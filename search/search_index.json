{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"uCore OS for LoongArch32 \u5b9e\u9a8c\u6307\u5bfc\u4e66","text":"<p>\u672c\u6307\u5bfc\u4e66\u5171\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\uff1a</p> <ul> <li>\u5b9e\u9a8c\u96f6\uff1a\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u51c6\u5907</li> <li>\u5b9e\u9a8c\u4e00\uff1a\u7cfb\u7edf\u8f6f\u4ef6\u542f\u52a8\u8fc7\u7a0b</li> <li>\u5b9e\u9a8c\u4e8c\uff1a\u7269\u7406\u5185\u5b58\u7ba1\u7406</li> <li>\u5b9e\u9a8c\u4e09\uff1a\u865a\u62df\u5185\u5b58\u7ba1\u7406</li> <li>\u5b9e\u9a8c\u56db\uff1a\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406</li> <li>\u5b9e\u9a8c\u4e94\uff1a\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406</li> <li>\u5b9e\u9a8c\u516d\uff1a\u8c03\u5ea6\u5668</li> <li>\u5b9e\u9a8c\u4e03\uff1a\u540c\u6b65\u4e92\u65a5</li> <li>\u5b9e\u9a8c\u516b\uff1a\u6587\u4ef6\u7cfb\u7edf</li> <li>Chiplab</li> </ul>"},{"location":"chiplab/chiplab/","title":"Chiplab","text":""},{"location":"chiplab/chiplab/#_1","title":"\u5f00\u53d1\u677f\u4ecb\u7ecd","text":"<p>\u6211\u4eec\u7f16\u5199\u7684OS\u53ef\u4ee5\u5728Chiplab\u8f6f\u6838\u4e0a\u8fd0\u884c\u3002\u771f\u5b9e\u7684Chiplab\u8f6f\u6838\u4e0eQEMU\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u53ef\u4ee5\u5e2e\u52a9\u540c\u5b66\u4eec\u53d1\u73b0\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u672a\u8003\u8651\u5230\u771f\u5b9e\u786c\u4ef6\u7684\u4e00\u4e9b\u95ee\u9898\uff08\u4f8b\u5982\u5728\u8f7d\u5165\u7528\u6237\u7a0b\u5e8f\u65f6\uff0cI Cache\u4e0eD Cache\u4e00\u81f4\u6027\u662f\u5426\u6b63\u786e\u7ef4\u62a4\uff09\u3002</p> <p>\u4ee5\u4e0b\u6d41\u7a0b\u4ee5Nexys 4 DDR\u5f00\u53d1\u677f\u4e3a\u4f8b\uff0c\u4f7f\u7528\u9f99\u82af\u676f\u6bd4\u8d5b\u5f00\u53d1\u677f\u6216\u8005\u767e\u82af\u8ba1\u5212\u5f00\u53d1\u677f\u8bf7\u53c2\u8003Chiplab\u6587\u6863\u70e7\u5199bit\u6d41\u4e0ePMON\u3002</p>"},{"location":"chiplab/chiplab/#_2","title":"\u6b65\u9aa4","text":""},{"location":"chiplab/chiplab/#1-loongarch32r-linux-gnusf-stripelfpmon","title":"1. \u4f7f\u7528<code>loongarch32r-linux-gnusf-strip</code>\u5bf9elf\u6587\u4ef6\u4e0d\u5fc5\u8981\u7684\u90e8\u5206\u8fdb\u884c\u88c1\u526a\uff0c\u5426\u5219PMON\u4f1a\u62a5\u9519\u3002","text":"<p>\u5728ucore-loongarch32\u7684obj\u6587\u4ef6\u5939\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a <pre><code>loongarch32r-linux-gnusf-strip ucore-kernel-initrd\n</code></pre></p>"},{"location":"chiplab/chiplab/#2-pmonbootloaderspi-flash","title":"2. \u5c06PMON\uff08Bootloader\uff09\u70e7\u5199\u5230\u5f00\u53d1\u677f\u7684SPI Flash","text":"<p>Warning</p> <p>\u6ce8\u610f\uff0cNexys 4 DDR\u5f00\u53d1\u677f\u70e7\u5199SPI Flash\u7684\u65b9\u5f0f\u4e0e\u9f99\u82af\u676f\u5f00\u53d1\u677f\u4ee5\u53ca\u767e\u82af\u8ba1\u5212\u5f00\u53d1\u677f\u4e0d\u540c\u3002\u5982\u4f7f\u7528\u5176\u4ed6\u5f00\u53d1\u677f\u8bf7\u6309\u7167\u5b98\u65b9\u6d41\u7a0b\u8fdb\u884c\u3002</p> <ol> <li> <p>\u5c06\u5f00\u53d1\u677f\u8fde\u4e0a\u7535\u8111\uff0c\u6253\u5f00Vivado\u7684Hardware Manager</p> </li> <li> <p>\u4e0b\u8f7dPMON\u6587\u4ef6</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u4eceChiplab\u6587\u6863\u4e2d\u4e0b\u8f7d\u6700\u65b0PMON\u6587\u4ef6\u3002</p> </li> <li> <p>\u5728Hardware Manager\u4e2d\u8fde\u63a5\u5f00\u53d1\u677f\uff0c\u5e76\u9009\u4e2dFPGA\u82af\u7247\uff0c\u70b9\u51fb\u53f3\u952e\uff0c\u9009\u62e9<code>Add Configuration Memory Device</code>\u3002</p> </li> <li> <p>\u5728\u5f39\u51fa\u7684\u7a97\u53e3\u4e2d\u641c\u7d22\u82af\u7247<code>s25fl128sxxxxxx0-spi-x1_x2_x4</code>\u3002</p> </li> <li> <p>\u4f7f\u7528\u521a\u521a\u4e0b\u8f7d\u7684PMON\u6587\u4ef6<code>gzrom.bin</code>\u8fdb\u884c\u70e7\u5199\u3002</p> </li> </ol>"},{"location":"chiplab/chiplab/#3-vivadochiplabfpga-bit","title":"3. \u4f7f\u7528Vivado\u751f\u6210Chiplab\u7684FPGA bit\u6d41\u3002","text":"<p>\u4e0b\u8f7d\u52a9\u6559\u505a\u597d\u7684Vivado\u5de5\u7a0b\u3002</p> <pre><code>git clone https://gitee.com/cyyself/chiplab.git -b n4ddr_with_cpu\ncd chiplab\nopen fpga/nexys4ddr/system_run/system_run.xpr # \u5982\u679c\u6ca1\u6709open\u547d\u4ee4\u53ef\u4ee5\u81ea\u5df1\u7528Vivado\u6253\u5f00\u8fd9\u4e2axpr\u6587\u4ef6\n</code></pre> <p>\u76f4\u63a5\u751f\u6210bit\u6d41\uff0c\u7136\u540e\u70e7\u5230\u5f00\u53d1\u677f\u4e0a\u5373\u53ef\u3002\uff08\u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002\uff09</p> <p>Warning</p> <p>\u5982\u679c\u4f7f\u7528\u65b0\u7248\u672c\u7684Vivado\uff0c\u5728\u66f4\u65b0IP\u6838\u65f6\u5e94\u9009\u62e9 Continue with Core Container Disabled.</p>"},{"location":"chiplab/chiplab/#4-bit","title":"4. \u5c06bit\u6d41\u5199\u5230\u5f00\u53d1\u677f\u4e0a\u3002","text":"<p>\u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662fSPI Flash\u5df2\u88ab\u6211\u4eec\u7684PMON\u5360\u7528\uff0c\u6240\u4ee5\u8bf7\u52ff\u56fa\u5316\u3002</p>"},{"location":"chiplab/chiplab/#5","title":"5. \u5269\u4f59\u6d41\u7a0b","text":"<p>\u4ee5\u4e0b\u6d41\u7a0b\u53ef\u76f4\u63a5\u53c2\u8003\u9f99\u82afChiplab\u6587\u6863\uff0c\u4ece4.3\u8282\u5f00\u59cb\uff0c4.5\u8282\u9664\u5916\uff08\u56e0\u4e3aNexys 4 DDR\u6ca1\u6709NAND Flash\uff09\u3002</p> <ul> <li>\u4f7f\u7528\u4e32\u53e3\u8f6f\u4ef6\u8fde\u63a5\u5f00\u53d1\u677f\u7684USB\u4e32\u53e3\uff0c\u4f7f\u7528115200\u6ce2\u7279\u7387\uff0c8n1\uff0c\u65e0\u6d41\u63a7\u3002</li> <li>\u4f7f\u7528\u7f51\u7ebf\u8fde\u63a5\u81ea\u5df1\u7684\u7535\u8111\u548c\u5f00\u53d1\u677f</li> <li> <p>\u5728PMON\u4e2d\u914d\u7f6eIP</p> <p>\u6211\u4eec\u53ef\u4ee5\u4e3a\u8fde\u63a5\u5f00\u53d1\u677f\u7684\u7f51\u5361\u968f\u610f\u914d\u7f6e\u4e00\u4e2a\u9759\u6001IP\uff0c\u4f8b\u5982PC\u914d\u7f6e\u4e3a169.254.0.1\u3002</p> <p>\u4e4b\u540e\u5728\u4e32\u53e3\u4e2d\u7684PMON\u4e5f\u914d\u7f6e\u540c\u7f51\u6bb5IP\uff1a</p> <pre><code>ifconfig dmfe0 169.254.0.2\nping 169.254.0.1\n</code></pre> </li> <li> <p>\u5728\u7535\u8111\u4e0a\u8fd0\u884ctftp\u670d\u52a1\u5668</p> <ul> <li> <p>\u5bf9\u4e8eWindows\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528Tftpd64</p> </li> <li> <p>\u5bf9\u4e8eLinux\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528tftpd-hpa\uff0c\u5bf9\u4e8eUbuntu\u53ef\u4ee5\u53c2\u8003Wiki\u3002</p> </li> </ul> <p>\u4f7f\u7528WSL2\u7684\u540c\u5b66\u6ce8\u610f\uff1aWSL2\u4e2d\u7f51\u5361\u4e3aNAT\u6a21\u5f0f\uff0cTFTP\u534f\u8bae\u4f7f\u7528UDP\u4f20\u8f93\uff0c\u8bf7\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u80fd\u591f\u6b63\u786e\u5904\u7406UDP\uff0c\u5426\u5219\u5efa\u8bae\u5c06\u6587\u4ef6\u590d\u5236\u51fa\u6765\uff0c\u5728Host\u7aefWindows\u8fd0\u884c\u3002</p> <p>\u7136\u540e\uff0c\u5c06\u4f60\u8981\u4f20\u5230\u5f00\u53d1\u677f\u4e0a\u7684\u88f8\u673a\u7a0b\u5e8f\uff08\u751a\u81f3Lab0\u7684\u6700\u7b80\u88f8\u673a\u7a0b\u5e8f\u4e5f\u662f\u53ef\u4ee5\u7684\uff09\uff0c\u653e\u5230tftp\u670d\u52a1\u5668\u8f6f\u4ef6\u8bbe\u5b9a\u7684\u6839\u76ee\u5f55\u4e0b\u3002</p> </li> <li> <p>\u5728PMON\u4e2d\u8f7d\u5165\u5185\u6838</p> <p>\u5728PMON\u4e2d\u6267\u884c\uff1a <pre><code>load tftp://169.254.0.1/ucore-kernel-initrd\ng\n</code></pre></p> <p>\u6ce8\uff1auCore\u4e0d\u4f1a\u8bfb\u53d6Bootloader\u4f20\u9012\u7684Kernel command line\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u50cf\u542f\u52a8Linux\u4e00\u6837\u5728g\u540e\u9762\u6dfb\u52a0\u53c2\u6570\u3002</p> </li> </ul>"},{"location":"chiplab/chiplab/#_3","title":"\u66f4\u591a\u5e2e\u52a9","text":"<ol> <li>Chiplab\u79fb\u690dN4DDR\u8bf4\u660e</li> </ol>"},{"location":"lab0/bare-prog/","title":"\u88f8\u673a\u7a0b\u5e8f","text":""},{"location":"lab0/bare-prog/#_1","title":"\u521d\u8bc6\u88f8\u673a\u7a0b\u5e8f","text":"<p>\u6211\u4eec\u4ee5\u5f80\u5199\u7528\u6237\u7a0b\u5e8f\u65f6\uff0c\u901a\u5e38\u90fd\u53ea\u5173\u6ce8\u4ee3\u7801\u672c\u8eab\uff0c\u800c\u5c06\u8fd0\u884c\u65f6\u7684\u73af\u5883\u4ea4\u7ed9\u4e86\u7f16\u8bd1\u5668\u7b49\u7cfb\u7edf\u8f6f\u4ef6\u8fdb\u884c\u5904\u7406\uff0c\u4f46\u6211\u4eec\u82e5\u8981\u7f16\u5199\u88f8\u673a\u7a0b\u5e8f\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u63ed\u5f00\u8fd0\u884c\u65f6\u73af\u5883\u7684\u795e\u79d8\u9762\u7eb1\u3002 \u4e0b\u8868\u63ed\u793a\u4e86\u88f8\u673a\u7a0b\u5e8f\u4e0e\u7528\u6237\u7a0b\u5e8f\u7684\u533a\u522b\uff1a</p> \u5bf9\u6bd4\u5bf9\u8c61 \u88f8\u673a\u7a0b\u5e8f \u5e38\u89c4\u7528\u6237\u7a0b\u5e8f \u5185\u5b58\u5730\u5740\u7a7a\u95f4 \u81ea\u884c\u7ba1\u7406\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u81ea\u884c\u5bf9\u865a\u62df\u5185\u5b58\u8fdb\u884c\u914d\u7f6e\u540e\u4f7f\u81ea\u5df1\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4 \u7531\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff08\u4e0d\u8003\u8651Linux NOMMU\u6a21\u5f0f\uff09 \u7cfb\u7edf\u8c03\u7528 \u8c03\u7528\u81ea\u5df1 \u8c03\u7528\u66f4\u9ad8\u7279\u6743\u7ea7\u7684\u64cd\u4f5c\u7cfb\u7edf/\u56fa\u4ef6 \u6808\u7684\u521d\u59cb\u5316 \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u7528\u6237\u8fdb\u7a0b\u65f6\u5b8c\u6210\uff08\u6bd5\u7adf\u8fd8\u8981\u901a\u8fc7\u6808\u4f20\u9012\u53c2\u6570\uff09 BSS\u6bb5\u7684\u6e05\u7a7a \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u865a\u62df\u9875\u9762\u65f6\u5b8c\u6210\u6e05\u96f6 <p>\u8bb8\u591a\u540c\u5b66\u53ef\u80fd\u5bf9\u4e8e\u4e0a\u8868\u5df2\u7ecf\u770b\u61f5\u4e86\uff0c\u4e0d\u660e\u767d\u8fd9\u4e9b\u540d\u8bcd\u7684\u5177\u4f53\u542b\u4e49\uff0c\u6ca1\u5173\u7cfb\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4e00\u4e00\u89e3\u91ca\uff1a</p>"},{"location":"lab0/bare-prog/#_2","title":"\u8c03\u7528\u6808","text":"<p>\u6211\u4eec\u77e5\u9053\u7f16\u5199\u7684\u7a0b\u5e8f\u53ef\u4ee5\u8fdb\u884c\u51fd\u6570\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u5728\u8c03\u7528\u540e\u8fd4\u56de\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u601d\u8003\uff0c\u8bb0\u5f55\u51fd\u6570\u6267\u884c\u4f4d\u7f6e\uff0c\u5305\u62ec\u5c40\u90e8\u53d8\u91cf\u7684\u72b6\u6001\u7b49\u53ef\u4ee5\u91c7\u7528\u4e00\u79cd\u5148\u8fdb\u540e\u51fa\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u6808\u3002\u8fd9\u4e2a\u8c03\u7528\u6808\u7684\u6570\u636e\u7ed3\u6784\u5728\u4e0d\u540c\u7684\u6307\u4ee4\u96c6\u67b6\u6784\u7684ABI\uff08Application Binary Interface\uff09\u4e2d\u5b9a\u4e49\u4e0d\u540c\u3002\u4e14\u5b83\u7684\u751f\u957f\u65b9\u5f0f\u662f\u5411\u4e0b\u751f\u957f\u3002</p> <p>\u4f46\u6211\u4eec\u9700\u8981\u5148\u5206\u914d\u51fa\u4e00\u4e2a\u6808\uff0c\u624d\u80fd\u8fd0\u884c\u8fd9\u79cd\u80fd\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u7684C\u8bed\u8a00\u7a0b\u5e8f\u3002\u56e0\u6b64\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u5728\u6c47\u7f16\u7a0b\u5e8f\u91cc\u5148\u521d\u59cb\u5316GPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u7684sp\u6307\u9488\uff0c\u624d\u80fd\u8fdb\u5165C\u7a0b\u5e8f\u3002</p>"},{"location":"lab0/bare-prog/#_3","title":"\u7a0b\u5e8f\u91cc\u7684\u5404\u4e2a\u5b58\u50a8\u533a","text":"<p>\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u8fd0\u884c\u4ee5\u4e0b\u5b9e\u9a8c\uff0c\u7f16\u5199\u5982\u4e0bC\u8bed\u8a00\u7a0b\u5e8f\uff1a</p> hello.c<pre><code>#include &lt;stdio.h&gt;\nint main() {\nprintf(\"Hello World\\n\");\nreturn 0;\n}\n</code></pre> <p>\u7136\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u7f16\u8bd1\u4e3a\u76ee\u6807\u6587\u4ef6\u5e76\u67e5\u770b\u76ee\u6807\u6587\u4ef6\u7684\u5934\uff1a</p> <pre><code>\u279c  gcc hello.c -c -o hello.o\n\u279c  objdump -h hello.o       \n\nhello.o:     file format elf64-x86-64\n\nSections:\nIdx Name          Size      VMA               LMA               File off  Algn\n  0 .text         0000001a  0000000000000000  0000000000000000  00000040  2**0\n                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE\n  1 .data         00000000  0000000000000000  0000000000000000  0000005a  2**0\n                  CONTENTS, ALLOC, LOAD, DATA\n  2 .bss          00000000  0000000000000000  0000000000000000  0000005a  2**0\n                  ALLOC\n  3 .rodata       0000000c  0000000000000000  0000000000000000  0000005a  2**0\n                  CONTENTS, ALLOC, LOAD, READONLY, DATA\n  4 .comment      0000001f  0000000000000000  0000000000000000  00000066  2**0\n                  CONTENTS, READONLY\n  5 .note.GNU-stack 00000000  0000000000000000  0000000000000000  00000085  2**0\n                  CONTENTS, READONLY\n  6 .eh_frame     00000038  0000000000000000  0000000000000000  00000088  2**3\n                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u7684\u7a0b\u5e8f\u5206\u4e3a\u4e86<code>.text</code>\u3001<code>.data</code>\u3001<code>.bss</code>\u3001<code>.rodata</code>\u5404\u5b58\u50a8\u6bb5\u3002</p> <p>\u5176\u4e2d\uff1a</p> <ul> <li> <p><code>.text</code>\u662f\u4ee3\u7801\u6bb5\uff0c\u653e\u7f6e\u7684\u662f\u6211\u4eec\u7684\u7a0b\u5e8f\u7f16\u8bd1\u540e\u7684\u4ee3\u7801\u3002</p> </li> <li> <p><code>.data</code>\u662f\u6570\u636e\u6bb5\uff0c\u8fd9\u91cc\u653e\u7684\u662f\u521d\u59cb\u5316\u8fc7\u7684\u9759\u6001\u53d8\u91cf\uff08\u5305\u542b\u5168\u5c40\u53d8\u91cf\u8fd8\u6709<code>static</code>\u4fee\u9970\u540e\u7684\u5c40\u90e8\u53d8\u91cf\uff09\u3002</p> </li> <li> <p><code>.bss</code>\u662f\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\u7684\u533a\u57df\u3002\u800c\u5728ELF\u6587\u4ef6\u4e2d\uff0c\u5b83\u5e76\u4e0d\u5b9e\u9645\u5b58\u50a8\u6570\u636e\uff0c\u4ec5\u7528\u4e8e\u544a\u77e5\u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u8fdb\u7a0b\u65f6\u8be5\u6bb5\u5408\u6cd5\u5730\u5740\u7684\u5b58\u5728\u3002</p> </li> <li> <p><code>.rodata</code>\u5b58\u653e\u7684\u662f\u53ea\u8bfb\u6570\u636e\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u5e38\u91cf\u4e0e\u5168\u5c40const\u53d8\u91cf\u5c31\u5b58\u653e\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u3002</p> </li> </ul> <p>\u8fd9\u4e9b\u6bb5\u7684\u5143\u6570\u636e\u653e\u5728\u6211\u4eec\u7f16\u8bd1\u7684\u4ea7\u7269\uff08ELF\u6587\u4ef6\uff09\u7684\u5934\u90e8\u5206\u3002</p>"},{"location":"lab0/bare-prog/#_4","title":"\u94fe\u63a5","text":"<p>\u6211\u4eec\u5728\u8fc7\u53bb\u7684\u201c\u7a0b\u5e8f\u8bbe\u8ba1\u57fa\u7840\u201d\u8bfe\u7a0b\u5e94\u8be5\u5df2\u7ecf\u5b66\u8fc7\u591a\u6587\u4ef6\u7684C\u8bed\u8a00\u7a0b\u5e8f\u7f16\u5199\u4ee5\u53ca\u94fe\u63a5\u8fc7\u7a0b\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u4e5f\u5728\u5176\u4e2d\u5b66\u4e60\u4e86Makefile\u7684\u57fa\u672c\u4f7f\u7528\u3002</p> <p>\u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u94fe\u63a5\u5668\u662f\u5982\u4f55\u5c06\u8fd9\u4e9b\u672a\u5b9a\u4e49\u7684\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u94fe\u63a5\u7684\u5462\uff1f</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u5f97\u6d89\u53ca\u5230\u4e00\u4e2a\u7b26\u53f7\u8868\u7684\u6982\u5ff5\uff0c\u5728\u6211\u4eec\u7f16\u8bd1\u4ea7\u751f\u7684ELF\u6587\u4ef6\u4e2d\uff0c\u8fd8\u6709\u4e00\u4e2a\u5b58\u653e\u7b26\u53f7\u8868\u7684\u533a\u57df\uff0c\u5176\u4e2d\u7b26\u53f7\u6307\u7684\u662f\u51fd\u6570\u3001\u53d8\u91cf\u7b49\u7684\u540d\u5b57\uff0c\u5e76\u8bb0\u5f55\u4ed6\u4eec\u5bf9\u5e94\u7684\u5730\u5740\u3002\u8fd9\u6837\u5728\u94fe\u63a5\u65f6\u5c31\u77e5\u9053\u80fd\u591f\u77e5\u9053\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff0c\u4ece\u800c\u8fdb\u884c\u94fe\u63a5\uff0c\u751f\u6210\u51fa\u4e00\u4e2a\u66f4\u5927\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u3002</p> <p>\u800c\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\uff0c\u6211\u4eec\u8fd8\u6709\u4e00\u4e2a\u9700\u6c42\u662f\u8bbe\u5b9a\u7a0b\u5e8f\u5404\u5b58\u50a8\u6bb5\u7684\u6392\u5e03\u4ee5\u53ca\u5730\u5740\u504f\u79fb\u91cf\u3002\u5730\u5740\u504f\u79fb\u91cf\u53ef\u4ee5\u544a\u77e5\u7f16\u8bd1\u5668\u8fdb\u884c\u76f4\u63a5\u8df3\u8f6c\u65f6\u6240\u9700\u8981\u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5f15\u5165\u4e00\u4e2a\u53eb\u505ald\u811a\u672c\u7684\u4e1c\u897f\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89c4\u5212\u9700\u8981\u653e\u5165\u6700\u7ec8\u7f16\u8bd1\u7ed3\u679c\u7684\u5404\u6bb5\u7684\u5730\u5740\u3002</p>"},{"location":"lab0/bare-prog/#_5","title":"\u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f","text":"<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5f00\u59cb\u771f\u6b63\u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\uff0c\u5927\u5bb6\u5728\u642d\u5efa\u597d\u7684\u73af\u5883\u4e2d\u65b0\u5efa\u6587\u4ef6\u5939\uff0c\u4e00\u6b65\u6b65\u5f00\u59cb\u5427\uff01</p>"},{"location":"lab0/bare-prog/#_6","title":"\u521d\u59cb\u5316\u7684\u6c47\u7f16\u4ee3\u7801","text":"start.S<pre><code>.extern main\n.text\n.globl _start\n_start:\n# Config direct window and set PG\nli.w    $t0, 0xa0000011\ncsrwr   $t0, 0x180\n/* CSR_DMWIN0(0x180): 0xa0000000-0xbfffffff-&gt;0x00000000-0x1fffffff Cached */\nli.w    $t0, 0x80000001\n/* CSR_DMWIN1(0x181): 0x80000000-0x9fffffff-&gt;0x00000000-0x1fffffff Uncached */\n# Enable PG\nli.w    $t0, 0xb0\ncsrwr   $t0, 0x0\n/* CSR_CRMD(0x0): PLV=0, IE=0, PG */\nla  $sp, bootstacktop\nla  $t0, main\njr  $t0\npoweroff:\nb poweroff\n_stack:\n.section .data\n.global bootstack\nbootstack:\n.space 1024\n.global bootstacktop\nbootstacktop:\n.space 64\n</code></pre> <p>\u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>start.S</code>\u3002</p> <p>\u8fd9\u91cc\u7a0b\u5e8f\u4e3b\u8981\u5b8c\u6210\u4e86\u5bf9CSR\u7684DMWIN\u7684\u8bbe\u7f6e\uff0c\u5e76\u4fee\u6539CSR_CRMD\u5f00\u542f\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u7136\u540e\u4ece\u6808\u5730\u5740\u76f4\u63a5\u8fdb\u5165\u5230main\u51fd\u6570\u3002\u800cmain\u51fd\u6570\u6765\u6e90\u4e8e\u5916\u90e8\u7684extern\uff0c\u6211\u4eec\u63a5\u7740\u5199main\u5bf9\u5e94\u7684\u4ee3\u7801\u3002</p>"},{"location":"lab0/bare-prog/#c","title":"\u7f16\u5199\u7b80\u5355\u4e32\u53e3\u8f93\u51faC\u7a0b\u5e8f","text":"<p>\u4e32\u53e3\u662f\u4e00\u79cd\u901a\u4fe1\u65b9\u5f0f\u3002\u5728LoongArch32\u7684QEMU\u4e2d\uff0c\u6709\u4e00\u4e2ans16550a\u89c4\u683c\u7684\u4e32\u53e3\uff0c\u4f4d\u4e8e\u7269\u7406\u5730\u57400x1fe001e0\u3002</p> <p>\u8be5\u4e32\u53e3\u901a\u8fc7MMIO\u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u7f16\u5199ns16550a\u5bf9\u5e94\u7684\u9a71\u52a8\u4ee3\u7801\u5b8c\u6210\u4e32\u53e3\u7684\u6253\u5370\uff0c\u8fd9\u4e00\u90e8\u5206\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u4e0a\u7f51\u641c\u7d22\uff0c\u52a9\u6559\u5df2\u7ecf\u7ed9\u51fa\u4e00\u4e2a\u53ea\u6709\u8f93\u51fa\u529f\u80fd\u7684\u9a71\u52a8\u8303\u4f8b\uff0c\u5982\u4e0b\uff1a</p> main.c<pre><code>#define UART_BASE 0x9fe001e0\n#define UART_RX     0   /* In:  Receive buffer */\n#define UART_TX     0   /* Out: Transmit buffer */\n#define UART_LSR    5   /* In:  Line Status Register */\n#define UART_LSR_TEMT       0x40 /* Transmitter empty */\n#define UART_LSR_THRE       0x20 /* Transmit-hold-register empty */\n#define UART_LSR_DR         0x01 /* Receiver data ready */\n\nvoid uart_put_c(char c) {\nwhile (!(*((volatile char*)UART_BASE + UART_LSR) &amp; (UART_LSR_THRE)));\n*((volatile char*)UART_BASE + UART_TX) = c;\n}\n\nvoid print_s(const char *c) {\nwhile (*c) {\nuart_put_c(*c);\nc ++;\n}\n}\n\nvoid main() {\nprint_s(\"\\nHere is my first bare-metal machine program on LoongArch32!\\n\\n\");\n}\n</code></pre> <p>\u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>main.c</code>\u3002</p> <p>\u7ec6\u5fc3\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\uff0c\u6211\u4eec\u524d\u6587\u63d0\u5230\u4e32\u53e3\u5730\u5740\u662f\u57280x1fe001e0\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4ee3\u7801\u5199\u6210\u4e860x9fe001e0\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u524d\u9762\u8bbe\u7f6e\u4e86DMW\uff0c\u5b8c\u6210\u4e860x80000000-0x9fffffff\u7684\u6620\u5c04\uff0c\u5e76\u8bbe\u7f6e\u7684Uncached\u5c5e\u6027\u3002</p> <p>Warning</p> <p>\u5982\u679c\u4f7f\u7528Cached\u5730\u5740\u8bbf\u95ee\u4e32\u53e3\uff0c\u4f8b\u5982\u5bf9\u5e94\u7684DMWIN0\u4e0b\u76840xbfe001e0\uff0c\u5c3d\u7ba1\u5728QEMU\u4e2d\u4e0d\u4f1a\u6709\u4efb\u4f55\u9519\u8bef\uff0c\u4f46\u5728\u5b9e\u9645\u6709Cache\u7684CPU\u786c\u4ef6\u4e0a\u4f1a\u5bfc\u81f4\u4e32\u53e3\u8bbf\u95ee\u5931\u53bb\u539f\u5b50\u6027\uff0c\u5bfc\u81f4\u65e0\u6cd5\u5f97\u5230\u4e32\u53e3\u8f93\u51fa\u3002</p>"},{"location":"lab0/bare-prog/#_7","title":"\u7f16\u5199\u94fe\u63a5\u811a\u672c","text":"<p>\u8fd9\u91cc\u6211\u4eec\u7684\u94fe\u63a5\u811a\u672c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u6307\u5b9a\u4e00\u4e2a\u8d77\u59cb\u5730\u5740\uff0c\u5e76\u5220\u53bb\u7a0b\u5e8f\u4e2d\u4e0d\u9700\u8981\u7684\u5b58\u50a8\u533a\u6bb5\uff0c\u56e0\u6b64\u6700\u7ec8\u4ea7\u751f\u94fe\u63a5\u811a\u672c\u5982\u4e0b\uff1a</p> lab0.ld<pre><code>SECTIONS\n{\n    . = 0xa0000000;\n    .text : { *(.text) }\n    .rodata : { *(.rodata) }\n    .bss : { *(.bss) }\n}\n</code></pre> <p>\u7136\u540e\u4fdd\u5b58\u4e3a<code>lab0.ld</code>\u3002</p> <p>\u5176\u4e2d\uff0c\u6211\u4eec\u628a\u5f00\u59cb\u5730\u5740\u653e\u57280xa0000000\u662f\u57fa\u4e8e\u6211\u4eec\u914d\u7f6e\u7684DMWIN0\u8003\u8651\u7684\uff0c\u5bf9\u4e8e\u4ee3\u7801\u548c\u6570\u636e\u8fd9\u7c7b\u8bbf\u95ee\uff0c\u6211\u4eec\u5f53\u7136\u5e0c\u671b\u653e\u5728\u5e26\u6709Cache\u5c5e\u6027\u7684\u5730\u5740\u6bb5\uff0c\u8fd9\u6837\u8fd0\u884c\u8d77\u6765\u901f\u5ea6\u5feb\u4e00\u4e9b\u3002</p>"},{"location":"lab0/bare-prog/#makefile","title":"\u7f16\u5199Makefile","text":"Makefile<pre><code>TOOL    :=  loongarch32r-linux-gnusf-\nCC      :=  $(TOOL)gcc\nOBJCOPY :=  $(TOOL)objcopy\nOBJDUMP :=  $(TOOL)objdump\nQEMU    :=  qemu-system-loongarch32\n\n.PHONY: clean qemu\n\nstart.elf: start.S main.c lab0.ld\n$(CC) -nostdlib -T lab0.ld start.S main.c -O3 -o $@\n\nqemu: start.elf\n$(QEMU) -M ls3a5k32 -m 32M -kernel start.elf -nographic\n\nclean:\nrm start.elf\n</code></pre> <p>Warning</p> <p>Makefile\u4e2d\u547d\u4ee4\u6240\u5728\u7684\u884c\u5fc5\u987b\u4ee5\u5236\u8868\u7b26\uff08\"\\t\"\uff09\u5f00\u5934\uff0c\u5982\u679c\u76f4\u63a5\u590d\u5236\u4e3a\u7a7a\u683c\u9700\u8981\u624b\u52a8\u66ff\u6362\u4e3a\u5236\u8868\u7b26\uff0c\u5426\u5219Make\u65f6\u4f1a\u51fa\u73b0\"missing separator.\"\u9519\u8bef\u3002</p> <p>\u7136\u540e\u4fdd\u5b58\u4e3a<code>Makefile</code>\u3002</p> <p>\u5173\u4e8eMakefile\u7684\u5185\u5bb9\u5927\u5bb6\u53ef\u4ee5\u4e0a\u7f51\u5bfb\u627e\u76f8\u5173\u8d44\u6599\uff0c\u60f3\u5fc5\u806a\u660e\u7684\u540c\u5b66\u4eec\u4e5f\u4ece\u8fd9\u7b80\u5355\u7684Makefile\u4e2d\u770b\u51fa\u4e86\u4e00\u4e9b\u89c4\u5f8b\u3002\u8fd9\u91cc\u7f16\u8bd1\u65f6\u6dfb\u52a0\u53c2\u6570<code>-nostdlib</code>\u662f\u4e3a\u4e86\u9632\u6b62stdlib\u7f16\u8bd1\u5230\u6211\u4eec\u7684\u7a0b\u5e8f\u4e2d\uff0c\u6bd5\u7adf\u8fd9\u662f\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\u3002</p>"},{"location":"lab0/bare-prog/#_8","title":"\u7f16\u8bd1\u8fd0\u884c","text":"<p>\u5728\u653e\u7f6e\u4e86<code>start.S</code>\u3001<code>main.c</code>\u3001<code>lab0.ld</code>\u3001<code>Makefile</code>\u7684\u6587\u4ef6\u5939\u4e0b\u6267\u884c<code>make qemu</code>\uff1a</p> <pre><code>\u279c  make qemu \nqemu-system-loongarch32 -M ls3a5k32 -m 32M -kernel start.elf -nographic\nloongson32_init: num_nodes 1\nloongson32_init: node 0 mem 0x2000000\n\nHere is my first bare-metal machine program on LoongArch32!\n</code></pre> <p>\u770b\u5230\"Here is my first bare-metal machine program on LoongArch32!\"\u8868\u793a\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f\u8fd0\u884c\u6210\u529f\uff01</p>"},{"location":"lab0/bare-prog/#qemu","title":"\u9000\u51faQEMU","text":"<p>\u5728nographic\u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u6309 ++ctrl+a++ \u4e00\u6b21\uff0c\u7136\u540e\u6309 ++x++ \u9000\u51fa\u3002</p> <p>Note</p> <p>\u5c0f\u601d\u8003\uff1a</p> <ol> <li> <p>\u4e3a\u4ec0\u4e48\u5728start.S\u7684\u6700\u540e\u5199\u4e86\u4e2a\u6b7b\u5faa\u73af\uff0c\u5982\u679c\u4e0d\u5199\u4f1a\u6709\u4ec0\u4e48\u574f\u5904\uff1f</p> </li> <li> <p>\u5728QEMU\u6a21\u62df\u5668\u4e2d\u8fd0\u884c\u88f8\u673a\u7a0b\u5e8f\u6709\u4ec0\u4e48\u529e\u6cd5\u907f\u514dCPU\u6ee1\u8f7d\uff1f\uff08\u53ef\u4ee5\u9605\u8bfb\u5b9e\u9a8c\u4e00\u7684\u4ee3\u7801\u627e\u5230\u7b54\u6848\u3002\uff09</p> </li> </ol>"},{"location":"lab0/debug/","title":"\u8c03\u8bd5\u65b9\u6cd5","text":""},{"location":"lab0/debug/#_1","title":"\u7a0b\u5e8f\u8c03\u8bd5","text":"<p>\u6211\u4eec\u5df2\u7ecf\u7ed9\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u88f8\u673a\u7a0b\u5e8f\u7684\u4f8b\u5b50\uff0c\u4f46\u6211\u4eec\u5728\u540e\u7eed\u7684OS\u5b9e\u9a8c\u4e2d\u5f80\u5f80\u4f1a\u9047\u5230\u9700\u8981\u8c03\u8bd5\u7684\u7a0b\u5e8f\uff0c\u56e0\u6b64</p>"},{"location":"lab0/debug/#_2","title":"\u5728\u7a0b\u5e8f\u7f16\u8bd1\u65f6\u589e\u52a0\u8c03\u8bd5\u4fe1\u606f","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6211\u4eec\u5f80\u5f80\u9700\u8981\u5728\u7f16\u8bd1\u65f6\u5173\u95ed\u7f16\u8bd1\u4f18\u5316\u5e76\u8ba9\u7f16\u8bd1\u5668\u8f93\u51fa\u8c03\u8bd5\u4fe1\u606f\uff0c\u9700\u8981\u5bf9Makefile\u8fdb\u884c\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <ol> <li>\u8c03\u7528GCC\u5173\u95ed\u7f16\u8bd1\u4f18\u5316\uff0c\u53bb\u9664\u6211\u4eec\u5df2\u7ecf\u5199\u7684<code>-O3</code></li> <li>\u8c03\u7528GCC\u6dfb\u52a0<code>-g</code>\u53c2\u6570\u589e\u52a0\u8c03\u8bd5\u4fe1\u606f</li> </ol> <p>\u6700\u7ec8\uff0c\u6211\u4eec\u9700\u8981\u5bf9Makefile\u8fdb\u884c\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <pre><code>10c10\n&lt;       $(CC) -nostdlib -T lab0.ld start.S main.c -g -o $@\n---\n&gt;       $(CC) -nostdlib -T lab0.ld start.S main.c -O3 -o $@\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u4f7f\u7528<code>make clean</code>\uff0c\u7136\u540e<code>make</code>\u5b8c\u6210\u7f16\u8bd1\u3002</p>"},{"location":"lab0/debug/#qemugdb","title":"QEMU\u5f00\u542fGDB\u7aef\u53e3","text":"<p>\u4e0d\u540c\u4e8e\u6211\u4eec\u4ee5\u5f80\u4f7f\u7528GDB\u76f4\u63a5attach\u5230\u67d0\u4e00\u4e2a\u8fdb\u7a0b\u6216\u76f4\u63a5\u901a\u8fc7gdb\u6253\u5f00\u67d0\u4e2a\u7a0b\u5e8f\u5e76\u8fd0\u884c\uff0c\u5bf9\u4e8eQEMU\u4e2d\u7684\u88f8\u673a\u7a0b\u5e8f\u8c03\u8bd5\uff0c\u6211\u4eec\u9700\u8981\u8ba9GDB\u8c03\u8bd5\u5668\u4e0eQEMU\u8fdb\u884c\u901a\u4fe1\u3002\u800cGDB\u4e5f\u5b9a\u4e49\u4e86GDB Remote Serial Protocol\uff0cQEMU\u4e5f\u540c\u6837\u652f\u6301\uff0c\u5e76\u901a\u8fc7TCP Socket\u7684\u65b9\u5f0f\u4e0eGDB\u4ea4\u4e92\u3002</p> <p>\u6211\u4eec\u5728QEMU\u4e2d\u53ef\u4ee5\u4f7f\u7528<code>-s</code>\u53c2\u6570\uff0c\u8be5\u53c2\u6570\u7b49\u4ef7\u4e8e<code>-gdb tcp::1234</code>\uff0c\u5c06GDB Remote Serial Protocol\u76d1\u542c\u5728TCP 1234\u7aef\u53e3\u3002</p> <p>\u6b64\u5916\uff0cQEMU\u76d1\u542c\u4e86\u8be5\u7aef\u53e3\u540e\uff0c\u6211\u4eec\u4ec5\u4ec5\u62e5\u6709\u4e86GDB\u76f4\u63a5\u8fde\u63a5\u67d0\u4e2a\u8fdb\u7a0b\u7684\u80fd\u529b\uff0c\u4f46\u6211\u4eec\u7684\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u8d77\u6765\u540e\u53ef\u80fd\u5df2\u7ecf\u8dd1\u8fc7\u4e86\u6211\u4eec\u6240\u9700\u8981\u8c03\u8bd5\u7684\u5730\u65b9\uff0c\u56e0\u6b64\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bf9QEMU\u4f7f\u7528<code>-S</code>\u53c2\u6570\uff0c\u4f7fQEMU\u542f\u52a8\u65f6\u4e0d\u7acb\u523b\u8fd0\u884c\u7a0b\u5e8f\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u9700\u8981\u5bf9QEMU\u6dfb\u52a0\u4ee5\u4e0b\u4e24\u4e2a\u53c2\u6570\uff1a</p> <ul> <li> <p><code>-S</code>     \u5728\u542f\u52a8\u65f6\u4e0d\u7acb\u523b\u542f\u52a8CPU</p> </li> <li> <p><code>-s</code>     \u76f8\u5f53\u4e8e-gdb tcp::1234\uff0c\u5c06gdbserver\u76d1\u542c\u5230\u672c\u5730\u76841234\u7aef\u53e3\u3002</p> </li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u7f16\u8bd1\u597d\u7684ucore\u76ee\u5f55\u4e2d\u76f4\u63a5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8QEMU\uff1a</p> <pre><code>qemu-system-loongarch32 -M ls3a5k32 -m 32m -kernel start.elf -nographic -S -s\n</code></pre>"},{"location":"lab0/debug/#gdb","title":"GDB\u7684\u4f7f\u7528","text":"<p>\u6211\u4eec\u9700\u8981\u518d\u65b0\u5efa\u53e6\u4e00\u4e2a\u7ec8\u7aef\uff0c\u5b8c\u6210gdb\u7684\u64cd\u4f5c\u3002\uff08\u8fd9\u4e00\u6b65\u5927\u5bb6\u6839\u636e\u5927\u5bb6\u4e60\u60ef\u4f7f\u7528\u7684\u7ec8\u7aef\u4e0d\u540c\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u505a\u6cd5\uff0c\u4f8b\u5982\u76f4\u63a5\u5728\u7ec8\u7aef\u91cc\u65b0\u5efa\u7a97\u53e3\uff0c\u6216\u8005\u5728VSCode\u91cc\u7684\u65b0\u5efa\u4e00\u4e2aTerminal\uff0c\u6216\u8005\u4f7f\u7528screen/tmux\u7b49\u5de5\u5177\uff09\u3002</p> <p>\u5728\u65b0\u5efa\u7684\u4e2d\u65ad\u4e2d\uff0c\u9996\u5148\u8fdb\u5165\u5230\u6211\u4eec\u7684lab0\u6587\u4ef6\u5939\uff0c\u7136\u540e\u4f7f\u7528\u4e00\u4e0b\u547d\u4ee4\u8fd0\u884c<code>gdb</code>\uff0c\u5e76\u6253\u5f00\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f`\uff1a</p> <pre><code>loongarch32r-linux-gnusf-gdb start.elf\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fde\u63a5\u5230QEMU\uff1a</p> <pre><code>target remote 127.0.0.1:1234\n</code></pre> <p>\u5176\u4e2d\uff0c\u547d\u4ee4\u53ef\u4ee5\u88ab\u7b80\u5199\u4e3a\uff1a</p> <pre><code>tar rem :1234\n</code></pre> <p>\u8fde\u63a5\u5230GDB\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u6b63\u5e38\u8c03\u8bd5\u7a0b\u5e8f\u540c\u6837\u7684\u6b65\u9aa4\u8c03\u8bd5\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f\u4e86\u3002\u5982\u679c\u6ca1\u6709\u8fde\u63a5\u4e0a\u9047\u5230\u4e86\u62a5\u9519\u8bf7\u786e\u4fddQEMU\u5df2\u542f\u52a8\u4e14\u4ec5\u542f\u52a8\u4e86\u4e00\u4e2a\u3002</p> <p>\u540c\u5b66\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728GDB\u63a7\u5236\u53f0\u4e2d\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <ul> <li> <p>layout [src/asm/split]</p> <p>\u6539\u53d8gdb\u7684\u5e03\u5c40\uff0csrc\u6307\u4ee3\u7801\uff0casm\u6307\u53cd\u6c47\u7f16\uff0csplit\u4f1a\u540c\u65f6\u663e\u793a\u4e24\u8005</p> </li> <li> <p>breakpoint [target]</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>b</code></p> <p>target\u53ef\u4ee5\u4e3a\u7b26\u53f7\u540d\uff08\u51fd\u6570\u540d\uff09/\u4ee3\u7801\u6587\u4ef6:\u884c\u53f7\u7b49\u3002</p> <p>\u4f8b\u5982\uff0c\u60f3\u8981\u5728<code>uart_put_c</code>\u51fd\u6570\u6dfb\u52a0\u65ad\u70b9\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>b uart_put_c\n</code></pre> <p>\u5982\u679c\u60f3\u8981\u5728main.c\u7684\u7b2c10\u884c\u6dfb\u52a0\u65ad\u70b9\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>b main.c:10\n</code></pre> <p>\u5982\u679c\u60f3\u8981\u5728PC\uff08\u7a0b\u5e8f\u8ba1\u6570\u5668\uff09 <code>0xa0000004</code>\u5904\u6dfb\u52a0\u65ad\u70b9\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>b *0xa0000004\n</code></pre> </li> <li> <p>info break</p> <p>\u67e5\u8be2\u6240\u6709\u8c03\u7528\u6808</p> </li> <li> <p>info registers</p> <p>\u67e5\u8be2\u6240\u6709\u5bc4\u5b58\u5668\u72b6\u6001</p> </li> <li> <p>continue</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>c</code></p> <p>\u7ee7\u7eed\u6267\u884c\u7a0b\u5e8f\u3002</p> <p>\u5bf9\u4e8eQEMU\u8c03\u8bd5\u800c\u8a00\uff0c\u9ed8\u8ba4\u5904\u4e8e\u6682\u505c\u72b6\u6001\uff0c\u9700\u8981\u5728\u6211\u4eec\u8bbe\u7f6e\u597d\u65ad\u70b9\u540e\u4f7f\u7528<code>c</code>\u8ba9QEMU\u5f00\u59cb\u8fd0\u884c\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f\u3002</p> </li> <li> <p>backtrace</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>bt</code></p> <p>\u67e5\u770b\u5f53\u524d\u7684\u8c03\u7528\u6808\uff0c\u89c2\u6d4b\u51fd\u6570\u8c03\u7528\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>next</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>n</code></p> <p>\u5355\u6b65\u6267\u884c\u5f53\u524d\u7a0b\u5e8f\uff0c\u4e0d\u8fdb\u5165\u51fd\u6570\u3002</p> </li> <li> <p>step</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>s</code></p> <p>\u5355\u6b65\u6267\u884c\u8c03\u8bd5\u7a0b\u5e8f\uff0c\u9047\u5230\u51fd\u6570\u65f6\u8fdb\u5165\u51fd\u6570\u3002</p> </li> <li> <p>stepi</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>si</code></p> <p>\u5355\u6b65\u6267\u884c\u4e00\u6761\u6c47\u7f16\u6307\u4ee4\u3002</p> </li> <li> <p>print [expr]</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>p</code></p> <p>[expr]\u90e8\u5206\u53ef\u4ee5\u66ff\u6362\u4e3a\u4efb\u610f\u8868\u8fbe\u5f0f\u3002\u4f46gdb\u4e2d\u80fd\u591f\u652f\u6301\u7684\u8868\u8fbe\u5f0f\u6709\u9650\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u7a0b\u5e8f\u6267\u884c\u5230\u4e86<code>uart_put_c</code>\u51fd\u6570\uff0c\u6211\u4eec\u82e5\u60f3\u67e5\u770b\u4f20\u5165\u7684<code>char c</code>\u53c2\u6570\u7684\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>p c\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u60f3\u8981\u67e5\u770bc\u7684\u5341\u516d\u8fdb\u5236\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>p/x c\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u60f3\u8981\u67e5\u770b\u5185\u5b58\u5730\u5740<code>0xa0000129</code>\u5904\u7684char\u5b57\u7b26\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>p *(char*)0xa0000129\n</code></pre> </li> <li> <p>display [expr]</p> <p>\u53ef\u4ee5\u7b80\u5199\u4e3a<code>disp</code></p> <p>\u548cprint\u4f5c\u7528\u7c7b\u4f3c\uff0c\u4f46print\u53ea\u6253\u5370\u4e00\u6b21\uff0cdisp\u5219\u662f\u5728\u6bcf\u6b21gdb\u8c03\u8bd5\u65f6\u8fdb\u884c\u6253\u5370\u3002</p> </li> </ul> <p>\u9664\u6b64\u4e4b\u5916\uff0cgdb\u8fd8\u6709\u975e\u5e38\u591a\u7684\u547d\u4ee4\u4e0e\u4f7f\u7528\u6280\u5de7\uff0c\u8fd9\u4e00\u90e8\u5206\u7559\u7ed9\u540c\u5b66\u4eec\u81ea\u884c\u4e0a\u7f51\u67e5\u627e\u76f8\u5173\u8d44\u6599\u5e76\u5b66\u4e60\u3002</p>"},{"location":"lab0/debug/#gdbinit","title":".gdbinit","text":"<p>\u6bcf\u6b21\u6211\u4eec\u6253\u5f00gdb\u65f6\u90fd\u4f7f\u7528target remote 127.0.0.1:1234\u5e76\u4fee\u6539layout\u975e\u5e38\u9ebb\u70e6\uff0c\u6709\u6ca1\u6709\u4ec0\u4e48\u65b9\u4fbf\u7684\u65b9\u5f0f\u5462\uff1f</p> <p>\u7b54\u6848\u662f\u6709\u7684\uff0c\u90a3\u5c31\u662f\u7f16\u5199\u4e00\u4e2agdbinit\u811a\u672c\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u7f16\u5199\u4ee5\u4e0b\u5185\u5bb9\u4fdd\u5b58\u5230lab0\u6587\u4ef6\u5939\u4e0b\u7684<code>.gdbinit</code>\u6587\u4ef6\u4e2d\uff1a</p> <pre><code>target remote 127.0.0.1:1234\nlayout split\n</code></pre> <p>Warning</p> <p>Linux\u4e0b<code>.</code>\u5f00\u5934\u7684\u6587\u4ef6\u9ed8\u8ba4\u4e3a\u9690\u85cf\u6587\u4ef6\uff0c\u76f4\u63a5\u4f7f\u7528<code>ls</code>\u547d\u4ee4\u5e76\u4e0d\u4f1a\u51fa\u73b0\uff0c\u9700\u8981\u4f7f\u7528<code>ls -a</code>\u67e5\u770b\u3002</p> <p>\u7136\u540e\u518d\u6b21\u542f\u52a8<code>loongarch32r-linux-gnusf-gdb start.elf</code>\uff0c\u6b64\u65f6\u4e5f\u8bb8\u4f1a\u544a\u8bc9\u6211\u4eec\u4e00\u4e2a\u9519\u8bef\u63d0\u793a\uff0c\u8fd9\u662fgdb\u57fa\u4e8e\u5b89\u5168\u8003\u8651\u3002\u5982\u679c\u6211\u4eec\u4fdd\u8bc1gdb\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u4e0b<code>.gdbinit</code>\u5747\u662f\u53ef\u4ee5\u4fe1\u4efb\u7684\uff0c\u53ef\u4ee5\u5148\u9000\u51fagdb\uff08\u901a\u8fc7\u5728gdb\u63a7\u5236\u53f0\u6267\u884c<code>exit</code>\uff09\uff0c\u7136\u540e\u5728shell\u4e2d\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8bbe\u7f6e\u5b89\u5168\u52a0\u8f7d\u8def\u5f84\u4e3a\u6240\u6709\u8def\u5f84\uff08\u8bbe\u7f6e\u4e3a<code>/</code>\uff09\uff1a</p> <pre><code>echo \"set auto-load safe-path /\" &gt; ~/.gdbinit\n</code></pre> <p>\u7136\u540e\u518d\u6b21\u542f\u52a8<code>loongarch32r-linux-gnusf-gdb start.elf</code>\uff0c\u5982\u679cQEMU\u5df2\u7ecf\u5f00\u542f\u5e76\u5df2\u4f7f\u7528-s\u53c2\u6570\u76d1\u542cGDB RSP\u57281234\u7aef\u53e3\uff0c\u6b64\u65f6\u5e94\u8be5\u5c31\u80fd\u591f\u81ea\u52a8\u8fde\u4e0aQEMU\u4e86\u3002</p> <p>Info</p> <p>Tips: \u5f53\u4f60\u591a\u6b21\u8c03\u8bd5\u7a0b\u5e8f\u540c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u610f\u5473\u7740\u4f60\u8981\u591a\u6b21\u4f7f\u7528\u76f8\u540c\u7684\u65ad\u70b9\u65f6\uff0c\u4e5f\u53ef\u4ee5\u5c06\u65ad\u70b9\u7684b [target]\u547d\u4ee4\u5199\u5728.gdbinit\u4e2d\uff0c\u8fd9\u6837\u5c31\u4e0d\u5fc5\u6bcf\u6b21\u91cd\u65b0\u8bbe\u7f6e\u65ad\u70b9\u3002</p>"},{"location":"lab0/env/","title":"\u73af\u5883\u914d\u7f6e","text":"<p>\u6211\u4eec\u53c2\u8003\u4e86MIT\u7684xv6\u3001Harvard\u7684OS161\u548cLinux\u7b49\u8bbe\u8ba1\u4e86ucore OS\u5b9e\u9a8c\uff0c\u6240\u6709OS\u5b9e\u9a8c\u9700\u5728Linux\u4e0b\u8fd0\u884c\u3002</p>"},{"location":"lab0/env/#_2","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u73af\u5883\u51c6\u5907\uff1ax86-64\u67b6\u6784\u7684Docker\u8fd0\u884c\u73af\u5883\u3002</p> <p>\u56e0\u4e3aLoongArch32\u7684\u73af\u5883\u914d\u7f6e\u6bd4\u8f83\u590d\u6742\uff0c\u5c24\u5176\u662f\u5b83\u7684QEMU\u9700\u8981\u8865\u5145\u5927\u91cf\u4f9d\u8d56\uff0c\u56e0\u6b64\u52a9\u6559\u4e3a\u4e86\u8282\u7701\u540c\u5b66\u4eec\u7684\u5de5\u4f5c\u91cf\u6253\u5305\u4e86\u4e00\u4e2aDocker\u955c\u50cf\uff0c\u5b83\u5c01\u88c5\u4e86\u6240\u6709\u8fd0\u884c\u6211\u4eec\u7684uCore\u5b9e\u9a8c\u6240\u9700\u7684\u73af\u5883\uff0c\u5e76\u5df2\u53d1\u5e03\u5230Docker Hub.</p> <p>\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528Windows\u7684\u540c\u5b66\u4f7f\u7528WSL2\u6216Linux\u865a\u62df\u673a\u5b89\u88c5Docker\uff0c\u4f7f\u7528Linux\u7684\u540c\u5b66\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff0c\u4f7f\u7528macOS\uff08\u542bApple Silicon\uff09\u7684\u540c\u5b66\u4f7f\u7528Linux\u865a\u62df\u673a\u5b89\u88c5Docker\u3002</p> <p>\u5e38\u89c1Linux\u53d1\u884c\u7248\u5b89\u88c5Docker\u65b9\u6cd5\u53ef\u53c2\u8003\u6e05\u534e\u955c\u50cf\u7ad9\u4e0a\u7684\u6559\u7a0b\u3002</p> <p>Note</p> <p>\u4f7f\u7528WSL2+Ubuntu 22.04\u7684\u540c\u5b66\u8bf7\u6ce8\u610f\uff1a</p> <p>\u5982\u679c\u9047\u5230Docker Daemon\u6ca1\u6709\u542f\u52a8\uff0c\u4e5f\u8bb8\u662fiptables-legacy\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a</p> <pre><code>sudo apt install iptables\nsudo update-alternatives --set iptables /usr/sbin/iptables-legacy\nsudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy\nsudo service docker start\n</code></pre> <p>\u53e6\u5916\uff0cWSL1\u4e0d\u652f\u6301Docker\uff0c\u6ca1\u6709\u6761\u4ef6\u5b89\u88c5WSL2\u7684\u540c\u5b66\u5efa\u8bae\u4f7f\u7528\u865a\u62df\u673a\u3002</p>"},{"location":"lab0/env/#x86-64","title":"\u5bf9\u4e8e\u4f7f\u7528\u7684\u7535\u8111\u975ex86-64\u67b6\u6784\u7684\u540c\u5b66","text":"<p>\u5982\u679c\u540c\u5b66\u4eec\u4f7f\u7528\u975ex86-64\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u8fdb\u884c\u5b9e\u9a8c\uff0c\u4f8b\u5982\u4f7f\u7528ARM\u67b6\u6784\u7684Apple Silicon\u7684Mac\u751a\u81f3\u662f\u6811\u8393\u6d3e\uff0c\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u673a\u5b89\u88c5\u4e00\u4e2a\u81ea\u5df1\u6307\u4ee4\u96c6\u67b6\u6784\u7684Linux\u53d1\u884c\u7248\uff08\u5bf9\u4e8eARM\u63a8\u8350Debian\uff0c\u4f5c\u4e3aUbuntu\u7684\u4e0a\u6e38\u8f6f\u4ef6\u652f\u6301\u8f83\u4e30\u5bcc\uff09\uff0c\u7136\u540e\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5qemu-user\u6a21\u62dfx86-64\u73af\u5883\uff0c\u5c31\u53ef\u4ee5\u5728Linux\u4e2d\u8fd0\u884cx86\u67b6\u6784\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u4e86\uff1a</p> <pre><code>sudo apt install qemu-user qemu-user-static binfmt-support gcc-x86-64-linux-gnu binutils-x86-64-linux-gnu binutils-x86-64-linux-gnu-dbg build-essential\n</code></pre> <p>\u4e4b\u540e\u7684\u64cd\u4f5c\u4e0ex86-64\u7684Linux\u5b8c\u5168\u76f8\u540c\u3002</p>"},{"location":"lab0/env/#docker","title":"\u914d\u7f6eDocker\uff08\u53ef\u9009\uff09","text":"<ol> <li> <p>\u914d\u7f6e\u955c\u50cf\u7ad9</p> <p>\u5bf9\u4e8e\u8bb8\u591a\u540c\u5b66\u7684\u7f51\u7edc\u73af\u5883\u800c\u8a00\u53ef\u80fd\u4eceDocker Hub\u5b98\u65b9\u4e0b\u8f7d\u8f83\u6162\uff0c\u8fd9\u91cc\u63a8\u8350\u5c06Docker Hub\u6539\u4e3a\u5357\u4eac\u5927\u5b66\u955c\u50cf\u7ad9\uff08\u76ee\u524d\u6559\u80b2\u7f51\u5185\u552f\u4e00Docker Hub\u955c\u50cf\uff09\uff0c\u914d\u7f6e\u65b9\u6cd5\u5728\u6b64\u3002</p> </li> <li> <p>\u914d\u7f6eDocker\u7ec4\u7684\u7528\u6237\u6743\u9650</p> <p>\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u5728Linux\u4e2d\u4e0d\u901a\u8fc7root\u7528\u6237\uff08sudo\uff09\u5c31\u80fd\u76f4\u63a5\u8bbf\u95eeDocker\uff0c\u4ee5\u53ca\u5728\u8fd0\u884c\u4e8e\u7528\u6237\u6743\u9650\u7684VSCode\u4e2d\u76f4\u63a5\u4f7f\u7528Docker\uff0c\u53ef\u4ee5\u5c06\u81ea\u5df1\u7684\u7528\u6237\u52a0\u5165Docker\u521b\u5efa\u7684\u7ec4\u4e2d\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a</p> <pre><code>sudo usermod -aG docker $USER\nnewgrp docker\n</code></pre> <p>\u4e4b\u540e\u91cd\u542f\u7535\u8111\u5373\u53ef\u5168\u5c40\u751f\u6548\uff0c\u5426\u5219\u6bcf\u6b21\u6253\u5f00\u7ec8\u7aef\u9700\u8981\u4f7f\u7528<code>newgrp docker</code>\u624d\u80fd\u4f7f\u6743\u9650\u751f\u6548\u3002</p> </li> </ol>"},{"location":"lab0/env/#docker_1","title":"\u4e0b\u8f7dDocker\u955c\u50cf\u5e76\u521b\u5efa\u5b9e\u9a8c\u73af\u5883\u5bb9\u5668","text":"<ol> <li> <p>\u4e0b\u8f7d<code>chenyy/la32r-env</code>\u955c\u50cf\uff1a</p> <p>\u5728\u7ec8\u7aef\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>docker pull chenyy/la32r-env\n</code></pre> </li> <li> <p>\u57fa\u4e8e<code>chenyy/la32r-env</code>\u521b\u5efa<code>la32r-docker</code>\u5bb9\u5668</p> <pre><code>docker run -dit \\\n--name la32r-docker \\\n--user=$(id -u $USER):$(id -g $USER) \\\n--net=host \\\n--workdir=\"/home/$USER\" \\\n--volume=\"/home:/home\" \\\n--volume=\"/root:/root\" \\\n--volume=\"/mnt:/mnt\" \\\n--volume=\"/etc/group:/etc/group:ro\" \\\n--volume=\"/etc/passwd:/etc/passwd:ro\" \\\n--volume=\"/etc/shadow:/etc/shadow:ro\" \\\n--volume=\"/etc/sudoers.d:/etc/sudoers.d:ro\" \\\n-e LANG=en_US.UTF-8 \\\n-e LANGUAGE=en_US.UTF-8 \\\n-e LC_ALL=en_US.UTF-8 \\\nchenyy/la32r-env\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5bf9Docker\u8fdb\u884c\u4e86\u4e00\u4e9b\u914d\u7f6e\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u5c06\u6574\u4e2a/home\u76ee\u5f55\u5728\u4e3b\u673a\u4e0eDocker\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\uff0c\u4ece\u800cDocker\u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u7528\u6237\u6587\u4ef6\u3002\u540c\u65f6\u5c06\u7528\u6237\u4e0e\u7ec4\u6743\u9650\u8fdb\u884c\u540c\u6b65\uff0c\u65b9\u4fbf\u5728Docker\u4e2d\u76f4\u63a5\u8bbf\u95ee\u5bf9\u5e94\u7684\u6587\u4ef6\u3002</p> </li> <li> <p>\u542f\u52a8<code>la32r-docker</code>\u5bb9\u5668</p> <pre><code>docker start la32r-docker\n</code></pre> </li> <li> <p>\u8fdb\u5165<code>la32r-docker</code>\u7684Shell</p> <pre><code>docker exec -it la32r-docker /bin/zsh\n</code></pre> </li> </ol>"},{"location":"lab0/env/#vscode","title":"\u914d\u7f6eVSCode\uff08\u53ef\u9009\uff09","text":"<p>\u540c\u5b66\u4eec\u53ef\u4ee5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u641c\u7d22Docker\uff0c\u5e76\u901a\u8fc7\u8be5\u63d2\u4ef6\u8fde\u63a5\u5230\u5bb9\u5668\u4e2d\u5b8c\u6210\u64cd\u4f5c\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u627e\u5230\u5bf9\u5e94Docker\uff0c\u53ef\u4ee5\u8fdb\u884cAttach Shell\u6216Attch VSCode\u3002\u65b9\u4fbf\u6211\u4eec\u540e\u7eed\u5728Host\u7aef\u7684VSCode\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\uff0c\u5e76\u5728Docker\u4e2d\u4f7f\u7528\u5bf9\u5e94\u73af\u5883\u5b8c\u6210\u7f16\u8bd1\u4e0e\u8c03\u8bd5\u3002</p> <p></p>"},{"location":"lab0/env/#_3","title":"\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u4f7f\u7528\u7684\u8f6f\u4ef6","text":""},{"location":"lab0/env/#_4","title":"\u7f16\u8f91\u5668","text":"<p>\u8fd9\u91cc\u6211\u4eec\u63a8\u8350\u4f7f\u7528Visual Studio Code\u4f5c\u4e3a\u7f16\u8f91\u5668\uff0c\u539f\u56e0\u662f\u5b83\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u4f7f\u7528Docker\u63d2\u4ef6\u65b9\u4fbf\u6211\u4eec\u5bf9LoongArch32\u7684\u8fd0\u884c\u73af\u5883\u8fdb\u884c\u64cd\u4f5c\u3002</p>"},{"location":"lab0/env/#git","title":"git","text":"<p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u91c7\u7528Git\u4f5c\u4e3a\u7248\u672c\u63a7\u5236\u5de5\u5177\uff0c\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u8bb0\u5f55\u6211\u4eec\u6bcf\u6b21\u7684\u4fee\u6539\uff0c\u5e76\u5728\u9047\u5230\u95ee\u9898\u7684\u65f6\u5019\u8fd8\u539f\u56de\u81ea\u5df1\u7684\u5148\u524d\u4fee\u6539\u7684\u7248\u672c\u3002</p>"},{"location":"lab0/lab0/","title":"\u5b9e\u9a8c\u96f6\uff1a\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u51c6\u5907","text":""},{"location":"lab0/lab0/#_2","title":"\u5b9e\u9a8c\u76ee\u7684\uff1a","text":"<ul> <li>\u4e86\u89e3LoongArch32\u6307\u4ee4\u96c6</li> <li>\u4e86\u89e3\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u5b9e\u9a8c\u73af\u5883(Docker)</li> <li>\u719f\u6089\u547d\u4ee4\u884c\u65b9\u5f0f\u7684\u7f16\u8bd1\u3001\u8c03\u8bd5\u5de5\u7a0b</li> <li>\u638c\u63e1\u57fa\u4e8e\u786c\u4ef6\u6a21\u62df\u5668\u7684\u8c03\u8bd5\u6280\u672f</li> <li>\u719f\u6089C\u8bed\u8a00\u7f16\u7a0b\u548c\u6307\u9488\u7684\u6982\u5ff5</li> <li>\u4e86\u89e3LoongArch32\u6c47\u7f16\u8bed\u8a00</li> </ul>"},{"location":"lab0/lab0/#os","title":"\u4e86\u89e3OS\u5b9e\u9a8c","text":"<p>\u5199\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u96be\u5417\uff1f\u522b\u88ab\u73b0\u5728\u4e0a\u767e\u4e07\u884c\u7684Linux\u548cWindows\u64cd\u4f5c\u7cfb\u7edf\u5413\u5012\u3002\u5f53\u5e74Thompson\u4e58\u4ed6\u8001\u5a46\u5e26\u7740\u5c0f\u5b69\u5ea6\u5047\u7559\u4ed6\u4e00\u4eba\u5728\u5bb6\u65f6\uff0c\u5199\u4e86UNIX\uff1b\u5f53\u5e74Linus\u8fd8\u662f\u4e00\u4e2a21\u5c81\u5927\u5b66\u751f\u65f6\u5b8c\u6210\u4e86Linux\u96cf\u5f62\u3002\u7ad9\u5728\u8fd9\u4e9b\u5de8\u4eba\u7684\u80a9\u8180\u4e0a\uff0c\u6211\u4eec\u80fd\u5426\u4e5f\u5c1d\u8bd5\u4e00\u4e0b\u505a\u201c\u5de8\u4eba\u201d\u7684\u6ecb\u5473\u5462\uff1f</p> <p>MIT\u7684Frans Kaashoek\u7b49\u57282006\u5e74\u53c2\u8003PDP-11\u4e0a\u7684UNIX Version 6\u5199\u4e86\u4e00\u4e2a\u53ef\u5728X86\u4e0a\u8dd1\u7684\u64cd\u4f5c\u7cfb\u7edfxv6\uff08\u57fa\u4e8eMIT License\uff09\uff0c\u7528\u4e8e\u5b66\u751f\u5b66\u4e60\u64cd\u4f5c\u7cfb\u7edf\u3002\u6211\u4eec\u53ef\u4ee5\u7ad9\u5728\u4ed6\u4eec\u7684\u80a9\u8180\u4e0a\uff0c\u57fa\u4e8exv6\u7684\u8bbe\u8ba1\uff0c\u5c1d\u8bd5\u7740\u4e00\u6b65\u4e00\u6b65\u5b8c\u6210\u4e00\u4e2a\u4ece\u201c\u7a7a\u7a7a\u5982\u4e5f\u201d\u5230\u201c\u4e94\u810f\u4ff1\u5168\u201d\u7684\u201c\u9ebb\u96c0\u201d\u64cd\u4f5c\u7cfb\u7edf\u2014ucore\uff0c\u6b64\u201c\u9ebb\u96c0\u201d\u5305\u542b\u865a\u5b58\u7ba1\u7406\u3001\u8fdb\u7a0b\u7ba1\u7406\u3001\u5904\u7406\u5668\u8c03\u5ea6\u3001\u540c\u6b65\u4e92\u65a5\u3001\u8fdb\u7a0b\u95f4\u901a\u4fe1\u3001\u6587\u4ef6\u7cfb\u7edf\u7b49\u4e3b\u8981\u5185\u6838\u529f\u80fd\uff0c\u603b\u7684\u5185\u6838\u4ee3\u7801\u91cf\uff08C+asm\uff09\u4e0d\u4f1a\u8d85\u8fc75K\u884c\u3002\u5145\u5206\u4f53\u73b0\u4e86\u201c\u5c0f\u800c\u5168\u201d\u7684\u6307\u5bfc\u601d\u60f3\u3002</p> <p>ucore\u7684\u8fd0\u884c\u73af\u5883\u53ef\u4ee5\u662f\u771f\u5b9e\u7684LoongArch32\u8ba1\u7b97\u673a\uff0c\u4e0d\u8fc7\u8003\u8651\u5230\u8c03\u8bd5\u548c\u5f00\u53d1\u7684\u65b9\u4fbf\uff0c\u6211\u4eec\u53ef\u91c7\u7528LoongArch32\u786c\u4ef6\u6a21\u62df\u5668\uff0c\u6bd4\u5982QEMU\u7b49\u3002ucore\u7684\u5f00\u53d1\u73af\u5883\u4e3b\u8981\u662fGCC\u4e2d\u7684gcc\u3001gas\u3001ld\u548cMAKE\u7b49\u5de5\u5177\uff0c\u5bf9\u4e8e\u4ee3\u7801\u7f16\u8f91\u5219\u53ef\u4ee5\u91c7\u7528Visual Studio Code\u7b49\u5de5\u5177\u3002\u5bf9\u4e8e\u8f6f\u4ef6\u7684\u7248\u672c\u63a7\u5236\u53ef\u4ee5\u91c7\u7528Git\u3001SVN\u7b49\u5de5\u5177\u3002\u800c\u5bf9\u4e8e\u4e0d\u719f\u7ec3\u8fd9\u4e9b\u5de5\u5177\u7684\u540c\u5b66\u9700\u8981\u5728\u7248\u672c\u4e4b\u95f4\u8fdb\u884c\u7b80\u5355\u7684\u6bd4\u8f83\u4e5f\u53ef\u4ee5\u4f7f\u7528Meld\u7b49\u8f6f\u4ef6\u3002\u8c03\u8bd5\uff08deubg\uff09\u5b9e\u9a8c\u6709\u52a9\u4e8e\u53d1\u73b0\u8bbe\u8ba1\u4e2d\u7684\u9519\u8bef\uff0c\u53ef\u91c7\u7528gdb\uff08\u914d\u5408qemu\uff09\u7b49\u8c03\u8bd5\u5de5\u5177\u8f6f\u4ef6\u3002\u5e76\u53ef\u6574\u4e2a\u5b9e\u9a8c\u7684\u8fd0\u884c\u73af\u5883\u548c\u5f00\u53d1\u73af\u5883\u5df2\u7ecf\u4f7f\u7528Docker\u6253\u5305\uff0c\u63a8\u8350\u4f7f\u7528Docker\u6765\u76f4\u63a5\u8fd0\u884c\u6211\u4eec\u7684\u73af\u5883\u3002</p> <p>\u90a3\u6211\u4eec\u51c6\u5907\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u6765\u5b9e\u73b0ucore\u5462\uff1f\u6839\u636e\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u6709\u5982\u4e0b\u7684\u5b9e\u9a8c\u6b65\u9aa4\uff1a 1. \u7528\u4e8e\u4e86\u89e3\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u524d\u7684\u72b6\u6001\u548c\u8981\u505a\u7684\u51c6\u5907\u5de5\u4f5c\uff0c\u4e86\u89e3\u8fd0\u884c\u64cd\u4f5c\u7cfb\u7edf\u7684\u786c\u4ef6\u652f\u6301\uff0c\u7406\u89e3\u4f8b\u5916\uff0c\u5305\u62ec\u5e38\u89c4\u4f8b\u5916\uff08\u4f8b\u5982\u4e2d\u65ad\u3001\u7cfb\u7edf\u8c03\u7528\u3001\u5176\u5b83\u5f02\u5e38\u7b49\uff09\u4e0eTLB\u4f8b\u5916\uff1b 2. \u7269\u7406\u5185\u5b58\u7ba1\u7406\u5b50\u7cfb\u7edf\uff0c\u7406\u89e3LoongArch32\u7684\u5185\u5b58\u7ba1\u7406\u6a21\u5f0f\uff0c\u4e86\u89e3\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u7ba1\u7406\u7269\u7406\u5185\u5b58\uff1b 3. \u865a\u62df\u5185\u5b58\u7ba1\u7406\u5b50\u7cfb\u7edf\uff0c\u901a\u8fc7\u9875\u8868\u673a\u5236\u5b9e\u73b0TLB\u7684\u586b\u5145\u4ee5\u53ca\u7f3a\u9875\u6545\u969c\u5904\u7406\u7b49\uff1b 4. \u5185\u6838\u7ebf\u7a0b\u5b50\u7cfb\u7edf\uff0c\u7528\u4e8e\u4e86\u89e3\u5982\u4f55\u521b\u5efa\u76f8\u5bf9\u4e0e\u7528\u6237\u8fdb\u7a0b\u66f4\u52a0\u7b80\u5355\u7684\u5185\u6838\u6001\u7ebf\u7a0b\uff0c\u5982\u679c\u5bf9\u5185\u6838\u7ebf\u7a0b\u8fdb\u884c\u52a8\u6001\u7ba1\u7406\u7b49\uff1b 5. \u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u5b50\u7cfb\u7edf\uff0c\u7528\u4e8e\u4e86\u89e3\u7528\u6237\u6001\u8fdb\u7a0b\u521b\u5efa\u3001\u6267\u884c\u3001\u5207\u6362\u548c\u7ed3\u675f\u7684\u52a8\u6001\u7ba1\u7406\u8fc7\u7a0b\uff0c\u4e86\u89e3\u5728\u7528\u6237\u6001\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u5f97\u5230\u5185\u6838\u6001\u7684\u5185\u6838\u670d\u52a1\u7684\u8fc7\u7a0b\uff1b 6. \u5904\u7406\u5668\u8c03\u5ea6\u5b50\u7cfb\u7edf\uff0c\u7528\u4e8e\u7406\u89e3\u64cd\u4f5c\u7cfb\u7edf\u7684\u8c03\u5ea6\u8fc7\u7a0b\u548c\u8c03\u5ea6\u7b97\u6cd5\uff1b 7. \u540c\u6b65\u4e92\u65a5\u4e0e\u8fdb\u7a0b\u95f4\u901a\u4fe1\u5b50\u7cfb\u7edf\uff0c\u4e86\u89e3\u8fdb\u7a0b\u95f4\u5982\u4f55\u8fdb\u884c\u4fe1\u606f\u4ea4\u6362\u548c\u5171\u4eab\uff0c\u5e76\u4e86\u89e3\u540c\u6b65\u4e92\u65a5\u7684\u5177\u4f53\u5b9e\u73b0\u4ee5\u53ca\u5bf9\u7cfb\u7edf\u6027\u80fd\u7684\u5f71\u54cd\uff0c\u7814\u7a76\u6b7b\u9501\u4ea7\u751f\u7684\u539f\u56e0\uff0c\u4ee5\u53ca\u5982\u4f55\u907f\u514d\u6b7b\u9501\uff1b 8. \u6587\u4ef6\u7cfb\u7edf\uff0c\u4e86\u89e3\u6587\u4ef6\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u4e0e\u8fdb\u7a0b\u7ba1\u7406\u7b49\u7684\u5173\u7cfb\uff0c\u4e86\u89e3\u7f13\u5b58\u5bf9\u64cd\u4f5c\u7cfb\u7edfIO\u8bbf\u95ee\u7684\u6027\u80fd\u6539\u8fdb\uff0c\u4e86\u89e3\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\uff08VFS\uff09\u3001buffer cache\u548cdisk driver\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p> <p>\u5176\u4e2d\u6bcf\u4e2a\u5f00\u53d1\u6b65\u9aa4\u90fd\u662f\u5efa\u7acb\u5728\u4e0a\u4e00\u4e2a\u6b65\u9aa4\u4e4b\u4e0a\u7684\uff0c\u5c31\u50cf\u642d\u79ef\u6728\uff0c\u4ece\u4e00\u4e2a\u4e00\u4e2a\u5c0f\u6728\u5757\uff0c\u6700\u7ec8\u642d\u51fa\u6765\u4e00\u4e2a\u5c0f\u623f\u5b50\u3002\u5728\u642d\u623f\u5b50\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5b8c\u6210\u4ece\u7406\u89e3\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u5230\u5b9e\u8df5\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u7684\u63a2\u7d22\u8fc7\u7a0b\u3002\u8fd9\u4e2a\u623f\u5b50\u6700\u7ec8\u7684\u5efa\u7b51\u67b6\u6784\u548c\u5efa\u8bbe\u8fdb\u5ea6\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u56fe1 ucore\u7cfb\u7edf\u7ed3\u6784\u56fe</p>"},{"location":"lab0/lab0/#os-lab","title":"\u5f00\u53d1OS lab\u5b9e\u9a8c\u7684\u7b80\u5355\u6b65\u9aa4","text":"<ol> <li>\u6309\u7167\u6bcf\u4e2a\u5b9e\u9a8c\u6307\u5bfc\u4e66\u4e2d\u7684<code>\u7f16\u8bd1\u65b9\u6cd5</code>\u90e8\u5206\uff0c\u5c06Makefile\u4e2d\u7684<code>LAB CONFIG</code>\u533a\u57df\u4fee\u6539\u4e3a\u5f53\u524d\u5b9e\u9a8c\u9700\u8981\u7684\u90e8\u5206\u3002</li> <li>\u6267\u884c<code>make clean</code></li> <li>\u6839\u636e\u6307\u5bfc\u4e66\uff0c\u53c2\u9605uCore\u5df2\u6709\u4ee3\u7801\uff0c\u4e86\u89e3uCore\u4e2d\u4e00\u4e9b\u6a21\u5757\u7684\u57fa\u672c\u5de5\u4f5c\u6d41\u7a0b\uff0c\u7136\u540e\u5b8c\u6210\u6bcf\u4e2a\u7ec3\u4e60\u7684\u8981\u6c42\u3002</li> <li>\u6267\u884c<code>make qemu -j 16</code>\uff0c\u8fd0\u884c\u5f53\u524d\u5b9e\u9a8c\uff0c\u68c0\u67e5\u8fd0\u884c\u60c5\u51b5\u3002\u5176\u4e2d16\u53ef\u4ee5\u66ff\u6362\u4e3a\u4f60\u7684\u673a\u5668\u7684CPU\u7ebf\u7a0b\u6570\u4ee5\u8fbe\u5230\u6700\u4f73\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002</li> <li>\u82e5\u8fd0\u884c\u4e0d\u6210\u529f\uff0c\u53ef\u4ee5\u5206\u522b\u5728\u4e24\u4e2a\u7ec8\u7aef\u4e2d\u4f7f\u7528<code>make debug</code>\u4e0e<code>make gdb</code>\uff0c\u4f7f\u7528gdb\u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5\u3002</li> </ol> <p>Warning</p> <p>\u4e0a\u8ff0\u6b65\u9aa4\u4e0d\u9002\u7528\u4e8eLab0</p>"},{"location":"lab0/prepare/","title":"\u51c6\u5907\u77e5\u8bc6","text":""},{"location":"lab0/prepare/#_1","title":"\u5f00\u7bc7","text":"<p>\u76f8\u4fe1\u5927\u5bb6\u901a\u8fc7\u201c\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u201d\u8fd9\u95e8\u8bfe\u7a0b\u5df2\u7ecf\u5bf9\u8ba1\u7b97\u673a\u5982\u4f55\u8ba1\u7b97\u4ee5\u53ca\u6267\u884c\u6307\u4ee4\u6709\u4e86\u4e00\u5b9a\u7684\u4e86\u89e3\u3002</p> <p>\u4f46\u6211\u4eec\u8ba1\u7b97\u673a\u7684\u5904\u7406\u5668\u9664\u4e86\u7b80\u5355\u5730\u6267\u884c\u6307\u4ee4\u4e4b\u5916\uff0c\u5b83\u8fd8\u62e5\u6709\u7279\u6743\u7ea7\u7ba1\u7406\u3001\u5f02\u5e38\u4e0e\u4e2d\u65ad\u7b49\u529f\u80fd\uff0c\u8fd9\u4e9b\u786c\u4ef6\u529f\u80fd\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u8f6f\u4ef6\u5bc6\u5207\u76f8\u5173\u3002</p> <p>\u76f8\u4fe1\u5927\u5bb6\u5728\u901a\u8fc7\u672c\u5b9e\u9a8c\u7684\u5b66\u4e60\u540e\uff0c\u80fd\u591f\u5bf9\u8ba1\u7b97\u673a\u7684\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7684\u8fd0\u884c\u6d41\u7a0b\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\uff0c\u89e3\u5f00\u5927\u5bb6\u5fc3\u4e2d\u8ba1\u7b97\u673a\u5e95\u5c42\u7684\u795e\u79d8\u9762\u7eb1\u3002</p>"},{"location":"lab0/prepare/#loongarch32","title":"LoongArch32\u7b80\u4ecb","text":"<p>LoongArch\u662f\u4e00\u79cd\u7cbe\u7b80\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u5206\u4e3a32\u4f4d\u4e0e64\u4f4d\u4e24\u4e2a\u7248\u672c\u3002\u6211\u4eec\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u91c7\u7528\u7684\u662f32\u4f4d\u7248\u672c\u3002</p>"},{"location":"lab0/prepare/#_2","title":"\u901a\u7528\u5bc4\u5b58\u5668","text":"<p>LoongArch32\u670932\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u8bb0\u4e3ar0~r31\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u5728ABI\u4e2d\u5b9a\u4e49\u4e86\u5bf9\u5e94\u7684\u522b\u540d\uff0c\u5982\u4e0b\uff1a</p> \u540d\u79f0 \u522b\u540d \u7528\u9014 \u5728\u8c03\u7528\u4e2d\u662f\u5426\u4fdd\u7559 <code>$r0</code> <code>$zero</code> \u5e38\u6570 <code>0</code> \uff08\u5e38\u6570\uff09 <code>$r1</code> <code>$ra</code> \u8fd4\u56de\u5730\u5740 \u5426 <code>$r2</code> <code>$tp</code> \u7ebf\u7a0b\u6307\u9488 \uff08\u4e0d\u53ef\u5206\u914d\uff09 <code>$r3</code> <code>$sp</code> \u6808\u6307\u9488 \u662f <code>$r4</code> - <code>$r5</code> <code>$a0</code> - <code>$a1</code> \u4f20\u53c2\u5bc4\u5b58\u5668\u3001\u8fd4\u56de\u503c\u5bc4\u5b58\u5668 \u5426 <code>$r6</code> - <code>$r11</code> <code>$a2</code> - <code>$a7</code> \u4f20\u53c2\u5bc4\u5b58\u5668 \u5426 <code>$r12</code> - <code>$r20</code> <code>$t0</code> - <code>$t8</code> \u4e34\u65f6\u5bc4\u5b58\u5668 \u5426 <code>$r21</code> \u4fdd\u7559 \uff08\u4e0d\u53ef\u5206\u914d\uff09 <code>$r22</code> <code>$fp</code> / <code>$s9</code> \u6808\u5e27\u6307\u9488 / \u9759\u6001\u5bc4\u5b58\u5668 \u662f <code>$r23</code> - <code>$r31</code> <code>$s0</code> - <code>$s8</code> \u9759\u6001\u5bc4\u5b58\u5668 \u662f <p>\u6ce8\uff1aLoongArch32\u8001\u7248\u672cABI\u4e2d\u5b58\u5728\u4e0e<code>v0</code>\u3001<code>v1</code>\u5bc4\u5b58\u5668\uff0c\u4e0e<code>a0</code>\u3001<code>a1</code>\u540c\u4e3a<code>$r4</code>\u4e0e<code>$r5</code>\u5bc4\u5b58\u5668\u7684\u522b\u540d\uff0c\u5728\u65b0\u7248ABI\u4e2d\u5df2\u88ab\u820d\u5f03\u3002</p>"},{"location":"lab0/prepare/#_3","title":"\u57fa\u672c\u6574\u6570\u6307\u4ee4","text":"<p>\u8fd9\u4e00\u90e8\u5206\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u53c2\u8003\u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf\u3002</p>"},{"location":"lab0/prepare/#marco","title":"marco\u6307\u4ee4","text":"<p>marco\u6307\u4ee4\u662f\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u65f6\u6d89\u53ca\u5230\u7684\u4e00\u79cd\u7279\u6b8a\u6307\u4ee4\uff0c\u5b83\u672c\u8eab\u4e0d\u5b9a\u4e49\u5728ISA\u4e2d\u3002\u8fd9\u4e9bmarco\u6307\u4ee4\u5b9a\u4e49\u51fa\u6765\u540e\u4f1a\u5728\u6c47\u7f16\u5668\u7ffb\u8bd1\u6210\u5176\u4ed6\u4e00\u6761\u6216\u591a\u6761\u771f\u5b9e\u5b58\u5728\u7684\u6307\u4ee4\uff0c\u800c\u5b83\u5b58\u5728\u7684\u610f\u4e49\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u4ee3\u7801\u65f6\u80fd\u591f\u66f4\u52a0\u65b9\u4fbf\u3002</p> <p>\u5728\u6211\u4eec\u79fb\u690d\u7684uCore for LoongArch32\u4e2d\uff0c\u53ea\u7528\u5230\u4e86\u4e00\u79cdmarco\u6307\u4ee4\uff0c\u5c31\u662f<code>li.w</code>\u3002\u56e0\u4e3aLoongArch32\u4e0d\u652f\u630132\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u591a\u6761\u6307\u4ee4\u62fc\u51d1\u51fa\u4e00\u4e2a32\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528<code>li.w</code>\u76f4\u63a5\u5e2e\u6211\u4eec\u62fc\u63a5\uff0c\u6700\u7ec8\u751f\u6210\u51fa\u6765\u7684\u662f<code>lu12i.w</code>\u4e0e\u4e00\u6761<code>ori</code>\u6307\u4ee4\u5171\u540c\u5b8c\u6210li.w\u7684\u64cd\u4f5c\u3002</p> <p>\u7531\u4e8e\u52a9\u6559\u6682\u672a\u627e\u5230\u9f99\u82af\u76f8\u5173\u6587\u6863\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfb\u6c47\u7f16\u5668\u7684\u6307\u4ee4\u5b9a\u4e49\u4ee3\u7801\u624b\u52a8\u9006\u5411marco\u6307\u4ee4\uff1ahttps://gitee.com/loongson-edu/la32r_binutils/blob/master/opcodes/loongarch-opc.c</p> <p>\u5982\u679c\u6709\u5174\u8da3\u7684\u540c\u5b66\u60f3\u77e5\u9053\u8fd9\u4e9bopcodes\u5982\u4f55\u5b9a\u4e49\uff0c\u53ef\u4ee5\u53c2\u8003\u52a9\u6559\u7684\u535a\u5ba2\uff0c\u66fe\u7ecf\u505a\u8fc7RISC-V\u4e0a\u6dfb\u52a0\u6307\u4ee4\u7684\u5de5\u4f5c\u3002</p>"},{"location":"lab0/prepare/#loongarch32_1","title":"LoongArch32\u62ff\u6765\u505a\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u6709\u4ec0\u4e48\u597d\u5904\uff1f","text":"<p>\u5feb\u901f\u4e0a\u624b\u5bb9\u6613\uff0c\u4e0eMIPS\u975e\u5e38\u76f8\u4f3c\uff0c\u7b80\u5355\u6613\u61c2\u3002\u4e14\u5177\u6709\u4e2d\u6587\u6587\u6863\u3002</p> <p>\u76f8\u6bd4x86\uff0c\u5386\u53f2\u5305\u88b1\u8f7b\uff0c\u4e0d\u9700\u8981\u4e86\u89e3\u5404\u79cdPIO\u76f8\u5173\u5bc4\u5b58\u5668\u7684\u8bbe\u7f6e\u4ee5\u53ca\u5206\u6bb5\u7ba1\u7406\u3002</p> <p>\u76f8\u6bd4RISC-V\uff0c\u5e26MMU\u7684\u64cd\u4f5c\u7cfb\u7edf\u76f4\u63a5\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\uff0c\u4e0d\u9700\u8981\u4e86\u89e3SBI\u4ee5\u53caSupervisor\u7279\u6743\u7ea7\u7b49\u4e00\u7cfb\u5217\u5185\u5bb9\u3002</p>"},{"location":"lab0/prepare/#loongarch32x86armrisc-v","title":"LoongArch32\u4e0ex86\u3001ARM\u3001RISC-V\u5728\u5185\u5b58\u7ba1\u7406\u4e0a\u7684\u533a\u522b","text":"<p>\u5b83\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u91c7\u7528 \u8f6f\u4ef6\u63a7\u5236TLB \uff0c\u4e0eMIPS\u7c7b\u4f3c\uff0c\u5f53TLB\u67e5\u627e\u5931\u8d25\u6216TLB\u67e5\u627e\u6210\u529f\u4f46\u6709\u6548\u4f4d\u4e3a0\u65f6\uff0c\u4ea7\u751f\u5bf9\u5e94\u7684TLB\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002</p> <p>\u800cx86\u3001ARM\u3001RISC-V\u90fd\u662f\u91c7\u7528\u786c\u4ef6\u904d\u5386\u9875\u8868\u65b9\u5f0f\uff0c\u8f6f\u4ef6\u53ea\u9700\u8981\u5c06\u9875\u8868\u57fa\u5730\u5740\u901a\u8fc7\u4e00\u4e2aCSR\u544a\u77e5\u786c\u4ef6\uff08\u5982x86\u4e0a\u7684CR3\u3001RISC-V\u4e0a\u7684satp\uff09\uff0c\u786c\u4ef6\u5b8c\u6210TLB\u586b\u5145\u3002\u53ea\u6709\u5f53\u9875\u8868\u904d\u5386\u53d1\u73b0\u9875\u9762\u65e0\u6548\u65f6\u624d\u4ea7\u751f\u7f3a\u9875\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002</p> <p>\u56e0\u6b64\uff0c\u5728LoongArch32\u4e0eMIPS\u4e00\u6837 \u6ca1\u6709\u7f3a\u9875\u5f02\u5e38 \uff0c\u5176\u7f3a\u9875\u5f02\u5e38\u5305\u542b\u5728TLB\u5f02\u5e38\u4e2d\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u5224\u65ad\u662f\u5426\u662f\u7f3a\u9875\u3002</p> <p>\u5728x86\u3001ARM\u3001RISC-V\u4e0a \u6ca1\u6709TLB\u5f02\u5e38\u3002</p>"},{"location":"lab0/prepare/#_4","title":"\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668","text":"<p>\u6211\u4eec\u4e5f\u8bb8\u77e5\u9053CPU\u4e0a\u6709\u4e00\u4e9b\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u751a\u81f3\u6709\u4e00\u4e9b\u540c\u5b66\u80fd\u975e\u5e38\u719f\u6089\u4ed6\u4eec\u7684\u540d\u5b57\uff0c\u4f8b\u5982x86-64\u4e0a\u7684RAX\u3001RSP\u3001RBP\u7b49\uff0cARM/MIPS/RISC-V\u4e0a\u768432\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u4ee5\u53ca\u5404\u81ea\u7684\u522b\u540d\uff0c\u5982a0\u3001a1\u3001sp\u3001ra\u7b49\u3002</p> <p>\u4f46\u6211\u4eec\u7684CPU\u4e0a\uff0c\u8fd8\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u5bc4\u5b58\u5668\uff0c\u5b83\u79f0\u4e3a\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\uff08Control/Status Registers\uff0cCSR\uff09\uff0c\u5b83\u5bf9\u8ba1\u7b97\u673a\u7684\u7cfb\u7edf\u72b6\u6001\u4e0e\u63a7\u5236\u8fdb\u884c\u7ba1\u7406\u3002\u5e76\u901a\u8fc7CSR\u6307\u4ee4\u5bf9\u4ed6\u4eec\u8fdb\u884c\u8bfb\u5199\uff0c\u5728\u4fee\u6539\u540e\uff0c\u8ba1\u7b97\u673a\u7684\u8fd0\u884c\u72b6\u6001\u4e5f\u5c31\u968f\u4e4b\u6539\u53d8\u3002</p> <p>\u4f8b\u5982\uff0c\u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u6709\u4e24\u79cd\u7279\u6743\u7ea7\uff0cPLV0\uff08\u4fd7\u79f0\u5185\u6838\u6001\uff09\u4e0ePLV3\uff08\u4fd7\u79f0\u7528\u6237\u6001\uff09\u3002\u7c7b\u4f3c\u4e8ex86\u67b6\u6784\u4e0a\u7684Ring0\u4e0eRing3\u3002\u4e5f\u7c7b\u4f3cARM\u4e0a\u7684EL0\u4e0eEL3\uff0c\u4ee5\u53caRISC-V\u67b6\u6784\u4e2d\u7684Machine\u4e0eUser\u3002</p> <p>Note</p> <p>\u5c0f\u601d\u8003\uff1a\u64cd\u4f5c\u7cfb\u7edf\u4e00\u5b9a\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\u5417\uff1f\u5982\u679c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u4e0a\u8fd8\u6709\u4e00\u5c42\u7279\u6743\u7ea7\u4f1a\u5e26\u6765\u4ec0\u4e48\u597d\u5904\uff1f</p> <p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u4e86\u89e3RISC-V\u67b6\u6784\u4e2d\u7684Supervisor\u7279\u6743\u7ea7\u4ee5\u53ca\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u7684\u865a\u62df\u5316\u673a\u5236\u3002</p> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4f1a\u6d89\u53ca\u5230CSR\u7684<code>CRMD</code>\u72b6\u6001\u4fee\u6539\u3001<code>DMW0</code>\u4e0e<code>DMW1</code>\u7684\u914d\u7f6e\u3002\u5173\u4e8e\u8fd9\u91cc\u7684\u5bc4\u5b58\u5668\u5404\u4f4d\u57df\u7684\u5177\u4f53\u542b\u4e49\u4ee5\u53ca\u914d\u7f6e\u65b9\u5f0f\uff0c\u9700\u8981\u5927\u5bb6\u81ea\u884c\u9605\u8bfb\u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf\u5b8c\u6210\u3002</p> <p>Info</p> <p>\u8bf7\u5927\u5bb6\u81ea\u884c\u9605\u8bfb\u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf\u4e2d\u7684P55, \u4e86\u89e3CRMD\u540e\uff0c\u518d\u7ee7\u7eed\u4e86\u89e3\u540e\u7eed\u5185\u5bb9\u3002</p> <p>\u5173\u4e8eDMW\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u53ef\u4ee5\u6682\u65f6\u8df3\u8fc7\uff0c\u6211\u4eec\u4f1a\u5728\u540e\u6587\u4e2d\u4ecb\u7ecd\uff0c\u53ef\u5c4a\u65f6\u518d\u56de\u8fc7\u5934\u6765\u770bDMW\u7684\u5bc4\u5b58\u5668\u3002</p>"},{"location":"lab0/prepare/#io","title":"I/O\u4e0e\u5730\u5740\u7a7a\u95f4","text":""},{"location":"lab0/prepare/#io_1","title":"I/O\u7b80\u4ecb","text":"<p>\u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u5f53\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u8fde\u63a5\u4e0a\u4e00\u4e2a\u5916\u8bbe\u65f6\uff0c\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u53d1\u73b0\u8fd9\u4e9b\u5916\u8bbe\u7684\u8fde\u63a5\uff1f\u5916\u8bbe\u4e0e\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u4ea4\u4e92\u7684\u5462\uff1f</p> <p>\u8fd9\u91cc\u5c31\u9700\u8981\u6d89\u53ca\u5230I/O\u7684\u6982\u5ff5\u3002</p> <p>\u5728\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u4e2d\uff0cI/O\u65b9\u5f0f\u901a\u5e38\u53ef\u5206\u4e3a3\u79cd\uff1a</p>"},{"location":"lab0/prepare/#pmio-port-mapped-io","title":"PMIO (Port-Mapped I/O)","text":"<p>\u8fd9\u662f\u4e00\u79cd\u975e\u5e38\u7279\u6b8a\u7684I/O\uff0c\u5728LoongArch32\u3001RISC-V\u3001ARM\u3001MIPS\u4e2d \u5747\u4e0d\u5b58\u5728 \u3002</p> <p>\u5728x86\uff08\u542bx86-64\uff09\u67b6\u6784\u4e2d\uff0c\u6709\u4e00\u4e2a\u4e0e\u5185\u5b58\u72ec\u7acb\u7684I/O\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u7528<code>in[blw]</code>\u4e0e<code>out[blw]</code>\u6307\u4ee4\uff0c\u5b8c\u6210I/O\u5730\u5740\u4e0eGPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u95f4\u7684\u6570\u636e\u79fb\u52a8\u3002</p>"},{"location":"lab0/prepare/#mmio-memory-mapped-io","title":"MMIO (Memory-Mapped I/O)","text":"<p>\u5185\u5b58\u6620\u5c04I/O\u5c31\u662f\u5c06I/O\u8bbe\u5907\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\uff0c\u50cf\u8bfb\u5199\u5185\u5b58\u4e00\u6837\u8bbf\u95eeI/O\u8bbe\u5907\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u5bf9\u4e8e\u8f6f\u4ef6\u800c\u8a00\u975e\u5e38\u65b9\u4fbf\uff0c\u4ec5\u9700\u8981\u7528\u4e00\u4e2a\u6307\u9488\u6307\u5411\u5bf9\u5e94\u7684MMIO\u8bbe\u5907\u4e0a\u7684\u5730\u5740\uff0c\u5e76\u4e86\u89e3\u8bfb\u5199MMIO\u8bbe\u5907\u5730\u5740\u7684\u5177\u4f53\u542b\u4e49\u5373\u53ef\u5b8c\u6210IO\u64cd\u4f5c\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u5230\u7684UART\u4e32\u53e3\u5c31\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u8fdb\u884cIO\u4ea4\u4e92\u3002</p>"},{"location":"lab0/prepare/#dma-direct-memory-access","title":"DMA  (Direct Memory Access)","text":"<p>\u5c3d\u7ba1MMIO\u5f88\u65b9\u4fbf\uff0c\u4f46\u5b83\u7684\u6570\u636e\u642c\u8fd0\u9700\u8981CPU\u53c2\u4e0e\uff0c\u6548\u7387\u8f83\u4f4e\u3002</p> <p>\u5bf9\u4e8e\u4e00\u6b21\u8bbf\u95ee\u5927\u91cf\u6570\u636e\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba9\u8bbe\u5907\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\uff0c\u907f\u514d\u7ecf\u8fc7CPU\u5f71\u54cd\u6548\u7387\u3002</p> <p>\u73b0\u5728\u8ba1\u7b97\u673a\u7684\u9ad8\u901fIO\uff0c\u4f8b\u5982\u7f51\u5361\u3001\u786c\u76d8\u63a7\u5236\u5668\u3001GPU\uff0c\u90fd\u4f7f\u7528DMA\u6280\u672f\u5c06\u6570\u636e\u7f13\u51b2\u533a\u76f4\u63a5\u653e\u7f6e\u4e8e\u5185\u5b58\uff0c\u907f\u514d\u5927\u91cf\u6570\u636e\u4f20\u8f93\u65f6\u9700\u8981\u5927\u91cfMMIO\u8bbf\u95ee\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u63d0\u9192\u540c\u5b66\u4eec\u6ce8\u610f\u7684\u662f\uff0cDMA\u8bbf\u95ee\u901a\u5e38\u4e0e\u5176\u4ed6IO\u65b9\u5f0f\u4ee5\u53ca\u4e2d\u65ad\u914d\u5408\u4f7f\u7528\u3002\u5176\u4ed6IO\u65b9\u5f0f\u7528\u4e8e\u8fdb\u884cDMA\u4f20\u8f93\u7684\u63a7\u5236\uff0c\u4e2d\u65ad\u7528\u4e8e\u901a\u77e5DMA\u72b6\u6001\u6539\u53d8\uff0c\u4f8b\u5982\u6709\u65b0\u6570\u636e\u5df2\u7ecf\u5b8c\u6210\u5199\u5165\u5185\u5b58\u6216\u8005\u7f13\u51b2\u533a\u5df2\u7ecf\u53d1\u5230\u5bf9\u5e94\u7684\u8bbe\u5907\u3002</p> <p>Note</p> <p>\u5c0f\u601d\u8003\uff1a</p> <ol> <li> <p>\u5982\u679cCPU\u6709Cache\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u4e0d\u80fd\u7ecf\u8fc7Cache\u5462\uff1f\u4e3a\u4ec0\u4e48\uff1f</p> </li> <li> <p>\u5982\u679cCPU\u4e3a\u4e71\u5e8f\u591a\u53d1\u5c04\u67b6\u6784\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u5426\u4e71\u5e8f\u53d1\u51fa\u5462\uff1f</p> </li> <li> <p>\u9664\u4e86\u63d2\u5165\u5185\u5b58\u5c4f\u969c\u6307\u4ee4\u5916\uff0c\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u8fd8\u63d0\u4f9b\u4e86\u4ec0\u4e48\u914d\u7f6e\u4f7f\u5f97\u4f7f\u7528\u865a\u62df\u5730\u5740\u8fdb\u884cMMIO\u8bbf\u95ee\u65f6CPU\u4e00\u5b9a\u80fd\u786e\u4fdd\u987a\u5e8f\u6267\u884c\uff1f</p> </li> <li> <p>\u5982\u679cCPU\u6709Cache\uff0cDMA\u64cd\u4f5c\u4e0d\u7ecf\u8fc7Cache\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\u4ea7\u751f\u4e86Cache\u7684\u6570\u636e\u4e0e\u5185\u5b58\u4e0d\u4e00\u81f4\u600e\u4e48\u529e\uff1f\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u4e0e\u4e0d\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u5206\u522b\u600e\u4e48\u505a\uff1f</p> </li> <li> <p>\u5728C\u8bed\u8a00\u4e2d\u5b8c\u6210MMIO\u8bbf\u95ee\u65f6\uff0c\u4e3a\u4ec0\u4e48\u901a\u5e38\u4f1a\u5bf9\u6307\u5411\u8981\u8bbf\u95ee\u7684\u6570\u636e\u7684\u6307\u9488\u52a0\u4e0a volatile \u5173\u952e\u5b57\uff0c\u5b83\u4f1a\u5982\u4f55\u5f71\u54cd\u7f16\u8bd1\u5668\u884c\u4e3a\uff1f\uff08\u540c\u5b66\u4eec\u53ef\u4ee5\u8bd5\u8bd5\u770b\u7b80\u5355\u5199\u4e00\u4e2a\u8fde\u7eed\u8fdb\u884cMMIO\u8bbf\u95ee\u7684\u88f8\u673a\u7a0b\u5e8f\uff0c\u5e76\u5728\u7f16\u8bd1\u65f6\u5f00\u542fO2\u4f18\u5316\uff0c\u89c2\u5bdf\u751f\u6210\u6c47\u7f16\u7684\u53d8\u5316\u3002\uff09</p> </li> <li> <p>\u65e2\u7136\u8bbf\u95ee\u7684\u6570\u636e\u7ec8\u7a76\u662f\u8981\u88ab\u4f7f\u7528\u7684\uff0c\u90a3\u4e48\u5747\u644a\u65f6\u95f4\u6765\u8bf4DMA\u7684\u4f18\u52bf\u5728\u54ea\u91cc\u5462\uff1f\uff08\u63d0\u793a\uff1a\u53ef\u4ee5\u4e86\u89e3\u5355\u6b21Uncached\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u4ee5\u53ca\u540e\u7eed\u4f53\u7cfb\u67b6\u6784\u8bfeCache\u5b9e\u9a8c\u4e2d\u7684\u603b\u7ebf\u7a81\u53d1\u4f20\u8f93\uff0cSIMD\u6307\u4ee4\uff0c\u8f6f\u4ef6\u4e0a\u5bf9\u6570\u636e\u7684\u96f6\u62f7\u8d1d\u5904\u7406\uff0c\u6216\u8bb8\u80fd\u591f\u89e3\u7b54\u540c\u5b66\u4eec\u7684\u7591\u60d1\u3002\uff09</p> </li> </ol>"},{"location":"lab0/prepare/#_5","title":"\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u77e5\u9053\u8fd9\u53f0\u8ba1\u7b97\u673a\u4e0a\u6709\u54ea\u4e9b\u8bbe\u5907\uff1f","text":""},{"location":"lab0/prepare/#e820acpi","title":"e820\u4e0eACPI","text":"<p>\u5728x86\u8ba1\u7b97\u673a\u4e2d\uff0cBIOS\u63d0\u4f9b\u4e86\u4e00\u4e2ae820\u5185\u5b58\u7ba1\u7406\u5668\uff0c\u5e76\u901a\u8fc7\u4e2d\u65ad\u6307\u4ee4\uff08x86\u4e0a\u7684int\uff09\u8c03\u7528BIOS\u5b8c\u6210\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u63a2\u6d4b\u3002</p> <p>\u6709\u5728x86\u8ba1\u7b97\u673a\u4e0a\u4f7f\u7528Linux\u7684\u540c\u5b66\u4eec\uff0c\u53ef\u4ee5\u901a\u8fc7dmesg\u547d\u4ee4\u67e5\u770b\u5185\u6838\u7684\u8f93\u51fa\uff0c\u5728\u5185\u6838\u542f\u52a8\u65f6\u53ef\u4ee5\u627e\u5230BIOS\u63d0\u4f9b\u7684e820\u5185\u5b58\u6620\u5c04\u8868\uff0c\u4e14\u5982\u679c\u540c\u5b66\u4eec\u7684\u8ba1\u7b97\u673a\u91c7\u7528\u6838\u5fc3\u663e\u5361\uff0c\u5f80\u5f80\u4f1a\u770b\u5230\u6570\u767e\u5146\u751a\u81f3\u6570GB\u7684\u5185\u5b58\u5e26\u4e0a\u4e86reserved\u6807\u8bb0\uff0c\u8fd9\u662f\u56e0\u4e3a\u6838\u5fc3\u663e\u5361\u4f1a\u5360\u7528\u4e00\u90e8\u5206\u5185\u5b58\u3002\u4f46\u8fd9\u91cc\u8fd8\u8981\u63d0\u9192\u540c\u5b66\u4eec\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u865a\u62df\u673a\u7684\u8bdd\uff0c\u770b\u7684\u5c31\u662f\u4f60\u865a\u62df\u673a\u7684e820\u800c\u4e0d\u662f\u771f\u5b9e\u8ba1\u7b97\u673aBIOS\u6c47\u62a5\u7684e820\u4e86\u3002</p> <p>ACPI\uff08Advanced Configuration and Power Interface\uff09\u662f\u4e0a\u4e2a\u4e16\u7eaa90\u5e74\u4ee3\u4ea7\u751f\u7684\u4e00\u79cd\u5f00\u653e\u6807\u51c6\uff0c\u5b83\u5b9a\u4e49\u4e86\u7cfb\u7edf\u56fa\u4ef6\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u786c\u4ef6\u62bd\u8c61\u63a5\u53e3\u3002x86\u8ba1\u7b97\u673a\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u5c31\u53ef\u4ee5\u5229\u7528ACPI\u5bf9\u56fa\u4ef6\u51fd\u6570\u8fdb\u884c\u8c03\u7528\uff0c\u83b7\u53d6\u7cfb\u7edf\u4e0a\u7684\u5185\u5b58\u5e03\u5c40\u3001\u5404\u8bbe\u5907\u6240\u5904\u7684\u4f4d\u7f6e\u548c\u8bbe\u5907\u578b\u53f7\u7b49\uff0c\u5c31\u5b9e\u73b0\u4e86\u540c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u80fd\u591f\u517c\u5bb9\u591a\u79cd\u4e0d\u540c\u7684\u8ba1\u7b97\u673a\u3002</p>"},{"location":"lab0/prepare/#_6","title":"\u8bbe\u5907\u6811","text":"<p>\u81ea\u5df1\u7ed9\u4e00\u4e9b\u5d4c\u5165\u5f0f\u5f00\u53d1\u677f\u7f16\u8bd1\u8fc7\u7cfb\u7edf\u8f6f\u4ef6\u7684\u540c\u5b66\u4e00\u5b9a\u5bf9\u8bbe\u5907\u6811\u4e0d\u964c\u751f\u3002</p> <p>\u5728\u8fd9\u4e9b\u6ca1\u6709ACPI\u673a\u5236\u7684\u5e73\u53f0\u4e0a\uff0c\u901a\u5e38\u91c7\u7528\u4e00\u79cd\u53eb\u505a\u8bbe\u5907\u6811\u7684\u811a\u672c\u6765\u63cf\u8ff0\u8ba1\u7b97\u673a\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u3002\u8be5\u8bbe\u5907\u6811\u901a\u5e38\u4f1a\u653e\u7f6e\u4e8eBootloader\u4e2d\u901a\u8fc7\u53c2\u6570\u4f20\u9012\u7ed9\u7cfb\u7edf\u5185\u6838\uff0c\u4e5f\u53ef\u80fd\u76f4\u63a5\u5185\u5d4c\u4e0e\u7cfb\u7edf\u5185\u6838\u4e2d\uff0c\u60f3\u8981\u77e5\u9053\u8bbe\u5907\u6811\u662f\u4e2a\u4ec0\u4e48\u6587\u4ef6\u7684\u540c\u5b66\u53ef\u4ee5\u7ffb\u770bLinux\u5185\u6838\u6e90\u4ee3\u7801\u7684<code>arch/*/boot/dts</code>\u6587\u4ef6\u5939\u3002</p> <p>\u800c\u5bf9\u4e8e\u4e00\u4e9b\u5373\u63d2\u5373\u7528\u7684\u8bbe\u5907\uff0c\u4f8b\u5982USB\u4e0ePCI-E\uff0c\u8bbe\u5907\u6811\u901a\u5e38\u4ec5\u63d0\u4f9b\u5176\u63a7\u5236\u5668\u672c\u8eab\u7684\u63cf\u8ff0\uff0c\u8fd9\u4e9b\u5373\u63d2\u5373\u7528\u8bbe\u5907\u7684\u5177\u4f53\u63a2\u6d4b\u4ea4\u7ed9\u63a7\u5236\u5668\u9a71\u52a8\u6765\u5b8c\u6210\u3002</p>"},{"location":"lab0/prepare/#_7","title":"\u8fd8\u53ef\u4ee5\u9009\u62e9\u4e0d\u63a2\u6d4b","text":"<p>\u5728LoongArch32\u7684uCore\u79fb\u690d\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u4efb\u4f55\u8bbe\u5907\u63a2\u6d4b\u7684\u65b9\u6cd5\u3002\u6bd5\u7adf\u6ca1\u6709ACPI\uff0c\u4e5f\u6ca1\u6709Bootloader\u4f20\u9012\u8bbe\u5907\u6811\uff0c\u5373\u4f7f\u6709\u4f20\u9012\u8bbe\u5907\u6811\u4e5f\u9700\u8981\u4e00\u90e8\u5206\u89e3\u6790\u8bbe\u5907\u6811\u7684\u4ee3\u7801\uff0c\u4f1a\u589e\u52a0\u7cfb\u7edf\u7684\u590d\u6742\u7a0b\u5ea6\u3002</p> <p>\u5bf9\u4e8e\u5185\u5b58\u5927\u5c0f\uff0c\u7531\u4e8eLoongArch32\u4e0b\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u662f\u4ece0\u5f00\u59cb\u8fde\u7eed\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8bbe\u5b9a\u4e00\u4e2a\u56fa\u5b9a\u503c32M\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002</p> <p>\u800c\u5bf9\u4e8eIO\u5916\u8bbe\uff0c\u5728uCore\u4e2d\u4ec5\u4f7f\u7528\u4e32\u53e3\uff0c\u4e14\u5b83\u7684MMIO\u5730\u5740\u4ee5\u53ca\u4e2d\u65ad\u670d\u52a1\u53f7\u5728\u6211\u4eec\u4f7f\u7528\u7684QEMU\u4e0eChiplab FPGA\u8f6f\u6838SoC\u73af\u5883\u4e2d\u90fd\u662f\u56fa\u5b9a\u7684\uff0c\u56e0\u6b64\u4e5f\u5c06\u8be5\u5730\u5740\u56fa\u5b9a\u4e86\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002</p>"},{"location":"lab0/prepare/#_8","title":"\u865a\u62df\u5730\u5740\u7ba1\u7406","text":"<p>LoongArch32\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662fDMW\uff0c\u4e00\u79cd\u662fTLB\u3002DMW\u7684\u67e5\u627e\u4f18\u5148\u4e8eTLB\u7684\u67e5\u627e\uff0c\u5f53\u4e24\u8005\u5747\u67e5\u627e\u5931\u8d25\u65f6\u4ea7\u751fTLB REFILL\u4f8b\u5916\uff08\u5f02\u5e38\uff09\u3002</p>"},{"location":"lab0/prepare/#dmw","title":"DMW","text":"<p>LoongArch32\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u65b9\u5f0f\uff0c\u79f0\u4e3a\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\uff08DMW\uff09\u3002\u5b83\u53ef\u4ee5\u63d0\u4f9b\u865a\u62df\u5730\u5740<code>[31:29]</code>\u90e8\u5206\u5230\u7269\u7406\u5730\u5740<code>[31:29]</code>\u7684\u6620\u5c04\u914d\u7f6e\u3002\u5e76\u53ef\u4ee5\u5728\u5730\u5740\u6620\u5c04\u7a97\u53e3\u4e2d\u8bbe\u7f6e\u5141\u8bb8\u8bbf\u95ee\u8be5\u7a97\u53e3\u7684\u7279\u6743\u7ea7\u4ee5\u53caCache\u5c5e\u6027\u3002</p> <p>\u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003\u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf\u4e2d\u7684P43\u3002</p>"},{"location":"lab0/prepare/#tlb","title":"TLB","text":"<p>\u5927\u5bb6\u5e94\u8be5\u5728\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u8bfe\u7a0b\u65f6\u5df2\u7ecf\u5bf9TLB\u6709\u4e00\u4e2a\u521d\u6b65\u7684\u4e86\u89e3\uff0c\u5b83\u662f\u4e00\u4e2a\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u7684\u7f13\u51b2\u533a\uff0c\u50a8\u5b58\u4e86\u6700\u8fd1\u4f7f\u7528\u7684\u4e00\u90e8\u5206\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5e76\u8bb0\u5f55\u4e86\u5bf9\u5e94\u865a\u62df\u9875\u9762\u7684\u5143\u6570\u636e\uff0c\u4f8b\u5982\u6743\u9650\u914d\u7f6e\u4e0eCache\u5c5e\u6027\u7b49\u3002</p> <p>\u4e5f\u8bb8\u6709\u7684\u540c\u5b66\u4f1a\u60f3\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981TLB\u800c\u4e0d\u662f\u6bcf\u6b21\u8bbf\u95ee\u9875\u8868\u52a0\u4e0aPage Table Cache\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u591a\u7ea7\u683c\u5f0f\u904d\u5386\u65f6\u9700\u8981\u9010\u5c42\u8bbf\u95ee\u591a\u4e2a\u5730\u5740\u5e76\u4e0d\u9002\u5408\u5904\u7406\u5668\u5355\u4e2a\u5468\u671f\u8bbf\u95ee\uff0c\u56e0\u4e3a\u786c\u4ef6\u4e0a\u5c06\u9875\u8868\u904d\u5386\u7684\u7ed3\u679c\u653e\u5728\u4e00\u4e2a\u7f13\u51b2\u533a\u4e2d\uff0c\u8fd9\u4e2a\u7f13\u51b2\u533a\u5c31\u662fTLB\u3002</p> <p>\u4e0d\u540c\u4e8ex86\u3001ARM\u3001RISC-V\u7b49\u67b6\u6784\uff0c\u7531\u786c\u4ef6\u904d\u5386\u9875\u8868\u586b\u5145TLB\uff0c\u5e76\u63d0\u4f9b\u9875\u8868\u57fa\u5730\u5740\u7b49\u5bc4\u5b58\u5668\u7531\u8f6f\u4ef6\u914d\u7f6e\u5f53\u524d\u5904\u7406\u5668\u904d\u5386\u7684\u9875\u8868\u3002LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u63a7\u5236TLB\u7684\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003\u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf\u4e2d\u7684P55\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6682\u4e0d\u6d89\u53caTLB\uff0c\u5927\u5bb6\u53ea\u9700\u8981\u4e86\u89e3\u5b83\u7684\u5b58\u5728\u5373\u53ef\u3002</p>"},{"location":"lab0/prepare/#dmw_1","title":"\u5982\u4f55\u914d\u7f6eDMW\uff1f","text":"<p>\u5bf9\u4e8e\u5927\u591a\u6570\u6307\u4ee4\u96c6\u67b6\u6784\u800c\u8a00\uff08\u6211\u4eec\u719f\u6089\u7684MIPS\u662f\u4e2a\u6709\u56fa\u5b9a\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u7279\u4f8b\uff09\uff0c\u5728\u8ba1\u7b97\u673a\u4e0a\u7535\u542f\u52a8\u65f6\uff0c\u8f6f\u4ef6\u8fd0\u884c\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u771f\u5b9e\u786c\u4ef6\u4e0a\u901a\u5e38\u4f1a\u5728\u4e0a\u7535\u542f\u52a8\u65f6\u4ece\u7b2c\u4e00\u7ea7Bootloader\u5f00\u59cb\u6267\u884c\u5b8c\u6210\u7cfb\u7edf\u7684\u521d\u59cb\u5316\uff0c\u518d\u9010\u7ea7\u8f7d\u5165\u66f4\u9ad8\u7ea7\u7684Bootloader\u4ee5\u81f3\u4e8e\u6700\u540e\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002\u800c\u5177\u4f53\u4ece\u54ea\u4e00\u7ea7\u5f00\u59cb\u4f7f\u7528\u865a\u62df\u5730\u5740\u53d6\u51b3\u4e8e\u5404\u67b6\u6784\u4ee5\u53ca\u7cfb\u7edf\u8f6f\u4ef6\u3002\u5bf9\u4e8e\u6211\u4eec\u672c\u6b21\u5b9e\u9a8c\u4f7f\u7528\u7684LoongArch32\u67b6\u6784\u800c\u8a00\uff0c\u5728QEMU\u4e0a\u8fd0\u884c\u65f6\u662f\u5728uCore\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u914d\u7f6eDMW\u7a97\u53e3\u5e76\u4fee\u6539CSR.CRMD\u5bc4\u5b58\u5668\u5f00\u59cb\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u3002\u800c\u5982\u679c\u662f\u4f7f\u7528Chiplab\u8f6f\u6838\uff0c\u5b83\u7684\u7b2c\u4e00\u7ea7Bootloader\u662fPMON\uff0c\u5728PMON\u4e2d\u5c31\u4f1a\u8bbe\u7f6eDMW\u5e76\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u3002</p> <p>\u5728uCore\u4e2d\uff0c\u4f1a\u914d\u7f6e\u4e24\u4e2aDMW\u7a97\u53e3\uff0c\u5206\u522b\u7528\u4e8e\u5185\u6838\u666e\u901a\u7684DRAM\u8bbf\u95ee\u4e0eIO\u5916\u8bbe\u8bbf\u95ee\uff0c\u5982\u4e0b\uff1a</p> DMW\u7f16\u53f7 MAT\uff08\u5b58\u50a8\u8bbf\u95ee\u7c7b\u578b\uff09 PLV0 PLV3 PSEG VSEG VSEG\u8303\u56f4 DMW0 1\uff08\u4e00\u81f4\u53ef\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b101 <code>0xa0000000-0xbfffffff</code> DMW1 0\uff08\u5f3a\u5e8f\u975e\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b100 <code>0x80000000-0x9fffffff</code> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u662f\u4eceQEMU\u6a21\u62df\u5668\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0cDMW\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\uff0c\u4f46\u5982\u679c\u662f\u4eceChiplab\u7684FPGA\u8f6f\u6838\u4e0a\u4f7f\u7528PMON\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7531\u4e8ePMON\u672c\u8eab\u5df2\u7ecf\u8fdb\u884cDMW\u7684\u914d\u7f6e\u5e76\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\uff0c\u56e0\u6b64\u6211\u4eec\u7684DMW\u914d\u7f6e\u5fc5\u987b\u4e0ePMON\u4e00\u81f4\u624d\u80fd\u4fdd\u8bc1\u7cfb\u7edf\u6b63\u5e38\u542f\u52a8\u3002</p> <p>\u7279\u522b\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cLoongArch32\u7684QEMU\u6709\u4e00\u4e2a\u7279\u70b9\u662f\u5b83\u4f1a\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u53bb\u9664\u7269\u7406\u5730\u5740\u7684\u9ad83\u4f4d\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u914d\u7f6eDMW\u65f6\u80fd\u591f\u6b63\u786e\u542f\u52a8\u7cfb\u7edf\u8f6f\u4ef6\uff0c\u4f46\u771f\u5b9e\u7684LoongArch32\u786c\u4ef6\uff08\u5982Chiplab\u8f6f\u6838\uff09\u4e0d\u4f1a\u8fd9\u4e48\u505a\u3002\u56e0\u6b64\u5927\u5bb6\u5728\u7f16\u5199\u7cfb\u7edf\u8f6f\u4ef6\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a\u7279\u5f81\uff0c\u7f16\u5199\u90a3\u4e9b\u8fd0\u884c\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u7684\u4ee3\u7801\u65f6\u9700\u8981\u786e\u4fdd\u53d6\u6307\u5730\u5740\u548c\u8bbf\u5b58\u5730\u5740\u5747\u4e3a\u7269\u7406\u5730\u5740\uff0c\u82e5\u65e0\u6cd5\u4fdd\u8bc1\u5219\u53ef\u4ee5\u505a\u4e00\u5c42\u8df3\u8f6c\uff08\u53c2\u8003uCore\u5904\u7406TLBREFILL\u7684\u4ee3\u7801\uff09\uff0c\u5207\u6362\u4e3a\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u518d\u8fdb\u884c\u4e0b\u4e00\u6b65\u64cd\u4f5c\uff0c\u9632\u6b62\u7f16\u5199\u7684\u64cd\u4f5c\u7cfb\u7edf\u5728QEMU\u4e0a\u80fd\u8fd0\u884c\u4f46\u65e0\u6cd5\u5728\u771f\u5b9e\u786c\u4ef6\u4e0a\u8fd0\u884c\u3002</p>"},{"location":"lab0/prepare/#qemu","title":"QEMU\u7b80\u4ecb","text":"<p>QEMU\u662f\u4e00\u6b3e\u6a21\u62df\u5668\uff08\u865a\u62df\u673a\uff09\uff0c\u652f\u6301\u591a\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u7684\u662fLoongArch32\u67b6\u6784\u7684QEMU\u3002</p>"},{"location":"lab0/ref/","title":"ucore\u5b9e\u9a8c\u4e2d\u7684\u5e38\u7528\u5de5\u5177","text":"<p>\u5728ucore\u5b9e\u9a8c\u4e2d\uff0c\u4e00\u4e9b\u57fa\u672c\u7684\u5e38\u7528\u5de5\u5177\u5982\u4e0b\uff1a   - \u547d\u4ee4\u884cshell: bash shell -- \u6709\u5bf9\u6587\u4ef6\u548c\u76ee\u5f55\u64cd\u4f5c\u7684\u5404\u79cd\u547d\u4ee4\uff0c\u5982ls\u3001cd\u3001rm\u3001pwd...   - \u7cfb\u7edf\u7ef4\u62a4\u5de5\u5177\uff1aapt\u3001git     - apt\uff1a\u5b89\u88c5\u7ba1\u7406\u5404\u79cd\u8f6f\u4ef6\uff0c\u4e3b\u8981\u5728debian, ubuntu linux\u7cfb\u7edf\u4e2d     - git\uff1a\u5f00\u53d1\u8f6f\u4ef6\u7684\u7248\u672c\u7ef4\u62a4\u5de5\u5177   - \u6e90\u7801\u9605\u8bfb\u4e0e\u7f16\u8f91\u5de5\u5177\uff1aeclipse-CDT\u3001understand\u3001gedit\u3001vim     - Eclipse-CDT\uff1a\u57fa\u4e8eEclipse\u7684C/C++\u96c6\u6210\u5f00\u53d1\u73af\u5883\u3001\u8de8\u5e73\u53f0\u3001\u4e30\u5bcc\u7684\u5206\u6790\u7406\u89e3\u4ee3\u7801\u7684\u529f\u80fd\uff0c\u53ef\u4e0eqemu\u7ed3\u5408\uff0c\u8054\u673a\u6e90\u7801\u7ea7Debug uCore OS\u3002     - Understand\uff1a\u5546\u4e1a\u8f6f\u4ef6\u3001\u8de8\u5e73\u53f0\u3001\u4e30\u5bcc\u7684\u5206\u6790\u7406\u89e3\u4ee3\u7801\u7684\u529f\u80fd\uff0cWindows\u4e0a\u6709\u7c7b\u4f3c\u7684sourceinsight\u8f6f\u4ef6     - gedit\uff1aLinux\u4e2d\u7684\u5e38\u7528\u6587\u672c\u7f16\u8f91\uff0cWindows\u4e0a\u6709\u7c7b\u4f3c\u7684notepad     - vim: Linux/unix\u4e2d\u7684\u4f20\u7edf\u7f16\u8f91\u5668\uff0c\u7c7b\u4f3c\u6709emacs\u7b49\uff0c\u53ef\u901a\u8fc7exuberant-ctags\u3001cscope\u7b49\u5b9e\u73b0\u4ee3\u7801\u5b9a\u4f4d   - \u6e90\u7801\u6bd4\u8f83\u548c\u6253\u8865\u4e01\u5de5\u5177\uff1adiff\u3001meld\uff0c\u7528\u4e8e\u6bd4\u8f83\u4e0d\u540c\u76ee\u5f55\u6216\u4e0d\u540c\u6587\u4ef6\u7684\u533a\u522b, patch\u662f\u6253\u8865\u4e01\u5de5\u5177     - diff, patch\u662f\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u4f7f\u7528\u7b80\u5355     - meld\u662f\u56fe\u5f62\u754c\u9762\u7684\u5de5\u5177\uff0c\u529f\u80fd\u76f8\u5bf9\u76f4\u89c2\u548c\u65b9\u4fbf\uff0c\u7c7b\u4f3c\u7684\u5de5\u5177\u8fd8\u6709 kdiff3\u3001diffmerge\u3001P4merge   - \u5f00\u53d1\u7f16\u8bd1\u8c03\u8bd5\u5de5\u5177\uff1agcc \u3001gdb \u3001make     - gcc\uff1aC\u8bed\u8a00\u7f16\u8bd1\u5668     - gdb\uff1a\u6267\u884c\u7a0b\u5e8f\u8c03\u8bd5\u5668     - ld\uff1a\u94fe\u63a5\u5668     - objdump\uff1a\u5bf9ELF\u683c\u5f0f\u6267\u884c\u7a0b\u5e8f\u6587\u4ef6\u8fdb\u884c\u53cd\u7f16\u8bd1\u3001\u8f6c\u6362\u6267\u884c\u683c\u5f0f\u7b49\u64cd\u4f5c\u7684\u5de5\u5177     - nm\uff1a\u67e5\u770b\u6267\u884c\u6587\u4ef6\u4e2d\u7684\u53d8\u91cf\u3001\u51fd\u6570\u7684\u5730\u5740     - readelf\uff1a\u5206\u6790ELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\u6587\u4ef6     - make\uff1a\u8f6f\u4ef6\u5de5\u7a0b\u7ba1\u7406\u5de5\u5177\uff0c make\u547d\u4ee4\u6267\u884c\u65f6\uff0c\u9700\u8981\u4e00\u4e2a makefile \u6587\u4ef6\uff0c\u4ee5\u544a\u8bc9make\u547d\u4ee4\u5982\u4f55\u53bb\u7f16\u8bd1\u548c\u94fe\u63a5\u7a0b\u5e8f     - dd\uff1a\u8bfb\u5199\u6570\u636e\u5230\u6587\u4ef6\u548c\u8bbe\u5907\u4e2d\u7684\u5de5\u5177   - \u786c\u4ef6\u6a21\u62df\u5668\uff1aqemu -- qemu\u53ef\u6a21\u62df\u591a\u79cdCPU\u786c\u4ef6\u73af\u5883\uff0c\u672c\u5b9e\u9a8c\u4e2d\uff0c\u7528\u4e8e\u6a21\u62df\u4e00\u53f0LoongArch32\u7684\u8ba1\u7b97\u673a\u7cfb\u7edf\u3002   - markdown\u6587\u672c\u683c\u5f0f\u7684\u7f16\u5199\u548c\u9605\u8bfb\u5de5\u5177(\u6bd4\u5982\u9605\u8bfbucore_docs)     - \u7f16\u5199\u5de5\u5177 haroopad      - \u9605\u8bfb\u5de5\u5177 gitbook</p>"},{"location":"lab0/ref/#_1","title":"\u4e0a\u8ff0\u5de5\u5177\u7684\u4f7f\u7528\u65b9\u6cd5\u5728\u7ebf\u4fe1\u606f","text":"<ul> <li>apt-get</li> <li>http://wiki.ubuntu.org.cn/Apt-get%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97</li> <li>git github</li> <li>http://www.cnblogs.com/cspku/articles/Git_cmds.html</li> <li>http://www.worldhello.net/gotgithub/index.html</li> <li>diff patch</li> <li>http://www.ibm.com/developerworks/cn/linux/l-diffp/index.html</li> <li>http://www.cnblogs.com/itech/archive/2009/08/19/1549729.html </li> <li>gcc</li> <li>http://wiki.ubuntu.org.cn/Gcchowto</li> <li>http://wiki.ubuntu.org.cn/Compiling_Cpp</li> <li>http://wiki.ubuntu.org.cn/C_Cpp_IDE</li> <li>http://wiki.ubuntu.org.cn/C%E8%AF%AD%E8%A8%80%E7%AE%80%E8%A6%81%E8%AF%AD%E6%B3%95%E6%8C%87%E5%8D%97</li> <li>gdb</li> <li>http://wiki.ubuntu.org.cn/%E7%94%A8GDB%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F</li> <li>make &amp; makefile</li> <li>http://wiki.ubuntu.com.cn/index.php?title=%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile&amp;variant=zh-cn</li> <li>http://blog.csdn.net/a_ran/article/details/43937041</li> <li>shell</li> <li>http://wiki.ubuntu.org.cn/Shell%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80</li> <li>http://wiki.ubuntu.org.cn/%E9%AB%98%E7%BA%A7Bash%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97</li> <li>understand</li> <li>http://blog.csdn.net/qwang24/article/details/4064975</li> <li>vim</li> <li>http://www.httpy.com/html/wangluobiancheng/Perljiaocheng/2014/0613/93894.html</li> <li>http://wenku.baidu.com/view/4b004dd5360cba1aa811da77.html</li> <li>meld</li> <li>https://linuxtoy.org/archives/meld-2.html</li> <li>qemu</li> <li>http://wenku.baidu.com/view/04c0116aa45177232f60a2eb.html</li> <li>Eclipse-CDT</li> <li>http://blog.csdn.net/anzhu_111/article/details/5946634 </li> <li>haroopad</li> <li>http://pad.haroopress.com/</li> <li>gitbook</li> <li>https://github.com/GitbookIO/gitbook https://www.gitbook.com/</li> </ul>"},{"location":"lab0/ref/#_2","title":"\u53c2\u8003\u8d44\u6599","text":"<p>\u4e00\u4e9b\u8d44\u6599\u4fe1\u606f\u6765\u6e90\u4e8e http://pdos.csail.mit.edu/6.828/2014/reference.html</p>"},{"location":"lab0/ref/#unix-general-info","title":"UNIX general info","text":"<ul> <li>Youtube Unix intro</li> <li>The UNIX Time-Sharing System, Dennis M. Ritchie and Ken L.Thompson,. Bell System Technical Journal 57, number 6, part 2 (July-August 1978) pages 1905-1930. </li> <li>The Evolution of the Unix Time-sharing System, Dennis M. Ritchie, 1979.</li> <li>The C programming language (second edition) by Kernighan and Ritchie. Prentice Hall, Inc., 1988. ISBN 0-13-110362-8, 1998.</li> </ul>"},{"location":"lab0/ref/#building-or-reading-a-small-os","title":"building or reading a small OS","text":"<ul> <li>How to make an Operating System</li> <li>xv6 book \u4e2d\u6587</li> <li>\u81ea\u5df1\u52a8\u624b\u5199\u64cd\u4f5c\u7cfb\u7edf\u4e8e\u6e0a \u8457,\u7535\u5b50\u5de5\u4e1a\u51fa\u7248\u793e,2005</li> <li>Linux-0.11\u5185\u6838\u5b8c\u5168\u6ce8\u91ca \u8d75\u70af\uff0c2009</li> <li>oldlinux\u8bba\u575b</li> <li>osdev.org</li> </ul>"},{"location":"lab0/ref/#some-os-course","title":"some OS course","text":"<ul> <li>6.828: Operating Systems Engineering - in MIT</li> <li>CS-537: Introduction to Operating Systems - in WISC</li> </ul>"},{"location":"lab0/ref/#16550-uart-serial-port","title":"16550 UART Serial Port","text":"<ul> <li>PC16550D Universal Asynchronous Receiver/Transmitter with FIFOs, National Semiconductor, 1995.</li> <li>http://byterunner.com/16550.html, Byterunner Technologies.</li> <li>Interfacing the Serial / RS232 Port,, Craig Peacock, August 2001.</li> </ul>"},{"location":"lab0/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab0/task/#_1","title":"\u5b9e\u9a8c\u4efb\u52a1","text":"<ol> <li> <p>\u642d\u5efa\u7f16\u8bd1\u73af\u5883</p> </li> <li> <p>\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u88f8\u673a\u7a0b\u5e8f\uff0c\u5b9e\u73b0\u5728\u4e32\u53e3\u4e0a\u8f93\u51fa\u5b57\u7b26\u4e32</p> </li> <li> <p>\u4e86\u89e3\u8c03\u8bd5\u5de5\u5177\u7684\u4f7f\u7528\uff0c\u5c1d\u8bd5\u4f7f\u7528gdb\u6dfb\u52a0\u65ad\u70b9\uff0c\u8c03\u8bd5\u4f60\u7684\u88f8\u673a\u7a0b\u5e8f\u3002</p> </li> </ol>"},{"location":"lab1/booting/","title":"\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u6d41\u7a0b","text":""},{"location":"lab1/booting/#_1","title":"\u4ece\u673a\u5668\u542f\u52a8\u5230\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u7684\u8fc7\u7a0b","text":""},{"location":"lab1/booting/#bios","title":"BIOS\u542f\u52a8\u8fc7\u7a0b","text":"<p>\u5f53\u8ba1\u7b97\u673a\u52a0\u7535\u540e\uff0c\u4e00\u822c\u4e0d\u76f4\u63a5\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\uff0c\u800c\u662f\u6267\u884c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5b8c\u6210\u57fa\u672cIO\u521d\u59cb\u5316\u548c\u5f15\u5bfc\u52a0\u8f7d\u529f\u80fd\u3002\u7b80\u5355\u5730\u8bf4\uff0c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5c31\u662f\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\u8fd0\u884c\u7684\u4e00\u6bb5\u5c0f\u8f6f\u4ef6\u3002\u901a\u8fc7\u8fd9\u6bb5\u5c0f\u8f6f\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u521d\u59cb\u5316\u786c\u4ef6\u8bbe\u5907\u3001\u5efa\u7acb\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\u56fe\uff0c\u4ece\u800c\u5c06\u7cfb\u7edf\u7684\u8f6f\u786c\u4ef6\u73af\u5883\u5e26\u5230\u4e00\u4e2a\u5408\u9002\u7684\u72b6\u6001\uff0c\u4ee5\u4fbf\u4e3a\u6700\u7ec8\u8c03\u7528\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u51c6\u5907\u597d\u6b63\u786e\u7684\u73af\u5883\u3002\u6700\u7ec8\u5f15\u5bfc\u52a0\u8f7d\u7a0b\u5e8f\u628a\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u6620\u50cf\u52a0\u8f7d\u5230RAM\u4e2d\uff0c\u5e76\u5c06\u7cfb\u7edf\u63a7\u5236\u6743\u4f20\u9012\u7ed9\u5b83\u3002</p> <p>\u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u8ba1\u7b97\u673a\u7cfb\u7edf\u800c\u8a00\uff0c\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u8f6f\u4ef6\u662f\u5b58\u653e\u5728\u78c1\u76d8\uff08\u786c\u76d8/\u8f6f\u76d8\uff09\u3001\u5149\u76d8\u3001EPROM\u3001ROM\u3001Flash\u7b49\u53ef\u5728\u6389\u7535\u540e\u7ee7\u7eed\u4fdd\u5b58\u6570\u636e\u7684\u5b58\u50a8\u4ecb\u8d28\u4e0a\u3002\u8ba1\u7b97\u673a\u542f\u52a8\u540e\uff0cCPU\u4e00\u5f00\u59cb\u4f1a\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5f00\u59cb\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5b58\u653e\u4e86\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\uff0c\u8d1f\u8d23\u5b8c\u6210\u8ba1\u7b97\u673a\u57fa\u672c\u7684IO\u521d\u59cb\u5316\uff0c\u8fd9\u662f\u7cfb\u7edf\u52a0\u7535\u540e\u8fd0\u884c\u7684\u7b2c\u4e00\u6bb5\u8f6f\u4ef6\u4ee3\u7801\u3002</p> <p>\u5bf9\u4e8eLoongArch32\u4f53\u7cfb\u7ed3\u6784\u800c\u8a00\uff0c\u771f\u5b9e\u7684\u786c\u4ef6\u4e0a\u7535\u540e\u4f1a\u5f00\u59cb\u542f\u52a8BIOS\uff0c\u8be5BIOS\u53ef\u4ee5\u88ab\u81ea\u5df1\u5237\u5199\u3002\u800c\u5728ChipLab\u6559\u5b66\u8ba1\u7b97\u673a\u4e2d\u91c7\u7528\u7684\u662fPMON2000\u4f5c\u4e3aBIOS\uff0c\u5b83\u5177\u6709\u7f51\u7edc\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7\u7f51\u5361\u4ece\u7f51\u7edc\u4e0a\u4f7f\u7528tftp\u534f\u8bae\u8f7d\u5165ELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u7136\u540e\u4eceELF\u7684\u5165\u53e3\u70b9\u542f\u52a8\u3002</p> <p>\u800c\u6211\u4eec\u5b9e\u9a8c\u91c7\u7528\u7684QEMU\u73af\u5883\uff0c\u5219\u662f\u629b\u5f03\u4e86BIOS\u8fd9\u4e00\u8fc7\u7a0b\u3002\u5728QEMU\u4e0a\u76f4\u63a5\u4f7f\u7528<code>-kernel</code>\u53c2\u6570\u6307\u5b9a\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u5b8c\u6210\u4e86BIOS\u6240\u505a\u7684\u52a0\u8f7d\u5185\u6838\u7684\u8fc7\u7a0b\uff0c\u76f4\u63a5\u4eceELF\u6587\u4ef6\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002</p>"},{"location":"lab1/booting/#_2","title":"\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u8fc7\u7a0b","text":"<p>\u5f53bootloader\u901a\u8fc7\u628aucore\u5728\u7cfb\u7edf\u52a0\u8f7d\u5230\u5185\u5b58\u540e\uff0c\u5c31\u8f6c\u8df3\u5230ucore\u64cd\u4f5c\u7cfb\u7edf\u5728\u5185\u5b58\u4e2d\u7684\u5165\u53e3\u4f4d\u7f6e\uff08kern/start.S\u4e2d\u7684start\u7684\u5730\u5740\uff09\uff0c\u8fd9\u6837ucore\u5c31\u63a5\u7ba1\u4e86\u6574\u4e2a\u63a7\u5236\u6743\u3002\u5f53\u524d\u7684ucore\u529f\u80fd\u5f88\u7b80\u5355\uff0c\u53ea\u5b8c\u6210\u57fa\u672c\u7684\u5185\u5b58\u7ba1\u7406\u548c\u5916\u8bbe\u4e2d\u65ad\u7ba1\u7406\u3002ucore\u4e3b\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\u5305\u62ec\uff1a</p> <ul> <li>\u914d\u7f6eDMW\uff0c\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u62e5\u6709\u53ef\u7528\u7684\u5730\u5740\u7a7a\u95f4\uff08\u4f4d\u4e8e<code>kern/init/entry.S</code>\uff0c\u5176\u5b83\u90e8\u5206\u5747\u4e3aC\u8bed\u8a00\u7a0b\u5e8f\uff0c\u6574\u4f53\u4f4d\u4e8e<code>kern/init/init.c</code>\uff09</li> <li>\u521d\u59cb\u5316\u7ec8\u7aef\uff1b</li> <li>\u663e\u793a\u5b57\u7b26\u4e32\uff1b</li> <li>\u8bbe\u7f6e\u4f8b\u5916\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\uff1b</li> <li>\u6267\u884cwhile\uff081\uff09\u6b7b\u5faa\u73af\u3002</li> </ul> <p>\u4ee5\u540e\u7684\u5b9e\u9a8c\u4e2d\u4f1a\u5927\u91cf\u6d89\u53ca\u5404\u4e2a\u51fd\u6570\u76f4\u63a5\u7684\u8c03\u7528\u5173\u7cfb\uff0c\u4ee5\u53ca\u7531\u4e8e\u4e2d\u65ad\u5904\u7406\u5bfc\u81f4\u7684\u5f02\u6b65\u73b0\u8c61\uff0c\u53ef\u80fd\u5bf9\u5927\u5bb6\u5b9e\u73b0\u64cd\u4f5c\u7cfb\u7edf\u548c\u6539\u6b63\u5176\u4e2d\u7684\u9519\u8bef\u6709\u5f88\u5927\u5f71\u54cd\u3002\u800c\u7406\u89e3\u597d\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u7684\u5efa\u7acb\u673a\u5236\u548c\u4e2d\u65ad\u5904\u7406\u673a\u5236\uff0c\u5bf9\u540e\u7eed\u5b9e\u9a8c\u4f1a\u6709\u5f88\u5927\u5e2e\u52a9\u3002</p>"},{"location":"lab1/booting/#_3","title":"\u5730\u5740\u7a7a\u95f4","text":"<p>LoongArch32\u7684\u5730\u5740\u7a7a\u95f4\u6d89\u53ca\u4e24\u79cd\u5730\u5740\uff1a - \u903b\u8f91\u5730\u5740\uff08Logical Address,\u5e94\u7528\u7a0b\u5e8f\u5458\u770b\u5230\u7684\u5730\u5740\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u4e0a\u79f0\u4e3a\u865a\u62df\u5730\u5740\uff0c\u4ee5\u540e\u63d0\u5230\u865a\u62df\u5730\u5740\u5c31\u662f\u6307\u903b\u8f91\u5730\u5740\uff09 - \u7269\u7406\u5730\u5740\uff08Physical Address, \u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\uff09\u3002</p> <p>(1) \u903b\u8f91\u5730\u5740\u7a7a\u95f4 \u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\uff0c\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u7a0b\u6240\u7528\u5230\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u7a0b\u5e8f\u7247\u6bb5\uff1a     int val=100;     int * point=&amp;val;</p> <p>\u5176\u4e2d\u6307\u9488\u53d8\u91cfpoint\u4e2d\u5b58\u50a8\u7684\u5373\u662f\u4e00\u4e2a\u903b\u8f91\u5730\u5740\u3002</p> <p>(2) \u7269\u7406\u5730\u5740\u7a7a\u95f4 \u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u89d2\u5ea6\u770b\uff0cCPU\u3001\u5185\u5b58\u786c\u4ef6\uff08\u901a\u5e38\u8bf4\u7684\u201c\u5185\u5b58\u6761\u201d\uff09\u548c\u5404\u79cd\u5916\u8bbe\u662f\u5b83\u4e3b\u8981\u7ba1\u7406\u7684\u786c\u4ef6\u8d44\u6e90\u800c\u5185\u5b58\u786c\u4ef6\u548c\u5916\u8bbe\u5206\u5e03\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u4e00\u4e2a\u201c\u5927\u6570\u7ec4\u201d\uff0cCPU\u901a\u8fc7\u7d22\u5f15\uff08\u7269\u7406\u5730\u5740\uff09\u6765\u8bbf\u95ee\u8fd9\u4e2a\u201c\u5927\u6570\u7ec4\u201d\u4e2d\u7684\u5185\u5bb9\u3002\u7269\u7406\u5730\u5740\u662f\u6307CPU\u63d0\u4ea4\u5230\u5185\u5b58\u603b\u7ebf\u4e0a\u7528\u4e8e\u8bbf\u95ee\u8ba1\u7b97\u673a\u5185\u5b58\u548c\u5916\u8bbe\u7684\u6700\u7ec8\u5730\u5740\u3002</p> <p>\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u5927\u5c0f\u53d6\u51b3\u4e8eCPU\u5b9e\u73b0\u7684\u7269\u7406\u5730\u5740\u4f4d\u6570\uff0cLoongArch32\u8ba1\u7b97\u673a\u4e2d\uff0cCPU\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u53d6\u51b3\u4e8e\u5904\u7406\u5668\u914d\u7f6e\u7684PALEN\u3002\u800c\u5bf9\u4e8e\u5916\u8bbe\uff0c\u5219\u662f\u56fa\u5b9a\u914d\u7f6e\u4e8e0x1f000000~0x1fffffff\u3002\u4f8b\u5982\u6211\u4eec\u5982\u679c\u914d\u7f6eQEMU\u7684\u5185\u5b58\u4e3a256M\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\uff1a</p> <pre><code>+------------------+  &lt;- 0xFFFFFFFF (4GB)\n|     \u65e0\u6548\u7a7a\u95f4      |\n+------------------+  &lt;- 0x1FFFFFFF (512M)\n|   IO\u5916\u8bbe\u5730\u5740\u7a7a\u95f4   |\n+------------------+  &lt;- 0x1F000000 (496M)\n|     \u65e0\u6548\u7a7a\u95f4      |\n+------------------+  &lt;- 0x0FFFFFFF (256M)\n|     \u6709\u6548\u5185\u5b58      |\n+------------------+  &lt;- 0x00000000\n</code></pre> <p>\u56fe6 LoongArch32\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4</p> <p>(3) \u5730\u5740\u7a7a\u95f4\u7684\u7ffb\u8bd1</p> <p>LoongArch32\u67b6\u6784\u5730\u5740\u7a7a\u95f4\u6709\u4e24\u79cd\u7ffb\u8bd1\u6a21\u5f0f\uff1a</p> <ul> <li>\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff08CSR.CRMD\u4e2d\u7684DA=1\u4e14PG=0\u65f6\uff09     \u7b80\u5355\u5730\u4f7f\u7269\u7406\u5730\u5740=\u865a\u62df\u5730\u5740\u7684\u524dPALEN\u4f4d\uff0c\u540e\u7eed\u88650\u3002     \u6ce8\uff1aPALEN\u4e0e\u5904\u7406\u5668\u914d\u7f6e\u6709\u5173\u3002</li> <li>\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff08CSR.CRMD\u4e2d\u7684DA=0\u4e14PG=1\u65f6\uff09<ul> <li>\u5148\u67e5\u770bDMW\u5730\u5740\u6620\u5c04\u7a97\u53e3\uff0c\u82e5\u5339\u914d\u5219\u6309\u7167DMW\u914d\u7f6e\u7684\u7ffb\u8bd1\u3002\u4e0d\u5339\u914d\u5219\u7ee7\u7eed\u3002</li> <li>\u7136\u540e\u68c0\u67e5TLB\u662f\u5426\u5b58\u5728\u8be5\u9875\u8868\u9879\uff0c\u82e5\u5339\u914d\u5219\u6309\u7167TLB\u5bf9\u5e94\u914d\u7f6e\u7ffb\u8bd1\uff0c\u4e0d\u5339\u914d\u5219\u4ea7\u751fTLB\u4f8b\u5916\u7531\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u6839\u636e\u9875\u8868\u5b8c\u6210TLB\u586b\u5145\u64cd\u4f5c\u3002</li> </ul> </li> </ul>"},{"location":"lab1/booting/#_4","title":"\u4e2d\u65ad\u4e0e\u5f02\u5e38","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u5bf9\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u5404\u79cd\u5916\u8bbe\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u5c31\u9700\u8981CPU\u548c\u5916\u8bbe\u80fd\u591f\u76f8\u4e92\u901a\u4fe1\u624d\u884c\u3002\u4e00\u822c\u5916\u8bbe\u7684\u901f\u5ea6\u8fdc\u6162\u4e8eCPU\u7684\u901f\u5ea6\u3002\u5982\u679c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7CPU\u201c\u4e3b\u52a8\u5173\u5fc3\u201d\u5916\u8bbe\u7684\u4e8b\u4ef6\uff0c\u5373\u91c7\u7528\u901a\u5e38\u7684\u8f6e\u8be2(polling)\u673a\u5236\uff0c\u5219\u592a\u6d6a\u8d39CPU\u8d44\u6e90\u4e86\u3002\u6240\u4ee5\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u548cCPU\u80fd\u591f\u4e00\u8d77\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u5916\u8bbe\u5728\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u5904\u7406\u5916\u8bbe\u76f8\u5173\u4e8b\u4ef6\u7684\u65f6\u5019\uff0c\u80fd\u591f\u201c\u4e3b\u52a8\u901a\u77e5\u201d\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5373\u6253\u65ad\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u5916\u8bbe\u7684\u76f8\u5173\u5904\u7406\uff0c\u7136\u540e\u518d\u6062\u590d\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u79cd\u673a\u5236\u79f0\u4e3a\u4e2d\u65ad\u673a\u5236\u3002\u4e2d\u65ad\u673a\u5236\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u5904\u7406\u610f\u5916\u60c5\u51b5\u7684\u80fd\u529b\uff0c\u540c\u65f6\u5b83\u4e5f\u662f\u5b9e\u73b0\u8fdb\u7a0b/\u7ebf\u7a0b\u62a2\u5360\u5f0f\u8c03\u5ea6\u7684\u4e00\u4e2a\u91cd\u8981\u57fa\u77f3\u3002\u4f46\u4e2d\u65ad\u7684\u5f15\u5165\u4f1a\u5bfc\u81f4\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u7684\u7406\u89e3\u66f4\u52a0\u56f0\u96be\u3002</p> <p>\u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u4e2d\u65ad\u5c5e\u4e8e\u5f02\u5e38(Exception)\u7684\u4e00\u79cd\uff0cuCore\u5185\u6838\u76ee\u524d\u5904\u7406\u7684\u5f02\u5e38\u5305\u62ec\u4ee5\u4e0b\u7c7b\u578b\uff1a</p> <ul> <li>\u4e2d\u65ad          (EX_IRQ,CSR.ESTAT.Ecode=0)</li> <li>Load\u64cd\u4f5c\u9875\u65e0\u6548 (EX_TLBL,CSR.ESTAT.Ecode=1)</li> <li>Store\u64cd\u4f5c\u9875\u65e0\u6548(EX_TLBS,CSR.ESTAT.Ecode=2)</li> <li>TLB \u91cd\u586b      (EX_TLBR,CSR.ESTAT.Ecode=31)</li> <li>\u6307\u4ee4\u4e0d\u5b58\u5728     (EX_RI,CSR.ESTAT.Ecode=13)</li> <li>\u6307\u4ee4\u7279\u6743\u7b49\u7ea7\u9519\u8bef(EX_IPE,CSR.ESTAT.Ecode=14)</li> <li>\u7cfb\u7edf\u8c03\u7528       (EX_SYS,CSR.ESTAT.Ecode=11)</li> <li>\u5730\u5740\u9519\u8bef\u4f8b\u5916    (EX_ADE,CSR.ESTAT.Ecode=8) \u4f8b\u5982\u5730\u5740\u6ca1\u6709\u5bf9\u9f50</li> </ul> <p>LoongArch32\u67b6\u6784\u7684\u5904\u7406\u5668\u4e5f\u63d0\u4f9b\u4e86\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u3002\u5206\u522b\u662f\u5e38\u89c4\u4f8b\u5916\u4e0eTLB\u4f8b\u5916\u3002\u7531\u4e8eTLB\u4f8b\u5916\u6d89\u53ca\u91cd\u586b\u9875\u8868\u7684\u5de5\u4f5c\uff0c\u56e0\u6b64\u5fc5\u987b\u4e3a\u7269\u7406\u5730\u5740\u3002\u800c\u5e38\u89c4\u4f8b\u5916\u5165\u53e3\u5219\u53ef\u4ee5\u6839\u636e\u76ee\u524d\u5904\u7406\u5668\u7684\u8fd0\u884c\u72b6\u6001\u9009\u62e9\u4f7f\u7528\u865a\u62df\u5730\u5740\u6216\u7269\u7406\u5730\u5740\u3002</p> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u6211\u4eec\u6240\u4f7f\u7528\u7684QEMU\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\uff0c\u4f1a\u62b9\u9664CSR.RFBASE\u5730\u5740\u7684\u9ad83\u4f4d\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u9700\u8981\u5173\u5fc3TLB\u91cd\u586b\u65f6\u5730\u5740\u8bbf\u95ee\u7684\u5730\u5740\u7684\u95ee\u9898\uff0c\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539CSR.CRMD\u6765\u5f00\u542f\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u7136\u540e\u5f53\u505a\u865a\u62df\u5730\u5740\u4e00\u6837\u5904\u7406\u5373\u53ef\u3002</p> <p>\u8fd9\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u4e5f\u5b58\u50a8\u5728CSR\u5bc4\u5b58\u5668\u4e2d\uff0c\u540d\u79f0\u5206\u522b\u4e3aCSR.EBASE\u4e0eCSR.RFBASE\u3002\u5f53\u4f8b\u5916\u4ea7\u751f\u65f6\uff0c\u5904\u7406\u5668\u4f1a\u8fdb\u884c\u5982\u4e0b\u64cd\u4f5c\uff1a - \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 - \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d - \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09</p> <p>\u7136\u540e\u5c06PC\u8df3\u8f6c\u5230\u5bf9\u5e94\u7684\u4f8b\u5916\u5165\u53e3\u5730\u5740\u5904\uff0c\u4ea4\u7ed9\u8f6f\u4ef6\u5b8c\u6210\u4f8b\u5916\u7684\u5904\u7406\u64cd\u4f5c\u3002</p> <p>\u5f53\u4f8b\u5916\u5904\u7406\u7ed3\u675f\u540e\uff0c\u8f6f\u4ef6\u5e94\u8be5\u6267\u884cERTN\u4ece\u4f8b\u5916\u72b6\u6001\u8fd4\u56de\uff0c\u8be5\u6307\u4ee4\u4f1a\u5b8c\u6210\u5982\u4e0b\u64cd\u4f5c\uff1a - \u5c06CSR.PRMD\u4e2d\u7684PPLV\u3001PIE\u503c\u56de\u590d\u5230CSR.CRMD\u7684PLV\u3001IE\u4e2d\u3002 - \u8df3\u8f6c\u5230CSR.ERA\u6240\u8bb0\u5f55\u7684\u5730\u5740\u5904\u53d6\u6307\u3002</p>"},{"location":"lab1/booting/#lab1","title":"lab1\u4e2d\u5bf9\u4f8b\u5916\u7684\u5904\u7406\u5b9e\u73b0","text":"<p>(1) \u5916\u8bbe\u57fa\u672c\u521d\u59cb\u5316\u8bbe\u7f6e</p> <p>Lab1\u5b9e\u73b0\u4e86\u4e2d\u65ad\u521d\u59cb\u5316\u548c\u5bf9\u952e\u76d8\u3001\u4e32\u53e3\u3001\u65f6\u949f\u5916\u8bbe\u8fdb\u884c\u4e2d\u65ad\u5904\u7406\u3002\u4e32\u53e3\u7684\u521d\u59cb\u5316\u51fd\u6570serial_init\uff08\u4f4d\u4e8e/kern/driver/console.c\uff09\u4e2d\u6d89\u53ca\u4e2d\u65ad\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5f88\u7b80\u5355\uff1a</p> <pre><code>......\n// \u4f7f\u80fd\u4e32\u53e31\u63a5\u6536\u5b57\u7b26\u540e\u4ea7\u751f\u4e2d\u65ad\noutb(COM1 + COM_IER, COM_IER_RDI);\n......\n// \u901a\u8fc7\u4e2d\u65ad\u63a7\u5236\u5668\u4f7f\u80fd\u4e32\u53e31\u4e2d\u65ad\npic_enable(IRQ_COM1);\n</code></pre> <p>\u65f6\u949f\u662f\u4e00\u79cd\u6709\u7740\u7279\u6b8a\u4f5c\u7528\u7684\u5916\u8bbe\uff0c\u5176\u4f5c\u7528\u5e76\u4e0d\u4ec5\u4ec5\u662f\u8ba1\u65f6\u3002\u5728\u540e\u7eed\u7ae0\u8282\u4e2d\u5c06\u8bb2\u5230\uff0c\u6b63\u662f\u7531\u4e8e\u6709\u4e86\u89c4\u5f8b\u7684\u65f6\u949f\u4e2d\u65ad\uff0c\u624d\u4f7f\u5f97\u65e0\u8bba\u5f53\u524dCPU\u8fd0\u884c\u5728\u54ea\u91cc\uff0c\u64cd\u4f5c\u7cfb\u7edf\u90fd\u53ef\u4ee5\u5728\u9884\u5148\u786e\u5b9a\u7684\u65f6\u95f4\u70b9\u4e0a\u83b7\u5f97CPU\u63a7\u5236\u6743\u3002\u8fd9\u6837\u5f53\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u4e86\u4e00\u5b9a\u65f6\u95f4\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u65f6\u949f\u4e2d\u65ad\u83b7\u5f97CPU\u63a7\u5236\u6743\uff0c\u5e76\u53ef\u628aCPU\u8d44\u6e90\u8ba9\u7ed9\u66f4\u9700\u8981CPU\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u3002\u65f6\u949f\u7684\u521d\u59cb\u5316\u51fd\u6570clock_init\uff08\u4f4d\u4e8ekern/driver/clock.c\u4e2d\uff09\u5b8c\u6210\u4e86\u5bf9\u65f6\u949f\u63a7\u5236\u5668\u7684\u521d\u59cb\u5316\uff1a</p> <p><pre><code>    ......\nunsigned long timer_config;\nunsigned long period = 200000000;\nperiod = period / HZ;\ntimer_config = period &amp; LISA_CSR_TMCFG_TIMEVAL;\ntimer_config |= (LISA_CSR_TMCFG_PERIOD | LISA_CSR_TMCFG_EN);\n__lcsr_csrwr(timer_config, LISA_CSR_TMCFG);\npic_enable(TIMER0_IRQ);\n</code></pre> (2) \u4f8b\u5916\u521d\u59cb\u5316\u8bbe\u7f6e</p> <p>\u5bf9\u4e8eLoongArch32\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u4e2d\u65ad\u9996\u5148\u9700\u8981\u5b8c\u6210\u4f8b\u5916\u5904\u7406\u7a0b\u5e8f\u7684\u57fa\u5730\u5740\u8bbe\u7f6e\u3002\u8fd9\u4e00\u90e8\u5206\u7a0b\u5e8f\u5199\u5728\u4e86<code>kern/init/init.c</code>\u4e2d\u7684<code>setup_exception_vector</code>\u51fd\u6570\u3002</p> <p>\u5176\u4e2d\uff0c\u8be5\u51fd\u6570\u4e2d\u4f7f\u7528\u7684<code>__exception_vector</code>\u5730\u5740\u4f4d\u4e8e\u6587\u4ef6<code>kern/trap/vectors.S</code>\u3002\u4e3a\u4e86\u7b80\u5316\uff0c\u5b83\u76f4\u63a5\u8df3\u8f6c\u5230\u4e86<code>kern/trap/exception.S</code>\u4e2d\u7684<code>ramExcHandle_general</code>\u5904\u3002</p> <p>(3) \u4f8b\u5916\u7684\u5904\u7406\u8fc7\u7a0b</p> <p>trap\u51fd\u6570\uff08\u5b9a\u4e49\u5728trap.c\u4e2d\uff09\u662f\u5bf9\u4f8b\u5916\u8fdb\u884c\u5904\u7406\u7684\u8fc7\u7a0b\uff0c\u6240\u6709\u7684\u4f8b\u5916\u5728\u7ecf\u8fc7\u4e2d\u65ad\u5165\u53e3\u51fd\u6570<code>ramExcHandle_general</code>\u9884\u5904\u7406\u540e (\u5b9a\u4e49\u5728 exception.S\u4e2d) \uff0c\u90fd\u4f1a\u8df3\u8f6c\u5230\u8fd9\u91cc\u3002\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\uff0c\u6839\u636e\u4e0d\u540c\u7684\u4f8b\u5916\u7c7b\u578b\uff0c\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\u3002\u5728\u76f8\u5e94\u7684\u5904\u7406\u8fc7\u7a0b\u7ed3\u675f\u4ee5\u540e\uff0ctrap\u5c06\u4f1a\u8fd4\u56de\uff0c\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u4f1a\u7ee7\u7eed\u8fd0\u884c\u3002\u6574\u4e2a\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p> <p>1)\u4ea7\u751f\u4f8b\u5916\u540e\uff0cCPU\u786c\u4ef6\u5b8c\u6210\u4e86\u5982\u4e0b\u64cd\u4f5c\uff1a - \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 - \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d - \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09</p> <p>2)\u7ecf\u8fc7\u4f8b\u5916\u5411\u91cf\u7684\u8df3\u8f6c\uff0c\u8fdb\u5165<code>exception.S</code>\u4e2d\u7684<code>ramExcHandle_general</code>\u3002</p> <p>\u5728\u8fd9\u91cc\u4f1a\u5b8c\u6210\u4f8b\u5916\u73b0\u573a\u7684\u4fdd\u5b58\u64cd\u4f5c\uff0c\u5207\u6362\u5230\u5185\u6838\u6808\uff0c\u5c06\u5f53\u524d\u5904\u7406\u5668\u7684\u6240\u6709\u901a\u7528\u5bc4\u5b58\u5668\u538b\u5165\u5185\u6838\u6808\u4e2d\uff0c\u5e76\u4f7f\u7528CSR\u4e2d\u7684KS0\u548cKS1\u5bc4\u5b58\u5668\u7528\u6765\u8f85\u52a9\u4fdd\u5b58\u6570\u636e\uff08\u5426\u5219\u4fdd\u5b58\u8fc7\u7a0b\u4e2d\u5fc5\u7136\u5bfc\u81f4\u4e00\u4e9b\u7279\u5b9a\u5bc4\u5b58\u5668\u7684\u4fee\u6539\uff09\u3002</p> <p>\u4fdd\u5b58\u7684\u6570\u636e\u6309\u7167trapfame\u7ed3\u6784\u8fdb\u884c\uff0c\u4f4d\u4e8e<code>kern/trap/loongarch_trapframe.h</code>\u3002</p> <p>3) \u7136\u540e\u8df3\u8f6c\u8fdb\u5165<code>kern/trap/trap.c</code>\u4e2d\u7684<code>loongarch_trap</code>\u51fd\u6570\uff0c\u5f00\u59cb\u4e86C\u8bed\u8a00\u7a0b\u5e8f\u7684\u5185\u6838\u7684\u5904\u7406\u3002</p> <p>\u8fd9\u4e2a\u51fd\u6570\u4e2d\uff0c\u4f1a\u6839\u636e\u4f8b\u5916\u7684\u7c7b\u578b\u5b8c\u6210\u4f8b\u5916\u7684\u5206\u7c7b\u5e76\u8fdb\u884c\u5904\u7406\uff0c\u5177\u4f53\u89c1<code>kern/trap/trap.c</code>\u3002</p> <p>4) \u5f53<code>loongarch_trap</code>\u8fd9\u4e00\u51fd\u6570\u5904\u7406\u5b8c\u6bd5\u540e\uff08\u5904\u7406\u8fc7\u7a0b\u53ef\u80fd\u5305\u542b\u5bf9trapframe\u7684\u4fee\u6539\uff09\uff0c\u4f1a\u8fd4\u56de\u5230\u4e4b\u524d\u7684\u6c47\u7f16\u7a0b\u5e8f\uff08<code>exception.S</code>\u4e2d\uff09\uff0c\u5b8c\u6210\u5bc4\u5b58\u5668\u72b6\u6001\u7684\u8fd8\u539f\uff0c\u7136\u540e\u4f7f\u7528ertn\u6307\u4ee4\u7ed3\u675f\u4f8b\u5916\u5904\u7406\uff0c\u6062\u590d\u7a0b\u5e8f\u7684\u6267\u884c\u3002</p> <p>\u81f3\u6b64\uff0c\u5bf9\u6574\u4e2alab1\u4e2d\u7684\u4e3b\u8981\u90e8\u5206\u7684\u80cc\u666f\u77e5\u8bc6\u548c\u5b9e\u73b0\u8fdb\u884c\u4e86\u9610\u8ff0\u3002\u8bf7\u5927\u5bb6\u80fd\u591f\u6839\u636e\u524d\u9762\u7684\u7ec3\u4e60\u8981\u6c42\u5b8c\u6210\u6240\u6709\u7684\u7ec3\u4e60\u3002</p>"},{"location":"lab1/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab1/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB1    := -DLAB1_EX4 -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT(\u7b2c6\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\n# LAB2  := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\n# LAB3  := -DLAB3_EX1 -DLAB3_EX2\n# LAB4  := -DLAB4_EX1 -DLAB4_EX2\n# LAB5  := -DLAB5_EX1 -DLAB5_EX2\n# LAB6  := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre> -D_SHOW_100_TICKS\u9009\u9879\u53ef\u5728\u7ec8\u7aef\u6bcf\u662f\u6beb\u79d2\u6253\u5370\u4e00\u884c\"100 ticks\" -D_SHOW_SERIAL_INPUT\u9009\u9879\u4f1a\u5728\u7ec8\u7aef\u6253\u5370\u952e\u76d8\u7684\u8f93\u5165 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA001F000 (phys)\nedata 0xA0151820 (phys)\nend   0xA0154B00 (phys)\nKernel executable memory footprint: 1239KB\nLAB1 Check - Please press your keyboard manually and see what happend.\n100 ticks\n100 ticks\n100 ticks\n100 ticks\n100 ticks\n100 ticks\n100 ticks\ngot input 100 ticks\ngot input s\ngot input d\ngot input g\n100 ticks\ngot input s\ngot input g\n100 ticks\n</code></pre></p>"},{"location":"lab1/inline_asm/","title":"\u5185\u8054\u6c47\u7f16","text":""},{"location":"lab1/inline_asm/#_1","title":"\u5185\u8054\u6c47\u7f16","text":"<p>\u6211\u4eec\u5728\u9605\u8bfbLab1\u7684C\u4ee3\u7801\u65f6\u5f80\u5f80\u4f1a\u770b\u5230<code>asm</code>\u5173\u952e\u5b57\uff0c\u8fd9\u662f\u4e00\u79cd\u5185\u8054\u6c47\u7f16\u7684\u5199\u6cd5\uff0c\u4f7f\u5f97\u6211\u4eec\u80fd\u591f\u5728C\u8bed\u8a00\u4e2d\u76f4\u63a5\u64cd\u4f5c\u6c47\u7f16\uff0c\u4ee5\u8fbe\u6210\u8bfb\u5199\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\uff08CSR\uff09\u3001\u53d1\u8d77\u7cfb\u7edf\u8c03\u7528\u7b49C\u8bed\u8a00\u65e0\u6cd5\u76f4\u63a5\u5b8c\u6210\u7684\u64cd\u4f5c\u3002</p> <p>\u8fd9\u91cc\u5bf9\u5185\u8054\u6c47\u7f16\u8fdb\u884c\u7b80\u8981\u4ecb\u7ecd\u3002</p>"},{"location":"lab1/inline_asm/#gcc","title":"GCC\u57fa\u672c\u5185\u8054\u6c47\u7f16","text":"<p>GCC \u63d0\u4f9b\u4e86\u4e24\u7c7b\u5185\u8054\u6c47\u7f16\u8bed\u53e5\uff08inline asm statements\uff09\uff1a\u57fa\u672c\u5185\u8054\u6c47\u7f16\u8bed\u53e5\uff08basic inline asm statement)\u548c\u6269\u5c55\u5185\u8054\u6c47\u7f16\u8bed\u53e5\uff08extended inline asm statement\uff09\u3002GCC\u57fa\u672c\u5185\u8054\u6c47\u7f16\u5f88\u7b80\u5355\uff0c\u4e00\u822c\u662f\u6309\u7167\u4e0b\u9762\u7684\u683c\u5f0f\uff1a</p> <pre><code>asm(\"statements\");\n</code></pre> <p>\u4f8b\u5982\uff1a</p> <pre><code>asm(\"nop\");\n</code></pre> <p>\"asm\" \u548c \"__asm__\" \u7684\u542b\u4e49\u662f\u5b8c\u5168\u4e00\u6837\u7684\u3002\u5982\u679c\u6709\u591a\u884c\u6c47\u7f16\uff0c\u5219\u6bcf\u4e00\u884c\u90fd\u8981\u52a0\u4e0a \"\\n\\t\"\u3002\u5176\u4e2d\u7684 \u201c\\n\u201d \u662f\u6362\u884c\u7b26\uff0c\"\\t\u201d \u662f tab \u7b26\uff0c\u5728\u6bcf\u6761\u547d\u4ee4\u7684 \u7ed3\u675f\u52a0\u8fd9\u4e24\u4e2a\u7b26\u53f7\uff0c\u662f\u4e3a\u4e86\u8ba9 gcc \u628a\u5185\u8054\u6c47\u7f16\u4ee3\u7801\u7ffb\u8bd1\u6210\u4e00\u822c\u7684\u6c47\u7f16\u4ee3\u7801\u65f6\u80fd\u591f\u4fdd\u8bc1\u6362\u884c\u548c\u7559\u6709\u4e00\u5b9a\u7684\u7a7a\u683c\u3002\u5bf9\u4e8e\u57fa\u672casm\u8bed\u53e5\uff0cGCC\u7f16\u8bd1\u51fa\u6765\u7684\u6c47\u7f16\u4ee3\u7801\u5c31\u662f\u53cc\u5f15\u53f7\u91cc\u7684\u5185\u5bb9\u3002\u4f8b\u5982\uff1a</p> <p><pre><code>asm( \"li.w $t0, 1\\n\\t\"\n\"li.w $t1, 2\\n\\t\"\n\"addi.w $t0, $t1, $t2\"\n);\n</code></pre> \u5b9e\u9645\u4e0agcc\u5728\u5904\u7406\u6c47\u7f16\u65f6\uff0c\u662f\u8981\u628aasm(...)\u7684\u5185\u5bb9\"\u6253\u5370\"\u5230\u6c47\u7f16\u6587\u4ef6\u4e2d\uff0c\u6240\u4ee5\u683c\u5f0f\u63a7\u5236\u5b57\u7b26\u662f\u5fc5\u8981\u7684\u3002</p> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u6211\u4eec\u5728\u5185\u8054\u6c47\u7f16\u4e2d\u6539\u53d8\u4e86 t0 \u548c t1 \u7684\u503c\uff0c\u4f46\u662f\u7531\u4e8e gcc \u7684\u7279\u6b8a\u7684\u5904\u7406\u65b9\u6cd5\uff0c\u5373\u5148\u5f62\u6210\u6c47\u7f16\u6587\u4ef6\uff0c\u518d\u4ea4\u7ed9 GAS \u53bb\u6c47\u7f16\uff0c\u6240\u4ee5 GAS \u5e76\u4e0d\u77e5\u9053\u6211\u4eec\u5df2\u7ecf\u6539\u53d8\u4e86 t0 \u548c t1 \u7684\u503c\uff0c\u5982\u679c\u7a0b\u5e8f\u7684\u4e0a\u4e0b\u6587\u9700\u8981 t0 \u6216 t1 \u4f5c\u5176\u4ed6\u5185\u5b58\u5355\u5143\u6216\u53d8\u91cf\u7684\u6682\u5b58\uff0c\u5c31\u4f1a\u4ea7\u751f\u6ca1\u6709\u9884\u6599\u7684\u591a\u6b21\u8d4b\u503c\uff0c\u5f15\u8d77\u4e25\u91cd\u7684\u540e\u679c\u3002\u5bf9\u4e8e\u53d8\u91cf _boo\u4e5f\u5b58\u5728\u4e00\u6837\u7684\u95ee\u9898\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u8981\u7528\u5230\u6269\u5c55 GCC \u5185\u8054\u6c47\u7f16\u8bed\u6cd5\u3002</p> <p>\u53c2\u8003\uff1a - GCC Manual\uff0c \u7248\u672c\u4e3a5.0.0 pre-release,6.43\u8282\uff08How to Use Inline Assembly Language in C Code\uff09 - GCC-Inline-Assembly-HOWTO</p>"},{"location":"lab1/inline_asm/#gcc_1","title":"GCC\u6269\u5c55\u5185\u8054\u6c47\u7f16","text":"<p>\u4f7f\u7528GCC\u6269\u5c55\u5185\u8054\u6c47\u7f16\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>#define read_a0() ({ \\\nunsigned int __dummy; \\\n__asm__( \\\n    \"move $a0, %0\\n\\t\" \\\n    :\"=r\" (__dummy)); \\\n__dummy; \\\n})\n</code></pre> <p>\u5b83\u4ee3\u8868\u4ec0\u4e48\u542b\u4e49\u5462\uff1f\u8fd9\u9700\u8981\u4ece\u5176\u57fa\u672c\u683c\u5f0f\u8bb2\u8d77\u3002GCC\u6269\u5c55\u5185\u8054\u6c47\u7f16\u7684\u57fa\u672c\u683c\u5f0f\u662f\uff1a          </p> <pre><code>asm [volatile] ( Assembler Template\n: Output Operands\n[ : Input Operands\n[ : Clobbers ] ])\n</code></pre> <p>\u5176\u4e2d\uff0c__asm__ \u8868\u793a\u6c47\u7f16\u4ee3\u7801\u7684\u5f00\u59cb\uff0c\u5176\u540e\u53ef\u4ee5\u8ddf __volatile__\uff08\u8fd9\u662f\u53ef\u9009\u9879\uff09\uff0c\u5176\u542b\u4e49\u662f\u907f\u514d \u201casm\u201d \u6307\u4ee4\u88ab\u5220\u9664\u3001\u79fb\u52a8\u6216\u7ec4\u5408\uff0c\u5728\u6267\u884c\u4ee3\u7801\u65f6\uff0c\u5982\u679c\u4e0d\u5e0c\u671b\u6c47\u7f16\u8bed\u53e5\u88ab gcc \u4f18\u5316\u800c\u6539\u53d8\u4f4d\u7f6e\uff0c\u5c31\u9700\u8981\u5728 asm \u7b26\u53f7\u540e\u6dfb\u52a0 volatile \u5173\u952e\u8bcd\uff1aasm volatile(...)\uff1b\u6216\u8005\u66f4\u8be6\u7ec6\u5730\u8bf4\u660e\u4e3a\uff1a__asm__ __volatile__(...)\uff1b\u7136\u540e\u5c31\u662f\u5c0f\u62ec\u5f27\uff0c\u62ec\u5f27\u4e2d\u7684\u5185\u5bb9\u662f\u5177\u4f53\u7684\u5185\u8054\u6c47\u7f16\u6307\u4ee4\u4ee3\u7801\u3002 \"\" \u4e3a\u6c47\u7f16\u6307\u4ee4\u90e8\u5206\uff0c\u4f8b\u5982\uff0c\"movl %%cr0,%0\\n\\t\"\u3002\u6570\u5b57\u524d\u52a0\u524d\u7f00 \u201c\uff05\u201c\uff0c\u5982\uff051\uff0c\uff052\u7b49\u8868\u793a\u4f7f\u7528\u5bc4\u5b58\u5668\u7684\u6837\u677f\u64cd\u4f5c\u6570\u3002\u53ef\u4ee5\u4f7f\u7528\u7684\u64cd\u4f5c\u6570\u603b\u6570\u53d6\u51b3\u4e8e\u5177\u4f53CPU\u4e2d\u901a\u7528\u5bc4\u5b58\u5668\u7684\u6570 \u91cf\uff0c\u5982LoongArch32\u53ef\u4ee5\u670932\u4e2a\u3002\u6307\u4ee4\u4e2d\u6709\u51e0\u4e2a\u64cd\u4f5c\u6570\uff0c\u5c31\u8bf4\u660e\u6709\u51e0\u4e2a\u53d8\u91cf\u9700\u8981\u4e0e\u5bc4\u5b58\u5668\u7ed3\u5408\uff0c\u7531gcc\u5728\u7f16\u8bd1\u65f6\u6839\u636e\u540e\u9762\u8f93\u51fa\u90e8\u5206\u548c\u8f93\u5165\u90e8\u5206\u7684\u7ea6\u675f\u6761\u4ef6\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\u3002 <p>\u8f93\u51fa\u90e8\u5206\uff08output operand list\uff09\uff0c\u7528\u4ee5\u89c4\u5b9a\u5bf9\u8f93\u51fa\u53d8\u91cf\uff08\u76ee\u6807\u64cd\u4f5c\u6570\uff09\u5982\u4f55\u4e0e\u5bc4\u5b58\u5668\u7ed3\u5408\u7684\u7ea6\u675f\uff08constraint\uff09,\u8f93\u51fa\u90e8\u5206\u53ef\u4ee5\u6709\u591a\u4e2a\u7ea6\u675f\uff0c\u4e92\u76f8\u4ee5\u9017\u53f7\u5206\u5f00\u3002\u6bcf\u4e2a\u7ea6\u675f\u4ee5\u201c\uff1d\u201d\u5f00\u5934\uff0c\u63a5\u7740\u7528\u4e00\u4e2a\u5b57\u6bcd\u6765\u8868\u793a\u64cd\u4f5c\u6570\u7684\u7c7b\u578b\uff0c\u7136\u540e\u662f\u5173\u4e8e\u53d8\u91cf\u7ed3\u5408\u7684\u7ea6\u675f\u3002\u4f8b\u5982\uff0c\u4e0a\u4f8b\u4e2d\uff1a</p> <p><pre><code>    :\"=r\" (__dummy)\n</code></pre> \u201c\uff1dr\u201d\u8868\u793a\u76f8\u5e94\u7684\u76ee\u6807\u64cd\u4f5c\u6570\uff08\u6307\u4ee4\u90e8\u5206\u7684%0\uff09\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u4e00\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u5e76\u4e14\u53d8\u91cf__dummy \u5b58\u653e\u5728\u8fd9\u4e2a\u5bc4\u5b58\u5668\u4e2d\uff0c\u4f46\u5982\u679c\u662f\uff1a               </p> <pre><code>    :\u201c\uff1dm\u201d(__dummy)\n</code></pre> <p>\u201c\uff1dm\u201d\u5c31\u8868\u793a\u76f8\u5e94\u7684\u76ee\u6807\u64cd\u4f5c\u6570\u662f\u5b58\u653e\u5728\u5185\u5b58\u5355\u5143__dummy\u4e2d\u3002\u8868\u793a\u7ea6\u675f\u6761\u4ef6\u7684\u5b57\u6bcd\u5f88\u591a\uff0c\u4e0b\u8868\u7ed9\u51fa\u51e0\u4e2a\u4e3b\u8981\u7684\u7ea6\u675f\u5b57\u6bcd\u53ca\u5176\u542b\u4e49\uff1a</p> \u5b57\u6bcd\u542b\u4e49 m, v, o\u5185\u5b58\u5355\u5143 R\u4efb\u4f55\u901a\u7528\u5bc4\u5b58\u5668 I, h\u76f4\u63a5\u64cd\u4f5c\u6570 G\u4efb\u610f I\u5e38\u6570\uff080\uff5e31\uff09 <p>\u8f93\u5165\u90e8\u5206\uff08input  operand list\uff09\uff1a\u8f93\u5165\u90e8\u5206\u4e0e\u8f93\u51fa\u90e8\u5206\u76f8\u4f3c\uff0c\u4f46\u6ca1\u6709\u201c\uff1d\u201d\u3002\u5982\u679c\u8f93\u5165\u90e8\u5206\u4e00\u4e2a\u64cd\u4f5c\u6570\u6240\u8981\u6c42\u4f7f\u7528\u7684\u5bc4\u5b58\u5668\uff0c\u4e0e\u524d\u9762\u8f93\u51fa\u90e8\u5206\u67d0\u4e2a\u7ea6\u675f\u6240\u8981\u6c42\u7684\u662f\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\uff0c\u90a3\u5c31\u628a\u5bf9\u5e94\u64cd\u4f5c\u6570\u7684\u7f16\u53f7\uff08\u5982\u201c1\u201d\uff0c\u201c2\u201d\u7b49\uff09\u653e\u5728\u7ea6\u675f\u6761\u4ef6\u4e2d\u3002\u5728\u540e\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u53ef\u770b\u5230\u8fd9\u79cd\u60c5\u51b5\u3002\u4fee\u6539\u90e8\u5206\uff08clobber list,\u4e5f\u79f0 \u4e71\u7801\u5217\u8868\uff09:\u8fd9\u90e8\u5206\u5e38\u5e38\u4ee5\u201cmemory\u201d\u4e3a\u7ea6\u675f\u6761\u4ef6\uff0c\u4ee5\u8868\u793a\u64cd\u4f5c\u5b8c\u6210\u540e\u5185\u5b58\u4e2d\u7684\u5185\u5bb9\u5df2\u6709\u6539\u53d8\uff0c\u5982\u679c\u539f\u6765\u67d0\u4e2a\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u6765\u81ea\u5185\u5b58\uff0c\u90a3\u4e48\u73b0\u5728\u5185\u5b58\u4e2d\u8fd9\u4e2a\u5355\u5143\u7684\u5185\u5bb9\u5df2\u7ecf\u6539\u53d8\u3002\u4e71\u7801\u5217\u8868\u901a\u77e5\u7f16\u8bd1\u5668\uff0c\u6709\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u56e0\u5185\u8054\u6c47\u7f16\u5757\u9020\u6210\u4e71\u7801\uff0c\u53ef\u9690\u5f0f\u5730\u7834\u574f\u4e86\u6761\u4ef6\u5bc4\u5b58\u5668\u7684\u67d0\u4e9b\u4f4d\uff08\u5b57\u6bb5\uff09\u3002 \u6ce8\u610f\uff0c\u6307\u4ee4\u90e8\u5206\u4e3a\u5fc5\u9009\u9879\uff0c\u800c\u8f93\u5165\u90e8\u5206\u3001\u8f93\u51fa\u90e8\u5206\u53ca\u4fee\u6539\u90e8\u5206\u4e3a\u53ef\u9009\u9879\uff0c\u5f53\u8f93\u5165\u90e8\u5206\u5b58\u5728\uff0c\u800c\u8f93\u51fa\u90e8\u5206\u4e0d\u5b58\u5728\u65f6\uff0c\u5192\u53f7\u201c\uff1a\u201d\u8981\u4fdd\u7559\uff0c\u5f53\u201cmemory\u201d\u5b58\u5728\u65f6\uff0c\u4e09\u4e2a\u5192\u53f7\u90fd\u8981\u4fdd\u7559\u3002</p> <p>\u53c2\u8003\uff1a - GCC Manual\uff0c \u7248\u672c\u4e3a5.0.0 pre-release,6.43\u8282\uff08How to Use Inline Assembly Language in C Code\uff09 - GCC-Inline-Assembly-HOWTO</p>"},{"location":"lab1/lab1/","title":"\u5b9e\u9a8c\u4e00\uff1a\u7cfb\u7edf\u8f6f\u4ef6\u542f\u52a8\u8fc7\u7a0b","text":""},{"location":"lab1/lab1/#_2","title":"\u5b9e\u9a8c\u5185\u5bb9\uff1a","text":"<p>lab1\u4e2d\u5305\u542b\u4e00\u4e2aOS\u3002\u8fd9lab1\u4e2d\u7684OS\u53ea\u662f\u4e00\u4e2a\u53ef\u4ee5\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u548c\u663e\u793a\u5b57\u7b26\u7684\u5e7c\u513f\u56ed\u7ea7\u522bOS\u3002</p>"},{"location":"lab1/lab1/#_3","title":"\u5b9e\u9a8c\u76ee\u7684\uff1a","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4e5f\u9700\u8981\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u52a0\u8f7d\u5e76\u8fd0\u884c\u5b83\u3002\u5bf9\u4e8eLoongArch32\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u4e0a\u7535\u590d\u4f4d\u6700\u521d\u542f\u52a8\u7684\u662f\u4e00\u4e2aBIOS\u8f6f\u4ef6\uff08\u4f8b\u5982PMON\uff09\uff0c\u8be5BIOS\u8f6f\u4ef6\u80fd\u591f\u652f\u6301\u4ece\u7f51\u7edc\u52a0\u8f7dELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u4ece\u800c\u5f00\u59cb\u542f\u52a8\u6211\u4eec\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684uCore\u5185\u6838\u3002</p> <p>\u800c\u5bf9\u4e8eQEMU\u865a\u62df\u673a\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528<code>-kernel</code>\u6765\u6307\u5b9a\u6211\u4eec\u9700\u8981\u52a0\u8f7d\u7684\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u4ece\u800c\u76f4\u63a5\u5b8c\u6210\u4e86\u5185\u6838\u7684\u8f7d\u5165\u8fc7\u7a0b\uff0c\u5e76\u76f4\u63a5\u4eceELF\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u3002</p> <ul> <li>ucore OS\u8f6f\u4ef6</li> <li>\u7f16\u8bd1\u8fd0\u884cucore OS\u7684\u8fc7\u7a0b</li> <li>ucore OS\u7684\u542f\u52a8\u8fc7\u7a0b</li> <li>\u8c03\u8bd5ucore OS\u7684\u65b9\u6cd5</li> <li>\u51fd\u6570\u8c03\u7528\u5173\u7cfb\uff1a\u5728\u6c47\u7f16\u7ea7\u4e86\u89e3\u51fd\u6570\u8c03\u7528\u6808\u7684\u7ed3\u6784\u548c\u5904\u7406\u8fc7\u7a0b</li> <li>\u4e2d\u65ad\u7ba1\u7406\uff1a\u4e0e\u8f6f\u4ef6\u76f8\u5173\u7684\u4e2d\u65ad\u5904\u7406</li> <li>\u5916\u8bbe\u7ba1\u7406\uff1a\u65f6\u949f</li> </ul>"},{"location":"lab1/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab1/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab1\u7684\u76ee\u6807\uff0clab1\u63d0\u4f9b\u4e864\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002 \u6ce8\u610f\u6709\u201cLAB1\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB1\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca</p> <p>\u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b\u3002  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab1/task/#1make","title":"\u7ec3\u4e601\uff1a\u7406\u89e3\u901a\u8fc7make\u751f\u6210\u6267\u884c\u6587\u4ef6\u7684\u8fc7\u7a0b\u3002\uff08\u8981\u6c42\u5728\u62a5\u544a\u4e2d\u5199\u51fa\u5bf9\u4e0b\u8ff0\u95ee\u9898\u7684\u56de\u7b54\uff09","text":"<p>\u5217\u51fa\u672c\u5b9e\u9a8c\u5404\u7ec3\u4e60\u4e2d\u5bf9\u5e94\u7684OS\u539f\u7406\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u8bf4\u660e\u672c\u5b9e\u9a8c\u4e2d\u7684\u5b9e\u73b0\u90e8\u5206\u5982\u4f55\u5bf9\u5e94\u548c\u4f53\u73b0\u4e86\u539f\u7406\u4e2d\u7684\u57fa\u672c\u6982\u5ff5\u548c\u5173\u952e\u77e5\u8bc6\u70b9\u3002</p> <p>\u5728\u6b64\u7ec3\u4e60\u4e2d\uff0c\u5927\u5bb6\u9700\u8981\u901a\u8fc7\u9759\u6001\u5206\u6790\u4ee3\u7801\u6765\u4e86\u89e3\uff1a</p> <ol> <li>\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\u6587\u4ef6ucore-kernel.elf\u662f\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u751f\u6210\u7684\uff1f(\u9700\u8981\u6bd4\u8f83\u8be6\u7ec6\u5730\u89e3\u91caMakefile\u4e2d\u6bcf\u4e00\u6761\u76f8\u5173\u547d\u4ee4\u548c\u547d\u4ee4\u53c2\u6570\u7684\u542b\u4e49\uff0c\u4ee5\u53ca\u8bf4\u660e\u547d\u4ee4\u5bfc\u81f4\u7684\u7ed3\u679c)</li> </ol> <p>\u8865\u5145\u6750\u6599\uff1a</p> <p>\u5982\u4f55\u8c03\u8bd5Makefile</p> <p>\u5f53\u6267\u884cmake\u65f6\uff0c\u4e00\u822c\u53ea\u4f1a\u663e\u793a\u8f93\u51fa\uff0c\u4e0d\u4f1a\u663e\u793amake\u5230\u5e95\u6267\u884c\u4e86\u54ea\u4e9b\u547d\u4ee4\u3002</p> <p>\u5982\u60f3\u4e86\u89e3make\u6267\u884c\u4e86\u54ea\u4e9b\u547d\u4ee4\uff0c\u6211\u4eec\u5728Makefile\u4e2d\u8bbe\u7f6e\u4e86<code>V=@</code>\u53c2\u6570\uff0c<code>@</code>\u5728Makefile\u4e2d\u7528\u4e8e\u9690\u85cf\u6267\u884c\u7684\u547d\u4ee4\uff0c\u82e5\u60f3\u8981\u663e\u793a\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6bcf\u6b21<code>make</code>\u6267\u884c\u65f6\u6dfb\u52a0\u53c2\u6570<code>V=</code>\u6765\u907f\u514d\u9690\u85cf\u6267\u884c\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ make clean\n$ make \"V=\"\n</code></pre> <p>\u8981\u83b7\u53d6\u66f4\u591a\u6709\u5173make\u7684\u4fe1\u606f\uff0c\u53ef\u4e0a\u7f51\u67e5\u8be2\uff0c\u5e76\u8bf7\u6267\u884c</p> <pre><code>$ man make\n</code></pre>"},{"location":"lab1/task/#2qemulab1","title":"\u7ec3\u4e602\uff1a\u4f7f\u7528qemu\u6267\u884c\u5e76\u8c03\u8bd5lab1\u4e2d\u7684\u8f6f\u4ef6\u3002\uff08\u8981\u6c42\u5728\u62a5\u544a\u4e2d\u7b80\u8981\u5199\u51fa\u7ec3\u4e60\u8fc7\u7a0b\uff09","text":"<p>\u4e3a\u4e86\u719f\u6089\u4f7f\u7528qemu\u548cgdb\u8fdb\u884c\u7684\u8c03\u8bd5\u5de5\u4f5c\uff0c\u6211\u4eec\u8fdb\u884c\u5982\u4e0b\u7684\u5c0f\u7ec3\u4e60\uff1a</p> <ol> <li>\u4eceuCore\u5185\u6838\u7684\u5165\u53e3\u70b9\u5f00\u59cb\uff0c\u5355\u6b65\u8ddf\u8e2a\u5185\u6838\u521d\u59cb\u5316\u7684\u6267\u884c</li> <li>\u81ea\u5df1\u627e\u4e00\u4e2a\u5185\u6838\u4e2d\u7684\u4ee3\u7801\u4f4d\u7f6e\uff0c\u8bbe\u7f6e\u65ad\u70b9\u5e76\u8fdb\u884c\u6d4b\u8bd5\u3002</li> </ol> <p>\u8865\u5145\u6750\u6599\uff1a \u6211\u4eec\u4e3b\u8981\u901a\u8fc7\u786c\u4ef6\u6a21\u62df\u5668qemu\u6765\u8fdb\u884c\u5404\u79cd\u5b9e\u9a8c\u3002\u5728\u5b9e\u9a8c\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u53ef\u80fd\u4f1a\u9047\u4e0a\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u8c03\u8bd5\u662f\u5fc5\u8981\u7684\u3002qemu\u652f\u6301\u4f7f\u7528gdb\u8fdb\u884c\u7684\u5f3a\u5927\u800c\u65b9\u4fbf\u7684\u8c03\u8bd5\u3002\u6240\u4ee5\u7528\u597dqemu\u548cgdb\u662f\u5b8c\u6210\u5404\u79cd\u5b9e\u9a8c\u7684\u57fa\u672c\u8981\u7d20\u3002</p> <p>\u9ed8\u8ba4\u7684gdb\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u989d\u5916\u7684\u914d\u7f6e\u624d\u8fdb\u884cqemu\u7684\u8c03\u8bd5\u4efb\u52a1\u3002qemu\u548cgdb\u4e4b\u95f4\u4f7f\u7528\u7f51\u7edc\u7aef\u53e31234\u8fdb\u884c\u901a\u8baf\u3002\u5728\u6253\u5f00qemu\u8fdb\u884c\u6a21\u62df\u4e4b\u540e\uff0c\u6267\u884cgdb\u5e76\u8f93\u5165</p> <pre><code>target remote localhost:1234\n</code></pre> <p>\u5373\u53ef\u8fde\u63a5qemu\uff0c\u6b64\u65f6qemu\u4f1a\u8fdb\u5165\u505c\u6b62\u72b6\u6001\uff0c\u542c\u4ecegdb\u7684\u547d\u4ee4\u3002</p> <p>\u53e6\u5916\uff0c\u6211\u4eec\u53ef\u80fd\u9700\u8981qemu\u5728\u4e00\u5f00\u59cb\u4fbf\u8fdb\u5165\u7b49\u5f85\u6a21\u5f0f\uff0c\u5219\u6211\u4eec\u4e0d\u518d\u4f7f\u7528make qemu\u5f00\u59cb\u7cfb\u7edf\u7684\u8fd0\u884c\uff0c\u800c\u4f7f\u7528make debug\u6765\u5b8c\u6210\u8fd9\u9879\u5de5\u4f5c\u3002\u8fd9\u6837qemu\u4fbf\u4e0d\u4f1a\u5728gdb\u5c1a\u672a\u8fde\u63a5\u7684\u65f6\u5019\u64c5\u81ea\u8fd0\u884c\u4e86\u3002</p> <p>gdb\u7684\u5730\u5740\u65ad\u70b9</p> <p>\u5728gdb\u547d\u4ee4\u884c\u4e2d\uff0c\u4f7f\u7528b *[\u5730\u5740]\u4fbf\u53ef\u4ee5\u5728\u6307\u5b9a\u5185\u5b58\u5730\u5740\u8bbe\u7f6e\u65ad\u70b9\uff0c\u5f53qemu\u4e2d\u7684cpu\u6267\u884c\u5230\u6307\u5b9a\u5730\u5740\u65f6\uff0c\u4fbf\u4f1a\u5c06\u63a7\u5236\u6743\u4ea4\u7ed9gdb\u3002</p> <p>gdb\u7684\u5355\u6b65\u547d\u4ee4</p> <p>\u5728gdb\u4e2d\uff0c\u6709next, nexti, step, stepi\u7b49\u6307\u4ee4\u6765\u5355\u6b65\u8c03\u8bd5\u7a0b\u5e8f\uff0c\u4ed6\u4eec\u529f\u80fd\u5404\u4e0d\u76f8\u540c\uff0c\u533a\u522b\u5728\u4e8e\u5355\u6b65\u7684\u201c\u8de8\u5ea6\u201d\u4e0a\u3002</p> <pre><code>next \u5355\u6b65\u5230\u7a0b\u5e8f\u6e90\u4ee3\u7801\u7684\u4e0b\u4e00\u884c\uff0c\u4e0d\u8fdb\u5165\u51fd\u6570\u3002\nnexti \u5355\u6b65\u4e00\u6761\u673a\u5668\u6307\u4ee4\uff0c\u4e0d\u8fdb\u5165\u51fd\u6570\u3002\nstep \u5355\u6b65\u5230\u4e0b\u4e00\u4e2a\u4e0d\u540c\u7684\u6e90\u4ee3\u7801\u884c\uff08\u5305\u62ec\u8fdb\u5165\u51fd\u6570\uff09\u3002\nstepi \u5355\u6b65\u4e00\u6761\u673a\u5668\u6307\u4ee4\u3002\n</code></pre>"},{"location":"lab1/task/#3csr","title":"\u7ec3\u4e603\uff1a\u5206\u6790\u5185\u6838\u542f\u52a8\u540e\u5728\u542f\u7528\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u4e4b\u524d\u9700\u8981\u5728CSR\u4e2d\u5199\u5165\u54ea\u4e9b\u5fc5\u8981\u914d\u7f6e\uff1f\u3002\uff08\u8981\u6c42\u5728\u62a5\u544a\u4e2d\u5199\u51fa\u5206\u6790\uff09","text":"<p>\u63d0\u793a\uff1a\u9700\u8981\u9605\u8bfb**\u5c0f\u8282\u201cLoongArch32\u5b58\u50a8\u7ba1\u7406\u201d**\u548ckern/init/entry.S\u6e90\u7801\uff0c\u4e86\u89e3\u5185\u6838\u5982\u4f55\u8fdb\u884cDMW\u7684\u914d\u7f6e\uff0c\u9700\u8981\u4e86\u89e3\uff1a  - DMW\u6709\u51e0\u4e2a\uff0c\u53ef\u914d\u7f6e\u9879\u6709\u54ea\u4e9b\uff1f  - \u5bf9\u4e8e\u4e00\u4e2a\u5730\u5740\u6620\u5c04\u7a97\u53e3\uff0c\u4ec0\u4e48\u60c5\u51b5\u4e0b\u53ef\u4ee5\u542f\u7528\u4e00\u81f4\u53ef\u7f13\u5b58\uff1f\u4ec0\u4e48\u60c5\u51b5\u4e0b\u5fc5\u987b\u5f3a\u5e8f\u975e\u7f13\u5b58\uff1f\uff08\u63d0\u793a\uff1a\u53ef\u4ee5\u4e86\u89e3MMIO\u4e0eDMA\u5bf9\u4e8e\u5185\u5b58\u5e8f\u4ee5\u53ca\u662f\u5426\u7f13\u5b58\u7684\u8981\u6c42\u3002\uff09  - \u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u9875\u8868\u4e0eDMW\u540c\u65f6\u5339\u914d\u65f6\uff0c\u54ea\u4e2a\u4f18\u5148\u7ea7\u66f4\u9ad8\uff1f</p>"},{"location":"lab1/task/#4","title":"\u7ec3\u4e604\uff1a\u5b8c\u5584\u4f8b\u5916\u521d\u59cb\u5316\u548c\u5904\u7406 \uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u8bf7\u5b8c\u6210\u7f16\u7801\u5de5\u4f5c\u548c\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a</p> <ol> <li>\u7ed3\u5408LoongArch32\u7684\u6587\u6863\uff0c\u5217\u51faLoongArch32\u6709\u54ea\u4e9b\u4f8b\u5916\uff1f\u4ee5\u53ca\u8fd9\u4e9b\u4f8b\u5916\u6709\u54ea\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\u5165\u53e3\uff1f</li> <li>\u8bf7\u7f16\u7a0b\u5b8c\u5584<code>kern/driver/clock.c</code>\u4e2d\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570<code>clock_int_handler</code>\uff0c\u5728\u5bf9\u65f6\u949f\u4e2d\u65ad\u8fdb\u884c\u5904\u7406\u7684\u90e8\u5206\u586b\u5199trap\u51fd\u6570\u4e2d\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u7684\u90e8\u5206\uff0c\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u6bcf\u9047\u5230100\u6b21\u65f6\u949f\u4e2d\u65ad\u540e\uff0c\u8c03\u7528kprintf\uff0c\u5411\u5c4f\u5e55\u4e0a\u6253\u5370\u4e00\u884c\u6587\u5b57\u201d100 ticks\u201d\u3002</li> <li>\u8bf7\u7f16\u7a0b\u5b8c\u5584<code>kern/driver/console.c</code>\u4e2d\u7684\u4e32\u53e3\u4e2d\u65ad\u5904\u7406\u51fd\u6570<code>serial_int_handler</code>\uff0c\u5728\u63a5\u6536\u5230\u4e00\u4e2a\u5b57\u7b26\u540e\u8bfb\u53d6\u8be5\u5b57\u7b26\uff0c\u5e76\u8c03\u7528kprintf\u8f93\u51fa\u8be5\u5b57\u7b26\u3002</li> </ol> <p>\u8981\u6c42\u5b8c\u6210\u95ee\u98982\u30013\u63d0\u51fa\u7684\u76f8\u5173\u51fd\u6570\u5b9e\u73b0\uff0c\u63d0\u4ea4\u6539\u8fdb\u540e\u7684\u6e90\u4ee3\u7801\u5305\uff08\u53ef\u4ee5\u7f16\u8bd1\u6267\u884c\uff09\uff0c\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u5e76\u5199\u51fa\u5bf9\u95ee\u98981\u7684\u56de\u7b54\u3002\u5b8c\u6210\u8fd9\u95ee\u98982\u548c3\u8981\u6c42\u7684\u90e8\u5206\u4ee3\u7801\u540e\uff0c\u8fd0\u884c\u6574\u4e2a\u7cfb\u7edf\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6bcf1\u79d2\u4f1a\u8f93\u51fa\u4e00\u6b21\u201d100 ticks\u201d\uff0c\u800c\u6309\u4e0b\u7684\u952e\u4e5f\u4f1a\u5728\u5c4f\u5e55\u4e0a\u663e\u793a\u3002</p> <p>\u63d0\u793a\uff1a\u53ef\u9605\u8bfb\u5c0f\u8282\u201c\u4e2d\u65ad\u4e0e\u5f02\u5e38\u201d\u3002</p>"},{"location":"lab2/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab2/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3(\u7b2c7\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\n# LAB3  := -DLAB3_EX1 -DLAB3_EX2\n# LAB4  := -DLAB4_EX1 -DLAB4_EX2\n# LAB5  := -DLAB5_EX1 -DLAB5_EX2\n# LAB6  := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0020000 (phys)\nedata 0xA0153370 (phys)\nend   0xA0156650 (phys)\nKernel executable memory footprint: 1242KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0197000\nfree pages: 00001E69\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\nLAB2 Check Pass!\n</code></pre> \u901a\u8fc7\u4e0a\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230ucore\u5728\u663e\u793a\u5176entry\uff08\u5165\u53e3\u5730\u5740\uff09\u3001etext\uff08\u4ee3\u7801\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001edata\uff08\u6570\u636e\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001\u548cend\uff08ucore\u622a\u6b62\u5904\u5730\u5740\uff09\u7684\u503c\u540e\uff0c\u63a2\u6d4b\u51fa\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u7269\u7406\u5185\u5b58\u7684\u5e03\u5c40\u3002\u7136\u540e\u4f1a\u663e\u793a\u5185\u5b58\u8303\u56f4\u548c\u7a7a\u95f2\u5185\u5b58\u7684\u8d77\u59cb\u5730\u5740\uff0c\u663e\u793a\u53ef\u4ee5\u5206\u4e3a\u591a\u5c11\u4e2apage\u3002\u63a5\u4e0b\u6765\u4f1a\u6267\u884c\u5404\u79cd\u6211\u4eec\u8bbe\u7f6e\u7684\u68c0\u67e5\uff0c\u6700\u540e\u54cd\u5e94\u65f6\u949f\u4e2d\u65ad\u3002</p>"},{"location":"lab2/lab2/","title":"\u7269\u7406\u5185\u5b58\u7ba1\u7406","text":"<p>\u5b9e\u9a8c\u4e00\u8fc7\u540e\u5927\u5bb6\u505a\u51fa\u6765\u4e86\u4e00\u4e2a\u53ef\u4ee5\u542f\u52a8\u7684\u7cfb\u7edf\uff0c\u5b9e\u9a8c\u4e8c\u4e3b\u8981\u6d89\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u3002\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4e86\u4f7f\u7528\u5185\u5b58\uff0c\u8fd8\u9700\u9ad8\u6548\u5730\u7ba1\u7406\u5185\u5b58\u8d44\u6e90\u3002\u5728\u5b9e\u9a8c\u4e8c\u4e2d\u5927\u5bb6\u4f1a\u4e86\u89e3\u5e76\u4e14\u81ea\u5df1\u52a8\u624b\u5b8c\u6210\u4e00\u4e2a\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\u3002</p>"},{"location":"lab2/lab2/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u7406\u89e3\u57fa\u4e8e\u9875\u8868\u7684\u8f6c\u6362\u673a\u5236</li> <li>\u7406\u89e3\u9875\u8868\u7684\u5efa\u7acb\u548c\u4f7f\u7528\u65b9\u6cd5</li> <li>\u7406\u89e3\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\u65b9\u6cd5</li> </ul>"},{"location":"lab2/lab2/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u5305\u542b\u4e09\u4e2a\u90e8\u5206\u3002\u9996\u5148\u4e86\u89e3\u5982\u4f55\u53d1\u73b0\u7cfb\u7edf\u4e2d\u7684\u7269\u7406\u5185\u5b58\uff1b\u7136\u540e\u4e86\u89e3\u5982\u4f55\u5efa\u7acb\u5bf9\u7269\u7406\u5185\u5b58\u7684\u521d\u6b65\u7ba1\u7406\uff0c\u5373\u4e86\u89e3\u8fde\u7eed\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff1b\u6700\u540e\u4e86\u89e3\u9875\u8868\u76f8\u5173\u7684\u64cd\u4f5c\uff0c\u5373\u5982\u4f55\u5efa\u7acb\u9875\u8868\u6765\u5b9e\u73b0\u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u4e4b\u95f4\u7684\u6620\u5c04\u3002\u672c\u5b9e\u9a8c\u91cc\u9762\u5b9e\u73b0\u7684\u5185\u5b58\u7ba1\u7406\u8fd8\u662f\u975e\u5e38\u57fa\u672c\u7684\uff0c\u5e76\u6ca1\u6709\u6d89\u53ca\u5230\u5bf9\u5b9e\u9645\u673a\u5668\u7684\u4f18\u5316\uff0c\u6bd4\u5982\u9488\u5bf9 cache \u7684\u4f18\u5316\u7b49\u3002\u5982\u679c\u5927\u5bb6\u6709\u4f59\u529b\uff0c\u5c1d\u8bd5\u5b8c\u6210\u6269\u5c55\u7ec3\u4e60\u3002</p>"},{"location":"lab2/lab2/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u4e3b\u8981\u5b8c\u6210ucore\u5185\u6838\u5bf9\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\u5de5\u4f5c\u3002</p> <p>kern_init\u51fd\u6570\u5728\u5b8c\u6210\u4e00\u4e9b\u8f93\u51fa\u5e76\u5bf9lab1\u5b9e\u9a8c\u7ed3\u679c\u7684\u68c0\u67e5\u540e\uff0c\u5c06\u8fdb\u5165\u7269\u7406\u5185\u5b58\u7ba1\u7406\u521d\u59cb\u5316\u7684\u5de5\u4f5c\uff0c\u5373\u8c03\u7528pmm_init\u51fd\u6570\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\uff0c\u8fd9\u4e5f\u662f\u6211\u4eeclab2\u7684\u5185\u5bb9\u3002\u63a5\u7740\u6267\u884cintr_enable\u51fd\u6570\u5f00\u542f\u4e2d\u65ad\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u4e0elab1\u7684\u4e2d\u65ad\u5f02\u5e38\u5de5\u4f5c\u7684\u5185\u5bb9\u662f\u76f8\u540c\u7684\u3002</p> <p>\u4e3a\u4e86\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u8fd9\u91cc\u9996\u5148\u9700\u8981\u63a2\u6d4b\u53ef\u7528\u7684\u7269\u7406\u5185\u5b58\u8d44\u6e90\uff1b\u4e86\u89e3\u5230\u7269\u7406\u5185\u5b58\u4f4d\u4e8e\u4ec0\u4e48\u5730\u65b9\uff0c\u6709\u591a\u5927\u3002</p> <p>\u5728\u786e\u5b9a\u4e86\u7269\u7406\u5185\u5b58\u5927\u5c0f\u540e\uff0c\u5c31\u4ee5\u56fa\u5b9a\u9875\u9762\u5927\u5c0f\u6765\u5212\u5206\u6574\u4e2a\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u51c6\u5907\u4ee5\u6b64\u4e3a\u6700\u5c0f\u5185\u5b58\u5206\u914d\u5355\u4f4d\u6765\u7ba1\u7406\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u7ba1\u7406\u5728\u5185\u6838\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6bcf\u9875\u5185\u5b58\uff0c\u8bbe\u5b9a\u5176\u53ef\u7528\u72b6\u6001\uff08free\u7684\uff0cused\u7684\uff0c\u8fd8\u662freserved\u7684\uff09\uff0c\u8fd9\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u7684\u8fde\u7eed\u5185\u5b58\u5206\u914d\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\uff1b\u63a5\u7740ucore kernel\u5c31\u8981\u5efa\u7acb\u9875\u8868\uff0c\u542f\u52a8\u5206\u9875\u673a\u5236\uff0c\u5f53\u7f3a\u9875\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u5c31\u4f1a\u8df3\u8f6c\u5230\u5185\u6838\u7684\u5f02\u5e38\u5904\u7406\u5730\u5740\u4e0a\uff0c\u7531\u5185\u6838\u5b8c\u6210TLB\u586b\u5145\uff0c\u6839\u636e\u9875\u8868\u9879\u63cf\u8ff0\u7684\u865a\u62df\u9875\uff08Page\uff09\u4e0e\u7269\u7406\u9875\u5e27\uff08Page Frame\uff09\u7684\u5bf9\u5e94\u5173\u7cfb\u5b8c\u6210CPU\u5bf9\u5185\u5b58\u7684\u8bfb\u3001\u5199\u548c\u6267\u884c\u64cd\u4f5c\u3002\u8fd9\u4e00\u90e8\u5206\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u5185\u5b58\u6620\u5c04\u3001\u9875\u8868\u3001\u591a\u7ea7\u9875\u8868\u7b49\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\u3002</p> <p>\u5728\u4ee3\u7801\u5206\u6790\u4e0a\uff0c\u5efa\u8bae\u6839\u636e\u6267\u884c\u6d41\u7a0b\u6765\u76f4\u63a5\u770b\u6e90\u4ee3\u7801\uff0c\u5e76\u53ef\u91c7\u7528GDB\u6e90\u7801\u8c03\u8bd5\u7684\u624b\u6bb5\u6765\u52a8\u6001\u5730\u5206\u6790ucore\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u603b\u4f53\u63a7\u5236\u51fd\u6570\u662fpmm_init\u51fd\u6570\uff0c\u5b83\u5b8c\u6210\u7684\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a</p> <ol> <li> <p>\u521d\u59cb\u5316\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff1b</p> </li> <li> <p>\u5efa\u7acb\u7a7a\u95f2\u7684page\u94fe\u8868\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5206\u914d\u4ee5\u9875\uff084KB\uff09\u4e3a\u5355\u4f4d\u7684\u7a7a\u95f2\u5185\u5b58\u4e86\uff1b</p> </li> <li> <p>\u68c0\u67e5\u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\uff1b</p> </li> <li> <p>\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\uff1b</p> </li> <li> <p>\u4f7f\u80fd\u5206\u9875\u673a\u5236\uff1b</p> </li> <li> <p>\u68c0\u67e5\u9875\u8868\u5efa\u7acb\u662f\u5426\u6b63\u786e\uff1b</p> </li> </ol> <p>\u53e6\u5916\uff0c\u4e3b\u8981\u6ce8\u610f\u7684\u76f8\u5173\u4ee3\u7801\u5185\u5bb9\u5305\u62ec\uff1a</p> <ul> <li>\u7ba1\u7406\u6bcf\u4e2a\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\uff08\u5728mm/memlayout.h\u4e2d\uff09\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u4e5f\u662f\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u6570\u636e\u7ed3\u6784\uff0c\u53ef\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u7a7a\u95f2\u5757\u7684\u94fe\u63a5\u548c\u4fe1\u606f\u5b58\u50a8\uff0c\u800c\u57fa\u4e8e\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u7684\u7ba1\u7406\u7269\u7406\u9875\u6570\u7ec4\u8d77\u59cb\u5730\u5740\u5c31\u662f\u5168\u5c40\u53d8\u91cfpages\uff0c\u5177\u4f53\u521d\u59cb\u5316\u6b64\u6570\u7ec4\u7684\u51fd\u6570\u4f4d\u4e8epage_init\u51fd\u6570\u4e2d\uff1b</li> <li>\u7528\u4e8e\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u4e86\u5b9e\u73b0\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u51fd\u6570\u6307\u9488\uff0c\u800c\u540c\u5b66\u4eec\u9700\u8981\u5b8c\u6210\u8fd9\u4e9b\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\uff1b</li> <li>\u8bbe\u5b9a\u4e8c\u7ea7\u9875\u8868\u548c\u5efa\u7acb\u9875\u8868\u9879\u4ee5\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff0c\u8fd9\u4e0e\u786c\u4ef6\u76f8\u5173\uff0c\u4e14\u7528\u5230\u4e0d\u5c11\u5185\u8054\u51fd\u6570\uff0c\u6e90\u4ee3\u7801\u76f8\u5bf9\u96be\u61c2\u4e00\u4e9b\u3002\u5177\u4f53\u5b8c\u6210\u9875\u8868\u548c\u9875\u8868\u9879\u5efa\u7acb\u7684\u91cd\u8981\u51fd\u6570\u662fboot_map_segment\u51fd\u6570\uff0c\u800cget_pte\u51fd\u6570\u662f\u5b8c\u6210\u865a\u5b9e\u6620\u5c04\u5173\u952e\u7684\u5173\u952e\u3002</li> </ul>"},{"location":"lab2/paging/","title":"\u5206\u9875\u673a\u5236","text":""},{"location":"lab2/paging/#_1","title":"\u5b9e\u73b0\u5206\u9875\u673a\u5236","text":"<p>\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u9700\u8981\u91cd\u70b9\u4e86\u89e3\u548c\u5b9e\u73b0\u57fa\u4e8e\u9875\u8868\u7684\u9875\u673a\u5236\u548c\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u65b9\u6cd5\u548c\u5206\u914d\u7b97\u6cd5\u7b49\u3002\u4e0b\u9762\u6bd4\u8f83\u8be6\u7ec6\u5730\u4ecb\u7ecd\u4e86\u5b9e\u73b0\u5206\u9875\u673a\u5236\u7684\u8fc7\u7a0b\u3002</p>"},{"location":"lab2/paging/#dmw","title":"\u5efa\u7acbDMW+\u5206\u9875\u7ba1\u7406\u4e2d\u9700\u8981\u8003\u8651\u7684\u5173\u952e\u95ee\u9898","text":"<p>\u4e3a\u4e86\u5b9e\u73b0\u5206\u9875\u673a\u5236\uff0c\u9700\u8981\u5efa\u7acb\u597d\u865a\u62df\u5185\u5b58\u548c\u7269\u7406\u5185\u5b58\u7684\u9875\u6620\u5c04\u5173\u7cfb\u3002\u6b64\u8fc7\u7a0b\u6d89\u53ca\u786c\u4ef6\u7ec6\u8282\uff0c\u4e0d\u540c\u7684\u5730\u5740\u6620\u5c04\u5173\u7cfb\u7ec4\u5408\uff0c\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\u3002\u603b\u4f53\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u601d\u8003\u5982\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u5bf9\u4e8e\u54ea\u4e9b\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u9700\u8981\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\uff1f</li> <li>\u5177\u4f53\u7684\u6620\u5c04\u5173\u7cfb\u662f\u4ec0\u4e48\uff1f</li> <li>\u9875\u76ee\u5f55\u8868\u7684\u8d77\u59cb\u5730\u5740\u8bbe\u7f6e\u5728\u54ea\u91cc\uff1f</li> <li>\u9875\u8868\u7684\u8d77\u59cb\u5730\u5740\u8bbe\u7f6e\u5728\u54ea\u91cc\uff0c\u9700\u8981\u591a\u5927\u7a7a\u95f4\uff1f</li> <li>\u5982\u4f55\u8bbe\u7f6e\u9875\u76ee\u5f55\u8868\u9879\u7684\u5185\u5bb9\uff1f</li> <li>\u5982\u4f55\u8bbe\u7f6e\u9875\u8868\u9879\u7684\u5185\u5bb9\uff1f</li> </ul>"},{"location":"lab2/paging/#_2","title":"\u7cfb\u7edf\u6267\u884c\u4e2d\u5730\u5740\u6620\u5c04\u7684\u8fc7\u7a0b","text":"<p>\u5728lab1\u548clab2\u4e2d\u90fd\u4f1a\u6d89\u53ca\u5982\u4f55\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\u7684\u64cd\u4f5c\uff0c\u5728\u9f99\u82af\u67b6\u6784\u4e2dMMU\u652f\u6301\u4e24\u79cd\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff1a\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u7269\u7406\u5730\u5740\u9ed8\u8ba4\u76f4\u63a5\u7b49\u4e8e\u865a\u62df\u5730\u5740\u7684[PALEN-1:0]\u4f4d\uff08\u4e0d\u8db3\u88650\uff09\u3002\u5f53\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u5177\u4f53\u53c8\u5206\u4e3a\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6a21\u5f0f\u662f\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\u673a\u5236\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u7684\u76f4\u63a5\u6620\u5c04\uff0c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u901a\u8fc7\u9875\u8868\u5b8c\u6210\u6620\u5c04\u3002</p> <p>\u5728lab1\u548clab2\u4e2d\u6211\u4eec\u5728ucore\u7684\u5165\u53e3\u51fd\u6570kernel_entry\uff08entry.S\u6587\u4ef6\u4e2d\uff09\u4e2d\u8bbe\u7f6e\u4e86CSR.CRMD\u7684DA=0\u4e14PG=1\uff0c\u5373\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u540c\u65f6\uff0c\u6211\u4eec\u5c06CSR.DWM0\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0xa0000001\uff0c\u8868\u793a 0xa0000000-0xbfffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u5c06CSR.DWM1\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0x80000011\uff0c\u8868\u793a0x80000000-0x9fffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u7528\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u9664\u4e86\u8fd9\u4e24\u6bb5\u865a\u62df\u5730\u5740\u4e4b\u5916\u7684\u865a\u62df\u5730\u5740\u90fd\u662f\u901a\u8fc7\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u8fdb\u884c\u6620\u5c04\u3002</p> <p>\u4e0b\u9762\uff0c\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u6539\u53d8\u5185\u6838\u7684\u8d77\u59cb\u5730\u5740\u3002\u89c2\u5bdf\u4e00\u4e0b\u94fe\u63a5\u811a\u672c\uff0c\u5373tools/kernel.ld\u6587\u4ef6\uff1a <pre><code>OUTPUT_ARCH(loongarch)\nENTRY(kernel_entry)\nSECTIONS\n{\n    . = 0xa0000000;\n\n  .text      :\n  {\n    . = ALIGN(4);\n    wrs_kernel_text_start = .; _wrs_kernel_text_start = .;\n    *(.startup)\n    *(.text) \n    *(.text.*)\n    *(.gnu.linkonce.t*)\n    *(.mips16.fn.*) \n    *(.mips16.call.*) /* for MIPS */\n    *(.rodata) *(.rodata.*) *(.gnu.linkonce.r*) *(.rodata1)\n    . = ALIGN(4096);\n    *(.ramexv)\n  }\n</code></pre> \u4ece\u4e0a\u8ff0\u4ee3\u7801\u53ef\u4ee5\u770b\u51fald\u5de5\u5177\u5f62\u6210\u7684ucore\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\u4ece0xa0000000\u5f00\u59cb\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6bb5\u7684\u5730\u5740\u662f\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6bb5\uff0c\u6240\u4ee5\u5176\u8d77\u59cb\u7684\u7269\u7406\u5730\u5740\u4e3a0x00000000\uff0c\u5373</p> <pre><code> phy addr  = CSR.DMW0[31:29]  : virtual addr[28:0] \n</code></pre> <p>**\u7b2c\u4e00\u4e2a\u9636\u6bb5**\u4ecekernel_entry\u51fd\u6570\u5f00\u59cb\u5230pmm_init\u51fd\u6570\u6267\u884c\u4e4b\u524d\uff0cucore\u91c7\u7528\u76f4\u63a5\u6620\u5c04\u5730\u5740\u65b9\u5f0f\u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\uff0c\u7ffb\u8bd1\u65b9\u5f0f\u5982\u4e0a\u3002\u6ce8\u610f\uff0c\u7531\u4e8e0x80000000-0x9fffffff\u548c0xa0000000-0xbfffffff\u624d\u80fd\u8fdb\u884c\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5185\u6838\u7684\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7512M\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u9636\u6bb5\uff08\u521b\u5efa\u521d\u59cb\u9875\u76ee\u5f55\u8868\uff0c\u5f00\u542f\u5206\u9875\u6a21\u5f0f\uff09\u4ecepmm_init\u51fd\u6570\u88ab\u8c03\u7528\u5f00\u59cb\uff0c\u5728pmm_init\u51fd\u6570\u4e2d\u521b\u5efa\u4e86boot_pgdir\uff0c\u521d\u59cb\u5316\u4e86\u9875\u76ee\u5f55\u8868\uff0c\u6b63\u5f0f\u5f00\u59cb\u4e86\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002</p>"},{"location":"lab2/paging/#_3","title":"\u7269\u7406\u5185\u5b58\u63a2\u6d4b","text":"<p>\u8fd9\u91cc\u7ec6\u5fc3\u7684\u8bfb\u8005\u4e00\u5b9a\u4f1a\u6709\u7591\u95ee\uff0c\u5728\u7ffb\u9605uCore(LoongArch32\u7248\u672c)\u4ee3\u7801\u540e\u53d1\u73b0\u5185\u5b58\u5927\u5c0f\u4f3c\u4e4e\u662f\u5199\u6b7b\u768432M\uff0c\u5e76\u6ca1\u6709\u50cfx86\u7b49\u67b6\u6784\u4e00\u6837\u901a\u8fc7e820\u53bb\u5f97\u5230\u4e00\u4e2a\u53ef\u7528\u5185\u5b58\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u64cd\u4f5c\u7cfb\u7edf\u4f3c\u4e4e\u6ca1\u6709\u5b8c\u6210\u7269\u7406\u5185\u5b58\u63a2\u6d4b\u7684\u64cd\u4f5c\u3002\u786e\u5b9e\u662f\u8fd9\u6837\uff0c\u5728\u8bb8\u591aRISC\u67b6\u6784\u4e0b\uff0c\u7531\u4e8e\u6ca1\u6709\u63d0\u4f9bACPI\u7b49\u673a\u5236\uff0c\u901a\u5e38\u542f\u52a8\u7cfb\u7edf\u5185\u6838\u4f1a\u8bfb\u53d6\u4e00\u4e2a\u53eb\u505a\u8bbe\u5907\u6811(Device Tree)\u7684\u6587\u4ef6\uff0c\u6765\u63cf\u8ff0\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u7684\u5730\u5740\u548c\u7279\u6027\uff0c\u8bbe\u5907\u6811\u4e2d\u4e5f\u5305\u62ec\u4e86\u5185\u5b58\u5927\u5c0f\uff0c\u800c\u5e76\u4e0d\u662f\u4ea4\u7ed9\u7cfb\u7edf\u5185\u6838\u81ea\u5df1\u53bb\u63a2\u6d4b\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u89c1\u5230\u8bb8\u591aARM\u548cRISC-V\u67b6\u6784\u7684Linux\u5f00\u53d1\u677f\uff0c\u4e0d\u540c\u5185\u5b58\u5bb9\u91cf\u7684\u7248\u672c\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u955c\u50cf\uff0c\u4e5f\u662f\u56e0\u4e3a\u8bbe\u5907\u6811\u4e0d\u540c\u5bfc\u81f4\u7684\u3002\u800c\u4e3a\u4e86\u7b80\u5316\u7cfb\u7edf\u7684\u8bbe\u8ba1\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u5b9e\u73b0\u8bbe\u5907\u6811\u7684\u8bfb\u53d6\uff0c\u56e0\u6b64\u91c7\u7528\u4e86\u5199\u6b7b\u768432M\u3002</p>"},{"location":"lab2/paging/#_4","title":"\u4ee5\u9875\u4e3a\u5355\u4f4d\u7ba1\u7406\u7269\u7406\u5185\u5b58","text":"<p>\u5728\u83b7\u5f97\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u540e\uff0c\u7cfb\u7edf\u9700\u8981\u5efa\u7acb\u76f8\u5e94\u7684\u6570\u636e\u7ed3\u6784\u6765\u7ba1\u7406\u4ee5\u7269\u7406\u9875\uff08\u63094KB\u5bf9\u9f50\uff0c\u4e14\u5927\u5c0f\u4e3a4KB\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\uff09\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u4ee5\u914d\u5408\u540e\u7eed\u6d89\u53ca\u7684\u5206\u9875\u7ba1\u7406\u673a\u5236\u3002\u6bcf\u4e2a\u7269\u7406\u9875\u53ef\u4ee5\u7528\u4e00\u4e2aPage\u6570\u636e\u7ed3\u6784\u6765\u8868\u793a\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u9700\u8981\u5360\u7528\u4e00\u4e2aPage\u7ed3\u6784\u7684\u7a7a\u95f4\uff0cPage\u7ed3\u6784\u5728\u8bbe\u8ba1\u65f6\u987b\u5c3d\u53ef\u80fd\u5c0f\uff0c\u4ee5\u51cf\u5c11\u5bf9\u5185\u5b58\u7684\u5360\u7528\u3002Page\u7684\u5b9a\u4e49\u5728kern/mm/memlayout.h\u4e2d\u3002\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7ba1\u7406\u7684\u5b9e\u73b0\u5728kern/default_pmm.c\u4e2d\u3002</p> <p>\u4e3a\u4e86\u4e0e\u4ee5\u540e\u7684\u5206\u9875\u673a\u5236\u914d\u5408\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u5efa\u7acb\u5bf9\u6574\u4e2a\u8ba1\u7b97\u673a\u7684\u6bcf\u4e00\u4e2a\u7269\u7406\u9875\u7684\u5c5e\u6027\u7528\u7ed3\u6784Page\u6765\u8868\u793a\uff0c\u5b83\u5305\u542b\u4e86\u6620\u5c04\u6b64\u7269\u7406\u9875\u7684\u865a\u62df\u9875\u4e2a\u6570\uff0c\u63cf\u8ff0\u7269\u7406\u9875\u5c5e\u6027\u7684flags\u548c\u53cc\u5411\u94fe\u63a5\u5404\u4e2aPage\u7ed3\u6784\u7684page_link\u53cc\u5411\u94fe\u8868\u3002 <pre><code>struct Page {\nint ref;        // page frame's reference counter\nuint32_t flags; // array of flags that describe the status of the page frame\nunsigned int property; // used in buddy system, stores the order (the X in 2^X) of the continuous memory block\nint zone_num;  // used in buddy system, the No. of zone which the page belongs to\nlist_entry_t page_link;// free list link\nlist_entry_t swap_link;  // swap hash link\n};\n</code></pre> \u8fd9\u91cc\u770b\u770bPage\u6570\u636e\u7ed3\u6784\u7684\u5404\u4e2a\u6210\u5458\u53d8\u91cf\u6709\u4f55\u5177\u4f53\u542b\u4e49\u3002ref\u8868\u793a\u8fd9\u9875\u88ab\u9875\u8868\u7684\u5f15\u7528\u8bb0\u6570\uff08\u5728\u201c\u5b9e\u73b0\u5206\u9875\u673a\u5236\u201d\u4e00\u8282\u4f1a\u8bb2\u5230\uff09\u3002\u5982\u679c\u8fd9\u4e2a\u9875\u88ab\u9875\u8868\u5f15\u7528\u4e86\uff0c\u5373\u5728\u67d0\u9875\u8868\u4e2d\u6709\u4e00\u4e2a\u9875\u8868\u9879\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u865a\u62df\u9875\u5230\u8fd9\u4e2aPage\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u52a0\u4e00\uff1b\u53cd\u4e4b\uff0c\u82e5\u9875\u8868\u9879\u53d6\u6d88\uff0c\u5373\u6620\u5c04\u5173\u7cfb\u89e3\u9664\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u51cf\u4e00\u3002flags\u8868\u793a\u6b64\u7269\u7406\u9875\u7684\u72b6\u6001\u6807\u8bb0\uff0c\u8fdb\u4e00\u6b65\u67e5\u770bkern/mm/memlayout.h\u4e2d\u7684\u5b9a\u4e49\uff0c\u53ef\u4ee5\u770b\u5230\uff1a <pre><code>/* Flags describing the status of a page frame */\n#define PG_reserved                 0       // the page descriptor is reserved for kernel or unusable\n#define PG_property                 1       // the member 'property' is valid\n#define PG_slab                     2       // page frame is included in a slab\n#define PG_dirty                    3       // the page has been modified\n#define PG_swap                     4       // the page is in the active or inactive page list (and swap hash table)\n#define PG_active                   5       // the page is in the active page list\n</code></pre> \u8fd9\u8868\u793aflags\u76ee\u524d\u7528\u5230\u4e86\u516d\u4e2abit\u8868\u793a\u9875\u76ee\u524d\u5177\u6709\u7684\u516d\u79cd\u5c5e\u6027\uff0cbit 0\u8868\u793a\u6b64\u9875\u662f\u5426\u88ab\u4fdd\u7559\uff08reserved\uff09\uff0c\u5982\u679c\u662f\u88ab\u4fdd\u7559\u7684\u9875\uff0c\u5219bit 0\u4f1a\u8bbe\u7f6e\u4e3a1\uff0c\u4e14\u4e0d\u80fd\u653e\u5230\u7a7a\u95f2\u9875\u94fe\u8868\u4e2d\uff0c\u5373\u8fd9\u6837\u7684\u9875\u4e0d\u662f\u7a7a\u95f2\u9875\uff0c\u4e0d\u80fd\u52a8\u6001\u5206\u914d\u4e0e\u91ca\u653e\u3002\u6bd4\u5982\u76ee\u524d\u5185\u6838\u4ee3\u7801\u5360\u7528\u7684\u7a7a\u95f4\u5c31\u5c5e\u4e8e\u8fd9\u6837\u201c\u88ab\u4fdd\u7559\u201d\u7684\u9875\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cbit 1\u8868\u793a\u6b64\u9875\u662f\u5426\u662ffree\u7684\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a1\uff0c\u8868\u793a\u8fd9\u9875\u662ffree\u7684\uff0c\u53ef\u4ee5\u88ab\u5206\u914d\uff1b\u5982\u679c\u8bbe\u7f6e\u4e3a0\uff0c\u8868\u793a\u8fd9\u9875\u5df2\u7ecf\u88ab\u5206\u914d\u51fa\u53bb\u4e86\uff0c\u4e0d\u80fd\u88ab\u518d\u4e8c\u6b21\u5206\u914d\u3002</p> <p>\u53e6\u5916\uff0c\u672c\u5b9e\u9a8c\u8fd9\u91cc\u53d6\u7684\u540d\u5b57PG_property\u6bd4\u8f83\u4e0d\u76f4\u89c2\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\uff08best fit, buddy system\u7b49\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2aPG_property\u5c31\u6709\u4e0d\u540c\u7684\u542b\u4e49\u4e86\u3002</p> <p>\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cPage\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfproperty\u7528\u6765\u8bb0\u5f55\u67d0\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff08\u5373\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfproperty\u6765\u8bb0\u5f55\u5728\u6b64\u5757\u5185\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u3002\u8fd9\u91cc\u53d6\u7684\u540d\u5b57property\u4e5f\u4e0d\u662f\u5f88\u76f4\u89c2\uff0c\u539f\u56e0\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u5728\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\u4e2d\uff0cproperty\u6709\u4e0d\u540c\u7684\u542b\u4e49\u3002</p> <p>Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfpage_link\u662f\u4fbf\u4e8e\u628a\u591a\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u94fe\u63a5\u5728\u4e00\u8d77\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\uff08\u53ef\u56de\u987e\u5728lab0\u5b9e\u9a8c\u6307\u5bfc\u4e66\u4e2d\u6709\u5173\u53cc\u5411\u94fe\u8868\u6570\u636e\u7ed3\u6784\u7684\u4ecb\u7ecd\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfpage_link\u6765\u94fe\u63a5\u6bd4\u5b83\u5730\u5740\u5c0f\u548c\u5927\u7684\u5176\u4ed6\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002</p> <p>\u5728\u521d\u59cb\u60c5\u51b5\u4e0b\uff0c\u4e5f\u8bb8\u8fd9\u4e2a\u7269\u7406\u5185\u5b58\u7684\u7a7a\u95f2\u7269\u7406\u9875\u90fd\u662f\u8fde\u7eed\u7684\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u4f46\u968f\u7740\u7269\u7406\u9875\u7684\u5206\u914d\u4e0e\u91ca\u653e\uff0c\u8fd9\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u4f1a\u5206\u88c2\u4e3a\u4e00\u7cfb\u5217\u5730\u5740\u4e0d\u8fde\u7eed\u7684\u591a\u4e2a\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\uff0c\u4e14\u6bcf\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5185\u90e8\u7684\u7269\u7406\u9875\u662f\u8fde\u7eed\u7684\u3002\u90a3\u4e48\u4e3a\u4e86\u6709\u6548\u5730\u7ba1\u7406\u8fd9\u4e9b\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u6240\u6709\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u53ef\u7528\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\u7ba1\u7406\u8d77\u6765\uff0c\u4fbf\u4e8e\u5206\u914d\u548c\u91ca\u653e\uff0c\u4e3a\u6b64\u5b9a\u4e49\u4e86\u4e00\u4e2afree_area_t\u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u4e86\u4e00\u4e2alist_entry\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\u548c\u8bb0\u5f55\u5f53\u524d\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u7684\u65e0\u7b26\u53f7\u6574\u578b\u53d8\u91cfnr_free\u3002\u5176\u4e2d\u7684\u94fe\u8868\u6307\u9488\u6307\u5411\u4e86\u7a7a\u95f2\u7684\u7269\u7406\u9875\u3002 <pre><code>/* free_area_t - maintains a doubly linked list to record free (unused) pages */\ntypedef struct {\nlist_entry_t free_list;                                // the list header\nunsigned int nr_free;                                 // # of free pages in this free list\n} free_area_t;\n</code></pre> \u6709\u4e86\u8fd9\u4e24\u4e2a\u6570\u636e\u7ed3\u6784\uff0cucore\u5c31\u53ef\u4ee5\u7ba1\u7406\u8d77\u6765\u6574\u4e2a\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002\u63a5\u4e0b\u6765\u9700\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li> <p>\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u5360\u591a\u5927\u7a7a\u95f4\uff1f</p> </li> <li> <p>\u7a7a\u95f2\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u5728\u54ea\u91cc\uff1f</p> </li> </ul> <p>\u5bf9\u4e8e\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9996\u5148\u6839\u636ememlayout.h\u7ed9\u51fa\u7684\u6838\u5fc3\u6001\u5185\u5b58\u57fa\u5730\u5740KERNBASE\uff080xa0000000\uff09\u548cKMEMSIZE\uff08512M\uff09\u8ba1\u7b97\u51fa\u6700\u5927\u7684\u7269\u7406\u5185\u5b58\u5730\u5740KERNTOP\uff08\u5b9a\u4e49\u5728memlayout.h\u4e2d\uff09\uff0c\u6700\u5927\u7269\u7406\u5185\u5b58\u5730\u5740maxpa\u7b49\u4e8eKERNTOP\uff08\u5b9a\u4e49\u5728page_init\u51fd\u6570\u4e2d\u7684\u5c40\u90e8\u53d8\u91cf\uff09\uff0c\u5728\u8be5\u5b9e\u9a8c\u4e2dPage size\u4e3a4096 bytes\u53732^12 bytes\uff0c\u6240\u4ee5\u9700\u8981\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u4e2a\u6570npage\u7684\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <p><pre><code>#define KERNTOP             (KERNBASE + KMEMSIZE)\nmaxpa = KERNTOP\nnpage = KMEMSIZE &gt;&gt; PGSHIFT    # PGSHIFT = 12\n</code></pre> \u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u4f30\u51fa\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684\u5185\u5b58\u5927\u5c0f\u4e3a\uff1a <pre><code>sizeof(struct Page) * npage\n</code></pre> \u7531\u4e8e\u52a0\u8f7d\u5185\u6838\u7684\u7ed3\u675f\u5730\u5740\uff08\u7528\u5168\u5c40\u6307\u9488\u53d8\u91cfend\u8bb0\u5f55\uff09\u4ee5\u4e0a\u7684\u7a7a\u95f4\u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u628aend\u6309\u9875\u5927\u5c0f\u4e3a\u8fb9\u754c\u53d6\u6574\u540e\uff0c\u4f5c\u4e3a\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u8bb0\u4e3a\uff1a <pre><code>pages = (struct Page *)ROUNDUP_2N((void *)end, PGSHIFT); </code></pre> \u4e3a\u4e86\u7b80\u5316\u8d77\u89c1\uff0c\u4ece\u5730\u57400\u5230\u5730\u5740pages+ sizeof(struct Page) *npage)\u7ed3\u675f\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbe\u5b9a\u4e3a\u5df2\u5360\u7528\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff08\u8d77\u59cb0~640KB\u7684\u7a7a\u95f4\u662f\u7a7a\u95f2\u7684\uff09\uff0c\u5730\u5740pages+sizeof(struct Page) *npage)\u4ee5\u4e0a\u7684\u7a7a\u95f4\u4e3a\u7a7a\u95f2\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u8fd9\u65f6\u7684\u7a7a\u95f2\u7a7a\u95f4\u8d77\u59cb\u5730\u5740\u4e3a</p> <p><pre><code>uintptr_t freemem = PADDR((uintptr_t)pages + sizeof(struct Page) * npage);\n</code></pre> \u4e3a\u6b64\u6211\u4eec\u9700\u8981\u628a\u8fd9\u4e24\u90e8\u5206\u7a7a\u95f4\u7ed9\u6807\u8bc6\u51fa\u6765\u3002\u9996\u5148\uff0c\u5bf9\u4e8e\u6240\u6709\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u5360\u7528\u6807\u8bb0\uff1a <pre><code>for (i = 0; i &lt; npage; i ++) {\nSetPageReserved(pages + i);\n}\n</code></pre> \u7136\u540e\uff0c\u6839\u636e\u63a2\u6d4b\u5230\u7684\u7a7a\u95f2\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u7a7a\u95f2\u6807\u8bb0\uff1a <pre><code>//\u83b7\u5f97\u7a7a\u95f2\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740begin\u548c\u7ed3\u675f\u5730\u5740end\n...\ninit_memmap(pa2page(mbegin), (mend - mbegin) &gt;&gt; PGSHIFT );\n</code></pre> \u5176\u5b9eSetPageReserved\u53ea\u9700\u628a\u7269\u7406\u5730\u5740\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u6807\u5fd7\u8bbe\u7f6e\u4e3aPG_reserved\uff0c\u8868\u793a\u8fd9\u4e9b\u9875\u5df2\u7ecf\u88ab\u4f7f\u7528\u4e86\uff0c\u5c06\u6765\u4e0d\u80fd\u88ab\u7528\u4e8e\u5206\u914d\u3002\u800cinit_memmap\u51fd\u6570\u5219\u662f\u628a\u7a7a\u95f2\u7269\u7406\u9875\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u548c\u5f15\u7528\u8ba1\u6570ref\u6e05\u96f6\uff0c\u5e76\u52a0\u5230free_area.free_list\u6307\u5411\u7684\u53cc\u5411\u5217\u8868\u4e2d\uff0c\u4e3a\u5c06\u6765\u7684\u7a7a\u95f2\u9875\u7ba1\u7406\u505a\u597d\u521d\u59cb\u5316\u51c6\u5907\u5de5\u4f5c\u3002</p> <p>\u5173\u4e8e\u5185\u5b58\u5206\u914d\u7684\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u65b9\u9762\u7684\u77e5\u8bc6\u6709\u5f88\u591a\uff0c\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\u53ea\u5b9e\u73b0\u4e86\u6700\u7b80\u5355\u7684\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u3002\u76f8\u5e94\u7684\u5b9e\u73b0\u5728default_pmm.c\u4e2d\u7684default_alloc_pages\u51fd\u6570\u548cdefault_free_pages\u51fd\u6570\uff0c\u76f8\u5173\u5b9e\u73b0\u5f88\u7b80\u5355\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5177\u4f53\u5206\u6790\u4e86\uff0c\u76f4\u63a5\u770b\u6e90\u7801\uff0c\u5e94\u8be5\u5f88\u597d\u7406\u89e3\u3002</p> <p>\u5176\u5b9e\u5b9e\u9a8c\u4e8c\u5728\u5185\u5b58\u5206\u914d\u548c\u91ca\u653e\u65b9\u9762\u6700\u4e3b\u8981\u7684\u4f5c\u7528\u662f\u5efa\u7acb\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5b9a\u4e49\u5982\u4e0b\uff1a <pre><code>struct pmm_manager {\nconst char *name;                                 // XXX_pmm_manager's name\nvoid (*init)(void);                               // initialize internal description&amp;management data structure\n// (free block list, number of free block) of XXX_pmm_manager \nvoid (*init_memmap)(struct Page *base, size_t n); // setup description&amp;management data structcure according to\n// the initial free physical memory space \nstruct Page *(*alloc_pages)(size_t n);            // allocate &gt;=n pages, depend on the allocation algorithm \nvoid (*free_pages)(struct Page *base, size_t n);  // free &gt;=n pages with \"base\" addr of Page descriptor structures(memlayout.h)\nsize_t (*nr_free_pages)(void);                    // return the number of free pages \nvoid (*check)(void);                              // check the correctness of XXX_pmm_manager \n};\n</code></pre> \u91cd\u70b9\u662f\u5b9e\u73b0init_memmap/ alloc_pages/free_pages\u8fd9\u4e09\u4e2a\u51fd\u6570\u3002</p>"},{"location":"lab2/paging/#_5","title":"\u5efa\u7acb\u865a\u62df\u9875\u548c\u7269\u7406\u9875\u5e27\u7684\u5730\u5740\u6620\u5c04\u5173\u7cfb","text":"<p>\u5efa\u7acb\u4e8c\u7ea7\u9875\u8868</p> <p>\u5728LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u5b9a\u4e49\u9875\u8868\u7684\u65b9\u5f0f\uff0c\u56e0\u6b64\u5185\u6838\u53ef\u4ee5\u81ea\u7531\u91c7\u53d6\u9875\u8868\u7684\u5b9a\u4e49\u65b9\u5f0f\u3002\u7531\u4e8e\u8be5\u7248\u672cuCore\u81eax86\u67b6\u6784\u79fb\u690d\u800c\u6765\uff0c\u56e0\u6b64\u6cbf\u7528\u4e86x86\u7684\u7c7b\u4f3c\u65b9\u5f0f\u91c7\u7528\u4e8c\u7ea7\u9875\u8868\u6765\u5efa\u7acb\u903b\u8f91\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u3002\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u5177\u6709\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668default_pmm_manager\uff0c\u652f\u6301\u52a8\u6001\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58\u9875\u7684\u529f\u80fd\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u5b83\u6765\u83b7\u5f97\u6240\u9700\u7684\u7a7a\u95f2\u7269\u7406\u9875\u3002\u5728\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u4e2d\uff0c\u9875\u76ee\u5f55\u8868\u53604KB\u7a7a\u95f4\uff0c\u53ef\u901a\u8fc7alloc_page\u51fd\u6570\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u4f5c\u4e3a\u9875\u76ee\u5f55\u8868\uff08Page Directory Table\uff0cPDT\uff09\u3002\u540c\u7406\uff0cucore\u4e5f\u901a\u8fc7\u8fd9\u79cd\u7c7b\u4f3c\u65b9\u5f0f\u83b7\u5f97\u4e00\u4e2a\u9875\u8868\uff08Page Table\uff0cPT\uff09\u6240\u9700\u76844KB\u7a7a\u95f4\u3002</p> <p>\u6574\u4e2a\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u6240\u5360\u7a7a\u95f4\u5927\u5c0f\u53d6\u51b3\u4e0e\u4e8c\u7ea7\u9875\u8868\u8981\u7ba1\u7406\u548c\u6620\u5c04\u7684\u7269\u7406\u9875\u6570\u3002\u5047\u5b9a\u5f53\u524d\u7269\u7406\u5185\u5b580~16MB\uff0c\u6bcf\u7269\u7406\u9875\uff08\u4e5f\u79f0Page Frame\uff09\u5927\u5c0f\u4e3a4KB\uff0c\u5219\u67094096\u4e2a\u7269\u7406\u9875\uff0c\u4e5f\u5c31\u610f\u5473\u8fd9\u67094\u4e2a\u9875\u76ee\u5f55\u9879\u548c4096\u4e2a\u9875\u8868\u9879\u9700\u8981\u8bbe\u7f6e\u3002\u4e00\u4e2a\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff0cPDE\uff09\u548c\u4e00\u4e2a\u9875\u8868\u9879\uff08Page Table Entry\uff0cPTE\uff09\u53604B\u3002\u5373\u4f7f\u662f4\u4e2a\u9875\u76ee\u5f55\u9879\u4e5f\u9700\u8981\u4e00\u4e2a\u5b8c\u6574\u7684\u9875\u76ee\u5f55\u8868\uff08\u53604KB\uff09\u3002\u800c4096\u4e2a\u9875\u8868\u9879\u9700\u898116KB\uff08\u53734096*4B\uff09\u7684\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f4\u4e2a\u7269\u7406\u9875\uff0c16KB\u7684\u7a7a\u95f4\u3002\u6240\u4ee5\u5bf916MB\u7269\u7406\u9875\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u768416MB\u865a\u62df\u9875\uff0c\u9700\u89815\u4e2a\u7269\u7406\u9875\uff0c\u537320KB\u7684\u7a7a\u95f4\u6765\u5f62\u6210\u4e8c\u7ea7\u9875\u8868\u3002</p> <p>\u5b8c\u6210\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u7684\u5730\u5740\u6620\u5c04\u53d8\u5316\u540e\uff0c\u4e3a\u628a0~KERNSIZE\uff08\u660e\u786eucore\u8bbe\u5b9a\u5b9e\u9645\u7269\u7406\u5185\u5b58\u4e0d\u80fd\u8d85\u8fc7KERNSIZE\u503c\uff0c\u5373512MB\uff0c131072\u4e2a\u7269\u7406\u9875\uff09\u7684\u7269\u7406\u5730\u5740\u4e00\u4e00\u6620\u5c04\u5230\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u7684\u5185\u5bb9\uff0c\u5176\u5927\u81f4\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u6307\u5411\u9875\u76ee\u5f55\u8868\u7684\u6307\u9488\u5df2\u5b58\u50a8\u5728boot_pgdir\u53d8\u91cf\u4e2d\u3002</p> </li> <li> <p>\u8c03\u7528boot_map_segment\u51fd\u6570\u8fdb\u4e00\u6b65\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\uff0c\u5177\u4f53\u5904\u7406\u8fc7\u7a0b\u4ee5\u9875\u4e3a\u5355\u4f4d\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5373</p> </li> </ol> <p><pre><code>linear addr = phy addr + 0xa0000000\n</code></pre> \u8bbe\u4e00\u4e2a32bit\u7ebf\u6027\u5730\u5740la\u6709\u4e00\u4e2a\u5bf9\u5e94\u768432bit\u7269\u7406\u5730\u5740pa\uff0c\u5982\u679c\u5728\u4ee5la\u7684\u9ad810\u4f4d\u4e3a\u7d22\u5f15\u503c\u7684\u9875\u76ee\u5f55\u9879\u4e2d\u7684\u5b58\u5728\u4f4d\uff08PTE_P\uff09\u4e3a0\uff0c\u8868\u793a\u7f3a\u5c11\u5bf9\u5e94\u7684\u9875\u8868\u7a7a\u95f4\uff0c\u5219\u53ef\u901a\u8fc7alloc_page\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u7ed9\u9875\u8868\uff0c\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740\u662f\u63094096\u5b57\u8282\u5bf9\u9f50\u7684\uff0c\u8fd9\u6837\u586b\u5199\u9875\u76ee\u5f55\u9879\u7684\u5185\u5bb9\u4e3a <pre><code>  \u9875\u76ee\u5f55\u9879\u5185\u5bb9 = (\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740 &amp; ~0x0FFF) | PTE_U | PTE_W | PTE_P\n</code></pre> \u8fdb\u4e00\u6b65\u5bf9\u4e8e\u9875\u8868\u4e2d\u4ee5\u7ebf\u6027\u5730\u5740la\u7684\u4e2d10\u4f4d\u4e3a\u7d22\u5f15\u503c\u5bf9\u5e94\u9875\u8868\u9879\u7684\u5185\u5bb9\u4e3a <pre><code>  \u9875\u8868\u9879\u5185\u5bb9 = (pa &amp; ~0x0FFF) | PTE_P | PTE_W\n</code></pre> \u5176\u4e2d\uff1a</p> <ul> <li>PTE_U\uff1a\u4f4d3\uff0c\u8868\u793a\u7528\u6237\u6001\u7684\u8f6f\u4ef6\u53ef\u4ee5\u8bfb\u53d6\u5bf9\u5e94\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9</li> <li>PTE_W\uff1a\u4f4d2\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9\u53ef\u5199</li> <li>PTE_P\uff1a\u4f4d1\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5b58\u5728</li> </ul> <p>ucore\u7684\u5185\u5b58\u7ba1\u7406\u7ecf\u5e38\u9700\u8981\u67e5\u627e\u9875\u8868\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u865a\u62df\u5730\u5740\uff0c\u627e\u51fa\u8fd9\u4e2a\u865a\u62df\u5730\u5740\u5728\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u7684\u9879\u3002\u901a\u8fc7\u66f4\u6539\u6b64\u9879\u7684\u503c\u53ef\u4ee5\u65b9\u4fbf\u5730\u5c06\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u53e6\u5916\u7684\u9875\u4e0a\u3002\u53ef\u5b8c\u6210\u6b64\u529f\u80fd\u7684\u8fd9\u4e2a\u51fd\u6570\u662fget_pte\u51fd\u6570\u3002\u5b83\u7684\u539f\u578b\u4e3a <pre><code>pte_t *get_pte(pde_t *pgdir, uintptr_t la, bool create)\n</code></pre> \u4e0b\u9762\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u53ef\u4ee5\u6bd4\u8f83\u597d\u5730\u770b\u51faget_pte\u5728\u5b9e\u73b0\u4e0a\u8ff0\u6d41\u7a0b\u4e2d\u7684\u4f4d\u7f6e\uff1a</p> <p></p> <p>\u56fe6 get_pte\u8c03\u7528\u5173\u7cfb\u56fe</p> <p>\u8fd9\u91cc\u6d89\u53ca\u5230\u4e09\u4e2a\u7c7b\u578bpte_t\u3001pde_t\u548cuintptr_t\u3002\u901a\u8fc7\u53c2\u89c1mm/mmlayout.h\u548clibs/types.h\uff0c\u53ef\u77e5\u5b83\u4eec\u5176\u5b9e\u90fd\u662funsigned int\u7c7b\u578b\u3002\u5728\u6b64\u505a\u533a\u5206\uff0c\u662f\u4e3a\u4e86\u5206\u6e05\u6982\u5ff5\u3002</p> <p>pde_t\u5168\u79f0\u4e3a page directory entry\uff0c\u4e5f\u5c31\u662f\u4e00\u7ea7\u9875\u8868\u7684\u8868\u9879\uff08\u6ce8\u610f\uff1apgdir\u5b9e\u9645\u4e0d\u662f\u8868\u9879\uff0c\u800c\u662f\u4e00\u7ea7\u9875\u8868\u672c\u8eab\u3002\u5b9e\u9645\u4e0a\u5e94\u8be5\u65b0\u5b9a\u4e49\u4e00\u4e2a\u7c7b\u578bpgd_t\u6765\u8868\u793a\u4e00\u7ea7\u9875\u8868\u672c\u8eab\uff09\u3002pte_t\u5168\u79f0\u4e3a page table entry\uff0c\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u8868\u9879\u3002uintptr_t\u8868\u793a\u4e3a\u7ebf\u6027\u5730\u5740\uff0c\u7531\u4e8e\u6bb5\u5f0f\u7ba1\u7406\u53ea\u505a\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5b83\u4e5f\u662f\u903b\u8f91\u5730\u5740\u3002</p> <p>pgdir\u7ed9\u51fa\u9875\u8868\u8d77\u59cb\u5730\u5740\u3002\u901a\u8fc7\u67e5\u627e\u8fd9\u4e2a\u9875\u8868\uff0c\u6211\u4eec\u9700\u8981\u7ed9\u51fa\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u9879\u7684\u5730\u5740\u3002\u867d\u7136\u76ee\u524d\u6211\u4eec\u53ea\u6709boot_pgdir\u4e00\u4e2a\u9875\u8868\uff0c\u4f46\u662f\u5f15\u5165\u8fdb\u7a0b\u7684\u6982\u5ff5\u4e4b\u540e\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u4f1a\u6709\u81ea\u5df1\u7684\u9875\u8868\u3002</p> <p>\u6709\u53ef\u80fd\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u4e8c\u7ea7\u9875\u8868\u4e0d\u5fc5\u8981\u4e00\u5f00\u59cb\u5c31\u5206\u914d\uff0c\u800c\u662f\u7b49\u5230\u9700\u8981\u7684\u65f6\u5019\u518d\u6dfb\u52a0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679c\u5728\u67e5\u627e\u4e8c\u7ea7\u9875\u8868\u9879\u65f6\uff0c\u53d1\u73b0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u4e0d\u5b58\u5728\uff0c\u5219\u9700\u8981\u6839\u636ecreate\u53c2\u6570\u7684\u503c\u6765\u5904\u7406\u662f\u5426\u521b\u5efa\u65b0\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679ccreate\u53c2\u6570\u4e3a0\uff0c\u5219get_pte\u8fd4\u56deNULL\uff1b\u5982\u679ccreate\u53c2\u6570\u4e0d\u4e3a0\uff0c\u5219get_pte\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u7269\u7406\u9875\uff08\u901a\u8fc7alloc_page\u6765\u5b9e\u73b0\uff0c\u53ef\u5728mm/pmm.h\u4e2d\u627e\u5230\u5b83\u7684\u5b9a\u4e49\uff09\uff0c\u518d\u5728\u4e00\u7ea7\u9875\u8868\u4e2d\u6dfb\u52a0\u9875\u76ee\u5f55\u9879\u6307\u5411\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u65b0\u7269\u7406\u9875\u3002\u6ce8\u610f\uff0c\u65b0\u7533\u8bf7\u7684\u9875\u5fc5\u987b\u5168\u90e8\u8bbe\u5b9a\u4e3a\u96f6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u9875\u6240\u4ee3\u8868\u7684\u865a\u62df\u5730\u5740\u90fd\u6ca1\u6709\u88ab\u6620\u5c04\u3002</p> <p>\u5f53\u5efa\u7acb\u4ece\u4e00\u7ea7\u9875\u8868\u5230\u4e8c\u7ea7\u9875\u8868\u7684\u6620\u5c04\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u8bbe\u7f6e\u63a7\u5236\u4f4d\u3002\u8fd9\u91cc\u5e94\u8be5\u8bbe\u7f6e\u540c\u65f6\u8bbe\u7f6e\u4e0aPTE_U\u3001PTE_W\u548cPTE_P\uff08\u5b9a\u4e49\u5728mm/mmu.h\uff09\u3002\u5982\u679c\u539f\u6765\u5c31\u6709\u4e8c\u7ea7\u9875\u8868\uff0c\u6216\u8005\u65b0\u5efa\u7acb\u4e86\u9875\u8868\uff0c\u5219\u53ea\u9700\u8fd4\u56de\u5bf9\u5e94\u9879\u7684\u5730\u5740\u5373\u53ef\u3002</p> <p>\u865a\u62df\u5730\u5740\u53ea\u6709\u6620\u5c04\u4e0a\u4e86\u7269\u7406\u9875\u624d\u53ef\u4ee5\u6b63\u5e38\u7684\u8bfb\u5199\u3002\u5728\u5b8c\u6210\u6620\u5c04\u7269\u7406\u9875\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9664\u4e86\u8981\u50cf\u4e0a\u9762\u90a3\u6837\u5728\u9875\u8868\u7684\u5bf9\u5e94\u8868\u9879\u4e0a\u586b\u4e0a\u76f8\u5e94\u7684\u7269\u7406\u5730\u5740\u5916\uff0c\u8fd8\u8981\u8bbe\u7f6e\u6b63\u786e\u7684\u63a7\u5236\u4f4d\u3002</p> <p>\u53ea\u6709\u5f53\u4e00\u7ea7\u4e8c\u7ea7\u9875\u8868\u7684\u9879\u90fd\u8bbe\u7f6e\u4e86\u7528\u6237\u5199\u6743\u9650\u540e\uff0c\u7528\u6237\u624d\u80fd\u5bf9\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u8fdb\u884c\u8bfb\u5199\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u7ea7\u9875\u8868\u5148\u7ed9\u7528\u6237\u5199\u6743\u9650\uff0c\u518d\u5728\u4e8c\u7ea7\u9875\u8868\u4e0a\u9762\u6839\u636e\u9700\u8981\u9650\u5236\u7528\u6237\u7684\u6743\u9650\uff0c\u5bf9\u7269\u7406\u9875\u8fdb\u884c\u4fdd\u62a4\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u53ef\u80fd\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684\u865a\u62df\u5730\u5740\u4e0a\u53bb\uff08\u8b6c\u5982\u4e00\u5757\u5185\u5b58\u5728\u4e0d\u540c\u8fdb\u7a0b\u95f4\u5171\u4eab\uff09\uff0c\u5f53\u8fd9\u4e2a\u9875\u9700\u8981\u5728\u4e00\u4e2a\u5730\u5740\u4e0a\u89e3\u9664\u6620\u5c04\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u9875\u56de\u6536\uff0c\u800c\u662f\u8981\u5148\u770b\u770b\u5b83\u8fd8\u6709\u6ca1\u6709\u6620\u5c04\u5230\u522b\u7684\u865a\u62df\u5730\u5740\u4e0a\u3002\u8fd9\u662f\u901a\u8fc7\u67e5\u627e\u7ba1\u7406\u8be5\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfref\uff08\u7528\u6765\u8868\u793a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u7684\u4e2a\u6570\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u5982\u679cref\u4e3a0\u4e86\uff0c\u8868\u793a\u6ca1\u6709\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u4e86\uff0c\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e2a\u7269\u7406\u9875\u7ed9\u56de\u6536\u4e86\uff0c\u4ece\u800c\u8fd9\u4e2a\u7269\u7406\u9875\u662ffree\u7684\u4e86\uff0c\u53ef\u4ee5\u518d\u88ab\u5206\u914d\u3002page_insert\u51fd\u6570\u5c06\u7269\u7406\u9875\u6620\u5c04\u5728\u4e86\u9875\u8868\u4e0a\u3002\u53ef\u53c2\u770bpage_insert\u51fd\u6570\u7684\u5b9e\u73b0\u6765\u4e86\u89e3ucore\u5185\u6838\u662f\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u53d8\u91cf\u7684\u3002\u5f53\u4e0d\u9700\u8981\u518d\u8bbf\u95ee\u8fd9\u5757\u865a\u62df\u5730\u5740\u65f6\uff0c\u53ef\u4ee5\u628a\u8fd9\u5757\u7269\u7406\u9875\u56de\u6536\u5e76\u5728\u5c06\u6765\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002\u53d6\u6d88\u6620\u5c04\u7531page_remove\u6765\u505a\uff0c\u8fd9\u5176\u5b9e\u662fpage_insert\u7684\u9006\u64cd\u4f5c\u3002</p> <p>\u5efa\u7acb\u597d\u4e00\u4e00\u6620\u5c04\u7684\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u540e\uff0c\u7531\u4e8e\u5206\u9875\u673a\u5236\u5728\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u5df2\u7ecf\u5f00\u542f\uff0c\u5206\u9875\u673a\u5236\u5230\u6b64\u521d\u59cb\u5316\u5b8c\u6bd5\u3002\u5f53\u6267\u884c\u5b8c\u6bd5gdt_init\u51fd\u6570\u540e\uff0c\u65b0\u7684\u6bb5\u9875\u5f0f\u6620\u5c04\u5df2\u7ecf\u5efa\u7acb\u597d\u4e86\u3002</p> <p>\u5728pmm_init\u51fd\u6570\u5efa\u7acb\u5b8c\u5b9e\u73b0\u7269\u7406\u5185\u5b58\u4e00\u4e00\u6620\u5c04\u548c\u9875\u76ee\u5f55\u8868\u81ea\u6620\u5c04\u7684\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u540e\uff0cucore\u770b\u5230\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <pre><code>  Virtual memory map:                                          Permissions\n                                                                              kernel/user\n\n       4G ------------------&gt; +---------------------------------+\n                              |                                 |\n                              |         Mapped(2G)              |\n                              |                                 |\n       KERNTOP  ------------&gt; +---------------------------------+ 0xBFFF_FFFF\n                              |                                 | \n                              |  Unmapped cached(DMW0 512M)     |\n                              |                                 | \n       KERNBASE-------------&gt; +---------------------------------+ 0xa0000000\n                              |                                 |\n                              |    Unmapped uncached(DMW1 512M) | RW/-- KMEMSIZE\n                              |                                 |\n                              +---------------------------------+ 0x80000000\n                              |                                 |\n                              |    User Mapped                  |\n                              |                                 |\n                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 0x00000000\n</code></pre>"},{"location":"lab2/paging/#_6","title":"\u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u5b9e\u73b0","text":"<p>\u5982\u679c\u8981\u5728ucore\u4e2d\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff0c\u5219\u9700\u8981\u8003\u8651\u7684\u4e8b\u60c5\u6bd4\u8f83\u591a\uff0c\u76f8\u5bf9\u8bfe\u672c\u4e0a\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u63cf\u8ff0\u8981\u590d\u6742\u4e0d\u5c11\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0b\u5982\u679c\u8981\u5b9e\u73b0\u4e00\u4e2aFirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5927\u81f4\u6d41\u7a0b\u3002</p> <p>lab2\u7684\u7b2c\u4e00\u90e8\u5206\u662f\u5b8c\u6210first_fit\u7684\u5206\u914d\u7b97\u6cd5\u3002\u539f\u7406FirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u4e0a\u5f88\u7b80\u5355\uff0c\u4f46\u8981\u5728ucore\u4e2d\u5b9e\u73b0\uff0c\u9700\u8981\u5145\u5206\u4e86\u89e3\u548c\u5229\u7528ucore\u5df2\u6709\u7684\u6570\u636e\u7ed3\u6784\u548c\u76f8\u5173\u64cd\u4f5c\u3001\u5173\u952e\u7684\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u7b49\u3002</p> <p>\u5173\u952e\u6570\u636e\u7ed3\u6784\u548c\u53d8\u91cf</p> <p>first_fit\u5206\u914d\u7b97\u6cd5\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u67e5\u627e\u6709\u5e8f\uff08\u5730\u5740\u6309\u4ece\u5c0f\u5230\u5927\u6392\u5217\uff09\u7a7a\u95f2\u5757\uff08\u4ee5\u9875\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u8fde\u7eed\u5730\u5740\u7a7a\u95f4\uff09\u7684\u6570\u636e\u7ed3\u6784\uff0c\u800c\u53cc\u5411\u94fe\u8868\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u9009\u62e9\u3002</p> <p>kernel/include/list.h\u5b9a\u4e49\u4e86\u53ef\u6302\u63a5\u4efb\u610f\u5143\u7d20\u7684\u901a\u7528\u53cc\u5411\u94fe\u8868\u7ed3\u6784\u548c\u5bf9\u5e94\u7684\u64cd\u4f5c\uff0c\u6240\u4ee5\u9700\u8981\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e2a\u6587\u4ef6\u63d0\u4f9b\u7684\u5404\u79cd\u51fd\u6570\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u5bf9\u53cc\u5411\u94fe\u8868\u7684\u521d\u59cb\u5316/\u63d2\u5165/\u5220\u9664\u7b49\u3002</p> <p>kern/mm/memlayout.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a free_area_t \u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u6210\u5458\u7ed3\u6784 <pre><code>  list_entry_t free_list;         // the list header   \u7a7a\u95f2\u5757\u53cc\u5411\u94fe\u8868\u7684\u5934\nunsigned int nr_free;           // # of free pages in this free list  \u7a7a\u95f2\u5757\u7684\u603b\u6570\uff08\u4ee5\u9875\u4e3a\u5355\u4f4d\uff09\n</code></pre> \u663e\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u5bf9\u7a7a\u95f2\u5757\u7684\u7ba1\u7406\u3002\u800cbuddy_pmm.c\u4e2d\u5b9a\u4e49\u7684free_area\u53d8\u91cf\u5c31\u662f\u5e72\u8fd9\u4e2a\u4e8b\u60c5\u7684\u3002</p> <p>kern/mm/pmm.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u901a\u7528\u7684\u5206\u914d\u7b97\u6cd5\u7684\u51fd\u6570\u5217\u8868\uff0c\u7528pmm_manager\u8868\u793a\u3002\u5176\u4e2dinit\u51fd\u6570\u5c31\u662f\u7528\u6765\u521d\u59cb\u5316free_area\u53d8\u91cf\u7684,first_fit\u5206\u914d\u7b97\u6cd5\u53ef\u76f4\u63a5\u91cd\u7528buddy_init\u51fd\u6570\u7684\u5b9e\u73b0\u3002init_memmap\u51fd\u6570\u9700\u8981\u6839\u636e\u73b0\u6709\u7684\u5185\u5b58\u60c5\u51b5\u6784\u5efa\u7a7a\u95f2\u5757\u5217\u8868\u7684\u521d\u59cb\u72b6\u6001\u3002\u4f55\u65f6\u5e94\u8be5\u6267\u884c\u8fd9\u4e2a\u51fd\u6570\u5462\uff1f</p> <p>\u901a\u8fc7\u5206\u6790\u4ee3\u7801\uff0c\u53ef\u4ee5\u77e5\u9053\uff1a <pre><code>kern_init --&gt; pmm_init--&gt;page_init--&gt;init_memmap--&gt; pmm_manager-&gt;init_memmap\n</code></pre> \u6240\u4ee5\uff0cdefault_init_memmap\u9700\u8981\u6839\u636epage_init\u51fd\u6570\u4e2d\u4f20\u9012\u8fc7\u6765\u7684\u53c2\u6570\uff08\u67d0\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u7a7a\u95f2\u5757\u7684\u8d77\u59cb\u9875\uff0c\u9875\u4e2a\u6570\uff09\u6765\u5efa\u7acb\u4e00\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u53cc\u5411\u94fe\u8868\u3002\u8fd9\u91cc\u6709\u4e00\u4e2a\u5047\u5b9apage_init\u51fd\u6570\u662f\u6309\u5730\u5740\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u4f20\u6765\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u3002\u94fe\u8868\u5934\u662ffree_area.free_list\uff0c\u94fe\u8868\u9879\u662fPage\u6570\u636e\u7ed3\u6784\u7684base-&gt;page_link\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u4f9d\u9760Page\u6570\u636e\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cfpage_link\u5f62\u6210\u4e86\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5217\u8868\u3002</p> <p>\u8bbe\u8ba1\u5b9e\u73b0</p> <p>default_init_memmap\u51fd\u6570\u5c06\u6839\u636e\u6bcf\u4e2a\u7269\u7406\u9875\u5e27\u7684\u60c5\u51b5\u6765\u5efa\u7acb\u7a7a\u95f2\u9875\u94fe\u8868\uff0c\u4e14\u7a7a\u95f2\u9875\u5757\u5e94\u8be5\u662f\u6839\u636e\u5730\u5740\u9ad8\u4f4e\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u94fe\u8868\u3002\u6839\u636e\u4e0a\u8ff0\u53d8\u91cf\u7684\u5b9a\u4e49\uff0cdefault_init_memmap\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <p><pre><code>default_init_memmap(struct Page *base, size_t n) {\nassert(n &gt; 0);\nstruct Page *p = base;\nfor (; p != base + n; p ++) {\nassert(PageReserved(p));\np-&gt;flags = p-&gt;property = 0;\nset_page_ref(p, 0);\n}\nbase-&gt;property = n;\nSetPageProperty(base);\nnr_free += n;\nlist_add_before(&amp;free_list, &amp;(base-&gt;page_link));\n}\n</code></pre> \u5982\u679c\u8981\u5206\u914d\u4e00\u4e2a\u9875\uff0c\u90a3\u8981\u8003\u8651\u54ea\u4e9b\u5462\uff1f\u8fd9\u91cc\u5c31\u9700\u8981\u8003\u8651\u5b9e\u73b0default_alloc_pages\u51fd\u6570\uff0c\u6ce8\u610f\u53c2\u6570n\u8868\u793a\u8981\u5206\u914dn\u4e2a\u9875\u3002\u53e6\u5916\uff0c\u9700\u8981\u6ce8\u610f\u5b9e\u73b0\u65f6\u5c3d\u91cf\u591a\u8003\u8651\u4e00\u4e9b\u8fb9\u754c\u60c5\u51b5\uff0c\u8fd9\u6837\u786e\u4fdd\u8f6f\u4ef6\u7684\u9c81\u68d2\u6027\u3002\u6bd4\u5982 <pre><code>if (n &gt; nr_free) {\nreturn NULL;\n}\n</code></pre> \u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u5206\u914d\u4e0d\u4f1a\u8d85\u51fa\u8303\u56f4\u3002\u4e5f\u53ef\u52a0\u4e00\u4e9bassert\u51fd\u6570\uff0c\u5728\u6709\u9519\u8bef\u51fa\u73b0\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u53d1\u73b0\u3002\u6bd4\u5982 n\u5e94\u8be5\u5927\u4e8e0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u52a0\u4e0a <pre><code>assert(n &gt; 0);\n</code></pre> \u8fd9\u6837\u5728n&lt;=0\u7684\u60c5\u51b5\u4e0b\uff0cucore\u4f1a\u8fc5\u901f\u62a5\u9519\u3002firstfit\u9700\u8981\u4ece\u7a7a\u95f2\u94fe\u8868\u5934\u5f00\u59cb\u67e5\u627e\u6700\u5c0f\u7684\u5730\u5740\uff0c\u901a\u8fc7list_next\u627e\u5230\u4e0b\u4e00\u4e2a\u7a7a\u95f2\u5757\u5143\u7d20\uff0c\u901a\u8fc7le2page\u5b8f\u53ef\u4ee5\u7531\u94fe\u8868\u5143\u7d20\u83b7\u5f97\u5bf9\u5e94\u7684Page\u6307\u9488p\u3002\u901a\u8fc7p-&gt;property\u53ef\u4ee5\u4e86\u89e3\u6b64\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u3002\u5982\u679c&gt;=n\uff0c\u8fd9\u5c31\u627e\u5230\u4e86\uff01\u5982\u679c&lt;n\uff0c\u5219list_next\uff0c\u7ee7\u7eed\u67e5\u627e\u3002\u76f4\u5230list_next== &amp;free_list\uff0c\u8fd9\u8868\u793a\u627e\u5b8c\u4e86\u4e00\u904d\u4e86\u3002\u627e\u5230\u540e\uff0c\u5c31\u8981\u4ece\u65b0\u7ec4\u7ec7\u7a7a\u95f2\u5757\uff0c\u7136\u540e\u628a\u627e\u5230\u7684page\u8fd4\u56de\u3002\u6240\u4ee5default_alloc_pages\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <p><pre><code>default_alloc_pages(size_t n) {\nassert(n &gt; 0);\nif (n &gt; nr_free) {\nreturn NULL;\n}\nstruct Page *page = NULL;\nlist_entry_t *le = &amp;free_list;\n// TODO: optimize (next-fit)\nwhile ((le = list_next(le)) != &amp;free_list) {                                    struct Page *p = le2page(le, page_link);\nif (p-&gt;property &gt;= n) {\npage = p;\nbreak;\n}\n}\nif (page != NULL) {\nif (page-&gt;property &gt; n) {\nstruct Page *p = page + n;\np-&gt;property = page-&gt;property - n;\nSetPageProperty(p);\nlist_add_after(&amp;(page-&gt;page_link), &amp;(p-&gt;page_link));\n}\nlist_del(&amp;(page-&gt;page_link));\nnr_free -= n;\nClearPageProperty(page);\n}\nreturn page;\n}\n</code></pre> default_free_pages\u51fd\u6570\u7684\u5b9e\u73b0\u5176\u5b9e\u662fdefault_alloc_pages\u7684\u9006\u8fc7\u7a0b\uff0c\u4e0d\u8fc7\u9700\u8981\u8003\u8651\u7a7a\u95f2\u5757\u7684\u5408\u5e76\u95ee\u9898\u3002\u8fd9\u91cc\u5c31\u4e0d\u518d\u7ec6\u8bb2\u4e86\u3002\u6ce8\u610f\uff0c\u4e0a\u8bc9\u4ee3\u7801\u53ea\u662f\u53c2\u8003\u8bbe\u8ba1\uff0c\u4e0d\u662f\u5b8c\u6574\u7684\u6b63\u786e\u8bbe\u8ba1\u3002\u66f4\u8be6\u7ec6\u7684\u8bf4\u660e\u4f4d\u4e8elab2/kernel/mm/default_pmm.c\u7684\u6ce8\u91ca\u4e2d\u3002\u5e0c\u671b\u540c\u5b66\u80fd\u591f\u987a\u5229\u5b8c\u6210\u672c\u5b9e\u9a8c\u7684\u7b2c\u4e00\u90e8\u5206\u3002</p>"},{"location":"lab2/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab2/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab2\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e863\u4e2a\u57fa\u672c\u7ec3\u4e60\u548c2\u4e2a\u6269\u5c55\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002 \u6ce8\u610f\u6709\u201cLAB2\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB2\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca</p> <p>\u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab2/task/#1-first-fit","title":"\u7ec3\u4e601\uff1a\u5b9e\u73b0 first-fit \u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u5728\u5b9e\u73b0first fit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u56de\u6536\u51fd\u6570\u65f6\uff0c\u8981\u8003\u8651\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u5757\u4e4b\u95f4\u7684\u5408\u5e76\u64cd\u4f5c\u3002\u63d0\u793a:\u5728\u5efa\u7acb\u7a7a\u95f2\u9875\u5757\u94fe\u8868\u65f6\uff0c\u9700\u8981\u6309\u7167\u7a7a\u95f2\u9875\u5757\u8d77\u59cb\u5730\u5740\u6765\u6392\u5e8f\uff0c\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u7684\u94fe\u8868\u3002\u53ef\u80fd\u4f1a\u4fee\u6539default_pmm.c\u4e2d\u7684default_init\uff0cdefault_init_memmap\uff0cdefault_alloc_pages\uff0cdefault_free_pages\u7b49\u76f8\u5173\u51fd\u6570\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3default_pmm.c\u4e2d\u7684\u6ce8\u91ca\u3002</p> <p>\u6ce8\u610f\uff0c\u76ee\u524d\u5b9e\u9a8c\u63d0\u4f9b\u7684\u4ee3\u7801\u5df2\u7ecf\u53ef\u4ee5\u8fd0\u884c\uff0c\u4f46\u5e0c\u671b\u8bfb\u8005\u5728\u7406\u89e3\u7684\u57fa\u7840\u4e0a\u80fd\u81ea\u5df1\u91cd\u65b0\u5b9e\u73b0\u6709\u5173\u51fd\u6570\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u4f60\u7684first fit\u7b97\u6cd5\u662f\u5426\u6709\u8fdb\u4e00\u6b65\u7684\u6539\u8fdb\u7a7a\u95f4</p>"},{"location":"lab2/task/#2","title":"\u7ec3\u4e602\uff1a\u5b9e\u73b0\u5bfb\u627e\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u548c\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff0c\u53ef\u5efa\u7acb\u865a\u62df\u5185\u5b58\u5730\u5740\u548c\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u5bf9\u5e94\u5173\u7cfb\u3002\u5176\u4e2d\u7684get_pte\u51fd\u6570\u662f\u8bbe\u7f6e\u9875\u8868\u9879\u73af\u8282\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6b65\u9aa4\u3002\u6b64\u51fd\u6570\u627e\u5230\u4e00\u4e2a\u865a\u5730\u5740\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u5185\u6838\u865a\u5730\u5740\uff0c\u5982\u679c\u6b64\u4e8c\u7ea7\u9875\u8868\u9879\u4e0d\u5b58\u5728\uff0c\u5219\u5206\u914d\u4e00\u4e2a\u5305\u542b\u6b64\u9879\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u672c\u7ec3\u4e60\u9700\u8981\u8865\u5168get_pte\u51fd\u6570\uff08kern/mm/pmm.c\u4e2d\uff09\uff0c\u5b9e\u73b0\u5176\u529f\u80fd\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3get_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p> \u56fe1 get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u8bf7\u63cf\u8ff0\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff09\u548c\u9875\u8868\u9879\uff08Page Table Entry\uff09\u4e2d\u6bcf\u4e2a\u7ec4\u6210\u90e8\u5206\u7684\u542b\u4e49\u4ee5\u53ca\u5bf9ucore\u800c\u8a00\u7684\u6f5c\u5728\u7528\u5904\u3002  - \u5982\u679cucore\u6267\u884c\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5185\u5b58\uff0c\u51fa\u73b0\u4e86\u9875\u8bbf\u95ee\u5f02\u5e38\uff0c\u8bf7\u95ee\u786c\u4ef6\u8981\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1f</p>"},{"location":"lab2/task/#3","title":"\u7ec3\u4e603\uff1a\u91ca\u653e\u67d0\u865a\u5730\u5740\u6240\u5728\u7684\u9875\u5e76\u53d6\u6d88\u5bf9\u5e94\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u6620\u5c04\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u5f53\u91ca\u653e\u4e00\u4e2a\u5305\u542b\u67d0\u865a\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u65f6\uff0c\u9700\u8981\u8ba9\u5bf9\u5e94\u6b64\u7269\u7406\u5185\u5b58\u9875\u7684\u7ba1\u7406\u6570\u636e\u7ed3\u6784Page\u505a\u76f8\u5173\u7684\u6e05\u9664\u5904\u7406\uff0c\u4f7f\u5f97\u6b64\u7269\u7406\u5185\u5b58\u9875\u6210\u4e3a\u7a7a\u95f2\uff1b\u53e6\u5916\u8fd8\u9700\u628a\u8868\u793a\u865a\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u5bf9\u5e94\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u6e05\u9664\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3page_remove_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002\u4e3a\u6b64\uff0c\u9700\u8981\u8865\u5168\u5728kern/mm/pmm.c\u4e2d\u7684page_remove_pte\u51fd\u6570\u3002page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u56fe2 page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u6570\u636e\u7ed3\u6784Page\u7684\u5168\u5c40\u53d8\u91cf\uff08\u5176\u5b9e\u662f\u4e00\u4e2a\u6570\u7ec4\uff09\u7684\u6bcf\u4e00\u9879\u4e0e\u9875\u8868\u4e2d\u7684\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u6709\u65e0\u5bf9\u5e94\u5173\u7cfb\uff1f\u5982\u679c\u6709\uff0c\u5176\u5bf9\u5e94\u5173\u7cfb\u662f\u5565\uff1f  - \u5982\u679c\u5e0c\u671b\u865a\u62df\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u76f8\u7b49\uff0c\u5219\u9700\u8981\u5982\u4f55\u4fee\u6539lab2\uff0c\u5b8c\u6210\u6b64\u4e8b\uff1f \u9f13\u52b1\u901a\u8fc7\u7f16\u7a0b\u6765\u5177\u4f53\u5b8c\u6210\u8fd9\u4e2a\u95ee\u9898 </p>"},{"location":"lab2/task/#challengebuddy-system","title":"\u6269\u5c55\u7ec3\u4e60Challenge\uff1abuddy system\uff08\u4f19\u4f34\u7cfb\u7edf\uff09\u5206\u914d\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>Buddy System\u7b97\u6cd5\u628a\u7cfb\u7edf\u4e2d\u7684\u53ef\u7528\u5b58\u50a8\u7a7a\u95f4\u5212\u5206\u4e3a\u5b58\u50a8\u5757(Block)\u6765\u8fdb\u884c\u7ba1\u7406, \u6bcf\u4e2a\u5b58\u50a8\u5757\u7684\u5927\u5c0f\u5fc5\u987b\u662f2\u7684n\u6b21\u5e42(Pow(2, n)), \u53731, 2, 4, 8, 16, 32, 64, 128...</p> <ul> <li>\u53c2\u8003\u4f19\u4f34\u5206\u914d\u5668\u7684\u4e00\u4e2a\u6781\u7b80\u5b9e\u73b0\uff0c \u5728ucore\u4e2d\u5b9e\u73b0buddy system\u5206\u914d\u7b97\u6cd5\uff0c\u8981\u6c42\u6709\u6bd4\u8f83\u5145\u5206\u7684\u6d4b\u8bd5\u7528\u4f8b\u8bf4\u660e\u5b9e\u73b0\u7684\u6b63\u786e\u6027\uff0c\u9700\u8981\u6709\u8bbe\u8ba1\u6587\u6863\u3002</li> </ul>"},{"location":"lab2/task/#challengeslub","title":"\u6269\u5c55\u7ec3\u4e60Challenge\uff1a\u4efb\u610f\u5927\u5c0f\u7684\u5185\u5b58\u5355\u5143slub\u5206\u914d\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>slub\u7b97\u6cd5\uff0c\u5b9e\u73b0\u4e24\u5c42\u67b6\u6784\u7684\u9ad8\u6548\u5185\u5b58\u5355\u5143\u5206\u914d\uff0c\u7b2c\u4e00\u5c42\u662f\u57fa\u4e8e\u9875\u5927\u5c0f\u7684\u5185\u5b58\u5206\u914d\uff0c\u7b2c\u4e8c\u5c42\u662f\u5728\u7b2c\u4e00\u5c42\u57fa\u7840\u4e0a\u5b9e\u73b0\u57fa\u4e8e\u4efb\u610f\u5927\u5c0f\u7684\u5185\u5b58\u5206\u914d\u3002\u53ef\u7b80\u5316\u5b9e\u73b0\uff0c\u80fd\u591f\u4f53\u73b0\u5176\u4e3b\u4f53\u601d\u60f3\u5373\u53ef\u3002</p> <ul> <li>\u53c2\u8003linux\u7684slub\u5206\u914d\u7b97\u6cd5/\uff0c\u5728ucore\u4e2d\u5b9e\u73b0slub\u5206\u914d\u7b97\u6cd5\u3002\u8981\u6c42\u6709\u6bd4\u8f83\u5145\u5206\u7684\u6d4b\u8bd5\u7528\u4f8b\u8bf4\u660e\u5b9e\u73b0\u7684\u6b63\u786e\u6027\uff0c\u9700\u8981\u6709\u8bbe\u8ba1\u6587\u6863\u3002</li> </ul> <p>Challenges\u662f\u9009\u505a\uff0c\u505a\u4e00\u4e2a\u5c31\u5f88\u597d\u4e86\u3002\u5b8c\u6210Challenge\u7684\u540c\u5b66\u53ef\u5355\u72ec\u63d0\u4ea4Challenge\u3002\u5b8c\u6210\u5f97\u597d\u7684\u540c\u5b66\u53ef\u83b7\u5f97\u6700\u7ec8\u8003\u8bd5\u6210\u7ee9\u7684\u52a0\u5206\u3002</p>"},{"location":"lab3/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab3/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB3    := -DLAB3_EX1 -DLAB3_EX2(\u7b2c8\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\n# LAB4  := -DLAB4_EX1 -DLAB4_EX2\n# LAB5  := -DLAB5_EX1 -DLAB5_EX2\n# LAB6  := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n((THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0020000 (phys)\nedata 0xA0153A20 (phys)\nend   0xA0156D00 (phys)\nKernel executable memory footprint: 1244KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0197000\nfree pages: 00001E69\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nLAB3 Check Pass!\n</code></pre></p>"},{"location":"lab3/lab3/","title":"\u5b9e\u9a8c\u4e09\uff1a\u865a\u62df\u5185\u5b58\u7ba1\u7406","text":"<p>\u505a\u5b8c\u5b9e\u9a8c\u4e8c\u540e\uff0c\u5927\u5bb6\u53ef\u4ee5\u4e86\u89e3\u5e76\u638c\u63e1\u7269\u7406\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u8fde\u7eed\u7a7a\u95f4\u5206\u914d\u7b97\u6cd5\u7684\u5177\u4f53\u5b9e\u73b0\u4ee5\u53ca\u5982\u4f55\u5efa\u7acb\u4e8c\u7ea7\u9875\u8868\u3002\u672c\u6b21\u5b9e\u9a8c\u662f\u5728\u5b9e\u9a8c\u4e8c\u7684\u57fa\u7840\u4e0a\uff0c\u501f\u52a9\u4e8e\u9875\u8868\u673a\u5236\u548c\u5b9e\u9a8c\u4e00\u4e2d\u6d89\u53ca\u7684\u4e2d\u65ad\u5f02\u5e38\u5904\u7406\u673a\u5236\uff0c\u5b8c\u6210TLB Refill\u5f02\u5e38\u5904\u7406\u548cPage Fault\u5904\u7406\u7684\u5b9e\u73b0\u3002</p>"},{"location":"lab3/lab3/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4e86\u89e3TLB\u7684\u521d\u59cb\u5316</li> <li>\u4e86\u89e3LoongArch32\u67b6\u6784\u4e0a\u7684\u8f6f\u4ef6\u91cd\u586bTLB\u7684\u5b9e\u73b0</li> <li>\u4e86\u89e3\u865a\u62df\u5185\u5b58\u7684Page Fault\u5f02\u5e38\u5904\u7406\u5b9e\u73b0</li> </ul>"},{"location":"lab3/lab3/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u662f\u5728\u5b9e\u9a8c\u4e8c\u7684\u57fa\u7840\u4e0a\uff0c\u501f\u52a9\u4e8eTLB\u673a\u5236\u548c\u5b9e\u9a8c\u4e00\u4e2d\u6d89\u53ca\u7684\u5f02\u5e38\u5904\u7406\u673a\u5236\uff0c\u5b8c\u6210TLB\u76f8\u5173\u7684\u5f02\u5e38\u5904\u7406\u5b9e\u73b0\u3002</p>"},{"location":"lab3/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab3/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab3\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB3\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB3\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab3/task/#1tlb","title":"\u7ec3\u4e601\uff1a\u5b8c\u6210TLB\u7684\u91cd\u586b\u4ee3\u7801\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u8bf7\u8bfb\u8005\u9605\u8bfbLoongArch32\u6587\u6863\u4e2d\u7684\u5b58\u50a8\u7ba1\u7406\u548c\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\u6709\u5173\u90e8\u5206\uff0c\u5b66\u4e60LoongArch32\u67b6\u6784\u7684\u5185\u5b58\u7ba1\u7406\u673a\u5236\uff0c\u5305\u62ec\u8f6f\u4ef6\u586b\u5145TLB\uff0cTLB\u9879\u7684TLBELO\u548cTLBEHI\u5404\u4e2abit\u7684\u542b\u4e49\uff0c\u7136\u540e\u5b8c\u6210\u4f4d\u4e8e<code>kern/mm/la32_tlb.c</code>\u4e2d\u7684\u4ee3\u7801\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801\u5305\u62ec2\u4e2a\u51fd\u6570\uff1a</p> <p><code>pte2tlblow</code>\u662f\u4ece\u6839\u636euCore\u7684PTE\u83b7\u5f97\u76f8\u5e94\u7684\u9875\u8868\u6743\u9650\uff0c\u4ee5\u53ca\u5b83\u7684\u7269\u7406\u5730\u5740\uff0c\u7136\u540e\u586b\u5230TLBELO\u4e2d\u3002</p> <p><code>tlb_refill</code> \u8981\u5b8c\u6210LoongArch32\u865a\u53cc\u9875\u8868\u7684\u9002\u914d\uff08\u5373\u865a\u62df\u5730\u5740\u7b2c13\u4f4d\u5206\u522b\u4e3a0\u548c1\u7684\u76f8\u90bb\u4e24\u4e2a\u9875\u9762\u653e\u5728\u540c\u4e00\u4e2a\u9875\u8868\u9879\u4e2d\uff09\uff0c\u5e76\u8c03\u7528<code>pte2tlblow</code>\u5f97\u5230TLBELO\u6240\u8981\u586b\u5199\u7684\u5185\u5bb9\uff0c\u4ee5\u53ca\u6839\u636e\u865a\u62df\u5730\u5740\u5f97\u5230TLBEHI\u6240\u8981\u586b\u5199\u7684\u5185\u5bb9\uff0c\u6700\u540e\u8c03\u7528<code>tlb_replace_random</code>\u5b8c\u6210TLB\u91cd\u586b\u3002</p>"},{"location":"lab3/task/#2","title":"\u7ec3\u4e602\uff1a\u7ed9\u672a\u88ab\u6620\u5c04\u7684\u5730\u5740\u6620\u5c04\u4e0a\u7269\u7406\u9875\uff08\u9700\u8981\u7f16\u7a0b\uff09","text":"<p>\u5b8c\u6210do_pgfault\uff08mm/vmm.c\uff09\u51fd\u6570\uff0c\u7ed9\u672a\u88ab\u6620\u5c04\u7684\u5730\u5740\u6620\u5c04\u4e0a\u7269\u7406\u9875\u3002\u8bbe\u7f6e\u8bbf\u95ee\u6743\u9650\u7684\u65f6\u5019\u9700\u8981\u53c2\u8003\u9875\u9762\u6240\u5728 VMA \u7684\u6743\u9650\uff0c\u540c\u65f6\u9700\u8981\u6ce8\u610f\u6620\u5c04\u7269\u7406\u9875\u65f6\u9700\u8981\u64cd\u4f5c\u5185\u5b58\u63a7\u5236\u7ed3\u6784\u6240\u6307\u5b9a\u7684\u9875\u8868\uff0c\u800c\u4e0d\u662f\u5185\u6838\u7684\u9875\u8868\u3002\u6ce8\u610f\uff1a\u5728LAB3 EXERCISE 2\u5904\u586b\u5199\u4ee3\u7801\u3002\u6267\u884c <pre><code>make\u3000qemu\n</code></pre> \u540e\uff0c\u5982\u679c\u901a\u8fc7check_pgfault\u51fd\u6570\u7684\u6d4b\u8bd5\u540e\uff0c\u4f1a\u6709\u201ccheck_pgfault()succeeded!\u201d\u7684\u8f93\u51fa\uff0c\u8868\u793a\u7ec3\u4e601\u30012\u57fa\u672c\u6b63\u786e\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u8bf7\u63cf\u8ff0\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff09\u548c\u9875\u8868\u9879\uff08Page Table Entry\uff09\u4e2d\u7ec4\u6210\u90e8\u5206\u5bf9ucore\u5b9e\u73b0\u9875\u66ff\u6362\u7b97\u6cd5\u7684\u6f5c\u5728\u7528\u5904\u3002</li> <li>\u5982\u679cucore\u7684\u7f3a\u9875\u670d\u52a1\u4f8b\u7a0b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u5185\u5b58\uff0c\u51fa\u73b0\u4e86\u9875\u8bbf\u95ee\u5f02\u5e38\uff0c\u8bf7\u95ee\u786c\u4ef6\u8981\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1f</li> </ul>"},{"location":"lab3/vmm/","title":"\u865a\u62df\u5185\u5b58","text":""},{"location":"lab3/vmm/#_1","title":"\u865a\u62df\u5185\u5b58\u7ba1\u7406","text":""},{"location":"lab3/vmm/#_2","title":"\u57fa\u672c\u539f\u7406\u6982\u8ff0","text":"<p>\u4ec0\u4e48\u662f\u865a\u62df\u5185\u5b58\uff1f\u7b80\u5355\u5730\u8bf4\u662f\u6307\u7a0b\u5e8f\u5458\u6216CPU\u201c\u770b\u5230\u201d\u7684\u5185\u5b58\u3002\u4f46\u6709\u51e0\u70b9\u9700\u8981\u6ce8\u610f\uff1a</p> <ol> <li>\u865a\u62df\u5185\u5b58\u5355\u5143\u4e0d\u4e00\u5b9a\u6709\u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\u5bf9\u5e94\uff0c\u5373\u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\u53ef\u80fd\u4e0d\u5b58\u5728\uff1b</li> <li>\u5982\u679c\u865a\u62df\u5185\u5b58\u5355\u5143\u5bf9\u5e94\u6709\u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\uff0c\u90a3\u4e8c\u8005\u7684\u5730\u5740\u4e00\u822c\u662f\u4e0d\u76f8\u7b49\u7684\uff1b</li> <li>\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u73b0\u7684\u67d0\u79cd\u5185\u5b58\u6620\u5c04\u53ef\u5efa\u7acb\u865a\u62df\u5185\u5b58\u4e0e\u7269\u7406\u5185\u5b58\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u4f7f\u5f97\u7a0b\u5e8f\u5458\u6216CPU\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\u4f1a\u81ea\u52a8\u8f6c\u6362\u4e3a\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u5730\u5740\u3002</li> </ol> <p>\u90a3\u4e48\u8fd9\u4e2a\u201c\u865a\u62df\u201d\u7684\u4f5c\u7528\u6216\u610f\u4e49\u5728\u54ea\u91cc\u4f53\u73b0\u5462\uff1f\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u865a\u62df\u5185\u5b58\u5176\u5b9e\u5305\u542b\u591a\u4e2a\u865a\u62df\u5c42\u6b21\uff0c\u5728\u4e0d\u540c\u7684\u5c42\u6b21\u4f53\u73b0\u4e86\u4e0d\u540c\u7684\u4f5c\u7528\u3002\u9996\u5148\uff0c\u5728\u6709\u4e86\u5206\u9875\u673a\u5236\u540e\uff0c\u7a0b\u5e8f\u5458\u6216CPU\u201c\u770b\u5230\u201d\u7684\u5730\u5740\u5df2\u7ecf\u4e0d\u662f\u5b9e\u9645\u7684\u7269\u7406\u5730\u5740\u4e86\uff0c\u8fd9\u5df2\u7ecf\u6709\u4e00\u5c42\u865a\u62df\u5316\uff0c\u6211\u4eec\u53ef\u7b80\u79f0\u4e3a\u5185\u5b58\u5730\u5740\u865a\u62df\u5316\u3002\u6709\u4e86\u5185\u5b58\u5730\u5740\u865a\u62df\u5316\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u9879\u6765\u9650\u5b9a\u8f6f\u4ef6\u8fd0\u884c\u65f6\u7684\u8bbf\u95ee\u7a7a\u95f4\uff0c\u786e\u4fdd\u8f6f\u4ef6\u8fd0\u884c\u4e0d\u8d8a\u754c\uff0c\u5b8c\u6210\u5185\u5b58\u8bbf\u95ee\u4fdd\u62a4\u7684\u529f\u80fd\u3002</p> <p>\u901a\u8fc7\u5185\u5b58\u5730\u5740\u865a\u62df\u5316\uff0c\u53ef\u4ee5\u4f7f\u5f97\u8f6f\u4ef6\u5728\u6ca1\u6709\u8bbf\u95ee\u67d0\u865a\u62df\u5185\u5b58\u5730\u5740\u65f6\u4e0d\u5206\u914d\u5177\u4f53\u7684\u7269\u7406\u5185\u5b58\uff0c\u800c\u53ea\u6709\u5728\u5b9e\u9645\u8bbf\u95ee\u67d0\u865a\u62df\u5185\u5b58\u5730\u5740\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u518d\u52a8\u6001\u5730\u5206\u914d\u7269\u7406\u5185\u5b58\uff0c\u5efa\u7acb\u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u7684\u9875\u6620\u5c04\u5173\u7cfb\uff0c\u8fd9\u79cd\u6280\u672f\u79f0\u4e3a\u6309\u9700\u5206\u9875\uff08demand paging\uff09\u3002\u628a\u4e0d\u7ecf\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u6240\u5360\u7684\u5185\u5b58\u7a7a\u95f4\u4e34\u65f6\u5199\u5230\u786c\u76d8\u4e0a\uff0c\u8fd9\u6837\u53ef\u4ee5\u817e\u51fa\u66f4\u591a\u7684\u7a7a\u95f2\u5185\u5b58\u7a7a\u95f4\u7ed9\u7ecf\u5e38\u8bbf\u95ee\u7684\u6570\u636e\uff1b\u5f53CPU\u8bbf\u95ee\u5230\u4e0d\u7ecf\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u65f6\uff0c\u518d\u628a\u8fd9\u4e9b\u6570\u636e\u4ece\u786c\u76d8\u8bfb\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u8fd9\u79cd\u6280\u672f\u79f0\u4e3a\u9875\u6362\u5165\u6362\u51fa\uff08page\u3000swap in/out\uff09\uff0c\u5c3d\u7ba1\u6211\u4eecLoongArch32\u7248\u672c\u7684uCore\u4e2d\u79fb\u9664\u4e86swap\u529f\u80fd\u3002\u8fd9\u79cd\u5185\u5b58\u7ba1\u7406\u6280\u672f\u7ed9\u4e86\u7a0b\u5e8f\u5458\u66f4\u5927\u7684\u5185\u5b58\u201c\u7a7a\u95f4\u201d\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba9\u66f4\u591a\u7684\u7a0b\u5e8f\u5728\u5185\u5b58\u4e2d\u5e76\u53d1\u8fd0\u884c\u3002</p>"},{"location":"lab3/vmm/#_3","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u4e3b\u8981\u5b8c\u6210ucore\u5185\u6838\u5bf9\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u5de5\u4f5c\u3002\u5176\u603b\u4f53\u8bbe\u8ba1\u601d\u8def\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\uff0c\u5373\u9996\u5148\u5b8c\u6210\u521d\u59cb\u5316\u865a\u62df\u5185\u5b58\u7ba1\u7406\u673a\u5236\uff0c\u5373\u9700\u8981\u8bbe\u7f6e\u597d\u54ea\u4e9b\u9875\u9700\u8981\u653e\u5728\u7269\u7406\u5185\u5b58\u4e2d\uff0c\u54ea\u4e9b\u9875\u4e0d\u9700\u8981\u653e\u5728\u7269\u7406\u5185\u5b58\u4e2d\uff0c\u800c\u662f\u53ef\u88ab\u6362\u51fa\u5230\u786c\u76d8\u4e0a\uff0c\u5e76\u6d89\u53ca\u5b8c\u5584\u5efa\u7acb\u9875\u8868\u6620\u5c04\u3001\u9875\u8bbf\u95ee\u5f02\u5e38\u5904\u7406\u64cd\u4f5c\u7b49\u51fd\u6570\u5b9e\u73b0\u3002\u7136\u540e\u5c31\u6267\u884c\u4e00\u7ec4\u8bbf\u5b58\u6d4b\u8bd5\uff0c\u770b\u770b\u6211\u4eec\u5efa\u7acb\u7684\u9875\u8868\u9879\u662f\u5426\u80fd\u591f\u6b63\u786e\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u6620\u5c04\uff0c\u662f\u5426\u6b63\u786e\u63cf\u8ff0\u4e86\u865a\u62df\u5185\u5b58\u9875\u5728\u7269\u7406\u5185\u5b58\u4e2d\u8fd8\u662f\u5728\u786c\u76d8\u4e0a\uff0c\u662f\u5426\u80fd\u591f\u6b63\u786e\u628a\u865a\u62df\u5185\u5b58\u9875\u5728\u7269\u7406\u5185\u5b58\u548c\u786c\u76d8\u4e4b\u95f4\u8fdb\u884c\u4f20\u9012\uff0c\u662f\u5426\u6b63\u786e\u5b9e\u73b0\u4e86\u9875\u9762\u66ff\u6362\u7b97\u6cd5\u7b49\u3002lab3\u7684\u603b\u4f53\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u3002</p> <p>\u9996\u5148\u662f\u521d\u59cb\u5316\u8fc7\u7a0b\u3002\u53c2\u8003ucore\u603b\u63a7\u51fd\u6570init\u7684\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u8c03\u7528\u5b8c\u6210\u865a\u62df\u5185\u5b58\u521d\u59cb\u5316\u7684vmm_init\u51fd\u6570\u4e4b\u524d\uff0c\u9700\u8981\u9996\u5148\u8c03\u7528setup_exception_vector\u51fd\u6570\u548cpic_init\u51fd\u6570\u7b49\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u4e0elab1\u7684\u4e2d\u65ad\u5f02\u5e38\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5185\u5bb9\u662f\u76f8\u540c\u7684\u3002\u63a5\u7740\u662f\u8c03\u7528pmm_init\u51fd\u6570\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\uff0c\u8fd9\u4e5f\u662f\u6211\u4eeclab2\u5df2\u7ecf\u5b8c\u6210\u7684\u5185\u5bb9\u3002</p> <p>\u5728\u8c03\u7528\u5b8cpmm_init\u51fd\u6570\u4e4b\u540e\uff0c\u5c06\u8fdb\u4e00\u6b65\u8c03\u7528\u4e09\u4e2alab3\u4e2d\u624d\u6709\u7684\u65b0\u51fd\u6570vmm_init\u3002\u8fd9\u4e2a\u51fd\u6570\u6d89\u53ca\u4e86\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7684\u7ec3\u4e602\u3002\u4f46\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u9700\u8981\u5148\u5b9e\u73b0\u7ec3\u4e601\u4e2d\u7684TLB\u7684\u586b\u5145\u903b\u8f91\u624d\u80fd\u8fdb\u884cvmm_init\u3002TLB\u7684\u586b\u5145\u903b\u8f91\u4f4d\u4e8e<code>kern/mm/la32_tlb.c</code>\u6587\u4ef6\u4e2d\uff0c\u8fd9\u91cc\u9700\u8981\u540c\u5b66\u4eec\u67e5\u9605LoongArch32\u7684\u6587\u6863\u4e2d\u7684\u201c\u5b58\u50a8\u7ba1\u7406\u201d\u7ae0\u8282\u4e0e\u201c\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\u201d\u7ae0\u8282\uff0c\u4e86\u89e3LoongArch32\u7684\u8f6f\u4ef6\u586b\u5145TLB\u7684\u57fa\u672c\u539f\u7406\u4ee5\u53caCSR\u4e2dTLB\u6709\u5173\u5bc4\u5b58\u5668\u5404\u4e2a\u4f4d\u7684\u4f5c\u7528\uff0c\u4ee5\u5b9e\u73b0\u7ec3\u4e601\u3002</p> <p>\u56de\u5230ucore\u7684init\u4ee3\u7801\uff0c\u7b2c\u4e00\u4e2a\u51fd\u6570vmm_init\u662f\u68c0\u67e5\u6211\u4eec\u7684\u7ec3\u4e601\u4e0e\u7ec3\u4e602\u662f\u5426\u6b63\u786e\u5b9e\u73b0\u4e86\u3002\u4e3a\u4e86\u8868\u8ff0\u4e0d\u5728\u7269\u7406\u5185\u5b58\u4e2d\u7684\u201c\u5408\u6cd5\u201d\u865a\u62df\u9875\uff0c\u9700\u8981\u6709\u6570\u636e\u7ed3\u6784\u6765\u63cf\u8ff0\u8fd9\u6837\u7684\u9875\uff0c\u4e3a\u6b64ucore\u5efa\u7acb\u4e86mm_struct\u548cvma_struct\u6570\u636e\u7ed3\u6784\uff08\u63a5\u4e0b\u6765\u7684\u5c0f\u8282\u4e2d\u6709\u8fdb\u4e00\u6b65\u8be6\u7ec6\u63cf\u8ff0\uff09\uff0c\u5047\u5b9a\u6211\u4eec\u5df2\u7ecf\u63cf\u8ff0\u597d\u4e86\u8fd9\u6837\u7684\u201c\u5408\u6cd5\u201d\u865a\u62df\u9875\uff0c\u5f53ucore\u8bbf\u95ee\u8fd9\u4e9b\u201c\u5408\u6cd5\u201d\u865a\u62df\u9875\u65f6\uff0c\u4f1a\u7531\u4e8e\u6ca1\u6709\u865a\u5b9e\u5730\u5740\u6620\u5c04\u800c\u4ea7\u751f\u9875\u8bbf\u95ee\u5f02\u5e38\u3002\u5982\u679c\u6211\u4eec\u6b63\u786e\u5b9e\u73b0\u4e86\u7ec3\u4e602\uff0c\u5219do_pgfault\u51fd\u6570\u4f1a\u7533\u8bf7\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\uff0c\u5e76\u5efa\u7acb\u597d\u865a\u5b9e\u6620\u5c04\u5173\u7cfb\uff0c\u4ece\u800c\u4f7f\u5f97\u8fd9\u6837\u7684\u201c\u5408\u6cd5\u201d\u865a\u62df\u9875\u6709\u5b9e\u9645\u7684\u7269\u7406\u9875\u5e27\u5bf9\u5e94\u3002\u8fd9\u6837\u7ec3\u4e601\u5c31\u7b97\u5b8c\u6210\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u8fdb\u4e00\u6b65\u5206\u6790\u5b8c\u6210lab3\u4e3b\u8981\u6ce8\u610f\u7684\u5173\u952e\u95ee\u9898\u548c\u6d89\u53ca\u7684\u5173\u952e\u6570\u636e\u7ed3\u6784\u3002</p>"},{"location":"lab3/vmm/#_4","title":"\u5173\u952e\u6570\u636e\u7ed3\u6784\u548c\u76f8\u5173\u51fd\u6570\u5206\u6790","text":"<p>\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u95ee\u9898\u7684\u51fa\u73b0\uff0c\u5728\u4e8e\u5b9e\u9a8c\u4e8c\u4e2d\u6709\u5173\u5185\u5b58\u7684\u6570\u636e\u7ed3\u6784\u548c\u76f8\u5173\u64cd\u4f5c\u90fd\u662f\u76f4\u63a5\u9488\u5bf9\u5b9e\u9645\u5b58\u5728\u7684\u8d44\u6e90--\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u7ba1\u7406\uff0c\u6ca1\u6709\u4ece\u4e00\u822c\u5e94\u7528\u7a0b\u5e8f\u5bf9\u5185\u5b58\u7684\u201c\u9700\u6c42\u201d\u8003\u8651\uff0c\u5373\u9700\u8981\u6709\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784\u548c\u64cd\u4f5c\u6765\u4f53\u73b0\u4e00\u822c\u5e94\u7528\u7a0b\u5e8f\u5bf9\u865a\u62df\u5185\u5b58\u7684\u201c\u9700\u6c42\u201d\u3002\u4e00\u822c\u5e94\u7528\u7a0b\u5e8f\u7684\u5bf9\u865a\u62df\u5185\u5b58\u7684\u201c\u9700\u6c42\u201d\u4e0e\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u201c\u4f9b\u7ed9\u201d\u6ca1\u6709\u76f4\u63a5\u7684\u5bf9\u5e94\u5173\u7cfb\uff0cucore\u662f\u901a\u8fc7page fault\u5f02\u5e38\u5904\u7406\u6765\u95f4\u63a5\u5b8c\u6210\u8fd9\u4e8c\u8005\u4e4b\u95f4\u7684\u8854\u63a5\u3002</p> <p>page_fault\u51fd\u6570\u4e0d\u77e5\u9053\u54ea\u4e9b\u662f\u201c\u5408\u6cd5\u201d\u7684\u865a\u62df\u9875\uff0c\u539f\u56e0\u662fucore\u8fd8\u7f3a\u5c11\u4e00\u5b9a\u7684\u6570\u636e\u7ed3\u6784\u6765\u63cf\u8ff0\u8fd9\u79cd\u4e0d\u5728\u7269\u7406\u5185\u5b58\u4e2d\u7684\u201c\u5408\u6cd5\u201d\u865a\u62df\u9875\u3002\u4e3a\u6b64ucore\u901a\u8fc7\u5efa\u7acbmm_struct\u548cvma_struct\u6570\u636e\u7ed3\u6784\uff0c\u63cf\u8ff0\u4e86ucore\u6a21\u62df\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u6240\u9700\u7684\u5408\u6cd5\u5185\u5b58\u7a7a\u95f4\u3002\u5f53\u8bbf\u95ee\u5185\u5b58\u4ea7\u751fpage fault\u5f02\u5e38\u65f6\uff0c\u53ef\u83b7\u5f97\u8bbf\u95ee\u7684\u5185\u5b58\u7684\u65b9\u5f0f\uff08\u8bfb\u6216\u5199\uff09\u4ee5\u53ca\u5177\u4f53\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff0c\u8fd9\u6837ucore\u5c31\u53ef\u4ee5\u67e5\u8be2\u6b64\u5730\u5740\uff0c\u770b\u662f\u5426\u5c5e\u4e8evma_struct\u6570\u636e\u7ed3\u6784\u4e2d\u63cf\u8ff0\u7684\u5408\u6cd5\u5730\u5740\u8303\u56f4\u4e2d\uff0c\u5982\u679c\u5728\uff0c\u5219\u53ef\u6839\u636e\u5177\u4f53\u60c5\u51b5\u8fdb\u884c\u8bf7\u6c42\u8c03\u9875\uff1b\u5982\u679c\u4e0d\u5728\uff0c\u5219\u62a5\u9519\u3002mm_struct\u548cvma_struct\u6570\u636e\u7ed3\u6784\u7ed3\u5408\u9875\u8868\u8868\u793a\u865a\u62df\u5730\u5740\u7a7a\u95f4\u548c\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p>\u56fe \u865a\u62df\u5730\u5740\u7a7a\u95f4\u548c\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u793a\u610f\u56fe</p> <p> </p> <p>\u5728ucore\u4e2d\u63cf\u8ff0\u5e94\u7528\u7a0b\u5e8f\u5bf9\u865a\u62df\u5185\u5b58\u201c\u9700\u6c42\u201d\u7684\u6570\u636e\u7ed3\u6784\u662fvma_struct\uff08\u5b9a\u4e49\u5728vmm.h\u4e2d\uff09\uff0c\u4ee5\u53ca\u9488\u5bf9vma_struct\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u8fd9\u91cc\u628a\u4e00\u4e2avma_struct\u7ed3\u6784\u7684\u53d8\u91cf\u7b80\u79f0\u4e3avma\u53d8\u91cf\u3002vma_struct\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct vma_struct {\n// the set of vma using the same PDT\nstruct mm_struct *vm_mm;\nuintptr_t vm_start; // start addr of vma\nuintptr_t vm_end; // end addr of vma\nuint32_t vm_flags; // flags of vma\n//linear list link which sorted by start addr of vma\nlist_entry_t list_link;\n};\n</code></pre> <p>vm_start\u548cvm_end\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u7ed3\u675f\u4f4d\u7f6e\uff0c\u8fd9\u4e24\u4e2a\u503c\u90fd\u5e94\u8be5\u662fPGSIZE \u5bf9\u9f50\u7684\uff0c\u800c\u4e14\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u5408\u7406\u7684\u5730\u5740\u7a7a\u95f4\u8303\u56f4\uff08\u5373\u4e25\u683c\u786e\u4fdd vm_start &lt; vm_end\u7684\u5173\u7cfb\uff09\uff1blist_link\u662f\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u6309\u7167\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u628a\u4e00\u7cfb\u5217\u7528vma_struct\u8868\u793a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u94fe\u63a5\u8d77\u6765\uff0c\u5e76\u4e14\u8fd8\u8981\u6c42\u8fd9\u4e9b\u94fe\u8d77\u6765\u7684vma_struct\u5e94\u8be5\u662f\u4e0d\u76f8\u4ea4\u7684\uff0c\u5373vma\u4e4b\u95f4\u7684\u5730\u5740\u7a7a\u95f4\u65e0\u4ea4\u96c6\uff1bvm_flags\u8868\u793a\u4e86\u8fd9\u4e2a\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5c5e\u6027\uff0c\u76ee\u524d\u7684\u5c5e\u6027\u5305\u62ec\uff1a</p> <pre><code>#define VM_READ 0x00000001 //\u53ea\u8bfb\n#define VM_WRITE 0x00000002 //\u53ef\u8bfb\u5199\n#define VM_EXEC 0x00000004 //\u53ef\u6267\u884c\n</code></pre> <p>vm_mm\u662f\u4e00\u4e2a\u6307\u9488\uff0c\u6307\u5411\u4e00\u4e2a\u6bd4vma_struct\u66f4\u9ad8\u7684\u62bd\u8c61\u5c42\u6b21\u7684\u6570\u636e\u7ed3\u6784mm_struct\uff0c\u8fd9\u91cc\u628a\u4e00\u4e2amm_struct\u7ed3\u6784\u7684\u53d8\u91cf\u7b80\u79f0\u4e3amm\u53d8\u91cf\u3002\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u8868\u793a\u4e86\u5305\u542b\u6240\u6709\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5171\u540c\u5c5e\u6027\uff0c\u5177\u4f53\u5b9a\u4e49\u5982\u4e0b  </p> <pre><code>struct mm_struct {\n// linear list link which sorted by start addr of vma\nlist_entry_t mmap_list;\n// current accessed vma, used for speed purpose\nstruct vma_struct *mmap_cache;\npde_t *pgdir; // the PDT of these vma\nint map_count; // the count of these vma\n};\n</code></pre> <p>mmap_list\u662f\u53cc\u5411\u94fe\u8868\u5934\uff0c\u94fe\u63a5\u4e86\u6240\u6709\u5c5e\u4e8e\u540c\u4e00\u9875\u76ee\u5f55\u8868\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0cmmap_cache\u662f\u6307\u5411\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u7531\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u6267\u884c\u7684\u201c\u5c40\u90e8\u6027\u201d\u539f\u7406\uff0c\u5f53\u524d\u6b63\u5728\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5728\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u4e2d\u53ef\u80fd\u8fd8\u4f1a\u7528\u5230\uff0c\u8fd9\u65f6\u5c31\u4e0d\u9700\u8981\u67e5\u94fe\u8868\uff0c\u800c\u662f\u76f4\u63a5\u4f7f\u7528\u6b64\u6307\u9488\u5c31\u53ef\u627e\u5230\u4e0b\u4e00\u6b21\u8981\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002\u7531\u4e8emmap_cache \u7684\u5f15\u5165\uff0c\u53ef\u4f7f\u5f97 mm_struct \u6570\u636e\u7ed3\u6784\u7684\u67e5\u8be2\u52a0\u901f 30% \u4ee5\u4e0a\u3002pgdir \u6240\u6307\u5411\u7684\u5c31\u662f mm_struct\u6570\u636e\u7ed3\u6784\u6240\u7ef4\u62a4\u7684\u9875\u8868\u3002\u901a\u8fc7\u8bbf\u95eepgdir\u53ef\u4ee5\u67e5\u627e\u67d0\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\u662f\u5426\u5b58\u5728\u4ee5\u53ca\u9875\u8868\u9879\u7684\u5c5e\u6027\u7b49\u3002map_count\u8bb0\u5f55mmap_list \u91cc\u9762\u94fe\u63a5\u7684 vma_struct\u7684\u4e2a\u6570\u3002</p> <p>\u6d89\u53cavma_struct\u7684\u64cd\u4f5c\u51fd\u6570\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u4e3b\u8981\u5305\u62ec\u4e09\u4e2a\uff1a</p> <ul> <li>vma_create--\u521b\u5efavma</li> <li>insert_vma_struct--\u63d2\u5165\u4e00\u4e2avma</li> <li>find_vma--\u67e5\u8be2vma\u3002</li> </ul> <p>vma_create\u51fd\u6570\u6839\u636e\u8f93\u5165\u53c2\u6570vm_start\u3001vm_end\u3001vm_flags\u6765\u521b\u5efa\u5e76\u521d\u59cb\u5316\u63cf\u8ff0\u4e00\u4e2a\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684vma_struct\u7ed3\u6784\u53d8\u91cf\u3002insert_vma_struct\u51fd\u6570\u5b8c\u6210\u628a\u4e00\u4e2avma\u53d8\u91cf\u6309\u7167\u5176\u7a7a\u95f4\u4f4d\u7f6e[vma-&gt;vm_start,vma-&gt;vm_end]\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u63d2\u5165\u5230\u6240\u5c5e\u7684mm\u53d8\u91cf\u4e2d\u7684mmap_list\u53cc\u5411\u94fe\u8868\u4e2d\u3002find_vma\u6839\u636e\u8f93\u5165\u53c2\u6570addr\u548cmm\u53d8\u91cf\uff0c\u67e5\u627e\u5728mm\u53d8\u91cf\u4e2d\u7684mmap_list\u53cc\u5411\u94fe\u8868\u4e2d\u67d0\u4e2avma\u5305\u542b\u6b64addr\uff0c\u5373vma-&gt;vm_start&lt;=addr &lt;vma-&gt;end\u3002\u8fd9\u4e09\u4e2a\u51fd\u6570\u4e0e\u540e\u7eed\u8bb2\u5230\u7684page fault\u5f02\u5e38\u5904\u7406\u6709\u7d27\u5bc6\u8054\u7cfb\u3002</p> <p>\u6d89\u53camm_struct\u7684\u64cd\u4f5c\u51fd\u6570\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u6709mm_create\u548cmm_destroy\u4e24\u4e2a\u51fd\u6570\uff0c\u4ece\u5b57\u9762\u610f\u601d\u5c31\u53ef\u4ee5\u770b\u51fa\u662f\u662f\u5b8c\u6210mm_struct\u7ed3\u6784\u7684\u53d8\u91cf\u521b\u5efa\u548c\u5220\u9664\u3002\u5728mm_create\u4e2d\u7528kmalloc\u5206\u914d\u4e86\u4e00\u5757\u7a7a\u95f4\uff0c\u6240\u4ee5\u5728mm_destroy\u4e2d\u4e5f\u8981\u5bf9\u5e94\u8fdb\u884c\u91ca\u653e\u3002\u5728ucore\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u4ea7\u751f\u63cf\u8ff0\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684vma_struct\u7ed3\u6784\uff0c\u6240\u4ee5\u5728mm_destroy\u4e2d\u4e5f\u8981\u8fdb\u5bf9\u8fd9\u4e9bmmap_list\u4e2d\u7684vma\u8fdb\u884c\u91ca\u653e\u3002</p>"},{"location":"lab3/vmm/#tlb-refill","title":"TLB Refill\u4f8b\u5916\u5904\u7406","text":"<p>\u5bf9\u4e8eLoongArch32\u67b6\u6784\u800c\u8a00\uff0c\u5b9e\u73b0\u865a\u5b58\u7ba1\u7406\u7684\u5173\u952e\u5728\u4e8e\u5b9e\u73b0TLB\u76f8\u5173\u7684\u4f8b\u5916\u5904\u7406\u3002\u5176\u8fc7\u7a0b\u4e2d\u4e3b\u8981\u6d89\u53ca\u5230\u51fd\u6570 -- handle_tlbmiss\u7684\u5177\u4f53\u5b9e\u73b0\u3002\u5728TLB\u4e2d\u65e0\u6cd5\u627e\u5230\u7684\u9875\u9762\uff0cCPU\u4f1a\u4ea7\u751fTLB Refill\u4f8b\u5916\uff0c\u4ece\u800c\u8bbe\u7f6eCSR.PRMD\u5e76\u8df3\u8f6c\u5230TLB Refill\u4f8b\u5916\u5904\u7406\u7a0b\u5e8f\u5f00\u59cb\u5904\u7406\u3002\u8fd9\u4e2aTLB Refill\u7528\u4e8e\u5b8c\u6210\u8f6f\u4ef6\u5b9a\u4e49\u9875\u8868\u7684\u5b9e\u73b0\u3002\u5728uCore\u7684\u8bbe\u8ba1\u4e2d\uff0c\u6211\u4eec\u5c06TLB Refill\u4f8b\u5916\u5165\u53e3\u7684\u8bbe\u7f6e\u4e0e\u901a\u7528\u4f8b\u5916\u5165\u53e3\u8bbe\u7f6e\u76f8\u540c\uff0c\u4ece\u800c\u53ef\u4ee5\u590d\u7528\u4fdd\u5b58\u73b0\u573a\uff0c\u8bbe\u7f6eCRMD\u3001\u5185\u6838\u6808\u7b49\u4ee3\u7801\uff0c\u7136\u540e\u7531trap_dispatch\u6839\u636e\u8bfb\u53d6\u5df2\u7ecf\u4fdd\u5b58\u7684trapframe\u4e2d\u7684CSR.ESTAT\u5bc4\u5b58\u5668\u7684\u503c\u5224\u65ad\u662f\u5426\u4e3aTLB Refill\u76f8\u5173\u7684\u4f8b\u5916\uff0c\u82e5\u662f\uff0c\u5219\u8c03\u7528<code>handle_tlbmiss</code>\u3002</p> <p>\u56e0\u6b64\uff0c\u5927\u81f4\u7684\u8c03\u7528\u5173\u7cfb\u5982\u4e0b\uff1a</p> <p>loongarch_trap--&gt;trap_dispatch--&gt;handle_tlbmiss</p> <p>\u800c\u5f53<code>handle_tlbmiss</code>\u51fd\u6570\u5904\u7406\u65f6\uff0c\u5982\u679c\u53d1\u73b0\u5bf9\u5e94\u7684PTE\u4e0d\u5b58\u5728\uff0c\u5c31\u9700\u8981\u5bf9\u7f3a\u9875\uff08Page Fault\uff09\u8fdb\u884c\u5904\u7406\u3002\u8fd9\u91cc\u9996\u5148\u8c03\u7528\u4e86<code>pgfault_handler</code>\u51fd\u6570\uff0c\u8fdb\u884c\u4e86\u76f8\u5173\u68c0\u67e5\u540e\u6700\u7ec8\u8c03\u7528\u5230\u4e86<code>do_pgfault</code>\u51fd\u6570\uff0c\u4e0b\u9762\u9700\u8981\u5177\u4f53\u5206\u6790\u4e00\u4e0bdo_pgfault\u51fd\u6570\u3002do_pgfault\u7684\u8c03\u7528\u5173\u7cfb\u5982\u4e0b\u6240\u793a\uff1a</p> <p>loongarch_trap--&gt;trap_dispatch--&gt;handle_tlbmiss--&gt;pgfault_handler--&gt;do_pgfault</p> <p>ucore\u4e2ddo_pgfault\u51fd\u6570\u662f\u5b8c\u6210\u9875\u8bbf\u95ee\u5f02\u5e38\u5904\u7406\u7684\u4e3b\u8981\u51fd\u6570\uff0c\u5b83\u6839\u636e\u5728trapframe\u4e2d\u4fdd\u5b58\u7684CPU\u7684\u63a7\u5236\u5bc4\u5b58\u5668CSR.BADVA\u4e2d\u83b7\u53d6\u7684\u9875\u8bbf\u95ee\u5f02\u5e38\u7684\u865a\u62df\u5730\u5740\u4ee5\u53ca\u6839\u636eerrorCode\u7684\u9519\u8bef\u7c7b\u578b\u6765\u67e5\u627e\u6b64\u5730\u5740\u662f\u5426\u5728\u67d0\u4e2aVMA\u7684\u5730\u5740\u8303\u56f4\u5185\u4ee5\u53ca\u662f\u5426\u6ee1\u8db3\u6b63\u786e\u7684\u8bfb\u5199\u6743\u9650\uff0c\u5982\u679c\u5728\u6b64\u8303\u56f4\u5185\u5e76\u4e14\u6743\u9650\u4e5f\u6b63\u786e\uff0c\u8fd9\u8ba4\u4e3a\u8fd9\u662f\u4e00\u6b21\u5408\u6cd5\u8bbf\u95ee\uff0c\u4f46\u6ca1\u6709\u5efa\u7acb\u865a\u5b9e\u5bf9\u5e94\u5173\u7cfb\u3002\u6240\u4ee5\u9700\u8981\u5206\u914d\u4e00\u4e2a\u7a7a\u95f2\u7684\u5185\u5b58\u9875\uff0c\u5e76\u4fee\u6539\u9875\u8868\u5b8c\u6210\u865a\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff0c\u5237\u65b0TLB\uff0c\u7136\u540e\u8fd4\u56de\u5230\u4ea7\u751f\u9875\u8bbf\u95ee\u5f02\u5e38\u7684\u6307\u4ee4\u5904\u91cd\u65b0\u6267\u884c\u6b64\u6307\u4ee4\u3002\u5982\u679c\u8be5\u865a\u5730\u5740\u4e0d\u5728\u67d0VMA\u8303\u56f4\u5185\uff0c\u5219\u8ba4\u4e3a\u662f\u4e00\u6b21\u975e\u6cd5\u8bbf\u95ee\u3002</p>"},{"location":"lab4/appendix/","title":"\u9644\u5f55","text":""},{"location":"lab4/appendix/#_1","title":"\u3010\u539f\u7406\u3011\u8fdb\u7a0b\u7684\u5c5e\u6027\u4e0e\u7279\u5f81\u89e3\u6790","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u8d1f\u8d23\u8fdb\u7a0b\u7ba1\u7406\uff0c\u5373\u4ece\u7a0b\u5e8f\u52a0\u8f7d\u5230\u8fd0\u884c\u7ed3\u675f\u7684\u5168\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u8fc7\u7a0b\u5c06\u7ecf\u5386\u4ece\u201c\u51fa\u751f\u201d\u5230\u201c\u6b7b\u4ea1\u201d\u7684\u5b8c\u6574\u201c\u751f\u547d\u201d\u5386\u7a0b\u3002\u6240\u8c13\u201c\u8fdb\u7a0b\u201d\u5c31\u662f\u6307\u8fd9\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u7684\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u3002\u4e3a\u4e86\u8bb0\u5f55\u3001\u63cf\u8ff0\u548c\u7ba1\u7406\u7a0b\u5e8f\u6267\u884c\u7684\u52a8\u6001\u53d8\u5316\u8fc7\u7a0b\uff0c\u9700\u8981\u6709\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\uff0c\u8fd9\u5c31\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\u3002\u8fdb\u7a0b\u4e0e\u8fdb\u7a0b\u63a7\u5236\u5757\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u3002\u4e3a\u6b64\uff0cucore\u9700\u8981\u5efa\u7acb\u5408\u9002\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u57fa\u4e8e\u8fdb\u7a0b\u63a7\u5236\u5757\u6765\u5b8c\u6210\u5bf9\u8fdb\u7a0b\u7684\u7ba1\u7406\u3002</p> <p>\u4e3a\u4e86\u8ba9\u591a\u4e2a\u7a0b\u5e8f\u80fd\u591f\u4f7f\u7528CPU\u6267\u884c\u4efb\u52a1\uff0c\u9700\u8981\u8bbe\u8ba1\u7528\u4e8e\u8fdb\u7a0b\u7ba1\u7406\u7684\u5185\u6838\u6570\u636e\u7ed3\u6784\u201c\u8fdb\u7a0b\u63a7\u5236\u5757\u201d\u3002\u4f46\u5230\u5e95\u5982\u4f55\u8bbe\u8ba1\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u5982\u4f55\u7ba1\u7406\u8fdb\u7a0b\uff1f\u5982\u679c\u5bf9\u8fdb\u7a0b\u7684\u5c5e\u6027\u548c\u7279\u5f81\u4e86\u89e3\u4e0d\u591f\uff0c\u5219\u65e0\u6cd5\u6709\u6548\u5730\u8bbe\u8ba1\u8fdb\u7a0b\u63a7\u5236\u5757\u548c\u5b9e\u73b0\u8fdb\u7a0b\u7ba1\u7406\u3002</p> <p>\u518d\u4e00\u6b21\u56de\u5230\u8fdb\u7a0b\u7684\u5b9a\u4e49\uff1a\u4e00\u4e2a\u5177\u6709\u4e00\u5b9a\u72ec\u7acb\u529f\u80fd\u7684\u7a0b\u5e8f\u5728\u4e00\u4e2a\u6570\u636e\u96c6\u5408\u4e0a\u7684\u4e00\u6b21\u52a8\u6001\u6267\u884c\u8fc7\u7a0b\u3002\u8fd9\u91cc\u6709\u56db\u4e2a\u5173\u952e\u8bcd\uff1a\u7a0b\u5e8f\u3001\u6570\u636e\u96c6\u5408\u3001\u6267\u884c\u548c\u52a8\u6001\u6267\u884c\u8fc7\u7a0b\u3002\u4eceCPU\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u6240\u8c13\u7a0b\u5e8f\u5c31\u662f\u4e00\u6bb5\u7279\u5b9a\u7684\u6307\u4ee4\u673a\u5668\u7801\u5e8f\u5217\u800c\u5df2\u3002CPU\u4f1a\u4e00\u6761\u4e00\u6761\u5730\u53d6\u51fa\u5728\u5185\u5b58\u4e2d\u7a0b\u5e8f\u7684\u6307\u4ee4\u5e76\u6309\u7167\u6307\u4ee4\u7684\u542b\u4e49\u6267\u884c\u5404\u79cd\u529f\u80fd\uff1b\u6240\u8c13\u6570\u636e\u96c6\u5408\u5c31\u662f\u4f7f\u7528\u7684\u5185\u5b58\uff1b\u6240\u8c13\u6267\u884c\u5c31\u662f\u8ba9CPU\u5de5\u4f5c\u3002\u8fd9\u4e2a\u6570\u636e\u96c6\u5408\u548c\u6267\u884c\u5176\u5b9e\u4f53\u73b0\u4e86\u8fdb\u7a0b\u5bf9\u8d44\u6e90\u7684\u5360\u7528\u3002\u52a8\u6001\u6267\u884c\u8fc7\u7a0b\u4f53\u73b0\u4e86\u7a0b\u5e8f\u6267\u884c\u7684\u4e0d\u540c\u201c\u751f\u547d\u201d\u9636\u6bb5\uff1a\u8bde\u751f\u3001\u5de5\u4f5c\u3001\u4f11\u606f/\u7b49\u5f85\u3001\u6b7b\u4ea1\u3002\u5982\u679c\u8fd9\u4e00\u6bb5\u6307\u4ee4\u6267\u884c\u5b8c\u6bd5\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u8fdb\u7a0b\u7ed3\u675f\u4e86\u3002\u4ece\u5f00\u59cb\u6267\u884c\u5230\u6267\u884c\u7ed3\u675f\u662f\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5168\u8fc7\u7a0b\u3002\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u7ba1\u7406\u8fdb\u7a0b\u7684\u4ec0\u4e48\uff1f\u5982\u679c\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u90a3\u64cd\u4f5c\u7cfb\u7edf\u7684\u5de5\u4f5c\u5c31\u7b80\u5355\u4e86\u3002\u8fdb\u7a0b\u7ba1\u7406\u5c31\u662f\u7ba1\u7406\u8fdb\u7a0b\u6267\u884c\u7684\u6307\u4ee4\uff0c\u8fdb\u7a0b\u5360\u7528\u7684\u8d44\u6e90\uff0c\u8fdb\u7a0b\u6267\u884c\u7684\u72b6\u6001\u3002\u8fd9\u53ef\u5f52\u7ed3\u4e3a\u5bf9\u4e00\u4e2a\u8fdb\u7a0b\u5185\u7684\u7ba1\u7406\u5de5\u4f5c\u3002\u4f46\u5b9e\u9645\u4e0a\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u5185\u5b58\u4e2d\uff0c\u53ef\u4ee5\u653e\u5f88\u591a\u7a0b\u5e8f\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u7ba1\u7406\u591a\u4e2a\u8fdb\u7a0b\uff0c\u90a3\u4e48\uff0c\u4e3a\u4e86\u534f\u8c03\u5404\u8fdb\u7a0b\u5bf9\u7cfb\u7edf\u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u8fdb\u7a0b\u7ba1\u7406\u8fd8\u9700\u8981\u505a\u4e00\u4e9b\u4e0e\u8fdb\u7a0b\u534f\u8c03\u6709\u5173\u7684\u5176\u4ed6\u7ba1\u7406\u5de5\u4f5c\uff0c\u5305\u62ec\u8fdb\u7a0b\u8c03\u5ea6\u3001\u8fdb\u7a0b\u95f4\u7684\u6570\u636e\u5171\u4eab\u3001\u8fdb\u7a0b\u95f4\u6267\u884c\u7684\u540c\u6b65\u4e92\u65a5\u5173\u7cfb\uff08\u540e\u7eed\u76f8\u5173\u5b9e\u9a8c\u6d89\u53ca\uff09\u7b49\u3002\u4e0b\u9762\u9010\u4e00\u8fdb\u884c\u89e3\u6790\u3002</p>"},{"location":"lab4/appendix/#1","title":"1. \u8d44\u6e90\u7ba1\u7406","text":"<p>\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\uff0c\u8fdb\u7a0b\u4f1a\u5360\u7528\u5185\u5b58\u548cCPU\uff0c\u8fd9\u90fd\u662f\u6709\u9650\u7684\u8d44\u6e90\uff0c\u5982\u679c\u4e0d\u8fdb\u884c\u5408\u7406\u7684\u7ba1\u7406\uff0c\u8d44\u6e90\u4f1a\u8017\u5c3d\u6216\u65e0\u6cd5\u9ad8\u6548\u516c\u5e73\u5730\u4f7f\u7528\uff0c\u4ece\u800c\u4f1a\u5bfc\u81f4\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u591a\u4e2a\u8fdb\u7a0b\u6267\u884c\u6548\u7387\u5f88\u4f4e\uff0c\u751a\u81f3\u7531\u4e8e\u8d44\u6e90\u4e0d\u591f\u800c\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\u3002</p> <p>\u5bf9\u4e8e\u7528\u6237\u8fdb\u7a0b\u800c\u8a00\uff0c\u64cd\u4f5c\u7cfb\u7edf\u662f\u5b83\u7684\u201c\u4e0a\u5e1d\u201d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u4e86\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u8fd0\u884c\u6240\u9700\u7684\u8d44\u6e90\uff0c\u6700\u57fa\u672c\u7684\u8d44\u6e90\u5c31\u662f\u5185\u5b58\u548cCPU\u3002\u5728\u5b9e\u9a8c\u4e8c/\u4e09\u4e2d\u6d89\u53ca\u7684\u5185\u5b58\u7ba1\u7406\u65b9\u6cd5\u548c\u673a\u5236\u53ef\u76f4\u63a5\u5e94\u7528\u5230\u8fdb\u7a0b\u7684\u5185\u5b58\u8d44\u6e90\u7ba1\u7406\u4e2d\u6765\u3002\u5728\u6709\u591a\u4e2a\u8fdb\u7a0b\u5b58\u5728\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u4e8eCPU\u8fd9\u79cd\u8d44\u6e90\uff0c\u5219\u9700\u8981\u901a\u8fc7\u8fdb\u7a0b\u8c03\u5ea6\u6765\u5408\u7406\u9009\u62e9\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5e76\u8fdb\u4e00\u6b65\u901a\u8fc7\u8fdb\u7a0b\u5206\u6d3e\u548c\u8fdb\u7a0b\u5207\u6362\u8ba9\u4e0d\u540c\u7684\u8fdb\u7a0b\u5206\u65f6\u590d\u7528CPU\uff0c\u6267\u884c\u5404\u81ea\u7684\u5de5\u4f5c\u3002\u5bf9\u4e8e\u65e0\u6cd5\u5265\u593a\u7684\u5171\u4eab\u8d44\u6e90\uff0c\u5982\u679c\u8d44\u6e90\u7ba1\u7406\u4e0d\u5f53\uff0c\u591a\u4e2a\u8fdb\u7a0b\u4f1a\u51fa\u73b0\u6b7b\u9501\u6216\u9965\u997f\u73b0\u8c61\u3002</p>"},{"location":"lab4/appendix/#2","title":"2. \u8fdb\u7a0b\u72b6\u6001\u7ba1\u7406","text":"<p>\u7528\u6237\u8fdb\u7a0b\u6709\u4e0d\u540c\u7684\u72b6\u6001\uff08\u53ef\u7406\u89e3\u4e3a\u201c\u751f\u547d\u201d\u7684\u4e0d\u540c\u9636\u6bb5\uff09\uff0c\u5f53\u64cd\u4f5c\u7cfb\u7edf\u628a\u7a0b\u5e8f\u7684\u653e\u5230\u5185\u5b58\u4e2d\u540e\uff0c\u8fd9\u4e2a\u8fdb\u7a0b\u5c31\u201c\u8bde\u751f\u201d\u4e86\uff0c\u4e0d\u8fc7\u8fd8\u6ca1\u6709\u5f00\u59cb\u6267\u884c\uff0c\u4f46\u5df2\u7ecf\u6d88\u8017\u4e86\u5185\u5b58\u8d44\u6e90\uff0c\u5904\u4e8e\u201c\u521b\u5efa\u201d\u72b6\u6001\uff1b\u5f53\u8fdb\u7a0b\u51c6\u5907\u597d\u5404\u79cd\u8d44\u6e90\uff0c\u5c31\u7b49\u80fd\u591f\u4f7f\u7528CPU\u65f6\uff0c\u8fdb\u7a0b\u5904\u4e8e\u201c\u5c31\u7eea\u201d\u72b6\u6001\uff1b\u5f53\u8fdb\u7a0b\u7ec8\u4e8e\u5360\u7528CPU\uff0c\u7a0b\u5e8f\u7684\u6307\u4ee4\u88abCPU\u4e00\u6761\u4e00\u6761\u6267\u884c\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u8fdb\u7a0b\u5c31\u8fdb\u5165\u4e86\u201c\u8fd0\u884c\u201d\u72b6\u6001\uff0c\u8fd9\u65f6\u9664\u4e86\u7ee7\u7eed\u5360\u7528\u5185\u5b58\u8d44\u6e90\u5916\uff0c\u8fd8\u5360\u7528\u4e86CPU\u8d44\u6e90\uff1b\u5f53\u8fdb\u7a0b\u7531\u4e8e\u7b49\u5f85\u67d0\u4e2a\u8d44\u6e90\u800c\u65e0\u6cd5\u7ee7\u7eed\u6267\u884c\u65f6\uff0c\u8fdb\u7a0b\u53ef\u653e\u5f03CPU\u4f7f\u7528\uff0c\u5373\u91ca\u653eCPU\u8d44\u6e90\uff0c\u8fdb\u5165\u201c\u7b49\u5f85\u201d\u72b6\u6001\uff1b\u5f53\u7a0b\u5e8f\u6307\u4ee4\u6267\u884c\u5b8c\u6bd5\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u56de\u6536\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u8d44\u6e90\u65f6\uff0c\u8fdb\u7a0b\u8fdb\u5165\u4e86\u201c\u6b7b\u4ea1\u201d\u72b6\u6001\u3002</p> <p>\u8fd9\u4e9b\u8fdb\u7a0b\u72b6\u6001\u7684\u8f6c\u6362\u65f6\u673a\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u8d77\u6765\uff0c\u800c\u4e14\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u6e05\u9664\u7b49\u670d\u52a1\u5fc5\u987b\u7531\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\uff0c\u800c\u4e14\u5728\u201c\u8fd0\u884c\u201d\u4e0e\u201c\u5c31\u7eea\u201d/\u201c\u7b49\u5f85\u201d\u72b6\u6001\u4e4b\u95f4\u7684\u8f6c\u6362\uff0c\u6d89\u53ca\u5230\u4fdd\u5b58\u548c\u6062\u590d\u8fdb\u7a0b\u7684\u201c\u6267\u884c\u73b0\u573a\u201d\uff0c\u4e5f\u5c31\u662f\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff0c\u8fd9\u662f\u786e\u4fdd\u8fdb\u7a0b\u5373\u4f7f\u201c\u65ad\u65ad\u7eed\u7eed\u201d\u5730\u6267\u884c\uff0c\u4e5f\u80fd\u6b63\u786e\u5b8c\u6210\u5de5\u4f5c\u7684\u5fc5\u8981\u4fdd\u8bc1\u3002</p>"},{"location":"lab4/appendix/#3","title":"3. \u8fdb\u7a0b\u4e0e\u7ebf\u7a0b","text":"<p>\u4e00\u4e2a\u8fdb\u7a0b\u62e5\u6709\u4e00\u4e2a\u5b58\u653e\u7a0b\u5e8f\u548c\u6570\u636e\u7684\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4ee5\u53ca\u5176\u4ed6\u8d44\u6e90\u3002\u4e00\u4e2a\u8fdb\u7a0b\u57fa\u4e8e\u7a0b\u5e8f\u7684\u6307\u4ee4\u6d41\u6267\u884c\uff0c\u5176\u6267\u884c\u8fc7\u7a0b\u53ef\u80fd\u4e0e\u5176\u5b83\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u4ea4\u66ff\u8fdb\u884c\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u5177\u6709\u6267\u884c\u72b6\u6001\uff08\u8fd0\u884c\u6001\u3001\u5c31\u7eea\u6001\u7b49\uff09\u7684\u8fdb\u7a0b\u662f\u4e00\u4e2a\u88ab\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u8d44\u6e90\uff08\u6bd4\u5982\u5206\u914d\u5185\u5b58\uff09\u5e76\u8c03\u5ea6\uff08\u6bd4\u5982\u5206\u65f6\u4f7f\u7528CPU\uff09\u7684\u5355\u4f4d\u3002\u5728\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u4e24\u4e2a\u7279\u70b9\u662f\u8fdb\u7a0b\u7684\u4e3b\u8981\u672c\u8d28\u7279\u5f81\u3002\u4f46\u8fd9\u4e24\u4e2a\u7279\u5f81\u76f8\u5bf9\u72ec\u7acb\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u628a\u8fd9\u4e24\u4e2a\u7279\u5f81\u5206\u522b\u8fdb\u884c\u7ba1\u7406\u3002</p> <p>\u8fd9\u6837\u53ef\u4ee5\u628a\u62e5\u6709\u8d44\u6e90\u6240\u6709\u6743\u7684\u5355\u4f4d\u901a\u5e38\u4ecd\u79f0\u4f5c\u8fdb\u7a0b\uff0c\u5bf9\u8d44\u6e90\u7684\u7ba1\u7406\u6210\u4e3a\u8fdb\u7a0b\u7ba1\u7406\uff1b\u628a\u6307\u4ee4\u6267\u884c\u6d41\u7684\u5355\u4f4d\u79f0\u4e3a\u7ebf\u7a0b\uff0c\u5bf9\u7ebf\u7a0b\u7684\u7ba1\u7406\u5c31\u662f\u7ebf\u7a0b\u8c03\u5ea6\u548c\u7ebf\u7a0b\u5206\u6d3e\u3002\u5bf9\u5c5e\u4e8e\u540c\u4e00\u8fdb\u7a0b\u7684\u6240\u6709\u7ebf\u7a0b\u800c\u8a00\uff0c\u8fd9\u4e9b\u7ebf\u7a0b\u5171\u4eab\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u548c\u5176\u4ed6\u8d44\u6e90\uff0c\u4f46\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u6808\uff0c\u8fd8\u6709\u72ec\u7acb\u7684\u7ebf\u7a0b\u8fd0\u884c\u4e0a\u4e0b\u6587\uff0c\u7528\u4e8e\u5305\u542b\u8868\u793a\u7ebf\u7a0b\u6267\u884c\u73b0\u573a\u7684\u5bc4\u5b58\u5668\u503c\u7b49\u4fe1\u606f\u3002</p> <p>\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\uff0c\u8fdb\u7a0b\u88ab\u5b9a\u4e49\u6210\u8d44\u6e90\u5206\u914d\u4e0e\u4fdd\u62a4\u7684\u5355\u4f4d\uff0c\u4e0e\u8fdb\u7a0b\u76f8\u5173\u8054\u7684\u4fe1\u606f\u4e3b\u8981\u6709\u5b58\u653e\u8fdb\u7a0b\u6620\u50cf\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7b49\u3002\u5728\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\uff0c\u53ef\u80fd\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u7ebf\u7a0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u7ebf\u7a0b\u6267\u884c\u72b6\u6001\uff08\u8fd0\u884c\u3001\u5c31\u7eea\u3001\u7b49\u5f85\u7b49\uff09\uff0c\u4fdd\u5b58\u4e0a\u6b21\u8fd0\u884c\u65f6\u7684\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u3001\u7ebf\u7a0b\u7684\u6267\u884c\u6808\u7b49\u3002\u8003\u8651\u5230CPU\u6709\u4e0d\u540c\u7684\u7279\u6743\u6a21\u5f0f\uff0c\u53c2\u7167\u8fdb\u7a0b\u7684\u5206\u7c7b\uff0c\u7ebf\u7a0b\u53c8\u53ef\u8fdb\u4e00\u6b65\u7ec6\u5316\u4e3a\u7528\u6237\u7ebf\u7a0b\u548c\u5185\u6838\u7ebf\u7a0b\u3002</p> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u660e\u786e\u7528\u6237\u8fdb\u7a0b\u3001\u5185\u6838\u8fdb\u7a0b\uff08\u53ef\u628aucore\u770b\u6210\u4e00\u4e2a\u5185\u6838\u8fdb\u7a0b\uff09\u3001\u7528\u6237\u7ebf\u7a0b\u3001\u5185\u6838\u7ebf\u7a0b\u7684\u533a\u522b\u4e86\u3002\u4ece\u672c\u8d28\u4e0a\u770b\uff0c\u7ebf\u7a0b\u5c31\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u4e0d\u7528\u62e5\u6709\u8d44\u6e90\u7684\u8f7b\u91cf\u7ea7\u8fdb\u7a0b\uff0c\u5728ucore\u7684\u8c03\u5ea6\u548c\u6267\u884c\u7ba1\u7406\u4e2d\uff0c\u5e76\u6ca1\u6709\u533a\u5206\u7ebf\u7a0b\u548c\u8fdb\u7a0b\u3002\u4e14\u7531\u4e8eucore\u5185\u6838\u4e2d\u7684\u6240\u6709\u5185\u6838\u7ebf\u7a0b\u5171\u4eab\u4e00\u4e2a\u5185\u6838\u5730\u5740\u7a7a\u95f4\u548c\u5176\u4ed6\u8d44\u6e90\uff0c\u6240\u4ee5\u8fd9\u4e9b\u5185\u6838\u7ebf\u7a0b\u4ece\u5c5e\u4e8e\u540c\u4e00\u4e2a\u552f\u4e00\u7684\u5185\u6838\u8fdb\u7a0b\uff0c\u5373ucore\u5185\u6838\u672c\u8eab\u3002\u7406\u89e3\u4e86\u8fdb\u7a0b\u6216\u7ebf\u7a0b\u7684\u4e0a\u8ff0\u5c5e\u6027\u548c\u7279\u5f81\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u8fdb\u7a0b/\u7ebf\u7a0b\u7ba1\u7406\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u4e86\u3002\u4f46\u662f\u4e3a\u4e86\u53d9\u8ff0\u4e0a\u7684\u7b80\u4fbf\uff0c\u4ee5\u4e0b\u7528\u6237\u6001\u7684\u8fdb\u7a0b/\u7ebf\u7a0b\u7edf\u79f0\u4e3a\u7528\u6237\u8fdb\u7a0b\u3002</p>"},{"location":"lab4/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab4/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB4    := -DLAB4_EX1 -DLAB4_EX2(\u7b2c9\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\nLAB4    := -DLAB4_EX1 -DLAB4_EX2\n# LAB5  := -DLAB5_EX1 -DLAB5_EX2\n# LAB6  := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0020000 (phys)\nedata 0xA0153CF0 (phys)\nend   0xA0156FD0 (phys)\nKernel executable memory footprint: 1244KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0197000\nfree pages: 00001E69\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nsched class: RR_scheduler\nproc_init succeeded\nthis initproc, pid = 1, name = \"init\"\nTo U: \"(null)\".\nTo U: \"en.., Bye, Bye. :)\"\nkernel panic at kern/process/proc.c:1274:\n    LAB4 Check Passed!\nWelcome to the kernel debug monitor!!\nType 'help' for a list of commands.\nK&gt; </code></pre></p>"},{"location":"lab4/kthread/","title":"\u5185\u6838\u7ebf\u7a0b","text":""},{"location":"lab4/kthread/#_1","title":"\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406","text":""},{"location":"lab4/kthread/#_2","title":"\u521b\u5efa\u5e76\u6267\u884c\u5185\u6838\u7ebf\u7a0b","text":"<p>\u5efa\u7acb\u8fdb\u7a0b\u63a7\u5236\u5757\uff08proc.c\u4e2d\u7684alloc_proc\u51fd\u6570\uff09\u540e\uff0c\u73b0\u5728\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fdb\u7a0b\u63a7\u5236\u5757\u6765\u521b\u5efa\u5177\u4f53\u7684\u8fdb\u7a0b/\u7ebf\u7a0b\u4e86\u3002\u9996\u5148\uff0c\u8003\u8651\u6700\u7b80\u5355\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u5b83\u901a\u5e38\u53ea\u662f\u5185\u6838\u4e2d\u7684\u4e00\u5c0f\u6bb5\u4ee3\u7801\u6216\u8005\u51fd\u6570\uff0c\u6ca1\u6709\u81ea\u5df1\u7684\u201c\u4e13\u5c5e\u201d\u7a7a\u95f4\u3002\u8fd9\u662f\u7531\u4e8e\u5728uCore OS\u542f\u52a8\u540e\uff0c\u5df2\u7ecf\u5bf9\u6574\u4e2a\u5185\u6838\u5185\u5b58\u7a7a\u95f4\u8fdb\u884c\u4e86\u7ba1\u7406\uff0c\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u5efa\u7acb\u4e86\u5185\u6838\u865a\u62df\u7a7a\u95f4\uff08\u5373boot_cr3\u6307\u5411\u7684\u4e8c\u7ea7\u9875\u8868\u63cf\u8ff0\u7684\u7a7a\u95f4\uff09\u3002\u6240\u4ee5uCore OS\u5185\u6838\u4e2d\u7684\u6240\u6709\u7ebf\u7a0b\u90fd\u4e0d\u9700\u8981\u518d\u5efa\u7acb\u5404\u81ea\u7684\u9875\u8868\uff0c\u53ea\u9700\u5171\u4eab\u8fd9\u4e2a\u5185\u6838\u865a\u62df\u7a7a\u95f4\u5c31\u53ef\u4ee5\u8bbf\u95ee\u6574\u4e2a\u7269\u7406\u5185\u5b58\u4e86\u3002\u4ece\u8fd9\u4e2a\u89d2\u5ea6\u770b\uff0c\u5185\u6838\u7ebf\u7a0b\u88abuCore OS\u5185\u6838\u8fd9\u4e2a\u5927\u201c\u5185\u6838\u8fdb\u7a0b\u201d\u6240\u7ba1\u7406\u3002</p>"},{"location":"lab4/kthread/#-","title":"\u5173\u952e\u6570\u636e\u7ed3\u6784 -- \u8fdb\u7a0b\u63a7\u5236\u5757","text":"<p>\u5728\u5b9e\u9a8c\u56db\u4e2d\uff0c\u8fdb\u7a0b\u7ba1\u7406\u4fe1\u606f\u7528struct proc_struct\u8868\u793a\uff0c\u5728*kern/process/proc.h*\u4e2d\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct proc_struct {\n    enum proc_state state;                      // Process state\n    int pid;                                    // Process ID\n    int runs;                                   // the running times of Proces\n    uintptr_t kstack;                           // Process kernel stack\n    volatile bool need_resched;                 // bool value: need to be rescheduled to release CPU?\n    struct proc_struct *parent;                 // the parent process\n    struct mm_struct *mm;                       // Process's memory management field\n    struct context context;                     // Switch here to run process\n    struct trapframe *tf;                       // Trap frame for current interrupt\n    uintptr_t cr3;                              // the base addr of Page Directroy Table(PDT)\n    uint32_t flags;                             // Process flag\n    char name[PROC_NAME_LEN + 1];               // Process name\n    list_entry_t list_link;                     // Process link list \n    list_entry_t hash_link;                     // Process hash list\n    int exit_code;                              // exit code (be sent to parent proc)\n    uint32_t wait_state;                        // waiting state\n    struct proc_struct *cptr, *yptr, *optr;     // relations between processes\n    struct run_queue *rq;                       // running queue contains Process\n    list_entry_t run_link;                      // the entry linked in run queue\n    int time_slice;                             // time slice for occupying the CPU\n    struct fs_struct *fs_struct;                // the file related info(pwd, files_count, files_array, fs_semaphore) of process\n};\n</code></pre> <p>\u4e0b\u9762\u91cd\u70b9\u89e3\u91ca\u4e00\u4e0b\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u6210\u5458\u53d8\u91cf\uff1a</p> <ul> <li> <p>mm\uff1a\u5185\u5b58\u7ba1\u7406\u7684\u4fe1\u606f\uff0c\u5305\u62ec\u5185\u5b58\u6620\u5c04\u5217\u8868\u3001\u9875\u8868\u6307\u9488\u7b49\u3002mm\u6210\u5458\u53d8\u91cf\u5728lab3\u4e2d\u7528\u4e8e\u865a\u5b58\u7ba1\u7406\u3002\u4f46\u5728\u5b9e\u9645OS\u4e2d\uff0c\u5185\u6838\u7ebf\u7a0b\u5e38\u9a7b\u5185\u5b58\uff0c\u4e0d\u9700\u8981\u8003\u8651swap page\u95ee\u9898\uff0c\u5728lab5\u4e2d\u6d89\u53ca\u5230\u4e86\u7528\u6237\u8fdb\u7a0b\uff0c\u624d\u8003\u8651\u8fdb\u7a0b\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u7684swap page\u95ee\u9898\uff0cmm\u624d\u4f1a\u53d1\u6325\u4f5c\u7528\u3002\u6240\u4ee5\u5728lab4\u4e2dmm\u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\u5c31\u6ca1\u6709\u7528\u4e86\uff0c\u8fd9\u6837\u5185\u6838\u7ebf\u7a0b\u7684proc_struct\u7684\u6210\u5458\u53d8\u91cf*mm=0\u662f\u5408\u7406\u7684\u3002mm\u91cc\u6709\u4e2a\u5f88\u91cd\u8981\u7684\u9879pgdir\uff0c\u8bb0\u5f55\u7684\u662f\u8be5\u8fdb\u7a0b\u4f7f\u7528\u7684\u4e00\u7ea7\u9875\u8868\u7684\u7269\u7406\u5730\u5740\u3002\u7531\u4e8e*mm=NULL\uff0c\u6240\u4ee5\u5728proc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u9700\u8981\u6709\u4e00\u4e2a\u4ee3\u66ffpgdir\u9879\u6765\u8bb0\u5f55\u9875\u8868\u8d77\u59cb\u5730\u5740\uff0c\u8fd9\u5c31\u662fproc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u7684cr3\u6210\u5458\u53d8\u91cf\u3002</p> </li> <li> <p>state\uff1a\u8fdb\u7a0b\u6240\u5904\u7684\u72b6\u6001\u3002</p> </li> <li> <p>parent\uff1a\u7528\u6237\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff08\u521b\u5efa\u5b83\u7684\u8fdb\u7a0b\uff09\u3002\u5728\u6240\u6709\u8fdb\u7a0b\u4e2d\uff0c\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u6709\u7236\u8fdb\u7a0b\uff0c\u5c31\u662f\u5185\u6838\u521b\u5efa\u7684\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0bidleproc\u3002\u5185\u6838\u6839\u636e\u8fd9\u4e2a\u7236\u5b50\u5173\u7cfb\u5efa\u7acb\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\uff0c\u7528\u4e8e\u7ef4\u62a4\u4e00\u4e9b\u7279\u6b8a\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u786e\u5b9a\u67d0\u4e2a\u8fdb\u7a0b\u662f\u5426\u53ef\u4ee5\u5bf9\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u67d0\u79cd\u64cd\u4f5c\u7b49\u7b49\u3002</p> </li> <li> <p>context\uff1a\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\uff0c\u7528\u4e8e\u8fdb\u7a0b\u5207\u6362\uff08\u53c2\u89c1switch.S\uff09\u3002\u5728 uCore\u4e2d\uff0c\u6240\u6709\u7684\u8fdb\u7a0b\u5728\u5185\u6838\u4e2d\u4e5f\u662f\u76f8\u5bf9\u72ec\u7acb\u7684\uff08\u4f8b\u5982\u72ec\u7acb\u7684\u5185\u6838\u5806\u6808\u4ee5\u53ca\u4e0a\u4e0b\u6587\u7b49\u7b49\uff09\u3002\u4f7f\u7528 context \u4fdd\u5b58\u5bc4\u5b58\u5668\u7684\u76ee\u7684\u5c31\u5728\u4e8e\u5728\u5185\u6838\u6001\u4e2d\u80fd\u591f\u8fdb\u884c\u4e0a\u4e0b\u6587\u4e4b\u95f4\u7684\u5207\u6362\u3002\u5b9e\u9645\u5229\u7528context\u8fdb\u884c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u51fd\u6570\u662f\u5728*kern/process/switch.S*\u4e2d\u5b9a\u4e49switch_to\u3002</p> </li> <li> <p>tf\uff1a\u4e2d\u65ad\u5e27\u7684\u6307\u9488\uff0c\u603b\u662f\u6307\u5411\u5185\u6838\u6808\u7684\u67d0\u4e2a\u4f4d\u7f6e\uff1a\u5f53\u8fdb\u7a0b\u4ece\u7528\u6237\u7a7a\u95f4\u8df3\u5230\u5185\u6838\u7a7a\u95f4\u65f6\uff0c\u4e2d\u65ad\u5e27\u8bb0\u5f55\u4e86\u8fdb\u7a0b\u5728\u88ab\u4e2d\u65ad\u524d\u7684\u72b6\u6001\u3002\u5f53\u5185\u6838\u9700\u8981\u8df3\u56de\u7528\u6237\u7a7a\u95f4\u65f6\uff0c\u9700\u8981\u8c03\u6574\u4e2d\u65ad\u5e27\u4ee5\u6062\u590d\u8ba9\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u7684\u5404\u5bc4\u5b58\u5668\u503c\u3002\u9664\u6b64\u4e4b\u5916\uff0cuCore\u5185\u6838\u5141\u8bb8\u5d4c\u5957\u4e2d\u65ad\u3002\u56e0\u6b64\u4e3a\u4e86\u4fdd\u8bc1\u5d4c\u5957\u4e2d\u65ad\u53d1\u751f\u65f6tf \u603b\u662f\u80fd\u591f\u6307\u5411\u5f53\u524d\u7684trapframe\uff0cuCore \u5728\u5185\u6838\u6808\u4e0a\u7ef4\u62a4\u4e86 tf \u7684\u94fe\uff0c\u53ef\u4ee5\u53c2\u8003trap.c::trap\u51fd\u6570\u505a\u8fdb\u4e00\u6b65\u7684\u4e86\u89e3\u3002</p> </li> <li> <p>cr3: cr3\u662fx86\u6307\u4ee4\u96c6\u4e2d\u4fdd\u5b58\u9875\u8868\u57fa\u5730\u5740\u7684CSR\uff0c\u8fd9\u662f\u56e0\u4e3ax86\u91c7\u7528\u786c\u4ef6\u904d\u5386\u9875\u8868\u5b8c\u6210TLB\u586b\u5145\u3002\u800c\u5728LoongArch32\u7248\u672c\u7684uCore\u4e2d\uff0c\u8f6f\u4ef6\u5b9a\u4e49\u9875\u8868\u4f7f\u5f97\u6211\u4eec\u4e0d\u5fc5\u5728\u786c\u4ef6\u4e0a\u4fdd\u7559\u8be5\u5bc4\u5b58\u5668\uff0c\u4f46uCore\u7ee7\u7eed\u4fdd\u7559\u4e86\u8be5\u540d\u79f0\u5e76\u7528\u4e8e\u6307\u4ee3\u9875\u8868\u57fa\u5730\u5740\u3002\u76ee\u7684\u5c31\u662f\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u65b9\u4fbf\u76f4\u63a5\u4f7f\u7528 lcr3 \u5b9e\u73b0\u9875\u8868\u5207\u6362\uff0c\u907f\u514d\u6bcf\u6b21\u90fd\u6839\u636e mm \u6765\u8ba1\u7b97 cr3\u3002mm\u6570\u636e\u7ed3\u6784\u662f\u7528\u6765\u5b9e\u73b0\u7528\u6237\u7a7a\u95f4\u7684\u865a\u5b58\u7ba1\u7406\u7684\uff0c\u4f46\u662f\u5185\u6838\u7ebf\u7a0b\u6ca1\u6709\u7528\u6237\u7a7a\u95f4\uff0c\u5b83\u6267\u884c\u7684\u53ea\u662f\u5185\u6838\u4e2d\u7684\u4e00\u5c0f\u6bb5\u4ee3\u7801\uff08\u901a\u5e38\u662f\u4e00\u5c0f\u6bb5\u51fd\u6570\uff09\uff0c\u6240\u4ee5\u5b83\u6ca1\u6709mm \u7ed3\u6784\uff0c\u4e5f\u5c31\u662fNULL\u3002\u5f53\u67d0\u4e2a\u8fdb\u7a0b\u662f\u4e00\u4e2a\u666e\u901a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u65f6\u5019\uff0cPCB \u4e2d\u7684 cr3 \u5c31\u662f mm \u4e2d\u9875\u8868\uff08pgdir\uff09\u7684\u7269\u7406\u5730\u5740\uff1b\u800c\u5f53\u5b83\u662f\u5185\u6838\u7ebf\u7a0b\u7684\u65f6\u5019\uff0ccr3 \u7b49\u4e8eboot_cr3\u3002\u800cboot_cr3\u6307\u5411\u4e86uCore\u542f\u52a8\u65f6\u5efa\u7acb\u597d\u7684\u997f\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u9875\u76ee\u5f55\u8868\u9996\u5730\u5740\u3002</p> </li> <li> <p>kstack: \u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u5185\u6838\u6808\uff0c\u5e76\u4e14\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\u7684\u4e0d\u540c\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\uff0c\u8be5\u6808\u5c31\u662f\u8fd0\u884c\u65f6\u7684\u7a0b\u5e8f\u4f7f\u7528\u7684\u6808\uff1b\u800c\u5bf9\u4e8e\u666e\u901a\u8fdb\u7a0b\uff0c\u8be5\u6808\u662f\u53d1\u751f\u7279\u6743\u7ea7\u6539\u53d8\u7684\u65f6\u5019\u4f7f\u4fdd\u5b58\u88ab\u6253\u65ad\u7684\u786c\u4ef6\u4fe1\u606f\u7528\u7684\u6808\u3002uCore\u5728\u521b\u5efa\u8fdb\u7a0b\u65f6\u5206\u914d\u4e86 2 \u4e2a\u8fde\u7eed\u7684\u7269\u7406\u9875\uff08\u53c2\u89c1memlayout.h\u4e2dKSTACKSIZE\u7684\u5b9a\u4e49\uff09\u4f5c\u4e3a\u5185\u6838\u6808\u7684\u7a7a\u95f4\u3002\u8fd9\u4e2a\u6808\u5f88\u5c0f\uff0c\u6240\u4ee5\u5185\u6838\u4e2d\u7684\u4ee3\u7801\u5e94\u8be5\u5c3d\u53ef\u80fd\u7684\u7d27\u51d1\uff0c\u5e76\u4e14\u907f\u514d\u5728\u6808\u4e0a\u5206\u914d\u5927\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ee5\u514d\u6808\u6ea2\u51fa\uff0c\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002kstack\u8bb0\u5f55\u4e86\u5206\u914d\u7ed9\u8be5\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u5185\u6838\u6808\u7684\u4f4d\u7f6e\u3002\u4e3b\u8981\u4f5c\u7528\u6709\u4ee5\u4e0b\u51e0\u70b9\u3002\u9996\u5148\uff0c\u5f53\u5185\u6838\u51c6\u5907\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7684\u65f6\u5019\uff0c\u9700\u8981\u6839\u636ekstack \u7684\u503c\u6b63\u786e\u7684\u8bbe\u7f6e\u597d tss \uff08\u53ef\u4ee5\u56de\u987e\u4e00\u4e0b\u5728\u5b9e\u9a8c\u4e00\u4e2d\u8bb2\u8ff0\u7684 tss \u5728\u4e2d\u65ad\u5904\u7406\u8fc7\u7a0b\u4e2d\u7684\u4f5c\u7528\uff09\uff0c\u4ee5\u4fbf\u5728\u8fdb\u7a0b\u5207\u6362\u4ee5\u540e\u518d\u53d1\u751f\u4e2d\u65ad\u65f6\u80fd\u591f\u4f7f\u7528\u6b63\u786e\u7684\u6808\u3002\u5176\u6b21\uff0c\u5185\u6838\u6808\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\uff0c\u5e76\u4e14\u662f\u4e0d\u5171\u4eab\u7684\uff08\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u62e5\u6709\u81ea\u5df1\u7684\u5185\u6838\u6808\uff09\uff0c\u56e0\u6b64\u4e0d\u53d7\u5230 mm \u7684\u7ba1\u7406\uff0c\u5f53\u8fdb\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u5185\u6838\u80fd\u591f\u6839\u636e kstack \u7684\u503c\u5feb\u901f\u5b9a\u4f4d\u6808\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u56de\u6536\u3002uCore \u7684\u8fd9\u79cd\u5185\u6838\u6808\u7684\u8bbe\u8ba1\u501f\u9274\u7684\u662f linux \u7684\u65b9\u6cd5\uff08\u4f46\u7531\u4e8e\u5185\u5b58\u7ba1\u7406\u5b9e\u73b0\u7684\u5dee\u5f02\uff0c\u5b83\u5b9e\u73b0\u7684\u8fdc\u4e0d\u5982 linux \u7684\u7075\u6d3b\uff09\uff0c\u5b83\u4f7f\u5f97\u6bcf\u4e2a\u7ebf\u7a0b\u7684\u5185\u6838\u6808\u5728\u4e0d\u540c\u7684\u4f4d\u7f6e\uff0c\u8fd9\u6837\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u65b9\u4fbf\u8c03\u8bd5\uff0c\u4f46\u540c\u65f6\u4e5f\u4f7f\u5f97\u5185\u6838\u5bf9\u6808\u6ea2\u51fa\u53d8\u5f97\u5341\u5206\u4e0d\u654f\u611f\uff0c\u56e0\u4e3a\u4e00\u65e6\u53d1\u751f\u6ea2\u51fa\uff0c\u5b83\u6781\u53ef\u80fd\u6c61\u67d3\u5185\u6838\u4e2d\u5176\u5b83\u7684\u6570\u636e\u4f7f\u5f97\u5185\u6838\u5d29\u6e83\u3002\u5982\u679c\u80fd\u591f\u901a\u8fc7\u9875\u8868\uff0c\u5c06\u6240\u6709\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u6620\u5c04\u5230\u56fa\u5b9a\u7684\u5730\u5740\u4e0a\u53bb\uff0c\u80fd\u591f\u907f\u514d\u8fd9\u79cd\u95ee\u9898\uff0c\u4f46\u53c8\u4f1a\u4f7f\u5f97\u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b\u4e2d\u5bf9\u6808\u7684\u4fee\u6539\u53d8\u5f97\u76f8\u5f53\u7e41\u7410\u3002\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u53c2\u8003 linux kernel \u7684\u4ee3\u7801\u5bf9\u6b64\u8fdb\u884c\u5c1d\u8bd5\u3002</p> </li> </ul> <p>\u4e3a\u4e86\u7ba1\u7406\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\uff0cuCore\u7ef4\u62a4\u4e86\u5982\u4e0b\u5168\u5c40\u53d8\u91cf\uff08\u4f4d\u4e8e*kern/process/proc.c*\uff09\uff1a</p> <ul> <li> <p>static struct proc *current\uff1a\u5f53\u524d\u5360\u7528CPU\u4e14\u5904\u4e8e\u201c\u8fd0\u884c\u201d\u72b6\u6001\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u3002\u901a\u5e38\u8fd9\u4e2a\u53d8\u91cf\u662f\u53ea\u8bfb\u7684\uff0c\u53ea\u6709\u5728\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u624d\u8fdb\u884c\u4fee\u6539\uff0c\u5e76\u4e14\u6574\u4e2a\u5207\u6362\u548c\u4fee\u6539\u8fc7\u7a0b\u9700\u8981\u4fdd\u8bc1\u64cd\u4f5c\u7684\u539f\u5b50\u6027\uff0c\u76ee\u524d\u81f3\u5c11\u9700\u8981\u5c4f\u853d\u4e2d\u65ad\u3002\u53ef\u4ee5\u53c2\u8003 switch_to \u7684\u5b9e\u73b0\u3002</p> </li> <li> <p>static struct proc *initproc\uff1a\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6307\u5411\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u3002\u672c\u5b9e\u9a8c\u4ee5\u540e\uff0c\u6b64\u6307\u9488\u5c06\u6307\u5411\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u3002</p> </li> <li> <p>static list_entry_t hash_list[HASH_LIST_SIZE]\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u54c8\u5e0c\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cfhash_link\u5c06\u57fa\u4e8epid\u94fe\u63a5\u5165\u8fd9\u4e2a\u54c8\u5e0c\u8868\u4e2d\u3002</p> </li> <li> <p>list_entry_t proc_list\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u53cc\u5411\u7ebf\u6027\u5217\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cflist_link\u5c06\u94fe\u63a5\u5165\u8fd9\u4e2a\u94fe\u8868\u4e2d\u3002</p> </li> </ul>"},{"location":"lab4/kthread/#0-idleproc","title":"\u521b\u5efa\u7b2c 0 \u4e2a\u5185\u6838\u7ebf\u7a0b idleproc","text":"<p>\u5728init.c::kern_init\u51fd\u6570\u8c03\u7528\u4e86proc.c::proc_init\u51fd\u6570\u3002proc_init\u51fd\u6570\u542f\u52a8\u4e86\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\u7684\u6b65\u9aa4\u3002\u9996\u5148\u5f53\u524d\u7684\u6267\u884c\u4e0a\u4e0b\u6587\uff08\u4ecekern_init \u542f\u52a8\u81f3\u4eca\uff09\u5c31\u53ef\u4ee5\u770b\u6210\u662fuCore\u5185\u6838\uff08\u4e5f\u53ef\u770b\u505a\u662f\u5185\u6838\u8fdb\u7a0b\uff09\u4e2d\u7684\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u3002\u4e3a\u6b64\uff0cuCore\u901a\u8fc7\u7ed9\u5f53\u524d\u6267\u884c\u7684\u4e0a\u4e0b\u6587\u5206\u914d\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u4ee5\u53ca\u5bf9\u5b83\u8fdb\u884c\u76f8\u5e94\u521d\u59cb\u5316\uff0c\u5c06\u5176\u6253\u9020\u6210\u7b2c0\u4e2a\u5185\u6838\u7ebf\u7a0b -- idleproc\u3002\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <p>\u9996\u5148\u8c03\u7528alloc_proc\u51fd\u6570\u6765\u901a\u8fc7kmalloc\u51fd\u6570\u83b7\u5f97proc_struct\u7ed3\u6784\u7684\u4e00\u5757\u5185\u5b58\u5757-\uff0c\u4f5c\u4e3a\u7b2c0\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u3002\u5e76\u628aproc\u8fdb\u884c\u521d\u6b65\u521d\u59cb\u5316\uff08\u5373\u628aproc_struct\u4e2d\u7684\u5404\u4e2a\u6210\u5458\u53d8\u91cf\u6e05\u96f6\uff09\u3002\u4f46\u6709\u4e9b\u6210\u5458\u53d8\u91cf\u8bbe\u7f6e\u4e86\u7279\u6b8a\u7684\u503c\uff0c\u6bd4\u5982\uff1a</p> <pre><code> proc-&gt;state = PROC_UNINIT;  \u8bbe\u7f6e\u8fdb\u7a0b\u4e3a\u201c\u521d\u59cb\u201d\u6001\n proc-&gt;pid = -1;             \u8bbe\u7f6e\u8fdb\u7a0bpid\u7684\u672a\u521d\u59cb\u5316\u503c\n proc-&gt;cr3 = boot_cr3;       \u4f7f\u7528\u5185\u6838\u9875\u76ee\u5f55\u8868\u7684\u57fa\u5740\n ...\n</code></pre> <p>\u4e0a\u8ff0\u4e09\u6761\u8bed\u53e5\u4e2d,\u7b2c\u4e00\u6761\u8bbe\u7f6e\u4e86\u8fdb\u7a0b\u7684\u72b6\u6001\u4e3a\u201c\u521d\u59cb\u201d\u6001\uff0c\u8fd9\u8868\u793a\u8fdb\u7a0b\u5df2\u7ecf\u201c\u51fa\u751f\u201d\u4e86\uff0c\u6b63\u5728\u83b7\u53d6\u8d44\u6e90\u8301\u58ee\u6210\u957f\u4e2d\uff1b\u7b2c\u4e8c\u6761\u8bed\u53e5\u8bbe\u7f6e\u4e86\u8fdb\u7a0b\u7684pid\u4e3a-1\uff0c\u8fd9\u8868\u793a\u8fdb\u7a0b\u7684\u201c\u8eab\u4efd\u8bc1\u53f7\u201d\u8fd8\u6ca1\u6709\u529e\u597d\uff1b\u7b2c\u4e09\u6761\u8bed\u53e5\u8868\u660e\u7531\u4e8e\u8be5\u5185\u6838\u7ebf\u7a0b\u5728\u5185\u6838\u4e2d\u8fd0\u884c\uff0c\u6545\u91c7\u7528\u4e3auCore\u5185\u6838\u5df2\u7ecf\u5efa\u7acb\u7684\u9875\u8868\uff0c\u5373\u8bbe\u7f6e\u4e3a\u5728uCore\u5185\u6838\u9875\u8868\u7684\u8d77\u59cb\u5730\u5740boot_cr3\u3002\u540e\u7eed\u5b9e\u9a8c\u4e2d\u53ef\u8fdb\u4e00\u6b65\u770b\u51fa\u6240\u6709\u5185\u6838\u7ebf\u7a0b\u7684\u5185\u6838\u865a\u5730\u5740\u7a7a\u95f4\uff08\u4e5f\u5305\u62ec\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff09\u662f\u76f8\u540c\u7684\u3002\u65e2\u7136\u5185\u6838\u7ebf\u7a0b\u5171\u7528\u4e00\u4e2a\u6620\u5c04\u5185\u6838\u7a7a\u95f4\u7684\u9875\u8868\uff0c\u8fd9\u8868\u793a\u5185\u6838\u7a7a\u95f4\u5bf9\u6240\u6709\u5185\u6838\u7ebf\u7a0b\u90fd\u662f\u201c\u53ef\u89c1\u201d\u7684\uff0c\u6240\u4ee5\u66f4\u7cbe\u786e\u5730\u8bf4\uff0c\u8fd9\u4e9b\u5185\u6838\u7ebf\u7a0b\u90fd\u5e94\u8be5\u662f\u4ece\u5c5e\u4e8e\u540c\u4e00\u4e2a\u552f\u4e00\u7684\u201c\u5927\u5185\u6838\u8fdb\u7a0b\u201d\u2014uCore\u5185\u6838\u3002</p> <p>\u63a5\u4e0b\u6765\uff0cproc_init\u51fd\u6570\u5bf9idleproc\u5185\u6838\u7ebf\u7a0b\u8fdb\u884c\u8fdb\u4e00\u6b65\u521d\u59cb\u5316\uff1a</p> <pre><code>idleproc-&gt;pid = 0;\nidleproc-&gt;state = PROC_RUNNABLE;\nidleproc-&gt;kstack = (uintptr_t)bootstack;\nidleproc-&gt;need_resched = 1;\nset_proc_name(idleproc, \"idle\");\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u524d4\u6761\u8bed\u53e5\u3002\u7b2c\u4e00\u6761\u8bed\u53e5\u7ed9\u4e86idleproc\u5408\u6cd5\u7684\u8eab\u4efd\u8bc1\u53f7--0\uff0c\u8fd9\u540d\u6b63\u8a00\u987a\u5730\u8868\u660e\u4e86idleproc\u662f\u7b2c0\u4e2a\u5185\u6838\u7ebf\u7a0b\u3002\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7pid\u7684\u8d4b\u503c\u6765\u8868\u793a\u7ebf\u7a0b\u7684\u521b\u5efa\u548c\u8eab\u4efd\u786e\u5b9a\u3002\u201c0\u201d\u662f\u7b2c\u4e00\u4e2a\u7684\u8868\u793a\u65b9\u6cd5\u662f\u8ba1\u7b97\u673a\u9886\u57df\u6240\u7279\u6709\u7684\uff0c\u6bd4\u5982C\u8bed\u8a00\u5b9a\u4e49\u7684\u7b2c\u4e00\u4e2a\u6570\u7ec4\u5143\u7d20\u7684\u5c0f\u6807\u4e5f\u662f\u201c0\u201d\u3002\u7b2c\u4e8c\u6761\u8bed\u53e5\u6539\u53d8\u4e86idleproc\u7684\u72b6\u6001\uff0c\u4f7f\u5f97\u5b83\u4ece\u201c\u51fa\u751f\u201d\u8f6c\u5230\u4e86\u201c\u51c6\u5907\u5de5\u4f5c\u201d\uff0c\u5c31\u5deeuCore\u8c03\u5ea6\u5b83\u6267\u884c\u4e86\u3002\u7b2c\u4e09\u6761\u8bed\u53e5\u8bbe\u7f6e\u4e86idleproc\u6240\u4f7f\u7528\u7684\u5185\u6838\u6808\u7684\u8d77\u59cb\u5730\u5740\u3002\u9700\u8981\u6ce8\u610f\u4ee5\u540e\u7684\u5176\u4ed6\u7ebf\u7a0b\u7684\u5185\u6838\u6808\u90fd\u9700\u8981\u901a\u8fc7\u5206\u914d\u83b7\u5f97\uff0c\u56e0\u4e3auCore\u542f\u52a8\u65f6\u8bbe\u7f6e\u7684\u5185\u6838\u6808\u76f4\u63a5\u5206\u914d\u7ed9idleproc\u4f7f\u7528\u4e86\u3002\u7b2c\u56db\u6761\u5f88\u91cd\u8981\uff0c\u56e0\u4e3auCore\u5e0c\u671b\u5f53\u524dCPU\u5e94\u8be5\u505a\u66f4\u6709\u7528\u7684\u5de5\u4f5c\uff0c\u800c\u4e0d\u662f\u8fd0\u884cidleproc\u8fd9\u4e2a\u201c\u65e0\u6240\u4e8b\u4e8b\u201d\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u6240\u4ee5\u628aidleproc-&gt;need_resched\u8bbe\u7f6e\u4e3a\u201c1\u201d\uff0c\u7ed3\u5408idleproc\u7684\u6267\u884c\u4e3b\u4f53--cpu_idle\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u53ef\u4ee5\u6e05\u695a\u770b\u51fa\u5982\u679c\u5f53\u524didleproc\u5728\u6267\u884c\uff0c\u5219\u53ea\u8981\u6b64\u6807\u5fd7\u4e3a1\uff0c\u9a6c\u4e0a\u5c31\u8c03\u7528schedule\u51fd\u6570\u8981\u6c42\u8c03\u5ea6\u5668\u5207\u6362\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\u3002</p>"},{"location":"lab4/kthread/#1-initproc","title":"\u521b\u5efa\u7b2c 1 \u4e2a\u5185\u6838\u7ebf\u7a0b initproc","text":"<p>\u7b2c0\u4e2a\u5185\u6838\u7ebf\u7a0b\u4e3b\u8981\u5de5\u4f5c\u662f\u5b8c\u6210\u5185\u6838\u4e2d\u5404\u4e2a\u5b50\u7cfb\u7edf\u7684\u521d\u59cb\u5316\uff0c\u7136\u540e\u5c31\u901a\u8fc7\u6267\u884ccpu_idle\u51fd\u6570\u5f00\u59cb\u8fc7\u9000\u4f11\u751f\u6d3b\u4e86\u3002\u6240\u4ee5uCore\u63a5\u4e0b\u6765\u8fd8\u9700\u521b\u5efa\u5176\u4ed6\u8fdb\u7a0b\u6765\u5b8c\u6210\u5404\u79cd\u5de5\u4f5c\uff0c\u4f46idleproc\u5185\u6838\u5b50\u7ebf\u7a0b\u81ea\u5df1\u4e0d\u60f3\u505a\uff0c\u4e8e\u662f\u5c31\u901a\u8fc7\u8c03\u7528kernel_thread\u51fd\u6570\u521b\u5efa\u4e86\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0binit_main\u3002\u5728\u5b9e\u9a8c\u56db\u4e2d\uff0c\u8fd9\u4e2a\u5b50\u5185\u6838\u7ebf\u7a0b\u7684\u5de5\u4f5c\u5c31\u662f\u8f93\u51fa\u4e00\u4e9b\u5b57\u7b26\u4e32\uff0c\u7136\u540e\u5c31\u8fd4\u56de\u4e86\uff08\u53c2\u770binit_main\u51fd\u6570\uff09\u3002\u4f46\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\uff0cinit_main\u7684\u5de5\u4f5c\u5c31\u662f\u521b\u5efa\u7279\u5b9a\u7684\u5176\u4ed6\u5185\u6838\u7ebf\u7a0b\u6216\u7528\u6237\u8fdb\u7a0b\uff08\u5b9e\u9a8c\u4e94\u6d89\u53ca\uff09\u3002\u4e0b\u9762\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\u7684\u51fd\u6570kernel_thread\uff1a</p> <pre><code>kernel_thread(int (*fn)(void *), void *arg, uint32_t clone_flags)\n{\n     struct trapframe tf;\n    memset(&amp;tf, 0, sizeof(struct trapframe));\n    tf.tf_regs.reg_r[LOONGARCH_REG_A0] = (uint32_t)arg;\n    tf.tf_regs.reg_r[LOONGARCH_REG_A1] = (uint32_t)fn;\n    tf.tf_regs.reg_r[LOONGARCH_REG_A7] = 0;\n    tf.tf_estat = read_csr_exst();\n    tf.tf_era = (uint32_t)kernel_thread_entry;  \n    return do_fork(clone_flags | CLONE_VM, 0, &amp;tf);\n}\n</code></pre> <p>\u6ce8\u610f\uff0ckernel_thread\u51fd\u6570\u91c7\u7528\u4e86\u5c40\u90e8\u53d8\u91cftf\u6765\u653e\u7f6e\u4fdd\u5b58\u5185\u6838\u7ebf\u7a0b\u7684\u4e34\u65f6\u4e2d\u65ad\u5e27\uff0c\u5e76\u628a\u4e2d\u65ad\u5e27\u7684\u6307\u9488\u4f20\u9012\u7ed9do_fork\u51fd\u6570\uff0c\u800cdo_fork\u51fd\u6570\u4f1a\u8c03\u7528copy_thread\u51fd\u6570\u6765\u5728\u65b0\u521b\u5efa\u7684\u8fdb\u7a0b\u5185\u6838\u6808\u4e0a\u4e13\u95e8\u7ed9\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\u5206\u914d\u4e00\u5757\u7a7a\u95f4\u3002\u7ed9\u4e2d\u65ad\u5e27\u5206\u914d\u5b8c\u7a7a\u95f4\u540e\uff0c\u5c31\u9700\u8981\u6784\u9020\u65b0\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u5177\u4f53\u8fc7\u7a0b\u662f\uff1a\u9996\u5148\u7ed9tf\u8fdb\u884c\u6e05\u96f6\u521d\u59cb\u5316\uff0c\u5e76\u8bbe\u7f6etf.tf_regs.reg_r[LOONGARCH_REG_A0],tf.tf_regs.reg_r[LOONGARCH_REG_A1],tf.tf_regs.reg_r[LOONGARCH_REG_V7]\uff0ctf.tf_estat\u5bc4\u5b58\u5668\u7684\u503c\u3002tf.tf_era\u7684\u6307\u51fa\u4e86\u662fkernel_thread_entry\uff08\u4f4d\u4e8ekern/process/entry.S\u4e2d\uff09\uff0ckernel_thread_entry\u662fentry.S\u4e2d\u5b9e\u73b0\u7684\u6c47\u7f16\u51fd\u6570\uff0c\u5b83\u505a\u7684\u4e8b\u60c5\u5f88\u7b80\u5355\uff1a</p> <pre><code>kernel_thread_entry:\n    addi.w  sp, sp,  -16\n    //goto kernel_thread\n    addi.w  t0, a1, 0\n  //  la.abs  t0, a1\n    jirl    ra, t0, 0\n   // bl a1\n    move    v0, a0\n    //goto do_exit():see proc.c\n    la.abs  t0, do_exit \n    jirl    ra, t0, 0\n</code></pre> <p>\u4ece\u4e0a\u53ef\u4ee5\u770b\u51fa\uff0ckernel_thread_entry\u51fd\u6570\u4e3b\u8981\u4e3a\u5185\u6838\u7ebf\u7a0b\u7684\u4e3b\u4f53fn\u51fd\u6570\u505a\u4e86\u4e00\u4e2a\u51c6\u5907\u5f00\u59cb\u548c\u7ed3\u675f\u8fd0\u884c\u7684\u201c\u58f3\u201d\uff0c\u5e76\u628a\u51fd\u6570fn\u7684\u53c2\u6570arg\uff08\u4fdd\u5b58\u5728a0\u5bc4\u5b58\u5668\u4e2d\uff09\u538b\u6808\uff0c\u7136\u540e\u8c03\u7528fn\u51fd\u6570\uff0c\u628a\u51fd\u6570\u8fd4\u56de\u503ca0\u5bc4\u5b58\u5668\u5185\u5bb9\u538b\u6808\uff0c\u8c03\u7528do_exit\u51fd\u6570\u9000\u51fa\u7ebf\u7a0b\u6267\u884c\u3002</p> <p>do_fork\u662f\u521b\u5efa\u7ebf\u7a0b\u7684\u4e3b\u8981\u51fd\u6570\u3002kernel_thread\u51fd\u6570\u901a\u8fc7\u8c03\u7528do_fork\u51fd\u6570\u6700\u7ec8\u5b8c\u6210\u4e86\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0bdo_fork\u51fd\u6570\u7684\u5b9e\u73b0\uff08\u7ec3\u4e602\uff09\u3002do_fork\u51fd\u6570\u4e3b\u8981\u505a\u4e86\u4ee5\u4e0b6\u4ef6\u4e8b\u60c5\uff1a</p> <ol> <li>\u5206\u914d\u5e76\u521d\u59cb\u5316\u8fdb\u7a0b\u63a7\u5236\u5757\uff08alloc_proc\u51fd\u6570\uff09\uff1b</li> <li>\u5206\u914d\u5e76\u521d\u59cb\u5316\u5185\u6838\u6808\uff08setup_stack\u51fd\u6570\uff09\uff1b</li> <li>\u6839\u636eclone_flag\u6807\u5fd7\u590d\u5236\u6216\u5171\u4eab\u8fdb\u7a0b\u5185\u5b58\u7ba1\u7406\u7ed3\u6784\uff08copy_mm\u51fd\u6570\uff09\uff1b</li> <li>\u8bbe\u7f6e\u8fdb\u7a0b\u5728\u5185\u6838\uff08\u5c06\u6765\u4e5f\u5305\u62ec\u7528\u6237\u6001\uff09\u6b63\u5e38\u8fd0\u884c\u548c\u8c03\u5ea6\u6240\u9700\u7684\u4e2d\u65ad\u5e27\u548c\u6267\u884c\u4e0a\u4e0b\u6587\uff08copy_thread\u51fd\u6570\uff09\uff1b</li> <li>\u628a\u8bbe\u7f6e\u597d\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u653e\u5165hash_list\u548cproc_list\u4e24\u4e2a\u5168\u5c40\u8fdb\u7a0b\u94fe\u8868\u4e2d\uff1b</li> <li>\u81ea\u6b64\uff0c\u8fdb\u7a0b\u5df2\u7ecf\u51c6\u5907\u597d\u6267\u884c\u4e86\uff0c\u628a\u8fdb\u7a0b\u72b6\u6001\u8bbe\u7f6e\u4e3a\u201c\u5c31\u7eea\u201d\u6001\uff1b</li> <li>\u8bbe\u7f6e\u8fd4\u56de\u7801\u4e3a\u5b50\u8fdb\u7a0b\u7684id\u53f7\u3002</li> </ol> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4e0a\u8ff0\u524d3\u6b65\u6267\u884c\u6ca1\u6709\u6210\u529f\uff0c\u5219\u9700\u8981\u505a\u5bf9\u5e94\u7684\u51fa\u9519\u5904\u7406\uff0c\u628a\u76f8\u5173\u5df2\u7ecf\u5360\u6709\u7684\u5185\u5b58\u91ca\u653e\u6389\u3002copy_mm\u51fd\u6570\u76ee\u524d\u53ea\u662f\u628acurrent-&gt;mm\u8bbe\u7f6e\u4e3aNULL\uff0c\u8fd9\u662f\u7531\u4e8e\u76ee\u524d\u5728\u5b9e\u9a8c\u56db\u4e2d\u53ea\u80fd\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\uff0cproc-&gt;mm\u63cf\u8ff0\u7684\u662f\u8fdb\u7a0b\u7528\u6237\u6001\u7a7a\u95f4\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u76ee\u524dmm\u8fd8\u7528\u4e0d\u4e0a\u3002copy_thread\u51fd\u6570\u505a\u7684\u4e8b\u60c5\u6bd4\u8f83\u591a\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <p><pre><code>static void\ncopy_thread(struct proc_struct *proc, uintptr_t esp, struct trapframe *tf) {\n    proc-&gt;tf = (struct trapframe *)(proc-&gt;kstack + KSTACKSIZE) - 1;\n    *(proc-&gt;tf) = *tf;\n    proc-&gt;tf-&gt;tf_regs.reg_r[LOONGARCH_REG_A7] = 0; // use A7 as syscall result register\n    if(esp == 0) //a kernel thread\n      esp = (uintptr_t)proc-&gt;tf - 32;\n    proc-&gt;tf-&gt;tf_regs.reg_r[LOONGARCH_REG_SP] = esp;\n    proc-&gt;context.sf_ra = (uintptr_t)forkret;\n    proc-&gt;context.sf_sp = (uintptr_t)(proc-&gt;tf) - 32;\n}\n</code></pre> ///////////////////////// \u6b64\u51fd\u6570\u9996\u5148\u5728\u5185\u6838\u5806\u6808\u7684\u9876\u90e8\u8bbe\u7f6e\u4e2d\u65ad\u5e27\u5927\u5c0f\u7684\u4e00\u5757\u6808\u7a7a\u95f4\uff0c\u5e76\u5728\u6b64\u7a7a\u95f4\u4e2d\u62f7\u8d1d\u5728kernel_thread\u51fd\u6570\u5efa\u7acb\u7684\u4e34\u65f6\u4e2d\u65ad\u5e27\u7684\u521d\u59cb\u503c\uff0c\u5e76\u8fdb\u4e00\u6b65\u8bbe\u7f6e\u4e2d\u65ad\u5e27\u4e2d\u7684\u6808\u6307\u9488sp\uff0c\u8fd9\u8868\u793a\u6b64\u5185\u6838\u7ebf\u7a0b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u80fd\u54cd\u5e94\u4e2d\u65ad\uff0c\u6253\u65ad\u5f53\u524d\u7684\u6267\u884c\u3002\u6267\u884c\u5230\u8fd9\u6b65\u540e\uff0c\u6b64\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\u5c31\u5efa\u7acb\u597d\u4e86\uff0c\u5bf9\u4e8einitproc\u800c\u8a00\uff0c\u5b83\u7684\u4e2d\u65ad\u5e27\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>//////////////////////////\n//\u6240\u5728\u5730\u5740\u4f4d\u7f6e\ninitproc-&gt;tf= (proc-&gt;kstack+KSTACKSIZE) \u2013 sizeof (struct trapframe);\n//\u5177\u4f53\u5185\u5bb9\ninitproc-&gt;tf.tf_regs.reg_r[LOONGARCH_REG_A0] = (uint32_t)init_main;\ninitproc-&gt;tf.tf_regs.reg_r[LOONGARCH_REG_A1] = (uint32_t)fn;\ninitproc-&gt;tf.tf_regs.reg_r[LOONGARCH_REG_A7] = 0;\ninitproc-&gt;tf.tf_era = (uint32_t)kernel_thread_entry; \ninitproc-&gt;tf-&gt;tf_regs.reg_r[LOONGARCH_REG_SP] = esp;\ninitproc-&gt;context.sf_ra = (uintptr_t)forkret;\ninitproc-&gt;context.sf_sp = (uintptr_t)(initproc-&gt;tf) - 32;\n</code></pre> <p>\u8bbe\u7f6e\u597d\u4e2d\u65ad\u5e27\u540e\uff0c\u6700\u540e\u5c31\u662f\u8bbe\u7f6einitproc\u7684\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff0c\uff08process context\uff0c\u4e5f\u79f0\u6267\u884c\u73b0\u573a\uff09\u4e86\u3002\u53ea\u6709\u8bbe\u7f6e\u597d\u6267\u884c\u73b0\u573a\u540e\uff0c\u4e00\u65e6uCore\u8c03\u5ea6\u5668\u9009\u62e9\u4e86initproc\u6267\u884c\uff0c\u5c31\u9700\u8981\u6839\u636einitproc-&gt;context\u4e2d\u4fdd\u5b58\u7684\u6267\u884c\u73b0\u573a\u6765\u6062\u590dinitproc\u7684\u6267\u884c\u3002\u8fd9\u91cc\u8bbe\u7f6e\u4e86initproc\u7684\u6267\u884c\u73b0\u573a\u4e2d\u4e3b\u8981\u7684\u4e24\u4e2a\u4fe1\u606f\uff1a\u4e0a\u6b21\u505c\u6b62\u6267\u884c\u65f6\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\u5730\u5740context.sf_ra\u548c\u4e0a\u6b21\u505c\u6b62\u6267\u884c\u65f6\u7684\u5806\u6808\u5730\u5740context.sf_sp\u3002\u5176\u5b9einitproc\u8fd8\u6ca1\u6709\u6267\u884c\u8fc7\uff0c\u6240\u4ee5\u8fd9\u5176\u5b9e\u5c31\u662finitproc\u5b9e\u9645\u6267\u884c\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u5730\u5740\u548c\u5806\u6808\u6307\u9488\u3002\u53ef\u4ee5\u770b\u51fa\uff0c\u7531\u4e8einitproc\u7684\u4e2d\u65ad\u5e27\u5360\u7528\u4e86\u5b9e\u9645\u7ed9initproc\u5206\u914d\u7684\u6808\u7a7a\u95f4\u7684\u9876\u90e8\uff0c\u6240\u4ee5initproc\u5c31\u53ea\u80fd\u628a\u6808\u9876\u6307\u9488context.sf_sp\u8bbe\u7f6e\u5728initproc\u7684\u4e2d\u65ad\u5e27\u7684\u8d77\u59cb\u4f4d\u7f6e\u3002\u6839\u636econtext.sf_ra\u7684\u8d4b\u503c\uff0c\u53ef\u4ee5\u77e5\u9053initproc\u5b9e\u9645\u5f00\u59cb\u6267\u884c\u7684\u5730\u65b9\u5728forkret\u51fd\u6570\uff08\u4e3b\u8981\u5b8c\u6210do_fork\u51fd\u6570\u8fd4\u56de\u7684\u5904\u7406\u5de5\u4f5c\uff09\u5904\u3002\u81f3\u6b64\uff0cinitproc\u5185\u6838\u7ebf\u7a0b\u5df2\u7ecf\u505a\u597d\u51c6\u5907\u6267\u884c\u4e86\u3002</p>"},{"location":"lab4/kthread/#initproc","title":"\u8c03\u5ea6\u5e76\u6267\u884c\u5185\u6838\u7ebf\u7a0b initproc","text":"<p>\u5728uCore\u6267\u884c\u5b8cproc_init\u51fd\u6570\u540e\uff0c\u5c31\u521b\u5efa\u597d\u4e86\u4e24\u4e2a\u5185\u6838\u7ebf\u7a0b\uff1aidleproc\u548cinitproc\uff0c\u8fd9\u65f6uCore\u5f53\u524d\u7684\u6267\u884c\u73b0\u573a\u5c31\u662fidleproc\uff0c\u7b49\u5230\u6267\u884c\u5230init\u51fd\u6570\u7684\u6700\u540e\u4e00\u4e2a\u51fd\u6570cpu_idle\u4e4b\u524d\uff0cuCore\u7684\u6240\u6709\u521d\u59cb\u5316\u5de5\u4f5c\u5c31\u7ed3\u675f\u4e86\uff0cidleproc\u5c06\u901a\u8fc7\u6267\u884ccpu_idle\u51fd\u6570\u8ba9\u51faCPU\uff0c\u7ed9\u5176\u5b83\u5185\u6838\u7ebf\u7a0b\u6267\u884c\uff0c\u5177\u4f53\u8fc7\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>void\ncpu_idle(void) {\n    while (1) {\n        if (current-&gt;need_resched) {\n            schedule();\n            \u2026\u2026\n</code></pre> <p>\u9996\u5148\uff0c\u5224\u65ad\u5f53\u524d\u5185\u6838\u7ebf\u7a0bidleproc\u7684need_resched\u662f\u5426\u4e0d\u4e3a0\uff0c\u56de\u987e\u524d\u9762\u201c\u521b\u5efa\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0bidleproc\u201d\u4e2d\u7684\u63cf\u8ff0\uff0cproc_init\u51fd\u6570\u5728\u521d\u59cb\u5316idleproc\u4e2d\uff0c\u5c31\u628aidleproc-&gt;need_resched\u7f6e\u4e3a1\u4e86\uff0c\u6240\u4ee5\u4f1a\u9a6c\u4e0a\u8c03\u7528schedule\u51fd\u6570\u627e\u5176\u4ed6\u5904\u4e8e\u201c\u5c31\u7eea\u201d\u6001\u7684\u8fdb\u7a0b\u6267\u884c\u3002</p> <p>uCore\u5728\u5b9e\u9a8c\u56db\u4e2d\u53ea\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6700\u7b80\u5355\u7684FIFO\u8c03\u5ea6\u5668\uff0c\u5176\u6838\u5fc3\u5c31\u662fschedule\u51fd\u6570\u3002\u5b83\u7684\u6267\u884c\u903b\u8f91\u5f88\u7b80\u5355\uff1a</p> <p>1\uff0e\u8bbe\u7f6e\u5f53\u524d\u5185\u6838\u7ebf\u7a0bcurrent-&gt;need_resched\u4e3a0\uff1b 2\uff0e\u5728proc_list\u961f\u5217\u4e2d\u67e5\u627e\u4e0b\u4e00\u4e2a\u5904\u4e8e\u201c\u5c31\u7eea\u201d\u6001\u7684\u7ebf\u7a0b\u6216\u8fdb\u7a0bnext\uff1b 3\uff0e\u627e\u5230\u8fd9\u6837\u7684\u8fdb\u7a0b\u540e\uff0c\u5c31\u8c03\u7528proc_run\u51fd\u6570\uff0c\u4fdd\u5b58\u5f53\u524d\u8fdb\u7a0bcurrent\u7684\u6267\u884c\u73b0\u573a\uff08\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff09\uff0c\u6062\u590d\u65b0\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff0c\u5b8c\u6210\u8fdb\u7a0b\u5207\u6362\u3002</p> <p>\u81f3\u6b64\uff0c\u65b0\u7684\u8fdb\u7a0bnext\u5c31\u5f00\u59cb\u6267\u884c\u4e86\u3002\u7531\u4e8e\u5728proc10\u4e2d\u53ea\u6709\u4e24\u4e2a\u5185\u6838\u7ebf\u7a0b\uff0c\u4e14idleproc\u8981\u8ba9\u51faCPU\u7ed9initproc\u6267\u884c\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230schedule\u51fd\u6570\u901a\u8fc7\u67e5\u627eproc_list\u8fdb\u7a0b\u961f\u5217\uff0c\u53ea\u80fd\u627e\u5230\u4e00\u4e2a\u5904\u4e8e\u201c\u5c31\u7eea\u201d\u6001\u7684initproc\u5185\u6838\u7ebf\u7a0b\u3002\u5e76\u901a\u8fc7proc_run\u548c\u8fdb\u4e00\u6b65\u7684switch_to\u51fd\u6570\u5b8c\u6210\u4e24\u4e2a\u6267\u884c\u73b0\u573a\u7684\u5207\u6362\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u8ba9current\u6307\u5411next\u5185\u6838\u7ebf\u7a0binitproc\uff1b</li> <li>\u8bbe\u7f6ecurrent_pgdir\u7684\u503c\u4e3anext\u5185\u6838\u7ebf\u7a0binitproc\u7684\u9875\u76ee\u5f55\u8868\u8d77\u59cb\u5730\u5740next-&gt;cr3\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u5b8c\u6210\u8fdb\u7a0b\u95f4\u7684\u9875\u8868\u5207\u6362\uff1b</li> <li>\u7531switch_to\u51fd\u6570\u5b8c\u6210\u5177\u4f53\u7684\u4e24\u4e2a\u7ebf\u7a0b\u7684\u6267\u884c\u73b0\u573a\u5207\u6362\uff0c\u5373\u5207\u6362\u5404\u4e2a\u5bc4\u5b58\u5668\uff0c\u5f53switch_to\u51fd\u6570\u6267\u884c\u6700\u540e\u4e00\u6761\u6307\u4ee4\u65f6\uff0c\u5c31\u8df3\u8f6c\u5230initproc\u6267\u884c\u4e86\u3002</li> </ol> <p>\u7531\u4e8eidleproc\u548cinitproc\u90fd\u662f\u5171\u7528\u4e00\u4e2a\u5185\u6838\u9875\u8868boot_cr3\uff0c\u6240\u4ee5\u6b64\u65f6\u7b2c\u4e8c\u6b65\u5176\u5b9e\u6ca1\u7528\uff0c\u4f46\u8003\u8651\u5230\u4ee5\u540e\u7684\u8fdb\u7a0b\u6709\u5404\u81ea\u7684\u9875\u8868\uff0c\u5176\u8d77\u59cb\u5730\u5740\u5404\u4e0d\u76f8\u540c\uff0c\u53ea\u6709\u5b8c\u6210\u9875\u8868\u5207\u6362\uff0c\u624d\u80fd\u786e\u4fdd\u65b0\u7684\u8fdb\u7a0b\u80fd\u591f\u6b63\u5e38\u6267\u884c\u3002</p> <p>\u7b2c\u4e09\u6b65proc_run\u51fd\u6570\u8c03\u7528switch_to\u51fd\u6570\uff0c\u53c2\u6570\u662f\u524d\u4e00\u4e2a\u8fdb\u7a0b\u548c\u540e\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff1aprocess context\u3002\u5728\u4e0a\u4e00\u8282\u201c\u8bbe\u8ba1\u8fdb\u7a0b\u63a7\u5236\u5757\u201d\u4e2d\uff0c\u63cf\u8ff0\u4e86context\u7ed3\u6784\u5305\u542b\u7684\u8981\u4fdd\u5b58\u548c\u6062\u590d\u7684\u5bc4\u5b58\u5668\u3002\u6211\u4eec\u518d\u770b\u770bswitch.S\u4e2d\u7684switch_to\u51fd\u6570\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <pre><code>.text\n.globl switch_to\nswitch_to:\n//save the registers\n    st.w    sp, a0, 48\n    st.w    fp, a0, 44\n    st.w    ra, a0, 40\n    st.w    tp, a0, 36\n    st.w    s8, a0, 32\n    st.w    s7, a0, 28\n    st.w    s6, a0, 24\n    st.w    s5, a0, 20\n    st.w    s4, a0, 16\n    st.w    s3, a0, 12\n    st.w    s2, a0, 8\n    st.w    s1, a0, 4\n    st.w    s0, a0, 0\n\n    //use as nop\n    dbar    0\n</code></pre> <p>\u9996\u5148\uff0c\u4fdd\u5b58\u524d\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff0c\u7b2c\u4e09\u6761\u6c47\u7f16\u6307\u4ee4\uff08\u5982\u4e0b\u6240\u793a\uff09\u4fdd\u5b58\u4e86\u8fdb\u7a0b\u5728\u8fd4\u56deswitch_to\u51fd\u6570\u540e\u7684\u6307\u4ee4\u5730\u5740\u5230context.sf_ra\u4e2d</p> <pre><code> st.w    ra, a0, 40\n</code></pre> <p>\u5728\u63a5\u4e0b\u6765\u7684\u6c47\u7f16\u6307\u4ee4\u5b8c\u6210\u4e86\u4fdd\u5b58\u524d\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5176\u4ed610\u4e2a\u5bc4\u5b58\u5668\u5230context\u4e2d\u7684\u76f8\u5e94\u6210\u5458\u53d8\u91cf\u4e2d\u3002\u81f3\u6b64\u524d\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\u4fdd\u5b58\u5b8c\u6bd5\u3002\u518d\u5f80\u540e\u662f\u6062\u590d\u5411\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u4e0a\u8ff0\u4fdd\u5b58\u8fc7\u7a0b\u7684\u9006\u6267\u884c\u8fc7\u7a0b\uff0c\u9010\u4e00\u628acontext\u4e2d\u76f8\u5173\u6210\u5458\u53d8\u91cf\u7684\u503c\u8d4b\u503c\u7ed9\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\uff0c\u6700\u540e\u4e24\u6761\u6c47\u7f16\u6307\u4ee4\u5c31\u662f\u5c06\u7a0b\u5e8f\u8df3\u8f6c\u5230context.sf_ra\u4fdd\u5b58\u7684\u5730\u5740\u5904\u6267\u884c\u3002\u5373\u5f53\u524d\u8fdb\u7a0b\u5df2\u7ecf\u662f\u4e0b\u4e00\u4e2a\u8fdb\u7a0b\u4e86\u3002uCore\u4f1a\u6267\u884c\u8fdb\u7a0b\u5207\u6362\uff0c\u8ba9initproc\u6267\u884c\u3002\u5728\u5bf9initproc\u8fdb\u884c\u521d\u59cb\u5316\u65f6\uff0c\u8bbe\u7f6e\u4e86initproc-&gt;context.sf_era = (uintptr_t)forkret\uff0c\u8fd9\u6837\uff0c\u5f53\u6267\u884cswitch_to\u51fd\u6570\u5e76\u8fd4\u56de\u540e\uff0cinitproc\u5c06\u6267\u884c\u5176\u5b9e\u9645\u4e0a\u7684\u6267\u884c\u5165\u53e3\u5730\u5740forkret\u3002\u800cforkret\u4f1a\u8c03\u7528\u4f4d\u4e8ekern/trap/trapentry.S\u4e2d\u7684forkrets\u51fd\u6570\u6267\u884c\uff0c\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>.global forkrets\n.type forkrets, @function\nforkrets:\n  addi.w a0, sp, -16\n  b exception_return\n.end forkrets\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0cforkrets\u51fd\u6570\u9996\u5148\u628asp\u6307\u5411\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u518d\u8df3\u8f6c\u5230\u4e2d\u65ad\u8fd4\u56de\u51fd\u6570\u4e2d\u5f00\u59cb\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u76f8\u5173\u64cd\u4f5c\u3002\u4e2d\u65ad\u8fd4\u56de\u6267\u884c\u5b8c\u4e4b\u540e\u5f00\u59cb\u6267\u884cinitproc\u7684\u4e3b\u4f53\u4e86\u3002Initprocde\u7684\u4e3b\u4f53\u51fd\u6570\u5f88\u7b80\u5355\u5c31\u662f\u8f93\u51fa\u4e00\u6bb5\u5b57\u7b26\u4e32\uff0c\u7136\u540e\u5c31\u8fd4\u56de\u5230kernel_tread_entry\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528do_exit\u6267\u884c\u9000\u51fa\u64cd\u4f5c\u4e86\u3002\u672c\u6765do_exit\u5e94\u8be5\u5b8c\u6210\u4e00\u4e9b\u8d44\u6e90\u56de\u6536\u5de5\u4f5c\u7b49\uff0c\u4f46\u8fd9\u4e9b\u4e0d\u662f\u5b9e\u9a8c\u56db\u6d89\u53ca\u7684\uff0c\u800c\u662f\u7531\u540e\u7eed\u7684\u5b9e\u9a8c\u6765\u5b8c\u6210\u3002\u81f3\u6b64\uff0c\u5b9e\u9a8c\u56db\u4e2d\u7684\u4e3b\u8981\u5de5\u4f5c\u63cf\u8ff0\u5b8c\u6bd5\u3002</p>"},{"location":"lab4/lab4/","title":"\u5b9e\u9a8c\u56db\uff1a\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406","text":""},{"location":"lab4/lab4/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4e86\u89e3\u5185\u6838\u7ebf\u7a0b\u521b\u5efa/\u6267\u884c\u7684\u7ba1\u7406\u8fc7\u7a0b</li> <li>\u4e86\u89e3\u5185\u6838\u7ebf\u7a0b\u7684\u5207\u6362\u548c\u57fa\u672c\u8c03\u5ea6\u8fc7\u7a0b</li> </ul>"},{"location":"lab4/lab4/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u9a8c\u2154\u5b8c\u6210\u4e86\u7269\u7406\u548c\u865a\u62df\u5185\u5b58\u7ba1\u7406\uff0c\u8fd9\u7ed9\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\uff08\u5185\u6838\u7ebf\u7a0b\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u8fdb\u7a0b\uff09\u6253\u4e0b\u4e86\u63d0\u4f9b\u5185\u5b58\u7ba1\u7406\u7684\u57fa\u7840\u3002\u5f53\u4e00\u4e2a\u7a0b\u5e8f\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u8fd0\u884c\u65f6\uff0c\u9996\u5148\u901a\u8fc7ucore OS\u7684\u5185\u5b58\u7ba1\u7406\u5b50\u7cfb\u7edf\u5206\u914d\u5408\u9002\u7684\u7a7a\u95f4\uff0c\u7136\u540e\u5c31\u9700\u8981\u8003\u8651\u5982\u4f55\u5206\u65f6\u4f7f\u7528CPU\u6765\u201c\u5e76\u53d1\u201d\u6267\u884c\u591a\u4e2a\u7a0b\u5e8f\uff0c\u8ba9\u6bcf\u4e2a\u8fd0\u884c\u7684\u7a0b\u5e8f\uff08\u8fd9\u91cc\u7528\u7ebf\u7a0b\u6216\u8fdb\u7a0b\u8868\u793a\uff09\u201c\u611f\u5230\u201d\u5b83\u4eec\u5404\u81ea\u62e5\u6709\u201c\u81ea\u5df1\u201d\u7684CPU\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u5c06\u9996\u5148\u63a5\u89e6\u7684\u662f\u5185\u6838\u7ebf\u7a0b\u7684\u7ba1\u7406\u3002\u5185\u6838\u7ebf\u7a0b\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u8fdb\u7a0b\uff0c\u5185\u6838\u7ebf\u7a0b\u4e0e\u7528\u6237\u8fdb\u7a0b\u7684\u533a\u522b\u6709\u4e24\u4e2a\uff1a</p> <ul> <li>\u5185\u6838\u7ebf\u7a0b\u53ea\u8fd0\u884c\u5728\u5185\u6838\u6001</li> <li>\u7528\u6237\u8fdb\u7a0b\u4f1a\u5728\u5728\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u4ea4\u66ff\u8fd0\u884c</li> <li>\u6240\u6709\u5185\u6838\u7ebf\u7a0b\u5171\u7528ucore\u5185\u6838\u5185\u5b58\u7a7a\u95f4\uff0c\u4e0d\u9700\u4e3a\u6bcf\u4e2a\u5185\u6838\u7ebf\u7a0b\u7ef4\u62a4\u5355\u72ec\u7684\u5185\u5b58\u7a7a\u95f4</li> <li>\u800c\u7528\u6237\u8fdb\u7a0b\u9700\u8981\u7ef4\u62a4\u5404\u81ea\u7684\u7528\u6237\u5185\u5b58\u7a7a\u95f4</li> </ul> <p>\u76f8\u5173\u539f\u7406\u4ecb\u7ecd\u53ef\u770b\u9644\u5f55\uff1a\u3010\u539f\u7406\u3011\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u5c5e\u6027\u4e0e\u7279\u5f81\u89e3\u6790\u3002</p>"},{"location":"lab4/lab4/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u4e3a\u4e86\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\uff0c\u9700\u8981\u8bbe\u8ba1\u7ba1\u7406\u7ebf\u7a0b\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5373\u8fdb\u7a0b\u63a7\u5236\u5757\uff08\u5728\u8fd9\u91cc\u4e5f\u53ef\u53eb\u505a\u7ebf\u7a0b\u63a7\u5236\u5757\uff09\u3002\u5982\u679c\u8981\u8ba9\u5185\u6838\u7ebf\u7a0b\u8fd0\u884c\uff0c\u6211\u4eec\u9996\u5148\u8981\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\u5bf9\u5e94\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u8fd8\u9700\u628a\u8fd9\u4e9b\u8fdb\u7a0b\u63a7\u5236\u5757\u901a\u8fc7\u94fe\u8868\u8fde\u5728\u4e00\u8d77\uff0c\u4fbf\u4e8e\u968f\u65f6\u8fdb\u884c\u63d2\u5165\uff0c\u5220\u9664\u548c\u67e5\u627e\u64cd\u4f5c\u7b49\u8fdb\u7a0b\u7ba1\u7406\u4e8b\u52a1\u3002\u8fd9\u4e2a\u94fe\u8868\u5c31\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\u94fe\u8868\u3002\u7136\u540e\u5728\u901a\u8fc7\u8c03\u5ea6\u5668\uff08scheduler\uff09\u6765\u8ba9\u4e0d\u540c\u7684\u5185\u6838\u7ebf\u7a0b\u5728\u4e0d\u540c\u7684\u65f6\u95f4\u6bb5\u5360\u7528CPU\u6267\u884c\uff0c\u5b9e\u73b0\u5bf9CPU\u7684\u5206\u65f6\u5171\u4eab\u3002\u90a3lab4\u4e2d\u662f\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u5b9e\u73b0\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u5462\uff1f</p> <p>\u6211\u4eec\u8fd8\u662f\u4ecekern/init/init.c\u4e2d\u7684kern_init\u51fd\u6570\u5165\u624b\u5206\u6790\u3002\u5728kern_init\u51fd\u6570\u4e2d\uff0c\u5f53\u5b8c\u6210\u865a\u62df\u5185\u5b58\u7684\u521d\u59cb\u5316\u5de5\u4f5c\u540e\uff0c\u5c31\u8c03\u7528\u4e86proc_init\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5b8c\u6210\u4e86idleproc\u5185\u6838\u7ebf\u7a0b\u548cinitproc\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u6216\u590d\u5236\u5de5\u4f5c\uff0c\u8fd9\u4e5f\u662f\u672c\u6b21\u5b9e\u9a8c\u8981\u5b8c\u6210\u7684\u7ec3\u4e60\u3002idleproc\u5185\u6838\u7ebf\u7a0b\u7684\u5de5\u4f5c\u5c31\u662f\u4e0d\u505c\u5730\u67e5\u8be2\uff0c\u770b\u662f\u5426\u6709\u5176\u4ed6\u5185\u6838\u7ebf\u7a0b\u53ef\u4ee5\u6267\u884c\u4e86\uff0c\u5982\u679c\u6709\uff0c\u9a6c\u4e0a\u8ba9\u8c03\u5ea6\u5668\u9009\u62e9\u90a3\u4e2a\u5185\u6838\u7ebf\u7a0b\u6267\u884c\uff08\u8bf7\u53c2\u8003cpu_idle\u51fd\u6570\u7684\u5b9e\u73b0\uff09\u3002\u6240\u4ee5idleproc\u5185\u6838\u7ebf\u7a0b\u662f\u5728ucore\u64cd\u4f5c\u7cfb\u7edf\u6ca1\u6709\u5176\u4ed6\u5185\u6838\u7ebf\u7a0b\u53ef\u6267\u884c\u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u88ab\u8c03\u7528\u3002\u63a5\u7740\u5c31\u662f\u8c03\u7528kernel_thread\u51fd\u6570\u6765\u521b\u5efainitproc\u5185\u6838\u7ebf\u7a0b\u3002initproc\u5185\u6838\u7ebf\u7a0b\u7684\u5de5\u4f5c\u5c31\u662f\u663e\u793a\u201cHello World\u201d\uff0c\u8868\u660e\u81ea\u5df1\u5b58\u5728\u4e14\u80fd\u6b63\u5e38\u5de5\u4f5c\u4e86\u3002</p> <p>\u8c03\u5ea6\u5668\u4f1a\u5728\u7279\u5b9a\u7684\u8c03\u5ea6\u70b9\u4e0a\u6267\u884c\u8c03\u5ea6\uff0c\u5b8c\u6210\u8fdb\u7a0b\u5207\u6362\u3002\u5728lab4\u4e2d\uff0c\u8fd9\u4e2a\u8c03\u5ea6\u70b9\u5c31\u4e00\u5904\uff0c\u5373\u5728cpu_idle\u51fd\u6570\u4e2d\uff0c\u6b64\u51fd\u6570\u5982\u679c\u53d1\u73b0\u5f53\u524d\u8fdb\u7a0b\uff08\u4e5f\u5c31\u662fidleproc\uff09\u7684need_resched\u7f6e\u4e3a1\uff08\u5728\u521d\u59cb\u5316idleproc\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u65f6\u5c31\u7f6e\u4e3a1\u4e86\uff09\uff0c\u5219\u8c03\u7528schedule\u51fd\u6570\uff0c\u5b8c\u6210\u8fdb\u7a0b\u8c03\u5ea6\u548c\u8fdb\u7a0b\u5207\u6362\u3002\u8fdb\u7a0b\u8c03\u5ea6\u7684\u8fc7\u7a0b\u5176\u5b9e\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u662f\u5728\u8fdb\u7a0b\u63a7\u5236\u5757\u94fe\u8868\u4e2d\u67e5\u627e\u5230\u4e00\u4e2a\u201c\u5408\u9002\u201d\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u6240\u8c13\u201c\u5408\u9002\u201d\u5c31\u662f\u6307\u5185\u6838\u7ebf\u7a0b\u5904\u4e8e\u201cPROC_RUNNABLE\u201d\u72b6\u6001\u3002\u5728\u63a5\u4e0b\u6765\u7684switch_to\u51fd\u6570(\u5728\u540e\u7eed\u6709\u8be6\u7ec6\u5206\u6790\uff0c\u6709\u4e00\u5b9a\u96be\u5ea6\uff0c\u9700\u6df1\u5165\u4e86\u89e3\u4e00\u4e0b)\u5b8c\u6210\u5177\u4f53\u7684\u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b\u3002\u4e00\u65e6\u5207\u6362\u6210\u529f\uff0c\u90a3\u4e48initproc\u5185\u6838\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u901a\u8fc7\u663e\u793a\u5b57\u7b26\u4e32\u6765\u8868\u660e\u672c\u6b21\u5b9e\u9a8c\u6210\u529f\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u4e3b\u8981\u4ecb\u7ecd\u4e86\u8fdb\u7a0b\u521b\u5efa\u6240\u9700\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784--\u8fdb\u7a0b\u63a7\u5236\u5757proc_struct\uff0c\u4ee5\u53caucore\u521b\u5efa\u5e76\u6267\u884c\u5185\u6838\u7ebf\u7a0bidleproc\u548cinitproc\u7684\u4e24\u79cd\u4e0d\u540c\u65b9\u5f0f\uff0c\u7279\u522b\u662f\u521b\u5efainitproc\u7684\u65b9\u5f0f\u5c06\u88ab\u5ef6\u7eed\u5230\u5b9e\u9a8c\u4e94\u4e2d\uff0c\u6269\u5c55\u4e3a\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\u7684\u4e3b\u8981\u65b9\u5f0f\u3002\u53e6\u5916\uff0c\u8fd8\u521d\u6b65\u6d89\u53ca\u4e86\u8fdb\u7a0b\u8c03\u5ea6\uff08\u5b9e\u9a8c\u516d\u6d89\u53ca\u5e76\u4f1a\u6269\u5c55\uff09\u548c\u8fdb\u7a0b\u5207\u6362\u5185\u5bb9\u3002</p>"},{"location":"lab4/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab4/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab4\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e863\u4e2a\u57fa\u672c\u7ec3\u4e60\u548c1\u4e2a\u6269\u5c55\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB4\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB4\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790sys_code\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab4/task/#1","title":"\u7ec3\u4e601\uff1a\u5206\u914d\u5e76\u521d\u59cb\u5316\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>alloc_proc\u51fd\u6570\uff08\u4f4d\u4e8ekern/process/proc.c\u4e2d\uff09\u8d1f\u8d23\u5206\u914d\u5e76\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684struct proc_struct\u7ed3\u6784\uff0c\u7528\u4e8e\u5b58\u50a8\u65b0\u5efa\u7acb\u7684\u5185\u6838\u7ebf\u7a0b\u7684\u7ba1\u7406\u4fe1\u606f\u3002ucore\u9700\u8981\u5bf9\u8fd9\u4e2a\u7ed3\u6784\u8fdb\u884c\u6700\u57fa\u672c\u7684\u521d\u59cb\u5316\uff0c\u4f60\u9700\u8981\u5b8c\u6210\u8fd9\u4e2a\u521d\u59cb\u5316\u8fc7\u7a0b\u3002</p> <p>\u3010\u63d0\u793a\u3011\u5728alloc_proc\u51fd\u6570\u7684\u5b9e\u73b0\u4e2d\uff0c\u9700\u8981\u521d\u59cb\u5316\u7684proc_struct\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cf\u81f3\u5c11\u5305\u62ec\uff1astate/pid/runs/kstack/need_resched/parent/mm/context/tf/cr3/flags/name\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u8bf7\u8bf4\u660eproc_struct\u4e2d<code>struct context context</code>\u548c<code>struct trapframe *tf</code>\u6210\u5458\u53d8\u91cf\u542b\u4e49\u548c\u5728\u672c\u5b9e\u9a8c\u4e2d\u7684\u4f5c\u7528\u662f\u5565\uff1f\uff08\u63d0\u793a\u901a\u8fc7\u770b\u4ee3\u7801\u548c\u7f16\u7a0b\u8c03\u8bd5\u53ef\u4ee5\u5224\u65ad\u51fa\u6765\uff09</p>"},{"location":"lab4/task/#2","title":"\u7ec3\u4e602\uff1a\u4e3a\u65b0\u521b\u5efa\u7684\u5185\u6838\u7ebf\u7a0b\u5206\u914d\u8d44\u6e90\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u521b\u5efa\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u9700\u8981\u5206\u914d\u548c\u8bbe\u7f6e\u597d\u5f88\u591a\u8d44\u6e90\u3002kernel_thread\u51fd\u6570\u901a\u8fc7\u8c03\u7528**do_fork**\u51fd\u6570\u5b8c\u6210\u5177\u4f53\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\u3002do_kernel\u51fd\u6570\u4f1a\u8c03\u7528alloc_proc\u51fd\u6570\u6765\u5206\u914d\u5e76\u521d\u59cb\u5316\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u4f46alloc_proc\u53ea\u662f\u627e\u5230\u4e86\u4e00\u5c0f\u5757\u5185\u5b58\u7528\u4ee5\u8bb0\u5f55\u8fdb\u7a0b\u7684\u5fc5\u8981\u4fe1\u606f\uff0c\u5e76\u6ca1\u6709\u5b9e\u9645\u5206\u914d\u8fd9\u4e9b\u8d44\u6e90\u3002ucore\u4e00\u822c\u901a\u8fc7do_fork\u5b9e\u9645\u521b\u5efa\u65b0\u7684\u5185\u6838\u7ebf\u7a0b\u3002do_fork\u7684\u4f5c\u7528\u662f\uff0c\u521b\u5efa\u5f53\u524d\u5185\u6838\u7ebf\u7a0b\u7684\u4e00\u4e2a\u526f\u672c\uff0c\u5b83\u4eec\u7684\u6267\u884c\u4e0a\u4e0b\u6587\u3001\u4ee3\u7801\u3001\u6570\u636e\u90fd\u4e00\u6837\uff0c\u4f46\u662f\u5b58\u50a8\u4f4d\u7f6e\u4e0d\u540c\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u7ed9\u65b0\u5185\u6838\u7ebf\u7a0b\u5206\u914d\u8d44\u6e90\uff0c\u5e76\u4e14\u590d\u5236\u539f\u8fdb\u7a0b\u7684\u72b6\u6001\u3002\u4f60\u9700\u8981\u5b8c\u6210\u5728kern/process/proc.c\u4e2d\u7684do_fork\u51fd\u6570\u4e2d\u7684\u5904\u7406\u8fc7\u7a0b\u3002\u5b83\u7684\u5927\u81f4\u6267\u884c\u6b65\u9aa4\u5305\u62ec\uff1a</p> <ul> <li>\u8c03\u7528alloc_proc\uff0c\u9996\u5148\u83b7\u5f97\u4e00\u5757\u7528\u6237\u4fe1\u606f\u5757\u3002</li> <li>\u4e3a\u8fdb\u7a0b\u5206\u914d\u4e00\u4e2a\u5185\u6838\u6808\u3002</li> <li>\u590d\u5236\u539f\u8fdb\u7a0b\u7684\u5185\u5b58\u7ba1\u7406\u4fe1\u606f\u5230\u65b0\u8fdb\u7a0b\uff08\u4f46\u5185\u6838\u7ebf\u7a0b\u4e0d\u5fc5\u505a\u6b64\u4e8b\uff09</li> <li>\u590d\u5236\u539f\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u5230\u65b0\u8fdb\u7a0b</li> <li>\u5c06\u65b0\u8fdb\u7a0b\u6dfb\u52a0\u5230\u8fdb\u7a0b\u5217\u8868</li> <li>\u5524\u9192\u65b0\u8fdb\u7a0b</li> <li>\u8fd4\u56de\u65b0\u8fdb\u7a0b\u53f7</li> </ul> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u8bf7\u8bf4\u660eucore\u662f\u5426\u505a\u5230\u7ed9\u6bcf\u4e2a\u65b0fork\u7684\u7ebf\u7a0b\u4e00\u4e2a\u552f\u4e00\u7684id\uff1f\u8bf7\u8bf4\u660e\u4f60\u7684\u5206\u6790\u548c\u7406\u7531\u3002</p>"},{"location":"lab4/task/#3-proc_run","title":"\u7ec3\u4e603\uff1a\u9605\u8bfb\u4ee3\u7801\uff0c\u7406\u89e3 proc_run \u51fd\u6570\u548c\u5b83\u8c03\u7528\u7684\u51fd\u6570\u5982\u4f55\u5b8c\u6210\u8fdb\u7a0b\u5207\u6362\u7684\u3002\uff08\u65e0\u7f16\u7801\u5de5\u4f5c\uff09","text":"<p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9proc_run\u51fd\u6570\u7684\u5206\u6790\u3002\u5e76\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u5728\u672c\u5b9e\u9a8c\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u521b\u5efa\u4e14\u8fd0\u884c\u4e86\u51e0\u4e2a\u5185\u6838\u7ebf\u7a0b\uff1f  - \u8bed\u53e5<code>local_intr_save(intr_flag);....local_intr_restore(intr_flag);</code>\u5728\u8fd9\u91cc\u6709\u4f55\u4f5c\u7528?\u8bf7\u8bf4\u660e\u7406\u7531</p> <p>\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\u540e\uff0c\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\uff1amake qemu -j 16</p> <p>\u5982\u679c\u53ef\u4ee5\u5f97\u5230\u5982 \u7f16\u8bd1\u65b9\u6cd5\u6240\u793a\u7684\u663e\u793a\u5185\u5bb9\uff08\u4ec5\u4f9b\u53c2\u8003\uff0c\u4e0d\u662f\u6807\u51c6\u7b54\u6848\u8f93\u51fa\uff09\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002</p>"},{"location":"lab4/task/#challenge","title":"\u6269\u5c55\u7ec3\u4e60Challenge\uff1a\u5b9e\u73b0\u652f\u6301\u4efb\u610f\u5927\u5c0f\u7684\u5185\u5b58\u5206\u914d\u7b97\u6cd5","text":"<p>\u8fd9\u4e0d\u662f\u672c\u5b9e\u9a8c\u7684\u5185\u5bb9\uff0c\u5176\u5b9e\u662f\u4e0a\u4e00\u6b21\u5b9e\u9a8c\u5185\u5b58\u7684\u6269\u5c55\uff0c\u4f46\u8003\u8651\u5230\u73b0\u5728\u7684slab\u7b97\u6cd5\u6bd4\u8f83\u590d\u6742\uff0c\u6709\u5fc5\u8981\u5b9e\u73b0\u4e00\u4e2a\u6bd4\u8f83\u7b80\u5355\u7684\u4efb\u610f\u5927\u5c0f\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u3002\u53ef\u53c2\u8003\u672c\u5b9e\u9a8c\u4e2d\u7684slab\u5982\u4f55\u8c03\u7528\u57fa\u4e8e\u9875\u7684\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff08\u6ce8\u610f\uff0c\u4e0d\u662f\u8981\u4f60\u5173\u6ce8slab\u7684\u5177\u4f53\u5b9e\u73b0\uff09\u6765\u5b9e\u73b0first-fit/best-fit/worst-fit/buddy\u7b49\u652f\u6301\u4efb\u610f\u5927\u5c0f\u7684\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u3002\u3002</p> <p>\u3010\u6ce8\u610f\u3011\u4e0b\u9762\u662f\u76f8\u5173\u7684Linux\u5b9e\u73b0\u6587\u6863\uff0c\u4f9b\u53c2\u8003</p> <p>SLOB</p> <p>http://en.wikipedia.org/wiki/SLOB http://lwn.net/Articles/157944/</p> <p>SLAB</p> <p>https://www.ibm.com/developerworks/cn/linux/l-linux-slab-allocator/</p>"},{"location":"lab5/appendix/","title":"\u9644\u5f55","text":""},{"location":"lab5/appendix/#a","title":"\u9644\u5f55 A\uff1a\u3010\u539f\u7406\u3011\u7528\u6237\u8fdb\u7a0b\u7684\u7279\u5f81","text":""},{"location":"lab5/appendix/#_1","title":"\u4ece\u5185\u6838\u7ebf\u7a0b\u5230\u7528\u6237\u8fdb\u7a0b","text":"<p>\u5728\u5b9e\u9a8c\u56db\u4e2d\u8bbe\u8ba1\u5b9e\u73b0\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u5e76\u5b9e\u73b0\u4e86\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u548c\u7b80\u5355\u7684\u8c03\u5ea6\u6267\u884c\u3002\u4f46\u5b9e\u9a8c\u56db\u4e2d\u6ca1\u6709\u5728\u7528\u6237\u6001\u6267\u884c\u7528\u6237\u8fdb\u7a0b\u7684\u7ba1\u7406\u673a\u5236\uff0c\u65e2\u65e0\u6cd5\u4f53\u73b0\u7528\u6237\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u9694\u79bb\u7684\u4fdd\u62a4\u673a\u5236\uff0c\u4e0d\u652f\u6301\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u7684\u7528\u6237\u6001\u548c\u6838\u5fc3\u6001\u4e4b\u95f4\u7684\u5207\u6362\uff0c\u4e14\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u7684\u5b8c\u6574\u72b6\u6001\u53d8\u5316\u7684\u751f\u547d\u5468\u671f\u3002\u5176\u5b9e\u6ca1\u6709\u5b9e\u73b0\u7684\u539f\u56e0\u662f\u5185\u6838\u7ebf\u7a0b\u4e0d\u9700\u8981\u8fd9\u4e9b\u529f\u80fd\u3002\u90a3\u5185\u6838\u7ebf\u7a0b\u76f8\u5bf9\u4e8e\u7528\u6237\u6001\u7ebf\u7a0b\u6709\u4f55\u7279\u70b9\u5462\uff1f</p> <p>\u4f46\u5176\u5b9e\u6211\u4eec\u5df2\u7ecf\u5728\u5b9e\u9a8c\u56db\u4e2d\u770b\u5230\u4e86\u5185\u6838\u7ebf\u7a0b\uff0c\u5185\u6838\u7ebf\u7a0b\u7684\u7ba1\u7406\u5b9e\u73b0\u76f8\u5bf9\u662f\u7b80\u5355\u7684\uff0c\u5176\u7279\u70b9\u662f\u76f4\u63a5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\uff08\u6bd4\u5982ucore\uff09\u5728\u521d\u59cb\u5316\u4e2d\u5efa\u7acb\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u5730\u5740\u7a7a\u95f4\uff0c\u4e0d\u540c\u7684\u5185\u6838\u7ebf\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7\u8c03\u5ea6\u5668\u5b9e\u73b0\u7ebf\u7a0b\u95f4\u7684\u5207\u6362\uff0c\u8fbe\u5230\u5206\u65f6\u4f7f\u7528CPU\u7684\u76ee\u7684\u3002\u7531\u4e8e\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u4e00\u4e00\u6620\u5c04\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u7269\u7406\u7a7a\u95f4\u7684\uff0c\u8fd9\u4f7f\u5f97\u53ef\u7528\u7a7a\u95f4\u7684\u5927\u5c0f\u4e0d\u4f1a\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u65f6\uff0c\u9700\u8981\u8003\u8651\u5230\u6709\u9650\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u9700\u8981\u4fdd\u8bc1\u5404\u4e2a\u5185\u6838\u7ebf\u7a0b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u7684\u6b63\u5e38\u8fd0\u884c\u3002\u8fd9\u6837\u5728\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u65f6\uff0c\u4e0d\u5fc5\u8003\u8651\u6d89\u53ca\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u7f3a\u9875\u5904\u7406\u3001\u6309\u9700\u5206\u9875\u3001\u5199\u65f6\u590d\u5236\u3001\u9875\u6362\u5165\u6362\u51fa\u7b49\u529f\u80fd\u3002\u5982\u679c\u5728\u5185\u6838\u7ebf\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u6216\u5185\u5b58\u4e0d\u591f\u7684\u60c5\u51b5\uff0c\u5c31\u8ba4\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u51fa\u73b0\u9519\u8bef\u4e86\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u76f4\u63a5\u5b95\u673a\u3002\u5728ucore\u4e2d\uff0c\u5c31\u662f\u8c03\u7528panic\u51fd\u6570\uff0c\u8fdb\u5165\u5185\u6838\u8c03\u8bd5\u76d1\u63a7\u5668kernel_debug_monitor\u3002</p> <p>\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u601d\u60f3\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u5bf9\u7a0b\u5e8f\u5458\u7684\u8981\u6c42\u5f88\u9ad8\u3002\u4ece\u7406\u8bba\u4e0a\u8bb2\uff08\u7406\u60f3\u60c5\u51b5\uff09\uff0c\u5982\u679c\u7a0b\u5e8f\u5458\u90fd\u662f\u80fd\u591f\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u201c\u9ad8\u624b\u201d\uff0c\u80fd\u591f\u52e4\u4fed\u548c\u9ad8\u6548\u5730\u4f7f\u7528\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\uff0c\u4e14\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u90fd\u4e3a\u4ed6\u4eba\u7740\u60f3\uff0c\u5177\u6709\u5949\u732e\u7cbe\u795e\uff0c\u5728\u522b\u7684\u5e94\u7528\u9700\u8981\u8ba1\u7b97\u673a\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u80fd\u591f\u4ece\u5927\u5c40\u51fa\u53d1\uff0c\u4ece\u6574\u4e2a\u7cfb\u7edf\u7684\u6267\u884c\u6548\u7387\u51fa\u53d1\uff0c\u8ba9\u51fa\u81ea\u5df1\u5360\u7528\u7684\u8d44\u6e90\uff0c\u90a3\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u7f16\u5199\u51fa\u6765\u7684\u7a0b\u5e8f\u76f4\u63a5\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u8fd0\u884c\u5373\u53ef\uff0c\u4e5f\u5c31\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u5b58\u5728\u7684\u5fc5\u8981\u4e86\u3002</p> <p>\u4f46\u73b0\u5b9e\u4e0e\u7406\u8bba\u7684\u5dee\u8ddd\u662f\u5de8\u5927\u7684\uff0c\u80fd\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u662f\u6781\u5c11\u6570\u7684\uff0c\u4e0e\u5f53\u524d\u7684\u5e94\u7528\u7a0b\u5e8f\u5458\u76f8\u6bd4\uff0c\u4f30\u8ba1\u5927\u7ea6\u5dee\u4e863~4\u4e2a\u6570\u91cf\u7ea7\u3002\u5982\u679c\u8fd8\u8981\u6c42\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u8003\u8651\u5176\u4ed6\u672a\u77e5\u7a0b\u5e8f\u5458\u7684\u672a\u77e5\u9700\u6c42\uff0c\u90a3\u8fd9\u6837\u7684\u7a0b\u5e8f\u5458\u4f30\u8ba1\u53ef\u4ee5\u6210\u4e3a\u662f\u7f16\u7a0b\u754c\u7684\u201c\u4e0a\u5e1d\u201d\u4e86\u3002</p> <p>\u4ece\u5e94\u7528\u7a0b\u5e8f\u7f16\u5199\u548c\u8fd0\u884c\u7684\u89d2\u5ea6\u770b\uff0c\u65e2\u7136\u7a0b\u5e8f\u5458\u90fd\u4e0d\u662f\u201c\u4e0a\u5e1d\u201d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u5c31\u9700\u8981\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u5199\u7684\u7a0b\u5e8f\u63d0\u4f9b\u4e00\u4e2a\u65e2\u201c\u5bbd\u677e\u201d\u53c8\u201c\u4e25\u683c\u201d\u7684\u6267\u884c\u73af\u5883\uff0c\u8ba9\u5bf9\u5185\u5b58\u5927\u5c0f\u548cCPU\u4f7f\u7528\u65f6\u95f4\u7b49\u8d44\u6e90\u7684\u9650\u5236\u6ca1\u6709\u4ed4\u7ec6\u8003\u8651\u7684\u5e94\u7528\u7a0b\u5e8f\u90fd\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6b63\u5e38\u8fd0\u884c\uff0c\u4e14\u5373\u4f7f\u7a0b\u5e8f\u592a\u53ef\u9760\uff0c\u4e5f\u53ea\u80fd\u7834\u574f\u81ea\u5df1\uff0c\u800c\u4e0d\u80fd\u7834\u574f\u5176\u4ed6\u8fd0\u884c\u7a0b\u5e8f\u548c\u6574\u4e2a\u7cfb\u7edf\u3002\u201c\u4e25\u683c\u201d\u5c31\u662f\u5b89\u5168\u6027\u4fdd\u8bc1\uff0c\u5373\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u4e0d\u4f1a\u7834\u574f\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u7b49\u72ec\u5360\u7684\u8d44\u6e90\uff1b\u201c\u5bbd\u677e\u201d\u5c31\u7b97\u662f\u65b9\u4fbf\u6027\u652f\u6301\uff0c\u5373\u63d0\u4f9b\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5c3d\u91cf\u4e30\u5bcc\u7684\u670d\u52a1\u529f\u80fd\u548c\u4e00\u4e2a\u8fdc\u5927\u4e8e\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8003\u8651\u5f88\u591a\u7e41\u7410\u7684\u7ec6\u8282\uff08\u6bd4\u5982\u5982\u4f55\u521d\u59cb\u5316PCI\u603b\u7ebf\u548c\u5916\u8bbe\u7b49\uff0c\u5982\u4f55\u7ba1\u7406\u7269\u7406\u5185\u5b58\u7b49\uff09\u3002</p>"},{"location":"lab5/appendix/#_2","title":"\u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883","text":"<p>\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u7684\u4ecb\u7ecd\u4e2d\uff0c\u4e00\u822c\u63d0\u5230\u8fdb\u7a0b\u7684\u6982\u5ff5\u5176\u5b9e\u4e3b\u8981\u662f\u6307\u7528\u6237\u8fdb\u7a0b\u3002\u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\u7684\u89d2\u5ea6\u770b\uff0c\u5176\u5b9e\u7528\u6237\u8fdb\u7a0b\u662f\u6307\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5728\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u6237\u73af\u5883\u4e2d\u7684\u4e00\u6b21\u6267\u884c\u8fc7\u7a0b\u3002\u8fd9\u91cc\u7684\u91cd\u70b9\u662f\u7528\u6237\u73af\u5883\u3002\u7528\u6237\u73af\u5883\u6709\u5565\u529f\u80fd\uff1f\u7528\u6237\u73af\u5883\u6307\u7684\u662f\u4ec0\u4e48\uff1f</p> <p>\u4ece\u529f\u80fd\u4e0a\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u8fd9\u4e2a\u7528\u6237\u73af\u5883\u6709\u4e24\u65b9\u9762\u7684\u7279\u70b9\u3002\u4e00\u65b9\u9762\u4e0e\u5b58\u50a8\u7a7a\u95f4\u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u4e14\u8ba9\u5404\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbf\u95ee\u4e0d\u91cd\u53e0\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u4e0d\u80fd\u76f8\u4e92\u7834\u574f\u5404\u81ea\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5229\u7528\u865a\u62df\u5185\u5b58\u7684\u529f\u80fd\uff08\u9875\u6362\u5165\u6362\u51fa\uff09\u3002\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e86\u8fdc\u5927\u4e8e\u5b9e\u9645\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\u4e0e\u6267\u884c\u6307\u4ee4\u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u6267\u884c\u7684\u6307\u4ee4\uff0c\u4e0d\u80fd\u8ba9\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u7279\u6743\u6307\u4ee4\uff08\u6bd4\u5982\u4fee\u6539\u9875\u8868\u8d77\u59cb\u5730\u5740\uff09\uff0c\u4ece\u800c\u4fdd\u8bc1\u7528\u6237\u8fdb\u7a0b\u65e0\u6cd5\u7834\u574f\u7cfb\u7edf\u3002\u4f46\u5982\u679c\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u5219\u5f88\u591a\u529f\u80fd\uff08\u6bd4\u5982\u8bbf\u95ee\u78c1\u76d8\u7b49\uff09\u65e0\u6cd5\u5b9e\u73b0\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u529f\u80fd\uff0c\u7ed9\u7528\u6237\u8fdb\u7a0b\u4e00\u4e2a\u201c\u670d\u52a1\u7a97\u53e3\u201d,\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u201c\u7a97\u53e3\u201d\u5411\u64cd\u4f5c\u7cfb\u7edf\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u7528\u6237\u8fdb\u7a0b\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u3002\u53e6\u5916\uff0c\u8fd8\u8981\u6709\u4e00\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8ba9\u7528\u6237\u8fdb\u7a0b\u4e0d\u4e3b\u52a8\u653e\u5f03\u4f7f\u7528CPU\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u901a\u8fc7\u8fd9\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\u5f3a\u5236\u8ba9\u7528\u6237\u8fdb\u7a0b\u653e\u5f03\u4f7f\u7528CPU\uff0c\u4ece\u800c\u8ba9\u5176\u4ed6\u7528\u6237\u8fdb\u7a0b\u6709\u673a\u4f1a\u6267\u884c\u3002</p> <p>\u57fa\u4e8e\u529f\u80fd\u5206\u6790\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e2a\u7528\u6237\u73af\u5883\u5b9a\u4e49\u4e3a\u5982\u4e0b\u7ec4\u6210\u90e8\u5206\uff1a</p> <ul> <li>\u5efa\u7acb\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u9875\u8868\u548c\u652f\u6301\u9875\u6362\u5165\u6362\u51fa\u673a\u5236\u7684\u7528\u6237\u5185\u5b58\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u670d\u52a1\u4f8b\u7a0b\uff1a\u63d0\u4f9b\u5730\u5740\u9694\u79bb\u548c\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\u7684\u865a\u5b58\u7a7a\u95f4\u3002</li> <li>\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u6001CPU\u7279\u6743\u7ea7\uff1a\u5728\u7528\u6237\u6001CPU\u7279\u6743\u7ea7\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ea\u80fd\u6267\u884c\u4e00\u822c\u6307\u4ee4\uff0c\u5982\u679c\u7279\u6743\u6307\u4ee4\uff0c\u7ed3\u679c\u4e0d\u662f\u65e0\u6548\u5c31\u662f\u4ea7\u751f\u201c\u6267\u884c\u975e\u6cd5\u6307\u4ee4\u201d\u5f02\u5e38\uff1b</li> <li>\u7cfb\u7edf\u8c03\u7528\u673a\u5236\uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u201c\u670d\u52a1\u7a97\u53e3\u201d\uff1b</li> <li>\u4e2d\u65ad\u54cd\u5e94\u673a\u5236\uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8fd9\u6837\u4ea7\u751f\u4e2d\u65ad\u540e\uff0c\u5f53\u524d\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u5c06\u88ab\u5f3a\u5236\u6253\u65ad\uff0cCPU\u63a7\u5236\u6743\u5c06\u88ab\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u4f7f\u7528\u3002</li> </ul>"},{"location":"lab5/appendix/#_3","title":"\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u5206\u6790","text":"<p>\u5728\u8fd9\u4e2a\u73af\u5883\u4e0b\u8fd0\u884c\u7684\u8fdb\u7a0b\u5c31\u662f\u7528\u6237\u8fdb\u7a0b\u3002\u90a3\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u4e0b\u9762\u8fdb\u5165\u5185\u6838\u6001\u540e\uff0c\u90a3\u5728\u5185\u6838\u6001\u6267\u884c\u7684\u662f\u4ec0\u4e48\u5462\uff1f\u8fd8\u662f\u7528\u6237\u8fdb\u7a0b\u5417\uff1f\u9996\u5148\u5206\u6790\u4e00\u4e0b\u7528\u6237\u8fdb\u7a0b\u8fd9\u6837\u4f1a\u8fdb\u5165\u5185\u6838\u6001\u5462\uff1f\u56de\u987e\u4e00\u4e0blab1\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5f53\u4ea7\u751f\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\uff0c\u7528\u6237\u8fdb\u7a0b\u5c31\u4f1a\u5207\u6362\u5230\u5185\u6838\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6765\u3002\u8868\u9762\u4e0a\u770b\uff0c\u5230\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53d6\u5f97\u4e86CPU\u63a7\u5236\u6743\uff0c\u6240\u4ee5\u73b0\u5728\u6267\u884c\u7684\u5e94\u8be5\u662f\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\uff0c\u7531\u4e8e\u6b64\u65f6CPU\u5904\u4e8e\u6838\u5fc3\u6001\u7279\u6743\u7ea7\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7684\u6267\u884c\u8fc7\u7a0b\u5c31\u5c31\u5e94\u8be5\u662f\u5185\u6838\u8fdb\u7a0b\u4e86\u3002\u8fd9\u6837\u7406\u89e3\u5ffd\u7565\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\u3002\u5982\u679c\u8003\u8651\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5e94\u8be5\u5982\u679c\u6765\u7406\u89e3\u8fdb\u7a0b\u5462\uff1f</p> <p>\u4ece\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u89d2\u5ea6\u770b\uff0c\u5982\u679c\u6267\u884c\u4e86\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\uff08\u4e0a\u4e0b\u6587\uff09\u7684\u5207\u6362\uff0c\u5c31\u8ba4\u4e3a\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u53ca\u8fdb\u7a0b\u7684\u5206\u754c\u70b9\u8bbe\u5b9a\u5728\u6267\u884c\u8fdb\u7a0b\u5207\u6362\u7684\u524d\u540e\u3002\u5230\u5e95\u5207\u6362\u4e86\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\u53ea\u662f\u5207\u6362\u4e86\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u7684\u76f8\u5173\u57df\u4e2d\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u4e00\u76f4\u5230\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u8fdb\u7a0b\u5207\u6362\u5904\u4e3a\u6b62\u90fd\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\uff08\u5176\u4e2d\u6709\u64cd\u4f5c\u7cfb\u7edf\u7684\u90e8\u5206\u4ee3\u7801\u6267\u884c\u8fc7\u8fc7\u7a0b\uff09\u5373\u8fdb\u7a0b\u3002\u56e0\u4e3a\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6ca1\u6709\u66f4\u6362\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\u3002</p> <p>\u4ece\u6307\u4ee4\u6267\u884c\u7684\u89d2\u5ea6\u770b\uff0c\u5982\u679c\u518d\u4ed4\u7ec6\u5206\u6790\u4e00\u4e0b\u64cd\u4f5c\u7cfb\u7edf\u8fd9\u4e2a\u8f6f\u4ef6\u7684\u7279\u70b9\u5e76\u7ec6\u5316\u4e00\u4e0b\u8fdb\u5165\u5185\u6838\u539f\u56e0\uff0c\u5c31\u53ef\u4ee5\u770b\u51fa\u8fdb\u4e00\u6b65\u8fdb\u884c\u5212\u5206\u3002\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e3b\u8981\u529f\u80fd\u662f\u7ed9\u4e0a\u5c42\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\uff0c\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\u3002\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u867d\u7136\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4f46\u5176\u5b9e\u662f\u4e00\u4e2a\u57fa\u4e8e\u4e8b\u4ef6\u7684\u8f6f\u4ef6\uff0c\u8fd9\u91cc\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u54cd\u5e94\u7684\u4e8b\u4ef6\u5305\u62ec\u4e09\u7c7b\uff1a\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8981\u6c42\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u670d\u52a1\uff0c\u90a3\u4e48\u7528\u6237\u8fdb\u7a0b\u7684\u89d2\u5ea6\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8f6f\u4ef6\u5e93\uff08\u6bd4\u5982\u76f8\u5bf9\u4e8e\u7528\u6237\u6001\u7684libc\u5e93\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u770b\u4f5c\u662f\u5185\u6838\u6001\u7684libc\u5e93\uff09\uff0c\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u9700\u6c42\uff0c\u4ece\u6267\u884c\u903b\u8f91\u4e0a\u770b\uff0c\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e3b\u89c2\u201d\u6267\u884c\u7684\u4e00\u90e8\u5206\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u201c\u77e5\u9053\u201d\u64cd\u4f5c\u7cfb\u7edf\u8981\u505a\u7684\u4e8b\u60c5\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u7684\u4ee3\u7801\u7a7a\u95f4\u5305\u62ec\u7528\u6237\u6001\u7684\u6267\u884c\u7a0b\u5e8f\u548c\u5185\u6838\u6001\u54cd\u5e94\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u800c\u5728\u6838\u5fc3\u7279\u6743\u6001\u6267\u884c\u670d\u52a1\u8bf7\u6c42\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\uff0c\u4e3a\u6b64\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7684\u8fdb\u7a0b\u7684\u5185\u5b58\u865a\u62df\u7a7a\u95f4\u4e5f\u5305\u62ec\u4e24\u90e8\u5206\uff1a\u7528\u6237\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u548c\u6838\u5fc3\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u6b64\u65f6\u53d1\u751f\u7684\u4e8b\u4ef6\u662f\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\uff0c\u867d\u7136CPU\u63a7\u5236\u6743\u4e5f\u8f6c\u5165\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\uff0c\u4f46\u8fd9\u4e9b\u5185\u6838\u6267\u884c\u4ee3\u7801\u6267\u884c\u8fc7\u7a0b\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e0d\u77e5\u9053\u201d\u7684\uff0c\u662f\u53e6\u5916\u4e00\u6bb5\u6267\u884c\u903b\u8f91\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5b9e\u9645\u4e0a\u662f\u6267\u884c\u4e86\u4e24\u6bb5\u76ee\u6807\u4e0d\u540c\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u5904\u7406\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\u7684\u5185\u6838\u7ebf\u7a0b\u3002\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u548c\u5185\u6838\u7ebf\u7a0b\u5728\u4ea7\u751f\u4e2d\u65ad\u6216\u5f02\u5e38\u7684\u65f6\u5019\uff0cCPU\u786c\u4ef6\u5c31\u5b8c\u6210\u4e86\u5b83\u4eec\u4e4b\u95f4\u7684\u6307\u4ee4\u6d41\u5207\u6362\u3002</p>"},{"location":"lab5/appendix/#_4","title":"\u7528\u6237\u8fdb\u7a0b\u7684\u8fd0\u884c\u72b6\u6001\u5206\u6790","text":"<p>\u7528\u6237\u8fdb\u7a0b\u5728\u5176\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u5b58\u5728\u5f88\u591a\u79cd\u4e0d\u540c\u7684\u6267\u884c\u72b6\u6001\uff0c\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\uff0c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e00\u822c\u7684\u8fd0\u884c\u72b6\u6001\u6709\u4e94\u79cd\uff1a\u521b\u5efa\uff08new\uff09\u6001\u3001\u5c31\u7eea\uff08ready\uff09\u6001\u3001\u8fd0\u884c\uff08running\uff09\u6001\u3001\u7b49\u5f85\uff08blocked\uff09\u6001\u3001\u9000\u51fa\uff08exit\uff09\u6001\u3002\u5404\u4e2a\u72b6\u6001\u4e4b\u95f4\u4f1a\u7531\u4e8e\u53d1\u751f\u4e86\u67d0\u4e8b\u4ef6\u800c\u8fdb\u884c\u72b6\u6001\u8f6c\u6362\u3002</p> <p>\u4f46\u5728\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5177\u4f53\u5728\u54ea\u4e2a\u65f6\u95f4\u6bb5\u5904\u4e8e\u4e0a\u8ff0\u72b6\u6001\u7684\u5462\uff1f\u4e0a\u8ff0\u72b6\u6001\u662f\u5982\u4f55\u8f6c\u53d8\u7684\u5462\uff1f\u9996\u5148\uff0c\u6211\u4eec\u770b\u521b\u5efa\uff08new\uff09\u6001\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\uff0c\u800c\u4f53\u73b0\u8fdb\u7a0b\u5b58\u5728\u7684\u5c31\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u6240\u4ee5\u4e00\u65e6\u64cd\u4f5c\u7cfb\u7edf\u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u4f46\u7531\u4e8e\u8fdb\u7a0b\u80fd\u591f\u8fd0\u884c\u7684\u5404\u79cd\u8d44\u6e90\u8fd8\u6ca1\u51c6\u5907\u597d\uff0c\u6240\u4ee5\u6b64\u65f6\u7684\u8fdb\u7a0b\u5904\u4e8e\u521b\u5efa\uff08new\uff09\u6001\u3002\u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\u540e\uff0c\u8fdb\u7a0b\u5e76\u4e0d\u80fd\u5c31\u6267\u884c\u4e86\uff0c\u8fd8\u9700\u51c6\u5907\u597d\u5404\u79cd\u8d44\u6e90\uff0c\u5982\u679c\u628a\u8fdb\u7a0b\u6267\u884c\u6240\u9700\u8981\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6267\u884c\u4ee3\u7801\uff0c\u8981\u5904\u7406\u7684\u6570\u636e\u7b49\u90fd\u51c6\u5907\u597d\u4e86\uff0c\u5219\u6b64\u65f6\u8fdb\u7a0b\u5df2\u7ecf\u53ef\u4ee5\u6267\u884c\u4e86\uff0c\u4f46\u8fd8\u6ca1\u6709\u88ab\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5ea6\uff0c\u9700\u8981\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u9009\u62e9\u8fd9\u4e2a\u8fdb\u7a0b\u6267\u884c\uff0c\u4e8e\u662f\u628a\u8fd9\u4e2a\u505a\u597d\u201c\u6267\u884c\u51c6\u5907\u201d\u7684\u8fdb\u7a0b\u653e\u5165\u5230\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u5e76\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5904\u4e8e\u5c31\u7eea\uff08ready\uff09\u6001\u3002\u5f53\u64cd\u4f5c\u7cfb\u7edf\u7684\u8c03\u5ea6\u5668\u4ece\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u9009\u62e9\u4e86\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u540e\uff0c\u901a\u8fc7\u6267\u884c\u8fdb\u7a0b\u5207\u6362\uff0c\u5c31\u8ba9\u8fd9\u4e2a\u88ab\u9009\u4e0a\u7684\u5c31\u7eea\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5904\u4e8e\u8fd0\u884c\uff08running\uff09\u6001\u4e86\u3002\u5230\u4e86\u8fd0\u884c\u6001\u540e\uff0c\u4f1a\u51fa\u73b0\u4e09\u79cd\u4e8b\u4ef6\u3002\u5982\u679c\u8fdb\u7a0b\u9700\u8981\u7b49\u5f85\u67d0\u4e2a\u4e8b\u4ef6\uff08\u6bd4\u5982\u4e3b\u52a8\u7761\u772010\u79d2\u949f\uff0c\u6216\u8fdb\u7a0b\u8bbf\u95ee\u67d0\u4e2a\u5185\u5b58\u7a7a\u95f4\uff0c\u4f46\u6b64\u5185\u5b58\u7a7a\u95f4\u88ab\u6362\u51fa\u5230\u786c\u76d8swap\u5206\u533a\u4e2d\u4e86\uff0c\u8fdb\u7a0b\u4e0d\u5f97\u4e0d\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u628a\u7f13\u6162\u7684\u786c\u76d8\u4e0a\u7684\u6570\u636e\u91cd\u65b0\u8bfb\u56de\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a\u7b49\u5f85\uff08blocked\uff09\u6001\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u6d41\u7a0b\u6267\u884c\u7ed3\u675f\u4e86\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a\u9000\u51fa\uff08exit\uff09\u6001\uff0c\u5e76\u51c6\u5907\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u5360\u7528\u7684\u5404\u79cd\u8d44\u6e90\uff0c\u5f53\u628a\u8868\u793a\u6574\u4e2a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e5f\u56de\u6536\u4e86\uff0c\u8fd9\u8fdb\u7a0b\u5c31\u4e0d\u5b58\u5728\u4e86\u3002\u5728\u8fd9\u6574\u4e2a\u56de\u6536\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u7a0b\u90fd\u5904\u4e8e\u9000\u51fa\uff08exit\uff09\u6001\u30022\u8003\u8651\u5230\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u591a\u4e2a\u5904\u4e8e\u5c31\u7eea\u6001\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u53ea\u6709\u4e00\u4e2aCPU\uff0c\u6240\u4ee5\u4e3a\u4e86\u516c\u5e73\u8d77\u89c1\uff0c\u6bcf\u4e2a\u5c31\u7eea\u6001\u8fdb\u7a0b\u90fd\u53ea\u6709\u6709\u9650\u7684\u65f6\u95f4\u7247\u6bb5\uff0c\u5f53\u4e00\u4e2a\u8fd0\u884c\u6001\u7684\u8fdb\u7a0b\u7528\u5b8c\u4e86\u5b83\u7684\u65f6\u95f4\u7247\u6bb5\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5265\u593a\u6b64\u8fdb\u7a0b\u7684CPU\u4f7f\u7528\u6743\uff0c\u5e76\u628a\u6b64\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a\u5c31\u7eea\uff08ready\uff09\u6001\uff0c\u6700\u540e\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\u3002\u5982\u679c\u67d0\u4e2a\u5904\u4e8e\u7b49\u5f85\uff08blocked\uff09\u6001\u7684\u8fdb\u7a0b\u6240\u7b49\u5f85\u7684\u4e8b\u4ef6\u4ea7\u751f\u4e86\uff08\u6bd4\u5982\u7761\u7720\u65f6\u95f4\u5230\uff0c\u6216\u9700\u8981\u8bbf\u95ee\u7684\u6570\u636e\u5df2\u7ecf\u4ece\u786c\u76d8\u6362\u5165\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u5219\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u628a\u7b49\u5f85\u6b64\u4e8b\u4ef6\u7684\u8fdb\u7a0b\u72b6\u6001\u4ece\u7b49\u5f85\uff08blocked\uff09\u6001\u8f6c\u5230\u5c31\u7eea\uff08ready\uff09\u6001\u3002\u8fd9\u6837\u8fdb\u7a0b\u7684\u6574\u4e2a\u72b6\u6001\u8f6c\u6362\u5f62\u6210\u4e86\u4e00\u4e2a\u6709\u9650\u72b6\u6001\u81ea\u52a8\u673a\u3002</p>"},{"location":"lab5/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab5/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB5    := -DLAB5_EX1 -DLAB5_EX2(\u7b2c10\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\nLAB4    := -DLAB4_EX1 -DLAB4_EX2\nLAB5    := -DLAB5_EX1 -DLAB5_EX2\n# LAB6  := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0020000 (phys)\nedata 0xA0153EC0 (phys)\nend   0xA01571A0 (phys)\nKernel executable memory footprint: 1245KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0198000\nfree pages: 00001E68\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nsched class: RR_scheduler\nproc_init succeeded\nkernel_execve: pid = 2, name = \"exit\".\nI am the parent. Forking the child...\nI am parent, fork a child pid 3\nI am the parent, waiting now..\nI am the child.\nwaitpid 3 ok.\nexit pass.\nall user-mode processes have quit.\ninit check memory pass.\nkernel panic at kern/process/proc.c:554:\n    initproc exit.\n\nWelcome to the kernel debug monitor!!\nType 'help' for a list of commands.\nK&gt; </code></pre></p>"},{"location":"lab5/lab5/","title":"\u5b9e\u9a8c\u4e94\uff1a\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406","text":""},{"location":"lab5/lab5/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4e86\u89e3\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u521b\u5efa\u8fc7\u7a0b</li> <li>\u4e86\u89e3\u7cfb\u7edf\u8c03\u7528\u6846\u67b6\u7684\u5b9e\u73b0\u673a\u5236</li> <li>\u4e86\u89e3ucore\u5982\u4f55\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528sys_fork/sys_exec/sys_exit/sys_wait\u6765\u8fdb\u884c\u8fdb\u7a0b\u7ba1\u7406</li> </ul>"},{"location":"lab5/lab5/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u9a8c4\u5b8c\u6210\u4e86\u5185\u6838\u7ebf\u7a0b\uff0c\u4f46\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6240\u6709\u7684\u8fd0\u884c\u90fd\u5728\u5185\u6838\u6001\u6267\u884c\u3002\u5b9e\u9a8c5\u5c06\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\uff0c\u8ba9\u7528\u6237\u8fdb\u7a0b\u5728\u7528\u6237\u6001\u6267\u884c\uff0c\u4e14\u5728\u9700\u8981ucore\u652f\u6301\u65f6\uff0c\u53ef\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6765\u8ba9ucore\u63d0\u4f9b\u670d\u52a1\u3002\u4e3a\u6b64\u9700\u8981\u6784\u9020\u51fa\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u5e76\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_fork/sys_exec/sys_exit/sys_wait\u6765\u652f\u6301\u8fd0\u884c\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5b8c\u6210\u5bf9\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u7684\u57fa\u672c\u7ba1\u7406\u3002\u76f8\u5173\u539f\u7406\u4ecb\u7ecd\u53ef\u770b\u9644\u5f55\u3002</p>"},{"location":"lab5/lab5/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u5230\u5b9e\u9a8c\u56db\u4e3a\u6b62\uff0cucore\u8fd8\u4e00\u76f4\u5728\u6838\u5fc3\u6001\u201c\u6253\u8f6c\u201d\uff0c\u6ca1\u6709\u5230\u7528\u6237\u6001\u6267\u884c\u3002\u63d0\u4f9b\u5404\u79cd\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u7684\u5185\u6838\u7ebf\u7a0b\u53ea\u80fd\u5728CPU\u6838\u5fc3\u6001\u8fd0\u884c\u662f\u64cd\u4f5c\u7cfb\u7edf\u81ea\u8eab\u7684\u8981\u6c42\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u8981\u5446\u5728\u6838\u5fc3\u6001\uff0c\u624d\u80fd\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u3002\u4f46\u5e94\u7528\u7a0b\u5e8f\u5458\u4e5f\u9700\u8981\u7f16\u5199\u5404\u79cd\u5e94\u7528\u8f6f\u4ef6\uff0c\u4e14\u8981\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e0a\u8fd0\u884c\u3002\u5982\u679c\u628a\u8fd9\u4e9b\u5e94\u7528\u8f6f\u4ef6\u90fd\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u6765\u6267\u884c\uff0c\u90a3\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u5c31\u65e0\u6cd5\u5f97\u5230\u4fdd\u8bc1\u4e86\u3002\u6240\u4ee5\uff0cucore\u8981\u63d0\u4f9b\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u6267\u884c\u673a\u5236\uff0c\u7ed9\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u63d0\u4f9b\u4e00\u4e2a\u7528\u6237\u6001\u8fd0\u884c\u73af\u5883\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7b80\u8981\u5206\u6790\u672c\u5b9e\u9a8c\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u5206\u6790\u7528\u6237\u8fdb\u7a0b\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u6765\u9610\u8ff0\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u3002</p> <p>\u663e\u7136\uff0c\u7531\u4e8e\u8fdb\u7a0b\u7684\u6267\u884c\u7a7a\u95f4\u6269\u5c55\u5230\u4e86\u7528\u6237\u6001\u7a7a\u95f4\uff0c\u4e14\u51fa\u73b0\u4e86\u521b\u5efa\u5b50\u8fdb\u7a0b\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b49\u4e0elab4\u6709\u8f83\u5927\u4e0d\u540c\u7684\u5730\u65b9\uff0c\u6240\u4ee5\u5177\u4f53\u5b9e\u73b0\u7684\u4e0d\u540c\u4e3b\u8981\u96c6\u4e2d\u5728\u8fdb\u7a0b\u7ba1\u7406\u548c\u5185\u5b58\u7ba1\u7406\u90e8\u5206\u3002\u9996\u5148\uff0c\u6211\u4eec\u4eceucore\u7684\u521d\u59cb\u5316\u90e8\u5206\u6765\u770b\uff0c\u4f1a\u53d1\u73b0\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570kern_init\u6ca1\u6709\u4efb\u4f55\u53d8\u5316\u3002\u4f46\u8fd9\u5e76\u4e0d\u610f\u5473\u7740lab4\u4e0elab5\u5dee\u522b\u4e0d\u5927\u3002\u5176\u5b9ekern_init\u8c03\u7528\u7684\u7269\u7406\u5185\u5b58\u521d\u59cb\u5316\uff0c\u8fdb\u7a0b\u7ba1\u7406\u521d\u59cb\u5316\u7b49\u90fd\u6709\u4e00\u5b9a\u7684\u53d8\u5316\u3002</p> <p>\u5728\u5185\u5b58\u7ba1\u7406\u90e8\u5206\uff0c\u4e0elab4\u6700\u5927\u7684\u533a\u522b\u5c31\u662f\u589e\u52a0\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u3002\u4e3a\u4e86\u7ba1\u7406\u7528\u6237\u6001\u7684\u865a\u62df\u5185\u5b58\uff0c\u9700\u8981\u5bf9\u9875\u8868\u7684\u5185\u5bb9\u8fdb\u884c\u6269\u5c55\uff0c\u80fd\u591f\u628a\u90e8\u5206\u7269\u7406\u5185\u5b58\u6620\u5c04\u4e3a\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u3002\u5982\u679c\u67d0\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0cCPU\u5728\u7528\u6237\u6001\u4e0b\u6267\u884c\uff08\u5728CSR.CRMD\u4e2d\u7684PLV\u57df\uff0c\u5982\u679c\u4e3a0\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7279\u6743\u6001\uff1b\u5982\u679c\u4e3a3\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7528\u6237\u6001\u3002\uff09\uff0c\u5219\u53ef\u4ee5\u8bbf\u95ee\u672c\u8fdb\u7a0b\u9875\u8868\u63cf\u8ff0\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\uff0c\u4f46\u7531\u4e8e\u6743\u9650\u4e0d\u591f\uff0c\u4e0d\u80fd\u8bbf\u95ee\u5185\u6838\u6001\u865a\u62df\u5185\u5b58\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e0d\u540c\u7684\u8fdb\u7a0b\u6709\u5404\u81ea\u7684\u9875\u8868\uff0c\u6240\u4ee5\u5373\u4f7f\u4e0d\u540c\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u76f8\u540c\uff0c\u4f46\u7531\u4e8e\u9875\u8868\u628a\u865a\u62df\u9875\u6620\u5c04\u5230\u4e86\u4e0d\u540c\u7684\u7269\u7406\u9875\u5e27\uff0c\u6240\u4ee5\u4e0d\u540c\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u88ab\u9694\u79bb\u5f00\u7684\uff0c\u76f8\u4e92\u4e4b\u95f4\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u3002\u5728\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u548c\u5185\u6838\u6001\u5185\u6838\u7a7a\u95f4\u4e4b\u95f4\u9700\u8981\u62f7\u8d1d\u6570\u636e\uff0c\u8ba9CPU\u5904\u5728\u5185\u6838\u6001\u624d\u80fd\u5b8c\u6210\u5bf9\u7528\u6237\u7a7a\u95f4\u7684\u8bfb\u6216\u5199\uff0c\u4e3a\u6b64\u9700\u8981\u8bbe\u8ba1\u4e13\u95e8\u7684\u62f7\u8d1d\u51fd\u6570\uff08copy_from_user\u548ccopy_to_user\uff09\u5b8c\u6210\u3002\u4f46\u53cd\u4e4b\u5219\u4f1a\u5bfc\u81f4\u8fdd\u53cdCPU\u7684\u6743\u9650\u7ba1\u7406\uff0c\u5bfc\u81f4\u5185\u5b58\u8bbf\u95ee\u5f02\u5e38\u3002</p> <p>\u5728\u8fdb\u7a0b\u7ba1\u7406\u65b9\u9762\uff0c\u4e3b\u8981\u6d89\u53ca\u5230\u7684\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u4e0e\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u90e8\u5206\uff0c\u5305\u62ec\u5efa\u7acb\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u7ef4\u62a4\u8fdb\u7a0b\u53ef\u8bbf\u95ee\u7a7a\u95f4\uff08\u53ef\u80fd\u8fd8\u6ca1\u6709\u5efa\u7acb\u865a\u5b9e\u6620\u5c04\u5173\u7cfb\uff09\u7684\u4fe1\u606f\uff1b\u52a0\u8f7d\u4e00\u4e2aELF\u683c\u5f0f\u7684\u7a0b\u5e8f\u5230\u8fdb\u7a0b\u63a7\u5236\u5757\u7ba1\u7406\u7684\u5185\u5b58\u4e2d\u7684\u65b9\u6cd5\uff1b\u5728\u8fdb\u7a0b\u590d\u5236\uff08fork\uff09\u8fc7\u7a0b\u4e2d\uff0c\u628a\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u7a7a\u95f4\u62f7\u8d1d\u5230\u5b50\u8fdb\u7a0b\u5185\u5b58\u7a7a\u95f4\u7684\u6280\u672f\u3002\u53e6\u5916\u4e00\u90e8\u5206\u4e0e\u7528\u6237\u6001\u8fdb\u7a0b\u751f\u547d\u5468\u671f\u7ba1\u7406\u76f8\u5173\uff0c\u5305\u62ec\u8ba9\u8fdb\u7a0b\u653e\u5f03CPU\u800c\u7761\u7720\u7b49\u5f85\u67d0\u4e8b\u4ef6\uff1b\u8ba9\u7236\u8fdb\u7a0b\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff1b\u4e00\u4e2a\u8fdb\u7a0b\u6740\u6b7b\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff1b\u7ed9\u8fdb\u7a0b\u53d1\u6d88\u606f\uff1b\u5efa\u7acb\u8fdb\u7a0b\u7684\u8840\u7f18\u5173\u7cfb\u94fe\u8868\u3002</p> <p>\u5f53\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u5185\u5b58\u7ba1\u7406\u548c\u8fdb\u7a0b\u7ba1\u7406\u7684\u9700\u6c42\u540e\uff0c\u63a5\u4e0b\u6765ucore\u7684\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u5de5\u4f5c\u5c31\u6bd4\u8f83\u7b80\u5355\u4e86\u3002\u9996\u5148\uff0c\u201c\u786c\u201d\u6784\u9020\u51fa\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff08lab4\u4e2d\u5df2\u6709\u63cf\u8ff0\uff09\uff0c\u5b83\u662f\u540e\u7eed\u6240\u6709\u8fdb\u7a0b\u7684\u7956\u5148\uff1b\u7136\u540e\uff0c\u5728proc_init\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7alloc\u628a\u5f53\u524ducore\u7684\u6267\u884c\u73af\u5883\u8f6c\u53d8\u6210idle\u5185\u6838\u7ebf\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff1b\u7136\u540e\u8c03\u7528kernl_thread\u6765\u521b\u5efa\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binit_main\uff0c\u800cinit_main\u5185\u6838\u7ebf\u7a0b\u6709\u521b\u5efa\u4e86user_main\u5185\u6838\u7ebf\u7a0b\u3002\u5230\u6b64\uff0c\u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u5b8c\u6bd5\uff0c\u5e94\u8be5\u5f00\u59cb\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u8fd9\u7b2c\u4e00\u6b65\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7user_main\u51fd\u6570\u8c03\u7528kernel_tread\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u901a\u8fc7kernel_execve\u8c03\u7528\u6765\u628a\u67d0\u4e00\u5177\u4f53\u7a0b\u5e8f\u7684\u6267\u884c\u5185\u5bb9\u653e\u5165\u5185\u5b58\u3002\u5177\u4f53\u7684\u653e\u7f6e\u65b9\u5f0f\u662f\u6839\u636eld\u5728\u6b64\u6587\u4ef6\u4e0a\u7684\u5730\u5740\u5206\u914d\u4e3a\u57fa\u672c\u539f\u5219\uff0c\u628a\u7a0b\u5e8f\u7684\u4e0d\u540c\u90e8\u5206\u653e\u5230\u67d0\u8fdb\u7a0b\u7684\u7528\u6237\u7a7a\u95f4\u4e2d\uff0c\u4ece\u800c\u901a\u8fc7\u6b64\u8fdb\u7a0b\u6765\u5b8c\u6210\u7a0b\u5e8f\u63cf\u8ff0\u7684\u4efb\u52a1\u3002\u4e00\u65e6\u6267\u884c\u4e86\u8fd9\u4e00\u7a0b\u5e8f\u5bf9\u5e94\u7684\u8fdb\u7a0b\uff0c\u5c31\u4f1a\u4ece\u5185\u6838\u6001\u5207\u6362\u5230\u7528\u6237\u6001\u7ee7\u7eed\u6267\u884c\u3002\u4ee5\u6b64\u7c7b\u63a8\uff0cCPU\u5728\u7528\u6237\u7a7a\u95f4\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u5176\u5730\u5740\u7a7a\u95f4\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7528\u6237\u7684\u8fdb\u7a0b\u5f71\u54cd\uff0c\u4f46\u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\uff08\u7528\u6237\u8fdb\u7a0b\u76f4\u63a5\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u552f\u4e00\u901a\u9053\uff09\u3001\u5916\u8bbe\u4e2d\u65ad\u548c\u5f02\u5e38\u4e2d\u65ad\u7684\u4f1a\u968f\u65f6\u4ea7\u751f\uff0c\u4ece\u800c\u95f4\u63a5\u63a8\u52a8\u4e86\u7528\u6237\u8fdb\u7a0b\u5b9e\u73b0\u7528\u6237\u6001\u5230\u5230\u5185\u6838\u6001\u7684\u5207\u6362\u5de5\u4f5c\u3002ucore\u5bf9CPU\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u7684\u5207\u6362\u8fc7\u7a0b\u9700\u8981\u6bd4\u8f83\u4ed4\u7ec6\u5730\u5206\u6790\uff08\u8fd9\u5176\u5b9e\u662f\u5b9e\u9a8c\u4e00\u7684\u6269\u5c55\u7ec3\u4e60\uff09\u3002\u5f53\u8fdb\u7a0b\u6267\u884c\u7ed3\u675f\u540e\uff0c\u9700\u56de\u6536\u8fdb\u7a0b\u5360\u7528\u548c\u6ca1\u6d88\u8017\u5b8c\u6bd5\u7684\u8bbe\u5907\u6574\u4e2a\u8fc7\u7a0b\uff0c\u4e14\u4e3a\u65b0\u7684\u521b\u5efa\u8fdb\u7a0b\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u5f53\u7cfb\u7edf\u4e2d\u5b58\u5728\u591a\u4e2a\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\u65f6\uff0cucore\u91c7\u7528\u4e86\u4e00\u79cdFIFO\u7684\u5f88\u7b80\u5355\u7684\u8c03\u5ea6\u65b9\u6cd5\u6765\u7ba1\u7406\u6bcf\u4e2a\u8fdb\u7a0b\u5360\u7528CPU\u7684\u65f6\u95f4\u548c\u9891\u5ea6\u7b49\u3002\u5728ucore\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u8c03\u5ea6\u3001\u65f6\u95f4\u4e2d\u65ad\u3001\u7cfb\u7edf\u8c03\u7528\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u4f1a\u8fdb\u884c\u5207\u6362\u3001\u521b\u5efa\u3001\u7761\u7720\u3001\u7b49\u5f85\u3001\u53d1\u6d88\u606f\u7b49\u5404\u79cd\u4e0d\u540c\u7684\u64cd\u4f5c\uff0c\u5468\u800c\u590d\u59cb\uff0c\u751f\u751f\u4e0d\u606f\u3002</p>"},{"location":"lab5/process/","title":"\u8fdb\u7a0b\u7ba1\u7406","text":""},{"location":"lab5/process/#_1","title":"\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406","text":""},{"location":"lab5/process/#_2","title":"\u521b\u5efa\u7528\u6237\u8fdb\u7a0b","text":"<p>\u5728\u5b9e\u9a8c\u56db\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\u5bf9\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\uff0c\u4f46\u4e0e\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u8fc7\u7a0b\u76f8\u6bd4\uff0c\u521b\u5efa\u5185\u6838\u7ebf\u7a0b\u7684\u8fc7\u7a0b\u8fd8\u8fdc\u8fdc\u4e0d\u591f\u3002\u800c\u8fd9\u4e24\u4e2a\u521b\u5efa\u8fc7\u7a0b\u7684\u5dee\u5f02\u672c\u8d28\u4e0a\u5c31\u662f\u7528\u6237\u8fdb\u7a0b\u548c\u5185\u6838\u7ebf\u7a0b\u7684\u5dee\u5f02\u51b3\u5b9a\u7684\u3002</p>"},{"location":"lab5/process/#1","title":"1. \u5e94\u7528\u7a0b\u5e8f\u7684\u7ec4\u6210\u548c\u7f16\u8bd1","text":"<p>\u6211\u4eec\u9996\u5148\u6765\u770b\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u91cc\u6211\u4eec\u5047\u5b9a\u662fhello\u5e94\u7528\u7a0b\u5e8f\uff0c\u5728user/hello.c\u4e2d\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>#include &lt;stdio.h&gt;\n#include &lt;ulib.h&gt;\n\nint main(void) {\n    cprintf(\"Hello world!!.\\n\");\n    cprintf(\"I am process %d.\\n\", getpid());\n    cprintf(\"hello pass.\\n\");\n    return 0;\n}\n</code></pre> <p>hello\u5e94\u7528\u7a0b\u5e8f\u53ea\u662f\u8f93\u51fa\u4e00\u4e9b\u5b57\u7b26\u4e32\uff0c\u5e76\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_getpid\uff08\u5728getpid\u51fd\u6570\u4e2d\u8c03\u7528\uff09\u8f93\u51fa\u4ee3\u8868hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u6807\u8bc6--pid\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3ucore\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u80fd\u591f\u627e\u5230hello\u5e94\u7528\u7a0b\u5e8f\u3002\u8fd9\u9700\u8981\u5206\u6790ucore\u548chello\u662f\u5982\u4f55\u7f16\u8bd1\u7684\u3002\u5728\u672c\u5b9e\u9a8c\u6e90\u7801\u76ee\u5f55\u4e0b\u6267\u884cmake\uff0c\u53ef\u5f97\u5230\u5982\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>\u2026\u2026\n\n+ cc user/hello.c\n\nloongarch32-linux-gnu-gcc -c  -Iuser/libs -Ikern/include -fno-builtin-fprintf -fno-builtin -nostdlib  -nostdinc -g -G0 -Wa,-O0 -fno-pic -mno-shared -msoft-float -ggdb -gstabs -mlcsr   user/hello.c  -o obj/user/hello.o\n\nloongarch32-linux-gnu-ld -T user/libs/user.ld  obj/user/hello.o --whole-archive obj/user/libuser.a -o obj/user/hello\n\n\u2026\u2026\n\nsed 's/$FILE/hello/g' tools/piggy.S.in &gt; obj/user/hello.S\n\n\u2026\u2026\n\n# \u6ce8\u610f\uff0c\u53ef\u4ee5\u89c2\u5bdfobj/user/hello.S\u6587\u4ef6\uff0c\u8fd9\u91cc\u6709\u4f7f\u7528.incbin\u53bb\u5f15\u5165\u5148\u524d\u7f16\u8bd1\u597d\u7684obj/user/hello\nloongarch32-linux-gnu-gcc -c obj/user/hello.S -o obj/user/hello.piggy.o\n\nloongarch32-linux-gnu-ld -nostdlib -n -G 0 -static -T tools/kernel.ld  obj/init/init.o  \u2026\u2026 obj/user/hello.piggy.o \u2026\u2026 -o obj/ucore-kernel-piggy\n</code></pre> <p>\u4ece\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0chello\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4ec5\u4ec5\u662fhello.c\uff0c\u8fd8\u5305\u542b\u4e86\u652f\u6301hello\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u6001\u5e93\uff1a</p> <ul> <li>user/libs/initcode.S\uff1a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u7684\u8d77\u59cb\u7528\u6237\u6001\u6267\u884c\u5730\u5740\u201c_start\u201d\uff0c\u8c03\u6574\u4e86gp\u548csp\u540e\uff0c\u8c03\u7528umain\u51fd\u6570\u3002</li> <li>user/libs/umain.c\uff1a\u5b9e\u73b0\u4e86umain\u51fd\u6570\uff0c\u8fd9\u662f\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7b2c\u4e00\u4e2aC\u51fd\u6570\uff0c\u5b83\u5c06\u8c03\u7528\u5e94\u7528\u7a0b\u5e8f\u7684main\u51fd\u6570\uff0c\u5e76\u5728main\u51fd\u6570\u7ed3\u675f\u540e\u8c03\u7528exit\u51fd\u6570\uff0c\u800cexit\u51fd\u6570\u6700\u7ec8\u5c06\u8c03\u7528sys_exit\u7cfb\u7edf\u8c03\u7528\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u56de\u6536\u8fdb\u7a0b\u8d44\u6e90\u3002</li> <li>user/libs/ulib.[ch]\uff1a\u5b9e\u73b0\u4e86\u6700\u5c0f\u7684C\u51fd\u6570\u5e93\uff0c\u9664\u4e86\u4e00\u4e9b\u4e0e\u7cfb\u7edf\u8c03\u7528\u65e0\u5173\u7684\u51fd\u6570\uff0c\u5176\u4ed6\u51fd\u6570\u662f\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5305\u88c5\u3002</li> <li>user/libs/syscall.[ch]\uff1a\u7528\u6237\u5c42\u53d1\u51fa\u7cfb\u7edf\u8c03\u7528\u7684\u5177\u4f53\u5b9e\u73b0\u3002</li> <li>user/libs/stdio.c\uff1a\u5b9e\u73b0cprintf\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_putc\u6765\u5b8c\u6210\u5b57\u7b26\u8f93\u51fa\u3002</li> <li>user/libs/panic.c\uff1a\u5b9e\u73b0__panic/__warn\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_exit\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u9000\u51fa\u3002</li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u7528\u6237\u6001\u5e93\u51fd\u6570\u5b9e\u73b0\u5916\uff0c\u8fd8\u6709\u4e00\u4e9blibs/*.[ch]\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u548c\u5e94\u7528\u7a0b\u5e8f\u5171\u7528\u7684\u51fd\u6570\u5b9e\u73b0\u3002\u8fd9\u4e9b\u7528\u6237\u5e93\u51fd\u6570\u5176\u5b9e\u5728\u672c\u8d28\u4e0a\u4e0eUNIX\u7cfb\u7edf\u4e2d\u7684\u6807\u51c6libc\u6ca1\u6709\u533a\u522b\uff0c\u53ea\u662f\u5b9e\u73b0\u5f97\u5f88\u7b80\u5355\uff0c\u4f46hello\u5e94\u7528\u7a0b\u5e8f\u7684\u6b63\u786e\u6267\u884c\u79bb\u4e0d\u5f00\u8fd9\u4e9b\u5e93\u51fd\u6570\u3002</p> <p>\u3010\u6ce8\u610f\u3011libs/*.[ch]\u3001user/libs/*.[ch]\u3001user/*.[ch]\u7684\u6e90\u7801\u4e2d\u6ca1\u6709\u4efb\u4f55\u7279\u6743\u6307\u4ee4\u3002</p> <p>a00c3160 _binary_obj_user_hello_end a00125ac file_open a00018d0 strcpy a0000240 ide_device_valid a01455c0 _binary_obj_user_forktree_start a000cb30 wakeup_queue a00156f0 vfs_set_bootfs a000d12c cond_signal a0011850 sysfile_fsync a001a57c dev_init_stdout a00b4ac0 _binary_obj_user_hello_start</p> <p>\u5728make\u7684\u6700\u540e\u4e00\u6b65\u6267\u884c\u4e86\u4e00\u4e2ald\u547d\u4ee4\uff0c\u628ahello\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u7801obj/user/hello.piggy.o\u8fde\u63a5\u5728\u4e86ucore kernel\u7684\u672b\u5c3e\u3002\u5e76\u89c2\u5bdf<code>tools/piggy.S.in</code>\u6587\u4ef6\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86.global _binary_obj_user_FILE\\_start\u548c.global \\_binary\\_obj\\_user\\_FILE_end\u3002\u8fd9\u6837\u8fd9\u4e24\u4e2a\u7b26\u53f7\u5c31\u4f1a\u4fdd\u7559\u5728\u6700\u7ec8ld\u751f\u6210\u7684\u6587\u4ef6\u4e2d\uff0c\u8fd9\u6837\u8fd9\u4e2ahello\u7528\u6237\u7a0b\u5e8f\u5c31\u80fd\u591f\u548cucore\u5185\u6838\u4e00\u8d77\u88ab bootloader \u52a0\u8f7d\u5230\u5185\u5b58\u91cc\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7\u8fd9\u4e24\u4e2a\u5168\u5c40\u53d8\u91cf\u5b9a\u4f4dhello\u7528\u6237\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u3002\u800c\u5230\u4e86\u4e0e\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u5b9e\u9a8c\u540e\uff0cucore\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u90a3\u65f6\u6240\u6709\u7684\u7528\u6237\u7a0b\u5e8f\u5c31\u90fd\u4e0d\u518d\u7528\u8fd9\u79cd\u65b9\u6cd5\u8fdb\u884c\u52a0\u8f7d\u4e86\uff0c\u800c\u53ef\u4ee5\u7528\u5927\u5bb6\u719f\u6089\u7684\u6587\u4ef6\u65b9\u5f0f\u8fdb\u884c\u52a0\u8f7d\u4e86\u3002</p> <p>\uff08\u6ce8\uff0c\u540e\u7eed\u7684\u6587\u4ef6\u7cfb\u7edf\u91c7\u7528initrd\u7684\u65b9\u5f0f\uff0c\u5e76\u975e\u4f4d\u4e8e\u78c1\u76d8\u3002\uff09</p>"},{"location":"lab5/process/#2","title":"2. \u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4","text":"<p>\u5728user/libs/user.ld\u63cf\u8ff0\u4e86\u7528\u6237\u7a0b\u5e8f\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u6267\u884c\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a</p> <pre><code>SECTIONS {\n    /* Load programs at this address: \".\" means the current address */\n    . = 0x10000000;\n</code></pre> <p>\u5728tools/kernel.ld\u63cf\u8ff0\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u8d77\u59cb\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a</p> <pre><code>SECTIONS {\n    /* Load the kernel at this address: \".\" means the current address */\n    . = 0xa0000000;\n</code></pre> <p>\u8fd9\u6837ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u4e86\u4e24\u5757\uff0c\u4e00\u5757\u4e0e\u5185\u6838\u7ebf\u7a0b\u4e00\u6837\uff0c\u662f\u6240\u6709\u7528\u6237\u8fdb\u7a0b\u90fd\u5171\u4eab\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u6620\u5c04\u5230\u540c\u6837\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd9\u6837\u5728\u7269\u7406\u5185\u5b58\u4e2d\u53ea\u9700\u653e\u7f6e\u4e00\u4efd\u5185\u6838\u4ee3\u7801\uff0c\u4f7f\u5f97\u7528\u6237\u8fdb\u7a0b\u4ece\u7528\u6237\u6001\u8fdb\u5165\u6838\u5fc3\u6001\u65f6\uff0c\u5185\u6838\u4ee3\u7801\u53ef\u4ee5\u7edf\u4e00\u5e94\u5bf9\u4e0d\u540c\u7684\u5185\u6838\u7a0b\u5e8f\uff1b\u53e6\u5916\u4e00\u5757\u662f\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u867d\u7136\u865a\u62df\u5730\u5740\u8303\u56f4\u4e00\u6837\uff0c\u4f46\u6620\u5c04\u5230\u4e0d\u540c\u4e14\u6ca1\u6709\u4ea4\u96c6\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\u3002\u8fd9\u6837\u5f53ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u4ee3\u7801\uff09\u548c\u6570\u636e\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u5168\u5c40\u53d8\u91cf\u7b49\uff09\u653e\u5230\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e2d\u65f6\uff0c\u786e\u4fdd\u4e86\u5404\u4e2a\u8fdb\u7a0b\u4e0d\u4f1a\u201c\u975e\u6cd5\u201d\u8bbf\u95ee\u5230\u5176\u4ed6\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002</p> <p>\u8fd9\u6837ucore\u7ed9\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u5177\u4f53\u8bbe\u5b9a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff08kern/mm/memlayout.h\uff09\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p>"},{"location":"lab5/process/#3","title":"3. \u521b\u5efa\u5e76\u6267\u884c\u7528\u6237\u8fdb\u7a0b","text":"<p>\u5728\u786e\u5b9a\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\u548c\u6570\u636e\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u7a7a\u95f4\u5e03\u5c40\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6765\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\u4e86\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u662f\u7531\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binitproc\u901a\u8fc7\u628ahello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u8986\u76d6\u5230initproc\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6765\u521b\u5efa\u7684\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>    // kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread\nstatic int kernel_execve(const char *name, unsigned char *binary, size_t size) {\n    int ret, len = strlen(name);\n    asm volatile(\n      \"addi.w   $a7, $zero,%1;\\n\" // syscall no.\n      \"move $a0, %2;\\n\"\n      \"move $a1, %3;\\n\"\n      \"move $a2, %4;\\n\"\n      \"move $a3, %5;\\n\"\n      \"syscall  0;\\n\"\n      \"move %0, $a7;\\n\"\n      : \"=r\"(ret)\n      : \"i\"(SYSCALL_BASE+SYS_exec), \"r\"(name), \"r\"(len), \"r\"(binary), \"r\"(size) \n      : \"a0\", \"a1\", \"a2\", \"a3\", \"a7\"\n    );\n    return ret;\n}\n\n#define __KERNEL_EXECVE(name, path, ...) ({                         \\\nconst char *argv[] = {path, ##__VA_ARGS__, NULL};       \\\n                     kprintf(\"kernel_execve: pid = %d, name = \\\"%s\\\".\\n\",    \\\n                             current-&gt;pid, name);                            \\\n                     kernel_execve(name, argv);                              \\\n})\n\n#define KERNEL_EXECVE(x, ...)                   __KERNEL_EXECVE(#x, #x, ##__VA_ARGS__)\n\u2026\u2026\n// init_main - the second kernel thread used to create kswapd_main &amp; user_main kernel threads\nstatic int\ninit_main(void *arg) {\n    #ifdef TEST\n    KERNEL_EXECVE2(TEST, TESTSTART, TESTSIZE);\n    #else\n    KERNEL_EXECVE(hello);\n    #endif\n    panic(\"kernel_execve failed.\\n\");\n    return 0;\n}\n</code></pre> <p>\u5bf9\u4e8e\u4e0a\u8ff0\u4ee3\u7801\uff0c\u6211\u4eec\u9700\u8981\u4ece\u540e\u5411\u524d\u6309\u7167\u51fd\u6570/\u5b8f\u7684\u5b9e\u73b0\u4e00\u4e2a\u4e00\u4e2a\u6765\u5206\u6790\u3002Initproc\u7684\u6267\u884c\u4e3b\u4f53\u662finit_main\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5728\u7f3a\u7701\u60c5\u51b5\u4e0b\u662f\u6267\u884c\u5b8fKERNEL_EXECVE(hello)\uff0c\u800c\u8fd9\u4e2a\u5b8f\u6700\u7ec8\u662f\u8c03\u7528kernel_execve\u51fd\u6570\u6765\u8c03\u7528SYS_exec\u7cfb\u7edf\u8c03\u7528\uff0c\u7531\u4e8eld\u5728\u94fe\u63a5hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u65f6\u5b9a\u4e49\u4e86\u4e24\u5168\u5c40\u53d8\u91cf\uff1a</p> <ul> <li>_binary_obj___user_hello_out_start\uff1ahello\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e</li> <li>_binary_obj___user_hello_out_size\u4e2d\uff1ahello\u6267\u884c\u7801\u7684\u5927\u5c0f</li> </ul> <p>kernel_execve\u628a\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4f5c\u4e3aSYS_exec\u7cfb\u7edf\u8c03\u7528\u7684\u53c2\u6570\uff0c\u8ba9ucore\u6765\u521b\u5efa\u6b64\u7528\u6237\u8fdb\u7a0b\u3002\u5f53ucore\u6536\u5230\u6b64\u7cfb\u7edf\u8c03\u7528\u540e\uff0c\u5c06\u4f9d\u6b21\u8c03\u7528\u5982\u4e0b\u51fd\u6570</p> <pre><code>vector128(vectors.S)--\\&gt;\n\\_\\_alltraps(trapentry.S)--\\&gt;trap(trap.c)--\\&gt;trap\\_dispatch(trap.c)--\n--\\&gt;syscall(syscall.c)--\\&gt;sys\\_exec\uff08syscall.c\uff09--\\&gt;do\\_execve(proc.c)\n</code></pre> <p>\u6700\u7ec8\u901a\u8fc7do_execve\u51fd\u6570\u6765\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\u3002\u6b64\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u9996\u5148\u4e3a\u52a0\u8f7d\u65b0\u7684\u6267\u884c\u7801\u505a\u597d\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u6e05\u7a7a\u51c6\u5907\u3002\u5982\u679cmm\u4e0d\u4e3aNULL\uff0c\u5219\u8bbe\u7f6e\u9875\u8868\u4e3a\u5185\u6838\u7a7a\u95f4\u9875\u8868\uff0c\u4e14\u8fdb\u4e00\u6b65\u5224\u65admm\u7684\u5f15\u7528\u8ba1\u6570\u51cf1\u540e\u662f\u5426\u4e3a0\uff0c\u5982\u679c\u4e3a0\uff0c\u5219\u8868\u660e\u6ca1\u6709\u8fdb\u7a0b\u518d\u9700\u8981\u6b64\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u4e3a\u6b64\u5c06\u6839\u636emm\u4e2d\u7684\u8bb0\u5f55\uff0c\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7528\u6237\u7a7a\u95f4\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u672c\u8eab\u6240\u5360\u7a7a\u95f4\u3002\u6700\u540e\u628a\u5f53\u524d\u8fdb\u7a0b\u7684mm\u5185\u5b58\u7ba1\u7406\u6307\u9488\u4e3a\u7a7a\u3002\u7531\u4e8e\u6b64\u5904\u7684initproc\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u6240\u4ee5mm\u4e3aNULL\uff0c\u6574\u4e2a\u5904\u7406\u90fd\u4e0d\u4f1a\u505a\u3002</p> </li> <li> <p>\u63a5\u4e0b\u6765\u7684\u4e00\u6b65\u662f\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u65b0\u521b\u5efa\u7684\u7528\u6237\u6001\u865a\u62df\u7a7a\u95f4\u4e2d\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u8bfbELF\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7533\u8bf7\u5185\u5b58\u7a7a\u95f4\uff0c\u5efa\u7acb\u7528\u6237\u6001\u865a\u5b58\u7a7a\u95f4\uff0c\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7b49\u3002load_icode\u51fd\u6570\u5b8c\u6210\u4e86\u6574\u4e2a\u590d\u6742\u7684\u5de5\u4f5c\u3002</p> </li> </ul> <p>load_icode\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u7ed9\u7528\u6237\u8fdb\u7a0b\u5efa\u7acb\u4e00\u4e2a\u80fd\u591f\u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883\u3002\u6b64\u51fd\u6570\u6709\u4e00\u767e\u591a\u884c\uff0c\u5b8c\u6210\u4e86\u5982\u4e0b\u91cd\u8981\u5de5\u4f5c\uff1a</p> <ol> <li> <p>\u8c03\u7528mm_create\u51fd\u6570\u6765\u7533\u8bf7\u8fdb\u7a0b\u7684\u5185\u5b58\u7ba1\u7406\u6570\u636e\u7ed3\u6784mm\u6240\u9700\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u5bf9mm\u8fdb\u884c\u521d\u59cb\u5316\uff1b</p> </li> <li> <p>\u8c03\u7528setup_pgdir\u6765\u7533\u8bf7\u4e00\u4e2a\u9875\u76ee\u5f55\u8868\u6240\u9700\u7684\u4e00\u4e2a\u9875\u5927\u5c0f\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u628a\u63cf\u8ff0ucore\u5185\u6838\u865a\u7a7a\u95f4\u6620\u5c04\u7684\u5185\u6838\u9875\u8868\uff08boot_pgdir\u6240\u6307\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u6b64\u65b0\u76ee\u5f55\u8868\u4e2d\uff0c\u6700\u540e\u8ba9mm-&gt;pgdir\u6307\u5411\u6b64\u9875\u76ee\u5f55\u8868\uff0c\u8fd9\u5c31\u662f\u8fdb\u7a0b\u65b0\u7684\u9875\u76ee\u5f55\u8868\u4e86\uff0c\u4e14\u80fd\u591f\u6b63\u786e\u6620\u5c04\u5185\u6838\u865a\u7a7a\u95f4\uff1b</p> </li> <li> <p>\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u6765\u89e3\u6790\u6b64ELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u5e76\u8c03\u7528mm_map\u51fd\u6570\u6839\u636eELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\u8bf4\u660e\u7684\u5404\u4e2a\u6bb5\uff08\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u3001BSS\u6bb5\u7b49\uff09\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u5efa\u7acb\u5bf9\u5e94\u7684vma\u7ed3\u6784\uff0c\u5e76\u628avma\u63d2\u5165\u5230mm\u7ed3\u6784\u4e2d\uff0c\u4ece\u800c\u8868\u660e\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u5408\u6cd5\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff1b</p> </li> <li> <p>\u8c03\u7528\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5927\u5c0f\u5206\u914d\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u8d77\u59cb\u4f4d\u7f6e\u786e\u5b9a\u865a\u62df\u5730\u5740\uff0c\u5e76\u5728\u9875\u8868\u4e2d\u5efa\u7acb\u597d\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u7136\u540e\u628a\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u76f8\u5e94\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u4e2d\uff0c\u81f3\u6b64\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u548c\u6570\u636e\u5df2\u7ecf\u6839\u636e\u7f16\u8bd1\u65f6\u8bbe\u5b9a\u5730\u5740\u653e\u7f6e\u5230\u865a\u62df\u5185\u5b58\u4e2d\u4e86\uff1b</p> </li> <li> <p>\u9700\u8981\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u7528\u6237\u6808\uff0c\u4e3a\u6b64\u8c03\u7528mm_mmap\u51fd\u6570\u5efa\u7acb\u7528\u6237\u6808\u7684vma\u7ed3\u6784\uff0c\u660e\u786e\u7528\u6237\u6808\u7684\u4f4d\u7f6e\u5728\u7528\u6237\u865a\u7a7a\u95f4\u7684\u9876\u7aef\uff0c\u5927\u5c0f\u4e3a256\u4e2a\u9875\uff0c\u53731MB\uff0c\u5e76\u5206\u914d\u4e00\u5b9a\u6570\u91cf\u7684\u7269\u7406\u5185\u5b58\u4e14\u5efa\u7acb\u597d\u6808\u7684\u865a\u5730\u5740\u2190&gt;\u7269\u7406\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff1b</p> </li> <li> <p>\u81f3\u6b64,\u8fdb\u7a0b\u5185\u7684\u5185\u5b58\u7ba1\u7406vma\u548cmm\u6570\u636e\u7ed3\u6784\u5df2\u7ecf\u5efa\u7acb\u5b8c\u6210\uff0c\u4e8e\u662f\u628amm-&gt;pgdir\u8d4b\u503c\u5230\u53d8\u91cfcurrent_pgdir\u4e2d\uff0c\u5373\u66f4\u65b0\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6b64\u65f6\u7684initproc\u5df2\u7ecf\u88abhello\u7684\u4ee3\u7801\u548c\u6570\u636e\u8986\u76d6\uff0c\u6210\u4e3a\u4e86\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u6b64\u65f6\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\u8fd8\u6ca1\u5efa\u7acb\u597d\uff1b</p> </li> <li> <p>\u5148\u6e05\u7a7a\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u518d\u91cd\u65b0\u8bbe\u7f6e\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u4f7f\u5f97\u5728\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u540e\uff0c\u80fd\u591f\u8ba9CPU\u8f6c\u5230\u7528\u6237\u6001\u7279\u6743\u7ea7\uff0c\u5e76\u56de\u5230\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\uff0c\u4e14\u80fd\u591f\u8df3\u8f6c\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u6267\u884c\uff0c\u5e76\u786e\u4fdd\u5728\u7528\u6237\u6001\u80fd\u591f\u54cd\u5e94\u4e2d\u65ad\uff1b</p> </li> </ol> <p>\u81f3\u6b64\uff0c\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u73af\u5883\u5df2\u7ecf\u642d\u5efa\u5b8c\u6bd5\u3002\u6b64\u65f6initproc\u5c06\u6309\u4ea7\u751f\u7cfb\u7edf\u8c03\u7528\u7684\u51fd\u6570\u8c03\u7528\u8def\u5f84\u539f\u8def\u8fd4\u56de\uff0c\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u201certn\u201d\uff08\u4f4d\u4e8eexception.S\u7684\u6700\u540e\u4e00\u53e5\uff09\u540e\uff0c\u5c06\u5207\u6362\u5230\u7528\u6237\u8fdb\u7a0bhello\u7684\u7b2c\u4e00\u6761\u8bed\u53e5\u4f4d\u7f6e_start\u5904\uff08\u4f4d\u4e8euser/libs/initcode.S\u7684\u7b2c\u4e09\u53e5\uff09\u5f00\u59cb\u6267\u884c\u3002</p>"},{"location":"lab5/process/#_3","title":"\u8fdb\u7a0b\u9000\u51fa\u548c\u7b49\u5f85\u8fdb\u7a0b","text":"<p>\u5f53\u8fdb\u7a0b\u6267\u884c\u5b8c\u5b83\u7684\u5de5\u4f5c\u540e\uff0c\u5c31\u9700\u8981\u6267\u884c\u9000\u51fa\u64cd\u4f5c\uff0c\u91ca\u653e\u8fdb\u7a0b\u5360\u7528\u7684\u8d44\u6e90\u3002ucore\u5206\u4e86\u4e24\u6b65\u6765\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u9996\u5148\u7531\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u5927\u90e8\u5206\u8d44\u6e90\u7684\u5360\u7528\u5185\u5b58\u56de\u6536\u5de5\u4f5c\uff0c\u7136\u540e\u7531\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u5b8c\u6210\u5269\u4f59\u8d44\u6e90\u5360\u7528\u5185\u5b58\u7684\u56de\u6536\u5de5\u4f5c\u3002\u4e3a\u4f55\u4e0d\u8ba9\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u6240\u6709\u7684\u8d44\u6e90\u56de\u6536\u5de5\u4f5c\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u8fdb\u7a0b\u8981\u6267\u884c\u56de\u6536\u64cd\u4f5c\uff0c\u5c31\u8868\u660e\u6b64\u8fdb\u7a0b\u8fd8\u5b58\u5728\uff0c\u8fd8\u5728\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u5c31\u9700\u8981\u5185\u6838\u6808\u7684\u7a7a\u95f4\u4e0d\u80fd\u91ca\u653e\uff0c\u4e14\u8868\u793a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e0d\u80fd\u91ca\u653e\u3002\u6240\u4ee5\u9700\u8981\u7236\u8fdb\u7a0b\u6765\u5e2e\u5fd9\u91ca\u653e\u5b50\u8fdb\u7a0b\u65e0\u6cd5\u5b8c\u6210\u7684\u8fd9\u4e24\u4e2a\u8d44\u6e90\u56de\u6536\u5de5\u4f5c\u3002</p> <p>\u4e3a\u6b64\u5728\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u4e2d\u63d0\u4f9b\u4e86exit\u51fd\u6570\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_exit\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u5f53\u524d\u8fdb\u7a0b\u6267\u884c\u9000\u51fa\u8fc7\u7a0b\u4e2d\u7684\u90e8\u5206\u8d44\u6e90\u56de\u6536\u3002\u6211\u4eec\u6765\u770b\u770bucore\u662f\u5982\u4f55\u505a\u8fdb\u7a0b\u9000\u51fa\u5de5\u4f5c\u7684\u3002</p> <p>\u9996\u5148\uff0cexit\u51fd\u6570\u4f1a\u628a\u4e00\u4e2a\u9000\u51fa\u7801error_code\u4f20\u9012\u7ed9ucore\uff0cucore\u901a\u8fc7\u6267\u884c\u5185\u6838\u51fd\u6570do_exit\u6765\u5b8c\u6210\u5bf9\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u5904\u7406\uff0c\u4e3b\u8981\u5de5\u4f5c\u7b80\u5355\u5730\u8bf4\u5c31\u662f\u56de\u6536\u5f53\u524d\u8fdb\u7a0b\u6240\u5360\u7684\u5927\u90e8\u5206\u5185\u5b58\u8d44\u6e90\uff0c\u5e76\u901a\u77e5\u7236\u8fdb\u7a0b\u5b8c\u6210\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <p>1. \u5982\u679ccurrent-&gt;mm != NULL\uff0c\u8868\u793a\u662f\u7528\u6237\u8fdb\u7a0b\uff0c\u5219\u5f00\u59cb\u56de\u6536\u6b64\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff1b</p> <p>a) \u9996\u5148\u6267\u884c\u201clcr3(boot_cr3)\u201d\uff0c\u5207\u6362\u5230\u5185\u6838\u6001\u7684\u9875\u8868\u4e0a\uff0c\u8fd9\u6837\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u76ee\u524d\u53ea\u80fd\u5728\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u6267\u884c\u4e86\uff0c\u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u540e\u7eed\u91ca\u653e\u7528\u6237\u6001\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u7684\u5de5\u4f5c\u80fd\u591f\u6b63\u5e38\u6267\u884c\uff1b</p> <p>b) \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u6210\u5458\u53d8\u91cfmm\u7684\u6210\u5458\u53d8\u91cfmm_count\u51cf1\u540e\u4e3a0\uff08\u8868\u660e\u8fd9\u4e2amm\u6ca1\u6709\u518d\u88ab\u5176\u4ed6\u8fdb\u7a0b\u5171\u4eab\uff0c\u53ef\u4ee5\u5f7b\u5e95\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u4e86\u3002\uff09\uff0c\u5219\u5f00\u59cb\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7684\u5185\u5b58\u8d44\u6e90\uff1a</p> <p>i. \u8c03\u7528exit_mmap\u51fd\u6570\u91ca\u653ecurrent-&gt;mm-&gt;vma\u94fe\u8868\u4e2d\u6bcf\u4e2avma\u63cf\u8ff0\u7684\u8fdb\u7a0b\u5408\u6cd5\u7a7a\u95f4\u4e2d\u5b9e\u9645\u5206\u914d\u7684\u5185\u5b58\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684\u9875\u8868\u9879\u5185\u5bb9\u6e05\u7a7a\uff0c\u6700\u540e\u8fd8\u628a\u9875\u8868\u6240\u5360\u7528\u7684\u7a7a\u95f4\u91ca\u653e\u5e76\u628a\u5bf9\u5e94\u7684\u9875\u76ee\u5f55\u8868\u9879\u6e05\u7a7a\uff1b</p> <p>ii. \u8c03\u7528put_pgdir\u51fd\u6570\u91ca\u653e\u5f53\u524d\u8fdb\u7a0b\u7684\u9875\u76ee\u5f55\u6240\u5360\u7684\u5185\u5b58\uff1b</p> <p>iii. \u8c03\u7528mm_destroy\u51fd\u6570\u91ca\u653emm\u4e2d\u7684vma\u6240\u5360\u5185\u5b58\uff0c\u6700\u540e\u91ca\u653emm\u6240\u5360\u5185\u5b58\uff1b</p> <p>c) \u6b64\u65f6\u8bbe\u7f6ecurrent-&gt;mm\u4e3aNULL\uff0c\u8868\u793a\u4e0e\u5f53\u524d\u8fdb\u7a0b\u76f8\u5173\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u548c\u5bf9\u5e94\u7684\u5185\u5b58\u7ba1\u7406\u6210\u5458\u53d8\u91cf\u6240\u5360\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5df2\u7ecf\u56de\u6536\u5b8c\u6bd5\uff1b</p> <p>2. \u8fd9\u65f6\uff0c\u8bbe\u7f6e\u5f53\u524d\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001current-&gt;state=PROC_ZOMBIE\uff0c\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u7801current-&gt;exit_code=error_code\u3002\u6b64\u65f6\u5f53\u524d\u8fdb\u7a0b\u5df2\u7ecf\u4e0d\u80fd\u88ab\u8c03\u5ea6\u4e86\uff0c\u9700\u8981\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6765\u505a\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\uff08\u5373\u56de\u6536\u63cf\u8ff0\u6b64\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\uff09\uff1b</p> <p>3. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0bcurrent-&gt;parent\u5904\u4e8e\u7b49\u5f85\u5b50\u8fdb\u7a0b\u72b6\u6001\uff1a</p> <p>current-&gt;parent-&gt;wait_state==WT_CHILD\uff0c</p> <p>\u5219\u5524\u9192\u7236\u8fdb\u7a0b\uff08\u5373\u6267\u884c\u201cwakup_proc(current-&gt;parent)\u201d\uff09\uff0c\u8ba9\u7236\u8fdb\u7a0b\u5e2e\u52a9\u81ea\u5df1\u5b8c\u6210\u6700\u540e\u7684\u8d44\u6e90\u56de\u6536\uff1b</p> <p>4. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u8fd8\u6709\u5b50\u8fdb\u7a0b\uff0c\u5219\u9700\u8981\u628a\u8fd9\u4e9b\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6307\u9488\u8bbe\u7f6e\u4e3a\u5185\u6838\u7ebf\u7a0binitproc\uff0c\u4e14\u5404\u4e2a\u5b50\u8fdb\u7a0b\u6307\u9488\u9700\u8981\u63d2\u5165\u5230initproc\u7684\u5b50\u8fdb\u7a0b\u94fe\u8868\u4e2d\u3002\u5982\u679c\u67d0\u4e2a\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u662fPROC_ZOMBIE\uff0c\u5219\u9700\u8981\u5524\u9192initproc\u6765\u5b8c\u6210\u5bf9\u6b64\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\u3002</p> <p>5. \u6267\u884cschedule()\u51fd\u6570\uff0c\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\u3002</p> <p>\u90a3\u4e48\u7236\u8fdb\u7a0b\u5982\u4f55\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\u5462\uff1f\u8fd9\u8981\u6c42\u7236\u8fdb\u7a0b\u8981\u6267\u884cwait\u7528\u6237\u51fd\u6570\u6216wait_pid\u7528\u6237\u51fd\u6570\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u533a\u522b\u662f\uff0cwait\u51fd\u6570\u7b49\u5f85\u4efb\u610f\u5b50\u8fdb\u7a0b\u7684\u7ed3\u675f\u901a\u77e5\uff0c\u800cwait_pid\u51fd\u6570\u7b49\u5f85\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u5b50\u8fdb\u7a0b\u7ed3\u675f\u901a\u77e5\u3002\u8fd9\u4e24\u4e2a\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_wait\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9ucore\u6765\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u56de\u6536\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u6240\u5360\u5185\u5b58\u7a7a\u95f4\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <p>1. \u5982\u679cpid!=0\uff0c\u8868\u793a\u53ea\u627e\u4e00\u4e2a\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff0c\u5426\u5219\u627e\u4efb\u610f\u4e00\u4e2a\u5904\u4e8e\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff1b</p> <p>2. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e0d\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u8fd8\u6ca1\u6709\u9000\u51fa\uff0c\u5219\u5f53\u524d\u8fdb\u7a0b\u53ea\u597d\u8bbe\u7f6e\u81ea\u5df1\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_SLEEPING\uff0c\u7761\u7720\u539f\u56e0\u4e3aWT_CHILD\uff08\u5373\u7b49\u5f85\u5b50\u8fdb\u7a0b\u9000\u51fa\uff09\uff0c\u8c03\u7528schedule()\u51fd\u6570\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\uff0c\u81ea\u5df1\u7761\u7720\u7b49\u5f85\uff0c\u5982\u679c\u88ab\u5524\u9192\uff0c\u5219\u91cd\u590d\u8df3\u56de\u6b65\u9aa41\u5904\u6267\u884c\uff1b</p> <p>3. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u5904\u4e8e\u9000\u51fa\u72b6\u6001\uff0c\u9700\u8981\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff09\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u7ec8\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u9996\u5148\u628a\u5b50\u8fdb\u7a0b\u63a7\u5236\u5757\u4ece\u4e24\u4e2a\u8fdb\u7a0b\u961f\u5217proc_list\u548chash_list\u4e2d\u5220\u9664\uff0c\u5e76\u91ca\u653e\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u5806\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u3002\u81ea\u6b64\uff0c\u5b50\u8fdb\u7a0b\u624d\u5f7b\u5e95\u5730\u7ed3\u675f\u4e86\u5b83\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6d88\u9664\u4e86\u5b83\u6240\u5360\u7528\u7684\u6240\u6709\u8d44\u6e90\u3002</p>"},{"location":"lab5/process/#_4","title":"\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0","text":"<p>\u7cfb\u7edf\u8c03\u7528\u7684\u82f1\u6587\u540d\u5b57\u662fSystem Call\u3002\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4ec0\u4e48\u9700\u8981\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u5462\uff1f\u5176\u5b9e\u8fd9\u662f\u5b9e\u73b0\u4e86\u7528\u6237\u8fdb\u7a0b\u540e\uff0c\u81ea\u7136\u5f15\u7533\u51fa\u6765\u9700\u8981\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u3002\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u5b83\u5708\u5b9a\u597d\u7684\u201c\u7528\u6237\u73af\u5883\u201d\u4e2d\u6267\u884c\uff0c\u4f46\u201c\u7528\u6237\u73af\u5883\u201d\u9650\u5236\u4e86\u7528\u6237\u8fdb\u7a0b\u80fd\u591f\u6267\u884c\u7684\u6307\u4ee4\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u6267\u884c\u4e00\u822c\u7684\u6307\u4ee4\uff0c\u65e0\u6cd5\u6267\u884c\u7279\u6743\u6307\u4ee4\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u60f3\u6267\u884c\u4e00\u4e9b\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u6bd4\u5982\u901a\u8fc7\u7f51\u5361\u53d1\u7f51\u7edc\u5305\u7b49\uff0c\u53ea\u80fd\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u4ee3\u52b3\u4e86\u3002\u4e8e\u662f\u5c31\u9700\u8981\u4e00\u79cd\u673a\u5236\u6765\u786e\u4fdd\u7528\u6237\u8fdb\u7a0b\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u4f46\u80fd\u591f\u8bf7\u64cd\u4f5c\u7cfb\u7edf\u201c\u5e2e\u5fd9\u201d\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u8fd9\u79cd\u673a\u5236\u5c31\u662f\u7cfb\u7edf\u8c03\u7528\u3002</p> <p>\u91c7\u7528\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u4e3a\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e00\u4e2a\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u7edf\u4e00\u63a5\u53e3\u5c42\uff0c\u8fd9\u6837\u4e00\u6765\u53ef\u7b80\u5316\u7528\u6237\u8fdb\u7a0b\u7684\u5b9e\u73b0\uff0c\u628a\u4e00\u4e9b\u5171\u6027\u7684\u3001\u7e41\u7410\u7684\u3001\u4e0e\u786c\u4ef6\u76f8\u5173\u3001\u4e0e\u7279\u6743\u6307\u4ee4\u76f8\u5173\u7684\u4efb\u52a1\u653e\u5230\u64cd\u4f5c\u7cfb\u7edf\u5c42\u6765\u5b9e\u73b0\uff0c\u4f46\u63d0\u4f9b\u4e00\u4e2a\u7b80\u6d01\u7684\u63a5\u53e3\u7ed9\u7528\u6237\u8fdb\u7a0b\u8c03\u7528\uff1b\u4e8c\u6765\u8fd9\u5c42\u63a5\u53e3\u4e8b\u5148\u53ef\u89c4\u5b9a\u597d\uff0c\u4e14\u4e25\u683c\u68c0\u67e5\u7528\u6237\u8fdb\u7a0b\u4f20\u9012\u8fdb\u6765\u7684\u53c2\u6570\u548c\u64cd\u4f5c\u7cfb\u7edf\u8981\u8fd4\u56de\u7684\u6570\u636e\uff0c\u4f7f\u5f97\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u670d\u52a1\u7684\u540c\u65f6\uff0c\u4fdd\u62a4\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u4f1a\u88ab\u7528\u6237\u8fdb\u7a0b\u7834\u574f\u3002</p> <p>\u4ece\u786c\u4ef6\u5c42\u9762\u4e0a\u770b\uff0c\u9700\u8981\u786c\u4ef6\u80fd\u591f\u652f\u6301\u5728\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u5207\u6362\u5230\u5185\u6838\u6001\u3002\u8bd5\u9a8c\u4e00\u8bb2\u8ff0\u4e2d\u65ad\u786c\u4ef6\u652f\u6301\u548c\u8f6f\u4ef6\u5904\u7406\u8fc7\u7a0b\u5176\u5b9e\u5c31\u53ef\u4ee5\u7528\u6765\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u6240\u9700\u7684\u8f6f\u786c\u4ef6\u652f\u6301\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u5728ucore\u4e2d\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u3002</p>"},{"location":"lab5/process/#1_1","title":"1. \u5efa\u7acb\u7cfb\u7edf\u8c03\u7528\u7684\u7528\u6237\u5e93\u51c6\u5907","text":"<p>\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u521d\u59cb\u5316\u597d\u7cfb\u7edf\u8c03\u7528\u76f8\u5173\u7684\u4e2d\u65ad\u63cf\u8ff0\u7b26\u3001\u4e2d\u65ad\u5904\u7406\u8d77\u59cb\u5730\u5740\u7b49\u540e\uff0c\u8fd8\u9700\u5728\u7528\u6237\u6001\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u521d\u59cb\u5316\u597d\u76f8\u5173\u5de5\u4f5c\uff0c\u7b80\u5316\u5e94\u7528\u7a0b\u5e8f\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u590d\u6742\u6027\u3002\u4e3a\u6b64\u5728\u7528\u6237\u6001\u5efa\u7acb\u4e86\u4e00\u4e2a\u4e2d\u95f4\u5c42\uff0c\u5373\u7b80\u5316\u7684libc\u5b9e\u73b0\uff0c\u5728user/libs/ulib.[ch]\u548cuser/libs/syscall.[ch]\u4e2d\u5b8c\u6210\u4e86\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5c01\u88c5\u3002\u7528\u6237\u6001\u6700\u7ec8\u7684\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u662fsyscall\uff0c\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>static inline int\nsyscall(int num, ...) {\n    va_list ap;\n    va_start(ap, num);\n    uint32_t arg[MAX_ARGS];\n    int i, ret;\n    for (i = 0; i &lt; MAX_ARGS; i ++) {\n        arg[i] = va_arg(ap, uint32_t);\n    }\n    va_end(ap);\n\n    num += SYSCALL_BASE;\n    asm volatile(\n      \"move $a7, %1;\\n\" /* syscall no. */\n      \"move $a0, %2;\\n\"\n      \"move $a1, %3;\\n\"\n      \"move $a2, %4;\\n\"\n      \"move $a3, %5;\\n\"\n      \"syscall 0;\\n\"\n      \"move %0, $a7;\\n\"\n      : \"=r\"(ret)\n      : \"r\"(num), \"r\"(arg[0]), \"r\"(arg[1]), \"r\"(arg[2]), \"r\"(arg[3]) \n      : \"a0\", \"a1\", \"a2\", \"a3\", \"a7\"\n    );\n    return ret;\n}\n</code></pre>"},{"location":"lab5/process/#2_1","title":"2. \u4e0e\u7528\u6237\u8fdb\u7a0b\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528","text":"<p>\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u5404\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c5e\u6027\u5982\u4e0b\u6240\u793a\uff1a</p> \u7cfb\u7edf\u8c03\u7528\u540d\u542b\u4e49\u5177\u4f53\u5b8c\u6210\u670d\u52a1\u7684\u51fd\u6570 SYS_exitprocess exitdo_exit SYS_forkcreate child process, dup mm do_fork--&gt;wakeup_proc SYS_waitwait child processdo_wait SYS_execafter fork, process execute a new programload a program and refresh the mm SYS_yieldprocess flag itself need resechedulingproc-&gt;need_sched=1, then scheduler will rescheule this process SYS_killkill processdo_kill--&gt;proc-&gt;flags |= PF_EXITING,                                                        --&gt;wakeup_proc--&gt;do_wait--&gt;do_exit SYS_getpidget the process's pid <p>\u901a\u8fc7\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\uff0c\u53ef\u65b9\u4fbf\u5730\u5b8c\u6210\u4ece\u8fdb\u7a0b/\u7ebf\u7a0b\u521b\u5efa\u5230\u9000\u51fa\u7684\u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b\u3002</p>"},{"location":"lab5/process/#3_1","title":"3. \u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b","text":"<p>\u4e0e\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u76f8\u6bd4\uff0c\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u7684\u6709\u56db\u70b9\u4e3b\u8981\u7684\u4e0d\u540c\uff1a</p> <ul> <li>\u901a\u8fc7\u201csyscall\u201d\u6307\u4ee4\u53d1\u8d77\u8c03\u7528\uff1b</li> <li>\u901a\u8fc7\u201certn\u201d\u6307\u4ee4\u5b8c\u6210\u8c03\u7528\u8fd4\u56de\uff1b</li> <li>\u5f53\u5230\u8fbe\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u4e25\u683c\u68c0\u67e5\u7cfb\u7edf\u8c03\u7528\u4f20\u9012\u7684\u53c2\u6570\uff0c\u786e\u4fdd\u4e0d\u7834\u574f\u6574\u4e2a\u7cfb\u7edf\u7684\u5b89\u5168\u6027\uff1b</li> <li>\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u53ef\u5bfc\u81f4\u8fdb\u7a0b\u7b49\u5f85\u67d0\u4e8b\u4ef6\u53d1\u751f\uff0c\u4ece\u800c\u53ef\u5f15\u8d77\u8fdb\u7a0b\u5207\u6362\uff1b</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u4ee5getpid\u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b\u5927\u81f4\u770b\u770b\u64cd\u4f5c\u7cfb\u7edf\u662f\u5982\u4f55\u5b8c\u6210\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u7684\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u8c03\u7528getpid\u51fd\u6570\uff0c\u6700\u7ec8\u6267\u884c\u5230\u201csyscall\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u5efa\u7acb\u7684\u7cfb\u7edf\u8c03\u7528\u4e2d\u65ad\u63cf\u8ff0\u7b26\uff0c\u8f6c\u5165\u5185\u6838\u6001\uff0c\u5e76\u8df3\u8f6c\u5230exception13\u5904\uff08kern/trap/exception.S\uff09\uff0c\u5f00\u59cb\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\uff0c\u51fd\u6570\u8c03\u7528\u548c\u8fd4\u56de\u64cd\u4f5c\u7684\u5173\u7cfb\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>exception13(exception.S)--\\&gt;\n\\_\\loongarch_trap(trap.c)--\\&gt;trap\\_dispatch(trap.c)--\n--\\&gt;syscall(syscall.c)--\\&gt;sys\\_getpid(syscall.c)--\\&gt;\u2026\u2026--\\&gt;\\_\\exception_return(exception.S)\n</code></pre> <p>\u5728\u6267\u884ctrap\u51fd\u6570\u524d\uff0c\u8f6f\u4ef6\u8fd8\u9700\u8fdb\u4e00\u6b65\u4fdd\u5b58\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u524d\u7684\u6267\u884c\u73b0\u573a\uff0c\u5373\u628a\u4e0e\u7528\u6237\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u6240\u9700\u7684\u76f8\u5173\u5bc4\u5b58\u5668\u7b49\u5f53\u524d\u5185\u5bb9\u4fdd\u5b58\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27trapframe\u4e2d\uff08\u6ce8\u610f\uff0c\u5728\u521b\u5efa\u8fdb\u7a0b\u662f\uff0c\u628a\u8fdb\u7a0b\u7684trapframe\u653e\u5728\u7ed9\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u5206\u914d\u7684\u7a7a\u95f4\u7684\u9876\u90e8\uff09\u3002\u8f6f\u4ef6\u505a\u7684\u5de5\u4f5c\u5728exception.S\u7684exception_handler\u51fd\u6570\u90e8\u5206\uff1a</p> <pre><code>exception_handler:\n    // Save t0 and t1\n    csrwr   t0, LISA_CSR_KS0\n    csrwr   t1, LISA_CSR_KS1\n    // Save previous stack pointer in t1\n    move    t1, sp\n    csrwr   t1, LISA_CSR_KS2\n    //t1 saved the vaual of KS2,KS2 saved sp\n    /*\n        Warning: csrwr will bring the old csr register value into rd, \n        not only just write rd to csr register,\n        so you may see the rd changed.\n        It's documented in the manual from loongarch.\n    */\n\n    // check if user mode\n    csrrd   t0, LISA_CSR_PRMD  \n    andi    t0, t0, 3\n    beq     t0, zero, 1f\n\n\n    /* Coming from user mode - load kernel stack into sp */\n    la      t0, current // current pointer\n    ld.w    t0, t0, 0 // proc struct\n    ld.w    t0, t0, 12 // kstack pointer\n    addi.w  t1, zero, 1\n    slli.w  t1, t1, 13 // KSTACKSIZE=8192=pow(2,13)\n    add.w   sp, t0, t1\n    csrrd   t1, LISA_CSR_KS2\n\n1:\n    //saved EXST to t0 for save EXST to sp later(line 114) \n    csrrd   t0, LISA_CSR_EXST\n    //return KS2\n    csrrd   t1, LISA_CSR_KS2\n    b common_exception\n\n\ncommon_exception:\n   /*\n    * At this point:\n    *      Interrupts are off. (The processor did this for us.)\n    *      t0 contains the exception status(like exception cause on MIPS).\n    *      t1 contains the old stack pointer.\n    *      sp points into the kernel stack.\n    *      All other registers are untouched.\n    */\n\n   /*\n    * Allocate stack space for 35 words to hold the trap frame,\n    * plus four more words for a minimal argument block.\n    */\n    addi.w  sp, sp, -156\n    st.w    s8, sp, 148\n    st.w    s7, sp, 144\n    st.w    s6, sp, 140\n    st.w    s5, sp, 136\n    st.w    s4, sp, 132\n    st.w    s3, sp, 128\n    st.w    s2, sp, 124\n    st.w    s1, sp, 120\n    st.w    s0, sp, 116\n    st.w    fp, sp, 112\n    st.w    reserved_reg, sp, 108\n    st.w    t8, sp, 104\n    st.w    t7, sp, 100\n    st.w    t6, sp, 96\n    st.w    t5, sp, 92\n    st.w    t4, sp, 88\n    st.w    t3, sp, 84\n    st.w    t2, sp, 80\n    //st.w    t1, sp, 76\n    //st.w    t0, sp, 72\n    st.w    a7, sp, 68\n    st.w    a6, sp, 64\n    st.w    a5, sp, 60\n    st.w    a4, sp, 56\n    st.w    a3, sp, 52\n    st.w    a2, sp, 48\n    st.w    a1, sp, 44\n    st.w    a0, sp, 40\n    st.w    t1, sp, 36  // replace sp with real sp, now use t1 for free\n    st.w    tp, sp, 32\n    // save real t0 and t1 after real sp (stored in t1 previously) stored\n    csrrd   t1, LISA_CSR_KS1\n    st.w    t1, sp, 76\n    csrrd   t1, LISA_CSR_KS0\n    st.w    t1, sp, 72\n\n    // replace with real value\n    // save tf_era after t0 and t1 saved\n    csrrd   t1, LISA_CSR_EPC\n    st.w    t1, sp, 152\n\n   /*\n    * Save remaining exception context information.\n    */\n\n    // save ra (note: not in pushregs, it's tf_ra)\n    st.w    ra, sp, 28\n    // save prmd\n    csrrd   t1, LISA_CSR_PRMD\n    st.w    t1, sp, 24\n    // save estat\n    st.w    t0, sp, 20\n    // now use t0 for free\n    // store badv\n    csrrd   t0, LISA_CSR_BADV\n    st.w    t0, sp, 16\n    st.w    zero, sp, 12\n    // support nested interrupt\n\n    // IE and PLV will automatically set to 0 when trap occur\n\n    // set trapframe as function argument\n    addi.w  a0, sp, 16\n    li  t0, 0xb0    # PLV=0, IE=0, PG=1\n    csrwr   t0, LISA_CSR_CRMD\n    la.abs  t0, loongarch_trap\n    jirl    ra, t0, 0\n    //bl loongarch_trap\n\u2026\u2026\n</code></pre> <p>\u81ea\u6b64\uff0c\u7528\u4e8e\u4fdd\u5b58\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\u7684trapframe\u7684\u5185\u5bb9\u586b\u5199\u5b8c\u6bd5\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u5f00\u59cb\u5b8c\u6210\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002\u5728sys_getpid\u51fd\u6570\u4e2d\uff0c\u7b80\u5355\u5730\u628a\u5f53\u524d\u8fdb\u7a0b\u7684pid\u6210\u5458\u53d8\u91cf\u505a\u4e3a\u51fd\u6570\u8fd4\u56de\u503c\u5c31\u662f\u4e00\u4e2a\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002\u5b8c\u6210\u670d\u52a1\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u6309\u8c03\u7528\u5173\u7cfb\u7684\u8def\u5f84\u539f\u8def\u8fd4\u56de\u5230__exception.S\u4e2d\u3002\u7136\u540e\u64cd\u4f5c\u7cfb\u7edf\u5f00\u59cb\u6839\u636e\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\u5185\u5bb9\u505a\u6062\u590d\u6267\u884c\u73b0\u573a\u64cd\u4f5c\u3002\u5176\u5b9e\u5c31\u662f\u628atrapframe\u7684\u4e00\u90e8\u5206\u5185\u5bb9\u4fdd\u5b58\u5230\u5bc4\u5b58\u5668\u5185\u5bb9\u3002\u8fd9\u662f\u5185\u6838\u6808\u7684\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>exception_return:\n    // restore prmd\n    ld.w    t0, sp, 24\n    li      t1, 7\n    csrxchg t0, t1, LISA_CSR_PRMD\n    // restore era no k0 and k1 for la32, so must do first\n    ld.w    t0, sp, 152\n    csrwr   t0, LISA_CSR_EPC\n    // restore general registers\n    ld.w    ra, sp, 28\n    ld.w    tp, sp, 32\n    //ld.w    sp, sp, 36 (do it finally)\n    ld.w    a0, sp, 40\n    ld.w    a1, sp, 44\n    ld.w    a2, sp, 48\n    ld.w    a3, sp, 52\n    ld.w    a4, sp, 56\n    ld.w    a5, sp, 60\n    ld.w    a6, sp, 64\n    ld.w    a7, sp, 68\n    ld.w    t0, sp, 72\n    ld.w    t1, sp, 76\n    ld.w    t2, sp, 80\n    ld.w    t3, sp, 84\n    ld.w    t4, sp, 88\n    ld.w    t5, sp, 92\n    ld.w    t6, sp, 96\n    ld.w    t7, sp, 100\n    ld.w    t8, sp, 104\n    ld.w    reserved_reg, sp, 108\n    ld.w    fp, sp, 112\n    ld.w    s0, sp, 116\n    ld.w    s1, sp, 120\n    ld.w    s2, sp, 124\n    ld.w    s3, sp, 128\n    ld.w    s4, sp, 132\n    ld.w    s5, sp, 136\n    ld.w    s6, sp, 140\n    ld.w    s7, sp, 144\n    ld.w    s8, sp, 148\n    // restore sp\n    ld.w    sp, sp, 36\n    ertn\n\n    .end exception_return\n    .end common_exception\n</code></pre> <p>\u8fd9\u65f6\u6267\u884c\u201certn\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u5185\u6838\u6808\u7684\u60c5\u51b5\u56de\u590d\u5230\u7528\u6237\u6001\uff0c\u5373\u201csyscall\u201d\u540e\u7684\u90a3\u6761\u6307\u4ee4\u3002\u8fd9\u6837\u6574\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c31\u6267\u884c\u5b8c\u6bd5\u4e86\u3002</p> <p>\u81f3\u6b64\uff0c\u5b9e\u9a8c\u4e94\u4e2d\u7684\u4e3b\u8981\u5de5\u4f5c\u63cf\u8ff0\u5b8c\u6bd5\u3002</p>"},{"location":"lab5/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab5/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab5\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e863\u4e2a\u57fa\u672c\u7ec3\u4e60\u548c1\u4e2a\u6269\u5c55\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB5\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB5\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab5/task/#1","title":"\u7ec3\u4e601: \u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u5e76\u6267\u884c\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>**do_execv**\u51fd\u6570\u8c03\u7528load_icode\uff08\u4f4d\u4e8ekern/process/proc.c\u4e2d\uff09\u6765\u52a0\u8f7d\u5e76\u89e3\u6790\u4e00\u4e2a\u5904\u4e8e\u5185\u5b58\u4e2d\u7684ELF\u6267\u884c\u6587\u4ef6\u683c\u5f0f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5efa\u7acb\u76f8\u5e94\u7684\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u6765\u653e\u7f6e\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u7b49\uff0c\u4e14\u8981\u8bbe\u7f6e\u597dproc_struct\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cftrapframe\u4e2d\u7684\u5185\u5bb9\uff0c\u786e\u4fdd\u5728\u6267\u884c\u6b64\u8fdb\u7a0b\u540e\uff0c\u80fd\u591f\u4ece\u5e94\u7528\u7a0b\u5e8f\u8bbe\u5b9a\u7684\u8d77\u59cb\u6267\u884c\u5730\u5740\u5f00\u59cb\u6267\u884c\u3002\u9700\u8bbe\u7f6e\u6b63\u786e\u7684trapframe\u5185\u5bb9\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u63cf\u8ff0\u5f53\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u5e76\u52a0\u8f7d\u4e86\u5e94\u7528\u7a0b\u5e8f\u540e\uff0cCPU\u662f\u5982\u4f55\u8ba9\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6700\u7ec8\u5728\u7528\u6237\u6001\u6267\u884c\u8d77\u6765\u7684\u3002\u5373\u8fd9\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u88abucore\u9009\u62e9\u5360\u7528CPU\u6267\u884c\uff08RUNNING\u6001\uff09\u5230\u5177\u4f53\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b2c\u4e00\u6761\u6307\u4ee4\u7684\u6574\u4e2a\u7ecf\u8fc7\u3002</p>"},{"location":"lab5/task/#2","title":"\u7ec3\u4e602: \u7236\u8fdb\u7a0b\u590d\u5236\u81ea\u5df1\u7684\u5185\u5b58\u7a7a\u95f4\u7ed9\u5b50\u8fdb\u7a0b\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u51fd\u6570do_fork\u5728\u6267\u884c\u4e2d\u5c06\u62f7\u8d1d\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u7236\u8fdb\u7a0b\uff09\u7684\u7528\u6237\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\u7684\u5408\u6cd5\u5185\u5bb9\u5230\u65b0\u8fdb\u7a0b\u4e2d\uff08\u5b50\u8fdb\u7a0b\uff09\uff0c\u5b8c\u6210\u5185\u5b58\u8d44\u6e90\u7684\u590d\u5236\u3002\u5177\u4f53\u662f\u901a\u8fc7copy_range\u51fd\u6570\uff08\u4f4d\u4e8ekern/mm/pmm.c\u4e2d\uff09\u5b9e\u73b0\u7684\uff0c\u8bf7\u8865\u5145copy_range\u7684\u5b9e\u73b0\uff0c\u786e\u4fdd\u80fd\u591f\u6b63\u786e\u6267\u884c\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5982\u4f55\u8bbe\u8ba1\u5b9e\u73b0\u201dCopy on Write \u673a\u5236\u201c\uff0c\u7ed9\u51fa\u6982\u8981\u8bbe\u8ba1\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u3002</p> <p>Copy-on-write\uff08\u7b80\u79f0COW\uff09\u7684\u57fa\u672c\u6982\u5ff5\u662f\u6307\u5982\u679c\u6709\u591a\u4e2a\u4f7f\u7528\u8005\u5bf9\u4e00\u4e2a\u8d44\u6e90A\uff08\u6bd4\u5982\u5185\u5b58\u5757\uff09\u8fdb\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219\u6bcf\u4e2a\u4f7f\u7528\u8005\u53ea\u9700\u83b7\u5f97\u4e00\u4e2a\u6307\u5411\u540c\u4e00\u4e2a\u8d44\u6e90A\u7684\u6307\u9488\uff0c\u5c31\u53ef\u4ee5\u8be5\u8d44\u6e90\u4e86\u3002\u82e5\u67d0\u4f7f\u7528\u8005\u9700\u8981\u5bf9\u8fd9\u4e2a\u8d44\u6e90A\u8fdb\u884c\u5199\u64cd\u4f5c\uff0c\u7cfb\u7edf\u4f1a\u5bf9\u8be5\u8d44\u6e90\u8fdb\u884c\u62f7\u8d1d\u64cd\u4f5c\uff0c\u4ece\u800c\u4f7f\u5f97\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u83b7\u5f97\u4e00\u4e2a\u8be5\u8d44\u6e90A\u7684\u201c\u79c1\u6709\u201d\u62f7\u8d1d\u2014\u8d44\u6e90B\uff0c\u53ef\u5bf9\u8d44\u6e90B\u8fdb\u884c\u5199\u64cd\u4f5c\u3002\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u5bf9\u8d44\u6e90B\u7684\u6539\u53d8\u5bf9\u4e8e\u5176\u4ed6\u7684\u4f7f\u7528\u8005\u800c\u8a00\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u56e0\u4e3a\u5176\u4ed6\u4f7f\u7528\u8005\u770b\u5230\u7684\u8fd8\u662f\u8d44\u6e90A\u3002</p>"},{"location":"lab5/task/#3-forkexecwaitexit","title":"\u7ec3\u4e603: \u9605\u8bfb\u5206\u6790\u6e90\u4ee3\u7801\uff0c\u7406\u89e3\u8fdb\u7a0b\u6267\u884c fork/exec/wait/exit \u7684\u5b9e\u73b0\uff0c\u4ee5\u53ca\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\uff08\u4e0d\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9 fork/exec/wait/exit\u51fd\u6570\u7684\u5206\u6790\u3002\u5e76\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a  - \u8bf7\u5206\u6790fork/exec/wait/exit\u5728\u5b9e\u73b0\u4e2d\u662f\u5982\u4f55\u5f71\u54cd\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u7684\uff1f  - \u8bf7\u7ed9\u51faucore\u4e2d\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u751f\u547d\u5468\u671f\u56fe\uff08\u5305\u6267\u884c\u72b6\u6001\uff0c\u6267\u884c\u72b6\u6001\u4e4b\u95f4\u7684\u53d8\u6362\u5173\u7cfb\uff0c\u4ee5\u53ca\u4ea7\u751f\u53d8\u6362\u7684\u4e8b\u4ef6\u6216\u51fd\u6570\u8c03\u7528\uff09\u3002\uff08\u5b57\u7b26\u65b9\u5f0f\u753b\u5373\u53ef\uff09</p> <p>\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u8f93\u51fa\u7ed3\u679c\u548c\u7f16\u8bd1\u65b9\u6cd5\u4e2d\u7684\u7ed3\u679c\u4e00\u81f4\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002</p>"},{"location":"lab5/task/#challenge-copy-on-write-cow","title":"\u6269\u5c55\u7ec3\u4e60 Challenge \uff1a\u5b9e\u73b0 Copy on Write  \uff08COW\uff09\u673a\u5236","text":"<p>\u7ed9\u51fa\u5b9e\u73b0\u6e90\u7801,\u6d4b\u8bd5\u7528\u4f8b\u548c\u8bbe\u8ba1\u62a5\u544a\uff08\u5305\u62ec\u5728cow\u60c5\u51b5\u4e0b\u7684\u5404\u79cd\u72b6\u6001\u8f6c\u6362\uff08\u7c7b\u4f3c\u6709\u9650\u72b6\u6001\u81ea\u52a8\u673a\uff09\u7684\u8bf4\u660e\uff09\u3002</p> <p>\u8fd9\u4e2a\u6269\u5c55\u7ec3\u4e60\u6d89\u53ca\u5230\u672c\u5b9e\u9a8c\u548c\u4e0a\u4e00\u4e2a\u5b9e\u9a8c\u201c\u865a\u62df\u5185\u5b58\u7ba1\u7406\u201d\u3002\u5728ucore\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u5f53\u4e00\u4e2a\u7528\u6237\u7236\u8fdb\u7a0b\u521b\u5efa\u81ea\u5df1\u7684\u5b50\u8fdb\u7a0b\u65f6\uff0c\u7236\u8fdb\u7a0b\u4f1a\u628a\u5176\u7533\u8bf7\u7684\u7528\u6237\u7a7a\u95f4\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\uff0c\u5b50\u8fdb\u7a0b\u53ef\u5171\u4eab\u7236\u8fdb\u7a0b\u5360\u7528\u7684\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u4e2d\u7684\u9875\u9762\uff08\u8fd9\u5c31\u662f\u4e00\u4e2a\u5171\u4eab\u7684\u8d44\u6e90\uff09\u3002\u5f53\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u8fdb\u7a0b\u4fee\u6539\u6b64\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u4e2d\u7684\u67d0\u9875\u9762\u65f6\uff0cucore\u4f1a\u901a\u8fc7page fault\u5f02\u5e38\u83b7\u77e5\u8be5\u64cd\u4f5c\uff0c\u5e76\u5b8c\u6210\u62f7\u8d1d\u5185\u5b58\u9875\u9762\uff0c\u4f7f\u5f97\u4e24\u4e2a\u8fdb\u7a0b\u90fd\u6709\u5404\u81ea\u7684\u5185\u5b58\u9875\u9762\u3002\u8fd9\u6837\u4e00\u4e2a\u8fdb\u7a0b\u6240\u505a\u7684\u4fee\u6539\u4e0d\u4f1a\u88ab\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u89c1\u4e86\u3002\u8bf7\u5728ucore\u4e2d\u5b9e\u73b0\u8fd9\u6837\u7684COW\u673a\u5236\u3002</p> <p>\u7531\u4e8eCOW\u5b9e\u73b0\u6bd4\u8f83\u590d\u6742\uff0c\u5bb9\u6613\u5f15\u5165bug\uff0c\u8bf7\u53c2\u8003 https://dirtycow.ninja/ \u00a0\u770b\u770b\u80fd\u5426\u5728ucore\u7684COW\u5b9e\u73b0\u4e2d\u6a21\u62df\u8fd9\u4e2a\u9519\u8bef\u548c\u89e3\u51b3\u65b9\u6848\u3002\u9700\u8981\u6709\u89e3\u91ca\u3002</p> <p>\u8fd9\u662f\u4e00\u4e2abig challenge.</p>"},{"location":"lab6/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab6/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB6    := -DLAB6_EX2(\u7b2c11\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\nLAB4    := -DLAB4_EX1 -DLAB4_EX2\nLAB5    := -DLAB5_EX1 -DLAB5_EX2\nLAB6    := -DLAB6_EX2\n# LAB7  := -DLAB7_EX1 #-D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0020000 (phys)\nedata 0xA0153EC0 (phys)\nend   0xA01571A0 (phys)\nKernel executable memory footprint: 1245KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0198000\nfree pages: 00001E68\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nsched class: RR_scheduler\nproc_init succeeded\nkernel_execve: pid = 2, name = \"exit\".\nI am the parent. Forking the child...\nI am parent, fork a child pid 3\nI am the parent, waiting now..\nI am the child.\nwaitpid 3 ok.\nexit pass.\nall user-mode processes have quit.\ninit check memory pass.\nkernel panic at kern/process/proc.c:554:\n    initproc exit.\n\nWelcome to the kernel debug monitor!!\nType 'help' for a list of commands.\nK&gt; </code></pre> \u5b9e\u9a8c\u516d\u8f93\u51fa\u4e0e\u5b9e\u9a8c\u4e94\u76f8\u540c\uff0c\u5982\u5b9e\u9a8c\u516d\u8865\u5168\u7684\u4ee3\u7801\u5b58\u5728\u95ee\u9898\uff0c\u5219\u4e0d\u80fd\u5f97\u5230\u4e0e\u5b9e\u9a8c\u4e94\u76f8\u540c\u7684\u8f93\u51fa\u3002</p>"},{"location":"lab6/framework/","title":"\u8c03\u5ea6\u5668\u6846\u67b6","text":""},{"location":"lab6/framework/#_1","title":"\u8c03\u5ea6\u6846\u67b6\u548c\u8c03\u5ea6\u7b97\u6cd5","text":""},{"location":"lab6/framework/#_2","title":"\u8bbe\u8ba1\u601d\u8def","text":"<p>\u5b9e\u884c\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u5ea6\u7b56\u7565\uff0c\u5230\u5e95\u9700\u8981\u5b9e\u73b0\u54ea\u4e9b\u57fa\u672c\u529f\u80fd\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\uff1f\u9996\u5148\u8003\u8651\u5230\u4e00\u4e2a\u65e0\u8bba\u54ea\u79cd\u8c03\u5ea6\u7b97\u6cd5\u90fd\u9700\u8981\u9009\u62e9\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u6765\u5360\u7528CPU\u8fd0\u884c\u3002\u4e3a\u6b64\u6211\u4eec\u53ef\u628a\u5c31\u7eea\u8fdb\u7a0b\u7ec4\u7ec7\u8d77\u6765\uff0c\u53ef\u7528\u961f\u5217\uff08\u53cc\u5411\u94fe\u8868\uff09\u3001\u4e8c\u53c9\u6811\u3001\u7ea2\u9ed1\u6811\u3001\u6570\u7ec4\u2026\u7b49\u4e0d\u540c\u7684\u7ec4\u7ec7\u65b9\u5f0f\u3002</p> <p>\u5728\u64cd\u4f5c\u65b9\u9762\uff0c\u5982\u679c\u9700\u8981\u9009\u62e9\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\uff0c\u5c31\u53ef\u4ee5\u4ece\u57fa\u4e8e\u67d0\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u7684\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u4e2d\u9009\u62e9\u51fa\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u3002\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u201c\u9009\u62e9\u201d\u548c\u201c\u51fa\u201d\u662f\u4e24\u4e2a\u64cd\u4f5c\uff0c\u9009\u62e9\u662f\u5728\u96c6\u5408\u4e2d\u6311\u9009\u4e00\u4e2a\u201c\u5408\u9002\u201d\u7684\u8fdb\u7a0b\uff0c\u201c\u51fa\u201d\u610f\u5473\u7740\u79bb\u5f00\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u3002\u53e6\u5916\u8003\u8651\u5230\u4e00\u4e2a\u5904\u4e8e\u8fd0\u884c\u6001\u7684\u8fdb\u7a0b\u8fd8\u4f1a\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\uff08\u6bd4\u5982\u65f6\u95f4\u7247\u7528\u5b8c\u4e86\uff09\u56de\u5230\u5c31\u7eea\u6001\u800c\u4e0d\u80fd\u7ee7\u7eed\u5360\u7528CPU\u6267\u884c\uff0c\u8fd9\u5c31\u4f1a\u91cd\u65b0\u8fdb\u5165\u5230\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u4e2d\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u5c31\u5f62\u6210\u4e86\u8c03\u5ea6\u5668\u76f8\u5173\u7684\u4e09\u4e2a\u57fa\u672c\u64cd\u4f5c\uff1a\u5728\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u4e2d\u9009\u62e9\u3001\u8fdb\u5165\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u548c\u79bb\u5f00\u5c31\u7eea\u8fdb\u7a0b\u96c6\u5408\u3002\u8fd9\u4e09\u4e2a\u64cd\u4f5c\u5c5e\u4e8e\u8c03\u5ea6\u5668\u7684\u57fa\u672c\u64cd\u4f5c\u3002</p> <p>\u5728\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u7eea\u8fdb\u7a0b\u7684\u7b49\u5f85\u65f6\u95f4\u548c\u6267\u884c\u8fdb\u7a0b\u7684\u6267\u884c\u65f6\u95f4\u662f\u5f71\u54cd\u8c03\u5ea6\u9009\u62e9\u7684\u91cd\u8981\u56e0\u7d20\uff0c\u8fd9\u4e24\u4e2a\u56e0\u7d20\u968f\u7740\u65f6\u95f4\u7684\u6d41\u901d\u548c\u5404\u79cd\u4e8b\u4ef6\u7684\u53d1\u751f\u5728\u4e0d\u505c\u5730\u53d8\u5316\uff0c\u6bd4\u5982\u5904\u4e8e\u5c31\u7eea\u6001\u7684\u8fdb\u7a0b\u7b49\u5f85\u8c03\u5ea6\u7684\u65f6\u95f4\u5728\u589e\u957f\uff0c\u5904\u4e8e\u8fd0\u884c\u6001\u7684\u8fdb\u7a0b\u6240\u6d88\u8017\u7684\u65f6\u95f4\u7247\u5728\u51cf\u5c11\u7b49\u3002\u8fd9\u4e9b\u8fdb\u7a0b\u72b6\u6001\u53d8\u5316\u7684\u60c5\u51b5\u9700\u8981\u53ca\u65f6\u8ba9\u8fdb\u7a0b\u8c03\u5ea6\u5668\u77e5\u9053\uff0c\u4fbf\u4e8e\u9009\u62e9\u66f4\u5408\u9002\u7684\u8fdb\u7a0b\u6267\u884c\u3002\u6240\u4ee5\u8fd9\u79cd\u8fdb\u7a0b\u53d8\u5316\u7684\u60c5\u51b5\u5c31\u5f62\u6210\u4e86\u8c03\u5ea6\u5668\u76f8\u5173\u7684\u4e00\u4e2a\u53d8\u5316\u611f\u77e5\u64cd\u4f5c\uff1atimer\u65f6\u95f4\u4e8b\u4ef6\u611f\u77e5\u64cd\u4f5c\u3002\u8fd9\u6837\u5728\u8fdb\u7a0b\u8fd0\u884c\u6216\u7b49\u5f85\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8c03\u5ea6\u5668\u53ef\u4ee5\u8c03\u6574\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u4e0e\u8fdb\u7a0b\u8c03\u5ea6\u76f8\u5173\u7684\u5c5e\u6027\u503c\uff08\u6bd4\u5982\u6d88\u8017\u7684\u65f6\u95f4\u7247\u3001\u8fdb\u7a0b\u4f18\u5148\u7ea7\u7b49\uff09\uff0c\u5e76\u53ef\u80fd\u5bfc\u81f4\u5bf9\u8fdb\u7a0b\u7ec4\u7ec7\u5f62\u5f0f\u7684\u8c03\u6574\uff08\u6bd4\u5982\u4ee5\u65f6\u95f4\u7247\u5927\u5c0f\u7684\u987a\u5e8f\u6765\u91cd\u6392\u53cc\u5411\u94fe\u8868\u7b49\uff09\uff0c\u5e76\u6700\u7ec8\u53ef\u80fd\u5bfc\u81f4\u8c03\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u5360\u7528CPU\u8fd0\u884c\u3002\u8fd9\u4e2a\u64cd\u4f5c\u5c5e\u4e8e\u8c03\u5ea6\u5668\u7684\u8fdb\u7a0b\u8c03\u5ea6\u5c5e\u6027\u8c03\u6574\u64cd\u4f5c\u3002</p>"},{"location":"lab6/framework/#_3","title":"\u6570\u636e\u7ed3\u6784","text":"<p>\u5728\u7406\u89e3\u6846\u67b6\u4e4b\u524d\uff0c\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0b\u8c03\u5ea6\u5668\u6846\u67b6\u6240\u9700\u8981\u7684\u6570\u636e\u7ed3\u6784\u3002</p> <ul> <li>\u901a\u5e38\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u8fdb\u7a0b\u6c60\u662f\u5f88\u5927\u7684\uff08\u867d\u7136\u5728 ucore \u4e2d\uff0cMAX_PROCESS \u5f88\u5c0f\uff09\u3002\u5728 ucore \u4e2d\uff0c\u8c03\u5ea6\u5668\u5f15\u5165 run-queue\uff08\u7b80\u79f0rq,\u5373\u8fd0\u884c\u961f\u5217\uff09\u7684\u6982\u5ff5\uff0c\u901a\u8fc7\u94fe\u8868\u7ed3\u6784\u7ba1\u7406\u8fdb\u7a0b\u3002</li> <li>\u7531\u4e8e\u76ee\u524d ucore \u8bbe\u8ba1\u8fd0\u884c\u5728\u5355CPU\u4e0a\uff0c\u5176\u5185\u90e8\u53ea\u6709\u4e00\u4e2a\u5168\u5c40\u7684\u8fd0\u884c\u961f\u5217\uff0c\u7528\u6765\u7ba1\u7406\u7cfb\u7edf\u5185\u5168\u90e8\u7684\u8fdb\u7a0b\u3002</li> <li>\u8fd0\u884c\u961f\u5217\u901a\u8fc7\u94fe\u8868\u7684\u5f62\u5f0f\u8fdb\u884c\u7ec4\u7ec7\u3002\u94fe\u8868\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u662f\u4e00\u4e2alist_entry_t,\u6bcf\u4e2alist_entry_t \u53c8\u5bf9\u5e94\u5230\u4e86 struct proc_struct *,\u8fd9\u5176\u95f4\u7684\u8f6c\u6362\u662f\u901a\u8fc7\u5b8f le2proc \u6765\u5b8c\u6210 \u7684\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6211\u4eec\u77e5\u9053\u5728 struct proc_struct \u4e2d\u6709\u4e00\u4e2a\u53eb run_link \u7684 list_entry_t\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u504f\u79fb\u91cf\u9006\u5411\u627e\u5230\u5bf9\u56e0\u67d0\u4e2a run_list\u7684 struct proc_struct\u3002\u5373\u8fdb\u7a0b\u7ed3\u6784\u6307\u9488 proc = le2proc(\u94fe\u8868\u8282\u70b9\u6307\u9488, run_link)\u3002</li> <li>\u4e3a\u4e86\u4fdd\u8bc1\u8c03\u5ea6\u5668\u63a5\u53e3\u7684\u901a\u7528\u6027\uff0cucore\u8c03\u5ea6\u6846\u67b6\u5b9a\u4e49\u4e86\u5982\u4e0b\u63a5\u53e3\uff0c\u8be5\u63a5\u53e3\u4e2d\uff0c\u51e0\u4e4e\u5168\u90e8\u6210\u5458\u53d8\u91cf\u5747\u4e3a\u51fd\u6570\u6307\u9488\u3002\u5177\u4f53\u7684\u529f\u80fd\u4f1a\u5728\u540e\u9762\u7684\u6846\u67b6\u8bf4\u660e\u4e2d\u4ecb\u7ecd\u3002</li> </ul> <pre><code>struct sched_class {\n    // \u8c03\u5ea6\u5668\u7684\u540d\u5b57\n    const char *name;\n    // \u521d\u59cb\u5316\u8fd0\u884c\u961f\u5217\n    void (*init) (struct run_queue *rq);\n    // \u5c06\u8fdb\u7a0b p \u63d2\u5165\u961f\u5217 rq\n    void (*enqueue) (struct run_queue *rq, struct proc_struct *p);\n    // \u5c06\u8fdb\u7a0b p \u4ece\u961f\u5217 rq \u4e2d\u5220\u9664\n    void (*dequeue) (struct run_queue *rq, struct proc_struct *p);\n    // \u8fd4\u56de \u8fd0\u884c\u961f\u5217 \u4e2d\u4e0b\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u8fdb\u7a0b\n    struct proc_struct* (*pick_next) (struct run_queue *rq);\n    // timetick \u5904\u7406\u51fd\u6570\n    void (*proc_tick)(struct  run_queue* rq, struct proc_struct* p);\n};\n</code></pre> <ul> <li>\u6b64\u5916\uff0cproc.h \u4e2d\u7684 struct proc_struct \u4e2d\u4e5f\u8bb0\u5f55\u4e86\u4e00\u4e9b\u8c03\u5ea6\u76f8\u5173\u7684\u4fe1\u606f\uff1a</li> </ul> <pre><code>struct proc_struct {\n    // . . .\n    // \u8be5\u8fdb\u7a0b\u662f\u5426\u9700\u8981\u8c03\u5ea6\uff0c\u53ea\u5bf9\u5f53\u524d\u8fdb\u7a0b\u6709\u6548\n    volatile bool need_resched;\n    // \u8be5\u8fdb\u7a0b\u7684\u8c03\u5ea6\u94fe\u8868\u7ed3\u6784\uff0c\u8be5\u7ed3\u6784\u5185\u90e8\u7684\u8fde\u63a5\u7ec4\u6210\u4e86 \u8fd0\u884c\u961f\u5217 \u5217\u8868\n    list_entry_t run_link;\n    // \u8be5\u8fdb\u7a0b\u5269\u4f59\u7684\u65f6\u95f4\u7247\uff0c\u53ea\u5bf9\u5f53\u524d\u8fdb\u7a0b\u6709\u6548\n    int time_slice;\n    // round-robin \u8c03\u5ea6\u5668\u5e76\u4e0d\u4f1a\u7528\u5230\u4ee5\u4e0b\u6210\u5458\n    // \u8be5\u8fdb\u7a0b\u5728\u4f18\u5148\u961f\u5217\u4e2d\u7684\u8282\u70b9\uff0c\u4ec5\u5728 LAB6 \u4f7f\u7528\n    skew_heap_entry_t  lab6_run_pool;\n    // \u8be5\u8fdb\u7a0b\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\uff0c\u4ec5\u5728 LAB6 \u4f7f\u7528\n    uint32_t lab6_priority;\n    // \u8be5\u8fdb\u7a0b\u7684\u8c03\u5ea6\u6b65\u8fdb\u503c\uff0c\u4ec5\u5728 LAB6 \u4f7f\u7528\n    uint32_t lab6_stride;\n};\n</code></pre> <p>\u5728\u6b64\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u4f60\u9700\u8981\u4e86\u89e3 default_sched.c\u4e2d\u7684\u5b9e\u73b0RR\u8c03\u5ea6\u7b97\u6cd5\u7684\u51fd\u6570\u3002\u5728\u8be5\u6587\u4ef6\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230ucore \u5df2\u7ecf\u4e3a RR \u8c03\u5ea6\u7b97\u6cd5\u521b\u5efa\u597d\u4e86\u4e00\u4e2a\u540d\u4e3a RR_sched_class \u7684\u8c03\u5ea6\u7b56\u7565\u7c7b\u3002</p> <p>\u901a\u8fc7\u6570\u636e\u7ed3\u6784 struct run_queue \u6765\u63cf\u8ff0\u5b8c\u6574\u7684 run_queue\uff08\u8fd0\u884c\u961f\u5217\uff09\u3002\u5b83\u7684\u4e3b\u8981\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>struct run_queue {\n    //\u5176\u8fd0\u884c\u961f\u5217\u7684\u54e8\u5175\u7ed3\u6784\uff0c\u53ef\u4ee5\u770b\u4f5c\u662f\u961f\u5217\u5934\u548c\u5c3e\n    list_entry_t run_list;\n    //\u4f18\u5148\u961f\u5217\u5f62\u5f0f\u7684\u8fdb\u7a0b\u5bb9\u5668\uff0c\u53ea\u5728 LAB6 \u4e2d\u4f7f\u7528\n    skew_heap_entry_t  *lab6_run_pool;\n    //\u8868\u793a\u5176\u5185\u90e8\u7684\u8fdb\u7a0b\u603b\u6570\n    unsigned int proc_num;\n    //\u6bcf\u4e2a\u8fdb\u7a0b\u4e00\u8f6e\u5360\u7528\u7684\u6700\u591a\u65f6\u95f4\u7247\n    int max_time_slice;\n};\n</code></pre> <p>\u5728 ucore \u6846\u67b6\u4e2d\uff0c\u8fd0\u884c\u961f\u5217\u5b58\u50a8\u7684\u662f\u5f53\u524d\u53ef\u4ee5\u8c03\u5ea6\u7684\u8fdb\u7a0b\uff0c\u6240\u4ee5\uff0c\u53ea\u6709\u72b6\u6001\u4e3arunnable\u7684\u8fdb\u7a0b\u624d\u80fd\u591f\u8fdb\u5165\u8fd0\u884c\u961f\u5217\u3002\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u8fdb\u7a0b\u5e76\u4e0d\u4f1a\u5728\u8fd0\u884c\u961f\u5217\u4e2d\uff0c\u8fd9\u4e00\u70b9\u9700\u8981\u6ce8\u610f\u3002</p>"},{"location":"lab6/framework/#_4","title":"\u8c03\u5ea6\u70b9\u7684\u76f8\u5173\u5173\u952e\u51fd\u6570","text":"<p>\u867d\u7136\u8fdb\u7a0b\u5404\u79cd\u72b6\u6001\u53d8\u5316\u7684\u539f\u56e0\u548c\u5bfc\u81f4\u7684\u8c03\u5ea6\u5904\u7406\u5404\u5f02\uff0c\u4f46\u5176\u5b9e\u4ed4\u7ec6\u89c2\u5bdf\u5404\u4e2a\u6d41\u7a0b\u7684\u5171\u6027\u90e8\u5206\uff0c\u4f1a\u53d1\u73b0\u5176\u4e2d\u53ea\u6d89\u53ca\u4e86\u4e09\u4e2a\u5173\u952e\u8c03\u5ea6\u76f8\u5173\u51fd\u6570\uff1awakup_proc\u3001shedule\u3001run_timer_list\u3002\u5982\u679c\u6211\u4eec\u80fd\u591f\u8ba9\u8fd9\u4e09\u4e2a\u8c03\u5ea6\u76f8\u5173\u51fd\u6570\u7684\u5b9e\u73b0\u4e0e\u5177\u4f53\u8c03\u5ea6\u7b97\u6cd5\u65e0\u5173\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u8ba4\u4e3aucore\u5b9e\u73b0\u4e86\u4e00\u4e2a\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u65e0\u5173\u7684\u8c03\u5ea6\u6846\u67b6\u3002</p> <p>wakeup_proc\u51fd\u6570\u5176\u5b9e\u5b8c\u6210\u4e86\u628a\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u653e\u5165\u5230\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u7684\u5de5\u4f5c\uff0c\u4e3a\u6b64\u8fd8\u8c03\u7528\u4e86\u4e00\u4e2a\u8c03\u5ea6\u7c7b\u63a5\u53e3\u51fd\u6570sched_class_enqueue\uff0c\u8fd9\u4f7f\u5f97wakeup_proc\u7684\u5b9e\u73b0\u4e0e\u5177\u4f53\u8c03\u5ea6\u7b97\u6cd5\u65e0\u5173\u3002schedule\u51fd\u6570\u5b8c\u6210\u4e86\u4e0e\u8c03\u5ea6\u6846\u67b6\u548c\u8c03\u5ea6\u7b97\u6cd5\u76f8\u5173\u4e09\u4ef6\u4e8b\u60c5:\u628a\u5f53\u524d\u7ee7\u7eed\u5360\u7528CPU\u6267\u884c\u7684\u8fd0\u884c\u8fdb\u7a0b\u653e\u653e\u5165\u5230\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\uff0c\u4ece\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u9009\u62e9\u4e00\u4e2a\u201c\u5408\u9002\u201d\u5c31\u7eea\u8fdb\u7a0b\uff0c\u628a\u8fd9\u4e2a\u201c\u5408\u9002\u201d\u7684\u5c31\u7eea\u8fdb\u7a0b\u4ece\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u6458\u9664\u3002\u901a\u8fc7\u8c03\u7528\u4e09\u4e2a\u8c03\u5ea6\u7c7b\u63a5\u53e3\u51fd\u6570sched_class_enqueue\u3001sched_class_pick_next\u3001sched_class_enqueue\u6765\u4f7f\u5f97\u5b8c\u6210\u8fd9\u4e09\u4ef6\u4e8b\u60c5\u4e0e\u5177\u4f53\u7684\u8c03\u5ea6\u7b97\u6cd5\u65e0\u5173\u3002run_timer_list\u51fd\u6570\u5728\u6bcf\u6b21timer\u4e2d\u65ad\u5904\u7406\u8fc7\u7a0b\u4e2d\u88ab\u8c03\u7528\uff0c\u4ece\u800c\u53ef\u7528\u6765\u8c03\u7528\u8c03\u5ea6\u7b97\u6cd5\u6240\u9700\u7684timer\u65f6\u95f4\u4e8b\u4ef6\u611f\u77e5\u64cd\u4f5c\uff0c\u8c03\u6574\u76f8\u5173\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u8c03\u5ea6\u76f8\u5173\u7684\u5c5e\u6027\u503c\u3002\u901a\u8fc7\u8c03\u7528\u8c03\u5ea6\u7c7b\u63a5\u53e3\u51fd\u6570sched_class_proc_tick\u4f7f\u5f97\u6b64\u64cd\u4f5c\u4e0e\u5177\u4f53\u8c03\u5ea6\u7b97\u6cd5\u65e0\u5173\u3002</p> <p>\u8fd9\u91cc\u6d89\u53ca\u4e86\u4e00\u7cfb\u5217\u8c03\u5ea6\u7c7b\u63a5\u53e3\u51fd\u6570\uff1a</p> <ul> <li>sched_class_enqueue</li> <li>sched_class_dequeue</li> <li>sched_class_pick_next</li> <li>sched_class_proc_tick</li> </ul> <p>\u8fd94\u4e2a\u51fd\u6570\u7684\u5b9e\u73b0\u5176\u5b9e\u5c31\u662f\u8c03\u7528\u67d0\u57fa\u4e8esched_class\u6570\u636e\u7ed3\u6784\u7684\u7279\u5b9a\u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0\u76844\u4e2a\u6307\u9488\u51fd\u6570\u3002\u91c7\u7528\u8fd9\u6837\u7684\u8c03\u5ea6\u7c7b\u6846\u67b6\u540e\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u65b0\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5219\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a\u9488\u5bf9\u6b64\u7b97\u6cd5\u7684\u8c03\u5ea6\u7c7b\u7684\u5b9e\u4f8b\uff0c\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u7684\u7ec4\u7ec7\u7ed3\u6784\u63cf\u8ff0\u5c31\u884c\u4e86\uff0c\u5176\u4ed6\u7684\u4e8b\u60c5\u90fd\u53ef\u4ea4\u7ed9\u8c03\u5ea6\u7c7b\u6846\u67b6\u6765\u5b8c\u6210\u3002</p>"},{"location":"lab6/framework/#rr","title":"RR \u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0","text":"<p>RR\u8c03\u5ea6\u7b97\u6cd5\u7684\u8c03\u5ea6\u601d\u60f3 \u662f\u8ba9\u6240\u6709runnable\u6001\u7684\u8fdb\u7a0b\u5206\u65f6\u8f6e\u6d41\u4f7f\u7528CPU\u65f6\u95f4\u3002RR\u8c03\u5ea6\u5668\u7ef4\u62a4\u5f53\u524drunnable\u8fdb\u7a0b\u7684\u6709\u5e8f\u8fd0\u884c\u961f\u5217\u3002\u5f53\u524d\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247\u7528\u5b8c\u4e4b\u540e\uff0c\u8c03\u5ea6\u5668\u5c06\u5f53\u524d\u8fdb\u7a0b\u653e\u7f6e\u5230\u8fd0\u884c\u961f\u5217\u7684\u5c3e\u90e8\uff0c\u518d\u4ece\u5176\u5934\u90e8\u53d6\u51fa\u8fdb\u7a0b\u8fdb\u884c\u8c03\u5ea6\u3002RR\u8c03\u5ea6\u7b97\u6cd5\u7684\u5c31\u7eea\u961f\u5217\u5728\u7ec4\u7ec7\u7ed3\u6784\u4e0a\u4e5f\u662f\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u53ea\u662f\u589e\u52a0\u4e86\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\uff0c\u8868\u660e\u5728\u6b64\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u7684\u6700\u5927\u6267\u884c\u65f6\u95f4\u7247\u3002\u800c\u4e14\u5728\u8fdb\u7a0b\u63a7\u5236\u5757proc_struct\u4e2d\u589e\u52a0\u4e86\u4e00\u4e2a\u6210\u5458\u53d8\u91cftime_slice\uff0c\u7528\u6765\u8bb0\u5f55\u8fdb\u7a0b\u5f53\u524d\u7684\u53ef\u8fd0\u884c\u65f6\u95f4\u7247\u6bb5\u3002\u8fd9\u662f\u7531\u4e8eRR\u8c03\u5ea6\u7b97\u6cd5\u9700\u8981\u8003\u8651\u6267\u884c\u8fdb\u7a0b\u7684\u8fd0\u884c\u65f6\u95f4\u4e0d\u80fd\u592a\u957f\u3002\u5728\u6bcf\u4e2atimer\u5230\u65f6\u7684\u65f6\u5019\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u9012\u51cf\u5f53\u524d\u6267\u884c\u8fdb\u7a0b\u7684time_slice\uff0c\u5f53time_slice\u4e3a0\u65f6\uff0c\u5c31\u610f\u5473\u7740\u8fd9\u4e2a\u8fdb\u7a0b\u8fd0\u884c\u4e86\u4e00\u6bb5\u65f6\u95f4\uff08\u8fd9\u4e2a\u65f6\u95f4\u7247\u6bb5\u79f0\u4e3a\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247\uff09\uff0c\u9700\u8981\u628aCPU\u8ba9\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u4e8e\u662f\u64cd\u4f5c\u7cfb\u7edf\u5c31\u9700\u8981\u8ba9\u6b64\u8fdb\u7a0b\u91cd\u65b0\u56de\u5230rq\u7684\u961f\u5217\u5c3e\uff0c\u4e14\u91cd\u7f6e\u6b64\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247\u4e3a\u5c31\u7eea\u961f\u5217\u7684\u6210\u5458\u53d8\u91cf\u6700\u5927\u65f6\u95f4\u7247max_time_slice\u503c\uff0c\u7136\u540e\u518d\u4ecerq\u7684\u961f\u5217\u5934\u53d6\u51fa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\u3002\u4e0b\u9762\u6765\u5206\u6790\u4e00\u4e0b\u5176\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002</p> <p>RR_enqueue\u7684\u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u8868\u6240\u793a\u3002\u5373\u628a\u67d0\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u653e\u5165\u5230rq\u961f\u5217\u672b\u5c3e\uff0c\u4e14\u5982\u679c\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u65f6\u95f4\u7247\u4e3a0\uff0c\u5219\u9700\u8981\u628a\u5b83\u91cd\u7f6e\u4e3arq\u6210\u5458\u53d8\u91cfmax_time_slice\u3002\u8fd9\u8868\u793a\u5982\u679c\u8fdb\u7a0b\u5728\u5f53\u524d\u7684\u6267\u884c\u65f6\u95f4\u7247\u5df2\u7ecf\u7528\u5b8c\uff0c\u9700\u8981\u7b49\u5230\u4e0b\u4e00\u6b21\u6709\u673a\u4f1a\u8fd0\u884c\u65f6\uff0c\u624d\u80fd\u518d\u6267\u884c\u4e00\u6bb5\u65f6\u95f4\u3002</p> <pre><code>static void\nRR_enqueue(struct run_queue *rq, struct proc_struct *proc) {\n    assert(list_empty(&amp;(proc-&gt;run_link)));\n    list_add_before(&amp;(rq-&gt;run_list), &amp;(proc-&gt;run_link));\n    if (proc-&gt;time_slice == 0 || proc-&gt;time_slice &gt; rq-&gt;max_time_slice) {\n        proc-&gt;time_slice = rq-&gt;max_time_slice;\n    }\n    proc-&gt;rq = rq;\n    rq-&gt;proc_num ++;\n}\n</code></pre> <p>RR_pick_next\u7684\u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u8868\u6240\u793a\u3002\u5373\u9009\u53d6\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217rq\u4e2d\u7684\u961f\u5934\u961f\u5217\u5143\u7d20\uff0c\u5e76\u628a\u961f\u5217\u5143\u7d20\u8f6c\u6362\u6210\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u3002</p> <pre><code>static struct proc_struct *\nRR_pick_next(struct run_queue *rq) {\n    list_entry_t *le = list_next(&amp;(rq-&gt;run_list));\n    if (le != &amp;(rq-&gt;run_list)) {\n        return le2proc(le, run_link);\n    }\n    return NULL;\n}\n</code></pre> <p>RR_dequeue\u7684\u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u8868\u6240\u793a\u3002\u5373\u628a\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217rq\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u7684\u961f\u5217\u5143\u7d20\u5220\u9664\uff0c\u5e76\u628a\u8868\u793a\u5c31\u7eea\u8fdb\u7a0b\u4e2a\u6570\u7684proc_num\u51cf\u4e00\u3002</p> <pre><code>static void\nRR_dequeue(struct run_queue *rq, struct proc_struct *proc) {\n    assert(!list_empty(&amp;(proc-&gt;run_link)) &amp;&amp; proc-&gt;rq == rq);\n    list_del_init(&amp;(proc-&gt;run_link));\n    rq-&gt;proc_num --;\n}\n</code></pre> <p>RR_proc_tick\u7684\u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u8868\u6240\u793a\u3002\u5373\u6bcf\u6b21timer\u5230\u65f6\u540e\uff0ctrap\u51fd\u6570\u5c06\u4f1a\u95f4\u63a5\u8c03\u7528\u6b64\u51fd\u6570\u6765\u628a\u5f53\u524d\u6267\u884c\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247time_slice\u51cf\u4e00\u3002\u5982\u679ctime_slice\u964d\u5230\u96f6\uff0c\u5219\u8bbe\u7f6e\u6b64\u8fdb\u7a0b\u6210\u5458\u53d8\u91cfneed_resched\u6807\u8bc6\u4e3a1\uff0c\u8fd9\u6837\u5728\u4e0b\u4e00\u6b21\u4e2d\u65ad\u6765\u540e\u6267\u884ctrap\u51fd\u6570\u65f6\uff0c\u4f1a\u7531\u4e8e\u5f53\u524d\u8fdb\u7a0b\u7a0b\u6210\u5458\u53d8\u91cfneed_resched\u6807\u8bc6\u4e3a1\u800c\u6267\u884cschedule\u51fd\u6570\uff0c\u4ece\u800c\u628a\u5f53\u524d\u6267\u884c\u8fdb\u7a0b\u653e\u56de\u5c31\u7eea\u961f\u5217\u672b\u5c3e\uff0c\u800c\u4ece\u5c31\u7eea\u961f\u5217\u5934\u53d6\u51fa\u5728\u5c31\u7eea\u961f\u5217\u4e0a\u7b49\u5f85\u65f6\u95f4\u6700\u4e45\u7684\u90a3\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u6267\u884c\u3002</p> <pre><code>static void\nRR_proc_tick(struct run_queue *rq, struct proc_struct *proc) {\n    if (proc-&gt;time_slice &gt; 0) {\n        proc-&gt;time_slice --;\n    }\n    if (proc-&gt;time_slice == 0) {\n        proc-&gt;need_resched = 1;\n    }\n}\n</code></pre>"},{"location":"lab6/lab6/","title":"\u5b9e\u9a8c\u516d\uff1a\u8c03\u5ea6\u5668","text":""},{"location":"lab6/lab6/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u7406\u89e3\u64cd\u4f5c\u7cfb\u7edf\u7684\u8c03\u5ea6\u7ba1\u7406\u673a\u5236</li> <li>\u719f\u6089 ucore \u7684\u7cfb\u7edf\u8c03\u5ea6\u5668\u6846\u67b6\uff0c\u4ee5\u53ca\u7f3a\u7701\u7684Round-Robin \u8c03\u5ea6\u7b97\u6cd5</li> <li>\u57fa\u4e8e\u8c03\u5ea6\u5668\u6846\u67b6\u5b9e\u73b0\u4e00\u4e2a(Stride Scheduling)\u8c03\u5ea6\u7b97\u6cd5\u6765\u66ff\u6362\u7f3a\u7701\u7684\u8c03\u5ea6\u7b97\u6cd5</li> </ul>"},{"location":"lab6/lab6/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u9a8c\u4e94\u5b8c\u6210\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u7ba1\u7406\uff0c\u53ef\u5728\u7528\u6237\u6001\u8fd0\u884c\u591a\u4e2a\u8fdb\u7a0b\u3002\u4f46\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u91c7\u7528\u7684\u8c03\u5ea6\u7b56\u7565\u662f\u5f88\u7b80\u5355\u7684FIFO\u8c03\u5ea6\u7b56\u7565\u3002\u672c\u6b21\u5b9e\u9a8c\uff0c\u4e3b\u8981\u662f\u719f\u6089ucore\u7684\u7cfb\u7edf\u8c03\u5ea6\u5668\u6846\u67b6\uff0c\u4ee5\u53ca\u57fa\u4e8e\u6b64\u6846\u67b6\u7684Round-Robin\uff08RR\uff09 \u8c03\u5ea6\u7b97\u6cd5\u3002\u7136\u540e\u53c2\u8003RR\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\uff0c\u5b8c\u6210Stride Scheduling\u8c03\u5ea6\u7b97\u6cd5\u3002</p>"},{"location":"lab6/lab6/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u5728\u5b9e\u9a8c\u4e94\uff0c\u521b\u5efa\u4e86\u7528\u6237\u8fdb\u7a0b\uff0c\u5e76\u8ba9\u5b83\u4eec\u6b63\u786e\u8fd0\u884c\u3002\u8fd9\u4e2d\u95f4\u4e5f\u5b9e\u73b0\u4e86FIFO\u8c03\u5ea6\u7b56\u7565\u3002\u53ef\u901a\u8fc7\u9605\u8bfb\u5b9e\u9a8c\u4e94\u4e0b\u7684 kern/schedule/sched.c \u7684 schedule \u51fd\u6570\u7684\u5b9e\u73b0\u6765\u4e86\u89e3\u5176FIFO\u8c03\u5ea6\u7b56\u7565\u3002\u4e0e\u5b9e\u9a8c\u4e94\u76f8\u6bd4\uff0c\u5b9e\u9a8c\u516d\u4e13\u95e8\u9700\u8981\u9488\u5bf9\u5904\u7406\u5668\u8c03\u5ea6\u6846\u67b6\u548c\u5404\u79cd\u7b97\u6cd5\u8fdb\u884c\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff0c\u4e3a\u6b64\u5bf9ucore\u7684\u8c03\u5ea6\u90e8\u5206\u8fdb\u884c\u4e86\u9002\u5f53\u7684\u4fee\u6539\uff0c\u4f7f\u5f97kern/schedule/sched.c \u53ea\u5b9e\u73b0\u8c03\u5ea6\u5668\u6846\u67b6\uff0c\u800c\u4e0d\u518d\u6d89\u53ca\u5177\u4f53\u7684\u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0\u3002\u800c\u8c03\u5ea6\u7b97\u6cd5\u5728\u5355\u72ec\u7684\u6587\u4ef6\uff08default_sched.[ch]\uff09\u4e2d\u5b9e\u73b0\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u5b9e\u9a8c\u4e2d\u8fd8\u6d89\u53ca\u4e86idle\u8fdb\u7a0b\u7684\u6982\u5ff5\u3002\u5f53cpu\u6ca1\u6709\u8fdb\u7a0b\u53ef\u4ee5\u6267\u884c\u7684\u65f6\u5019\uff0c\u7cfb\u7edf\u5e94\u8be5\u5982\u4f55\u5de5\u4f5c\uff1f\u5728\u5b9e\u9a8c\u4e94\u7684scheduler\u5b9e\u73b0\u4e2d\uff0cucore\u5185\u6838\u4e0d\u65ad\u7684\u904d\u5386\u8fdb\u7a0b\u6c60\uff0c\u76f4\u5230\u627e\u5230\u7b2c\u4e00\u4e2arunnable\u72b6\u6001\u7684 process\uff0c\u8c03\u7528\u5e76\u6267\u884c\u5b83\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u7cfb\u7edf\u6ca1\u6709\u8fdb\u7a0b\u53ef\u4ee5\u6267\u884c\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u628a\u6240\u6709 cpu \u65f6\u95f4\u7528\u5728\u641c\u7d22\u8fdb\u7a0b\u6c60\uff0c\u4ee5\u5b9e\u73b0 idle\u7684\u76ee\u7684\u3002\u4f46\u662f\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e0d\u88ab\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u6240\u91c7\u7528\uff0c\u539f\u56e0\u5728\u4e8e\u5b83\u5c06\u8fdb\u7a0b\u8c03\u5ea6\u548c idle \u8fdb\u7a0b\u4e24\u79cd\u4e0d\u540c\u7684\u6982\u5ff5\u6df7\u5728\u4e86\u4e00\u8d77\uff0c\u800c\u4e14\uff0c\u5f53\u8c03\u5ea6\u5668\u6bd4\u8f83\u590d\u6742\u65f6\uff0cschedule \u51fd\u6570\u672c\u8eab\u4e5f\u4f1a\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u6837\u7684\u8bbe\u8ba1\u7ed3\u6784\u5f88\u4e0d\u6e05\u6670\u800c\u4e14\u96be\u514d\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u6240\u4ee5\u5728\u6b64\u6b21\u5b9e\u9a8c\u4e2d\uff0cucore\u5efa\u7acb\u4e86\u4e00\u4e2a\u5355\u72ec\u7684\u8fdb\u7a0b(kern/process/proc.c \u4e2d\u7684 idleproc)\u4f5c\u4e3a cpu \u7a7a\u95f2\u65f6\u7684 idle \u8fdb\u7a0b\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u662f\u901a\u5e38\u4e00\u4e2a\u6b7b\u5faa\u73af\u3002\u4f60\u9700\u8981\u4e86\u89e3\u8fd9\u4e2a\u7a0b\u5e8f\u7684\u5b9e\u73b0\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u770b\u770b\u5b9e\u9a8c\u516d\u7684\u5927\u81f4\u6267\u884c\u8fc7\u7a0b\uff0c\u5728init.c\u4e2d\u7684kern_init\u51fd\u6570\u589e\u52a0\u4e86\u5bf9sched_init\u51fd\u6570\u7684\u8c03\u7528\u3002sched_init\u51fd\u6570\u4e3b\u8981\u5b8c\u6210\u4e86\u5bf9\u5b9e\u73b0\u7279\u5b9a\u8c03\u5ea6\u7b97\u6cd5\u7684\u8c03\u5ea6\u7c7b\uff08sched_class\uff09\u7684\u7ed1\u5b9a\uff0c\u4f7f\u5f97ucore\u5728\u540e\u7eed\u7684\u6267\u884c\u4e2d\uff0c\u80fd\u591f\u901a\u8fc7\u8c03\u5ea6\u6846\u67b6\u627e\u5230\u5b9e\u73b0\u7279\u5b9a\u8c03\u5ea6\u7b97\u6cd5\u7684\u8c03\u5ea6\u7c7b\u5e76\u5b8c\u6210\u8fdb\u7a0b\u8c03\u5ea6\u76f8\u5173\u5de5\u4f5c\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u7406\u89e3\u5b9e\u9a8c\u516d\u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u9700\u8981\u5173\u6ce8\u7684\u91cd\u70b9\u95ee\u9898\u5305\u62ec\uff1a</p> <ol> <li>\u4f55\u65f6\u6216\u4f55\u4e8b\u4ef6\u53d1\u751f\u540e\u9700\u8981\u8c03\u5ea6\uff1f</li> <li>\u4f55\u65f6\u6216\u4f55\u4e8b\u4ef6\u53d1\u751f\u540e\u9700\u8981\u8c03\u6574\u5b9e\u73b0\u8c03\u5ea6\u7b97\u6cd5\u6240\u6d89\u53ca\u7684\u53c2\u6570\uff1f</li> <li>\u5982\u679c\u57fa\u4e8e\u8c03\u5ea6\u6846\u67b6\u8bbe\u8ba1\u5177\u4f53\u7684\u8c03\u5ea6\u7b97\u6cd5\uff1f</li> <li>\u5982\u679c\u7075\u6d3b\u5e94\u7528\u94fe\u8868\u7b49\u6570\u636e\u7ed3\u6784\u7ba1\u7406\u8fdb\u7a0b\u8c03\u5ea6\uff1f</li> </ol> <p>\u5927\u5bb6\u53ef\u5e26\u7740\u8fd9\u4e9b\u95ee\u9898\u8fdb\u4e00\u6b65\u9605\u8bfb\u540e\u7eed\u7684\u5185\u5bb9\u3002</p>"},{"location":"lab6/sche_impl/","title":"\u8fdb\u7a0b\u8c03\u5ea6\u5b9e\u73b0","text":""},{"location":"lab6/sche_impl/#_1","title":"\u8fdb\u7a0b\u8c03\u5ea6\u5b9e\u73b0","text":""},{"location":"lab6/sche_impl/#_2","title":"\u8fdb\u7a0b\u72b6\u6001","text":"<p>\u5728\u6b64\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u8fdb\u7a0b\u7684\u72b6\u6001\u4e4b\u95f4\u7684\u8f6c\u6362\u9700\u8981\u6709\u4e00\u4e2a\u66f4\u4e3a\u6e05\u6670\u7684\u8868\u8ff0\uff0c\u5728 ucore\u4e2d\uff0crunnable\u7684\u8fdb\u7a0b\u4f1a\u88ab\u653e\u5728\u8fd0\u884c\u961f\u5217\u4e2d\u3002\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5177\u4f53\u5b9e\u73b0\u4e2d\uff0cucore\u5b9a\u4e49\u7684\u8fdb\u7a0b\u63a7\u5236\u5757struct proc_struct\u5305\u542b\u4e86\u6210\u5458\u53d8\u91cfstate,\u7528\u4e8e\u63cf\u8ff0\u8fdb\u7a0b\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u800crunning\u548crunnable\u5171\u4eab\u540c\u4e00\u4e2a\u72b6\u6001(state)\u503c(PROC_RUNNABLE\u3002\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u5904\u4e8erunning\u6001\u7684\u8fdb\u7a0b\u4e0d\u4f1a\u653e\u5728\u8fd0\u884c\u961f\u5217\u4e2d\u3002\u8fdb\u7a0b\u7684\u6b63\u5e38\u751f\u547d\u5468\u671f\u5982\u4e0b\uff1a</p> <ul> <li>\u8fdb\u7a0b\u9996\u5148\u5728 cpu \u521d\u59cb\u5316\u6216\u8005 sys_fork \u7684\u65f6\u5019\u88ab\u521b\u5efa\uff0c\u5f53\u4e3a\u8be5\u8fdb\u7a0b\u5206\u914d\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u4e4b\u540e\uff0c\u8be5\u8fdb\u7a0b\u8fdb\u5165 uninit\u6001(\u5728proc.c \u4e2d alloc_proc)\u3002</li> <li>\u5f53\u8fdb\u7a0b\u5b8c\u5168\u5b8c\u6210\u521d\u59cb\u5316\u4e4b\u540e\uff0c\u8be5\u8fdb\u7a0b\u8f6c\u4e3arunnable\u6001\u3002</li> <li>\u5f53\u5230\u8fbe\u8c03\u5ea6\u70b9\u65f6\uff0c\u7531\u8c03\u5ea6\u5668 sched_class \u6839\u636e\u8fd0\u884c\u961f\u5217rq\u7684\u5185\u5bb9\u6765\u5224\u65ad\u4e00\u4e2a\u8fdb\u7a0b\u662f\u5426\u5e94\u8be5\u88ab\u8fd0\u884c\uff0c\u5373\u628a\u5904\u4e8erunnable\u6001\u7684\u8fdb\u7a0b\u8f6c\u6362\u6210running\u72b6\u6001\uff0c\u4ece\u800c\u5360\u7528CPU\u6267\u884c\u3002</li> <li>running\u6001\u7684\u8fdb\u7a0b\u901a\u8fc7wait\u7b49\u7cfb\u7edf\u8c03\u7528\u88ab\u963b\u585e\uff0c\u8fdb\u5165sleeping\u6001\u3002</li> <li>sleeping\u6001\u7684\u8fdb\u7a0b\u88abwakeup\u53d8\u6210runnable\u6001\u7684\u8fdb\u7a0b\u3002</li> <li>running\u6001\u7684\u8fdb\u7a0b\u4e3b\u52a8 exit \u53d8\u6210zombie\u6001\uff0c\u7136\u540e\u7531\u5176\u7236\u8fdb\u7a0b\u5b8c\u6210\u5bf9\u5176\u8d44\u6e90\u7684\u6700\u540e\u91ca\u653e\uff0c\u5b50\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u6210\u4e3aunused\u3002</li> <li>\u6240\u6709\u4ecerunnable\u6001\u53d8\u6210\u5176\u4ed6\u72b6\u6001\u7684\u8fdb\u7a0b\u90fd\u8981\u51fa\u8fd0\u884c\u961f\u5217\uff0c\u53cd\u4e4b\uff0c\u88ab\u653e\u5165\u67d0\u4e2a\u8fd0\u884c\u961f\u5217\u4e2d\u3002</li> </ul>"},{"location":"lab6/sche_impl/#_3","title":"\u5185\u6838\u62a2\u5360\u70b9","text":"<p>\u8c03\u5ea6\u672c\u8d28\u4e0a\u4f53\u73b0\u4e86\u5bf9CPU\u8d44\u6e90\u7684\u62a2\u5360\u3002\u5bf9\u4e8e\u7528\u6237\u8fdb\u7a0b\u800c\u8a00\uff0c\u7531\u4e8e\u6709\u4e2d\u65ad\u7684\u4ea7\u751f\uff0c\u53ef\u4ee5\u968f\u65f6\u6253\u65ad\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\uff0c\u8f6c\u5230\u64cd\u4f5c\u7cfb\u7edf\u5185\u90e8\uff0c\u4ece\u800c\u7ed9\u4e86\u64cd\u4f5c\u7cfb\u7edf\u4ee5\u8c03\u5ea6\u63a7\u5236\u6743\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u6839\u636e\u5177\u4f53\u60c5\u51b5\uff08\u6bd4\u5982\u7528\u6237\u8fdb\u7a0b\u65f6\u95f4\u7247\u5df2\u7ecf\u7528\u5b8c\u4e86\uff09\u9009\u62e9\u5176\u4ed6\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u3002\u8fd9\u4f53\u73b0\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u53ef\u62a2\u5360\u6027\uff08preemptive\uff09\u3002\u4f46\u5982\u679c\u628aucore\u64cd\u4f5c\u7cfb\u7edf\u4e5f\u770b\u6210\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u5185\u6838\u8fdb\u7a0b\u6216\u591a\u4e2a\u5185\u6838\u7ebf\u7a0b\u7684\u96c6\u5408\uff0c\u90a3ucore\u662f\u5426\u4e5f\u662f\u53ef\u62a2\u5360\u7684\u5462\uff1f\u5176\u5b9eucore\u5185\u6838\u6267\u884c\u662f\u4e0d\u53ef\u62a2\u5360\u7684\uff08non-preemptive\uff09\uff0c\u5373\u5728\u6267\u884c\u201c\u4efb\u610f\u201d\u5185\u6838\u4ee3\u7801\u65f6\uff0cCPU\u63a7\u5236\u6743\u53ef\u88ab\u5f3a\u5236\u5265\u593a\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\uff0c\u4e0d\u662f\u5728\u6240\u6709\u60c5\u51b5\u4e0bucore\u5185\u6838\u6267\u884c\u90fd\u662f\u4e0d\u53ef\u62a2\u5360\u7684\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u201c\u56fa\u5b9a\u201d\u60c5\u51b5\u662f\u4f8b\u5916\uff1a</p> <ol> <li>\u8fdb\u884c\u540c\u6b65\u4e92\u65a5\u64cd\u4f5c\uff0c\u6bd4\u5982\u4e89\u62a2\u4e00\u4e2a\u4fe1\u53f7\u91cf\u3001\u9501\uff08lab7\u4e2d\u4f1a\u8be6\u7ec6\u5206\u6790\uff09\uff1b     </li> <li>\u8fdb\u884c\u78c1\u76d8\u8bfb\u5199\u7b49\u8017\u65f6\u7684\u5f02\u6b65\u64cd\u4f5c\uff0c\u7531\u4e8e\u7b49\u5f85\u5b8c\u6210\u7684\u8017\u65f6\u592a\u957f\uff0cucore\u4f1a\u8c03\u7528shcedule\u8ba9\u5176\u4ed6\u5c31\u7eea\u8fdb\u7a0b\u6267\u884c\u3002</li> </ol> <p>\u8fd9\u51e0\u79cd\u60c5\u51b5\u5176\u5b9e\u90fd\u662f\u7531\u4e8e\u5f53\u524d\u8fdb\u7a0b\u6240\u9700\u7684\u67d0\u4e2a\u8d44\u6e90\uff08\u4e5f\u53ef\u79f0\u4e3a\u4e8b\u4ef6\uff09\u65e0\u6cd5\u5f97\u5230\u6ee1\u8db3\uff0c\u65e0\u6cd5\u7ee7\u7eed\u6267\u884c\u4e0b\u53bb\uff0c\u4ece\u800c\u4e0d\u5f97\u4e0d\u4e3b\u52a8\u653e\u5f03\u5bf9CPU\u7684\u63a7\u5236\u6743\u3002\u5982\u679c\u53c2\u7167\u7528\u6237\u8fdb\u7a0b\u4efb\u4f55\u4f4d\u7f6e\u90fd\u53ef\u88ab\u5185\u6838\u6253\u65ad\u5e76\u653e\u5f03CPU\u63a7\u5236\u6743\u7684\u60c5\u51b5\uff0c\u8fd9\u4e9b\u5728\u5185\u6838\u4e2d\u653e\u5f03CPU\u63a7\u5236\u6743\u7684\u6267\u884c\u5730\u70b9\u662f\u201c\u56fa\u5b9a\u201d\u800c\u4e0d\u662f\u201c\u4efb\u610f\u201d\u7684\uff0c\u4e0d\u80fd\u4f53\u73b0\u5185\u6838\u4efb\u610f\u4f4d\u7f6e\u90fd\u53ef\u62a2\u5360\u6027\u7684\u7279\u70b9\u3002\u6211\u4eec\u641c\u5bfb\u4e00\u4e0b\u5b9e\u9a8c\u4e94\u7684\u4ee3\u7801\uff0c\u53ef\u53d1\u73b0\u5728\u5982\u4e0b\u51e0\u5904\u5730\u65b9\u8c03\u7528\u4e86shedule\u51fd\u6570\uff1a</p> <p>\u8868\u4e00\uff1a\u8c03\u7528\u8fdb\u7a0b\u8c03\u5ea6\u51fd\u6570schedule\u7684\u4f4d\u7f6e\u548c\u539f\u56e0</p> \u7f16\u53f7\u4f4d\u7f6e\u539f\u56e0 1proc.c::do_exit\u7528\u6237\u7ebf\u7a0b\u6267\u884c\u7ed3\u675f\uff0c\u4e3b\u52a8\u653e\u5f03CPU\u63a7\u5236\u6743\u3002 2proc.c::do_wait\u7528\u6237\u7ebf\u7a0b\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff0c\u4e3b\u52a8\u653e\u5f03CPU\u63a7\u5236\u6743\u3002 3proc.c::init_main1.  initproc\u5185\u6838\u7ebf\u7a0b\u7b49\u5f85\u6240\u6709\u7528\u6237\u8fdb\u7a0b\u7ed3\u675f\uff0c\u5982\u679c\u6ca1\u6709\u7ed3\u675f\uff0c\u5c31\u4e3b\u52a8\u653e\u5f03CPU\u63a7\u5236\u6743; 2.  initproc\u5185\u6838\u7ebf\u7a0b\u5728\u6240\u6709\u7528\u6237\u8fdb\u7a0b\u7ed3\u675f\u540e\uff0c\u8ba9kswapd\u5185\u6838\u7ebf\u7a0b\u6267\u884c10\u6b21\uff0c\u7528\u4e8e\u56de\u6536\u7a7a\u95f2\u5185\u5b58\u8d44\u6e90 4proc.c::cpu_idleidleproc\u5185\u6838\u7ebf\u7a0b\u7684\u5de5\u4f5c\u5c31\u662f\u7b49\u5f85\u6709\u5904\u4e8e\u5c31\u7eea\u6001\u7684\u8fdb\u7a0b\u6216\u7ebf\u7a0b\uff0c\u5982\u679c\u6709\u5c31\u8c03\u7528schedule\u51fd\u6570 5sync.h::lock\u5728\u83b7\u53d6\u9501\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u65e0\u6cd5\u5f97\u5230\u9501\uff0c\u5219\u4e3b\u52a8\u653e\u5f03CPU\u63a7\u5236\u6743 6trap.c::trap\u5982\u679c\u5728\u5f53\u524d\u8fdb\u7a0b\u5728\u7528\u6237\u6001\u88ab\u6253\u65ad\u53bb\uff0c\u4e14\u5f53\u524d\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u6210\u5458\u53d8\u91cfneed_resched\u8bbe\u7f6e\u4e3a1\uff0c\u5219\u5f53\u524d\u7ebf\u7a0b\u4f1a\u653e\u5f03CPU\u63a7\u5236\u6743 <p>\u4ed4\u7ec6\u5206\u6790\u4e0a\u8ff0\u4f4d\u7f6e\uff0c\u7b2c1\u30012\u30015\u5904\u7684\u6267\u884c\u4f4d\u7f6e\u4f53\u73b0\u4e86\u7531\u4e8e\u83b7\u53d6\u67d0\u79cd\u8d44\u6e90\u4e00\u65f6\u7b49\u4e0d\u5230\u6ee1\u8db3\u3001\u8fdb\u7a0b\u8981\u9000\u51fa\u3001\u8fdb\u7a0b\u8981\u7761\u7720\u7b49\u539f\u56e0\u800c\u4e0d\u5f97\u4e0d\u4e3b\u52a8\u653e\u5f03CPU\u3002\u7b2c3\u30014\u5904\u7684\u6267\u884c\u4f4d\u7f6e\u6bd4\u8f83\u7279\u6b8a\uff0cinitproc\u5185\u6838\u7ebf\u7a0b\u7b49\u5f85\u7528\u6237\u8fdb\u7a0b\u7ed3\u675f\u800c\u6267\u884cschedule\u51fd\u6570\uff1bidle\u5185\u6838\u7ebf\u7a0b\u5728\u6ca1\u6709\u8fdb\u7a0b\u5904\u4e8e\u5c31\u7eea\u6001\u65f6\u624d\u6267\u884c\uff0c\u4e00\u65e6\u6709\u4e86\u5c31\u7eea\u6001\u7684\u8fdb\u7a0b\uff0c\u5b83\u5c06\u6267\u884cschedule\u51fd\u6570\u5b8c\u6210\u8fdb\u7a0b\u8c03\u5ea6\u3002\u8fd9\u91cc\u53ea\u6709\u7b2c6\u5904\u7684\u4f4d\u7f6e\u6bd4\u8f83\u7279\u6b8a\uff1a</p> <pre><code>if (!in_kernel) {\n    \u2026\u2026\n\n    if (current-&gt;need_resched) {\n        schedule();\n    }\n}\n</code></pre> <p>\u8fd9\u91cc\u8868\u660e\u4e86\u53ea\u6709\u5f53\u8fdb\u7a0b\u5728\u7528\u6237\u6001\u6267\u884c\u5230\u201c\u4efb\u610f\u201d\u67d0\u5904\u7528\u6237\u4ee3\u7801\u4f4d\u7f6e\u65f6\u53d1\u751f\u4e86\u4e2d\u65ad\uff0c\u4e14\u5f53\u524d\u8fdb\u7a0b\u63a7\u5236\u5757\u6210\u5458\u53d8\u91cfneed_resched\u4e3a1\uff08\u8868\u793a\u9700\u8981\u8c03\u5ea6\u4e86\uff09\u65f6\uff0c\u624d\u4f1a\u6267\u884cshedule\u51fd\u6570\u3002\u8fd9\u5b9e\u9645\u4e0a\u4f53\u73b0\u4e86\u5bf9\u7528\u6237\u8fdb\u7a0b\u7684\u53ef\u62a2\u5360\u6027\u3002\u5982\u679c\u6ca1\u6709\u7b2c\u4e00\u884c\u7684if\u8bed\u53e5\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4f53\u73b0\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u53ef\u62a2\u5360\u6027\u3002\u4f46\u5982\u679c\u8981\u628a\u8fd9\u4e00\u884cif\u8bed\u53e5\u53bb\u6389\uff0c\u6211\u4eec\u5c31\u4e0d\u5f97\u4e0d\u5b9e\u73b0\u5bf9ucore\u4e2d\u7684\u6240\u6709\u5168\u5c40\u53d8\u91cf\u7684\u4e92\u65a5\u8bbf\u95ee\u64cd\u4f5c\uff0c\u4ee5\u9632\u6b62\u6240\u8c13\u7684racecondition\u73b0\u8c61\uff0c\u8fd9\u6837ucore\u7684\u5b9e\u73b0\u590d\u6742\u5ea6\u4f1a\u589e\u52a0\u4e0d\u5c11\u3002</p>"},{"location":"lab6/sche_impl/#_4","title":"\u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b","text":"<p>\u8fdb\u7a0b\u8c03\u5ea6\u51fd\u6570schedule\u9009\u62e9\u4e86\u4e0b\u4e00\u4e2a\u5c06\u5360\u7528CPU\u6267\u884c\u7684\u8fdb\u7a0b\u540e\uff0c\u5c06\u8c03\u7528\u8fdb\u7a0b\u5207\u6362\uff0c\u4ece\u800c\u8ba9\u65b0\u7684\u8fdb\u7a0b\u5f97\u4ee5\u6267\u884c\u3002\u901a\u8fc7\u5b9e\u9a8c\u56db\u548c\u5b9e\u9a8c\u4e94\u7684\u7406\u89e3\uff0c\u5e94\u8be5\u5df2\u7ecf\u5bf9\u8fdb\u7a0b\u8c03\u5ea6\u548c\u4e0a\u4e0b\u6587\u5207\u6362\u6709\u4e86\u521d\u6b65\u7684\u8ba4\u8bc6\u3002\u5728\u5b9e\u9a8c\u4e94\u4e2d\uff0c\u7ed3\u5408\u8c03\u5ea6\u5668\u6846\u67b6\u7684\u8bbe\u8ba1\uff0c\u53ef\u5bf9ucore\u4e2d\u7684\u8fdb\u7a0b\u5207\u6362\u4ee5\u53ca\u5806\u6808\u7684\u7ef4\u62a4\u548c\u4f7f\u7528\u7b49\u6709\u66f4\u52a0\u6df1\u523b\u7684\u8ba4\u8bc6\u3002\u5047\u5b9a\u6709\u4e24\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u5728\u4e8c\u8005\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5177\u4f53\u7684\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <p>\u9996\u5148\u5728\u6267\u884c\u67d0\u8fdb\u7a0bA\u7684\u7528\u6237\u4ee3\u7801\u65f6\uff0c\u51fa\u73b0\u4e86\u4e00\u4e2a trap (\u4f8b\u5982\u662f\u4e00\u4e2a\u5916\u8bbe\u4ea7\u751f\u7684\u4e2d\u65ad)\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u4f1a\u4ece\u8fdb\u7a0bA\u7684\u7528\u6237\u6001\u5207\u6362\u5230\u5185\u6838\u6001(\u8fc7\u7a0b(1))\uff0c\u5e76\u4e14\u4fdd\u5b58\u597d\u8fdb\u7a0bA\u7684trapframe\uff1b\u5f53\u5185\u6838\u6001\u5904\u7406\u4e2d\u65ad\u65f6\u53d1\u73b0\u9700\u8981\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\u65f6\uff0cucore\u8981\u901a\u8fc7schedule\u51fd\u6570\u9009\u62e9\u4e0b\u4e00\u4e2a\u5c06\u5360\u7528CPU\u6267\u884c\u7684\u8fdb\u7a0b\uff08\u5373\u8fdb\u7a0bB\uff09\uff0c\u7136\u540e\u4f1a\u8c03\u7528proc_run\u51fd\u6570\uff0cproc_run\u51fd\u6570\u8fdb\u4e00\u6b65\u8c03\u7528switch_to\u51fd\u6570\uff0c\u5207\u6362\u5230\u8fdb\u7a0bB\u7684\u5185\u6838\u6001(\u8fc7\u7a0b(2))\uff0c\u7ee7\u7eed\u8fdb\u7a0bB\u4e0a\u4e00\u6b21\u5728\u5185\u6838\u6001\u7684\u64cd\u4f5c\uff0c\u5e76\u901a\u8fc7ertn\u6307\u4ee4\uff0c\u6700\u7ec8\u5c06\u6267\u884c\u6743\u8f6c\u4ea4\u7ed9\u8fdb\u7a0bB\u7684\u7528\u6237\u7a7a\u95f4(\u8fc7\u7a0b(3))\u3002</p> <p>\u5f53\u8fdb\u7a0bB\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u53d1\u751f\u4e2d\u65ad\u4e4b\u540e(\u8fc7\u7a0b(4))\uff0c\u4f1a\u4ece\u8fdb\u7a0bB\u7684\u7528\u6237\u6001\u5207\u6362\u5230\u5185\u6838\u6001\uff0c\u5e76\u4e14\u4fdd\u5b58\u597d\u8fdb\u7a0bB\u7684trapframe\uff1b\u5f53\u5185\u6838\u6001\u5904\u7406\u4e2d\u65ad\u65f6\u53d1\u73b0\u9700\u8981\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\u65f6\uff0c\u5373\u9700\u8981\u5207\u6362\u5230\u8fdb\u7a0bA\uff0cucore\u518d\u6b21\u5207\u6362\u5230\u8fdb\u7a0bA(\u8fc7\u7a0b(5))\uff0c\u4f1a\u6267\u884c\u8fdb\u7a0bA\u4e0a\u4e00\u6b21\u5728\u5185\u6838\u8c03\u7528schedule (\u5177\u4f53\u8fd8\u8981\u8ddf\u8e2a\u5230 switch_to \u51fd\u6570)\u51fd\u6570\u8fd4\u56de\u540e\u7684\u4e0b\u4e00\u884c\u4ee3\u7801\uff0c\u8fd9\u884c\u4ee3\u7801\u5f53\u7136\u8fd8\u662f\u5728\u8fdb\u7a0bA\u7684\u4e0a\u4e00\u6b21\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b\u4e2d\u3002\u6700\u540e\u5f53\u8fdb\u7a0bA\u7684\u4e2d\u65ad\u5904\u7406\u5b8c\u6bd5\u7684\u65f6\u5019\uff0c\u6267\u884c\u6743\u53c8\u4f1a\u53cd\u4ea4\u7ed9\u8fdb\u7a0bA\u7684\u7528\u6237\u4ee3\u7801(\u8fc7\u7a0b(6))\u3002\u8fd9\u5c31\u662f\u5728\u53ea\u6709\u4e24\u4e2a\u8fdb\u7a0b\u7684\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u5207\u6362\u95f4\u7684\u5927\u4f53\u6d41\u7a0b\u3002</p> <p>\u51e0\u70b9\u9700\u8981\u5f3a\u8c03\u7684\u662f\uff1a</p> <p>a) \u9700\u8981\u900f\u5f7b\u7406\u89e3\u5728\u8fdb\u7a0b\u5207\u6362\u4ee5\u540e\uff0c\u7a0b\u5e8f\u662f\u4ece\u54ea\u91cc\u5f00\u59cb\u6267\u884c\u7684\uff1f\u9700\u8981\u6ce8\u610f\u5230\u867d\u7136\u6307\u4ee4\u8fd8\u662f\u540c\u4e00\u4e2acpu\u4e0a\u6267\u884c\uff0c\u4f46\u662f\u6b64\u65f6\u5df2\u7ecf\u662f\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u5728\u6267\u884c\u4e86\uff0c\u4e14\u4f7f\u7528\u7684\u8d44\u6e90\u5df2\u7ecf\u5b8c\u5168\u4e0d\u540c\u4e86\u3002</p> <p>b) \u5185\u6838\u5728\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u7684\u65f6\u5019\uff0c\u9700\u8981\u8fdb\u884c\u54ea\u4e9b\u64cd\u4f5c\uff1f\u6709\u4e86\u5b9e\u9a8c\u56db\u548c\u5b9e\u9a8c\u4e94\u7684\u7ecf\u9a8c\uff0c\u53ef\u4ee5\u786e\u5b9a\uff0c\u5185\u6838\u542f\u52a8\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u7684\u8fc7\u7a0b\uff0c\u5b9e\u9645\u4e0a\u662f\u4ece\u8fdb\u7a0b\u542f\u52a8\u65f6\u7684\u5185\u6838\u72b6\u6001\u5207\u6362\u5230\u8be5\u7528\u6237\u8fdb\u7a0b\u7684\u5185\u6838\u72b6\u6001\u7684\u8fc7\u7a0b\uff0c\u800c\u4e14\u8be5\u7528\u6237\u8fdb\u7a0b\u5728\u7528\u6237\u6001\u7684\u8d77\u59cb\u5165\u53e3\u5e94\u8be5\u662fforkrets\u3002</p>"},{"location":"lab6/stride/","title":"Stride Scheduling","text":""},{"location":"lab6/stride/#stride-scheduling","title":"Stride Scheduling","text":""},{"location":"lab6/stride/#_1","title":"\u57fa\u672c\u601d\u8def","text":"<p>\u3010\u63d0\u793a\u3011\u8bf7\u5148\u770b\u7ec3\u4e602\u4e2d\u63d0\u5230\u7684\u8bba\u6587, \u7406\u89e3\u540e\u5728\u770b\u4e0b\u9762\u7684\u5185\u5bb9\u3002</p> <p>\u8003\u5bdf round-robin \u8c03\u5ea6\u5668\uff0c\u5728\u5047\u8bbe\u6240\u6709\u8fdb\u7a0b\u90fd\u5145\u5206\u4f7f\u7528\u4e86\u5176\u62e5\u6709\u7684 CPU \u65f6\u95f4\u8d44\u6e90\u7684\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u8fdb\u7a0b\u5f97\u5230\u7684 CPU \u65f6\u95f4\u5e94\u8be5\u662f\u76f8\u7b49\u7684\u3002\u4f46\u662f\u6709\u65f6\u5019\u6211\u4eec\u5e0c\u671b\u8c03\u5ea6\u5668\u80fd\u591f\u66f4\u667a\u80fd\u5730\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u914d\u5408\u7406\u7684 CPU \u8d44\u6e90\u3002\u5047\u8bbe\u6211\u4eec\u4e3a\u4e0d\u540c\u7684\u8fdb\u7a0b\u5206\u914d\u4e0d\u540c\u7684\u4f18\u5148\u7ea7\uff0c\u5219\u6211\u4eec\u6709\u53ef\u80fd\u5e0c\u671b\u6bcf\u4e2a\u8fdb\u7a0b\u5f97\u5230\u7684\u65f6\u95f4\u8d44\u6e90\u4e0e\u4ed6\u4eec\u7684\u4f18\u5148\u7ea7\u6210\u6b63\u6bd4\u5173\u7cfb\u3002Stride\u8c03\u5ea6\u662f\u57fa\u4e8e\u8fd9\u79cd\u60f3\u6cd5\u7684\u4e00\u4e2a\u8f83\u4e3a\u5178\u578b\u548c\u7b80\u5355\u7684\u7b97\u6cd5\u3002\u9664\u4e86\u7b80\u5355\u6613\u4e8e\u5b9e\u73b0\u4ee5\u5916\uff0c\u5b83\u8fd8\u6709\u5982\u4e0b\u7684\u7279\u70b9\uff1a</p> <ul> <li>\u53ef\u63a7\u6027\uff1a\u5982\u6211\u4eec\u4e4b\u524d\u6240\u5e0c\u671b\u7684\uff0c\u53ef\u4ee5\u8bc1\u660e Stride Scheduling\u5bf9\u8fdb\u7a0b\u7684\u8c03\u5ea6\u6b21\u6570\u6b63\u6bd4\u4e8e\u5176\u4f18\u5148\u7ea7\u3002</li> <li>\u786e\u5b9a\u6027\uff1a\u5728\u4e0d\u8003\u8651\u8ba1\u65f6\u5668\u4e8b\u4ef6\u7684\u60c5\u51b5\u4e0b\uff0c\u6574\u4e2a\u8c03\u5ea6\u673a\u5236\u90fd\u662f\u53ef\u9884\u77e5\u548c\u91cd\u73b0\u7684\u3002\u8be5\u7b97\u6cd5\u7684\u57fa\u672c\u601d\u60f3\u53ef\u4ee5\u8003\u8651\u5982\u4e0b\uff1a       </li> <li>\u4e3a\u6bcf\u4e2arunnable\u7684\u8fdb\u7a0b\u8bbe\u7f6e\u4e00\u4e2a\u5f53\u524d\u72b6\u6001stride\uff0c\u8868\u793a\u8be5\u8fdb\u7a0b\u5f53\u524d\u7684\u8c03\u5ea6\u6743\u3002\u53e6\u5916\u5b9a\u4e49\u5176\u5bf9\u5e94\u7684pass\u503c\uff0c\u8868\u793a\u5bf9\u5e94\u8fdb\u7a0b\u5728\u8c03\u5ea6\u540e\uff0cstride \u9700\u8981\u8fdb\u884c\u7684\u7d2f\u52a0\u503c\u3002  </li> <li>\u6bcf\u6b21\u9700\u8981\u8c03\u5ea6\u65f6\uff0c\u4ece\u5f53\u524d runnable \u6001\u7684\u8fdb\u7a0b\u4e2d\u9009\u62e9 stride\u6700\u5c0f\u7684\u8fdb\u7a0b\u8c03\u5ea6\u3002</li> <li>\u5bf9\u4e8e\u83b7\u5f97\u8c03\u5ea6\u7684\u8fdb\u7a0bP\uff0c\u5c06\u5bf9\u5e94\u7684stride\u52a0\u4e0a\u5176\u5bf9\u5e94\u7684\u6b65\u957fpass\uff08\u53ea\u4e0e\u8fdb\u7a0b\u7684\u4f18\u5148\u6743\u6709\u5173\u7cfb\uff09\u3002  </li> <li> <p>\u5728\u4e00\u6bb5\u56fa\u5b9a\u7684\u65f6\u95f4\u4e4b\u540e\uff0c\u56de\u5230 2.\u6b65\u9aa4\uff0c\u91cd\u65b0\u8c03\u5ea6\u5f53\u524dstride\u6700\u5c0f\u7684\u8fdb\u7a0b\u3002  \u53ef\u4ee5\u8bc1\u660e\uff0c\u5982\u679c\u4ee4 P.pass =BigStride / P.priority \u5176\u4e2d P.priority \u8868\u793a\u8fdb\u7a0b\u7684\u4f18\u5148\u6743\uff08\u5927\u4e8e 1\uff09\uff0c\u800c BigStride \u8868\u793a\u4e00\u4e2a\u9884\u5148\u5b9a\u4e49\u7684\u5927\u5e38\u6570\uff0c\u5219\u8be5\u8c03\u5ea6\u65b9\u6848\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u914d\u7684\u65f6\u95f4\u5c06\u4e0e\u5176\u4f18\u5148\u7ea7\u6210\u6b63\u6bd4\u3002\u8bc1\u660e\u8fc7\u7a0b\u6211\u4eec\u5728\u8fd9\u91cc\u7565\u53bb\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u5728\u7f51\u4e0a\u67e5\u627e\u76f8\u5173\u8d44\u6599\u3002\u5c06\u8be5\u8c03\u5ea6\u5668\u5e94\u7528\u5230 ucore \u7684\u8c03\u5ea6\u5668\u6846\u67b6\u4e2d\u6765\uff0c\u5219\u9700\u8981\u5c06\u8c03\u5ea6\u5668\u63a5\u53e3\u5b9e\u73b0\u5982\u4e0b\uff1a</p> </li> <li> <p>init:   \u2013 \u521d\u59cb\u5316\u8c03\u5ea6\u5668\u7c7b\u7684\u4fe1\u606f\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\u3002  \u2013 \u521d\u59cb\u5316\u5f53\u524d\u7684\u8fd0\u884c\u961f\u5217\u4e3a\u4e00\u4e2a\u7a7a\u7684\u5bb9\u5668\u7ed3\u6784\u3002\uff08\u6bd4\u5982\u548cRR\u8c03\u5ea6\u7b97\u6cd5\u4e00\u6837\uff0c\u521d\u59cb\u5316\u4e3a\u4e00\u4e2a\u6709\u5e8f\u5217\u8868\uff09   </p> </li> <li> <p>enqueue   \u2013 \u521d\u59cb\u5316\u521a\u8fdb\u5165\u8fd0\u884c\u961f\u5217\u7684\u8fdb\u7a0b proc\u7684stride\u5c5e\u6027\u3002    \u2013 \u5c06 proc\u63d2\u5165\u653e\u5165\u8fd0\u884c\u961f\u5217\u4e2d\u53bb\uff08\u6ce8\u610f\uff1a\u8fd9\u91cc\u5e76\u4e0d\u8981\u6c42\u653e\u7f6e\u5728\u961f\u5217\u5934\u90e8\uff09\u3002    </p> </li> <li> <p>dequeue   \u2013 \u4ece\u8fd0\u884c\u961f\u5217\u4e2d\u5220\u9664\u76f8\u5e94\u7684\u5143\u7d20\u3002     </p> </li> <li> <p>pick next     \u2013 \u626b\u63cf\u6574\u4e2a\u8fd0\u884c\u961f\u5217\uff0c\u8fd4\u56de\u5176\u4e2dstride\u503c\u6700\u5c0f\u7684\u5bf9\u5e94\u8fdb\u7a0b\u3002    \u2013 \u66f4\u65b0\u5bf9\u5e94\u8fdb\u7a0b\u7684stride\u503c\uff0c\u5373pass = BIG_STRIDE / P-&gt;priority; P-&gt;stride += pass\u3002     </p> </li> <li> <p>proc tick:  \u2013 \u68c0\u6d4b\u5f53\u524d\u8fdb\u7a0b\u662f\u5426\u5df2\u7528\u5b8c\u5206\u914d\u7684\u65f6\u95f4\u7247\u3002\u5982\u679c\u65f6\u95f4\u7247\u7528\u5b8c\uff0c\u5e94\u8be5\u6b63\u786e\u8bbe\u7f6e\u8fdb\u7a0b\u7ed3\u6784\u7684\u76f8\u5173\u6807\u8bb0\u6765\u5f15\u8d77\u8fdb\u7a0b\u5207\u6362\u3002   \u2013 \u4e00\u4e2a process \u6700\u591a\u53ef\u4ee5\u8fde\u7eed\u8fd0\u884c rq.max_time_slice\u4e2a\u65f6\u95f4\u7247\u3002    </p> </li> </ul> <p>\u5728\u5177\u4f53\u5b9e\u73b0\u65f6\uff0c\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\uff1astride\u5c5e\u6027\u7684\u6ea2\u51fa\u95ee\u9898\uff0c\u5728\u4e4b\u524d\u7684\u5b9e\u73b0\u91cc\u9762\u6211\u4eec\u5e76\u6ca1\u6709\u8003\u8651 stride \u7684\u6570\u503c\u8303\u56f4\uff0c\u800c\u8fd9\u4e2a\u503c\u5728\u7406\u8bba\u4e0a\u662f\u4e0d\u65ad\u589e\u52a0\u7684\uff0c\u5728 stride\u6ea2\u51fa\u4ee5\u540e\uff0c\u57fa\u4e8estride\u7684\u6bd4\u8f83\u53ef\u80fd\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u6bd4\u5982\u5047\u8bbe\u5f53\u524d\u5b58\u5728\u4e24\u4e2a\u8fdb\u7a0bA\u548cB\uff0cstride\u5c5e\u6027\u91c7\u752816\u4f4d\u65e0\u7b26\u53f7\u6574\u6570\u8fdb\u884c\u5b58\u50a8\u3002\u5f53\u524d\u961f\u5217\u4e2d\u5143\u7d20\u5982\u4e0b\uff08\u5047\u8bbe\u5f53\u524d\u8fd0\u884c\u7684\u8fdb\u7a0b\u5df2\u7ecf\u88ab\u91cd\u65b0\u653e\u7f6e\u8fdb\u8fd0\u884c\u961f\u5217\u4e2d\uff09\uff1a   </p> <p></p> <p>\u6b64\u65f6\u5e94\u8be5\u9009\u62e9 A \u4f5c\u4e3a\u8c03\u5ea6\u7684\u8fdb\u7a0b\uff0c\u800c\u5728\u4e00\u8f6e\u8c03\u5ea6\u540e\uff0c\u961f\u5217\u5c06\u5982\u4e0b\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u7531\u4e8e\u6ea2\u51fa\u7684\u51fa\u73b0\uff0c\u8fdb\u7a0b\u95f4stride\u7684\u7406\u8bba\u6bd4\u8f83\u548c\u5b9e\u9645\u6bd4\u8f83\u7ed3\u679c\u51fa\u73b0\u4e86\u504f\u5dee\u3002\u6211\u4eec\u9996\u5148\u5728\u7406\u8bba\u4e0a\u5206\u6790\u8fd9\u4e2a\u95ee\u9898\uff1a\u4ee4PASS_MAX\u4e3a\u5f53\u524d\u6240\u6709\u8fdb\u7a0b\u91cc\u6700\u5927\u7684\u6b65\u8fdb\u503c\u3002\u5219\u6211\u4eec\u53ef\u4ee5\u8bc1\u660e\u5982\u4e0b\u7ed3\u8bba\uff1a\u5bf9\u6bcf\u6b21Stride\u8c03\u5ea6\u5668\u7684\u8c03\u5ea6\u6b65\u9aa4\u4e2d\uff0c\u6709\u5176\u6700\u5927\u7684\u6b65\u8fdb\u503cSTRIDE_MAX\u548c\u6700\u5c0f\u7684\u6b65\u8fdb\u503cSTRIDE_MIN\u4e4b\u5dee\uff1a</p> <p>STRIDE_MAX \u2013 STRIDE_MIN &lt;= PASS_MAX</p> <p>\u63d0\u95ee 1\uff1a\u5982\u4f55\u8bc1\u660e\u8be5\u7ed3\u8bba\uff1f</p> <p>\u6709\u4e86\u8be5\u7ed3\u8bba\uff0c\u5728\u52a0\u4e0a\u4e4b\u524d\u5bf9\u4f18\u5148\u7ea7\u6709Priority &gt; 1\u9650\u5236\uff0c\u6211\u4eec\u6709STRIDE_MAX \u2013 STRIDE_MIN &lt;= BIG_STRIDE,\u4e8e\u662f\u6211\u4eec\u53ea\u8981\u5c06BigStride\u53d6\u5728\u67d0\u4e2a\u8303\u56f4\u4e4b\u5185\uff0c\u5373\u53ef\u4fdd\u8bc1\u5bf9\u4e8e\u4efb\u610f\u4e24\u4e2a Stride \u4e4b\u5dee\u90fd\u4f1a\u5728\u673a\u5668\u6574\u6570\u8868\u793a\u7684\u8303\u56f4\u4e4b\u5185\u3002\u800c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5176\u4e0e0\u7684\u6bd4\u8f83\u7ed3\u6784\uff0c\u6765\u5f97\u5230\u4e24\u4e2aStride\u7684\u5927\u5c0f\u5173\u7cfb\u3002\u5728\u4e0a\u4f8b\u4e2d\uff0c\u867d\u7136\u5728\u76f4\u63a5\u7684\u6570\u503c\u8868\u793a\u4e0a 98 &lt; 65535\uff0c\u4f46\u662f 98 - 65535 \u7684\u7ed3\u679c\u7528\u5e26\u7b26\u53f7\u7684 16\u4f4d\u6574\u6570\u8868\u793a\u7684\u7ed3\u679c\u4e3a99,\u4e0e\u7406\u8bba\u503c\u4e4b\u5dee\u76f8\u7b49\u3002\u6240\u4ee5\u5728\u8fd9\u4e2a\u610f\u4e49\u4e0b 98 &gt; 65535\u3002\u57fa\u4e8e\u8fd9\u79cd\u7279\u6b8a\u8003\u8651\u7684\u6bd4\u8f83\u65b9\u6cd5\uff0c\u5373\u4fbfStride\u6709\u53ef\u80fd\u6ea2\u51fa\uff0c\u6211\u4eec\u4ecd\u80fd\u591f\u5f97\u5230\u7406\u8bba\u4e0a\u7684\u5f53\u524d\u6700\u5c0fStride\uff0c\u5e76\u505a\u51fa\u6b63\u786e\u7684\u8c03\u5ea6\u51b3\u5b9a\u3002</p> <p>\u63d0\u95ee 2\uff1a\u5728 ucore \u4e2d\uff0c\u76ee\u524dStride\u662f\u91c7\u7528\u65e0\u7b26\u53f7\u768432\u4f4d\u6574\u6570\u8868\u793a\u3002\u5219BigStride\u5e94\u8be5\u53d6\u591a\u5c11\uff0c\u624d\u80fd\u4fdd\u8bc1\u6bd4\u8f83\u7684\u6b63\u786e\u6027\uff1f</p>"},{"location":"lab6/stride/#stride-scheduling_1","title":"\u4f7f\u7528\u4f18\u5148\u961f\u5217\u5b9e\u73b0 Stride Scheduling","text":"<p>\u5728\u4e0a\u8ff0\u7684\u5b9e\u73b0\u63cf\u8ff0\u4e2d\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u6b21pick_next\u51fd\u6570\uff0c\u6211\u4eec\u90fd\u9700\u8981\u5b8c\u6574\u5730\u626b\u63cf\u6765\u83b7\u5f97\u5f53\u524d\u6700\u5c0f\u7684stride\u53ca\u5176\u8fdb\u7a0b\u3002\u8fd9\u5728\u8fdb\u7a0b\u975e\u5e38\u591a\u7684\u65f6\u5019\u662f\u975e\u5e38\u8017\u65f6\u548c\u4f4e\u6548\u7684\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u5728\u5b9e\u73b0\u4e86\u57fa\u4e8e\u5217\u8868\u626b\u63cf\u7684Stride\u8c03\u5ea6\u5668\u4e4b\u540e\u6bd4\u8f83\u4e00\u4e0bpriority\u7a0b\u5e8f\u5728Round-Robin\u53caStride\u8c03\u5ea6\u5668\u4e0b\u5404\u81ea\u7684\u8fd0\u884c\u65f6\u95f4\u3002\u8003\u8651\u5230\u5176\u8c03\u5ea6\u9009\u62e9\u4e8e\u4f18\u5148\u961f\u5217\u7684\u62bd\u8c61\u903b\u8f91\u4e00\u81f4\uff0c\u6211\u4eec\u8003\u8651\u4f7f\u7528\u4f18\u5316\u7684\u4f18\u5148\u961f\u5217\u6570\u636e\u7ed3\u6784\u5b9e\u73b0\u8be5\u8c03\u5ea6\u3002</p> <p>\u4f18\u5148\u961f\u5217\u662f\u8fd9\u6837\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff1a\u4f7f\u7528\u8005\u53ef\u4ee5\u5feb\u901f\u7684\u63d2\u5165\u548c\u5220\u9664\u961f\u5217\u4e2d\u7684\u5143\u7d20\uff0c\u5e76\u4e14\u5728\u9884\u5148\u6307\u5b9a\u7684\u987a\u5e8f\u4e0b\u5feb\u901f\u53d6\u5f97\u5f53\u524d\u5728\u961f\u5217\u4e2d\u7684\u6700\u5c0f\uff08\u6216\u8005\u6700\u5927\uff09\u503c\u53ca\u5176\u5bf9\u5e94\u5143\u7d20\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u975e\u5e38\u7b26\u5408 Stride \u8c03\u5ea6\u5668\u7684\u5b9e\u73b0\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u63d0\u4f9b\u4e86libs/skew_heap.h \u4f5c\u4e3a\u4f18\u5148\u961f\u5217\u7684\u4e00\u4e2a\u5b9e\u73b0\uff0c\u8be5\u5b9e\u73b0\u5b9a\u4e49\u76f8\u5173\u7684\u7ed3\u6784\u548c\u63a5\u53e3\uff0c\u5176\u4e2d\u4e3b\u8981\u5305\u62ec\uff1a</p> <pre><code>1   // \u4f18\u5148\u961f\u5217\u8282\u70b9\u7684\u7ed3\u6784\n2   typedef struct skew_heap_entry  skew_heap_entry_t;\n3   // \u521d\u59cb\u5316\u4e00\u4e2a\u961f\u5217\u8282\u70b9\n4   void skew_heap_init(skew_heap_entry_t *a);\n5   // \u5c06\u8282\u70b9 b \u63d2\u5165\u81f3\u4ee5\u8282\u70b9 a \u4e3a\u961f\u5217\u5934\u7684\u961f\u5217\u4e2d\u53bb\uff0c\u8fd4\u56de\u63d2\u5165\u540e\u7684\u961f\u5217\n6   skew_heap_entry_t  *skew_heap_insert(skew_heap_entry_t  *a,\n7                                        skew_heap_entry_t  *b,\n8                                        compare_f comp);\n9   // \u5c06\u8282\u70b9 b \u63d2\u5165\u4ece\u4ee5\u8282\u70b9 a \u4e3a\u961f\u5217\u5934\u7684\u961f\u5217\u4e2d\u53bb\uff0c\u8fd4\u56de\u5220\u9664\u540e\u7684\u961f\u5217\n10      skew_heap_entry_t  *skew_heap_remove(skew_heap_entry_t  *a,\n11                                           skew_heap_entry_t  *b,\n12                                           compare_f comp);\n</code></pre> <p>\u5176\u4e2d\u4f18\u5148\u961f\u5217\u7684\u987a\u5e8f\u662f\u7531\u6bd4\u8f83\u51fd\u6570comp\u51b3\u5b9a\u7684\uff0csched_stride.c\u4e2d\u63d0\u4f9b\u4e86proc_stride_comp_f\u6bd4\u8f83\u5668\u7528\u6765\u6bd4\u8f83\u4e24\u4e2astride\u7684\u5927\u5c0f\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b83\u3002\u5f53\u4f7f\u7528\u4f18\u5148\u961f\u5217\u4f5c\u4e3aStride\u8c03\u5ea6\u5668\u7684\u5b9e\u73b0\u65b9\u5f0f\u4e4b\u540e\uff0c\u8fd0\u884c\u961f\u5217\u7ed3\u6784\u4e5f\u9700\u8981\u4f5c\u76f8\u5173\u6539\u53d8\uff0c\u5176\u4e2d\u5305\u62ec\uff1a</p> <ul> <li> <p>struct run_queue\u4e2d\u7684lab6_run_pool\u6307\u9488\uff0c\u5728\u4f7f\u7528\u4f18\u5148\u961f\u5217\u7684\u5b9e\u73b0\u4e2d\u8868\u793a\u5f53\u524d\u4f18\u5148\u961f\u5217\u7684\u5934\u5143\u7d20\uff0c\u5982\u679c\u4f18\u5148\u961f\u5217\u4e3a\u7a7a\uff0c\u5219\u5176\u6307\u5411\u7a7a\u6307\u9488\uff08NULL\uff09\u3002</p> </li> <li> <p>struct proc_struct\u4e2d\u7684lab6_run_pool\u7ed3\u6784\uff0c\u8868\u793a\u5f53\u524d\u8fdb\u7a0b\u5bf9\u5e94\u7684\u4f18\u5148\u961f\u5217\u8282\u70b9\u3002\u672c\u6b21\u5b9e\u9a8c\u5df2\u7ecf\u4fee\u6539\u4e86\u7cfb\u7edf\u76f8\u5173\u90e8\u5206\u7684\u4ee3\u7801\uff0c\u4f7f\u5f97\u5176\u80fd\u591f\u5f88\u597d\u5730\u9002\u5e94LAB6\u65b0\u52a0\u5165\u7684\u6570\u636e\u7ed3\u6784\u548c\u63a5\u53e3\u3002\u800c\u5728\u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981\u505a\u7684\u662f\u7528\u4f18\u5148\u961f\u5217\u5b9e\u73b0\u4e00\u4e2a\u6b63\u786e\u548c\u9ad8\u6548\u7684Stride\u8c03\u5ea6\u5668\uff0c\u5982\u679c\u7528\u8f83\u7b80\u7565\u7684\u4f2a\u4ee3\u7801\u63cf\u8ff0\uff0c\u5219\u6709\uff1a</p> </li> <li> <p>init(rq):  \u2013 Initialize rq-&gt;run_list  \u2013 Set rq-&gt;lab6_run_pool to NULL  \u2013 Set rq-&gt;proc_num to 0   </p> </li> <li> <p>enqueue(rq, proc)  \u2013 Initialize proc-&gt;time_slice   \u2013 Insert proc-&gt;lab6_run_pool into rq-&gt;lab6_run_pool  \u2013 rq-&gt;proc_num ++   </p> </li> <li> <p>dequeue(rq, proc)  \u2013 Remove proc-&gt;lab6_run_pool from rq-&gt;lab6_run_pool   \u2013 rq-&gt;proc_num --   </p> </li> <li> <p>pick_next(rq)  \u2013 If rq-&gt;lab6_run_pool == NULL, return NULL  \u2013 Find the proc corresponding to the pointer rq-&gt;lab6_run_pool  \u2013 proc-&gt;lab6_stride += BIG_STRIDE / proc-&gt;lab6_priority  \u2013 Return proc   </p> </li> <li> <p>proc_tick(rq, proc):  \u2013 If proc-&gt;time_slice &gt; 0, proc-&gt;time_slice --  \u2013 If proc-&gt;time_slice == 0, set the flag proc-&gt;need_resched    </p> </li> </ul>"},{"location":"lab6/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab6/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab6\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\u548c2\u4e2a\u6269\u5c55\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB6\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB6\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab6/task/#1-round-robin","title":"\u7ec3\u4e601:  \u4f7f\u7528 Round Robin \u8c03\u5ea6\u7b97\u6cd5\uff08\u4e0d\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5b8c\u6210\uff1a  - \u8bf7\u7406\u89e3\u5e76\u5206\u6790sched_class\u4e2d\u5404\u4e2a\u51fd\u6570\u6307\u9488\u7684\u7528\u6cd5\uff0c\u5e76\u7ed3\u5408Round Robin \u8c03\u5ea6\u7b97\u6cd5\u63cfucore\u7684\u8c03\u5ea6\u6267\u884c\u8fc7\u7a0b  - \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5982\u4f55\u8bbe\u8ba1\u5b9e\u73b0\u201d\u591a\u7ea7\u53cd\u9988\u961f\u5217\u8c03\u5ea6\u7b97\u6cd5\u201c\uff0c\u7ed9\u51fa\u6982\u8981\u8bbe\u8ba1\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1</p>"},{"location":"lab6/task/#2-stride-scheduling","title":"\u7ec3\u4e602: \u5b9e\u73b0 Stride Scheduling \u8c03\u5ea6\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u9996\u5148\u9700\u8981\u6362\u6389RR\u8c03\u5ea6\u5668\u7684\u5b9e\u73b0\uff0c\u5373\u7528default_sched_stride_c\u8986\u76d6default_sched.c\u3002\u7136\u540e\u6839\u636e\u6b64\u6587\u4ef6\u548c\u540e\u7eed\u6587\u6863\u5bf9Stride\u5ea6\u5668\u7684\u76f8\u5173\u63cf\u8ff0\uff0c\u5b8c\u6210Stride\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002</p> <p>\u540e\u9762\u7684\u5b9e\u9a8c\u6587\u6863\u90e8\u5206\u7ed9\u51fa\u4e86Stride\u8c03\u5ea6\u7b97\u6cd5\u7684\u5927\u4f53\u63cf\u8ff0\u3002\u8fd9\u91cc\u7ed9\u51faStride\u8c03\u5ea6\u7b97\u6cd5\u7684\u4e00\u4e9b\u76f8\u5173\u7684\u8d44\u6599\uff08\u76ee\u524d\u7f51\u4e0a\u4e2d\u6587\u7684\u8d44\u6599\u6bd4\u8f83\u6b20\u7f3a\uff09\u3002</p> <ul> <li>strid-shed paper location1</li> <li>strid-shed paper location2</li> <li>\u4e5f\u53efGOOGLE \u201cStride Scheduling\u201d \u6765\u67e5\u627e\u76f8\u5173\u8d44\u6599</li> </ul> <p>\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\u540e\uff0c\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\uff1amake qemu -j 16</p> <p>\u5982\u679c\u53ef\u4ee5\u5f97\u5230\u5982 \u7f16\u8bd1\u65b9\u6cd5\u6240\u793a\u7684\u663e\u793a\u5185\u5bb9\uff08\u4ec5\u4f9b\u53c2\u8003\uff0c\u4e0d\u662f\u6807\u51c6\u7b54\u6848\u8f93\u51fa\uff09\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002</p>"},{"location":"lab6/task/#challenge-1-linux-cfs","title":"\u6269\u5c55\u7ec3\u4e60 Challenge 1 \uff1a\u5b9e\u73b0 Linux \u7684 CFS \u8c03\u5ea6\u7b97\u6cd5","text":"<p>\u5728ucore\u7684\u8c03\u5ea6\u5668\u6846\u67b6\u4e0b\u5b9e\u73b0\u4e0bLinux\u7684CFS\u8c03\u5ea6\u7b97\u6cd5\u3002\u53ef\u9605\u8bfb\u76f8\u5173Linux\u5185\u6838\u4e66\u7c4d\u6216\u67e5\u8be2\u7f51\u4e0a\u8d44\u6599\uff0c\u53ef\u4e86\u89e3CFS\u7684\u7ec6\u8282\uff0c\u7136\u540e\u5927\u81f4\u5b9e\u73b0\u5728ucore\u4e2d\u3002</p>"},{"location":"lab6/task/#challenge-2-ucorefifo-sjf","title":"\u6269\u5c55\u7ec3\u4e60 Challenge 2 \uff1a\u5728ucore\u4e0a\u5b9e\u73b0\u5c3d\u53ef\u80fd\u591a\u7684\u5404\u79cd\u57fa\u672c\u8c03\u5ea6\u7b97\u6cd5(FIFO, SJF,...)\uff0c\u5e76\u8bbe\u8ba1\u5404\u79cd\u6d4b\u8bd5\u7528\u4f8b\uff0c\u80fd\u591f\u5b9a\u91cf\u5730\u5206\u6790\u51fa\u5404\u79cd\u8c03\u5ea6\u7b97\u6cd5\u5728\u5404\u79cd\u6307\u6807\u4e0a\u7684\u5dee\u5f02\uff0c\u8bf4\u660e\u8c03\u5ea6\u7b97\u6cd5\u7684\u9002\u7528\u8303\u56f4\u3002","text":""},{"location":"lab7/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab7/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB7    := -DLAB7_EX1 -D_SHOW_PHI(\u7b2c12\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\nLAB4    := -DLAB4_EX1 -DLAB4_EX2\nLAB5    := -DLAB5_EX1 -DLAB5_EX2\nLAB6    := -DLAB6_EX2\nLAB7    := -DLAB7_EX1 -D_SHOW_PHI\n# LAB8  := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0021000 (phys)\nedata 0xA0155490 (phys)\nend   0xA0158770 (phys)\nKernel executable memory footprint: 1246KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0199000\nfree pages: 00001E67\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nsched class: stride_scheduler\nproc_init succeeded\nkernel_execve: pid = 2, name = \"exit\".\nI am the parent. Forking the child...\nI am parent, fork a child pid 13\nI am the parent, waiting now..\nI am No.0 philosopher_sema\nIter 1, No.0 philosopher_sema is thinking\nI am No.1 philosopher_sema\nIter 1, No.1 philosopher_sema is thinking\nI am No.2 philosopher_sema\nIter 1, No.2 philosopher_sema is thinking\nI am No.2 philosopher_condvar\nIter 1, No.2 philosopher_condvar is thinking\nI am No.3 philosopher_sema\nIter 1, No.3 philosopher_sema is thinking\nI am No.4 philosopher_sema\nIter 1, No.4 philosopher_sema is thinking\nI am No.0 philosopher_condvar\nIter 1, No.0 philosopher_condvar is thinking\nI am No.1 philosopher_condvar\nIter 1, No.1 philosopher_condvar is thinking\nI am No.3 philosopher_condvar\nIter 1, No.3 philosopher_condvar is thinking\nI am No.4 philosopher_condvar\nIter 1, No.4 philosopher_condvar is thinking\nI am the child.\nwaitpid 13 ok.\nexit pass.\nIter 1, No.0 philosopher_sema is eating\nIter 1, No.2 philosopher_sema is eating\nphi_test_condvar: state_condvar[2] will eating\nphi_test_condvar: signal self_cv[2] \ncond_signal begin: cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 1, No.2 philosopher_condvar is eating\nphi_test_condvar: state_condvar[0] will eating\nphi_test_condvar: signal self_cv[0] \ncond_signal begin: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 1, No.0 philosopher_condvar is eating\nphi_take_forks_condvar: 1 didn't get fork and will wait\ncond_wait begin:  cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_take_forks_condvar: 3 didn't get fork and will wait\ncond_wait begin:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_take_forks_condvar: 4 didn't get fork and will wait\ncond_wait begin:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.0 philosopher_sema is thinking\nIter 2, No.2 philosopher_sema is thinking\nIter 1, No.1 philosopher_sema is eating\nphi_test_condvar: state_condvar[3] will eating\nphi_test_condvar: signal self_cv[3] \ncond_signal begin: cvp a01b20cc, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\nIter 1, No.4 philosopher_sema is eating\ncond_wait end:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 1, No.3 philosopher_condvar is eating\ncond_signal end: cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.2 philosopher_condvar is thinking\nphi_test_condvar: state_condvar[1] will eating\nphi_test_condvar: signal self_cv[1] \ncond_signal begin: cvp a01b20a4, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 1, No.1 philosopher_condvar is eating\ncond_signal end: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.0 philosopher_condvar is thinking\nphi_take_forks_condvar: 0 didn't get fork and will wait\ncond_wait begin:  cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_test_condvar: state_condvar[0] will eating\nphi_test_condvar: signal self_cv[0] \ncond_signal begin: cvp a01b2090, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 2, No.0 philosopher_condvar is eating\ncond_signal end: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.1 philosopher_condvar is thinking\nIter 2, No.1 philosopher_sema is thinking\nphi_take_forks_condvar: 2 didn't get fork and will wait\ncond_wait begin:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.2 philosopher_sema is eating\nIter 2, No.4 philosopher_sema is thinking\nphi_test_condvar: state_condvar[2] will eating\nphi_test_condvar: signal self_cv[2] \ncond_signal begin: cvp a01b20b8, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.0 philosopher_sema is eating\ncond_wait end:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 2, No.2 philosopher_condvar is eating\ncond_signal end: cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.3 philosopher_condvar is thinking\nIter 3, No.0 philosopher_sema is thinking\nIter 3, No.2 philosopher_condvar is thinking\nphi_test_condvar: state_condvar[4] will eating\nphi_test_condvar: signal self_cv[4] \ncond_signal begin: cvp a01b20e0, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 1, No.4 philosopher_condvar is eating\nIter 3, No.2 philosopher_sema is thinking\nIter 1, No.3 philosopher_sema is eating\ncond_signal end: cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.0 philosopher_condvar is thinking\nphi_test_condvar: state_condvar[1] will eating\nphi_test_condvar: signal self_cv[1] \ncond_signal begin: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.1 philosopher_condvar is eating\nphi_take_forks_condvar: 3 didn't get fork and will wait\ncond_wait begin:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.1 philosopher_sema is eating\nIter 2, No.3 philosopher_sema is thinking\nIter 2, No.4 philosopher_sema is eating\nphi_take_forks_condvar: 0 didn't get fork and will wait\ncond_wait begin:  cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.1 philosopher_condvar is thinking\nphi_test_condvar: state_condvar[3] will eating\nphi_test_condvar: signal self_cv[3] \ncond_signal begin: cvp a01b20cc, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 2, No.3 philosopher_condvar is eating\nIter 3, No.1 philosopher_sema is thinking\nIter 3, No.2 philosopher_sema is eating\ncond_signal end: cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_test_condvar: state_condvar[0] will eating\nphi_test_condvar: signal self_cv[0] \ncond_signal begin: cvp a01b2090, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 3, No.0 philosopher_condvar is eating\ncond_signal end: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 2, No.4 philosopher_condvar is thinking\nphi_take_forks_condvar: 2 didn't get fork and will wait\ncond_wait begin:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_take_forks_condvar: 4 didn't get fork and will wait\ncond_wait begin:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.0 philosopher_condvar is thinking\nIter 3, No.4 philosopher_sema is thinking\nphi_test_condvar: state_condvar[1] will eating\nphi_test_condvar: signal self_cv[1] \ncond_signal begin: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.1 philosopher_condvar is eating\nphi_test_condvar: state_condvar[4] will eating\nphi_test_condvar: signal self_cv[4] \ncond_signal begin: cvp a01b20e0, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.0 philosopher_sema is eating\nIter 4, No.2 philosopher_sema is thinking\nIter 2, No.3 philosopher_sema is eating\ncond_wait end:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 2, No.4 philosopher_condvar is eating\ncond_signal end: cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.3 philosopher_condvar is thinking\nphi_take_forks_condvar: 3 didn't get fork and will wait\ncond_wait begin:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_test_condvar: state_condvar[3] will eating\nphi_test_condvar: signal self_cv[3] \ncond_signal begin: cvp a01b20cc, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 3, No.3 philosopher_condvar is eating\ncond_signal end: cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.4 philosopher_condvar is thinking\nIter 4, No.0 philosopher_sema is thinking\nIter 3, No.1 philosopher_sema is eating\nIter 3, No.3 philosopher_sema is thinking\nIter 4, No.1 philosopher_condvar is thinking\nIter 3, No.4 philosopher_sema is eating\nphi_test_condvar: state_condvar[0] will eating\nphi_test_condvar: signal self_cv[0] \ncond_signal begin: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b2090, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.0 philosopher_condvar is eating\nIter 4, No.4 philosopher_sema is thinking\nNo.0 philosopher_condvar quit\nphi_test_condvar: state_condvar[2] will eating\nphi_test_condvar: signal self_cv[2] \ncond_signal begin: cvp a01b20b8, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 3, No.2 philosopher_condvar is eating\nIter 4, No.1 philosopher_sema is thinking\nIter 4, No.2 philosopher_sema is eating\ncond_signal end: cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.3 philosopher_condvar is thinking\nphi_test_condvar: state_condvar[4] will eating\nphi_test_condvar: signal self_cv[4] \ncond_signal begin: cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\ncond_signal end: cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 3, No.4 philosopher_condvar is eating\nIter 4, No.0 philosopher_sema is eating\nphi_take_forks_condvar: 1 didn't get fork and will wait\ncond_wait begin:  cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_take_forks_condvar: 3 didn't get fork and will wait\ncond_wait begin:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.4 philosopher_condvar is thinking\nNo.0 philosopher_sema quit\nphi_test_condvar: state_condvar[1] will eating\nphi_test_condvar: signal self_cv[1] \ncond_signal begin: cvp a01b20a4, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.4 philosopher_sema is eating\ncond_wait end:  cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 4, No.1 philosopher_condvar is eating\ncond_signal end: cvp a01b20a4, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_test_condvar: state_condvar[3] will eating\nphi_test_condvar: signal self_cv[3] \ncond_signal begin: cvp a01b20cc, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 4, No.3 philosopher_condvar is eating\nNo.2 philosopher_sema quit\nIter 4, No.1 philosopher_sema is eating\ncond_signal end: cvp a01b20cc, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nIter 4, No.2 philosopher_condvar is thinking\nphi_take_forks_condvar: 4 didn't get fork and will wait\ncond_wait begin:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nNo.1 philosopher_sema quit\nphi_take_forks_condvar: 2 didn't get fork and will wait\ncond_wait begin:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nNo.4 philosopher_sema quit\nIter 3, No.3 philosopher_sema is eating\nNo.1 philosopher_condvar quit\nphi_test_condvar: state_condvar[2] will eating\nphi_test_condvar: signal self_cv[2] \ncond_signal begin: cvp a01b20b8, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 4, No.2 philosopher_condvar is eating\ncond_signal end: cvp a01b20b8, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nphi_test_condvar: state_condvar[4] will eating\nphi_test_condvar: signal self_cv[4] \ncond_signal begin: cvp a01b20e0, cvp-&gt;count 1, cvp-&gt;owner-&gt;next_count 0\ncond_wait end:  cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 1\nIter 4, No.4 philosopher_condvar is eating\ncond_signal end: cvp a01b20e0, cvp-&gt;count 0, cvp-&gt;owner-&gt;next_count 0\nNo.3 philosopher_condvar quit\nIter 4, No.3 philosopher_sema is thinking\nNo.4 philosopher_condvar quit\nNo.2 philosopher_condvar quit\nIter 4, No.3 philosopher_sema is eating\nNo.3 philosopher_sema quit\nall user-mode processes have quit.\ninit check memory pass.\nkernel panic at kern/process/proc.c:554:\n    initproc exit.\n\nWelcome to the kernel debug monitor!!\nType 'help' for a list of commands.\nK&gt; </code></pre></p>"},{"location":"lab7/lab7/","title":"\u5b9e\u9a8c\u4e03\uff1a\u540c\u6b65\u4e92\u65a5","text":""},{"location":"lab7/lab7/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u7406\u89e3\u64cd\u4f5c\u7cfb\u7edf\u7684\u540c\u6b65\u4e92\u65a5\u7684\u8bbe\u8ba1\u5b9e\u73b0\uff1b</li> <li>\u7406\u89e3\u5e95\u5c42\u652f\u6491\u6280\u672f\uff1a\u7981\u7528\u4e2d\u65ad\u3001\u5b9a\u65f6\u5668\u3001\u7b49\u5f85\u961f\u5217\uff1b</li> <li>\u5728ucore\u4e2d\u7406\u89e3\u4fe1\u53f7\u91cf\uff08semaphore\uff09\u673a\u5236\u7684\u5177\u4f53\u5b9e\u73b0\uff1b</li> <li>\u7406\u89e3\u7ba1\u7a0b\u673a\u5236\uff0c\u5728ucore\u5185\u6838\u4e2d\u589e\u52a0\u57fa\u4e8e\u7ba1\u7a0b\uff08monitor\uff09\u7684\u6761\u4ef6\u53d8\u91cf\uff08condition variable\uff09\u7684\u652f\u6301\uff1b</li> <li>\u4e86\u89e3\u7ecf\u5178\u8fdb\u7a0b\u540c\u6b65\u95ee\u9898\uff0c\u5e76\u80fd\u4f7f\u7528\u540c\u6b65\u673a\u5236\u89e3\u51b3\u8fdb\u7a0b\u540c\u6b65\u95ee\u9898\u3002</li> </ul>"},{"location":"lab7/lab7/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u9a8c\u516d\u5b8c\u6210\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u8c03\u5ea6\u6846\u67b6\u548c\u5177\u4f53\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c\u53ef\u8c03\u5ea6\u8fd0\u884c\u591a\u4e2a\u8fdb\u7a0b\u3002\u5982\u679c\u591a\u4e2a\u8fdb\u7a0b\u9700\u8981\u534f\u540c\u64cd\u4f5c\u6216\u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\uff0c\u5219\u5b58\u5728\u5982\u4f55\u540c\u6b65\u548c\u6709\u5e8f\u7ade\u4e89\u7684\u95ee\u9898\u3002\u672c\u6b21\u5b9e\u9a8c\uff0c\u4e3b\u8981\u662f\u719f\u6089ucore\u7684\u8fdb\u7a0b\u540c\u6b65\u673a\u5236\u2014\u4fe1\u53f7\u91cf\uff08semaphore\uff09\u673a\u5236\uff0c\u4ee5\u53ca\u57fa\u4e8e\u4fe1\u53f7\u91cf\u7684\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u89e3\u51b3\u65b9\u6848\u3002\u7136\u540e\u638c\u63e1\u7ba1\u7a0b\u7684\u6982\u5ff5\u548c\u539f\u7406\uff0c\u5e76\u53c2\u8003\u4fe1\u53f7\u91cf\u673a\u5236\uff0c\u5b9e\u73b0\u57fa\u4e8e\u7ba1\u7a0b\u7684\u6761\u4ef6\u53d8\u91cf\u673a\u5236\u548c\u57fa\u4e8e\u6761\u4ef6\u53d8\u91cf\u6765\u89e3\u51b3\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u3002</p> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u5728kern/sync/check_sync.c\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u4fe1\u53f7\u91cf\u7684\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u89e3\u6cd5\u3002\u540c\u65f6\u8fd8\u9700\u5b8c\u6210\u7ec3\u4e60\uff0c\u5373\u5b9e\u73b0\u57fa\u4e8e\u7ba1\u7a0b\uff08\u4e3b\u8981\u662f\u7075\u6d3b\u8fd0\u7528\u6761\u4ef6\u53d8\u91cf\u548c\u4e92\u65a5\u4fe1\u53f7\u91cf\uff09\u7684\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u89e3\u6cd5\u3002\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u63cf\u8ff0\u5982\u4e0b\uff1a\u6709\u4e94\u4e2a\u54f2\u5b66\u5bb6\uff0c\u4ed6\u4eec\u7684\u751f\u6d3b\u65b9\u5f0f\u662f\u4ea4\u66ff\u5730\u8fdb\u884c\u601d\u8003\u548c\u8fdb\u9910\u3002\u54f2\u5b66\u5bb6\u4eec\u516c\u7528\u4e00\u5f20\u5706\u684c\uff0c\u5468\u56f4\u653e\u6709\u4e94\u628a\u6905\u5b50\uff0c\u6bcf\u4eba\u5750\u4e00\u628a\u3002\u5728\u5706\u684c\u4e0a\u6709\u4e94\u4e2a\u7897\u548c\u4e94\u6839\u7b77\u5b50\uff0c\u5f53\u4e00\u4e2a\u54f2\u5b66\u5bb6\u601d\u8003\u65f6\uff0c\u4ed6\u4e0d\u4e0e\u5176\u4ed6\u4eba\u4ea4\u8c08\uff0c\u9965\u997f\u65f6\u4fbf\u8bd5\u56fe\u53d6\u7528\u5176\u5de6\u3001\u53f3\u6700\u9760\u8fd1\u4ed6\u7684\u7b77\u5b50\uff0c\u4f46\u4ed6\u53ef\u80fd\u4e00\u6839\u90fd\u62ff\u4e0d\u5230\u3002\u53ea\u6709\u5728\u4ed6\u62ff\u5230\u4e24\u6839\u7b77\u5b50\u65f6\uff0c\u65b9\u80fd\u8fdb\u9910\uff0c\u8fdb\u9910\u5b8c\u540e\uff0c\u653e\u4e0b\u7b77\u5b50\u53c8\u7ee7\u7eed\u601d\u8003\u3002</p>"},{"location":"lab7/lab7/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u4e92\u65a5\u662f\u6307\u67d0\u4e00\u8d44\u6e90\u540c\u65f6\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u5bf9\u5176\u8fdb\u884c\u8bbf\u95ee\uff0c\u5177\u6709\u552f\u4e00\u6027\u548c\u6392\u5b83\u6027\uff0c\u4f46\u4e92\u65a5\u4e0d\u7528\u9650\u5236\u8fdb\u7a0b\u5bf9\u8d44\u6e90\u7684\u8bbf\u95ee\u987a\u5e8f\uff0c\u5373\u8bbf\u95ee\u53ef\u4ee5\u662f\u65e0\u5e8f\u7684\u3002\u540c\u6b65\u662f\u6307\u5728\u8fdb\u7a0b\u95f4\u7684\u6267\u884c\u5fc5\u987b\u4e25\u683c\u6309\u7167\u89c4\u5b9a\u7684\u67d0\u79cd\u5148\u540e\u6b21\u5e8f\u6765\u8fd0\u884c\uff0c\u5373\u8bbf\u95ee\u662f\u6709\u5e8f\u7684\uff0c\u8fd9\u79cd\u5148\u540e\u6b21\u5e8f\u53d6\u51b3\u4e8e\u8981\u7cfb\u7edf\u5b8c\u6210\u7684\u4efb\u52a1\u9700\u6c42\u3002\u5728\u8fdb\u7a0b\u5199\u8d44\u6e90\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u95f4\u8981\u6c42\u6ee1\u8db3\u4e92\u65a5\u6761\u4ef6\u3002\u5728\u8fdb\u7a0b\u8bfb\u8d44\u6e90\u60c5\u51b5\u4e0b\uff0c\u53ef\u5141\u8bb8\u591a\u4e2a\u8fdb\u7a0b\u540c\u65f6\u8bbf\u95ee\u8d44\u6e90\u3002</p> <p>\u5b9e\u9a8c\u4e03\u8bbe\u8ba1\u5b9e\u73b0\u4e86\u591a\u79cd\u540c\u6b65\u4e92\u65a5\u624b\u6bb5\uff0c\u5305\u62ec\u65f6\u949f\u4e2d\u65ad\u7ba1\u7406\u3001\u7b49\u5f85\u961f\u5217\u3001\u4fe1\u53f7\u91cf\u3001\u7ba1\u7a0b\u673a\u5236\uff08\u5305\u542b\u6761\u4ef6\u53d8\u91cf\u8bbe\u8ba1\uff09\u7b49\uff0c\u5e76\u57fa\u4e8e\u4fe1\u53f7\u91cf\u5b9e\u73b0\u4e86\u54f2\u5b66\u5bb6\u95ee\u9898\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u800c\u672c\u6b21\u5b9e\u9a8c\u7684\u7ec3\u4e60\u662f\u8981\u6c42\u7528\u7ba1\u7a0b\u673a\u5236\u5b9e\u73b0\u54f2\u5b66\u5bb6\u95ee\u9898\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u5728\u5b9e\u73b0\u4fe1\u53f7\u91cf\u673a\u5236\u548c\u7ba1\u7a0b\u673a\u5236\u65f6\uff0c\u9700\u8981\u8ba9\u65e0\u6cd5\u8fdb\u5165\u4e34\u754c\u533a\u7684\u8fdb\u7a0b\u7761\u7720\uff0c\u4e3a\u6b64\u5728ucore\u4e2d\u8bbe\u8ba1\u4e86\u7b49\u5f85\u961f\u5217wait_queue\u3002\u5f53\u8fdb\u7a0b\u65e0\u6cd5\u8fdb\u5165\u4e34\u754c\u533a\uff08\u5373\u65e0\u6cd5\u83b7\u5f97\u4fe1\u53f7\u91cf\uff09\u65f6\uff0c\u53ef\u8ba9\u8fdb\u7a0b\u8fdb\u5165\u7b49\u5f85\u961f\u5217\uff0c\u8fd9\u65f6\u7684\u8fdb\u7a0b\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff08\u4e5f\u53ef\u79f0\u4e3a\u963b\u585e\u72b6\u6001\uff09\uff0c\u4ece\u800c\u4f1a\u8ba9\u5b9e\u9a8c\u516d\u4e2d\u7684\u8c03\u5ea6\u5668\u9009\u62e9\u4e00\u4e2a\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\uff08\u5373RUNNABLE STATE\uff09\u7684\u8fdb\u7a0b\uff0c\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\uff0c\u8ba9\u65b0\u8fdb\u7a0b\u6709\u673a\u4f1a\u5360\u7528CPU\u6267\u884c\uff0c\u4ece\u800c\u8ba9\u6574\u4e2a\u7cfb\u7edf\u7684\u8fd0\u884c\u66f4\u52a0\u9ad8\u6548\u3002</p> <p>\u5728\u5b9e\u9a8c\u4e03\u4e2d\u7684ucore\u521d\u59cb\u5316\u8fc7\u7a0b\uff0c\u5f00\u59cb\u7684\u6267\u884c\u6d41\u7a0b\u90fd\u4e0e\u5b9e\u9a8c\u516d\u76f8\u540c\uff0c\u76f4\u5230\u6267\u884c\u5230\u521b\u5efa\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binit_main\u65f6\uff0c\u4fee\u6539\u4e86init_main\u7684\u5177\u4f53\u6267\u884c\u5185\u5bb9\uff0c\u5373\u589e\u52a0\u4e86check_sync\u51fd\u6570\u7684\u8c03\u7528\uff0c\u800c\u4f4d\u4e8ekern/sync/check_sync.c\u4e2d\u7684check_sync\u51fd\u6570\u53ef\u4ee5\u7406\u89e3\u4e3a\u662f\u5b9e\u9a8c\u4e03\u7684\u8d77\u59cb\u6267\u884c\u70b9\uff0c\u662f\u5b9e\u9a8c\u4e03\u7684\u603b\u63a7\u51fd\u6570\u3002\u8fdb\u4e00\u6b65\u5206\u6790\u6b64\u51fd\u6570\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u51fd\u6570\u4e3b\u8981\u5206\u4e3a\u4e86\u4e24\u4e2a\u90e8\u5206\uff0c\u7b2c\u4e00\u90e8\u5206\u662f\u5b9e\u73b0\u57fa\u4e8e\u4fe1\u53f7\u91cf\u7684\u54f2\u5b66\u5bb6\u95ee\u9898\uff0c\u7b2c\u4e8c\u90e8\u5206\u662f\u5b9e\u73b0\u57fa\u4e8e\u7ba1\u7a0b\u7684\u54f2\u5b66\u5bb6\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8echeck_sync\u51fd\u6570\u7684\u7b2c\u4e00\u90e8\u5206\uff0c\u9996\u5148\u5b9e\u73b0\u521d\u59cb\u5316\u4e86\u4e00\u4e2a\u4e92\u65a5\u4fe1\u53f7\u91cf\uff0c\u7136\u540e\u521b\u5efa\u4e86\u5bf9\u5e945\u4e2a\u54f2\u5b66\u5bb6\u884c\u4e3a\u76845\u4e2a\u4fe1\u53f7\u91cf\uff0c\u5e76\u521b\u5efa5\u4e2a\u5185\u6838\u7ebf\u7a0b\u4ee3\u88685\u4e2a\u54f2\u5b66\u5bb6\uff0c\u6bcf\u4e2a\u5185\u6838\u7ebf\u7a0b\u5b8c\u6210\u4e86\u57fa\u4e8e\u4fe1\u53f7\u91cf\u7684\u54f2\u5b66\u5bb6\u5403\u996d\u7761\u89c9\u601d\u8003\u884c\u4e3a\u5b9e\u73b0\u3002\u8fd9\u90e8\u5206\u662f\u7ed9\u5b66\u751f\u4f5c\u4e3a\u7ec3\u4e60\u53c2\u8003\u7528\u7684\u3002\u5b66\u751f\u53ef\u4ee5\u770b\u770b\u4fe1\u53f7\u91cf\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff0c\u4ee5\u53ca\u5982\u4f55\u5229\u7528\u4fe1\u53f7\u91cf\u5b8c\u6210\u54f2\u5b66\u5bb6\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8echeck_sync\u51fd\u6570\u7684\u7b2c\u4e8c\u90e8\u5206\uff0c\u9996\u5148\u521d\u59cb\u5316\u4e86\u7ba1\u7a0b\uff0c\u7136\u540e\u53c8\u521b\u5efa\u4e865\u4e2a\u5185\u6838\u7ebf\u7a0b\u4ee3\u88685\u4e2a\u54f2\u5b66\u5bb6\uff0c\u6bcf\u4e2a\u5185\u6838\u7ebf\u7a0b\u8981\u5b8c\u6210\u57fa\u4e8e\u7ba1\u7a0b\u7684\u54f2\u5b66\u5bb6\u5403\u996d\u3001\u7761\u89c9\u3001\u601d\u8003\u7684\u884c\u4e3a\u5b9e\u73b0\u3002\u8fd9\u90e8\u5206\u9700\u8981\u5b66\u751f\u6765\u5177\u4f53\u5b8c\u6210\u3002\u5b66\u751f\u9700\u8981\u638c\u63e1\u5982\u4f55\u7528\u4fe1\u53f7\u91cf\u6765\u5b9e\u73b0\u6761\u4ef6\u53d8\u91cf\uff0c\u4ee5\u53ca\u5305\u542b\u6761\u4ef6\u53d8\u91cf\u7684\u7ba1\u7a0b\u5982\u4f55\u80fd\u591f\u786e\u4fdd\u54f2\u5b66\u5bb6\u80fd\u591f\u6b63\u5e38\u601d\u8003\u548c\u5403\u996d\u3002</p>"},{"location":"lab7/monitors/","title":"\u7ba1\u7a0b","text":""},{"location":"lab7/monitors/#_1","title":"\u7ba1\u7a0b\u548c\u6761\u4ef6\u53d8\u91cf","text":""},{"location":"lab7/monitors/#_2","title":"\u539f\u7406\u56de\u987e","text":"<p>\u5f15\u5165\u4e86\u7ba1\u7a0b\u662f\u4e3a\u4e86\u5c06\u5bf9\u5171\u4eab\u8d44\u6e90\u7684\u6240\u6709\u8bbf\u95ee\u53ca\u5176\u6240\u9700\u8981\u7684\u540c\u6b65\u64cd\u4f5c\u96c6\u4e2d\u5e76\u5c01\u88c5\u8d77\u6765\u3002Hansan\u4e3a\u7ba1\u7a0b\u6240\u4e0b\u7684\u5b9a\u4e49\uff1a\u201c\u4e00\u4e2a\u7ba1\u7a0b\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u548c\u80fd\u4e3a\u5e76\u53d1\u8fdb\u7a0b\u6240\u6267\u884c\uff08\u5728\u8be5\u6570\u636e\u7ed3\u6784\u4e0a\uff09\u7684\u4e00\u7ec4\u64cd\u4f5c\uff0c\u8fd9\u7ec4\u64cd\u4f5c\u80fd\u540c\u6b65\u8fdb\u7a0b\u548c\u6539\u53d8\u7ba1\u7a0b\u4e2d\u7684\u6570\u636e\u201d\u3002\u6709\u4e0a\u8ff0\u5b9a\u4e49\u53ef\u77e5\uff0c\u7ba1\u7a0b\u7531\u56db\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u7ba1\u7a0b\u5185\u90e8\u7684\u5171\u4eab\u53d8\u91cf\uff1b</li> <li>\u7ba1\u7a0b\u5185\u90e8\u7684\u6761\u4ef6\u53d8\u91cf\uff1b</li> <li>\u7ba1\u7a0b\u5185\u90e8\u5e76\u53d1\u6267\u884c\u7684\u8fdb\u7a0b\uff1b</li> <li>\u5bf9\u5c40\u90e8\u4e8e\u7ba1\u7a0b\u5185\u90e8\u7684\u5171\u4eab\u6570\u636e\u8bbe\u7f6e\u521d\u59cb\u503c\u7684\u8bed\u53e5\u3002</li> </ul> <p>\u5c40\u9650\u5728\u7ba1\u7a0b\u4e2d\u7684\u6570\u636e\u7ed3\u6784\uff0c\u53ea\u80fd\u88ab\u5c40\u9650\u5728\u7ba1\u7a0b\u7684\u64cd\u4f5c\u8fc7\u7a0b\u6240\u8bbf\u95ee\uff0c\u4efb\u4f55\u7ba1\u7a0b\u4e4b\u5916\u7684\u64cd\u4f5c\u8fc7\u7a0b\u90fd\u4e0d\u80fd\u8bbf\u95ee\u5b83\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u5c40\u9650\u5728\u7ba1\u7a0b\u4e2d\u7684\u64cd\u4f5c\u8fc7\u7a0b\u4e5f\u4e3b\u8981\u8bbf\u95ee\u7ba1\u7a0b\u5185\u7684\u6570\u636e\u7ed3\u6784\u3002\u7531\u6b64\u53ef\u89c1\uff0c\u7ba1\u7a0b\u76f8\u5f53\u4e8e\u4e00\u4e2a\u9694\u79bb\u533a\uff0c\u5b83\u628a\u5171\u4eab\u53d8\u91cf\u548c\u5bf9\u5b83\u8fdb\u884c\u64cd\u4f5c\u7684\u82e5\u5e72\u4e2a\u8fc7\u7a0b\u56f4\u4e86\u8d77\u6765\uff0c\u6240\u6709\u8fdb\u7a0b\u8981\u8bbf\u95ee\u4e34\u754c\u8d44\u6e90\u65f6\uff0c\u90fd\u5fc5\u987b\u7ecf\u8fc7\u7ba1\u7a0b\u624d\u80fd\u8fdb\u5165\uff0c\u800c\u7ba1\u7a0b\u6bcf\u6b21\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u8fdb\u5165\u7ba1\u7a0b\uff0c\u4ece\u800c\u9700\u8981\u786e\u4fdd\u8fdb\u7a0b\u4e4b\u95f4\u4e92\u65a5\u3002</p> <p>\u4f46\u5728\u7ba1\u7a0b\u4e2d\u4ec5\u4ec5\u6709\u4e92\u65a5\u64cd\u4f5c\u662f\u4e0d\u591f\u7528\u7684\u3002\u8fdb\u7a0b\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u4e3a\u771f\u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002\u5982\u679c\u91c7\u7528\u5fd9\u7b49(busy waiting)\u65b9\u5f0f\uff1a</p> <pre><code>while not( Cond ) do {}\n</code></pre> <p>\u5728\u5355\u5904\u7406\u5668\u60c5\u51b5\u4e0b\uff0c\u5c06\u4f1a\u5bfc\u81f4\u6240\u6709\u5176\u5b83\u8fdb\u7a0b\u90fd\u65e0\u6cd5\u8fdb\u5165\u4e34\u754c\u533a\u4f7f\u5f97\u8be5\u6761\u4ef6Cond\u4e3a\u771f\uff0c\u8be5\u7ba1\u7a0b\u7684\u6267\u884c\u5c06\u4f1a\u53d1\u751f\u6b7b\u9501\u3002\u4e3a\u6b64\uff0c\u53ef\u5f15\u5165\u6761\u4ef6\u53d8\u91cf\uff08Condition Variables\uff0c\u7b80\u79f0CV\uff09\u3002\u4e00\u4e2a\u6761\u4ef6\u53d8\u91cfCV\u53ef\u7406\u89e3\u4e3a\u4e00\u4e2a\u8fdb\u7a0b\u7684\u7b49\u5f85\u961f\u5217\uff0c\u961f\u5217\u4e2d\u7684\u8fdb\u7a0b\u6b63\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u53d8\u4e3a\u771f\u3002\u6bcf\u4e2a\u6761\u4ef6\u53d8\u91cf\u5173\u8054\u7740\u4e00\u4e2a\u6761\u4ef6\uff0c\u5982\u679c\u6761\u4ef6Cond\u4e0d\u4e3a\u771f\uff0c\u5219\u8fdb\u7a0b\u9700\u8981\u7b49\u5f85\uff0c\u5982\u679c\u6761\u4ef6Cond\u4e3a\u771f\uff0c\u5219\u8fdb\u7a0b\u53ef\u4ee5\u8fdb\u4e00\u6b65\u5728\u7ba1\u7a0b\u4e2d\u6267\u884c\u3002\u9700\u8981\u6ce8\u610f\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u7b49\u5f85\u4e00\u4e2a\u6761\u4ef6\u53d8\u91cfCV\uff08\u5373\u7b49\u5f85Cond\u4e3a\u771f\uff09\uff0c\u8be5\u8fdb\u7a0b\u9700\u8981\u9000\u51fa\u7ba1\u7a0b\uff0c\u8fd9\u6837\u624d\u80fd\u8ba9\u5176\u5b83\u8fdb\u7a0b\u53ef\u4ee5\u8fdb\u5165\u8be5\u7ba1\u7a0b\u6267\u884c\uff0c\u5e76\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\uff0c\u6bd4\u5982\u8bbe\u7f6e\u6761\u4ef6Cond\u4e3a\u771f\uff0c\u6539\u53d8\u6761\u4ef6\u53d8\u91cf\u7684\u72b6\u6001\uff0c\u5e76\u5524\u9192\u7b49\u5f85\u5728\u6b64\u6761\u4ef6\u53d8\u91cfCV\u4e0a\u7684\u8fdb\u7a0b\u3002\u56e0\u6b64\u5bf9\u6761\u4ef6\u53d8\u91cfCV\u6709\u4e24\u79cd\u4e3b\u8981\u64cd\u4f5c\uff1a</p> <ul> <li>wait_cv\uff1a \u88ab\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u7528\uff0c\u4ee5\u7b49\u5f85\u65ad\u8a00Pc\u88ab\u6ee1\u8db3\u540e\u8be5\u8fdb\u7a0b\u53ef\u6062\u590d\u6267\u884c. \u8fdb\u7a0b\u6302\u5728\u8be5\u6761\u4ef6\u53d8\u91cf\u4e0a\u7b49\u5f85\u65f6\uff0c\u4e0d\u88ab\u8ba4\u4e3a\u662f\u5360\u7528\u4e86\u7ba1\u7a0b\u3002</li> <li>signal_cv\uff1a\u88ab\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u7528\uff0c\u4ee5\u6307\u51fa\u65ad\u8a00Pc\u73b0\u5728\u4e3a\u771f\uff0c\u4ece\u800c\u53ef\u4ee5\u5524\u9192\u7b49\u5f85\u65ad\u8a00Pc\u88ab\u6ee1\u8db3\u7684\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u3002</li> </ul>"},{"location":"lab7/monitors/#_3","title":"\"\u54f2\u5b66\u5bb6\u5c31\u9910\"\u5b9e\u4f8b","text":"<p>\u6709\u4e86\u4e92\u65a5\u548c\u4fe1\u53f7\u91cf\u652f\u6301\u7684\u7ba1\u7a0b\u5c31\u53ef\u7528\u7528\u4e86\u89e3\u51b3\u5404\u79cd\u540c\u6b65\u4e92\u65a5\u95ee\u9898\u3002\u6bd4\u5982\u53c2\u8003\u300aOS Concept\u300b\u4e00\u4e66\u4e2d\u76846.7.2\u5c0f\u8282\u201c\u7528\u7ba1\u7a0b\u89e3\u51b3\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u201d\u5c31\u7ed9\u51fa\u4e86\u8fd9\u6837\u7684\u4e8b\u4f8b\uff1a <pre><code>monitor dp\n{\nenum {THINKING, HUNGRY, EATING} state[5];\ncondition self[5];\n\nvoid pickup(int i) {\nstate[i] = HUNGRY;\ntest(i);\nif (state[i] != EATING)\nself[i].wait_cv();\n}\n\nvoid putdown(int i) {\nstate[i] = THINKING;\ntest((i + 4) % 5);\ntest((i + 1) % 5);\n}\n\nvoid test(int i) {\nif ((state[(i + 4) % 5] != EATING) &amp;&amp;\n(state[i] == HUNGRY) &amp;&amp;\n(state[(i + 1) % 5] != EATING)) {\nstate[i] = EATING;\nself[i].signal_cv();\n}\n}\n\ninitialization code() {\nfor (int i = 0; i &lt; 5; i++)\nstate[i] = THINKING;\n}\n}\n</code></pre></p>"},{"location":"lab7/monitors/#_4","title":"\u5173\u952e\u6570\u636e\u7ed3\u6784","text":"<p>\u867d\u7136\u5927\u90e8\u5206\u6559\u79d1\u4e66\u4e0a\u8bf4\u660e\u7ba1\u7a0b\u9002\u5408\u5728\u8bed\u8a00\u7ea7\u5b9e\u73b0\u6bd4\u5982java\u7b49\u9ad8\u7ea7\u8bed\u8a00\uff0c\u6ca1\u6709\u63d0\u53ca\u5728\u91c7\u7528C\u8bed\u8a00\u7684OS\u4e2d\u5982\u4f55\u5b9e\u73b0\u3002\u4e0b\u9762\u6211\u4eec\u5c06\u8981\u5c1d\u8bd5\u5728ucore\u4e2d\u7528C\u8bed\u8a00\u5b9e\u73b0\u91c7\u7528\u57fa\u4e8e\u4e92\u65a5\u548c\u6761\u4ef6\u53d8\u91cf\u673a\u5236\u7684\u7ba1\u7a0b\u57fa\u672c\u539f\u7406\u3002</p> <p>ucore\u4e2d\u7684\u7ba1\u7a0b\u673a\u5236\u662f\u57fa\u4e8e\u4fe1\u53f7\u91cf\u548c\u6761\u4ef6\u53d8\u91cf\u6765\u5b9e\u73b0\u7684\u3002ucore\u4e2d\u7684\u7ba1\u7a0b\u7684\u6570\u636e\u7ed3\u6784monitor_t\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>typedef struct monitor{\nsemaphore_t mutex;      // the mutex lock for going into the routines in monitor, should be initialized to 1\n// the next semaphore is used to \n//    (1) procs which call cond_signal funciton should DOWN next sema after UP cv.sema\n// OR (2) procs which call cond_wait funciton should UP next sema before DOWN cv.sema\nsemaphore_t next;        int next_count;         // the number of of sleeped procs which cond_signal funciton\ncondvar_t *cv;          // the condvars in monitor\n} monitor_t;\n</code></pre> <p>\u7ba1\u7a0b\u4e2d\u7684\u6210\u5458\u53d8\u91cfmutex\u662f\u4e00\u4e2a\u4e8c\u503c\u4fe1\u53f7\u91cf\uff0c\u662f\u5b9e\u73b0\u6bcf\u6b21\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u8fdb\u5165\u7ba1\u7a0b\u7684\u5173\u952e\u5143\u7d20\uff0c\u786e\u4fdd\u4e86\u4e92\u65a5\u8bbf\u95ee\u6027\u8d28\u3002\u7ba1\u7a0b\u4e2d\u7684\u6761\u4ef6\u53d8\u91cfcv\u901a\u8fc7\u6267\u884c<code>wait_cv</code>\uff0c\u4f1a\u4f7f\u5f97\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u4e3a\u771f\u7684\u8fdb\u7a0b\u80fd\u591f\u79bb\u5f00\u7ba1\u7a0b\u5e76\u7761\u7720\uff0c\u4e14\u8ba9\u5176\u4ed6\u8fdb\u7a0b\u8fdb\u5165\u7ba1\u7a0b\u7ee7\u7eed\u6267\u884c\uff1b\u800c\u8fdb\u5165\u7ba1\u7a0b\u7684\u67d0\u8fdb\u7a0b\u8bbe\u7f6e\u6761\u4ef6Cond\u4e3a\u771f\u5e76\u6267\u884c<code>signal_cv</code>\u65f6\uff0c\u80fd\u591f\u8ba9\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u4e3a\u771f\u7684\u7761\u7720\u8fdb\u7a0b\u88ab\u5524\u9192\uff0c\u4ece\u800c\u7ee7\u7eed\u8fdb\u5165\u7ba1\u7a0b\u4e2d\u6267\u884c\u3002</p> <p>\u6ce8\u610f\uff1a\u7ba1\u7a0b\u4e2d\u7684\u6210\u5458\u53d8\u91cf\u4fe1\u53f7\u91cfnext\u548c\u6574\u578b\u53d8\u91cfnext_count\u662f\u914d\u5408\u8fdb\u7a0b\u5bf9\u6761\u4ef6\u53d8\u91cfcv\u7684\u64cd\u4f5c\u800c\u8bbe\u7f6e\u7684\uff0c\u8fd9\u662f\u7531\u4e8e\u53d1\u51fa<code>signal_cv</code>\u7684\u8fdb\u7a0bA\u4f1a\u5524\u9192\u7531\u4e8e<code>wait_cv</code>\u800c\u7761\u7720\u7684\u8fdb\u7a0bB\uff0c\u7531\u4e8e\u7ba1\u7a0b\u4e2d\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u8fd0\u884c\uff0c\u6240\u4ee5\u8fdb\u7a0bB\u6267\u884c\u4f1a\u5bfc\u81f4\u5524\u9192\u8fdb\u7a0bB\u7684\u8fdb\u7a0bA\u7761\u7720\uff0c\u76f4\u5230\u8fdb\u7a0bB\u79bb\u5f00\u7ba1\u7a0b\uff0c\u8fdb\u7a0bA\u624d\u80fd\u7ee7\u7eed\u6267\u884c\uff0c\u8fd9\u4e2a\u540c\u6b65\u8fc7\u7a0b\u662f\u901a\u8fc7\u4fe1\u53f7\u91cfnext\u5b8c\u6210\u7684\uff1b\u800cnext_count\u8868\u793a\u4e86\u7531\u4e8e\u53d1\u51fa<code>singal_cv</code>\u800c\u7761\u7720\u7684\u8fdb\u7a0b\u4e2a\u6570\u3002</p> <p>\u7ba1\u7a0b\u4e2d\u7684\u6761\u4ef6\u53d8\u91cf\u7684\u6570\u636e\u7ed3\u6784condvar_t\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>typedef struct condvar{\nsemaphore_t sem;    // the sem semaphore is used to down the waiting proc, and the signaling proc should up the waiting proc\nint count;       \u3000  // the number of waiters on condvar\nmonitor_t * owner;  // the owner(monitor) of this condvar\n} condvar_t;\n</code></pre> <p>\u6761\u4ef6\u53d8\u91cf\u7684\u5b9a\u4e49\u4e2d\u4e5f\u5305\u542b\u4e86\u4e00\u7cfb\u5217\u7684\u6210\u5458\u53d8\u91cf\uff0c\u4fe1\u53f7\u91cfsem\u7528\u4e8e\u8ba9\u53d1\u51fa<code>wait_cv</code>\u64cd\u4f5c\u7684\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u4e3a\u771f\u7684\u8fdb\u7a0b\u7761\u7720\uff0c\u800c\u8ba9\u53d1\u51fa<code>signal_cv</code>\u64cd\u4f5c\u7684\u8fdb\u7a0b\u901a\u8fc7\u8fd9\u4e2asem\u6765\u5524\u9192\u7761\u7720\u7684\u8fdb\u7a0b\u3002count\u8868\u793a\u7b49\u5728\u8fd9\u4e2a\u6761\u4ef6\u53d8\u91cf\u4e0a\u7684\u7761\u7720\u8fdb\u7a0b\u7684\u4e2a\u6570\u3002owner\u8868\u793a\u6b64\u6761\u4ef6\u53d8\u91cf\u7684\u5bbf\u4e3b\u662f\u54ea\u4e2a\u7ba1\u7a0b\u3002</p>"},{"location":"lab7/monitors/#signalwait","title":"\u6761\u4ef6\u53d8\u91cf\u7684signal\u548cwait\u7684\u8bbe\u8ba1","text":"<p>\u7406\u89e3\u4e86\u6570\u636e\u7ed3\u6784\u7684\u542b\u4e49\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u7ba1\u7a0b\u7684\u8bbe\u8ba1\u5b9e\u73b0\u4e86\u3002ucore\u8bbe\u8ba1\u5b9e\u73b0\u4e86\u6761\u4ef6\u53d8\u91cf<code>wait_cv</code>\u64cd\u4f5c\u548c<code>signal_cv</code>\u64cd\u4f5c\u5bf9\u5e94\u7684\u5177\u4f53\u51fd\u6570\uff0c\u5373<code>cond_wait</code>\u51fd\u6570\u548c<code>cond_signal</code>\u51fd\u6570\uff0c\u6b64\u5916\u8fd8\u6709<code>cond_init</code>\u521d\u59cb\u5316\u51fd\u6570\uff08\u53ef\u76f4\u63a5\u770b\u6e90\u7801\uff09\u3002\u51fd\u6570<code>cond_wait(condvar_t *cvp, semaphore_t *mp)</code>\u548c<code>cond_signal (condvar_t *cvp)</code>\u7684\u5b9e\u73b0\u539f\u7406\u53c2\u8003\u4e86\u300aOS Concept\u300b\u4e00\u4e66\u4e2d\u76846.7.3\u5c0f\u8282\u201c\u7528\u4fe1\u53f7\u91cf\u5b9e\u73b0\u7ba1\u7a0b\u201d\u7684\u5185\u5bb9\u3002\u9996\u5148\u6765\u770b<code>wait_cv</code>\u7684\u539f\u7406\u5b9e\u73b0\uff1a</p> <p>wait_cv\u7684\u539f\u7406\u63cf\u8ff0</p> <pre><code>cv.count++;\nif(monitor.next_count &gt; 0)\nsem_signal(monitor.next);\nelse\nsem_signal(monitor.mutex);\nsem_wait(cv.sem);\ncv.count -- ;\n</code></pre> <p>\u5bf9\u7167\u7740\u53ef\u5206\u6790\u51fa<code>cond_wait</code>\u51fd\u6570\u7684\u5177\u4f53\u6267\u884c\u8fc7\u7a0b\u3002\u53ef\u4ee5\u770b\u51fa\u5982\u679c\u8fdb\u7a0bA\u6267\u884c\u4e86<code>cond_wait</code>\u51fd\u6570\uff0c\u8868\u793a\u6b64\u8fdb\u7a0b\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6Cond\u4e0d\u4e3a\u771f\uff0c\u9700\u8981\u7761\u7720\u3002\u56e0\u6b64\u8868\u793a\u7b49\u5f85\u6b64\u6761\u4ef6\u7684\u7761\u7720\u8fdb\u7a0b\u4e2a\u6570cv.count\u8981\u52a0\u4e00\u3002\u63a5\u4e0b\u6765\u4f1a\u51fa\u73b0\u4e24\u79cd\u60c5\u51b5\u3002</p> <p>\u60c5\u51b5\u4e00\uff1a\u5982\u679cmonitor.next_count\u5982\u679c\u5927\u4e8e0\uff0c\u8868\u793a\u6709\u5927\u4e8e\u7b49\u4e8e1\u4e2a\u8fdb\u7a0b\u6267\u884ccond_signal\u51fd\u6570\u4e14\u7761\u4e86\uff0c\u5c31\u7761\u5728\u4e86monitor.next\u4fe1\u53f7\u91cf\u4e0a\uff08\u5047\u5b9a\u8fd9\u4e9b\u8fdb\u7a0b\u6302\u5728monitor.next\u4fe1\u53f7\u91cf\u76f8\u5173\u7684\u7b49\u5f85\u961f\u5217\uff33\u4e0a\uff09\uff0c\u56e0\u6b64\u9700\u8981\u5524\u9192\u7b49\u5f85\u961f\u5217\uff33\u4e2d\u7684\u4e00\u4e2a\u8fdb\u7a0bB\uff1b\u7136\u540e\u8fdb\u7a0bA\u7761\u5728cv.sem\u4e0a\u3002\u5982\u679c\u8fdb\u7a0bA\u9192\u4e86\uff0c\u5219\u8ba9cv.count\u51cf\u4e00\uff0c\u8868\u793a\u7b49\u5f85\u6b64\u6761\u4ef6\u53d8\u91cf\u7684\u7761\u7720\u8fdb\u7a0b\u4e2a\u6570\u5c11\u4e86\u4e00\u4e2a\uff0c\u53ef\u7ee7\u7eed\u6267\u884c\u4e86\uff01</p> <p>\u8fd9\u91cc\u9690\u542b\u8fd9\u4e00\u4e2a\u73b0\u8c61\uff0c\u5373\u67d0\u8fdb\u7a0bA\u5728\u65f6\u95f4\u987a\u5e8f\u4e0a\u5148\u6267\u884c\u4e86<code>cond_signal</code>\uff0c\u800c\u53e6\u4e00\u4e2a\u8fdb\u7a0bB\u540e\u6267\u884c\u4e86<code>cond_wait</code>\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u8fdb\u7a0bA\u6ca1\u6709\u8d77\u5230\u5524\u9192\u8fdb\u7a0bB\u7684\u4f5c\u7528\u3002</p> <p>\u95ee\u9898: \u5728cond_wait\u6709sem_signal(mutex)\uff0c\u4f46\u6ca1\u6709\u770b\u5230\u54ea\u91cc\u6709sem_wait(mutex)\uff0c\u8fd9\u597d\u50cf\u6ca1\u6709\u6210\u5bf9\u51fa\u73b0\uff0c\u662f\u5426\u662f\u9519\u8bef\u7684\uff1f \u7b54\u6848\uff1a\u5176\u5b9e\u5728\u7ba1\u7a0b\u4e2d\u7684\u6bcf\u4e00\u4e2a\u51fd\u6570\u7684\u5165\u53e3\u5904\u4f1a\u6709wait(mutex)\uff0c\u8fd9\u6837\u4e8c\u8005\u5c31\u914d\u597d\u5bf9\u4e86\u3002</p> <p>\u60c5\u51b5\u4e8c\uff1a\u5982\u679cmonitor.next_count\u5982\u679c\u5c0f\u4e8e\u7b49\u4e8e0\uff0c\u8868\u793a\u76ee\u524d\u6ca1\u6709\u8fdb\u7a0b\u6267\u884ccond_signal\u51fd\u6570\u4e14\u7761\u7740\u4e86\uff0c\u90a3\u9700\u8981\u5524\u9192\u7684\u662f\u7531\u4e8e\u4e92\u65a5\u6761\u4ef6\u9650\u5236\u800c\u65e0\u6cd5\u8fdb\u5165\u7ba1\u7a0b\u7684\u8fdb\u7a0b\uff0c\u6240\u4ee5\u8981\u5524\u9192\u7761\u5728monitor.mutex\u4e0a\u7684\u8fdb\u7a0b\u3002\u7136\u540e\u8fdb\u7a0bA\u7761\u5728cv.sem\u4e0a\uff0c\u5982\u679c\u7761\u9192\u4e86\uff0c\u5219\u8ba9cv.count\u51cf\u4e00\uff0c\u8868\u793a\u7b49\u5f85\u6b64\u6761\u4ef6\u7684\u7761\u7720\u8fdb\u7a0b\u4e2a\u6570\u5c11\u4e86\u4e00\u4e2a\uff0c\u53ef\u7ee7\u7eed\u6267\u884c\u4e86\uff01</p> <p>\u7136\u540e\u6765\u770b<code>signal_cv</code>\u7684\u539f\u7406\u5b9e\u73b0\uff1a</p> <p>** signal_cv\u7684\u539f\u7406\u63cf\u8ff0 **</p> <pre><code>if( cv.count &gt; 0) {\nmonitor.next_count ++;\nsem_signal(cv.sem);\nsem_wait(monitor.next);\nmonitor.next_count -- ;\n}\n</code></pre> <p>\u5bf9\u7167\u7740\u53ef\u5206\u6790\u51fa<code>cond_signal</code>\u51fd\u6570\u7684\u5177\u4f53\u6267\u884c\u8fc7\u7a0b\u3002\u9996\u5148\u8fdb\u7a0bB\u5224\u65adcv.count\uff0c\u5982\u679c\u4e0d\u5927\u4e8e0\uff0c\u5219\u8868\u793a\u5f53\u524d\u6ca1\u6709\u6267\u884ccond_wait\u800c\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u56e0\u6b64\u5c31\u6ca1\u6709\u88ab\u5524\u9192\u7684\u5bf9\u8c61\u4e86\uff0c\u76f4\u63a5\u51fd\u6570\u8fd4\u56de\u5373\u53ef\uff1b\u5982\u679c\u5927\u4e8e0\uff0c\u8fd9\u8868\u793a\u5f53\u524d\u6709\u6267\u884ccond_wait\u800c\u7761\u7720\u7684\u8fdb\u7a0bA\uff0c\u56e0\u6b64\u9700\u8981\u5524\u9192\u7b49\u5f85\u5728cv.sem\u4e0a\u7761\u7720\u7684\u8fdb\u7a0bA\u3002\u7531\u4e8e\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u5728\u7ba1\u7a0b\u4e2d\u6267\u884c\uff0c\u6240\u4ee5\u4e00\u65e6\u8fdb\u7a0bB\u5524\u9192\u4e86\u522b\u4eba\uff08\u8fdb\u7a0bA\uff09\uff0c\u90a3\u4e48\u81ea\u5df1\u5c31\u9700\u8981\u7761\u7720\u3002\u6545\u8ba9monitor.next_count\u52a0\u4e00\uff0c\u4e14\u8ba9\u81ea\u5df1\uff08\u8fdb\u7a0bB\uff09\u7761\u5728\u4fe1\u53f7\u91cfmonitor.next\u4e0a\u3002\u5982\u679c\u7761\u9192\u4e86\uff0c\u8fd9\u8ba9monitor.next_count\u51cf\u4e00\u3002</p>"},{"location":"lab7/monitors/#_5","title":"\u7ba1\u7a0b\u4e2d\u51fd\u6570\u7684\u5165\u53e3\u51fa\u53e3\u8bbe\u8ba1","text":"<p>\u4e3a\u4e86\u8ba9\u6574\u4e2a\u7ba1\u7a0b\u6b63\u5e38\u8fd0\u884c\uff0c\u8fd8\u9700\u5728\u7ba1\u7a0b\u4e2d\u7684\u6bcf\u4e2a\u51fd\u6570\u7684\u5165\u53e3\u548c\u51fa\u53e3\u589e\u52a0\u76f8\u5173\u64cd\u4f5c\uff0c\u5373\uff1a</p> <pre><code>function_in_monitor \uff08\u2026\uff09\n{\nsem.wait(monitor.mutex);\n//-----------------------------\nthe real body of function;\n//-----------------------------\nif(monitor.next_count &gt; 0)\nsem_signal(monitor.next);\nelse\nsem_signal(monitor.mutex);\n} </code></pre> <p>\u8fd9\u6837\u5e26\u6765\u7684\u4f5c\u7528\u6709\u4e24\u4e2a\uff0c\uff081\uff09\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u5728\u6267\u884c\u7ba1\u7a0b\u4e2d\u7684\u51fd\u6570\u3002\uff082\uff09\u907f\u514d\u7531\u4e8e\u6267\u884c\u4e86cond_signal\u51fd\u6570\u800c\u7761\u7720\u7684\u8fdb\u7a0b\u65e0\u6cd5\u88ab\u5524\u9192\u3002\u5bf9\u4e8e\u7b2c\u4e8c\u70b9\uff0c\u5982\u679c\u8fdb\u7a0bA\u7531\u4e8e\u6267\u884c\u4e86cond_signal\u51fd\u6570\u800c\u7761\u7720\uff08\u8fd9\u4f1a\u8ba9monitor.next_count\u5927\u4e8e0\uff0c\u4e14\u6267\u884csem_wait(monitor.next)\uff09\uff0c\u5219\u5176\u4ed6\u8fdb\u7a0b\u5728\u6267\u884c\u7ba1\u7a0b\u4e2d\u7684\u51fd\u6570\u7684\u51fa\u53e3\uff0c\u4f1a\u5224\u65admonitor.next_count\u662f\u5426\u5927\u4e8e0\uff0c\u5982\u679c\u5927\u4e8e0\uff0c\u5219\u6267\u884csem_signal(monitor.next)\uff0c\u4ece\u800c\u6267\u884c\u4e86cond_signal\u51fd\u6570\u800c\u7761\u7720\u7684\u8fdb\u7a0b\u88ab\u5524\u9192\u3002\u4e0a\u8bc9\u63aa\u65bd\u5c06\u4f7f\u5f97\u7ba1\u7a0b\u6b63\u5e38\u6267\u884c\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0a\u8ff0\u53ea\u662f\u539f\u7406\u63cf\u8ff0\uff0c\u4e0e\u5177\u4f53\u63cf\u8ff0\u76f8\u6bd4\uff0c\u8fd8\u6709\u4e00\u5b9a\u7684\u5dee\u8ddd\u3002\u9700\u8981\u5927\u5bb6\u5728\u5b8c\u6210\u7ec3\u4e60\u65f6\u4ed4\u7ec6\u8bbe\u8ba1\u548c\u5b9e\u73b0\u3002</p>"},{"location":"lab7/semaphore/","title":"\u4fe1\u53f7\u91cf","text":""},{"location":"lab7/semaphore/#_1","title":"\u4fe1\u53f7\u91cf","text":"<p>\u4fe1\u53f7\u91cf\u662f\u4e00\u79cd\u540c\u6b65\u4e92\u65a5\u673a\u5236\u7684\u5b9e\u73b0\uff0c\u666e\u904d\u5b58\u5728\u4e8e\u73b0\u5728\u7684\u5404\u79cd\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u91cc\u3002\u76f8\u5bf9\u4e8espinlock \u7684\u5e94\u7528\u5bf9\u8c61\uff0c\u4fe1\u53f7\u91cf\u7684\u5e94\u7528\u5bf9\u8c61\u662f\u5728\u4e34\u754c\u533a\u4e2d\u8fd0\u884c\u7684\u65f6\u95f4\u8f83\u957f\u7684\u8fdb\u7a0b\u3002\u7b49\u5f85\u4fe1\u53f7\u91cf\u7684\u8fdb\u7a0b\u9700\u8981\u7761\u7720\u6765\u51cf\u5c11\u5360\u7528 CPU \u7684\u5f00\u9500\u3002\u53c2\u8003\u6559\u79d1\u4e66\u201cOperating Systems Internals and Design Principles\u201d\u7b2c\u4e94\u7ae0\u201c\u540c\u6b65\u4e92\u65a5\u201d\u4e2d\u5bf9\u4fe1\u53f7\u91cf\u5b9e\u73b0\u7684\u539f\u7406\u6027\u63cf\u8ff0\uff1a</p> <pre><code>struct semaphore {\nint count;\nqueueType queue;\n};\nvoid semWait(semaphore s)\n{\ns.count--;\nif (s.count &lt; 0) {\n/* place this process in s.queue */;\n/* block this process */;\n}\n}\nvoid semSignal(semaphore s)\n{\ns.count++;\nif (s.count&lt;= 0) {\n/* remove a process P from s.queue */;\n/* place process P on ready list */;\n}\n}\n</code></pre> <p>\u57fa\u4e8e\u4e0a\u8bc9\u4fe1\u53f7\u91cf\u5b9e\u73b0\u53ef\u4ee5\u8ba4\u4e3a\uff0c\u5f53\u591a\u4e2a\uff08&gt;1\uff09\u8fdb\u7a0b\u53ef\u4ee5\u8fdb\u884c\u4e92\u65a5\u6216\u540c\u6b65\u5408\u4f5c\u65f6\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u4f1a\u7531\u4e8e\u65e0\u6cd5\u6ee1\u8db3\u4fe1\u53f7\u91cf\u8bbe\u7f6e\u7684\u67d0\u6761\u4ef6\u800c\u5728\u67d0\u4e00\u4f4d\u7f6e\u505c\u6b62\uff0c\u76f4\u5230\u5b83\u63a5\u6536\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u4fe1\u53f7\uff08\u8868\u660e\u6761\u4ef6\u6ee1\u8db3\u4e86\uff09\u3002\u4e3a\u4e86\u53d1\u4fe1\u53f7\uff0c\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u79f0\u4f5c\u4fe1\u53f7\u91cf\u7684\u7279\u6b8a\u53d8\u91cf\u3002\u4e3a\u901a\u8fc7\u4fe1\u53f7\u91cfs\u4f20\u9001\u4fe1\u53f7\uff0c\u4fe1\u53f7\u91cf\u7684V\u64cd\u4f5c\u91c7\u7528\u8fdb\u7a0b\u53ef\u6267\u884c\u539f\u8bedsemSignal(s)\uff1b\u4e3a\u901a\u8fc7\u4fe1\u53f7\u91cfs\u63a5\u6536\u4fe1\u53f7\uff0c\u4fe1\u53f7\u91cf\u7684P\u64cd\u4f5c\u91c7\u7528\u8fdb\u7a0b\u53ef\u6267\u884c\u539f\u8bedsemWait(s)\uff1b\u5982\u679c\u76f8\u5e94\u7684\u4fe1\u53f7\u4ecd\u7136\u6ca1\u6709\u53d1\u9001\uff0c\u5219\u8fdb\u7a0b\u88ab\u963b\u585e\u6216\u7761\u7720\uff0c\u76f4\u5230\u53d1\u9001\u5b8c\u4e3a\u6b62\u3002</p> <p>ucore\u4e2d\u4fe1\u53f7\u91cf\u53c2\u7167\u4e0a\u8ff0\u539f\u7406\u63cf\u8ff0\uff0c\u5efa\u7acb\u5728\u5f00\u5173\u4e2d\u65ad\u673a\u5236\u548cwait_queue\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u4e86\u5177\u4f53\u5b9e\u73b0\u3002\u4fe1\u53f7\u91cf\u7684\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>typedef struct {\nint value;                   //\u4fe1\u53f7\u91cf\u7684\u5f53\u524d\u503c\nwait_queue_t wait_queue;     //\u4fe1\u53f7\u91cf\u5bf9\u5e94\u7684\u7b49\u5f85\u961f\u5217\n} semaphore_t;\n</code></pre> <p>semaphore_t\u662f\u6700\u57fa\u672c\u7684\u8bb0\u5f55\u578b\u4fe1\u53f7\u91cf\uff08record semaphore)\u7ed3\u6784\uff0c\u5305\u542b\u4e86\u7528\u4e8e\u8ba1\u6570\u7684\u6574\u6570\u503cvalue\uff0c\u548c\u4e00\u4e2a\u8fdb\u7a0b\u7b49\u5f85\u961f\u5217wait_queue\uff0c\u4e00\u4e2a\u7b49\u5f85\u7684\u8fdb\u7a0b\u4f1a\u6302\u5728\u6b64\u7b49\u5f85\u961f\u5217\u4e0a\u3002</p> <p>\u5728ucore\u4e2d\u6700\u91cd\u8981\u7684\u4fe1\u53f7\u91cf\u64cd\u4f5c\u662fP\u64cd\u4f5c\u51fd\u6570down(semaphore_t *sem)\u548cV\u64cd\u4f5c\u51fd\u6570 up(semaphore_t *sem)\u3002\u4f46\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\u662f__down(semaphore_t *sem, uint32_t wait_state) \u51fd\u6570\u548c__up(semaphore_t *sem, uint32_t wait_state)\u51fd\u6570\uff0c\u4e8c\u8005\u7684\u5177\u4f53\u5b9e\u73b0\u63cf\u8ff0\u5982\u4e0b\uff1a</p> <p>\u25cf __down(semaphore_t *sem, uint32_t wait_state, timer_t *timer)\uff1a\u5177\u4f53\u5b9e\u73b0\u4fe1\u53f7\u91cf\u7684P\u64cd\u4f5c\uff0c\u9996\u5148\u5173\u6389\u4e2d\u65ad\uff0c\u7136\u540e\u5224\u65ad\u5f53\u524d\u4fe1\u53f7\u91cf\u7684value\u662f\u5426\u5927\u4e8e0\u3002\u5982\u679c\u662f&gt;0\uff0c\u5219\u8868\u660e\u53ef\u4ee5\u83b7\u5f97\u4fe1\u53f7\u91cf\uff0c\u6545\u8ba9value\u51cf\u4e00\uff0c\u5e76\u6253\u5f00\u4e2d\u65ad\u8fd4\u56de\u5373\u53ef\uff1b\u5982\u679c\u4e0d\u662f&gt;0\uff0c\u5219\u8868\u660e\u65e0\u6cd5\u83b7\u5f97\u4fe1\u53f7\u91cf\uff0c\u6545\u9700\u8981\u5c06\u5f53\u524d\u7684\u8fdb\u7a0b\u52a0\u5165\u5230\u7b49\u5f85\u961f\u5217\u4e2d\uff0c\u5e76\u6253\u5f00\u4e2d\u65ad\uff0c\u7136\u540e\u8fd0\u884c\u8c03\u5ea6\u5668\u9009\u62e9\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u3002\u5982\u679c\u88abV\u64cd\u4f5c\u5524\u9192\uff0c\u5219\u628a\u81ea\u8eab\u5173\u8054\u7684wait\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u5220\u9664\uff08\u6b64\u8fc7\u7a0b\u9700\u8981\u5148\u5173\u4e2d\u65ad\uff0c\u5b8c\u6210\u540e\u5f00\u4e2d\u65ad\uff09\u3002\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>static __noinline uint32_t __down(semaphore_t *sem, uint32_t wait_state) {\nbool intr_flag;\nlocal_intr_save(intr_flag);\nif (sem-&gt;value &gt; 0) {\nsem-&gt;value --;\nlocal_intr_restore(intr_flag);\nreturn 0;\n}\nwait_t __wait, *wait = &amp;__wait;\nwait_current_set(&amp;(sem-&gt;wait_queue), wait, wait_state);\nlocal_intr_restore(intr_flag);\n\nschedule();\n\nlocal_intr_save(intr_flag);\nwait_current_del(&amp;(sem-&gt;wait_queue), wait);\nlocal_intr_restore(intr_flag);\n\nif (wait-&gt;wakeup_flags != wait_state) {\nreturn wait-&gt;wakeup_flags;\n}\nreturn 0;\n}\n</code></pre> <p>\u4e0e<code>__down</code>\u76f8\u5173\u7684\u8c03\u7528\u548c\u88ab\u8c03\u7528\u51fd\u6570\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u25cf __up(semaphore_t *sem, uint32_t wait_state)\uff1a\u5177\u4f53\u5b9e\u73b0\u4fe1\u53f7\u91cf\u7684V\u64cd\u4f5c\uff0c\u9996\u5148\u5173\u4e2d\u65ad\uff0c\u5982\u679c\u4fe1\u53f7\u91cf\u5bf9\u5e94\u7684wait queue\u4e2d\u6ca1\u6709\u8fdb\u7a0b\u5728\u7b49\u5f85\uff0c\u76f4\u63a5\u628a\u4fe1\u53f7\u91cf\u7684value\u52a0\u4e00\uff0c\u7136\u540e\u5f00\u4e2d\u65ad\u8fd4\u56de\uff1b\u5982\u679c\u6709\u8fdb\u7a0b\u5728\u7b49\u5f85\u4e14\u8fdb\u7a0b\u7b49\u5f85\u7684\u539f\u56e0\u662fsemophore\u8bbe\u7f6e\u7684\uff0c\u5219\u8c03\u7528wakeup_wait\u51fd\u6570\u5c06waitqueue\u4e2d\u7b49\u5f85\u7684\u7b2c\u4e00\u4e2await\u5220\u9664\uff0c\u4e14\u628a\u6b64wait\u5173\u8054\u7684\u8fdb\u7a0b\u5524\u9192\uff0c\u6700\u540e\u5f00\u4e2d\u65ad\u8fd4\u56de\u3002\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>static __noinline void __up(semaphore_t *sem, uint32_t wait_state) {\nbool intr_flag;\nlocal_intr_save(intr_flag);\n{\nwait_t *wait;\nif ((wait = wait_queue_first(&amp;(sem-&gt;wait_queue))) == NULL) {\nsem-&gt;value ++;\n}\nelse {\nwakeup_wait(&amp;(sem-&gt;wait_queue), wait, wait_state, 1);\n}\n}\nlocal_intr_restore(intr_flag);\n}\n</code></pre> <p>\u4e0e<code>__up</code>\u76f8\u5173\u7684\u8c03\u7528\u548c\u88ab\u8c03\u7528\u51fd\u6570\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5bf9\u7167\u4fe1\u53f7\u91cf\u7684\u539f\u7406\u6027\u63cf\u8ff0\u548c\u5177\u4f53\u5b9e\u73b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e8c\u8005\u5728\u6d41\u7a0b\u4e0a\u57fa\u672c\u4e00\u81f4\uff0c\u53ea\u662f\u5177\u4f53\u5b9e\u73b0\u91c7\u7528\u4e86\u5173\u4e2d\u65ad\u7684\u65b9\u5f0f\u4fdd\u8bc1\u4e86\u5bf9\u5171\u4eab\u8d44\u6e90\u7684\u4e92\u65a5\u8bbf\u95ee\uff0c\u901a\u8fc7\u7b49\u5f85\u961f\u5217\u8ba9\u65e0\u6cd5\u83b7\u5f97\u4fe1\u53f7\u91cf\u7684\u8fdb\u7a0b\u7761\u7720\u7b49\u5f85\u3002\u53e6\u5916\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u4fe1\u53f7\u91cf\u7684\u8ba1\u6570\u5668value\u5177\u6709\u6709\u5982\u4e0b\u6027\u8d28\uff1a</p> <ul> <li>value&gt;0\uff0c\u8868\u793a\u5171\u4eab\u8d44\u6e90\u7684\u7a7a\u95f2\u6570</li> <li>vlaue&lt;0\uff0c\u8868\u793a\u8be5\u4fe1\u53f7\u91cf\u7684\u7b49\u5f85\u961f\u5217\u91cc\u7684\u8fdb\u7a0b\u6570</li> <li>value=0\uff0c\u8868\u793a\u7b49\u5f85\u961f\u5217\u4e3a\u7a7a</li> </ul>"},{"location":"lab7/sync/","title":"\u540c\u6b65\u4e92\u65a5\u7684\u5e95\u5c42\u652f\u6491","text":""},{"location":"lab7/sync/#_1","title":"\u540c\u6b65\u4e92\u65a5\u7684\u5e95\u5c42\u652f\u6491","text":"<p>\u7531\u4e8e\u6709\u5904\u7406\u5668\u8c03\u5ea6\u7684\u5b58\u5728\uff0c\u4e14\u8fdb\u7a0b\u5728\u8bbf\u95ee\u67d0\u7c7b\u8d44\u6e90\u6682\u65f6\u65e0\u6cd5\u6ee1\u8db3\u7684\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u4f1a\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002\u8fd9\u5bfc\u81f4\u4e86\u591a\u8fdb\u7a0b\u6267\u884c\u65f6\u5e8f\u7684\u4e0d\u786e\u5b9a\u6027\u548c\u6f5c\u5728\u6267\u884c\u7ed3\u679c\u7684\u4e0d\u786e\u5b9a\u6027\u3002\u4e3a\u4e86\u786e\u4fdd\u6267\u884c\u7ed3\u679c\u7684\u6b63\u786e\u6027\uff0c\u672c\u8bd5\u9a8c\u9700\u8981\u8bbe\u8ba1\u66f4\u52a0\u5b8c\u5584\u7684\u8fdb\u7a0b\u7b49\u5f85\u548c\u4e92\u65a5\u7684\u5e95\u5c42\u652f\u6491\u673a\u5236\uff0c\u786e\u4fdd\u80fd\u6b63\u786e\u63d0\u4f9b\u57fa\u4e8e\u4fe1\u53f7\u91cf\u548c\u6761\u4ef6\u53d8\u91cf\u7684\u540c\u6b65\u4e92\u65a5\u673a\u5236\u3002</p> <p>\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u7684\u77e5\u8bc6\uff0c\u6211\u4eec\u77e5\u9053\u5982\u679c\u6ca1\u6709\u5728\u786c\u4ef6\u7ea7\u4fdd\u8bc1\u8bfb\u5185\u5b58-\u4fee\u6539\u503c-\u5199\u56de\u5185\u5b58\u7684\u539f\u5b50\u6027\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7\u590d\u6742\u7684\u8f6f\u4ef6\u6765\u5b9e\u73b0\u540c\u6b65\u4e92\u65a5\u64cd\u4f5c\u3002\u4f46\u7531\u4e8e\u6709\u5b9a\u65f6\u5668\u3001\u5c4f\u853d/\u4f7f\u80fd\u4e2d\u65ad\u3001\u7b49\u5f85\u961f\u5217wait_queue\u652f\u6301test_and_set_bit\u7b49\u539f\u5b50\u64cd\u4f5c\u673a\u5668\u6307\u4ee4\uff08\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u7528\u5230\uff09\u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u6211\u4eec\u5728\u5b9e\u73b0\u8fdb\u7a0b\u7b49\u5f85\u3001\u540c\u6b65\u4e92\u65a5\u4e0a\u5f97\u5230\u4e86\u6781\u5927\u7684\u7b80\u5316\u3002\u4e0b\u9762\u5c06\u5bf9\u5b9a\u65f6\u5668\u3001\u5c4f\u853d/\u4f7f\u80fd\u4e2d\u65ad\u548c\u7b49\u5f85\u961f\u5217\u8fdb\u884c\u8fdb\u4e00\u6b65\u8bb2\u89e3\u3002</p>"},{"location":"lab7/sync/#_2","title":"\u5b9a\u65f6\u5668","text":"<p>\u5728\u4f20\u7edf\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u5b9a\u65f6\u5668\u662f\u5176\u4e2d\u4e00\u4e2a\u57fa\u7840\u800c\u91cd\u8981\u7684\u529f\u80fd.\u5b83\u63d0\u4f9b\u4e86\u57fa\u4e8e\u65f6\u95f4\u4e8b\u4ef6\u7684\u8c03\u5ea6\u673a\u5236\u3002\u5728ucore \u4e2d\uff0c\u65f6\u949f\uff08timer\uff09\u4e2d\u65ad\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u6709\u4e00\u5b9a\u95f4\u9694\u7684\u65f6\u95f4\u4e8b\u4ef6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u5176\u4f5c\u4e3a\u57fa\u672c\u7684\u8c03\u5ea6\u548c\u8ba1\u65f6\u5355\u4f4d\uff08\u6211\u4eec\u8bb0\u4e24\u6b21\u65f6\u95f4\u4e2d\u65ad\u4e4b\u95f4\u7684\u65f6\u95f4\u95f4\u9694\u4e3a\u4e00\u4e2a\u65f6\u95f4\u7247\uff0ctimer splice\uff09\u3002</p> <p>\u57fa\u4e8e\u6b64\u65f6\u95f4\u5355\u4f4d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5f97\u4ee5\u5411\u4e0a\u63d0\u4f9b\u57fa\u4e8e\u65f6\u95f4\u70b9\u7684\u4e8b\u4ef6\uff0c\u5e76\u5b9e\u73b0\u57fa\u4e8e\u65f6\u95f4\u957f\u5ea6\u7684\u7761\u7720\u7b49\u5f85\u548c\u5524\u9192\u673a\u5236\u3002\u5728\u6bcf\u4e2a\u65f6\u949f\u4e2d\u65ad\u53d1\u751f\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4ea7\u751f\u5bf9\u5e94\u7684\u65f6\u95f4\u4e8b\u4ef6\u3002\u5e94\u7528\u7a0b\u5e8f\u6216\u8005\u64cd\u4f5c\u7cfb\u7edf\u7684\u5176\u4ed6\u7ec4\u4ef6\u53ef\u4ee5\u4ee5\u6b64\u6765\u6784\u5efa\u66f4\u590d\u6742\u548c\u9ad8\u7ea7\u7684\u8fdb\u7a0b\u7ba1\u7406\u548c\u8c03\u5ea6\u7b97\u6cd5\u3002</p> <ul> <li>sched.h, sched.c \u5b9a\u4e49\u4e86\u6709\u5173timer\u7684\u5404\u79cd\u76f8\u5173\u63a5\u53e3\u6765\u4f7f\u7528 timer \u670d\u52a1\uff0c\u5176\u4e2d\u4e3b\u8981\u5305\u62ec:</li> <li>typedef struct {\u2026\u2026} timer_t: \u5b9a\u4e49\u4e86 timer_t \u7684\u57fa\u672c\u7ed3\u6784\uff0c\u5176\u53ef\u4ee5\u7528 sched.h \u4e2d\u7684timer_init\u51fd\u6570\u5bf9\u5176\u8fdb\u884c\u521d\u59cb\u5316\u3002</li> <li>void timer_init(timer t *timer, struct proc_struct *proc, int expires): \u5bf9\u67d0\u5b9a\u65f6\u5668 \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u8ba9\u5b83\u5728 expires \u65f6\u95f4\u7247\u4e4b\u540e\u5524\u9192 proc \u8fdb\u7a0b\u3002</li> <li>void add_timer(timer t *timer): \u5411\u7cfb\u7edf\u6dfb\u52a0\u67d0\u4e2a\u521d\u59cb\u5316\u8fc7\u7684timer_t\uff0c\u8be5\u5b9a\u65f6\u5668\u5728 \u6307\u5b9a\u65f6\u95f4\u540e\u88ab\u6fc0\u6d3b\uff0c\u5e76\u5c06\u5bf9\u5e94\u7684\u8fdb\u7a0b\u5524\u9192\u81f3runnable\uff08\u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u5904\u5728\u7b49\u5f85\u72b6\u6001\uff09\u3002</li> <li>void del_timer(timer_t *time): \u5411\u7cfb\u7edf\u5220\u9664\uff08\u6216\u8005\u8bf4\u53d6\u6d88\uff09\u67d0\u4e00\u4e2a\u5b9a\u65f6\u5668\u3002\u8be5\u5b9a\u65f6\u5668\u5728\u53d6\u6d88\u540e\u4e0d\u4f1a\u88ab\u7cfb\u7edf\u6fc0\u6d3b\u5e76\u5524\u9192\u8fdb\u7a0b\u3002</li> <li>void run_timer_list(void): \u66f4\u65b0\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u70b9\uff0c\u904d\u5386\u5f53\u524d\u6240\u6709\u5904\u5728\u7cfb\u7edf\u7ba1\u7406\u5185\u7684\u5b9a\u65f6\u5668\uff0c\u627e\u51fa\u6240\u6709\u5e94\u8be5\u6fc0\u6d3b\u7684\u8ba1\u6570\u5668\uff0c\u5e76\u6fc0\u6d3b\u5b83\u4eec\u3002\u8be5\u8fc7\u7a0b\u5728\u4e14\u53ea\u5728\u6bcf\u6b21\u5b9a\u65f6\u5668\u4e2d\u65ad\u65f6\u88ab\u8c03\u7528\u3002\u5728ucore \u4e2d\uff0c\u5176\u8fd8\u4f1a\u8c03\u7528\u8c03\u5ea6\u5668\u4e8b\u4ef6\u5904\u7406\u7a0b\u5e8f\u3002</li> </ul> <p>\u4e00\u4e2a timer_t \u5728\u7cfb\u7edf\u4e2d\u7684\u5b58\u6d3b\u5468\u671f\u53ef\u4ee5\u88ab\u63cf\u8ff0\u5982\u4e0b\uff1a</p> <ol> <li>timer_t \u5728\u67d0\u4e2a\u4f4d\u7f6e\u88ab\u521b\u5efa\u548c\u521d\u59cb\u5316\uff0c\u5e76\u901a\u8fc7 add_timer\u52a0\u5165\u7cfb\u7edf\u7ba1\u7406\u5217\u8868\u4e2d</li> <li>\u7cfb\u7edf\u65f6\u95f4\u88ab\u4e0d\u65ad\u7d2f\u52a0\uff0c\u76f4\u5230 run_timer_list \u53d1\u73b0\u8be5 timer_t\u5230\u671f\u3002</li> <li>run_timer_list\u66f4\u6539\u5bf9\u5e94\u7684\u8fdb\u7a0b\u72b6\u6001\uff0c\u5e76\u4ece\u7cfb\u7edf\u7ba1\u7406\u5217\u8868\u4e2d\u79fb\u9664\u8be5timer_t\u3002</li> </ol> <p>\u5c3d\u7ba1\u672c\u6b21\u5b9e\u9a8c\u5e76\u4e0d\u9700\u8981\u586b\u5145\u5b9a\u65f6\u5668\u76f8\u5173\u7684\u4ee3\u7801\uff0c\u4f46\u662f\u4f5c\u4e3a\u7cfb\u7edf\u91cd\u8981\u7684\u7ec4\u4ef6\uff08\u540c\u65f6\u5b9a\u65f6\u5668\u4e5f\u662f\u8c03\u5ea6\u5668\u7684\u4e00\u4e2a\u90e8\u5206\uff09\uff0c\u4f60\u5e94\u8be5\u4e86\u89e3\u5176\u76f8\u5173\u673a\u5236\u548c\u5728ucore\u4e2d\u7684\u5b9e\u73b0\u65b9\u6cd5\u548c\u4f7f\u7528\u65b9\u6cd5\u3002\u4e14\u5728trap_dispatch\u51fd\u6570\u4e2d\u4fee\u6539\u4e4b\u524d\u5bf9\u65f6\u949f\u4e2d\u65ad\u7684\u5904\u7406\uff0c\u4f7f\u5f97ucore\u80fd\u591f\u5229\u7528\u5b9a\u65f6\u5668\u63d0\u4f9b\u7684\u529f\u80fd\u5b8c\u6210\u8c03\u5ea6\u548c\u7761\u7720\u5524\u9192\u7b49\u64cd\u4f5c\u3002</p>"},{"location":"lab7/sync/#_3","title":"\u5c4f\u853d\u4e0e\u4f7f\u80fd\u4e2d\u65ad","text":"<p>\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u7684\u77e5\u8bc6\uff0c\u6211\u4eec\u77e5\u9053\u5982\u679c\u6ca1\u6709\u5728\u786c\u4ef6\u7ea7\u4fdd\u8bc1\u8bfb\u5185\u5b58-\u4fee\u6539\u503c-\u5199\u56de\u5185\u5b58\u7684\u539f\u5b50\u6027\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7\u590d\u6742\u7684\u8f6f\u4ef6\u6765\u5b9e\u73b0\u540c\u6b65\u4e92\u65a5\u64cd\u4f5c\uff0c\u800c\u5728\u5185\u6838\u4e2d\uff0c\u6211\u4eec\u5fc5\u987b\u4fdd\u8bc1\u4e34\u754c\u533a\u7684\u5185\u5b58\u4fee\u6539\u4e0d\u4f1a\u88ab\u4e2d\u65ad\u6253\u65ad\uff0c\u56e0\u6b64\u9700\u8981\u64cd\u4f5c\u5c4f\u853d\u4e0e\u4f7f\u80fd\u4e2d\u65ad\u3002</p> <p>\u5728ucore\u4e2d\u63d0\u4f9b\u7684\u5e95\u5c42\u673a\u5236\u5305\u62ec\u4e2d\u65ad\u5c4f\u853d/\u4f7f\u80fd\u63a7\u5236\u7b49\u3002kern/sync.c\u4e2d\u5b9e\u73b0\u7684\u5f00\u5173\u4e2d\u65ad\u7684\u63a7\u5236\u51fd\u6570local_intr_save(x)\u548clocal_intr_restore(x)\uff0c\u5b83\u4eec\u662f\u57fa\u4e8ekern/driver\u6587\u4ef6\u4e0b\u7684intr_enable()\u3001intr_disable()\u51fd\u6570\u5b9e\u73b0\u7684\u3002\u5177\u4f53\u8c03\u7528\u5173\u7cfb\u4e3a\uff1a</p> <pre><code>\u5173\u4e2d\u65ad\uff1alocal_intr_save --&gt; __intr_save --&gt; intr_disable --&gt; __lcsr_csrxchg(LISA_CSR_CRMD_IE, LISA_CSR_CRMD_IE, LISA_CSR_CRMD)\n\u5f00\u4e2d\u65ad\uff1alocal_intr_restore--&gt; __intr_restore --&gt; intr_enable --&gt; __lcsr_csrxchg(0, LISA_CSR_CRMD_IE, LISA_CSR_CRMD)\n</code></pre> <p>\u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u4e2d\u65ad\u7684\u5f00\u5173\u662f\u901a\u8fc7\u4fee\u6539CSR.CRMD\u5bc4\u5b58\u5668\u4e2d\u7684IE\u4f4d\u6765\u5b9e\u73b0\u7684\uff0c\u6700\u7ec8\u5b9e\u73b0\u4e86\u5173\uff08\u5c4f\u853d\uff09\u4e2d\u65ad\u548c\u5f00\uff08\u4f7f\u80fd\uff09\u4e2d\u65ad\u3002\u901a\u8fc7\u5173\u95ed\u4e2d\u65ad\uff0c\u53ef\u4ee5\u9632\u6b62\u5bf9\u5f53\u524d\u6267\u884c\u7684\u63a7\u5236\u6d41\u88ab\u5176\u4ed6\u4e2d\u65ad\u4e8b\u4ef6\u5904\u7406\u6240\u6253\u65ad\u3002\u65e2\u7136\u4e0d\u80fd\u4e2d\u65ad\uff0c\u90a3\u4e5f\u5c31\u610f\u5473\u7740\u5728\u5185\u6838\u8fd0\u884c\u7684\u5f53\u524d\u8fdb\u7a0b\u65e0\u6cd5\u88ab\u6253\u65ad\u6216\u88ab\u91cd\u65b0\u8c03\u5ea6\uff0c\u5373\u5b9e\u73b0\u4e86\u5bf9\u4e34\u754c\u533a\u7684\u4e92\u65a5\u64cd\u4f5c\u3002\u6240\u4ee5\u5728\u5355\u5904\u7406\u5668\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7\u5f00\u5173\u4e2d\u65ad\u5b9e\u73b0\u5bf9\u4e34\u754c\u533a\u7684\u4e92\u65a5\u4fdd\u62a4\uff0c\u9700\u8981\u4e92\u65a5\u7684\u4e34\u754c\u533a\u4ee3\u7801\u7684\u4e00\u822c\u5199\u6cd5\u4e3a\uff1a</p> <pre><code>local_intr_save(intr_flag);\n{\n\u4e34\u754c\u533a\u4ee3\u7801\n}\nlocal_intr_restore(intr_flag);\n\u2026\u2026\n</code></pre> <p>\u7531\u4e8e\u76ee\u524ducore\u53ea\u5b9e\u73b0\u4e86\u5bf9\u5355\u5904\u7406\u5668\u7684\u652f\u6301\uff0c\u6240\u4ee5\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u5c31\u53ef\u7b80\u5355\u5730\u652f\u6491\u4e92\u65a5\u64cd\u4f5c\u4e86\u3002\u5728\u591a\u5904\u7406\u5668\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u65b9\u6cd5\u662f\u65e0\u6cd5\u5b9e\u73b0\u4e92\u65a5\u7684\uff0c\u56e0\u4e3a\u5c4f\u853d\u4e86\u4e00\u4e2aCPU\u7684\u4e2d\u65ad\uff0c\u53ea\u80fd\u963b\u6b62\u672c\u5730CPU\u4e0a\u7684\u8fdb\u7a0b\u4e0d\u4f1a\u88ab\u4e2d\u65ad\u6216\u8c03\u5ea6\uff0c\u5e76\u4e0d\u610f\u5473\u7740\u5176\u4ed6CPU\u4e0a\u6267\u884c\u7684\u8fdb\u7a0b\u4e0d\u80fd\u6267\u884c\u4e34\u754c\u533a\u7684\u4ee3\u7801\u3002\u6240\u4ee5\uff0c\u5f00\u5173\u4e2d\u65ad\u53ea\u5bf9\u5355\u5904\u7406\u5668\u4e0b\u7684\u4e92\u65a5\u64cd\u4f5c\u8d77\u4f5c\u7528\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u5f00\u5173\u4e2d\u65ad\u673a\u5236\u662f\u5b9e\u73b0\u4fe1\u53f7\u91cf\u7b49\u9ad8\u5c42\u540c\u6b65\u4e92\u65a5\u539f\u8bed\u7684\u5e95\u5c42\u652f\u6491\u57fa\u7840\u4e4b\u4e00\u3002</p>"},{"location":"lab7/sync/#_4","title":"\u7b49\u5f85\u961f\u5217","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\uff0c\u7528\u6237\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\u8fd8\u6ca1\u6709\u7761\u7720\u7684\u652f\u6301\u673a\u5236\u3002\u5728\u8bfe\u7a0b\u4e2d\u63d0\u5230\u7528\u6237\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\u53ef\u4ee5\u8f6c\u5165\u7b49\u5f85\u72b6\u6001\u4ee5\u7b49\u5f85\u67d0\u4e2a\u7279\u5b9a\u4e8b\u4ef6\uff08\u6bd4\u5982\u7761\u7720,\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f,\u7b49\u5f85\u4fe1\u53f7\u91cf\u7b49\uff09\uff0c\u5f53\u8be5\u4e8b\u4ef6\u53d1\u751f\u65f6\u8fd9\u4e9b\u8fdb\u7a0b\u80fd\u591f\u88ab\u518d\u6b21\u5524\u9192\u3002\u5185\u6838\u5b9e\u73b0\u8fd9\u4e00\u529f\u80fd\u7684\u4e00\u4e2a\u5e95\u5c42\u652f\u6491\u673a\u5236\u5c31\u662f\u7b49\u5f85\u961f\u5217wait_queue\uff0c\u7b49\u5f85\u961f\u5217\u548c\u6bcf\u4e00\u4e2a\u4e8b\u4ef6\uff08\u7761\u7720\u7ed3\u675f\u3001\u65f6\u949f\u5230\u8fbe\u3001\u4efb\u52a1\u5b8c\u6210\u3001\u8d44\u6e90\u53ef\u7528\u7b49\uff09\u8054\u7cfb\u8d77\u6765\u3002\u9700\u8981\u7b49\u5f85\u4e8b\u4ef6\u7684\u8fdb\u7a0b\u5728\u8f6c\u5165\u4f11\u7720\u72b6\u6001\u540e\u63d2\u5165\u5230\u7b49\u5f85\u961f\u5217\u4e2d\u3002\u5f53\u4e8b\u4ef6\u53d1\u751f\u4e4b\u540e\uff0c\u5185\u6838\u904d\u5386\u76f8\u5e94\u7b49\u5f85\u961f\u5217\uff0c\u5524\u9192\u4f11\u7720\u7684\u7528\u6237\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\uff0c\u5e76\u8bbe\u7f6e\u5176\u72b6\u6001\u4e3a\u5c31\u7eea\u72b6\u6001\uff08PROC_RUNNABLE\uff09\uff0c\u5e76\u5c06\u8be5\u8fdb\u7a0b\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u6e05\u9664\u3002ucore\u5728kern/sync/{ wait.h, wait.c }\u4e2d\u5b9e\u73b0\u4e86\u7b49\u5f85\u9879wait\u7ed3\u6784\u548c\u7b49\u5f85\u961f\u5217wait queue\u7ed3\u6784\u4ee5\u53ca\u76f8\u5173\u51fd\u6570\uff09\uff0c\u8fd9\u662f\u5b9e\u73b0ucore\u4e2d\u7684\u4fe1\u53f7\u91cf\u673a\u5236\u548c\u6761\u4ef6\u53d8\u91cf\u673a\u5236\u7684\u57fa\u7840\uff0c\u8fdb\u5165wait queue\u7684\u8fdb\u7a0b\u4f1a\u88ab\u8bbe\u4e3a\u7b49\u5f85\u72b6\u6001\uff08PROC_SLEEPING\uff09\uff0c\u76f4\u5230\u4ed6\u4eec\u88ab\u5524\u9192\u3002</p>"},{"location":"lab7/sync/#_5","title":"\u6570\u636e\u7ed3\u6784\u5b9a\u4e49","text":"<pre><code>typedef  struct {\n    struct proc_struct *proc;     //\u7b49\u5f85\u8fdb\u7a0b\u7684\u6307\u9488\n    uint32_t wakeup_flags;        //\u8fdb\u7a0b\u88ab\u653e\u5165\u7b49\u5f85\u961f\u5217\u7684\u539f\u56e0\u6807\u8bb0\n    wait_queue_t *wait_queue;     //\u6307\u5411\u6b64wait\u7ed3\u6784\u6240\u5c5e\u4e8e\u7684wait_queue\n    list_entry_t wait_link;       //\u7528\u6765\u7ec4\u7ec7wait_queue\u4e2dwait\u8282\u70b9\u7684\u8fde\u63a5\n} wait_t;\n\ntypedef struct {\n    list_entry_t wait_head;       //wait_queue\u7684\u961f\u5934\n} wait_queue_t;\n\nle2wait(le, member)               //\u5b9e\u73b0wait_t\u4e2d\u6210\u5458\u7684\u6307\u9488\u5411wait_t \u6307\u9488\u7684\u8f6c\u5316\n</code></pre>"},{"location":"lab7/sync/#_6","title":"\u76f8\u5173\u51fd\u6570\u8bf4\u660e","text":"<p>\u4e0ewait\u548cwait queue\u76f8\u5173\u7684\u51fd\u6570\u4e3b\u8981\u5206\u4e3a\u4e24\u5c42\uff0c\u5e95\u5c42\u51fd\u6570\u662f\u5bf9wait queue\u7684\u521d\u59cb\u5316\u3001\u63d2\u5165\u3001\u5220\u9664\u548c\u67e5\u627e\u64cd\u4f5c\uff0c\u76f8\u5173\u51fd\u6570\u5982\u4e0b\uff1a</p> <pre><code>void wait_init(wait_t *wait, struct proc_struct *proc);    //\u521d\u59cb\u5316wait\u7ed3\u6784\nbool wait_in_queue(wait_t *wait);                          //wait\u662f\u5426\u5728wait queue\u4e2d\nvoid wait_queue_init(wait_queue_t *queue);                 //\u521d\u59cb\u5316wait_queue\u7ed3\u6784\nvoid wait_queue_add(wait_queue_t *queue, wait_t *wait);    //\u628await\u524d\u63d2\u5230wait queue\u4e2d\nvoid wait_queue_del(wait_queue_t *queue, wait_t *wait);    //\u4ecewait queue\u4e2d\u5220\u9664wait\nwait_t *wait_queue_next(wait_queue_t *queue, wait_t *wait);//\u53d6\u5f97wait\u7684\u540e\u4e00\u4e2a\u94fe\u63a5\u6307\u9488\nwait_t *wait_queue_prev(wait_queue_t *queue, wait_t *wait);//\u53d6\u5f97wait\u7684\u524d\u4e00\u4e2a\u94fe\u63a5\u6307\u9488\nwait_t *wait_queue_first(wait_queue_t *queue);             //\u53d6\u5f97wait queue\u7684\u7b2c\u4e00\u4e2await\nwait_t *wait_queue_last(wait_queue_t *queue);              //\u53d6\u5f97wait queue\u7684\u6700\u540e\u4e00\u4e2await\nbool wait_queue_empty(wait_queue_t *queue);                //wait queue\u662f\u5426\u4e3a\u7a7a\n</code></pre> <p>\u9ad8\u5c42\u51fd\u6570\u57fa\u4e8e\u5e95\u5c42\u51fd\u6570\u5b9e\u73b0\u4e86\u8ba9\u8fdb\u7a0b\u8fdb\u5165\u7b49\u5f85\u961f\u5217--<code>wait_current_set</code>\uff0c\u4ee5\u53ca\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u5524\u9192\u8fdb\u7a0b--<code>wakeup_wait</code>\uff0c\u76f8\u5173\u51fd\u6570\u5982\u4e0b\uff1a</p> <pre><code>//\u8ba9wait\u4e0e\u8fdb\u7a0b\u5173\u8054\uff0c\u4e14\u8ba9\u5f53\u524d\u8fdb\u7a0b\u5173\u8054\u7684wait\u8fdb\u5165\u7b49\u5f85\u961f\u5217queue\uff0c\u5f53\u524d\u8fdb\u7a0b\u7761\u7720\nvoid wait_current_set(wait_queue_t *queue, wait_t *wait, uint32_t wait_state);\n//\u628a\u4e0e\u5f53\u524d\u8fdb\u7a0b\u5173\u8054\u7684wait\u4ece\u7b49\u5f85\u961f\u5217queue\u4e2d\u5220\u9664\nwait_current_del(queue, wait);\n//\u5524\u9192\u4e0ewait\u5173\u8054\u7684\u8fdb\u7a0b\nvoid wakeup_wait(wait_queue_t *queue, wait_t *wait, uint32_t wakeup_flags, bool del);\n//\u5524\u9192\u7b49\u5f85\u961f\u5217\u4e0a\u6302\u7740\u7684\u7b2c\u4e00\u4e2await\u6240\u5173\u8054\u7684\u8fdb\u7a0b\nvoid wakeup_first(wait_queue_t *queue, uint32_t wakeup_flags, bool del);\n//\u5524\u9192\u7b49\u5f85\u961f\u5217\u4e0a\u6240\u6709\u7684\u7b49\u5f85\u7684\u8fdb\u7a0b\nvoid wakeup_queue(wait_queue_t *queue, uint32_t wakeup_flags, bool del);\n</code></pre>"},{"location":"lab7/sync/#_7","title":"\u8c03\u7528\u5173\u7cfb\u4e3e\u4f8b","text":"<p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u5bf9\u4e8e\u5524\u9192\u8fdb\u7a0b\u7684\u51fd\u6570<code>wakeup_wait</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u4f1a\u88ab\u5404\u79cd\u4fe1\u53f7\u91cf\u7684V\u64cd\u4f5c\u51fd\u6570<code>up</code>\u8c03\u7528\uff0c\u5e76\u4e14\u5b83\u4f1a\u8c03\u7528<code>wait_queue_del</code>\u51fd\u6570\u548c<code>wakup_proc</code>\u51fd\u6570\u6765\u5b8c\u6210\u5524\u9192\u8fdb\u7a0b\u7684\u64cd\u4f5c\u3002</p> <p></p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u800c\u5bf9\u4e8e\u8ba9\u8fdb\u7a0b\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u7684\u51fd\u6570<code>wait_current_set</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u4f1a\u88ab\u5404\u79cd\u4fe1\u53f7\u91cf\u7684P\u64cd\u4f5c\u51fd\u6570\uff40down<code>\u8c03\u7528\uff0c\u5e76\u4e14\u5b83\u4f1a\u8c03\u7528</code>wait_init<code>\u5b8c\u6210\u5bf9\u7b49\u5f85\u9879\u7684\u521d\u59cb\u5316\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528</code>wait_queue_add`\u6765\u628a\u4e0e\u8981\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\u7684\u8fdb\u7a0b\u6240\u5173\u8054\u7684\u7b49\u5f85\u9879\u6302\u5230\u4e0e\u4fe1\u53f7\u91cf\u7ed1\u5b9a\u7684\u7b49\u5f85\u961f\u5217\u4e2d\u3002</p> <p></p>"},{"location":"lab7/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab7/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab7\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\u548c2\u4e2a\u6269\u5c55\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB7\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB7\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab7/task/#1","title":"\u7ec3\u4e601: \u7406\u89e3\u5185\u6838\u7ea7\u4fe1\u53f7\u91cf\u7684\u5b9e\u73b0\u548c\u57fa\u4e8e\u5185\u6838\u7ea7\u4fe1\u53f7\u91cf\u7684\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\uff08\u4e0d\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u5185\u6838\u7ea7\u4fe1\u53f7\u91cf\u7684\u8bbe\u8ba1\u63cf\u8ff0\uff0c\u5e76\u8bf4\u660e\u5176\u5927\u81f4\u6267\u884c\u6d41\u7a0b\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u7ed9\u7528\u6237\u6001\u8fdb\u7a0b/\u7ebf\u7a0b\u63d0\u4f9b\u4fe1\u53f7\u91cf\u673a\u5236\u7684\u8bbe\u8ba1\u65b9\u6848\uff0c\u5e76\u6bd4\u8f83\u8bf4\u660e\u7ed9\u5185\u6838\u7ea7\u63d0\u4f9b\u4fe1\u53f7\u91cf\u673a\u5236\u7684\u5f02\u540c\u3002</p>"},{"location":"lab7/task/#2","title":"\u7ec3\u4e602: \u5b8c\u6210\u5185\u6838\u7ea7\u6761\u4ef6\u53d8\u91cf\u548c\u57fa\u4e8e\u5185\u6838\u7ea7\u6761\u4ef6\u53d8\u91cf\u7684\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u9996\u5148\u638c\u63e1\u7ba1\u7a0b\u673a\u5236\uff0c\u7136\u540e\u57fa\u4e8e\u4fe1\u53f7\u91cf\u5b9e\u73b0\u5b8c\u6210\u6761\u4ef6\u53d8\u91cf\u5b9e\u73b0\uff0c\u7136\u540e\u7528\u7ba1\u7a0b\u673a\u5236\u5b9e\u73b0\u54f2\u5b66\u5bb6\u5c31\u9910\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\uff08\u57fa\u4e8e\u6761\u4ef6\u53d8\u91cf\uff09\u3002</p> <p>\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\u540e\uff0c\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\uff1amake qemu -j 16</p> <p>\u5982\u679c\u53ef\u4ee5\u5f97\u5230\u5982 \u7f16\u8bd1\u65b9\u6cd5\u6240\u793a\u7684\u663e\u793a\u5185\u5bb9\uff08\u4ec5\u4f9b\u53c2\u8003\uff0c\u4e0d\u662f\u6807\u51c6\u7b54\u6848\u8f93\u51fa\uff09\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u5185\u6838\u7ea7\u6761\u4ef6\u53d8\u91cf\u7684\u8bbe\u8ba1\u63cf\u8ff0\uff0c\u5e76\u8bf4\u660e\u5176\u5927\u81f4\u6267\u884c\u6d41\u7a0b\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u7ed9\u7528\u6237\u6001\u8fdb\u7a0b/\u7ebf\u7a0b\u63d0\u4f9b\u6761\u4ef6\u53d8\u91cf\u673a\u5236\u7684\u8bbe\u8ba1\u65b9\u6848\uff0c\u5e76\u6bd4\u8f83\u8bf4\u660e\u7ed9\u5185\u6838\u7ea7\u63d0\u4f9b\u6761\u4ef6\u53d8\u91cf\u673a\u5236\u7684\u5f02\u540c\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u56de\u7b54\uff1a\u80fd\u5426\u4e0d\u7528\u57fa\u4e8e\u4fe1\u53f7\u91cf\u673a\u5236\u6765\u5b8c\u6210\u6761\u4ef6\u53d8\u91cf\uff1f\u5982\u679c\u4e0d\u80fd\uff0c\u8bf7\u7ed9\u51fa\u7406\u7531\uff0c\u5982\u679c\u80fd\uff0c\u8bf7\u7ed9\u51fa\u8bbe\u8ba1\u8bf4\u660e\u548c\u5177\u4f53\u5b9e\u73b0\u3002</p>"},{"location":"lab7/task/#challenge-ucore","title":"\u6269\u5c55\u7ec3\u4e60 Challenge \uff1a\u3000\u5728ucore\u4e2d\u5b9e\u73b0\u7b80\u5316\u7684\u6b7b\u9501\u548c\u91cd\u5165\u63a2\u6d4b\u673a\u5236","text":"<p>\u5728ucore\u4e0b\u5b9e\u73b0\u4e00\u79cd\u63a2\u6d4b\u673a\u5236\uff0c\u80fd\u591f\u5728\u591a\u8fdb\u7a0b/\u7ebf\u7a0b\u8fd0\u884c\u540c\u6b65\u4e92\u65a5\u95ee\u9898\u65f6\uff0c\u52a8\u6001\u5224\u65ad\u5f53\u524d\u7cfb\u7edf\u662f\u5426\u51fa\u73b0\u4e86\u6b7b\u9501\u4ea7\u751f\u7684\u5fc5\u8981\u6761\u4ef6\uff0c\u662f\u5426\u4ea7\u751f\u4e86\u591a\u4e2a\u8fdb\u7a0b\u8fdb\u5165\u4e34\u754c\u533a\u7684\u60c5\u51b5\u3002 \u5982\u679c\u53d1\u73b0\uff0c\u8ba9\u7cfb\u7edf\u8fdb\u5165monitor\u72b6\u6001\uff0c\u6253\u5370\u51fa\u4f60\u7684\u63a2\u6d4b\u4fe1\u606f\u3002</p>"},{"location":"lab7/task/#challenge-linuxrcuucorercu","title":"\u6269\u5c55\u7ec3\u4e60 Challenge \uff1a\u3000\u53c2\u8003Linux\u7684RCU\u673a\u5236\uff0c\u5728ucore\u4e2d\u5b9e\u73b0\u7b80\u5316\u7684RCU\u673a\u5236","text":"<p>\u5728ucore \u4e0b\u5b9e\u73b0\u4e0bLinux\u7684RCU\u540c\u6b65\u4e92\u65a5\u673a\u5236\u3002\u53ef\u9605\u8bfb\u76f8\u5173Linux\u5185\u6838\u4e66\u7c4d\u6216\u67e5\u8be2\u7f51\u4e0a\u8d44\u6599\uff0c\u53ef\u4e86\u89e3RCU\u7684\u8bbe\u8ba1\u5b9e\u73b0\u7ec6\u8282\uff0c\u7136\u540e\u7b80\u5316\u5b9e\u73b0\u5728ucore\u4e2d\u3002 \u8981\u6c42\u6709\u5b9e\u9a8c\u62a5\u544a\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u601d\u8def\uff0c\u5e76\u63d0\u4f9b\u6d4b\u8bd5\u7528\u4f8b\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u53c2\u8003\u8d44\u6599\uff1a</p> <ul> <li>http://www.ibm.com/developerworks/cn/linux/l-rcu/</li> <li>http://www.diybl.com/course/6_system/linux/Linuxjs/20081117/151814.html</li> </ul>"},{"location":"lab8/compile/","title":"\u7f16\u8bd1\u65b9\u6cd5","text":""},{"location":"lab8/compile/#_1","title":"\u7f16\u8bd1\u65b9\u6cd5","text":"<p>Makefile\u4fee\u6539 \u5728Makefile\u4e2d\u53d6\u6d88LAB8    := -DLAB8_EX1 -DLAB8_EX2(\u7b2c13\u884c)\u7684\u6ce8\u91ca <pre><code>LAB1    := -DLAB1_EX4 # -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT\nLAB2    := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3\nLAB3    := -DLAB3_EX1 -DLAB3_EX2\nLAB4    := -DLAB4_EX1 -DLAB4_EX2\nLAB5    := -DLAB5_EX1 -DLAB5_EX2\nLAB6    := -DLAB6_EX2\nLAB7    := -DLAB7_EX1 # -D_SHOW_PHI\nLAB8    := -DLAB8_EX1 -DLAB8_EX2\n</code></pre></p> <p>\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a <pre><code>make\n\nmake qemu -j 16\n</code></pre> \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 <pre><code>chenyu$ make qemu -j 16\n(THU.CST) os is loading ...\n\nSpecial kernel symbols:\n  entry  0xA00000A0 (phys)\netext 0xA0021000 (phys)\nedata 0xA0251470 (phys)\nend   0xA0254750 (phys)\nKernel executable memory footprint: 2254KB\nmemory management: default_pmm_manager\nmemory map:\n    [A0000000, A2000000]\n\nfreemem start at: A0295000\nfree pages: 00001D6B\n## 00000020\ncheck_alloc_page() succeeded!\ncheck_pgdir() succeeded!\ncheck_boot_pgdir() succeeded!\ncheck_slab() succeeded!\nkmalloc_init() succeeded!\ncheck_vma_struct() succeeded!\ncheck_pgfault() succeeded!\ncheck_vmm() succeeded.\nsched class: stride_scheduler\nproc_init succeeded\nInitrd: 0xa005d3d0 - 0xa02513cf, size: 0x001f4000, magic: 0x2f8dbe2a\nramdisk_init(): initrd found, magic: 0x2f8dbe2a, 0x00000fa0 secs\nsfs: mount: 'simple file system' (318/182/500)\nvfs: mount disk0.\nkernel_execve: pid = 2, name = \"sh\".\nuser sh is running!!!\n$ </code></pre></p>"},{"location":"lab8/dev_file/","title":"\u5916\u8bbe\u63a5\u53e3\u5c42","text":""},{"location":"lab8/dev_file/#io","title":"\u8bbe\u5907\u5c42\u6587\u4ef6 IO \u5c42","text":"<p>\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7edf\u4e00\u5730\u8bbf\u95ee\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u4e00\u4e2a\u8bbe\u5907\u770b\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u901a\u8fc7\u8bbf\u95ee\u6587\u4ef6\u7684\u63a5\u53e3\u6765\u8bbf\u95ee\u8bbe\u5907\u3002\u76ee\u524d\u5b9e\u73b0\u4e86stdin\u8bbe\u5907\u6587\u4ef6\u6587\u4ef6\u3001stdout\u8bbe\u5907\u6587\u4ef6\u3001disk0\u8bbe\u5907\u3002stdin\u8bbe\u5907\u5c31\u662f\u4e32\u53e3\uff0cstdout\u8bbe\u5907\u5c31\u662fCONSOLE\uff0c\u800cdisk0\u8bbe\u5907\u662f\u627f\u8f7dSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u8bbe\u5907\uff08\u5c3d\u7ba1\u5b83\u662f\u4e00\u4e2a\u5185\u5b58\u6a21\u62df\u7684\u78c1\u76d8\uff09\u3002\u4e0b\u9762\u6211\u4eec\u9010\u4e00\u5206\u6790ucore\u662f\u5982\u4f55\u8ba9\u7528\u6237\u628a\u8bbe\u5907\u770b\u6210\u6587\u4ef6\u6765\u8bbf\u95ee\u3002</p>"},{"location":"lab8/dev_file/#_1","title":"\u5173\u952e\u6570\u636e\u7ed3\u6784","text":"<p>\u4e3a\u4e86\u8868\u793a\u4e00\u4e2a\u8bbe\u5907\uff0c\u9700\u8981\u6709\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\uff0cucore\u4e3a\u6b64\u5b9a\u4e49\u4e86struct device\uff0c\u5176\u63cf\u8ff0\u5982\u4e0b\uff1a</p> <pre><code>struct device {\nsize_t d_blocks;    //\u8bbe\u5907\u5360\u7528\u7684\u6570\u636e\u5757\u4e2a\u6570            \nsize_t d_blocksize;  //\u6570\u636e\u5757\u7684\u5927\u5c0f\nint (*d_open)(struct device *dev, uint32_t open_flags);  //\u6253\u5f00\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488\nint (*d_close)(struct device *dev); //\u5173\u95ed\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488\nint (*d_io)(struct device *dev, struct iobuf *iob, bool write); //\u8bfb\u5199\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488\nint (*d_ioctl)(struct device *dev, int op, void *data); //\u7528ioctl\u65b9\u5f0f\u63a7\u5236\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488\n};\n</code></pre> <p>\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u80fd\u591f\u652f\u6301\u5bf9\u5757\u8bbe\u5907\uff08\u6bd4\u5982\u78c1\u76d8\uff09\u3001\u5b57\u7b26\u8bbe\u5907\uff08\u6bd4\u5982\u4e32\u53e3\uff09\u7684\u8868\u793a\uff0c\u5b8c\u6210\u5bf9\u8bbe\u5907\u7684\u57fa\u672c\u64cd\u4f5c\u3002ucore\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u628a\u8fd9\u4e9b\u8bbe\u5907\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbe\u5907\u94fe\u8868\uff0c\u5373\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u8fd9\u6837\u901a\u8fc7\u8bbf\u95ee\u6b64\u94fe\u8868\uff0c\u53ef\u4ee5\u627e\u5230ucore\u80fd\u591f\u8bbf\u95ee\u7684\u6240\u6709\u8bbe\u5907\u6587\u4ef6\u3002</p> <p>\u4f46\u8fd9\u4e2a\u8bbe\u5907\u63cf\u8ff0\u6ca1\u6709\u4e0e\u6587\u4ef6\u7cfb\u7edf\u4ee5\u53ca\u8868\u793a\u4e00\u4e2a\u6587\u4ef6\u7684inode\u6570\u636e\u7ed3\u6784\u5efa\u7acb\u5173\u7cfb\uff0c\u4e3a\u6b64\uff0c\u8fd8\u9700\u8981\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u628adevice\u548cinode\u8054\u901a\u8d77\u6765\uff0c\u8fd9\u5c31\u662fvfs_dev_t\u6570\u636e\u7ed3\u6784\uff1a</p> <pre><code>// device info entry in vdev_list \ntypedef struct {\nconst char *devname;\nstruct inode *devnode;\nstruct fs *fs;\nbool mountable;\nlist_entry_t vdev_link;\n} vfs_dev_t;\n</code></pre> <p>\u5229\u7528vfs_dev_t\u6570\u636e\u7ed3\u6784\uff0c\u5c31\u53ef\u4ee5\u8ba9\u6587\u4ef6\u7cfb\u7edf\u901a\u8fc7\u4e00\u4e2a\u94fe\u63a5vfs_dev_t\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u627e\u5230device\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u4e00\u4e2ainode\u8282\u70b9\u7684\u6210\u5458\u53d8\u91cfin_type\u7684\u503c\u662f0x1234\uff0c\u5219\u6b64 inode\u7684\u6210\u5458\u53d8\u91cfin_info\u5c06\u6210\u4e3a\u4e00\u4e2adevice\u7ed3\u6784\u3002\u8fd9\u6837inode\u5c31\u548c\u4e00\u4e2a\u8bbe\u5907\u5efa\u7acb\u4e86\u8054\u7cfb\uff0c\u8fd9\u4e2ainode\u5c31\u662f\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\u3002</p>"},{"location":"lab8/dev_file/#stdout","title":"stdout\u8bbe\u5907\u6587\u4ef6","text":"<p>\u521d\u59cb\u5316</p> <p>\u65e2\u7136stdout\u8bbe\u5907\u662f\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\uff0c\u81ea\u7136\u6709\u81ea\u5df1\u7684inode\u7ed3\u6784\u3002\u5728\u7cfb\u7edf\u521d\u59cb\u5316\u65f6\uff0c\u5373\u53ea\u9700\u5982\u4e0b\u5904\u7406\u8fc7\u7a0b</p> <pre><code>kern_init--&gt;fs_init--&gt;dev_init--&gt;dev_init_stdout --&gt; dev_create_inode\n                 --&gt; stdout_device_init\n                 --&gt; vfs_add_dev\n</code></pre> <p>\u5728dev_init_stdout\u4e2d\u5b8c\u6210\u4e86\u5bf9stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u3002\u5373\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2ainode\uff0c\u7136\u540e\u901a\u8fc7stdout_device_init\u5b8c\u6210\u5bf9inode\u4e2d\u7684\u6210\u5458\u53d8\u91cfinode-&gt;__device_info\u8fdb\u884c\u521d\u59cb\uff1a</p> <p>\u8fd9\u91cc\u7684stdout\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684console\u5916\u8bbe\uff08\u5b83\u5176\u5b9e\u662f\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u7684\u7ec4\u5408\u578b\u5916\u8bbe\uff09\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u5199\u8bbe\u5907\uff0c\u5982\u679c\u8bfb\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdout\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002</p> <p>\u521d\u59cb\u5316</p> <p>stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdout_device_init\u5b8c\u6210\uff0c\u5176\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>static void\nstdout_device_init(struct device *dev) {\ndev-&gt;d_blocks = 0;\ndev-&gt;d_blocksize = 1;\ndev-&gt;d_open = stdout_open;\ndev-&gt;d_close = stdout_close;\ndev-&gt;d_io = stdout_io;\ndev-&gt;d_ioctl = stdout_ioctl;\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cstdout_open\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u6587\u4ef6\u6253\u5f00\u5de5\u4f5c\uff0c\u5982\u679c\u53d1\u73b0\u7528\u6237\u8fdb\u7a0b\u8c03\u7528open\u51fd\u6570\u7684\u53c2\u6570flags\u4e0d\u662f\u53ea\u5199\uff08O_WRONLY\uff09\uff0c\u5219\u4f1a\u62a5\u9519\u3002</p> <p>\u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0</p> <p>stdout_io\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u7684\u5199\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>static int\nstdout_io(struct device *dev, struct iobuf *iob, bool write) {\nif (write) {\nchar *data = iob-&gt;io_base;\nfor (; iob-&gt;io_resid != 0; iob-&gt;io_resid --) {\nkputchar(*data ++);\n}\nreturn 0;\n}\nreturn -E_INVAL;\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8981\u5199\u7684\u6570\u636e\u653e\u5728iob-&gt;io_base\u6240\u6307\u7684\u5185\u5b58\u533a\u57df\uff0c\u4e00\u76f4\u5199\u5230iob-&gt;io_resid\u7684\u503c\u4e3a0\u4e3a\u6b62\u3002\u6bcf\u6b21\u5199\u64cd\u4f5c\u90fd\u662f\u901a\u8fc7cputchar\u6765\u5b8c\u6210\u7684\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u5c06\u901a\u8fc7console\u5916\u8bbe\u9a71\u52a8\u6765\u5b8c\u6210\u628a\u6570\u636e\u8f93\u51fa\u5230\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u663e\u793a\u5668\u4e0a\u8fc7\u7a0b\u3002\u53e6\u5916\uff0c\u4e5f\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u5982\u679c\u7528\u6237\u60f3\u6267\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219stdout_io\u51fd\u6570\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\u503c**-**E_INVAL\u3002</p>"},{"location":"lab8/dev_file/#stdin","title":"stdin \u8bbe\u5907\u6587\u4ef6","text":"<p>\u8fd9\u91cc\u7684stdin\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684\u4e32\u53e3\u8f93\u5165\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u8bfb\u8bbe\u5907\uff0c\u5982\u679c\u5199\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdin\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002</p> <p>\u521d\u59cb\u5316</p> <p>stdin\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdin_device_init\u5b8c\u6210\u4e86\u4e3b\u8981\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>static void\nstdin_device_init(struct device *dev) {\ndev-&gt;d_blocks = 0;\ndev-&gt;d_blocksize = 1;\ndev-&gt;d_open = stdin_open;\ndev-&gt;d_close = stdin_close;\ndev-&gt;d_io = stdin_io;\ndev-&gt;d_ioctl = stdin_ioctl;\n\np_rpos = p_wpos = 0;\nwait_queue_init(wait_queue);\n}\n</code></pre> <p>\u76f8\u5bf9\u4e8estdout\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\uff0cstdin\u7684\u521d\u59cb\u5316\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u591a\u4e86\u4e00\u4e2astdin_buffer\u7f13\u51b2\u533a\uff0c\u63cf\u8ff0\u7f13\u51b2\u533a\u8bfb\u5199\u4f4d\u7f6e\u7684\u53d8\u91cfp_rpos\u3001p_wpos\u4ee5\u53ca\u7528\u4e8e\u7b49\u5f85\u7f13\u51b2\u533a\u7684\u7b49\u5f85\u961f\u5217wait_queue\u3002\u5728stdin_device_init\u51fd\u6570\u7684\u521d\u59cb\u5316\u4e2d\uff0c\u4e5f\u5b8c\u6210\u4e86\u5bf9p_rpos\u3001p_wpos\u548cwait_queue\u7684\u521d\u59cb\u5316\u3002</p> <p>\u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0</p> <p>stdin_io\u51fd\u6570\u8d1f\u8d23\u5b8c\u6210\u8bbe\u5907\u7684\u8bfb\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>static int\nstdin_io(struct device *dev, struct iobuf *iob, bool write) {\nif (!write) {\nint ret;\nif ((ret = dev_stdin_read(iob-&gt;io_base, iob-&gt;io_resid)) &gt; 0) {\niob-&gt;io_resid -= ret;\n}\nreturn ret;\n}\nreturn -E_INVAL;\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u662f\u5199\u64cd\u4f5c\uff0c\u5219stdin_io\u51fd\u6570\u76f4\u63a5\u62a5\u9519\u8fd4\u56de\u3002\u6240\u4ee5\u8fd9\u4e5f\u8fdb\u4e00\u6b65\u8bf4\u660e\u4e86\u6b64\u8bbe\u5907\u6587\u4ef6\u662f\u53ea\u8bfb\u6587\u4ef6\u3002\u5982\u679c\u6b64\u8bfb\u64cd\u4f5c\uff0c\u5219\u6b64\u51fd\u6570\u8fdb\u4e00\u6b65\u8c03\u7528dev_stdin_read\u51fd\u6570\u5b8c\u6210\u5bf9\u4e32\u53e3\u8bbe\u5907\u7684\u8bfb\u5165\u64cd\u4f5c\u3002dev_stdin_read\u51fd\u6570\u7684\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u4e3b\u8981\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>static int\ndev_stdin_read(char *buf, size_t len) {\nint ret = 0;\nbool intr_flag;\nlocal_intr_save(intr_flag);\n{\nfor (; ret &lt; len; ret ++, p_rpos ++) {\ntry_again:\nif (p_rpos &lt; p_wpos) {\n*buf ++ = stdin_buffer[p_rpos % stdin_BUFSIZE];\n}\nelse {\nwait_t __wait, *wait = &amp;__wait;\nwait_current_set(wait_queue, wait, WT_KBD);\nlocal_intr_restore(intr_flag);\n\nschedule();\n\nlocal_intr_save(intr_flag);\nwait_current_del(wait_queue, wait);\nif (wait-&gt;wakeup_flags == WT_KBD) {\ngoto try_again;\n}\nbreak;\n}\n}\n}\nlocal_intr_restore(intr_flag);\nreturn ret;\n}\n</code></pre> <p>\u5728\u4e0a\u8ff0\u51fd\u6570\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cp_rpos &lt; p_wpos\uff0c\u5219\u8868\u793a\u6709\u4e32\u53e3\u8f93\u5165\u7684\u65b0\u5b57\u7b26\u5728stdin_buffer\u4e2d\uff0c\u4e8e\u662f\u5c31\u4ecestdin_buffer\u4e2d\u53d6\u51fa\u65b0\u5b57\u7b26\u653e\u5230iobuf\u6307\u5411\u7684\u7f13\u51b2\u533a\u4e2d\uff1b\u5982\u679cp_rpos &gt;=p_wpos\uff0c\u5219\u8868\u660e\u6ca1\u6709\u65b0\u5b57\u7b26\uff0c\u8fd9\u6837\u8c03\u7528read\u7528\u6237\u6001\u5e93\u51fd\u6570\u7684\u7528\u6237\u8fdb\u7a0b\u5c31\u9700\u8981\u91c7\u7528\u7b49\u5f85\u961f\u5217\u7684\u7761\u7720\u64cd\u4f5c\u8fdb\u5165\u7761\u7720\u72b6\u6001\uff0c\u7b49\u5f85\u4e32\u53e3\u8f93\u5165\u5b57\u7b26\u7684\u4ea7\u751f\u3002</p> <p>\u4e32\u53e3\u8f93\u5165\u5b57\u7b26\u540e\uff0c\u5982\u4f55\u5524\u9192\u7b49\u5f85\u4e32\u53e3\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u5462\uff1f\u56de\u987elab1\u4e2d\u7684\u5916\u8bbe\u4e2d\u65ad\u5904\u7406\uff0c\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u5f53\u7528\u6237\u5728QEMU\u7a0b\u5e8f\u4e2d\u8f93\u5165\u5b57\u7b26\u65f6\uff0c\u4f1a\u4ea7\u751f\u4e32\u53e3\u4e2d\u65ad\uff0c\u5728trap_dispatch\u51fd\u6570\u4e2d\uff0c\u5f53\u8bc6\u522b\u51fa\u4e2d\u65ad\u662f\u4e32\u53e3\u4e2d\u65ad\u65f6\uff0c\u4f1a\u8c03\u7528dev_stdin_write\u51fd\u6570\uff0c\u6765\u628a\u5b57\u7b26\u5199\u5165\u5230stdin_buffer\u4e2d\uff0c\u4e14\u4f1a\u901a\u8fc7\u7b49\u5f85\u961f\u5217\u7684\u5524\u9192\u64cd\u4f5c\u5524\u9192\u6b63\u5728\u7b49\u5f85\u4e32\u53e3\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u3002</p>"},{"location":"lab8/interface/","title":"\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3","text":""},{"location":"lab8/interface/#_1","title":"\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3","text":"<p>\u6587\u4ef6\u548c\u76ee\u5f55\u76f8\u5173\u7528\u6237\u5e93\u51fd\u6570</p> <p>Lab8\u4e2d\u90e8\u5206\u7528\u6237\u5e93\u51fd\u6570\u4e0e\u6587\u4ef6\u7cfb\u7edf\u6709\u5173\uff0c\u6211\u4eec\u5148\u8ba8\u8bba\u5bf9\u5355\u4e2a\u6587\u4ef6\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7136\u540e\u8ba8\u8bba\u5bf9\u76ee\u5f55\u548c\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u3002</p> <p>\u5728\u6587\u4ef6\u64cd\u4f5c\u65b9\u9762\uff0c\u6700\u57fa\u672c\u7684\u76f8\u5173\u51fd\u6570\u662fopen\u3001close\u3001read\u3001write\u3002\u5728\u8bfb\u5199\u4e00\u4e2a\u6587\u4ef6\u4e4b\u524d\uff0c\u9996\u5148\u8981\u7528open\u7cfb\u7edf\u8c03\u7528\u5c06\u5176\u6253\u5f00\u3002open\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\u6587\u4ef6\u7684\u8def\u5f84\u540d\uff0c\u53ef\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u540d\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6307\u5b9a\u6253\u5f00\u7684\u65b9\u5f0f\uff0c\u53ef\u8bbe\u7f6e\u4e3aO_RDONLY\u3001O_WRONLY\u3001O_RDWR\uff0c\u5206\u522b\u8868\u793a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ef\u8bfb\u53ef\u5199\u3002\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u8fd4\u56de\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u5bf9\u6587\u4ef6\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\u3002\u5728\u4f7f\u7528\u5b8c\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u8fd8\u8981\u7528close\u7cfb\u7edf\u8c03\u7528\u628a\u5b83\u5173\u95ed\uff0c\u5176\u53c2\u6570\u5c31\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u3002\u8fd9\u6837\u5b83\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c31\u53ef\u4ee5\u7a7a\u51fa\u6765\uff0c\u7ed9\u522b\u7684\u6587\u4ef6\u4f7f\u7528\u3002</p> <p>\u8bfb\u5199\u6587\u4ef6\u5185\u5bb9\u7684\u7cfb\u7edf\u8c03\u7528\u662fread\u548cwrite\u3002read\u7cfb\u7edf\u8c03\u7528\u6709\u4e09\u4e2a\u53c2\u6570\uff1a\u4e00\u4e2a\u6307\u5b9a\u6240\u64cd\u4f5c\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u4e2a\u6307\u5b9a\u8bfb\u53d6\u6570\u636e\u7684\u5b58\u653e\u5730\u5740\uff0c\u6700\u540e\u4e00\u4e2a\u6307\u5b9a\u8bfb\u591a\u5c11\u4e2a\u5b57\u8282\u3002\u5728C\u7a0b\u5e8f\u4e2d\u8c03\u7528\u8be5\u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>count = read(filehandle, buffer, nbytes);\n</code></pre> <p>\u8be5\u7cfb\u7edf\u8c03\u7528\u4f1a\u628a\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570\u8fd4\u56de\u7ed9count\u53d8\u91cf\u3002\u5728\u6b63\u5e38\u60c5\u5f62\u4e0b\u8fd9\u4e2a\u503c\u4e0enbytes\u76f8\u7b49\uff0c\u4f46\u6709\u65f6\u53ef\u80fd\u4f1a\u5c0f\u4e00\u4e9b\u3002\u4f8b\u5982\uff0c\u5728\u8bfb\u6587\u4ef6\u65f6\u78b0\u4e0a\u4e86\u6587\u4ef6\u7ed3\u675f\u7b26\uff0c\u4ece\u800c\u63d0\u524d\u7ed3\u675f\u6b64\u6b21\u8bfb\u64cd\u4f5c\u3002</p> <p>\u5982\u679c\u7531\u4e8e\u53c2\u6570\u65e0\u6548\u6216\u78c1\u76d8\u8bbf\u95ee\u9519\u8bef\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u6b64\u6b21\u7cfb\u7edf\u8c03\u7528\u65e0\u6cd5\u5b8c\u6210\uff0c\u5219count\u88ab\u7f6e\u4e3a-1\u3002\u800cwrite\u51fd\u6570\u7684\u53c2\u6570\u4e0e\u4e4b\u5b8c\u5168\u76f8\u540c\u3002</p> <p>\u5bf9\u4e8e\u76ee\u5f55\u800c\u8a00\uff0c\u6700\u5e38\u7528\u7684\u64cd\u4f5c\u662f\u8df3\u8f6c\u5230\u67d0\u4e2a\u76ee\u5f55\uff0c\u8fd9\u91cc\u5bf9\u5e94\u7684\u7528\u6237\u5e93\u51fd\u6570\u662fchdir\u3002\u7136\u540e\u5c31\u9700\u8981\u8bfb\u76ee\u5f55\u7684\u5185\u5bb9\u4e86\uff0c\u5373\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u540d\uff0c\u8fd9\u5728\u5904\u7406\u4e0a\u4e0e\u8bfb\u6587\u4ef6\u7c7b\u4f3c\uff0c\u5373\u9700\u8981\u901a\u8fc7opendir\u51fd\u6570\u6253\u5f00\u76ee\u5f55\uff0c\u901a\u8fc7readdir\u6765\u83b7\u53d6\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u8bfb\u5b8c\u540e\u8fd8\u9700\u901a\u8fc7closedir\u51fd\u6570\u6765\u5173\u95ed\u76ee\u5f55\u3002\u7531\u4e8e\u5728ucore\u4e2d\u628a\u76ee\u5f55\u770b\u6210\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6587\u4ef6\uff0c\u6240\u4ee5opendir\u548cclosedir\u5b9e\u9645\u4e0a\u5c31\u662f\u8c03\u7528\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u548cclose\u51fd\u6570\u3002\u53ea\u6709readdir\u9700\u8981\u8c03\u7528\u83b7\u53d6\u76ee\u5f55\u5185\u5bb9\u7684\u7279\u6b8a\u7cfb\u7edf\u8c03\u7528sys_getdirentry\u3002\u800c\u4e14\u8fd9\u91cc\u6ca1\u6709\u5199\u76ee\u5f55\u8fd9\u4e00\u64cd\u4f5c\u3002\u5728\u76ee\u5f55\u4e2d\u589e\u52a0\u5185\u5bb9\u5176\u5b9e\u5c31\u662f\u5728\u6b64\u76ee\u5f55\u4e2d\u521b\u5efa\u6587\u4ef6\uff0c\u9700\u8981\u7528\u5230\u521b\u5efa\u6587\u4ef6\u7684\u51fd\u6570\u3002</p> <p>\u6587\u4ef6\u548c\u76ee\u5f55\u8bbf\u95ee\u76f8\u5173\u7cfb\u7edf\u8c03\u7528</p> <p>\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u3001close\u3001read\u3001write\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_open\u3001sys_close\u3001sys_read\u3001sys_write\u56db\u4e2a\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002\u4e0e\u76ee\u5f55\u76f8\u5173\u7684readdir\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_getdirentry\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u63a5\u53e3\u5c06\u901a\u8fc7syscall\u51fd\u6570\u6765\u83b7\u5f97ucore\u7684\u5185\u6838\u670d\u52a1\u3002\u5f53\u5230\u4e86ucore\u5185\u6838\u540e\uff0c\u5728\u8c03\u7528\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684file\u63a5\u53e3\u548cdir\u63a5\u53e3\u3002</p>"},{"location":"lab8/interface/#_2","title":"\u6587\u4ef6\u64cd\u4f5c\u5b9e\u73b0","text":""},{"location":"lab8/interface/#_3","title":"\u6253\u5f00\u6587\u4ef6","text":"<p>\u6709\u4e86\u4e0a\u8ff0\u5206\u6790\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u4f1a\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1f\u9996\u5148\u5047\u5b9a\u7528\u6237\u8fdb\u7a0b\u9700\u8981\u6253\u5f00\u7684\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\u5728\u786c\u76d8\u4e0a\u3002\u4ee5user/sfs_filetest1.c\u4e3a\u4f8b\uff0c\u9996\u5148\u7528\u6237\u8fdb\u7a0b\u4f1a\u8c03\u7528\u5728main\u51fd\u6570\u4e2d\u7684\u5982\u4e0b\u8bed\u53e5\uff1a</p> <pre><code>int fd1 = safe_open(\"sfs\\_filetest1\", O_RDONLY);\n</code></pre> <p>\u4ece\u5b57\u9762\u4e0a\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cucore\u80fd\u591f\u6b63\u5e38\u67e5\u627e\u5230\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c31\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4ee3\u8868\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd1\uff0c\u8fd9\u6837\u5728\u63a5\u4e0b\u6765\u7684\u8bfb\u5199\u6587\u4ef6\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u76f4\u63a5\u7528\u8fd9\u6837fd1\u6765\u4ee3\u8868\u5c31\u53ef\u4ee5\u4e86\u3002\u90a3\u8fd9\u4e2a\u6253\u5f00\u6587\u4ef6\u7684\u8fc7\u7a0b\u662f\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u5b9e\u73b0\u7684\u5462\uff1f</p> <p>\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <p>\u9996\u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1a open-&gt;sys_open-&gt;syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_open\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_open\u5185\u6838\u51fd\u6570\u3002\u5230\u4e86\u8fd9\u91cc\uff0c\u9700\u8981\u628a\u4f4d\u4e8e\u7528\u6237\u7a7a\u95f4\u7684\u5b57\u7b26\u4e32\"sfs_filetest1\"\u62f7\u8d1d\u5230\u5185\u6838\u7a7a\u95f4\u4e2d\u7684\u5b57\u7b26\u4e32path\u4e2d\uff0c\u5e76\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u7684\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u4e2d\u3002</p> <p>\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <ol> <li>\u5206\u914d\u4e00\u4e2a\u7a7a\u95f2\u7684file\u6570\u636e\u7ed3\u6784\u53d8\u91cffile\u5728\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u4e2d\uff0c\u9996\u5148\u8c03\u7528\u7684\u662ffile_open\u51fd\u6570\uff0c\u5b83\u8981\u7ed9\u8fd9\u4e2a\u5373\u5c06\u6253\u5f00\u7684\u6587\u4ef6\u5206\u914d\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u5176\u5b9e\u662f\u5f53\u524d\u8fdb\u7a0b\u7684\u6253\u5f00\u6587\u4ef6\u6570\u7ec4current-&gt;fs_struct-&gt;filemap[]\u4e2d\u7684\u4e00\u4e2a\u7a7a\u95f2\u5143\u7d20\uff08\u5373\u8fd8\u6ca1\u7528\u4e8e\u4e00\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\uff09\uff0c\u800c\u8fd9\u4e2a\u5143\u7d20\u7684\u7d22\u5f15\u503c\u5c31\u662f\u6700\u7ec8\u8981\u8fd4\u56de\u5230\u7528\u6237\u8fdb\u7a0b\u5e76\u8d4b\u503c\u7ed9\u53d8\u91cffd1\u3002\u5230\u4e86\u8fd9\u4e00\u6b65\u8fd8\u4ec5\u4ec5\u662f\u7ed9\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u4e86\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd8\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u7684\u6587\u4ef6\u7d22\u5f15\u8282\u70b9\u3002</li> </ol> <p>\u4e3a\u6b64\u9700\u8981\u8fdb\u4e00\u6b65\u8c03\u7528vfs_open\u51fd\u6570\u6765\u627e\u5230path\u6307\u51fa\u7684\u6587\u4ef6\u6240\u5bf9\u5e94\u7684\u57fa\u4e8einode\u6570\u636e\u7ed3\u6784\u7684VFS\u7d22\u5f15\u8282\u70b9node\u3002vfs_open\u51fd\u6570\u9700\u8981\u5b8c\u6210\u4e24\u4ef6\u4e8b\u60c5\uff1a\u901a\u8fc7vfs_lookup\u627e\u5230path\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff1b\u8c03\u7528vop_open\u51fd\u6570\u6253\u5f00\u6587\u4ef6\u3002</p> <ol> <li> <p>\u627e\u5230\u6587\u4ef6\u8bbe\u5907\u7684\u6839\u76ee\u5f55\u201c/\u201d\u7684\u7d22\u5f15\u8282\u70b9\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684vfs_lookup\u51fd\u6570\u662f\u4e00\u4e2a\u9488\u5bf9\u76ee\u5f55\u7684\u64cd\u4f5c\u51fd\u6570\uff0c\u5b83\u4f1a\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u627e\u5230SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u201c/\u201d\u76ee\u5f55\u4e0b\u7684\u201csfs_filetest1\u201d\u6587\u4ef6\u3002\u4e3a\u6b64\uff0cvfs_lookup\u51fd\u6570\u9996\u5148\u8c03\u7528get_device\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528vfs_get_bootfs\u51fd\u6570\uff08\u5176\u5b9e\u8c03\u7528\u4e86\uff09\u6765\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u5bf9\u5e94\u7684inode\u3002\u8fd9\u4e2ainode\u5c31\u662f\u4f4d\u4e8evfs.c\u4e2d\u7684inode\u53d8\u91cfbootfs_node\u3002\u8fd9\u4e2a\u53d8\u91cf\u5728init_main\u51fd\u6570\uff08\u4f4d\u4e8ekern/process/proc.c\uff09\u6267\u884c\u65f6\u83b7\u5f97\u4e86\u8d4b\u503c\u3002</p> </li> <li> <p>\u901a\u8fc7\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u67e5\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u4e0b\u5bf9\u5e94\u6587\u4ef6sfs_filetest1\u7684\u7d22\u5f15\u8282\u70b9\uff0c\uff0c\u5982\u679c\u627e\u5230\u5c31\u8fd4\u56de\u6b64\u7d22\u5f15\u8282\u70b9\u3002</p> </li> <li> <p>\u628afile\u548cnode\u5efa\u7acb\u8054\u7cfb\u3002\u5b8c\u6210\u7b2c3\u6b65\u540e\uff0c\u5c06\u8fd4\u56de\u5230file_open\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u6267\u884c\u8bed\u53e5\u201cfile-&gt;node=node;\u201d\uff0c\u5c31\u628a\u5f53\u524d\u8fdb\u7a0b\u7684current-&gt;fs_struct-&gt;filemap[fd]\uff08\u5373file\u6240\u6307\u53d8\u91cf\uff09\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e86\u4ee3\u8868sfs_filetest1\u6587\u4ef6\u7684\u7d22\u5f15\u8282\u70b9inode\u3002\u8fd9\u65f6\u8fd4\u56defd\u3002\u7ecf\u8fc7\u91cd\u91cd\u56de\u9000\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u7528\u6237\u6001\u7684syscall-&gt;sys_open-&gt;open-&gt;safe_open\u7b49\u7528\u6237\u51fd\u6570\u7684\u5c42\u5c42\u51fd\u6570\u8fd4\u56de\uff0c\u6700\u7ec8\u628a\u628afd\u8d4b\u503c\u7ed9fd1\u3002\u81ea\u6b64\u5b8c\u6210\u4e86\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u3002\u4f46\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5206\u6790\u7b2c2\u548c\u7b2c3\u6b65\u662f\u5982\u4f55\u8fdb\u4e00\u6b65\u8c03\u7528SFS\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u51fd\u6570\u627e\u4f4d\u4e8eSFS\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684sfs_filetest1\u6587\u4ef6\u6240\u5bf9\u5e94\u7684sfs\u78c1\u76d8inode\u7684\u8fc7\u7a0b\u3002\u4e0b\u9762\u9700\u8981\u8fdb\u4e00\u6b65\u5bf9\u6b64\u8fdb\u884c\u5206\u6790\u3002</p> </li> </ol> <p>SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <p>\u8fd9\u91cc\u9700\u8981\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u4e2d\u6ca1\u6709\u5f7b\u5e95\u5206\u6790\u7684vop_lookup\u51fd\u6570\u5230\u5e95\u505a\u4e86\u5565\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u3002\u5728sfs_inode.c\u4e2d\u7684sfs_node_dirops\u53d8\u91cf\u5b9a\u4e49\u4e86\u201c.vop_lookup = sfs_lookup\u201d\uff0c\u6240\u4ee5\u6211\u4eec\u91cd\u70b9\u5206\u6790sfs_lookup\u7684\u5b9e\u73b0\u3002\u6ce8\u610f\uff1a\u5728lab8\u4e2d\uff0c\u4e3a\u7b80\u5316\u4ee3\u7801\uff0csfs_lookup\u51fd\u6570\u4e2d\u5e76\u6ca1\u6709\u5b9e\u73b0\u80fd\u591f\u5bf9\u591a\u7ea7\u76ee\u5f55\u8fdb\u884c\u67e5\u627e\u7684\u63a7\u5236\u903b\u8f91\uff08\u5728ucore_plus\u4e2d\u6709\u5b9e\u73b0\uff09\u3002</p> <p>sfs_lookup\u6709\u4e09\u4e2a\u53c2\u6570\uff1anode\uff0cpath\uff0cnode_store\u3002\u5176\u4e2dnode\u662f\u6839\u76ee\u5f55\u201c/\u201d\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\uff1bpath\u662f\u6587\u4ef6sfs_filetest1\u7684\u7edd\u5bf9\u8def\u5f84/sfs_filetest1\uff0c\u800cnode_store\u662f\u7ecf\u8fc7\u67e5\u627e\u83b7\u5f97\u7684sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002</p> <p>sfs_lookup\u51fd\u6570\u4ee5\u201c/\u201d\u4e3a\u5206\u5272\u7b26\uff0c\u4ece\u5de6\u81f3\u53f3\u9010\u4e00\u5206\u89e3path\u83b7\u5f97\u5404\u4e2a\u5b50\u76ee\u5f55\u548c\u6700\u7ec8\u6587\u4ef6\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5728\u672c\u4f8b\u4e2d\u662f\u8c03\u7528sfs_lookup_once\u67e5\u627e\u4ee5\u6839\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5f53\u65e0\u6cd5\u5206\u89e3path\u540e\uff0c\u5c31\u610f\u5473\u7740\u627e\u5230\u4e86sfs_filetest1\u5bf9\u5e94\u7684inode\u8282\u70b9\uff0c\u5c31\u53ef\u987a\u5229\u8fd4\u56de\u4e86\u3002</p> <p>\u5f53\u7136\u8fd9\u91cc\u8bb2\u5f97\u8fd8\u6bd4\u8f83\u7b80\u5355\uff0csfs_lookup_once\u5c06\u8c03\u7528sfs_dirent_search_nolock\u51fd\u6570\u6765\u67e5\u627e\u4e0e\u8def\u5f84\u540d\u5339\u914d\u7684\u76ee\u5f55\u9879\uff0c\u5982\u679c\u627e\u5230\u76ee\u5f55\u9879\uff0c\u5219\u6839\u636e\u76ee\u5f55\u9879\u4e2d\u8bb0\u5f55\u7684inode\u6240\u5904\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u627e\u5230\u8def\u5f84\u540d\u5bf9\u5e94\u7684SFS\u78c1\u76d8inode\uff0c\u5e76\u8bfb\u5165SFS\u78c1\u76d8inode\u5bf9\u7684\u5185\u5bb9\uff0c\u521b\u5efaSFS\u5185\u5b58inode\u3002</p>"},{"location":"lab8/interface/#_4","title":"\u8bfb\u6587\u4ef6","text":"<p>\u8bfb\u6587\u4ef6\u5176\u5b9e\u5c31\u662f\u8bfb\u51fa\u76ee\u5f55\u4e2d\u7684\u76ee\u5f55\u9879\uff0c\u9996\u5148\u5047\u5b9a\u6587\u4ef6\u5728\u78c1\u76d8\u4e0a\u4e14\u5df2\u7ecf\u6253\u5f00\u3002\u7528\u6237\u8fdb\u7a0b\u6709\u5982\u4e0b\u8bed\u53e5\uff1a</p> <pre><code>read(fd, data, len);\n</code></pre> <p>\u5373\u8bfb\u53d6fd\u5bf9\u5e94\u6587\u4ef6\uff0c\u8bfb\u53d6\u957f\u5ea6\u4e3alen\uff0c\u5b58\u5165data\u4e2d\u3002\u4e0b\u9762\u6765\u5206\u6790\u4e00\u4e0b\u8bfb\u6587\u4ef6\u7684\u5b9e\u73b0\u3002</p> <p>\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <p>\u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1aread-&gt;sys_read-&gt;syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u4ee5\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_read\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_read\u5185\u6838\u51fd\u6570\uff0c\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u8bfb\u6587\u4ef6\u7684\u64cd\u4f5c\u3002</p> <p>\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <p>1) \u68c0\u67e5\u9519\u8bef\uff0c\u5373\u68c0\u67e5\u8bfb\u53d6\u957f\u5ea6\u662f\u5426\u4e3a0\u548c\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\u3002</p> <p>2) \u5206\u914dbuffer\u7a7a\u95f4\uff0c\u5373\u8c03\u7528kmalloc\u51fd\u6570\u5206\u914d4096\u5b57\u8282\u7684buffer\u7a7a\u95f4\u3002</p> <p>3) \u8bfb\u6587\u4ef6\u8fc7\u7a0b</p> <p>[1] \u5b9e\u9645\u8bfb\u6587\u4ef6</p> <p>\u5faa\u73af\u8bfb\u53d6\u6587\u4ef6\uff0c\u6bcf\u6b21\u8bfb\u53d6buffer\u5927\u5c0f\u3002\u6bcf\u6b21\u5faa\u73af\u4e2d\uff0c\u5148\u68c0\u67e5\u5269\u4f59\u90e8\u5206\u5927\u5c0f\uff0c\u82e5\u5176\u5c0f\u4e8e4096\u5b57\u8282\uff0c\u5219\u53ea\u8bfb\u53d6\u5269\u4f59\u90e8\u5206\u7684\u5927\u5c0f\u3002\u7136\u540e\u8c03\u7528file_read\u51fd\u6570\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u5230buffer\u4e2d\uff0calen\u4e3a\u5b9e\u9645\u5927\u5c0f\u3002\u8c03\u7528copy_to_user\u51fd\u6570\u5c06\u8bfb\u5230\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u7528\u6237\u7684\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8c03\u6574\u5404\u53d8\u91cf\u4ee5\u8fdb\u884c\u4e0b\u4e00\u6b21\u5faa\u73af\u8bfb\u53d6\uff0c\u76f4\u81f3\u6307\u5b9a\u957f\u5ea6\u8bfb\u53d6\u5b8c\u6210\u3002\u6700\u540e\u51fd\u6570\u8c03\u7528\u5c42\u5c42\u8fd4\u56de\u81f3\u7528\u6237\u7a0b\u5e8f\uff0c\u7528\u6237\u7a0b\u5e8f\u6536\u5230\u4e86\u8bfb\u5230\u7684\u6587\u4ef6\u5185\u5bb9\u3002</p> <p>[2] file_read\u51fd\u6570</p> <p>\u8fd9\u4e2a\u51fd\u6570\u662f\u8bfb\u6587\u4ef6\u7684\u6838\u5fc3\u51fd\u6570\u3002\u51fd\u6570\u67094\u4e2a\u53c2\u6570\uff0cfd\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0cbase\u662f\u7f13\u5b58\u7684\u57fa\u5730\u5740\uff0clen\u662f\u8981\u8bfb\u53d6\u7684\u957f\u5ea6\uff0ccopied_store\u5b58\u653e\u5b9e\u9645\u8bfb\u53d6\u7684\u957f\u5ea6\u3002\u51fd\u6570\u9996\u5148\u8c03\u7528fd2file\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684file\u7ed3\u6784\uff0c\u5e76\u68c0\u67e5\u662f\u5426\u53ef\u8bfb\u3002\u8c03\u7528filemap_acquire\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u52a01\u3002\u8c03\u7528vop_read\u51fd\u6570\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u5230iob\u4e2d\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u3002\u8c03\u6574\u6587\u4ef6\u6307\u9488\u504f\u79fb\u91cfpos\u7684\u503c\uff0c\u4f7f\u5176\u5411\u540e\u79fb\u52a8\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570iobuf_used(iob)\u3002\u6700\u540e\u8c03\u7528filemap_release\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u51cf1\uff0c\u82e5\u6253\u5f00\u8ba1\u6570\u4e3a0\uff0c\u5219\u91ca\u653efile\u3002</p> <p>SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b</p> <p>vop_read\u51fd\u6570\u5b9e\u9645\u4e0a\u662f\u5bf9sfs_read\u7684\u5305\u88c5\u3002\u5728sfs_inode.c\u4e2dsfs_node_fileops\u53d8\u91cf\u5b9a\u4e49\u4e86.vop_read = sfs_read\uff0c\u6240\u4ee5\u4e0b\u9762\u6765\u5206\u6790sfs_read\u51fd\u6570\u7684\u5b9e\u73b0\u3002</p> <p>sfs_read\u51fd\u6570\u8c03\u7528sfs_io\u51fd\u6570\u3002\u5b83\u6709\u4e09\u4e2a\u53c2\u6570\uff0cnode\u662f\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff0ciob\u662f\u7f13\u5b58\uff0cwrite\u8868\u793a\u662f\u8bfb\u8fd8\u662f\u5199\u7684\u5e03\u5c14\u503c\uff080\u8868\u793a\u8bfb\uff0c1\u8868\u793a\u5199\uff09\uff0c\u8fd9\u91cc\u662f0\u3002\u51fd\u6570\u5148\u627e\u5230inode\u5bf9\u5e94sfs\u548csin\uff0c\u7136\u540e\u8c03\u7528sfs_io_nolock\u51fd\u6570\u8fdb\u884c\u8bfb\u53d6\u6587\u4ef6\u64cd\u4f5c\uff0c\u6700\u540e\u8c03\u7528iobuf_skip\u51fd\u6570\u8c03\u6574iobuf\u7684\u6307\u9488\u3002</p> <p>\u5728sfs_io_nolock\u51fd\u6570\u4e2d\uff0c\u5148\u8ba1\u7b97\u4e00\u4e9b\u8f85\u52a9\u53d8\u91cf\uff0c\u5e76\u5904\u7406\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\uff08\u6bd4\u5982\u8d8a\u754c\uff09\uff0c\u7136\u540e\u6709sfs_buf_op = sfs_rbuf,sfs_block_op = sfs_rblock\uff0c\u8bbe\u7f6e\u8bfb\u53d6\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u63a5\u7740\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\uff0c\u5148\u5904\u7406\u8d77\u59cb\u7684\u6ca1\u6709\u5bf9\u9f50\u5230\u5757\u7684\u90e8\u5206\uff0c\u518d\u4ee5\u5757\u4e3a\u5355\u4f4d\u5faa\u73af\u5904\u7406\u4e2d\u95f4\u7684\u90e8\u5206\uff0c\u6700\u540e\u5904\u7406\u672b\u5c3e\u5269\u4f59\u7684\u90e8\u5206\u3002\u6bcf\u90e8\u5206\u4e2d\u90fd\u8c03\u7528sfs_bmap_load_nolock\u51fd\u6570\u5f97\u5230blkno\u5bf9\u5e94\u7684inode\u7f16\u53f7\uff0c\u5e76\u8c03\u7528sfs_rbuf\u6216sfs_rblock\u51fd\u6570\u8bfb\u53d6\u6570\u636e\uff08\u4e2d\u95f4\u90e8\u5206\u8c03\u7528sfs_rblock\uff0c\u8d77\u59cb\u548c\u672b\u5c3e\u90e8\u5206\u8c03\u7528sfs_rbuf\uff09\uff0c\u8c03\u6574\u76f8\u5173\u53d8\u91cf\u3002\u5b8c\u6210\u540e\u5982\u679coffset + alen &gt; din-&gt;fileinfo.size\uff08\u5199\u6587\u4ef6\u65f6\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bfb\u6587\u4ef6\u65f6\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0calen\u4e3a\u5b9e\u9645\u8bfb\u5199\u7684\u957f\u5ea6\uff09\uff0c\u5219\u8c03\u6574\u6587\u4ef6\u5927\u5c0f\u4e3aoffset + alen\u5e76\u8bbe\u7f6edirty\u53d8\u91cf\u3002</p> <p>sfs_bmap_load_nolock\u51fd\u6570\u5c06\u5bf9\u5e94sfs_inode\u7684\u7b2cindex\u4e2a\u7d22\u5f15\u6307\u5411\u7684block\u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u5b83\u8c03\u7528sfs_bmap_get_nolock\u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\u3002sfs_rbuf\u548csfs_rblock\u51fd\u6570\u6700\u7ec8\u90fd\u8c03\u7528sfs_rwblock_nolock\u51fd\u6570\u5b8c\u6210\u64cd\u4f5c\uff0c\u800csfs_rwblock_nolock\u51fd\u6570\u8c03\u7528dop_io-&gt;disk0_io-&gt;disk0_read_blks_nolock-&gt;ide_read_secs\u5b8c\u6210\u5bf9\u78c1\u76d8\u7684\u64cd\u4f5c\u3002</p>"},{"location":"lab8/intro/","title":"\u603b\u4f53\u4ecb\u7ecd","text":""},{"location":"lab8/intro/#ucore","title":"ucore \u6587\u4ef6\u7cfb\u7edf\u603b\u4f53\u4ecb\u7ecd","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8d1f\u8d23\u7ba1\u7406\u548c\u5b58\u50a8\u53ef\u957f\u671f\u4fdd\u5b58\u6570\u636e\u7684\u8f6f\u4ef6\u529f\u80fd\u6a21\u5757\u79f0\u4e3a\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\uff0c\u4e3b\u8981\u4fa7\u91cd\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u8ba1\u5b9e\u73b0\u548c\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c\u6d41\u7a0b\u7684\u5206\u6790\u4e0e\u7406\u89e3\u3002</p> <p>ucore\u7684\u6587\u4ef6\u7cfb\u7edf\u6a21\u578b\u6e90\u4e8eHavard\u7684OS161\u7684\u6587\u4ef6\u7cfb\u7edf\u548cLinux\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u5176\u5b9e\u8fd9\u4e8c\u8005\u90fd\u662f\u6e90\u4e8e\u4f20\u7edf\u7684UNIX\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u3002UNIX\u63d0\u51fa\u4e86\u56db\u4e2a\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u6982\u5ff5\uff1a\u6587\u4ef6(file)\u3001\u76ee\u5f55\u9879(dentry)\u3001\u7d22\u5f15\u8282\u70b9(inode)\u548c\u5b89\u88c5\u70b9(mount point)\u3002</p> <ul> <li>\u6587\u4ef6\uff1aUNIX\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u53ef\u7406\u89e3\u4e3a\u662f\u4e00\u6709\u5e8f\u5b57\u8282buffer\uff0c\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a\u65b9\u4fbf\u5e94\u7528\u7a0b\u5e8f\u8bc6\u522b\u7684\u6587\u4ef6\u540d\u79f0\uff08\u4e5f\u79f0\u6587\u4ef6\u8def\u5f84\u540d\uff09\u3002\u5178\u578b\u7684\u6587\u4ef6\u64cd\u4f5c\u6709\u8bfb\u3001\u5199\u3001\u521b\u5efa\u548c\u5220\u9664\u7b49\u3002</li> <li>\u76ee\u5f55\u9879\uff1a\u76ee\u5f55\u9879\u4e0d\u662f\u76ee\u5f55\uff08\u53c8\u79f0\u6587\u4ef6\u8def\u5f84\uff09\uff0c\u800c\u662f\u76ee\u5f55\u7684\u7ec4\u6210\u90e8\u5206\u3002\u5728UNIX\u4e2d\u76ee\u5f55\u88ab\u770b\u4f5c\u4e00\u79cd\u7279\u5b9a\u7684\u6587\u4ef6\uff0c\u800c\u76ee\u5f55\u9879\u662f\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u90e8\u5206\u3002\u5982\u4e00\u4e2a\u6587\u4ef6\u8def\u5f84\u540d\u662f\u201c/test/testfile\u201d\uff0c\u5219\u5305\u542b\u7684\u76ee\u5f55\u9879\u4e3a\uff1a\u6839\u76ee\u5f55\u201c/\u201d\uff0c\u76ee\u5f55\u201ctest\u201d\u548c\u6587\u4ef6\u201ctestfile\u201d\uff0c\u8fd9\u4e09\u4e2a\u90fd\u662f\u76ee\u5f55\u9879\u3002\u4e00\u822c\u800c\u8a00\uff0c\u76ee\u5f55\u9879\u5305\u542b\u76ee\u5f55\u9879\u7684\u540d\u5b57\uff08\u6587\u4ef6\u540d\u6216\u76ee\u5f55\u540d\uff09\u548c\u76ee\u5f55\u9879\u7684\u7d22\u5f15\u8282\u70b9\uff08\u89c1\u4e0b\u9762\u7684\u63cf\u8ff0\uff09\u4f4d\u7f6e\u3002</li> <li>\u7d22\u5f15\u8282\u70b9\uff1aUNIX\u5c06\u6587\u4ef6\u7684\u76f8\u5173\u5143\u6570\u636e\u4fe1\u606f\uff08\u5982\u8bbf\u95ee\u63a7\u5236\u6743\u9650\u3001\u5927\u5c0f\u3001\u62e5\u6709\u8005\u3001\u521b\u5efa\u65f6\u95f4\u3001\u6570\u636e\u5185\u5bb9\u7b49\u7b49\u4fe1\u606f\uff09\u5b58\u50a8\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u8be5\u7ed3\u6784\u88ab\u79f0\u4e3a\u7d22\u5f15\u8282\u70b9\u3002</li> <li>\u5b89\u88c5\u70b9\uff1a\u5728UNIX\u4e2d\uff0c\u6587\u4ef6\u7cfb\u7edf\u88ab\u5b89\u88c5\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u6587\u4ef6\u8def\u5f84\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f\u5b89\u88c5\u70b9\u3002\u6240\u6709\u7684\u5df2\u5b89\u88c5\u6587\u4ef6\u7cfb\u7edf\u90fd\u4f5c\u4e3a\u6839\u6587\u4ef6\u7cfb\u7edf\u6811\u4e2d\u7684\u53f6\u5b50\u51fa\u73b0\u5728\u7cfb\u7edf\u4e2d\u3002</li> </ul> <p>\u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u5f62\u6210\u4e86UNIX\u6587\u4ef6\u7cfb\u7edf\u7684\u903b\u8f91\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u67b6\u6784\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u628a\u4e0a\u8ff0\u4fe1\u606f\u6620\u5c04\u5e76\u50a8\u5b58\u5230\u78c1\u76d8\u4ecb\u8d28\u4e0a\uff0c\u4ece\u800c\u5728\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u5e03\u5c40\uff08\u5373\u6570\u636e\u5728\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u7ec4\u7ec7\uff09\u4e0a\u5177\u4f53\u4f53\u73b0\u51fa\u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u3002\u6bd4\u5982\u6587\u4ef6\u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u5728\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u4e0a\u3002\u5f53\u6587\u4ef6\u88ab\u8f7d\u5165\u5185\u5b58\u65f6\uff0c\u5185\u6838\u9700\u8981\u4f7f\u7528\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u70b9\u6765\u6784\u9020\u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u3002</p> <p>ucore\u6a21\u4eff\u4e86UNIX\u7684\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\uff0cucore\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u4e3b\u8981\u7531\u56db\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li> <p>\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\uff1a\u8be5\u5c42\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4ece\u7528\u6237\u7a7a\u95f4\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u51c6\u8bbf\u95ee\u63a5\u53e3\u3002\u8fd9\u4e00\u5c42\u8bbf\u95ee\u63a5\u53e3\u8ba9\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u63a5\u53e3\u83b7\u5f97ucore\u5185\u6838\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002</p> </li> <li> <p>\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9b\u4e00\u4e2a\u4e00\u81f4\u7684\u63a5\u53e3\u7ed9\u5185\u6838\u5176\u4ed6\u90e8\u5206\uff08\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u6a21\u5757\u548c\u5176\u4ed6\u5185\u6838\u529f\u80fd\u6a21\u5757\uff09\u8bbf\u95ee\u3002\u5411\u4e0b\u63d0\u4f9b\u4e00\u4e2a\u540c\u6837\u7684\u62bd\u8c61\u51fd\u6570\u6307\u9488\u5217\u8868\u548c\u6570\u636e\u7ed3\u6784\u5c4f\u853d\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002</p> </li> <li> <p>Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff1a\u4e00\u4e2a\u57fa\u4e8e\u7d22\u5f15\u65b9\u5f0f\u7684\u7b80\u5355\u6587\u4ef6\u7cfb\u7edf\u5b9e\u4f8b\u3002\u5411\u4e0a\u901a\u8fc7\u5404\u79cd\u5177\u4f53\u51fd\u6570\u5b9e\u73b0\u4ee5\u5bf9\u5e94\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u63d0\u51fa\u7684\u62bd\u8c61\u51fd\u6570\u3002\u5411\u4e0b\u8bbf\u95ee\u5916\u8bbe\u63a5\u53e3</p> </li> <li> <p>\u5916\u8bbe\u63a5\u53e3\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9bdevice\u8bbf\u95ee\u63a5\u53e3\u5c4f\u853d\u4e0d\u540c\u786c\u4ef6\u7ec6\u8282\u3002\u5411\u4e0b\u5b9e\u73b0\u8bbf\u95ee\u5404\u79cd\u5177\u4f53\u8bbe\u5907\u9a71\u52a8\u7684\u63a5\u53e3\uff0c\u6bd4\u5982disk\u8bbe\u5907\u63a5\u53e3/\u4e32\u53e3\u8bbe\u5907\u63a5\u53e3/\u952e\u76d8\u8bbe\u5907\u63a5\u53e3\u7b49\u3002</p> </li> </ul> <p>\u5bf9\u7167\u4e0a\u9762\u7684\u5c42\u6b21\u6211\u4eec\u518d\u5927\u81f4\u4ecb\u7ecd\u4e00\u4e0b\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbf\u95ee\u5904\u7406\u8fc7\u7a0b\uff0c\u52a0\u6df1\u5bf9\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u7406\u89e3\u3002\u5047\u5982\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\u6587\u4ef6\uff08\u6253\u5f00/\u521b\u5efa/\u5220\u9664/\u8bfb\u5199\uff09\uff0c\u9996\u5148\u9700\u8981\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u7684\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u7ed9\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u7684\u8bbf\u95ee\u63a5\u53e3\u8fdb\u5165\u6587\u4ef6\u7cfb\u7edf\u5185\u90e8\uff0c\u63a5\u7740\u7531\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u628a\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u67d0\u4e00\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08\u6bd4\u5982SFS\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff09\u628a\u5e94\u7528\u7a0b\u5e8f\u7684\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u5316\u4e3a\u5bf9\u78c1\u76d8\u4e0a\u7684block\u7684\u5904\u7406\u8bf7\u6c42\uff0c\u5e76\u901a\u8fc7\u5916\u8bbe\u63a5\u53e3\u5c42\u4ea4\u7ed9\u78c1\u76d8\u9a71\u52a8\u4f8b\u7a0b\u6765\u5b8c\u6210\u5177\u4f53\u7684\u78c1\u76d8\u64cd\u4f5c\u3002\u7ed3\u5408\u7528\u6237\u6001\u5199\u6587\u4ef6\u51fd\u6570write\u7684\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u6e05\u695a\u5730\u770b\u51faucore\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u7684\u5c42\u6b21\u548c\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p> </p> <p>\u4eceucore\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u540c\u7684\u89d2\u5ea6\u6765\u770b\uff0cucore\u4e2d\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u5305\u542b\u56db\u7c7b\u4e3b\u8981\u7684\u6570\u636e\u7ed3\u6784, \u5b83\u4eec\u5206\u522b\u662f\uff1a</p> <ul> <li>\u8d85\u7ea7\u5757\uff08SuperBlock\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u89d2\u5ea6\u63cf\u8ff0\u7279\u5b9a\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002</li> <li>\u7d22\u5f15\u8282\u70b9\uff08inode\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5355\u4e2a\u6587\u4ef6\u7684\u89d2\u5ea6\u5b83\u63cf\u8ff0\u4e86\u6587\u4ef6\u7684\u5404\u79cd\u5c5e\u6027\u548c\u6570\u636e\u6240\u5728\u4f4d\u7f6e\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002</li> <li>\u76ee\u5f55\u9879\uff08dentry\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u8def\u5f84\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u5f55\u9879\uff08\u6ce8\uff1a\u4e00\u7cfb\u5217\u76ee\u5f55\u9879\u5f62\u6210\u76ee\u5f55/\u6587\u4ef6\u8def\u5f84\uff09\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002\u5bf9\u4e8eSFS\u800c\u8a00\uff0cinode(\u5177\u4f53\u4e3astruct sfs_disk_inode)\u5bf9\u5e94\u4e8e\u7269\u7406\u78c1\u76d8\u4e0a\u7684\u5177\u4f53\u5bf9\u8c61\uff0cdentry\uff08\u5177\u4f53\u4e3astruct sfs_disk_entry\uff09\u662f\u4e00\u4e2a\u5185\u5b58\u5b9e\u4f53\uff0c\u5176\u4e2d\u7684ino\u6210\u5458\u6307\u5411\u5bf9\u5e94\u7684inode number\uff0c\u53e6\u5916\u4e00\u4e2a\u6210\u5458\u662ffile name(\u6587\u4ef6\u540d).</li> <li>\u6587\u4ef6\uff08file\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u8fdb\u7a0b\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u5728\u8bbf\u95ee\u6587\u4ef6\u65f6\u9700\u8981\u4e86\u89e3\u7684\u6587\u4ef6\u6807\u8bc6\uff0c\u6587\u4ef6\u8bfb\u5199\u7684\u4f4d\u7f6e\uff0c\u6587\u4ef6\u5f15\u7528\u60c5\u51b5\u7b49\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u67d0\u4e00\u5177\u4f53\u8fdb\u7a0b\u3002</li> </ul> <p>\u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e86\u4e00\u4e2a\u6587\u4ef6\uff0c\u90a3\u4e48\u5728ucore\u4e2d\u6d89\u53ca\u7684\u76f8\u5173\u6570\u636e\u7ed3\u6784\uff08\u5176\u4e2d\u76f8\u5173\u6570\u636e\u7ed3\u6784\u5c06\u5728\u4e0b\u9762\u5404\u4e2a\u5c0f\u8282\u4e2d\u5c55\u5f00\u53d9\u8ff0\uff09\u548c\u5173\u7cfb\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p> </p>"},{"location":"lab8/intro/#_1","title":"\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3","text":"<p>\u6587\u4ef6\u548c\u76ee\u5f55\u76f8\u5173\u7528\u6237\u5e93\u51fd\u6570</p> <p>Lab8\u4e2d\u90e8\u5206\u7528\u6237\u5e93\u51fd\u6570\u4e0e\u6587\u4ef6\u7cfb\u7edf\u6709\u5173\uff0c\u6211\u4eec\u5148\u8ba8\u8bba\u5bf9\u5355\u4e2a\u6587\u4ef6\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7136\u540e\u8ba8\u8bba\u5bf9\u76ee\u5f55\u548c\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u3002</p> <p>\u5728\u6587\u4ef6\u64cd\u4f5c\u65b9\u9762\uff0c\u6700\u57fa\u672c\u7684\u76f8\u5173\u51fd\u6570\u662fopen\u3001close\u3001read\u3001write\u3002\u5728\u8bfb\u5199\u4e00\u4e2a\u6587\u4ef6\u4e4b\u524d\uff0c\u9996\u5148\u8981\u7528open\u7cfb\u7edf\u8c03\u7528\u5c06\u5176\u6253\u5f00\u3002open\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\u6587\u4ef6\u7684\u8def\u5f84\u540d\uff0c\u53ef\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u540d\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6307\u5b9a\u6253\u5f00\u7684\u65b9\u5f0f\uff0c\u53ef\u8bbe\u7f6e\u4e3aO_RDONLY\u3001O_WRONLY\u3001O_RDWR\uff0c\u5206\u522b\u8868\u793a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ef\u8bfb\u53ef\u5199\u3002\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u8fd4\u56de\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u5bf9\u6587\u4ef6\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\u3002\u5728\u4f7f\u7528\u5b8c\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u8fd8\u8981\u7528close\u7cfb\u7edf\u8c03\u7528\u628a\u5b83\u5173\u95ed\uff0c\u5176\u53c2\u6570\u5c31\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u3002\u8fd9\u6837\u5b83\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c31\u53ef\u4ee5\u7a7a\u51fa\u6765\uff0c\u7ed9\u522b\u7684\u6587\u4ef6\u4f7f\u7528\u3002</p> <p>\u8bfb\u5199\u6587\u4ef6\u5185\u5bb9\u7684\u7cfb\u7edf\u8c03\u7528\u662fread\u548cwrite\u3002read\u7cfb\u7edf\u8c03\u7528\u6709\u4e09\u4e2a\u53c2\u6570\uff1a\u4e00\u4e2a\u6307\u5b9a\u6240\u64cd\u4f5c\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u4e2a\u6307\u5b9a\u8bfb\u53d6\u6570\u636e\u7684\u5b58\u653e\u5730\u5740\uff0c\u6700\u540e\u4e00\u4e2a\u6307\u5b9a\u8bfb\u591a\u5c11\u4e2a\u5b57\u8282\u3002\u5728C\u7a0b\u5e8f\u4e2d\u8c03\u7528\u8be5\u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>count = read(filehandle, buffer, nbytes);\n</code></pre> <p>\u8be5\u7cfb\u7edf\u8c03\u7528\u4f1a\u628a\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570\u8fd4\u56de\u7ed9count\u53d8\u91cf\u3002\u5728\u6b63\u5e38\u60c5\u5f62\u4e0b\u8fd9\u4e2a\u503c\u4e0enbytes\u76f8\u7b49\uff0c\u4f46\u6709\u65f6\u53ef\u80fd\u4f1a\u5c0f\u4e00\u4e9b\u3002\u4f8b\u5982\uff0c\u5728\u8bfb\u6587\u4ef6\u65f6\u78b0\u4e0a\u4e86\u6587\u4ef6\u7ed3\u675f\u7b26\uff0c\u4ece\u800c\u63d0\u524d\u7ed3\u675f\u6b64\u6b21\u8bfb\u64cd\u4f5c\u3002</p> <p>\u5982\u679c\u7531\u4e8e\u53c2\u6570\u65e0\u6548\u6216\u78c1\u76d8\u8bbf\u95ee\u9519\u8bef\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u6b64\u6b21\u7cfb\u7edf\u8c03\u7528\u65e0\u6cd5\u5b8c\u6210\uff0c\u5219count\u88ab\u7f6e\u4e3a-1\u3002\u800cwrite\u51fd\u6570\u7684\u53c2\u6570\u4e0e\u4e4b\u5b8c\u5168\u76f8\u540c\u3002</p> <p>\u5bf9\u4e8e\u76ee\u5f55\u800c\u8a00\uff0c\u6700\u5e38\u7528\u7684\u64cd\u4f5c\u662f\u8df3\u8f6c\u5230\u67d0\u4e2a\u76ee\u5f55\uff0c\u8fd9\u91cc\u5bf9\u5e94\u7684\u7528\u6237\u5e93\u51fd\u6570\u662fchdir\u3002\u7136\u540e\u5c31\u9700\u8981\u8bfb\u76ee\u5f55\u7684\u5185\u5bb9\u4e86\uff0c\u5373\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u540d\uff0c\u8fd9\u5728\u5904\u7406\u4e0a\u4e0e\u8bfb\u6587\u4ef6\u7c7b\u4f3c\uff0c\u5373\u9700\u8981\u901a\u8fc7opendir\u51fd\u6570\u6253\u5f00\u76ee\u5f55\uff0c\u901a\u8fc7readdir\u6765\u83b7\u53d6\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u8bfb\u5b8c\u540e\u8fd8\u9700\u901a\u8fc7closedir\u51fd\u6570\u6765\u5173\u95ed\u76ee\u5f55\u3002\u7531\u4e8e\u5728ucore\u4e2d\u628a\u76ee\u5f55\u770b\u6210\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6587\u4ef6\uff0c\u6240\u4ee5opendir\u548cclosedir\u5b9e\u9645\u4e0a\u5c31\u662f\u8c03\u7528\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u548cclose\u51fd\u6570\u3002\u53ea\u6709readdir\u9700\u8981\u8c03\u7528\u83b7\u53d6\u76ee\u5f55\u5185\u5bb9\u7684\u7279\u6b8a\u7cfb\u7edf\u8c03\u7528sys_getdirentry\u3002\u800c\u4e14\u8fd9\u91cc\u6ca1\u6709\u5199\u76ee\u5f55\u8fd9\u4e00\u64cd\u4f5c\u3002\u5728\u76ee\u5f55\u4e2d\u589e\u52a0\u5185\u5bb9\u5176\u5b9e\u5c31\u662f\u5728\u6b64\u76ee\u5f55\u4e2d\u521b\u5efa\u6587\u4ef6\uff0c\u9700\u8981\u7528\u5230\u521b\u5efa\u6587\u4ef6\u7684\u51fd\u6570\u3002</p> <p>\u6587\u4ef6\u548c\u76ee\u5f55\u8bbf\u95ee\u76f8\u5173\u7cfb\u7edf\u8c03\u7528</p> <p>\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u3001close\u3001read\u3001write\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_open\u3001sys_close\u3001sys_read\u3001sys_write\u56db\u4e2a\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002\u4e0e\u76ee\u5f55\u76f8\u5173\u7684readdir\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_getdirentry\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u63a5\u53e3\u5c06\u901a\u8fc7syscall\u51fd\u6570\u6765\u83b7\u5f97ucore\u7684\u5185\u6838\u670d\u52a1\u3002\u5f53\u5230\u4e86ucore\u5185\u6838\u540e\uff0c\u5728\u8c03\u7528\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684file\u63a5\u53e3\u548cdir\u63a5\u53e3\u3002</p>"},{"location":"lab8/lab8/","title":"\u5b9e\u9a8c\u516b\uff1a\u6587\u4ef6\u7cfb\u7edf","text":""},{"location":"lab8/lab8/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<p>\u901a\u8fc7\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\uff0c\u5e0c\u671b\u80fd\u8fbe\u5230\u4ee5\u4e0b\u76ee\u6807</p> <ul> <li>\u4e86\u89e3\u57fa\u672c\u7684\u6587\u4ef6\u7cfb\u7edf\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\u65b9\u6cd5\uff1b</li> <li>\u4e86\u89e3\u4e00\u4e2a\u57fa\u4e8e\u7d22\u5f15\u8282\u70b9\u7ec4\u7ec7\u65b9\u5f0f\u7684Simple FS\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff1b</li> <li>\u4e86\u89e3\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42-VFS\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff1b</li> </ul>"},{"location":"lab8/lab8/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u9a8c\u4e03\u5b8c\u6210\u4e86\u5728\u5185\u6838\u4e2d\u7684\u540c\u6b65\u4e92\u65a5\u5b9e\u9a8c\u3002\u672c\u6b21\u5b9e\u9a8c\u6d89\u53ca\u7684\u662f\u6587\u4ef6\u7cfb\u7edf\uff0c\u901a\u8fc7\u5206\u6790\u4e86\u89e3ucore\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u67b6\u6784\u8bbe\u8ba1\uff0c\u5b8c\u5584\u8bfb\u5199\u6587\u4ef6\u64cd\u4f5c\uff0c\u4ece\u65b0\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\uff08\u5373\u6539\u5199do_execve\uff09\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u6267\u884c\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u548c\u5b9e\u73b0\u6587\u4ef6\u8bfb\u5199\u7b49\u529f\u80fd\u3002</p>"},{"location":"lab8/lab8/#_4","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0","text":"<p>\u4e0e\u5b9e\u9a8c\u4e03\u76f8\u6bd4\uff0c\u5b9e\u9a8c\u516b\u589e\u52a0\u4e86\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u56e0\u6b64\u5b9e\u73b0\u4e86\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6765\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u5230\u5185\u5b58\u4e2d\u8fd0\u884c\u7684\u529f\u80fd\uff0c\u5bfc\u81f4\u5bf9\u8fdb\u7a0b\u7ba1\u7406\u76f8\u5173\u7684\u5b9e\u73b0\u6bd4\u8f83\u5927\u7684\u8c03\u6574\u3002\u6211\u4eec\u6765\u7b80\u5355\u770b\u770b\u6587\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u521d\u59cb\u5316\u5e76\u80fd\u5728ucore\u7684\u7ba1\u7406\u4e0b\u6b63\u5e38\u5de5\u4f5c\u7684\u3002</p> <p>\u9996\u5148\u770b\u770bkern_init\u51fd\u6570\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e0elab7\u76f8\u6bd4\u589e\u52a0\u4e86\u5bf9fs_init\u51fd\u6570\u7684\u8c03\u7528\u3002fs_init\u51fd\u6570\u5c31\u662f\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570\uff0c\u5b83\u8fdb\u4e00\u6b65\u8c03\u7528\u4e86\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u51fd\u6570vfs_init\uff0c\u4e0e\u6587\u4ef6\u76f8\u5173\u7684\u8bbe\u5907\u521d\u59cb\u5316\u51fd\u6570dev_init\u548cSimple FS\u6587\u4ef6\u7cfb\u7edf\u7684\u521d\u59cb\u5316\u51fd\u6570sfs_init\u3002\u8fd9\u4e09\u4e2a\u521d\u59cb\u5316\u51fd\u6570\u8054\u5408\u5728\u4e00\u8d77\uff0c\u534f\u540c\u5b8c\u6210\u4e86\u6574\u4e2a\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u3001SFS\u6587\u4ef6\u7cfb\u7edf\u548c\u6587\u4ef6\u7cfb\u7edf\u5bf9\u5e94\u7684\u8bbe\u5907\uff08\u952e\u76d8\u3001\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u7684\u521d\u59cb\u5316\u5de5\u4f5c\u3002\u5176\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u8c03\u7528\u5173\u7cfb\u56fe</p> <p>\u53c2\u8003\u4e0a\u56fe\uff0c\u5e76\u7ed3\u5408\u6e90\u7801\u5206\u6790\uff0c\u53ef\u5927\u81f4\u4e86\u89e3\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6574\u4e2a\u521d\u59cb\u5316\u6d41\u7a0b\u3002vfs_init\u4e3b\u8981\u5efa\u7acb\u4e86\u4e00\u4e2adevice list\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u4e3a\u540e\u7eed\u5177\u4f53\u8bbe\u5907\uff08\u952e\u76d8\u3001\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u5448\u73b0\u5efa\u7acb\u67e5\u627e\u8bbf\u95ee\u901a\u9053\u3002dev_init\u51fd\u6570\u901a\u8fc7\u8fdb\u4e00\u6b65\u8c03\u7528disk0/stdin/stdout_device_init\u5b8c\u6210\u5bf9\u5177\u4f53\u8bbe\u5907\u7684\u521d\u59cb\u5316\uff0c\u628a\u5b83\u4eec\u62bd\u8c61\u6210\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u5e76\u5efa\u7acb\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u6700\u540e\u628a\u5b83\u4eec\u94fe\u5165\u5230vdev_list\u4e2d\u3002\u8fd9\u6837\u901a\u8fc7\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u8bbf\u95ee\u8fd9\u4e9b\u8bbe\u5907\u4e86\u3002sfs_init\u662f\u5b8c\u6210\u5bf9Simple FS\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5e76\u628a\u6b64\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u6302\u5728\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4ece\u800c\u8ba9ucore\u7684\u5176\u4ed6\u90e8\u5206\u80fd\u591f\u901a\u8fc7\u8bbf\u95ee\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u7684\u63a5\u53e3\u6765\u8fdb\u4e00\u6b65\u8bbf\u95ee\u5230SFS\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u3002</p>"},{"location":"lab8/sfs/","title":"Simple File System","text":""},{"location":"lab8/sfs/#simple-fs","title":"Simple FS \u6587\u4ef6\u7cfb\u7edf","text":"<p>\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u6309\u7167\u4ece\u4e0a\u5230\u4e0b\u5148\u8bb2\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u518d\u8bb2\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u8fd9\u662f\u7531\u4e8e\u5982\u679c\u80fd\u591f\u7406\u89e3Simple FS\uff08\u7b80\u79f0SFS\uff09\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c31\u53ef\u66f4\u597d\u5730\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u8bbe\u8ba1\u3002\u5373\u4ece\u5177\u4f53\u8d70\u5411\u62bd\u8c61\u3002ucore\u5185\u6838\u628a\u6240\u6709\u6587\u4ef6\u90fd\u770b\u4f5c\u662f\u5b57\u8282\u6d41\uff0c\u4efb\u4f55\u5185\u90e8\u903b\u8f91\u7ed3\u6784\u90fd\u662f\u4e13\u7528\u7684\uff0c\u7531\u5e94\u7528\u7a0b\u5e8f\u8d1f\u8d23\u89e3\u91ca\u3002\u4f46\u662fucore\u533a\u5206\u6587\u4ef6\u7684\u7269\u7406\u7ed3\u6784\u3002ucore\u76ee\u524d\u652f\u6301\u5982\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684\u6587\u4ef6\uff1a</p> <ul> <li>\u5e38\u89c4\u6587\u4ef6\uff1a\u6587\u4ef6\u4e2d\u5305\u62ec\u7684\u5185\u5bb9\u4fe1\u606f\u662f\u7531\u5e94\u7528\u7a0b\u5e8f\u8f93\u5165\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u5728\u666e\u901a\u6587\u4ef6\u4e0a\u4e0d\u5f3a\u52a0\u4efb\u4f55\u5185\u90e8\u7ed3\u6784\uff0c\u628a\u5176\u6587\u4ef6\u5185\u5bb9\u4fe1\u606f\u770b\u4f5c\u4e3a\u5b57\u8282\u3002</li> <li>\u76ee\u5f55\uff1a\u5305\u542b\u4e00\u7cfb\u5217\u7684entry\uff0c\u6bcf\u4e2aentry\u5305\u542b\u6587\u4ef6\u540d\u548c\u6307\u5411\u4e0e\u4e4b\u76f8\u5173\u8054\u7684\u7d22\u5f15\u8282\u70b9\uff08index node\uff09\u7684\u6307\u9488\u3002\u76ee\u5f55\u662f\u6309\u5c42\u6b21\u7ed3\u6784\u7ec4\u7ec7\u7684\u3002</li> <li>\u94fe\u63a5\u6587\u4ef6\uff1a\u5b9e\u9645\u4e0a\u4e00\u4e2a\u94fe\u63a5\u6587\u4ef6\u662f\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u6587\u4ef6\u7684\u53e6\u4e00\u4e2a\u53ef\u9009\u62e9\u7684\u6587\u4ef6\u540d\u3002</li> <li>\u8bbe\u5907\u6587\u4ef6\uff1a\u4e0d\u5305\u542b\u6570\u636e\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6620\u5c04\u7269\u7406\u8bbe\u5907\uff08\u5982\u4e32\u53e3\u3001\u952e\u76d8\u7b49\uff09\u5230\u4e00\u4e2a\u6587\u4ef6\u540d\u7684\u673a\u5236\u3002\u53ef\u901a\u8fc7\u8bbe\u5907\u6587\u4ef6\u8bbf\u95ee\u5916\u56f4\u8bbe\u5907\u3002</li> <li>\u7ba1\u9053\uff1a\u7ba1\u9053\u662f\u8fdb\u7a0b\u95f4\u901a\u8baf\u7684\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u3002\u7ba1\u9053\u7f13\u5b58\u4e86\u5176\u8f93\u5165\u7aef\u6240\u63a5\u53d7\u7684\u6570\u636e\uff0c\u4ee5\u4fbf\u5728\u7ba1\u9053\u8f93\u51fa\u7aef\u8bfb\u7684\u8fdb\u7a0b\u80fd\u4e00\u4e2a\u5148\u8fdb\u5148\u51fa\u7684\u65b9\u5f0f\u6765\u63a5\u53d7\u6570\u636e\u3002</li> </ul> <p>\u5728lab8\u4e2d\u5173\u6ce8\u7684\u4e3b\u8981\u662fSFS\u652f\u6301\u7684\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u94fe\u63a5\u4e2d\u7684 hardlink \u7684\u8bbe\u8ba1\u5b9e\u73b0\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\u5177\u6709\u5171\u540c\u7684\u5c5e\u6027\uff0c\u800c\u8fd9\u4e9b\u5c5e\u6027\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002SFS\u901a\u8fc7\u7d22\u5f15\u8282\u70b9\u6765\u7ba1\u7406\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\uff0c\u7d22\u5f15\u8282\u70b9\u5305\u542b\u64cd\u4f5c\u7cfb\u7edf\u6240\u9700\u8981\u7684\u5173\u4e8e\u67d0\u4e2a\u6587\u4ef6\u7684\u5173\u952e\u4fe1\u606f\uff0c\u6bd4\u5982\u6587\u4ef6\u7684\u5c5e\u6027\u3001\u8bbf\u95ee\u8bb8\u53ef\u6743\u4ee5\u53ca\u5176\u5b83\u63a7\u5236\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002\u53ef\u4ee5\u6709\u591a\u4e2a\u6587\u4ef6\u540d\u53ef\u6307\u5411\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\u3002</p>"},{"location":"lab8/sfs/#_1","title":"\u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u901a\u5e38\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u91c7\u7528\u5185\u5b58\u6a21\u62df\u78c1\u76d8\u3002\u6211\u4eec\u5728ucore\u7f16\u8bd1\u65f6\u4f1a\u751f\u6210\u4e00\u4e2ainitrd\u955c\u50cf\uff08\u5373ucore\u4e2d\u7684disk0\uff09\u7528\u4e8e\u5b58\u653e\u4e00\u4e2aSFS\u6587\u4ef6\u7cfb\u7edf\uff08Simple Filesystem\uff09\uff0c\u5b83\u662f\u4e00\u4e2a\u4f7f\u7528\u5185\u5b58\u6a21\u62df\u7684\u78c1\u76d8\uff0c\u5e76\u5c06\u78c1\u76d8\u955c\u50cf\u4e0e\u5185\u6838\u94fe\u63a5\u5728\u4e00\u8d77\u4e0e\u5185\u6838\u4e00\u8d77\u52a0\u8f7d\u5230\u5185\u5b58\u3002\u901a\u5e38\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u78c1\u76d8\u7684\u4f7f\u7528\u662f\u4ee5\u6247\u533a\uff08Sector\uff09\u4e3a\u5355\u4f4d\u7684\uff0c\u4f46\u662f\u4e3a\u4e86\u5b9e\u73b0\u7b80\u4fbf\uff0cSFS \u4e2d\u4ee5 block \uff084K\uff0c\u4e0e\u5185\u5b58 page \u5927\u5c0f\u76f8\u7b49\uff09\u4e3a\u57fa\u672c\u5355\u4f4d\u3002</p> <p>SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u7b2c0\u4e2a\u5757\uff084K\uff09\u662f\u8d85\u7ea7\u5757\uff08superblock\uff09\uff0c\u5b83\u5305\u542b\u4e86\u5173\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6240\u6709\u5173\u952e\u53c2\u6570\uff0c\u5f53\u8ba1\u7b97\u673a\u88ab\u542f\u52a8\u6216\u6587\u4ef6\u7cfb\u7edf\u88ab\u9996\u6b21\u63a5\u89e6\u65f6\uff0c\u8d85\u7ea7\u5757\u7684\u5185\u5bb9\u5c31\u4f1a\u88ab\u88c5\u5165\u5185\u5b58\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct sfs_super {\n    uint32_t magic;                                  /* magic number, should be SFS_MAGIC */\n    uint32_t blocks;                                 /* # of blocks in fs */\n    uint32_t unused_blocks;                         /* # of unused blocks in fs */\n    char info[SFS_MAX_INFO_LEN + 1];                /* infomation for sfs  */\n};\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5305\u542b\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\u9b54\u6570magic\uff0c\u5176\u503c\u4e3a0x2f8dbe2a\uff0c\u5185\u6838\u901a\u8fc7\u5b83\u6765\u68c0\u67e5\u78c1\u76d8\u955c\u50cf\u662f\u5426\u662f\u5408\u6cd5\u7684 SFS img\uff1b\u6210\u5458\u53d8\u91cfblocks\u8bb0\u5f55\u4e86SFS\u4e2d\u6240\u6709block\u7684\u6570\u91cf\uff0c\u5373 img \u7684\u5927\u5c0f\uff1b\u6210\u5458\u53d8\u91cfunused_block\u8bb0\u5f55\u4e86SFS\u4e2d\u8fd8\u6ca1\u6709\u88ab\u4f7f\u7528\u7684block\u7684\u6570\u91cf\uff1b\u6210\u5458\u53d8\u91cfinfo\u5305\u542b\u4e86\u5b57\u7b26\u4e32\"simple file system\"\u3002</p> <p>\u7b2c1\u4e2a\u5757\u653e\u4e86\u4e00\u4e2aroot-dir\u7684inode\uff0c\u7528\u6765\u8bb0\u5f55\u6839\u76ee\u5f55\u7684\u76f8\u5173\u4fe1\u606f\u3002\u6709\u5173inode\u8fd8\u5c06\u5728\u540e\u7eed\u90e8\u5206\u4ecb\u7ecd\u3002\u8fd9\u91cc\u53ea\u8981\u7406\u89e3root-dir\u662fSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u7ed3\u70b9\uff0c\u901a\u8fc7\u8fd9\u4e2aroot-dir\u7684inode\u4fe1\u606f\u5c31\u53ef\u4ee5\u5b9a\u4f4d\u5e76\u67e5\u627e\u5230\u6839\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u4fe1\u606f\u3002</p> <p>\u4ece\u7b2c2\u4e2a\u5757\u5f00\u59cb\uff0c\u6839\u636eSFS\u4e2d\u6240\u6709\u5757\u7684\u6570\u91cf\uff0c\u75281\u4e2abit\u6765\u8868\u793a\u4e00\u4e2a\u5757\u7684\u5360\u7528\u548c\u672a\u88ab\u5360\u7528\u7684\u60c5\u51b5\u3002\u8fd9\u4e2a\u533a\u57df\u79f0\u4e3aSFS\u7684freemap\u533a\u57df\uff0c\u8fd9\u5c06\u5360\u7528\u82e5\u5e72\u4e2a\u5757\u7a7a\u95f4\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u8bb0\u5f55\u548c\u7ba1\u7406freemap\u533a\u57df\uff0c\u4e13\u95e8\u63d0\u4f9b\u4e86\u4e24\u4e2a\u6587\u4ef6kern/fs/sfs/bitmap.[ch]\u6765\u5b8c\u6210\u6839\u636e\u4e00\u4e2a\u5757\u53f7\u67e5\u627e\u6216\u8bbe\u7f6e\u5bf9\u5e94\u7684bit\u4f4d\u7684\u503c\u3002</p> <p>\u6700\u540e\u5728\u5269\u4f59\u7684\u78c1\u76d8\u7a7a\u95f4\u4e2d\uff0c\u5b58\u653e\u4e86\u6240\u6709\u5176\u4ed6\u76ee\u5f55\u548c\u6587\u4ef6\u7684inode\u4fe1\u606f\u548c\u5185\u5bb9\u6570\u636e\u4fe1\u606f\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u867d\u7136inode\u7684\u5927\u5c0f\u5c0f\u4e8e\u4e00\u4e2a\u5757\u7684\u5927\u5c0f\uff084096B\uff09\uff0c\u4f46\u4e3a\u4e86\u5b9e\u73b0\u7b80\u5355\uff0c\u6bcf\u4e2a inode \u90fd\u5360\u7528\u4e00\u4e2a\u5b8c\u6574\u7684 block\u3002</p> <p>\u5728sfs_fs.c\u6587\u4ef6\u4e2d\u7684sfs_do_mount\u51fd\u6570\u4e2d\uff0c\u5b8c\u6210\u4e86\u52a0\u8f7d\u4f4d\u4e8e\u786c\u76d8\u4e0a\u7684SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757superblock\u548cfreemap\u7684\u5de5\u4f5c\u3002\u8fd9\u6837\uff0c\u5728\u5185\u5b58\u4e2d\u5c31\u6709\u4e86SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002</p>"},{"location":"lab8/sfs/#_2","title":"\u7d22\u5f15\u8282\u70b9","text":"<p>\u5728SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u9700\u8981\u8bb0\u5f55\u6587\u4ef6\u5185\u5bb9\u7684\u5b58\u50a8\u4f4d\u7f6e\u4ee5\u53ca\u6587\u4ef6\u540d\u4e0e\u6587\u4ef6\u5185\u5bb9\u7684\u5bf9\u5e94\u5173\u7cfb\u3002sfs_disk_inode\u8bb0\u5f55\u4e86\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5185\u5bb9\u5b58\u50a8\u7684\u7d22\u5f15\u4fe1\u606f\uff0c\u8be5\u6570\u636e\u7ed3\u6784\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002sfs_disk_entry\u8868\u793a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5305\u542b\u8be5\u9879\u6240\u5bf9\u5e94inode\u7684\u4f4d\u7f6e\u548c\u6587\u4ef6\u540d\uff0c\u540c\u6837\u4e5f\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002</p> <p>\u78c1\u76d8\u7d22\u5f15\u8282\u70b9</p> <p>SFS\u4e2d\u7684\u78c1\u76d8\u7d22\u5f15\u8282\u70b9\u4ee3\u8868\u4e86\u4e00\u4e2a\u5b9e\u9645\u4f4d\u4e8e\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u3002\u9996\u5148\u6211\u4eec\u770b\u770b\u5728\u786c\u76d8\u4e0a\u7684\u7d22\u5f15\u8282\u70b9\u7684\u5185\u5bb9\uff1a</p> <pre><code>struct sfs_disk_inode {\n    uint32_t size;                              \u5982\u679cinode\u8868\u793a\u5e38\u89c4\u6587\u4ef6\uff0c\u5219size\u662f\u6587\u4ef6\u5927\u5c0f\n    uint16_t type;                                  inode\u7684\u6587\u4ef6\u7c7b\u578b\n    uint16_t nlinks;                               \u6b64inode\u7684\u786c\u94fe\u63a5\u6570\n    uint32_t blocks;                              \u6b64inode\u7684\u6570\u636e\u5757\u6570\u7684\u4e2a\u6570\n    uint32_t direct[SFS_NDIRECT];                \u6b64inode\u7684\u76f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c\uff08\u6709SFS_NDIRECT\u4e2a\uff09\n    uint32_t indirect;                            \u6b64inode\u7684\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c\n};\n</code></pre> <p>\u901a\u8fc7\u4e0a\u8868\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cinode\u8868\u793a\u7684\u662f\u6587\u4ef6\uff0c\u5219\u6210\u5458\u53d8\u91cfdirect[]\u76f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u3002indirect\u95f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\uff0cindirect\u6307\u5411\u7684\u662f\u95f4\u63a5\u6570\u636e\u5757\uff08indirect block\uff09\uff0c\u6b64\u6570\u636e\u5757\u5b9e\u9645\u5b58\u653e\u7684\u5168\u90e8\u662f\u6570\u636e\u5757\u7d22\u5f15\uff0c\u8fd9\u4e9b\u6570\u636e\u5757\u7d22\u5f15\u6307\u5411\u7684\u6570\u636e\u5757\u624d\u88ab\u7528\u6765\u5b58\u653e\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u3002</p> <p>\u9ed8\u8ba4\u7684\uff0cucore \u91cc SFS_NDIRECT \u662f 12\uff0c\u5373\u76f4\u63a5\u7d22\u5f15\u7684\u6570\u636e\u9875\u5927\u5c0f\u4e3a 12 * 4k = 48k\uff1b\u5f53\u4f7f\u7528\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u65f6\uff0cucore \u652f\u6301\u6700\u5927\u7684\u6587\u4ef6\u5927\u5c0f\u4e3a 12 * 4k + 1024 * 4k = 48k + 4m\u3002\u6570\u636e\u7d22\u5f15\u8868\u5185\uff0c0 \u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684\u7d22\u5f15\uff0cinode \u91cc blocks \u8868\u793a\u8be5\u6587\u4ef6\u6216\u8005\u76ee\u5f55\u5360\u7528\u7684\u78c1\u76d8\u7684 block \u7684\u4e2a\u6570\u3002indiret \u4e3a 0 \u65f6\uff0c\u8868\u793a\u4e0d\u4f7f\u7528\u4e00\u7ea7\u7d22\u5f15\u5757\u3002\uff08\u56e0\u4e3a block 0 \u7528\u6765\u4fdd\u5b58 super block\uff0c\u5b83\u4e0d\u53ef\u80fd\u88ab\u5176\u4ed6\u4efb\u4f55\u6587\u4ef6\u6216\u76ee\u5f55\u4f7f\u7528\uff0c\u6240\u4ee5\u8fd9\u4e48\u8bbe\u8ba1\u4e5f\u662f\u5408\u7406\u7684\uff09\u3002</p> <p>\u5bf9\u4e8e\u666e\u901a\u6587\u4ef6\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684 block \u4e2d\u4fdd\u5b58\u7684\u662f\u6587\u4ef6\u4e2d\u7684\u6570\u636e\u3002\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684\u6570\u636e\u4fdd\u5b58\u7684\u662f\u76ee\u5f55\u4e0b\u6240\u6709\u7684\u6587\u4ef6\u540d\u4ee5\u53ca\u5bf9\u5e94\u7684\u7d22\u5f15\u8282\u70b9\u6240\u5728\u7684\u7d22\u5f15\u5757\uff08\u78c1\u76d8\u5757\uff09\u6240\u5f62\u6210\u7684\u6570\u7ec4\u3002\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>/* file entry (on disk) */\nstruct sfs_disk_entry {\n    uint32_t ino;                                   \u7d22\u5f15\u8282\u70b9\u6240\u5360\u6570\u636e\u5757\u7d22\u5f15\u503c\n    char name[SFS_MAX_FNAME_LEN + 1];               \u6587\u4ef6\u540d\n};\n</code></pre> <p>\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0b\u7684 inode \u90fd\u5e94\u8be5\u5206\u914d\u552f\u4e00\u7684 inode \u7f16\u53f7\u3002SFS \u4e0b\uff0c\u4e3a\u4e86\u5b9e\u73b0\u7684\u7b80\u4fbf\uff08\u5077\u61d2\uff09\uff0c\u6bcf\u4e2a inode \u76f4\u63a5\u7528\u4ed6\u6240\u5728\u7684\u78c1\u76d8 block \u7684\u7f16\u53f7\u4f5c\u4e3a inode \u7f16\u53f7\u3002\u6bd4\u5982\uff0croot block \u7684 inode \u7f16\u53f7\u4e3a 1\uff1b\u6bcf\u4e2a sfs_disk_entry \u6570\u636e\u7ed3\u6784\u4e2d\uff0cname \u8868\u793a\u76ee\u5f55\u4e0b\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684\u540d\u79f0\uff0cino \u8868\u793a\u78c1\u76d8 block \u7f16\u53f7\uff0c\u901a\u8fc7\u8bfb\u53d6\u8be5 block \u7684\u6570\u636e\uff0c\u80fd\u591f\u5f97\u5230\u76f8\u5e94\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684 inode\u3002ino \u4e3a0\u65f6\uff0c\u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684 entry\u3002</p> <p>\u6b64\u5916\uff0c\u548c inode \u76f8\u4f3c\uff0c\u6bcf\u4e2a sfs_dirent_entry \u4e5f\u5360\u7528\u4e00\u4e2a block\u3002</p> <p>\u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9</p> <pre><code>/* inode for sfs */\nstruct sfs_inode {\n    struct sfs_disk_inode *din;                     /* on-disk inode */\n    uint32_t ino;                                   /* inode number */\n    uint32_t flags;                                 /* inode flags */\n    bool dirty;                                     /* true if inode modified */\n    int reclaim_count;                              /* kill inode if it hits zero */\n    semaphore_t sem;                                /* semaphore for din */\n    list_entry_t inode_link;                        /* entry for linked-list in sfs_fs */\n    list_entry_t hash_link;                         /* entry for hash linked-list in sfs_fs */\n};\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230SFS\u4e2d\u7684\u5185\u5b58inode\u5305\u542b\u4e86SFS\u7684\u786c\u76d8inode\u4fe1\u606f\uff0c\u800c\u4e14\u8fd8\u589e\u52a0\u4e86\u5176\u4ed6\u4e00\u4e9b\u4fe1\u606f\uff0c\u8fd9\u5c5e\u4e8e\u662f\u4fbf\u4e8e\u8fdb\u884c\u662f\u5224\u65ad\u5426\u6539\u5199\u3001\u4e92\u65a5\u64cd\u4f5c\u3001\u56de\u6536\u548c\u5feb\u901f\u5730\u5b9a\u4f4d\u7b49\u4f5c\u7528\u3002\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e2a\u5185\u5b58inode\u662f\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\u624d\u521b\u5efa\u7684\uff0c\u5982\u679c\u5173\u673a\u5219\u76f8\u5173\u4fe1\u606f\u90fd\u4f1a\u6d88\u5931\u3002\u800c\u786c\u76d8inode\u7684\u5185\u5bb9\u662f\u4fdd\u5b58\u5728\u786c\u76d8\u4e2d\u7684\uff0c\u53ea\u662f\u5728\u8fdb\u7a0b\u9700\u8981\u65f6\u624d\u88ab\u8bfb\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u7528\u4e8e\u8bbf\u95ee\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5177\u4f53\u5185\u5bb9\u6570\u636e</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u5b9e\u73b0\u4e0a\u9762\u63d0\u5230\u7684\u591a\u7ea7\u6570\u636e\u7684\u8bbf\u95ee\u4ee5\u53ca\u76ee\u5f55\u4e2d entry \u7684\u64cd\u4f5c\uff0c\u5bf9 inode SFS\u5b9e\u73b0\u4e86\u4e00\u4e9b\u8f85\u52a9\u7684\u51fd\u6570\uff1a</p> <ol> <li>sfs_bmap_load_nolock\uff1a\u5c06\u5bf9\u5e94 sfs_inode \u7684\u7b2c index \u4e2a\u7d22\u5f15\u6307\u5411\u7684 block \u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u8be5\u51fd\u6570\u53ea\u63a5\u53d7 index &lt;= inode-&gt;blocks \u7684\u53c2\u6570\u3002\u5f53 index == inode-&gt;blocks \u65f6\uff0c\u8be5\u51fd\u6570\u7406\u89e3\u4e3a\u9700\u8981\u4e3a inode \u589e\u957f\u4e00\u4e2a block\u3002\u5e76\u6807\u8bb0 inode \u4e3a dirty\uff08\u6240\u6709\u5bf9 inode \u6570\u636e\u7684\u4fee\u6539\u90fd\u8981\u505a\u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u8fd9\u6837\uff0c\u5f53 inode \u4e0d\u518d\u4f7f\u7528\u7684\u65f6\u5019\uff0csfs \u80fd\u591f\u4fdd\u8bc1 inode \u6570\u636e\u80fd\u591f\u88ab\u5199\u56de\u5230\u78c1\u76d8\uff09\u3002sfs_bmap_load_nolock \u8c03\u7528\u7684 sfs_bmap_get_nolock \u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u9605\u8bfb sfs_bmap_get_nolock\uff0c\u4e86\u89e3\u4ed6\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002\uff08sfs_bmap_get_nolock \u53ea\u7531 sfs_bmap_load_nolock \u8c03\u7528\uff09   </li> <li>sfs_bmap_truncate_nolock\uff1a\u5c06\u591a\u7ea7\u6570\u636e\u7d22\u5f15\u8868\u7684\u6700\u540e\u4e00\u4e2a entry \u91ca\u653e\u6389\u3002\u4ed6\u53ef\u4ee5\u8ba4\u4e3a\u662f sfs_bmap_load_nolock \u4e2d\uff0cindex == inode-&gt;blocks \u7684\u9006\u64cd\u4f5c\u3002\u5f53\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u88ab\u5220\u9664\u65f6\uff0csfs \u4f1a\u5faa\u73af\u8c03\u7528\u8be5\u51fd\u6570\u76f4\u5230 inode-&gt;blocks \u51cf\u4e3a 0\uff0c\u91ca\u653e\u6240\u6709\u7684\u6570\u636e\u9875\u3002\u51fd\u6570\u901a\u8fc7 sfs_bmap_free_nolock \u6765\u5b9e\u73b0\uff0c\u4ed6\u5e94\u8be5\u662f sfs_bmap_get_nolock \u7684\u9006\u64cd\u4f5c\u3002\u548c sfs_bmap_get_nolock \u4e00\u6837\uff0c\u8c03\u7528 sfs_bmap_free_nolock \u4e5f\u8981\u683c\u5916\u5c0f\u5fc3\u3002    </li> <li>sfs_dirent_read_nolock\uff1a\u5c06\u76ee\u5f55\u7684\u7b2c slot \u4e2a entry \u8bfb\u53d6\u5230\u6307\u5b9a\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u4ed6\u901a\u8fc7\u4e0a\u9762\u63d0\u5230\u7684\u51fd\u6570\u6765\u5b8c\u6210\u3002     </li> <li>sfs_dirent_search_nolock\uff1a\u662f\u5e38\u7528\u7684\u67e5\u627e\u51fd\u6570\u3002\u4ed6\u5728\u76ee\u5f55\u4e0b\u67e5\u627e name\uff0c\u5e76\u4e14\u8fd4\u56de\u76f8\u5e94\u7684\u641c\u7d22\u7ed3\u679c\uff08\u6587\u4ef6\u6216\u6587\u4ef6\u5939\uff09\u7684 inode \u7684\u7f16\u53f7\uff08\u4e5f\u662f\u78c1\u76d8\u7f16\u53f7\uff09\uff0c\u548c\u76f8\u5e94\u7684 entry \u5728\u8be5\u76ee\u5f55\u7684 index \u7f16\u53f7\u4ee5\u53ca\u76ee\u5f55\u4e0b\u7684\u6570\u636e\u9875\u662f\u5426\u6709\u7a7a\u95f2\u7684 entry\u3002\uff08SFS \u5b9e\u73b0\u91cc\u6587\u4ef6\u7684\u6570\u636e\u9875\u662f\u8fde\u7eed\u7684\uff0c\u4e0d\u5b58\u5728\u4efb\u4f55\u7a7a\u6d1e\uff1b\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u6570\u636e\u9875\u4e0d\u662f\u8fde\u7eed\u7684\uff0c\u5f53\u67d0\u4e2a entry \u5220\u9664\u7684\u65f6\u5019\uff0cSFS \u901a\u8fc7\u8bbe\u7f6e entry-&gt;ino \u4e3a0\u5c06\u8be5 entry \u6240\u5728\u7684 block \u6807\u8bb0\u4e3a free\uff0c\u5728\u9700\u8981\u6dfb\u52a0\u65b0 entry \u7684\u65f6\u5019\uff0cSFS \u4f18\u5148\u4f7f\u7528\u8fd9\u4e9b free \u7684 entry\uff0c\u5176\u6b21\u624d\u4f1a\u53bb\u5728\u6570\u636e\u9875\u5c3e\u8ffd\u52a0\u65b0\u7684 entry\u3002    </li> </ol> <p>\u6ce8\u610f\uff0c\u8fd9\u4e9b\u540e\u7f00\u4e3a nolock \u7684\u51fd\u6570\uff0c\u53ea\u80fd\u5728\u5df2\u7ecf\u83b7\u5f97\u76f8\u5e94 inode \u7684semaphore\u624d\u80fd\u8c03\u7528\u3002</p> <p>Inode\u7684\u6587\u4ef6\u64cd\u4f5c\u51fd\u6570</p> <pre><code>static const struct inode_ops sfs_node_fileops = {\n    .vop_magic                      = VOP_MAGIC,\n    .vop_open                       = sfs_openfile,\n    .vop_close                      = sfs_close,\n    .vop_read                       = sfs_read,\n    .vop_write                      = sfs_write,\n    \u2026\u2026\n};\n</code></pre> <p>\u4e0a\u8ff0sfs_openfile\u3001sfs_close\u3001sfs_read\u548csfs_write\u5206\u522b\u5bf9\u5e94\u7528\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u3001read\u3001write\u64cd\u4f5c\u3002\u5176\u4e2dsfs_openfile\u4e0d\u7528\u505a\u4ec0\u4e48\u4e8b\uff1bsfs_close\u9700\u8981\u628a\u5bf9\u6587\u4ef6\u7684\u4fee\u6539\u5185\u5bb9\u5199\u56de\u5230\u786c\u76d8\u4e0a\uff0c\u8fd9\u6837\u786e\u4fdd\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u662f\u6700\u65b0\u7684\uff1bsfs_read\u548csfs_write\u51fd\u6570\u90fd\u8c03\u7528\u4e86\u4e00\u4e2a\u51fd\u6570sfs_io\uff0c\u5e76\u6700\u7ec8\u901a\u8fc7\u8bbf\u95ee\u786c\u76d8\u9a71\u52a8\u6765\u5b8c\u6210\u5bf9\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u8bfb\u5199\u3002</p> <p>Inode\u7684\u76ee\u5f55\u64cd\u4f5c\u51fd\u6570</p> <pre><code>static const struct inode_ops sfs_node_dirops = {\n    .vop_magic                      = VOP_MAGIC,\n    .vop_open                       = sfs_opendir,\n    .vop_close                      = sfs_close,\n    .vop_getdirentry                = sfs_getdirentry,\n    .vop_lookup                     = sfs_lookup,                           \n    \u2026\u2026\n};\n</code></pre> <p>\u5bf9\u4e8e\u76ee\u5f55\u64cd\u4f5c\u800c\u8a00\uff0c\u7531\u4e8e\u76ee\u5f55\u4e5f\u662f\u4e00\u79cd\u6587\u4ef6\uff0c\u6240\u4ee5sfs_opendir\u3001sys_close\u5bf9\u5e94\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u51fd\u6570\u3002\u76f8\u5bf9\u4e8esfs_open\uff0csfs_opendir\u53ea\u662f\u5b8c\u6210\u4e00\u4e9bopen\u51fd\u6570\u4f20\u9012\u7684\u53c2\u6570\u5224\u65ad\uff0c\u6ca1\u505a\u5176\u4ed6\u66f4\u591a\u7684\u4e8b\u60c5\u3002\u76ee\u5f55\u7684close\u64cd\u4f5c\u4e0e\u6587\u4ef6\u7684close\u64cd\u4f5c\u5b8c\u5168\u4e00\u81f4\u3002\u7531\u4e8e\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u4e0e\u6587\u4ef6\u7684\u5185\u5bb9\u6570\u636e\u4e0d\u540c\uff0c\u6240\u4ee5\u8bfb\u51fa\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u7684\u51fd\u6570\u662fsfs_getdirentry\uff0c\u5176\u4e3b\u8981\u5de5\u4f5c\u662f\u83b7\u53d6\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6inode\u4fe1\u606f\u3002</p>"},{"location":"lab8/task/","title":"\u5b9e\u9a8c\u4efb\u52a1","text":""},{"location":"lab8/task/#_1","title":"\u7ec3\u4e60","text":"<p>\u4e3a\u4e86\u5b9e\u73b0lab8\u7684\u76ee\u6807\uff0clab2\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002  \u6ce8\u610f\u6709\u201cLAB8\u201d\u7684\u6ce8\u91ca\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\uff08challenge\u9664\u5916\uff09\u90fd\u6709\u201cLAB8\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca \u5bf9\u5b9e\u9a8c\u62a5\u544a\u7684\u8981\u6c42\uff1a  - \u57fa\u4e8emarkdown\u683c\u5f0f\u6765\u5b8c\u6210\uff0c\u4ee5\u6587\u672c\u65b9\u5f0f\u4e3a\u4e3b  - \u586b\u5199\u5404\u4e2a\u57fa\u672c\u7ec3\u4e60\u4e2d\u8981\u6c42\u5b8c\u6210\u7684\u62a5\u544a\u5185\u5bb9  - \u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8bf7\u5206\u6790ucore_lab\u4e2d\u63d0\u4f9b\u7684\u53c2\u8003\u7b54\u6848\uff0c\u5e76\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u8bf4\u660e\u4f60\u7684\u5b9e\u73b0\u4e0e\u53c2\u8003\u7b54\u6848\u7684\u533a\u522b  - \u5217\u51fa\u4f60\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u4e2d\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u4ee5\u53ca\u4e0e\u5bf9\u5e94\u7684OS\u539f\u7406\u4e2d\u7684\u77e5\u8bc6\u70b9\uff0c\u5e76\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9\u4e8c\u8005\u7684\u542b\u4e49\uff0c\u5173\u7cfb\uff0c\u5dee\u5f02\u7b49\u65b9\u9762\u7684\u7406\u89e3\uff08\u4e5f\u53ef\u80fd\u51fa\u73b0\u5b9e\u9a8c\u4e2d\u7684\u77e5\u8bc6\u70b9\u6ca1\u6709\u5bf9\u5e94\u7684\u539f\u7406\u77e5\u8bc6\u70b9\uff09  - \u5217\u51fa\u4f60\u8ba4\u4e3aOS\u539f\u7406\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u5e94\u4e0a\u7684\u77e5\u8bc6\u70b9</p>"},{"location":"lab8/task/#1","title":"\u7ec3\u4e601: \u5b8c\u6210\u8bfb\u6587\u4ef6\u64cd\u4f5c\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u9996\u5148\u4e86\u89e3\u6253\u5f00\u6587\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u7136\u540e\u53c2\u8003\u672c\u5b9e\u9a8c\u540e\u7eed\u7684\u6587\u4ef6\u8bfb\u5199\u64cd\u4f5c\u7684\u8fc7\u7a0b\u5206\u6790\uff0c\u7f16\u5199\u5728sfs_inode.c\u4e2dsfs_io_nolock\u8bfb\u6587\u4ef6\u4e2d\u6570\u636e\u7684\u5b9e\u73b0\u4ee3\u7801\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u201dUNIX\u7684PIPE\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848</p>"},{"location":"lab8/task/#2","title":"\u7ec3\u4e602: \u5b8c\u6210\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09","text":"<p>\u6539\u5199proc.c\u4e2d\u7684load_icode\u51fd\u6570\u548c\u5176\u4ed6\u76f8\u5173\u51fd\u6570\uff0c\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u3002\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u80fd\u770b\u770b\u5230sh\u7528\u6237\u7a0b\u5e8f\u7684\u6267\u884c\u754c\u9762\uff0c\u5219\u57fa\u672c\u6210\u529f\u4e86\u3002\u5982\u679c\u5728sh\u7528\u6237\u754c\u9762\u4e0a\u53ef\u4ee5\u6267\u884c\u201dls\u201d,\u201dhello\u201d\u7b49\u5176\u4ed6\u653e\u7f6e\u5728sfs\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u5176\u4ed6\u6267\u884c\u7a0b\u5e8f\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u57fa\u672c\u6210\u529f\u3002</p> <p>\u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u57fa\u4e8e\u201dUNIX\u7684\u786c\u94fe\u63a5\u548c\u8f6f\u94fe\u63a5\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848</p> <p>\u795d\u8d3a\u4f60\u901a\u8fc7\u81ea\u5df1\u7684\u52aa\u529b\uff0c\u5b8c\u6210\u4e86ucore OS lab1-lab8!</p>"},{"location":"lab8/vfs/","title":"VFS","text":""},{"location":"lab8/vfs/#-vfs","title":"\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42 - VFS","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u662f\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5bf9\u5916\u5171\u6027\u63a5\u53e3\u63d0\u53d6\u51fa\u6765\uff0c\u5f62\u6210\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u6570\u7ec4\uff0c\u8fd9\u6837\uff0c\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u53ea\u9700\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u800c\u4e0d\u9700\u5173\u5fc3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u548c\u63a5\u53e3\u3002</p>"},{"location":"lab8/vfs/#file-dir","title":"file &amp; dir\u63a5\u53e3","text":"<p>file&amp;dir\u63a5\u53e3\u5c42\u5b9a\u4e49\u4e86\u8fdb\u7a0b\u5728\u5185\u6838\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7684\u6587\u4ef6\u76f8\u5173\u4fe1\u606f\uff0c\u8fd9\u5b9a\u4e49\u5728file\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u5177\u4f53\u63cf\u8ff0\u5982\u4e0b\uff1a</p> <pre><code>struct file {\nenum {\nFD_NONE, FD_INIT, FD_OPENED, FD_CLOSED,\n} status;                         //\u8bbf\u95ee\u6587\u4ef6\u7684\u6267\u884c\u72b6\u6001\nbool readable;                    //\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\nbool writable;                    //\u6587\u4ef6\u662f\u5426\u53ef\u5199\nint fd;                           //\u6587\u4ef6\u5728filemap\u4e2d\u7684\u7d22\u5f15\u503c\noff_t pos;                        //\u8bbf\u95ee\u6587\u4ef6\u7684\u5f53\u524d\u4f4d\u7f6e\nstruct inode *node;               //\u8be5\u6587\u4ef6\u5bf9\u5e94\u7684\u5185\u5b58inode\u6307\u9488\nint open_count;                   //\u6253\u5f00\u6b64\u6587\u4ef6\u7684\u6b21\u6570\n};\n</code></pre> <p>\u800c\u5728kern/process/proc.h\u4e2d\u7684proc_struct\u7ed3\u6784\u4e2d\u63cf\u8ff0\u4e86\u8fdb\u7a0b\u8bbf\u95ee\u6587\u4ef6\u7684\u6570\u636e\u63a5\u53e3files_struct\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct files_struct {\nstruct inode *pwd;                //\u8fdb\u7a0b\u5f53\u524d\u6267\u884c\u76ee\u5f55\u7684\u5185\u5b58inode\u6307\u9488\nstruct file *fd_array;            //\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u7684\u6570\u7ec4\natomic_t files_count;             //\u8bbf\u95ee\u6b64\u6587\u4ef6\u7684\u7ebf\u7a0b\u4e2a\u6570\nsemaphore_t files_sem;            //\u786e\u4fdd\u5bf9\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2dfs_struct\u7684\u4e92\u65a5\u8bbf\u95ee\n};\n</code></pre> <p>\u5f53\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\u540e\uff0c\u8be5\u8fdb\u7a0b\u7684files_struct\u5c06\u4f1a\u88ab\u521d\u59cb\u5316\u6216\u590d\u5236\u7236\u8fdb\u7a0b\u7684files_struct\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u65f6\uff0c\u5c06\u4ecefd_array\u6570\u7ec4\u4e2d\u53d6\u5f97\u4e00\u4e2a\u7a7a\u95f2file\u9879\uff0c\u7136\u540e\u4f1a\u628a\u6b64file\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e00\u4e2a\u4ee3\u8868\u6b64\u6587\u4ef6\u7684inode\u7684\u8d77\u59cb\u5730\u5740\u3002</p>"},{"location":"lab8/vfs/#inode","title":"inode \u63a5\u53e3","text":"<p>index node\u662f\u4f4d\u4e8e\u5185\u5b58\u7684\u7d22\u5f15\u8282\u70b9\uff0c\u5b83\u662fVFS\u7ed3\u6784\u4e2d\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\uff0c\u56e0\u4e3a\u5b83\u5b9e\u9645\u8d1f\u8d23\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u5b9a\u7d22\u5f15\u8282\u70b9\u4fe1\u606f\uff08\u751a\u81f3\u4e0d\u80fd\u7b97\u662f\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\uff09\u7edf\u4e00\u5c01\u88c5\u8d77\u6765\uff0c\u907f\u514d\u4e86\u8fdb\u7a0b\u76f4\u63a5\u8bbf\u95ee\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct inode {\nunion {                                 //\u5305\u542b\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7279\u5b9ainode\u4fe1\u606f\u7684union\u6210\u5458\u53d8\u91cf\nstruct device __device_info;          //\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f\nstruct sfs_inode __sfs_inode_info;    //SFS\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f\n} in_info;   enum {\ninode_type_device_info = 0x1234,\ninode_type_sfs_inode_info,\n} in_type;                          //\u6b64inode\u6240\u5c5e\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\natomic_t ref_count;                 //\u6b64inode\u7684\u5f15\u7528\u8ba1\u6570\natomic_t open_count;                //\u6253\u5f00\u6b64inode\u5bf9\u5e94\u6587\u4ef6\u7684\u4e2a\u6570\nstruct fs *in_fs;                   //\u62bd\u8c61\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u5305\u542b\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u7684\u51fd\u6570\u6307\u9488\nconst struct inode_ops *in_ops;     //\u62bd\u8c61\u7684inode\u64cd\u4f5c\uff0c\u5305\u542b\u8bbf\u95eeinode\u7684\u51fd\u6570\u6307\u9488     \n};\n</code></pre> <p>\u5728inode\u4e2d\uff0c\u6709\u4e00\u6210\u5458\u53d8\u91cf\u4e3ain_ops\uff0c\u8fd9\u662f\u5bf9\u6b64inode\u7684\u64cd\u4f5c\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct inode_ops {\nunsigned long vop_magic;\nint (*vop_open)(struct inode *node, uint32_t open_flags);\nint (*vop_close)(struct inode *node);\nint (*vop_read)(struct inode *node, struct iobuf *iob);\nint (*vop_write)(struct inode *node, struct iobuf *iob);\nint (*vop_getdirentry)(struct inode *node, struct iobuf *iob);\nint (*vop_create)(struct inode *node, const char *name, bool excl, struct inode **node_store);\nint (*vop_lookup)(struct inode *node, char *path, struct inode **node_store);\n\u2026\u2026\n};\n</code></pre> <p>\u53c2\u7167\u4e0a\u9762\u5bf9SFS\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u64cd\u4f5c\u51fd\u6570\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u770b\u51fainode_ops\u662f\u5bf9\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u3001\u8bbe\u5907\u6587\u4ef6\u6240\u6709\u64cd\u4f5c\u7684\u4e00\u4e2a\u62bd\u8c61\u51fd\u6570\u8868\u793a\u3002\u5bf9\u4e8e\u67d0\u4e00\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u53ea\u9700\u5b9e\u73b0\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5c31\u53ef\u4ee5\u88ab\u7528\u6237\u8fdb\u7a0b\u8bbf\u95ee\u5177\u4f53\u7684\u6587\u4ef6\u4e86\uff0c\u4e14\u7528\u6237\u8fdb\u7a0b\u65e0\u9700\u4e86\u89e3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002</p>"}]}